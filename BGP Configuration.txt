9 BGP Configuration
9.1 Overview of BGP
9.2 Understanding BGP
9.3 Summary of BGP Configuration Tasks
9.4 Licensing Requirements and Limitations for BGP
9.5 Default Settings for BGP
9.6 Configuring Basic BGP Functions
9.7 Configuring BGP Security
9.8 Simplifying IBGP Network Connections
9.9 Configuring BGP Route Selection and Load Balancing
9.10 Controlling the Receiving and Advertisement of BGP Routes
9.11 Adjusting the BGP Network Convergence Speed
9.12 Configuring BGP Reliability
9.13 Configuring BGP Route Summarization
9.14 Configuring BGP to Advertise Default Routes to Peers
9.15 Configuring MP-BGP
9.16 Maintaining BGP
9.17 Configuration Examples for BGP
9.1 Overview of BGP
Definition
The Border Gateway Protocol (BGP) is a path vector protocol that allows devices
between Autonomous Systems (ASs) to communicate and selects optimal routes.
BGP-1 (defined in RFC 1105), BGP-2 (defined in RFC 1163), and BGP-3 (defined in
RFC 1267) are three earlier versions of BGP. BGP-4 (defined in RFC 1771) has been
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 682
used since 1994. Since 2006, unicast IPv4 networks have been using BGP-4 defined
in RFC 4271, and other networks (such as IPv6 networks) have been using
Multiprotocol BGP (MP-BGP) defined in RFC 4760.
MP-BGP is an extension of BGP-4 and applies to different networks; however, the
original message exchange and routing mechanisms of BGP-4 are not changed.
MP-BGP applications on IPv6 unicast and IPv4 multicast networks are called
BGP4+ and Multicast BGP (MBGP) respectively.
Purpose
A network is divided into different ASs to facilitate network management. In 1982,
the Exterior Gateway Protocol (EGP) was used to dynamically exchange routing
information between ASs. However, EGP advertises only reachable routes and does
not select optimal routes or prevent routing loops. Therefore, EGP cannot meet
network management requirements.
BGP was designed to replace EGP and has the following capabilities:
● Selects optimal routes.
● Prevents routing loops.
● Transmits routing information efficiently.
● Maintains a large number of routes.
Benefits
BGP ensures high network security, flexibility, stability, reliability, and efficiency:
● BGP uses authentication and Generalized TTL Security Mechanism (GTSM) to
ensure network security.
● BGP provides routing policies to allow for flexible route selection.
● BGP provides 9.2.8 Route Summarization and 9.2.9 Route Dampening to
prevent route flapping and improve network stability.
● BGP uses the Transport Control Protocol (TCP) with port number 179 as the
transport layer protocol and supports 9.2.10 BFD for BGP, 9.2.11 BGP
Tracking, and 9.2.12 BGP GR to improve network reliability.
9.2 Understanding BGP
9.2.1 Basic Concepts of BGP
This section describes BGP concepts to help you better understand BGP functions.
Autonomous System
An Autonomous System (AS) is a group of Internet Protocol (IP) networks that are
controlled by one entity, typically an Internet service provider (ISP), and have the
same routing policy. Each AS is assigned a unique AS number, which identifies an
AS on a BGP network. Two types of AS numbers are available: 2-byte AS numbers
and 4-byte AS numbers. A 2-byte AS number ranges from 1 to 65535, and a 4-
byte AS number ranges from 1 to 4294967295. Devices supporting 4-byte AS
numbers are compatible with devices supporting 2-byte AS numbers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 683
BGP Classification
In Figure 9-1, BGP is classified into two types according to where it runs: Internal
BGP (IBGP) and External BGP (EBGP).
Figure 9-1 BGP operating mode
● EBGP
EBGP runs between ASs. To prevent routing loops between ASs, a BGP device
discards the routes with the local AS number when receiving the routes from
EBGP peers.
● IBGP
IBGP runs within an AS. To prevent routing loops within an AS, a BGP device
does not advertise the routes learned from an IBGP peer to the other IBGP
peers and establishes full-mesh connections with all IBGP peers. To address
the problem of too many IBGP connections between IBGP peers, BGP uses
9.2.6 Route Reflector and 9.2.7 BGP Confederation.
NOTE
If a BGP device needs to advertise the route received from an EBGP peer outside an AS
through another BGP device, IBGP is recommended.
Device Roles in BGP Message Exchange
There are two device roles in BGP message exchange:
● Speaker
The device that sends BGP messages is a BGP speaker. A BGP speaker receives
and generates new routes, and advertises the routes to other BGP speakers.
● Peer
BGP speakers that exchange messages with each other are BGP peers. A
group of BGP peers sharing the same policies can form a peer group.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 684
BGP Router ID
The BGP router ID is a 32-bit value that is often represented by an IPv4 address to
identify a BGP device. It is carried in the Open message sent during the
establishment of a BGP session. When two BGP peers need to establish a BGP
session, they each require a unique router ID. Otherwise, the two peers cannot
establish a BGP session.
9.2.2 BGP Fundamentals
BGP peer establishment, update, and deletion involve five types of messages, six
state machine states, and five route exchange rules.
BGP Messages
BGP peers exchange the following messages, among which Keepalive messages
are periodically sent and other messages are triggered by events.
● Open message
Used to establish BGP peer relationships.
● Update message
Used to exchange routes between BGP peers.
● Notification message
Used to terminate BGP connections.
● Keepalive message
Used to maintain BGP connections.
● Route-refresh message
Used to request the peer to retransmit routes if routing policies are changed.
Only the BGP devices supporting route-refresh can send and respond to
Route-refresh messages.
BGP State Machine
In Figure 9-2, a BGP device uses a finite state machine (FSM) to determine its
operations with peers. The FSM has six states: Idle, Connect, Active, OpenSent,
OpenConfirm, and Established. Three common states are involved in BGP peer
establishment: Idle, Active, and Established.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 685
Figure 9-2 BGP state machine
1. The Idle state is the initial BGP state where the BGP device refuses all
connection requests from neighbors. The BGP device initiates a TCP
connection with its BGP peer and changes its state to Connect only after
receiving a Start event from the system.
NOTE
● The Start event occurs when an operator configures a BGP process or resets an
existing BGP process or when the router software resets a BGP process.
● If an error occurs at any state of the FSM, for example, the BGP device receives a
Notification packet or TCP connection termination notification, the BGP device
returns to the Idle state.
2. In Connect state, the BGP device starts the Connect Retry timer and waits to
establish a TCP connection.
– If the TCP connection is established, the BGP device sends an Open
message to the peer and changes to the OpenSent state.
– If the TCP connection fails to be established, the BGP device moves to the
Active state.
– If the BGP device does not receive a response from the peer before the
Connect Retry timer expires, the BGP device attempts to establish a TCP
connection with another peer and stays in Connect state.
3. In Active state, the BGP device keeps trying to establish a TCP connection with
the peer.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 686
– If the TCP connection is established, the BGP device sends an Open
message to the peer, closes the Connect Retry timer, and changes to the
OpenSent state.
– If the TCP connection fails to be established, the BGP device stays in the
Active state.
– If the BGP device does not receive a response from the peer before the
Connect Retry timer expires, the BGP device returns to the Connect state.
4. In OpenSent state, the BGP device waits for an Open message from the peer
and then checks the validity of the received Open message, including the AS
number, version, and authentication password.
– If the received Open message is valid, the BGP device sends a Keepalive
message and changes to the OpenConfirm state.
– If the received Open message is invalid, the BGP device sends a
Notification message to the peer and returns to the Idle state.
5. In OpenConfirm state, the BGP device waits for a Keepalive or Notification
message from the peer. If the BGP device receives a Keepalive message, it
transitions to the Established state. If it receives a Notification message, it
returns to the Idle state.
6. In Established state, the BGP device exchanges Update, Keepalive, Route-
refresh, and Notification messages with the peer.
– If the BGP device receives a valid Update or Keepalive message, it
considers that the peer is working properly and maintains the BGP
connection with the peer.
– If the BGP device receives an invalid Update or Keepalive message, it
sends a Notification message to the peer and returns to the Idle state.
– If the BGP device receives a Route-refresh message, it does not change its
status.
– If the BGP device receives a Notification message, it returns to the Idle
state.
– If the BGP device receives a TCP connection termination notification, it
terminates the TCP connection with the peer and returns to the Idle state.
Route Exchange Rules
A BGP device adds optimal routes to the BGP routing table to generate BGP
routes. After establishing a BGP peer relationship with a neighbor, the BGP device
follows the following rules to exchange routes with the peer:
● Advertises the BGP routes received from IBGP peers only to its EBGP peers.
● Advertises the BGP routes received from EBGP peers to its EBGP peers and
IBGP peers.
● Advertises the optimal route to its peers when there are multiple valid routes
to the same destination.
● Sends only updated BGP routes when BGP routes change.
● Accepts all the routes sent from its peers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 687
9.2.3 Interaction Between BGP and IGPs
BGP and IGPs use different routing tables. To allow devices in different ASs to
communicate, BGP needs to interact with IGPs. That is, BGP and IGP routes can be
imported into IGP and BGP routing tables respectively.
Importing IGP Routes into BGP
BGP cannot discover routes and needs to import IGP routes into a BGP routing
table for inter-AS communication. When an AS needs to advertise routes to
another AS, an AS boundary router (ASBR) will import IGP routes into its BGP
routing table. For better network planning, BGP can filter and set attributes for
imported IGP routes based on routing policies. Alternatively, EBGP peers can select
routes when traffic enters an AS based on the configured Multi-Exit Discriminator
(MED) value.
BGP can import routes in either import or network mode:
● In import mode, BGP imports routes according to protocol types, such as RIP
routes, OSPF routes, and IS-IS routes. To ensure validity of imported IGP
routes, BGP can also import static routes and direct routes in import mode.
● In network mode, BGP imports routes in an IP routing table one by one.
Therefore, the network mode is more precise than the import mode.
Importing BGP Routes into IGPs
When an AS needs to import routes from other ASs, an ASBR of this AS will
import BGP routes into its IGP routing table. To prevent a large number of BGP
routes from affecting devices in this AS, IGPs can filter and set attributes for
imported BGP routes based on routing policies.
Problem and Solution Related to Route Import Between BGP and IGPs
BGP and IGPs often import routes from each other to advertise routes between
ASs. However, the following problems may occur:
● If a large number of BGP routes exist, low-end devices within ASs may be
unable to have these routes installed, resulting in route loss.
● If a route is unstable, for example, a port frequently alternates between Up
and Down states, all routes within an AS may flap, affecting network stability.
● BGP prevents routing loops using route attributes, for example, the AS_Path
attribute. When all BGP routes are re-advertised into IGPs, their route
attributes will be lost. As a result, the BGP routing loop prevention
mechanism becomes ineffective, and routing loops may occur.
On a large IP network, the number of BGP routes is much larger than the number
of IGP routes. Therefore, when BGP routes need to be imported into IGPs, exercise
caution to prevent a large number of imported BGP routes from affecting IGP
routes. To do so, use default routes and summarize routes to reduce the number
of BGP routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 688
Figure 9-3 Using EBGP and IBGP to Advertise Routes Between ASs
Figure 9-3 shows a typical IP backbone network topology. In this topology, the
backbone layer and aggregation layer are AS 200 and AS 100 respectively, and AS
100 has two egress devices, SwitchC and SwitchD. The two ASs need to
communicate using routes. The following requirements need to be met:
● Devices on the aggregation layer are not expected to know route details of
the backbone layer.
● Devices on the aggregation layer have low performance and are not expected
to receive a large number of BGP routes from the backbone layer.
● Devices on the backbone layer have high performance and are expected to
know route details of the aggregation layer.
In Figure 9-3, if the two egress devices SwitchC and SwitchD import BGP routes
into OSPF, a large number of BGP routes will be transmitted from the backbone
layer to the aggregation layer. This will enable the aggregation devices to receive
a large number of BGP routes and know route details of the backbone layer. As a
result, the preceding requirements cannot be met. The following solution can
meet these requirements:
● Two devices on the backbone layer, SwitchE and SwitchF, advertise default
routes through BGP to two egress devices on the aggregation layer, SwitchC
and SwitchD. This operation ensures that aggregation devices do not receive a
large number of BGP routes from the backbone layer and do not know route
details of the backbone layer.
● The two egress devices, SwitchC and SwitchD, import only OSPF routes into
BGP, without importing BGP routes into OSPF. This ensures that backbone
devices know route details of the aggregation layer.
● ASBRs of each AS establish an IBGP peer relationship. That is, SwitchC and
SwitchD establish an IBGP peer relationship, and SwitchE and SwitchF
establish an IBGP peer relationship. This ensures route backup of two egress
devices in the ASs and improves reliability.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 689
9.2.4 BGP Security
BGP uses authentication and Generalized TTL Security Mechanism (GTSM) to
ensure exchange security between BGP peers.
BGP Authentication
BGP authentication includes Message Digest 5 (MD5) authentication and keychain
authentication, which improves communication security between BGP peers. In
MD5 authentication, you can only set the authentication password for a TCP
connection. In keychain authentication, you can set the authentication password
for a TCP connection and authenticate BGP messages.
BGP GTSM
BGP GTSM checks whether the time to live (TTL) value in the IP packet header is
within a predefined range. It permits or discards the packets with TTL values
outside of the predefined range to protect services above the IP layer. BGP GTSM
enhances system security.
Assume that the TTL value range of packets from BGP peers is set to 254-255.
When an attacker forges valid BGP packets and keeps sending these packets to
attack a device, the TTL values of these packets are smaller than 254. If BGP
GTSM is not enabled on the device, the device finds that these packets are
destined for itself and sends the packets to the control plane for processing. Then
the control layer needs to process a large number of such attack packets, causing
high CPU usage. If BGP GTSM is enabled on the device, the system checks the TTL
values in all BGP packets and discards the attack packets with TTL values smaller
than 254. This prevents network attack packets from consuming CPU resources.
9.2.5 BGP Route Selection Rules and Load Balancing
When multiple routes are available to the same destination, BGP selects one
optimal route based on BGP route selection rules and adds it to the IP routing
table for traffic forwarding. Figure 9-4 shows how the optimal route is selected.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 690
Figure 9-4 BGP route selection process
BGP selects routes by comparing route attributes in a fixed order. When a route
attribute is a sufficient condition for determining the optimal route, BGP does not
compare the other attributes; If BGP fails to select the optimal route after
comparing all route attributes, the route that was first received is selected as the
optimal route. Table 9-1 lists the abbreviated alias, route selection rules, and
remarks of each matching item. Table 9-1 shows that the route priority is directly
proportional to the PreVal or Local_Pref value and inversely proportional to the
rest of the attribute values or lengths. In addition, the first column can be
summarized as a character string (PPAAA OMTCC RA), which helps memorize the
matching sequence.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 691
Table 9-1 BGP route selection process
Abbr
eviat
ed
Alias
Matching
Item
Route Selection
Rules
Remarks
P PrefVal The route with the
largest PreVal value is
preferred.
The default value is 0.
PrefVal is Huawei-specific and
valid only on the device where it
is configured.
P Local_Pref The route with the
largest Local_Pref
value is preferred.
The default value is
100.
To modify the default Local_Pref
value of BGP routes, run the
default local-preference
command.
A
NOTE
A is
the
initi
al of
the
char
acte
r
strin
g
(AS
NIL).
Route type A > S > N > I > L, in
which:
● A: indicates that
routes are
summarized using
the aggregate
command.
● S: indicates that
routes are
summarized using
the summary
automatic
command.
● N: indicates that
routes are
imported using the
network
command.
● I: indicates that
routes are
imported using the
import-route
command.
● L: indicates that
routes are learned
from BGP peers.
-
A AS_Path The route with the
shortest AS_Path
length is preferred.
If the bestroute as-path-ignore
command is configured, BGP
does not compare the AS_Path
attribute.
O Origin IGP > EGP >
Incomplete
-
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 692
Abbr
eviat
ed
Alias
Matching
Item
Route Selection
Rules
Remarks
M Multi Exit
Discriminat
or (MED)
The route with the
smallest MED value is
preferred.
The default value is 0.
If the bestroute med-none-as-
maximum command is
configured, BGP considers the
largest MED value (4294967295)
as the MED of the route that
does not carry an MED.
T Peer type EBGP > IBGP Prefers EBGP routes, IBGP routes,
LocalCross routes, and
RemoteCross routes, which are
listed in descending order of
priority.
LocalCross allows a PE to add
the VPNv4 route of a VPN
instance to the routing table of
the VPN instance if the export
RT of the VPNv4 route matches
the import RT of another VPN
instance on the PE. RemoteCross
allows a local PE to add the
VPNv4 route learned from a
remote PE to the routing table
of a VPN instance on the local
PE if the export RT of the VPNv4
route matches the import RT of
the VPN instance.
C IGP cost The route with the
smallest IGP cost is
preferred.
If there are multiple routes to
the same destination, an IGP
calculates the route metric using
its routing algorithm.
If the bestroute igp-metric-
ignore command is configured,
BGP does not compare the IGP
cost.
C Cluster_List The route with the
shortest Cluster_List
length is preferred.
By default, Cluster_List takes
precedence over Originator_ID
during BGP route selection. To
enable Originator_ID to take
precedence over Cluster_List
during BGP route selection, run
the bestroute routerid-prior-
clusterlist command.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 693
Abbr
eviat
ed
Alias
Matching
Item
Route Selection
Rules
Remarks
R Router ID The route with the
smallest router ID is
preferred.
If routes carry the Originator_ID,
the originator ID is substituted
for the router ID during route
selection. The route with the
smallest Originator_ID is
preferred.
A Peer IP
address
The route learned
from the peer with
the smallest IP
address is preferred.
-
Selection of the Routes for Load Balancing
After BGP load balancing is configured, the BGP routes that meet the following
conditions are used as equal-cost routes for load balancing:
● The routes have the same PrefVal value.
● The routes have the same Local_Pref value.
● All the routes are summarized or non-summarized routes.
● The routes have the same AIGP value.
● The routes have the same AS_Path length.
● The routes have the same origin type (IGP, EGP, or incomplete).
● The routes have the same MED value.
● All the routes are EBGP or IBGP routes. After the maximum load-balancing
eibgp command is run, BGP ignores this limitation when selecting the
optimal VPN route.
● The costs of the IGP routes to which the BGP routes are recursed within an AS
are the same. After the maximum load-balancing eibgp command is run,
BGP ignores this limitation when selecting the optimal VPN route.
In addition, BGP labeled routes and non-labeled routes cannot load-balance traffic
even if they meet the preceding conditions.
VPN Route Selection Rules
BGP VPN routes are selected in the same way as BGP public routes except that
VPN target-based route crossing is implemented first on BGP VPN routes.
9.2.6 Route Reflector
To ensure connectivity between IBGP peers, you need to establish full-mesh
connections between IBGP peers. If there are n devices in an AS, n(n-1)/2 IBGP
connections need to be established. When there are a large number of devices,
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 694
many network resources and CPU resources are consumed. A route reflector (RR)
can be used between IBGP peers to solve this problem.
Roles in RR
As shown in Figure 9-5, the following roles are involved in RR scenarios in an AS.
Figure 9-5 Networking diagram of the RR
● Route reflector (RR)
A BGP device that can reflect the routes learned from an IBGP peer to other
IBGP peers. An RR is similar to a designated router (DR) on an OSPF network.
● Client
An IBGP device whose routes are reflected by the RR to other IBGP devices. In
an AS, clients need to connect only to the RR directly.
● Non-client
An IBGP device that is neither an RR nor a client. In an AS, a non-client must
establish full-mesh connections with the RR and all the other non-clients.
● Originator
A device that originates routes in an AS. The Originator_ID attribute helps
eliminate routing loops in a cluster.
● Cluster
A set of the RR and clients. The Cluster_List attribute helps eliminate routing
loops between clusters.
RR Principles
Clients in a cluster need to exchange routing information only with the RR in the
same cluster. Therefore, clients need to establish IBGP connections only with the
RR. This reduces the number of IBGP connections in the cluster. As shown in
Figure 9-5, in AS 65000, Cluster1 is composed of an RR and three clients. The
number of IBGP connections in AS 65000 is then reduced from 10 to 4, which
simplifies the device configuration and reduces the loads on the network and CPU.
The RR allows a BGP device to advertise the BGP routes learned from an IBGP
peer to other IBGP peers, and uses the Cluster_List and Originator_ID attributes to
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 695
eliminate routing loops. The RR advertises routes to IBGP peers based on the
following rules:
● The RR advertises the routes learned from a non-client to all the clients.
● The RR advertises the routes learned from a client to all the other clients and
all the non-clients.
● The RR advertises the routes learned from an EBGP peer to all the clients and
non-clients.
Cluster_List Attribute
An RR and its clients form a cluster, which is identified by a unique cluster ID in an
AS. To prevent routing loops between clusters, an RR uses the Cluster_List
attribute to record the cluster IDs of all the clusters that a route passes through
based on the following rules:
● When a route is reflected by an RR for the first time, the RR adds the local
cluster ID to the top of the cluster list. If there is no cluster list, the RR creates
a Cluster_List attribute.
● When receiving an updated route, the RR checks the cluster list of the route. If
the cluster list contains the local cluster ID, the RR discards the route. If the
cluster list does not contain the local cluster ID, the RR adds the local cluster
ID to the cluster list and then reflects the route.
Originator_ID Attribute
An originator ID identifies the originator of a route and is generated by an RR to
prevent routing loops in a cluster. Its value is the same as a router ID.
When a route is reflected by an RR for the first time, the RR adds the
Originator_ID attribute to this route. The Originator_ID attribute identifies the
originator of the route. If the route contains the Originator_ID attribute, the RR
retains this Originator_ID attribute.
When a device receives a route, the device compares the originator ID of the route
with the local router ID. If they are the same, the device discards the route.
Backup RR
To ensure network reliability and prevent single-point failures, a cluster requires
redundant RRs. An RR allows a BGP device to advertise the routes received from
an IBGP peer to other IBGP peers. Therefore, routing loops may occur between
RRs in the same cluster. To prevent this, all the RRs in the cluster must use the
same cluster ID.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 696
Figure 9-6 Backup RR
As shown in Figure 9-6, RR1 and RR2 reside in the same cluster and have the
same cluster ID configured.
● When Client1 receives an updated route from an EBGP peer, Client1 advertises
this route to RR1 and RR2 using IBGP.
● After RR1 and RR2 receive this route, they add the local cluster ID to the top
of the cluster list of the route and then reflect the route to other clients
(Client2 and Client3) and to each other.
● After RR1 and RR2 receive the reflected route from each other, they check the
cluster list of the route, finding that the cluster list contains their local cluster
IDs. RR1 and RR2 discard this route to prevent routing loops.
RRs of Multiple Clusters in an AS
If there are multiple clusters in an AS, RRs of the clusters establish IBGP peer
relationships. When RRs reside at different network layers, an RR at the lower
network layer can be configured as a client to implement hierarchical RR. When
RRs reside at the same network layer, RRs of different clusters can establish full-
mesh connections to implement flat RR.
Hierarchical RR
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 697
Figure 9-7 Hierarchical RR
In practice, hierarchical RR is often used. As shown in Figure 9-7, the ISP provides
Internet routes to AS 100. AS 100 is divided into two clusters, Cluster1 and
Cluster2. Four devices in Cluster1 are core routers and use a backup RR to ensure
reliability.
Flat RR
Figure 9-8 Flat RR
As shown in Figure 9-8, the backbone network is divided into multiple clusters.
RRs of the clusters are non-clients and establish full-mesh connections with each
other. Although each client only establishes an IBGP connection with its RR, all the
RRs and clients can receive all routing information.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 698
9.2.7 BGP Confederation
In addition to a route reflector, the confederation is another method that reduces
the number of IBGP connections in an AS. A confederation divides an AS into sub-
ASs. Full-mesh IBGP connections are established in each sub-AS. EBGP connections
are established between sub-ASs. ASs outside a confederation still consider the
confederation as an AS. After a confederation divides an AS into sub-ASs, it
assigns a confederation ID (the AS number) to each router within the AS. This
brings two benefits.
● Original IBGP attributes are retained, including the Local_Pref attribute, MED
attribute, and Next_Hop attribute.
● Confederation-related attributes are automatically deleted when being
advertised outside a confederation.
Therefore, the administrator does not need to configure the rules for filtering
information such as sub-AS numbers at the egress of a confederation.
Figure 9-9 Networking diagram of a confederation
As shown in Figure 9-9, AS 100 is divided into three sub-ASs after a confederation
is configured: AS65001, AS65002, and AS65003. The AS number AS 100 is used as
the confederation ID. In Figure 9-9, to implement route transmission and packet
forwarding, 10 IBGP connections are required if a logical full mesh is used. If the
confederation is used, only two IBGP connections and two EBGP connections are
required. Therefore, using the confederation simplifies the device configuration
and reduces the network and CPU burden. In addition, BGP devices outside AS 100
only know the existence of AS 100 but not the confederation within AS 100.
Therefore, the confederation does not increase the CPU load.
Comparisons Between a Route Reflector and a Confederation
Table 9-2 compares a route reflector and a confederation in terms of the
configuration, device connection, and applications.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 699
Table 9-2 Comparisons between a route reflector and a confederation
Route Reflector Confederation
Retains the existing network topology
and ensures compatibility.
Requires the logical topology to be
changed.
Requires only a route reflector to be
configured because clients do not need
to know that they are clients of a
route reflector.
Requires all devices to be reconfigured.
Requires full-mesh connections
between clusters.
Does not require full-mesh
connections between sub-ASs of a
confederation because the sub-ASs are
special EBGP peers.
Applies to medium and large
networks.
Applies to large networks.
9.2.8 Route Summarization
The BGP routing table of each device is large on large networks. This burdens
devices, increases the route flapping probability, and affects network stability.
Route summarization is a mechanism that combines multiple routes into one
route. This mechanism allows a BGP device to advertise only the summarized
route but not all the specific routes to peers, thereby reducing the size of the BGP
routing table. If the summarized route flaps, the network is not affected,
improving network stability.
BGP supports automatic summarization and manual summarization on IPv4
networks, and supports only manual summarization on IPv6 networks. Automatic
and manual summarization work as follows:
● Automatic summarization
Summarizes the routes imported by BGP. After automatic summarization is
configured, BGP summarizes routes based on the natural network segment
and advertises only the summarized route to peers. For example, BGP
summarizes 10.1.1.1/24 and 10.2.1.1/24 (two Class A addresses with non-
natural mask) into 10.0.0.0/8 (Class A address with natural mask).
● Manual summarization
Summarizes routes in the local BGP routing table. Manual summarization can
help control the attributes of the summarized route and determine whether
to advertise specific routes.
To prevent routing loops caused by route summarization, BGP uses the AS_Set
attribute. The AS_Set attribute is an unordered set of all ASs that a route passes
through. When the summarized route enters an AS in the AS_Set attribute again,
BGP finds that the local AS number has been recorded in the AS_Set attribute of
the route and discards this route to prevent a routing loop.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 700
9.2.9 Route Dampening
When BGP is used on complex networks, route flapping occurs frequently. To
prevent this, BGP uses route dampening to suppress unstable routes.
Route flapping is a process of adding a route to an IP routing table and then
withdrawing this route. When route flapping occurs, a BGP device sends an
Update message to its neighbors. The devices that receive the Update message
need to recalculate routes and modify routing tables. Frequent route flapping
consumes lots of bandwidths and CPU resources and even affects normal network
operation.
Figure 9-10 Diagram of BGP route dampening
Route dampening measures the stability of a route using a penalty value. A larger
penalty value indicates a less stable route. In Figure 9-10, each time route
flapping occurs, BGP increases the penalty of this route by a value of 1000. When
the penalty value of a route exceeds the suppression threshold, BGP suppresses
this route, and does not add it to the IP routing table or advertise any Update
message to peers. After a route is suppressed for a period of time (half-life), the
penalty value is reduced by half. When the penalty value of a route decreases to
the reuse threshold, the route is reusable and is added to the routing table. At the
same time, BGP advertises an Update message to peers. The suppression time is
the period from when a route is suppressed to when the route is reusable.
Route dampening applies only to EBGP routes but not IBGP routes. IBGP routes
may include the routes of the local AS, and an IGP network requires that the
routing tables of devices within an AS be the same. If IBGP routes are dampened,
routing tables on devices are inconsistent when these devices have different
dampening parameters. Therefore, route dampening does not apply to IBGP
routes.
9.2.10 BFD for BGP
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 701
BGP periodically sends messages to peers to detect the status of the peers. It takes
more than 1 second for this detection mechanism to detect a fault. When data is
transmitted at gigabit rates, long-time fault detection will cause packet loss. This
cannot meet high reliability requirements of networks. Bidirectional Forwarding
Detection (BFD) provides the millisecond-level fault detection for BGP to improve
network reliability.
Figure 9-11 Networking diagram of BFD for BGP
As shown in Figure 9-11, RouterA belongs to AS 100 and RouterB belongs to AS
200. RouterA and RouterB are directly connected and establish the EBGP peer
relationship. Association between BGP and BFD is configured on RouterA and
RouterB. When a fault occurs on the link between RouterA and RouterB, BFD can
rapidly detect that the BFD session changes from Up to Down and notify this fault
to RouterA and RouterB. RouterA and RouterB process the neighbor Down event
and select routes again using BGP.
9.2.11 BGP Tracking
BGP tracking provides fast link fault detection to speed up network convergence.
When a fault occurs on the link between BGP peers that have BGP tracking
configured, BGP tracking can quickly detect peer unreachability and instruct the
routing management module to notify BGP of the fault, achieving rapid network
convergence.
Compared to BFD, BGP tracking is easy to configure because it needs to be
configured only on the local device. BGP tracking is a fault detection mechanism
at the routing layer, whereas BFD is a fault detection mechanism at the link layer.
BGP route convergence on a network where BGP tracking is configured is slower
than that on a network where BFD is configured. Therefore, BGP tracking is not
suitable for voice services that require fast convergence.
Applications
In Figure 9-12, RouterA and RouterB, and RouterB and RouterC establish IGP
connections. RouterA and RouterC establish an IBGP peer relationship. BGP
tracking is configured on RouterA. When a fault occurs on the link between
RouterA and RouterB, IGP performs fast convergence. Subsequently, BGP tracking
detects the unreachability of the route to RouterC and notifies the fault to BGP on
RouterA, which then interrupts the BGP connection with RouterC.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 702
Figure 9-12 Networking diagram of BGP tracking
NOTE
If establishing an IBGP peer relationship requires IGP routes, the interval between peer
unreachability discovery and connection interruption needs to be configured. This interval
must be longer than the IGP route convergence time. Otherwise, before IGP route flapping
caused by transient interruption is suppressed, the BGP peer relationship may have been
interrupted, causing unnecessary BGP convergence.
9.2.12 BGP GR
BGP graceful restart (GR) is high availability solutions that minimize the impact of
device failures on user services.
BGP GR ensures that the forwarding plane continues to guide data forwarding
during a device restart or active/standby switchover. The operations on the control
plane, such as reestablishing peer relationships and performing route calculation,
do not affect the forwarding plane. This mechanism prevents service interruptions
caused by route flapping and improves network reliability.
GR concepts are as follows:
● GR restarter
The device that is restarted by the administrator or triggered by failures to
perform GR.
● GR helper
The neighbor that helps the GR restarter to perform GR.
● GR time
The time during which the GR helper retains forwarding information after
detecting the restart or active/standby switchover of the GR restarter.
The BGP GR process is as follows:
1. Using the BGP capability negotiation mechanism, the GR restarter and helper
know each other's GR capability and establish a GR session.
2. When detecting the restart or active/standby switchover of the GR restarter,
the GR helper waits to reestablish a BGP connection with the GR restarter. It
does not delete the routing information and forwarding entries of the GR
restarter or notify other neighbors of the restart or switchover.
3. The GR restarter reestablishes neighbor relationships with all GR helpers
before the GR time expires.
9.2.13 Dynamic Update Peer-Groups
Currently, the rapid growth in the size of the routing table and the complexity of
the network topology require BGP to support more peers. Especially in the case of
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 703
a large number of peers and routes, high-performance grouping and forwarding
are required when a router needs to send routes to a large number of BGP peers,
most of which share the same outbound policies.
The dynamic update peer-groups feature treats all the BGP peers with the same
outbound policies as an update-group. In this case, routes are grouped uniformly
and then sent separately. That is, each route to be sent is grouped once and then
sent to all peers in the update-group, improving grouping efficiency exponentially.
For example, a route reflector (RR) has 100 clients and needs to reflect 100,000
routes to these clients. If the RR sends the routes grouped per peer to 100 clients,
the total number of times that all routes are grouped is 10,000,000 (100,000 x
100). After the dynamic update peer-groups feature is used, the total number of
grouping times changes to 100,000 (100,000 x 1), improving grouping
performance by a factor of 100.
Applications
BGP uses the dynamic update peer-groups technology when a large number of
peers and routes exist and most peers share the same outbound policies,
improving BGP route grouping and forwarding performance. The dynamic update
peer-groups feature applies to the following scenarios:
● International gateway
As shown in Figure 9-13, the Internet gateway (IGW) router sends routes to
all neighboring ASs. If the IGW router supports the dynamic update peer-
groups feature, its BGP route forwarding performance will be greatly
improved.
Figure 9-13 Networking diagram of the international gateway
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 704
● RR
As shown in Figure 9-14, RRs send routes to all clients. If the RRs support the
dynamic update peer-groups feature, their BGP route forwarding performance
will be greatly improved.
Figure 9-14 Networking diagram of RRs
● ASBR
As shown in Figure 9-15, RouterB, as an Autonomous System Boundary
Router (ASBR), sends all the routes received from an EBGP neighbor RouterA
to all IBGP neighbors. If RouterB supports the dynamic update peer-groups
feature, its BGP route forwarding performance will be greatly improved.
Figure 9-15 Networking diagram of a PE connecting to multiple IBGP
neighbors
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 705
9.2.14 MP-BGP and Address Families
The Border Gateway Protocol 4 (BGP-4) transmits only IPv4 unicast routing
information and cannot transmit routing information for other network layer
protocols, such as IPv6 and multicast protocols.
To support multiple types of network layer protocols, the Internet Engineering
Task Force (IETF) extended BGP-4 to Multiprotocol Extensions for BGP-4 (MP-
BGP). The current MP-BGP standard is RFC 4760. MP-BGP is forward compatible.
Switches that support BGP extension can communicate with switches that do not.
As an enhancement of BGP-4, MP-BGP provides routing information for various
protocols, such as IPv6 (BGP4+) and multicast:
● MP-BGP maintains unicast and multicast routing information, and stores both
types in different routing tables to ensure their separation.
● MP-BGP supports unicast and multicast, and constructs different network
topologies for each.
● MP-BGP can maintain unicast and multicast routes based on routing policies.
The unicast routing policies and configurations supported by BGP-4 can
mostly be applied to multicast.
Extended Attributes
BGP-4 update packets carry three IPv4-related attributes: network layer reachable
information (NLRI), Next_Hop, and Aggregator. Aggregator contains the IP address
of the BGP speaker that performs route aggregation.
To support multiple types of network layer protocols, BGP-4 needs to carry the
information about network layer protocols in NLRI and Next_Hop. MP-BGP
introduces the following route attributes:
● MP_REACH_NLRI: indicates the multiprotocol reachable NLRI, which is used to
advertise a reachable route and the next hop.
● MP_UNREACH_NLRI: indicates the multiprotocol unreachable NLRI, which is
used to withdraw an unreachable route.
The two attributes are optional non-transitive. Therefore, BGP speakers that do
not support multiprotocol ignore the information carried by the two attributes,
and do not advertise the information to peers.
NOTE
Optional non-transitive is a BGP attribute type. If a BGP device does not support this
attribute type, the Update messages with attributes of this type are ignored, and the
messages are not advertised to other peers.
MP_REACH_NLRI
Multiprotocol Reachable NLRI (MP_REACH_NLRI) is used to advertise reachable
routes and information about the next hop. MP_REACH_NLRI is coded as one or
more 3-tuples of the form <Address Family Information, Next Hop Information,
Network Layer Reachability Information>.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 706
Figure 9-16 Format of the MP_REACH_NLRI field
Descriptions of each part of the MP_REACH_NLRI field are as follows:
● Address Family Information: consists of a 2-byte Address Family Identifier
(AFI) and a 1-byte Subsequent Address Family Identifier (SAFI):
– The AFI identifies a network layer protocol. Defined values for this field
are specified in RFC 1700 (Address Family Number). For example, 1
indicates IPv4; 2 indicates IPv6.
– The SAFI indicates the type of the NLRI field.
If the AFI is 1 and the SAFI is 128, the address in the NLRI field is a BGP-
VPNv4 address.
● Next Hop Network Address Information: consists of the 1-byte length of the
next-hop network address and the next-hop network address of a variable
length. A next-hop network address refers to the network address of the next
device on the path to the destination.
● Network Layer Reachable Information: is a variable-length field that lists NLRI
for the routes being advertised. Figure 9-17 shows the format of the NLRI
field.
Figure 9-17 Format of the NLRI field that carries label information
Descriptions of each part of the NLRI field are as follows:
– Length: indicates the total bits of the label and prefix.
– Label: consists of one or more labels. The length of a label is 3 bytes.
– Prefix: In a BGP/Multiprotocol Label Switching (MPLS) IP VPN, the prefix
field consists of a route distinguisher (RD) and IPv4 address prefix.
VPNv4 update messages exchanged between provider edges (PEs) or autonomous
system boundary routers (ASBRs) carry MP_REACH_NLRI. An Update message can
carry multiple reachable routes with the same routing attributes.
MP_UNREACH_NLRI
Multiprotocol Unreachable NLRI (MP_UNREACH_NLRI) is used to inform a peer to
delete unreachable routes. Figure 9-18 shows the format of the attribute.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 707
Figure 9-18 Format of the MP_UNREACH_NLRI field
Descriptions of each part of the MP_UNREACH_NLRI field are as follows:
● AFI: identifies a network layer protocol. AFI uses the address family values
defined in RFC 1700.
● SAFI: indicates the NLRI type and is similar to SAFI in MP_REACH_NLRI.
● Withdrawn Routes: indicates an unreachable route list, which consists of one
or more NLRI fields. In the Withdrawn Routes field, BGP speakers can
withdraw the route by filling the NLRI field in the same manner as that for
the previously advertised reachable route.
Update messages carrying MP_UNREACH_NLRI are sent to withdraw routes. An
Update message can carry information about multiple unreachable routes.
If the labels of routes to be withdrawn are specified in the messages, the routes
with specified labels are withdrawn. If the labels are not specified, only the routes
without labels are withdrawn.
Update messages with MP_UNREACH_NLRI do not carry any path attributes.
Negotiation of the MP-BGP Capability
A BGP device gets to know the negotiation capability of its peer by checking the
capability parameters in Open messages. If the BGP device and its peer support
the same function, the BGP device and its peer communicate using the function.
The optional parameters of the negotiation capability in an Open message consist
of three parts: Capability Code, Capability Length, and Capability Value. Figure
9-19 shows the format of the capability parameters.
Figure 9-19 Format of BGP capability parameters
Descriptions of BGP capability parameters are as follows:
● Capability Code: uniquely identifies the capability type. The value 1 indicates
that the BGP speaker has the MP-BGP capability.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 708
● Capability Length: indicates the length of the capability field. For MP-BGP, the
length of the capability field is 4.
● Capability Value: indicates the value of the capability field. The length is
variable and depends on the type specified in Capability Code. Figure 9-20
shows the format of the Capability Value field:
– The meanings of 2-byte AFI and 1-byte SAFI are the same as those of
MP_REACH_NLRI.
– Res. is a 1-byte reserved field. The sender sets the value to 0, and the
receiver ignores the field.
Figure 9-20 Format of the Capability Value field
At present, BGP does not support dynamic capability negotiation. After a BGP
speaker advertises an Open message with optional capability fields:
● If the speaker receives a Notification message from its peer, the peer does not
support the capability. Then the BGP speaker tears down the session with its
peer and sends an Open message without any optional capability fields to the
peer to attempt a new BGP connection.
● If the peer supports the capability advertisement but the capability fields are
unknown or unsupported, negotiation fails. Then the BGP speaker tears down
the session with its peer, and sends an Open message without the optional
capability fields (but may carry other optional capability fields) to the peer to
attempt a new BGP connection.
After any change in BGP capabilities, such as enabling or disabling label-routing
capabilities, enabling or disabling address family capabilities (IPv4, IPv6, VPNv4,
and VPNv6), and enabling graceful restart (GR) capabilities, the BGP speaker tears
down the session with its peer, and then re-negotiates the capabilities with its
peer.
Address Family
BGP uses address families to differentiate network protocol applications. The
switch supports a wide range of MP-BGP applications. These applications can be
configured in their respective extended BGP address family views.
Table 9-3 lists BGP address families.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 709
Table 9-3 BGP address families
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
IPv4
unicas
t
addre
ss
family
1 1
or
4
Provides the following functions:
● Maintains public network BGP
peer relationships and transmits
public network IPv4 routes. When
a BGP-IPv4 unicast address family
transmits public network IPv4
routes, the SAFI field is 1.
● Transmits public network labeled
IPv4 routes. This function mainly
applies to BGP/MPLS IPv4 VPN or
BGP/MPLS IPv6 VPN in inter-AS
Option C mode. When a BGP-IPv4
unicast address family transmits
public network labeled IPv4
routes, the SAFI field is 4.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
unicast
[HUAWEI-bgp-af-ipv4]
BGP-
IPv4
multic
ast
addre
ss
family
1 2 Allows PEs to maintain multicast
BGP (MBGP) peer relationships. If
the multicast source and receiver are
in two autonomous systems (ASs),
an inter-AS multicast distribution
tree (MDT) must be established.
MBGP can transmit multicast
routing information across ASs.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
multicast
[HUAWEI-bgp-af-multicast]
BGP
VPN
instan
ce
IPv4
addre
ss
family
1 1 Allows BGP to transmit VPN IPv4
routing information between PEs
and CEs in a BGP/MPLS IPv4 VPN
scenario.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
vpn-instance vpna
[HUAWEI-bgp-vpna]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 710
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
VPNv
4
addre
ss
family
1 1
2
8
Allows PEs to establish BGP VPNv4
peer relationships and exchange
VPNv4 routes in a BGP/MPLS IPv4
VPN scenario.
After a PE receives a CE's local VPN
routes, the PE adds an RD and an
export route target (ERT) to these
routes and exchanges them with its
BGP VPNv4 peers. RDs differentiate
the routes from different VPNs, and
route targets (RTs) control the
distribution of VPNv4 routes into
virtual routing and forwarding tables
(VRFs). A PE maintains only routing
information about the VPNs that the
PE accesses and does not maintain
all VPN routes on the service
provider network.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
vpnv4
[HUAWEI-bgp-af-vpnv4]
BGP-
MDT
addre
ss
family
1 6
6
Allows PEs to exchange information
about share-groups and their
multicast sources over BGP sessions
in Protocol Independent Multicast
(PIM) source-specific multicast
(SSM) scenarios.
PIM-SSM can be configured on a
public network only if PEs know the
locations of the multicast sources in
advance. Share-groups are
configured on PEs, but a PE does not
know the multicast tunnel interface
(MTI) addresses of the share-groups
on other PEs. All PEs in a multicast
domain (MD) select an MTI address
that is used to establish the public
network BGP peer relationship as
the multicast source IP address.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
mdt
[HUAWEI-bgp-af-mdt]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 711
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
multic
ast
VPN
(MVP
N)
addre
ss
family
1 5 Applies to MCAST-VPN SAFI A-D.
BGP A-D MVPN has two modes:
MDT-SAFI A-D and MCAST-VPN SAFI
A-D.
In both modes, PEs discover their
peers by sending BGP update
packets that carry MVPN
configurations, such as the RD and
share-group address. BGP A-D
MVPN services can be transmitted
over public tunnels along the PIM-
SSM MDT. Compared with MDT-SAFI
A-D, MCAST-VPN SAFI A-D has a
broader definition, supports more
extensions, and carries more MVPN
attributes and information for
establishing public network tunnels.
MCAST-VPN SAFI A-D supports the
next-generation MVPN.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
mvpn
[HUAWEI-bgp-af-mvpn]
BGP-
IPv6
unicas
t
addre
ss
family
2 1
or
4
Provides the following functions:
● Maintains public network IPv6
BGP peer relationships and
transmits public network IPv6
routes. When a BGP-IPv6 unicast
address family transmits public
network IPv6 routes, the SAFI
field is 1.
● Transmits labeled IPv6 routes.
This function mainly applies to
6PE scenario. When a BGP-IPv6
unicast address family transmits
labeled IPv6 routes, the SAFI field
is 4.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv6-family
unicast
[HUAWEI-bgp-af-ipv6]
BGP
VPN
instan
ce
IPv6
addre
ss
family
2 1 Allows BGP to transmit VPN IPv6
routing information between PEs
and CEs in a BGP/MPLS IPv6 VPN
scenario.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv6-family
vpn-instance vpna
[HUAWEI-bgp6-vpna]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 712
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
VPNv
6
addre
ss
family
2 1
2
8
Allows PEs to establish BGP VPNv6
peer relationships and exchange
VPNv6 routes in a BGP/MPLS IPv6
VPN scenario.
After a PE receives a CE's local VPN
IPv6 routes, the PE adds an RD and
an ERT to these routes and
exchanges them with its BGP VPNv6
peers. RDs differentiate routes from
different VPNs, and RTs control the
distribution of VPNv6 routes into
VRFs. A PE maintains only routing
information about the VPNs that the
PE accesses and does not maintain
all VPN routes on the service
provider network.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv6-family
vpnv6
[HUAWEI-bgp-af-vpnv6]
BGP-
L2VP
N
addre
ss
family
1
9
6
1
2
8
Allows PEs to manage L2VPN label
blocks. MPLS L2VPN in Kompella
mode uses BGP as the signaling. PEs
on an MPLS L2VPN in Kompella
mode automatically discover their
peer PEs by sending BGP update
packets that carry VPN information
and use RTs to differentiate data
from different VPNs.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] l2vpn-family
[HUAWEI-bgp-af-l2vpn]
BGP-
virtual
privat
e LAN
servic
e
(VPLS
)
addre
ss
family
2
5
6
5
Applies to Kompella VPLS. After you
configure a BGP peer relationship
between two PEs in the BGP-VPLS
address family view, the two PEs can
exchange VPLS label blocks. VPLS is
a point-to-multipoint (P2MP) L2VPN
service provided over a public
network. VPLS can be implemented
in either Kompella or Martini mode.
Kompella VPLS uses BGP as the
signaling, and Martini VPLS uses the
Label Distribution Protocol (LDP) as
the signaling.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] vpls-family
[HUAWEI-bgp-af-vpls]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 713
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
L2VP
N-AD
addre
ss
family
2
5
6
5
Allows PEs to support BGP AD VPLS.
BGP AD VPLS has the advantages of
both Kompella VPLS and Martini
VPLS. BGP-AD-VPLS-enabled devices
exchange extended BGP packets to
automatically discover member
virtual switch instances (VSIs) in a
VPLS domain and use LDP FEC 129
to negotiate pseudo wire (PW)
establishment to achieve automatic
VPLS PW deployment.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] l2vpn-ad-
family
[HUAWEI-bgp-af-l2vpn-ad]
BGP-
EVPN
addre
ss
family
view
2
5
7
0
The BGP-EVPN address family view
is mainly used to configure BGP
EVPN peers.
Ethernet virtual private network
(EVPN) is a VPN technology used for
Layer 2 internetworking. EVPN is
similar to BGP/MPLS IP VPN. EVPN
defines a new type of BGP network
layer reachability information
(NLRI), called the EVPN NLRI. The
EVPN NLRI defines new BGP EVPN
routes to implement MAC address
learning and advertisement between
Layer 2 networks at different sites.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] l2vpn-family
evpn
[HUAWEI-bgp-af-evpn]
9.2.15 BGP VPN Route Crossing
In a BGP/MPLS IP VPN scenario, after a PE receives BGP VPN routes from a CE or
BGP VPNv4 routes from a remote PE, the local PE implements route crossing to
add desired routes to the routing table of this local VPN instance and sends the
crossed routes to corresponding VPN sites, which concludes route learning in this
scenario. Route crossing can be classified as local route crossing and remote route
crossing based on the source of the BGP VPN route.
● Remote route crossing: After a PE receives a BGP VPNv4 route from a remote
PE, the local PE matches the export target (ERT) of the route against the
import targets (IRTs) configured for local VPN instances. If the ERT matches
the IRT of a local VPN instance, the PE converts the BGP VPNv4 route to a
BGP VPN route and adds the BGP VPN route to the routing table of this local
VPN instance.
● Local route crossing: A PE matches the ERT of a BGP VPN route in a local VPN
instance against the IRTs configured for other local VPN instances. If the ERT
matches the IRT of a local VPN instance, the PE adds the BGP VPN route to
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 714
the routing table of this local VPN instance. Locally crossed routes include
both locally imported routes and routes learned from VPN peers.
After a PE receives VPNv4 routes destined for the same IP address from another
PE or VPN routes from a CE, the local PE implements route crossing by following
the steps in Figure 9-21.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 715
Figure 9-21 Flowchart for BGP VPN route crossing
In Figure 9-22, PEs have the same VPN instance (vpna) and RTs (including the
ERT and IRT). The RD configured for PE2 and PE3 is 2:2, and the RD configured for
PE4 is 3:3. Site 2 has a route destined for 10.1.1.0/24. The route is sent to PE2, PE3,
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 716
and PE4, who convert this route to multiple BGP VPNv4 routes and send them to
PE1. On receipt of the BGP VPNv4 routes, PE1 implements route crossing as shown
in Figure 9-23. The detailed process is as follows:
1. After receiving the BGP VPNv4 routes from PE2, PE3, and PE4, PE1 adds them
to the BGP VPNv4 routing table.
2. The RDs configured for the VPN instance on PE2 and PE3 are the same.
Therefore, the BGP VPNv4 routes that PE2 and PE3 send to PE1 are the same.
On receipt of the BGP VPNv4 routes from PE2 and PE3, PE1 selects an optimal
BGP VPNv4 route (the route from PE3 in this example) from them, converts
the optimal BGP VPNv4 route and the BGP VPNv4 route received from PE4 to
BGP VPN routes by removing their RDs, and adds the BGP VPN routes to the
routing table of the BGP VPN instance.
3. PE1 selects an optimal BGP VPN route from the two BGP VPN routes based
on BGP route selection policies and adds the optimal BGP VPN route to the IP
VPN instance routing table.
NOTE
If a PE receives two BGP VPNv4 routes with the same RD from remote PEs, only one of the
BGP VPNv4 routes can be added to the routing table of the BGP VPN instance. As a result,
VPN FRR or load balancing cannot be implemented between VPN routes.
Figure 9-22 Route crossing networking
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 717
Figure 9-23 BGP VPN route crossing process
9.2.16 Route Processing on the BGP router
Figure 9-24 shows the route processing on the BGP router. BGP routes can be
imported from other protocols or learned from BGP peers. Route summarization
can be configured to reduce the routing table size before routes are selected,
advertised, and delivered to the IP routing table.
Figure 9-24 Route processing on the BGP router
Table 9-4 lists some key points for Figure 9-24.
Table 9-4 Key points for route processing
No. Remarks
1 BGP can import direct routes, static routes, user network routes, and IGP
routes based on the import-route (BGP) or network command
configuration.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 718
No. Remarks
2 BGP can use routing policies when importing routes from other protocols,
receiving routes from BGP peers, or advertising routes to BGP peers.
Routing policies can be used to filter routes or modify route attributes.
3 BGP supports automatic and manual summarization. Multiple routing
policies can be used during manual summarization.
4 BGP selects routes based on strict route selection rules, which is the key
point to be discussed in the following part.
5 BGP adds the optimal route to the BGP routing table and advertises it to
BGP peers.
6 BGP adds the routes learned from peers and the optimal route in the BGP
routing table to the IP routing table for traffic forwarding.
9.2.17 BGP Routing Table
Table 9-5 lists all the common route attributes that affect BGP route selection and
the commands that are used to check them.
Table 9-5 Commands used to check route attributes
Route
Attribute
Command Used to Check the Route Attribute
PrefVal display bgp routing-table [
network ]
Local_Pref display bgp routing-table [
network ]
Route type display bgp routing-table
network
AS_Path display bgp routing-table [
network ]
Origin display bgp routing-table [
network ]
MED display bgp routing-table [
network ]
Peer type display bgp routing-table
network
IGP cost ● display bgp routing-table
network
● display ip routing-table
ip-address [
mask |
mask-length ]
[ verbose ], in which
ip-address is the next hop IP address of a
BGP route
Cluster_List display bgp routing-table
network
Originator_I
D
display bgp routing-table
network
Router ID display bgp routing-table
network
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 719
Route
Attribute
Command Used to Check the Route Attribute
Peer IP
address
display bgp routing-table
network
The following example describes how to check BGP route attributes in the display
bgp routing-table command output.
<HUAWEI> display bgp routing-table
BGP Local router ID is 192.168.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 9
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
*>i 2.2.2.7/32 10.1.1.2 0 100 0 (65001)i
* i 10.1.3.1 0 100 0 (65011 65001)i
*>i 2.2.2.8/32 10.1.2.2 0 100 0 (65011)i
* i 10.1.3.2 0 100 0 (65001 65011)i
*>i 2.2.2.9/32 10.1.4.2 0 100 0 (65001 65101)i
* i 10.1.5.2 0 100 0 (65011 65101)i
i 3.3.3.9/32 10.1.6.2 0 100 0 (65001 65101) 300i
i 10.1.6.2 0 100 0 (65011 65001 65101) 300i
Table 9-6 Description of the display bgp routing-table command output
Item Description
BGP Local
router ID is
192.168.2.2 Router ID: 192.168.2.2, in the same format as an IPv4 address
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 720
Item Description
Status
codes
Route status code, displayed in front of each route entry:
● *: indicates a valid route with a reachable next hop address.
● >: indicates an optimal route selected by BGP.
● d: indicates a dampened route.
● h: indicates a History route.
● i: indicates a route learned from an IBGP peer.
● s: indicates a suppressed route. If specific routes for route
summarization are suppressed, s is displayed in front of each
specific route.
● S: indicates a route in Stale status, and the route is being
deleted. Such routes may occur during a BGP GR process.
BGP dampening measures route stability using a penalty value.
The greater the penalty value, the less stable a route. Each time
route flapping occurs (a device receives a Withdraw or an Update
packet), BGP adds a penalty value to the route carried in the
packet.
When the penalty value of a route exceeds the Suppress value,
BGP suppresses the route by replacing the > sign of the route with
the d or h sign. The route is ignored and its Update packets are
not advertised to other BGP peers until the penalty value of the
route decreases to the Reuse value.
● If d is displayed in front of a route, the route is carried in an
Update packet.
● If h is displayed in front of a route, the route is carried in a
Withdraw packet.
The penalty value is not increased after it reaches the suppression
threshold. The penalty value of a suppressed route reduces by half
after a half-life period.
● When the penalty value of a route with the d sign decreases to
the Reuse value, the route becomes reusable, and BGP removes
the d sign, adds the route to the IP routing table, and
advertises an Update packet carrying the route to BGP peers.
● When the penalty value of a route with the h sign decreases to
0, BGP deletes this route from the BGP routing table.
Origin
Route origin code, displayed in front of each route entry:
● IGP: indicates that routes are added to the BGP routing table
using the network (BGP) command.
● EGP: indicates that routes are learned through the EGP
protocol.
● Incomplete: indicates that routes are added to the BGP routing
table using the import-route (BGP) command.
Network Network address in the BGP routing table
NextHop Next hop address
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 721
Item Description
MED MED value of a BGP route, similar to the cost of IGP routes
LocPrf Local_Pref
PrefVal PrefVal
Path/Ogn AS_Path and Origin attributes
Information about Next_Hop, MED, Local_Pref, PrefVal, AS_Path, and Origin can be
displayed using the display bgp routing-table command. To check information
about the route type, peer type, IGP cost, Cluster_List, router ID, and peer IP
address, run the display bgp routing-table
network command.
<HUAWEI> display bgp routing-table 10.1.1.1
BGP local router ID : 192.168.2.2
Local AS number : 65001
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.1/32:
From: 10.1.3.1 (192.168.2.3)
Route Duration: 05h35m04s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet1/0/4
Original nexthop: 10.1.3.1
Qos information : 0x0
AS-path Nil, origin incomplete, MED 1234, localpref 100, pref-val 0, valid, internal, best, select, active,
pre 255, IGP cost 1
Not advertised to any peer yet
Table 9-7 Description of the display bgp routing-table command output
Item Description
BGP local router
ID
Router ID of the local device, in the same format as an IPv4
address.
Local AS
number
Local AS number.
Paths BGP route information.
BGP routing
table entry
information of
10.1.1.1/32
Information about the BGP route 10.1.1.1/32:
From IP address of the device that advertised the route. In this
example, 10.1.3.1 is the IP address of the interface used by
the peer to establish the BGP peer relationship (peer IP
address), and 192.168.2.3 is the router ID of the peer.
Route Duration Duration of a route.
Relay IP
Nexthop
IP address of the route to which the BGP route is recursed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 722
Item Description
Relay IP Out-
Interface
Outbound interface of the route to which the BGP route is
recursed.
Original nexthop Original next hop IP address.
Qos information QoS information.
AS-path AS_Path attribute. If Nil is displayed, the AS_Path attribute is
null.
origin
incomplete
Origin attribute:
● IGP: indicates that routes are added to the BGP routing
table using the network (BGP) command.
● EGP: indicates that routes are learned through the EGP
protocol.
● Incomplete: indicates that routes are imported using the
import-route (BGP) command.
MED MED value of a BGP route, similar to the cost of IGP routes.
localpref Local_Pref
pref-val PrefVal
valid Valid route with a reachable next hop address.
internal Type of the peer from which the route is learned.
● external: indicates that the route is learned from an EBGP
peer.
● internal: indicates that the route is learned from an IBGP
peer.
best Optimal route.
select Selected route to be delivered to the IP routing table.
NOTE
According to BGP selection rules, BGP selects only one optimal route,
and this route is marked with best. In load balancing or FRR
scenarios, more than one route needs to be added to the IP routing
table, and each of the route is marked with select. Therefore, the
number of the route marked with best is 1, and the number of the
routes marked with select is the actual number of routes added to
the IP routing table.
active Active route.
pre 255 Protocol priority of the route: 255
Not advertised
to any peer yet
The route has not advertised to any peer yet.
The display bgp routing-table
network [ {
mask |
mask-length } [ longer-
prefixes ] ] command output varies with the route generation mode and
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 723
transmission mode, and not all BGP attributes are necessarily displayed. In the
preceding example, the route type is not displayed because the route 10.1.1.1/32 is
an IBGP route. For example:
<HUAWEI> display bgp routing-table 10.0.0.0
BGP local router ID : 192.168.2.4
Local AS number : 200
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.0.0.0/8:
Aggregated route.
Route Duration: 04h50m46s
Direct Out-interface: NULL0
Original nexthop: 127.0.0.1
Qos information : 0x0
AS-path {65001 10 100}, origin incomplete, pref-val 0, valid, local, best, select, active, pre 255
Aggregator: AS 200, Aggregator ID 192.168.2.4, Atomic-aggregate
Advertised to such 3 peers:
10.1.7.2
172.16.1.2
192.168.1.2
The route 10.0.0.0/8 was manually summarized using the aggregate command.
Therefore, Aggregated route is displayed in the command output. The route type
varies as follows:
● If the route is automatically summarized using the summary automatic
command, Summary automatic route will be displayed.
● If the route is imported using the network command, Network route will be
displayed.
● If the route is imported using the import-route command, Imported route
will be displayed.
In the following example, an RR and a cluster are configured. Therefore, the
Cluster_List attribute is displayed in the display bgp routing-table
network
[ {
mask |
mask-length } [ longer-prefixes ] ] command output.
<HUAWEI> display bgp routing-table 10.2.1.0
BGP local router ID : 4.4.4.4
Local AS number : 65010
Paths: 1 available, 0 best, 0 select
BGP routing table entry information of 10.2.1.0/24:
From: 10.1.4.1 (2.2.2.2)
Route Duration: 00h00m14s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface:
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, internal, pre 255
Originator: 1.1.1.1
Cluster list: 0.0.0.1
Not advertised to any peer yet
9.2.18 Route Attributes
9.2.18.1 BGP Route Attributes
There may be multiple routes to the same destination in a BGP routing table. BGP
will select one route as the optimal route and advertise it to peers. To select the
optimal route among these routes, BGP compares the BGP attributes of the routes
in sequence based on route selection rules.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 724
BGP Attributes
Route attributes describe routes. BGP route attributes are classified into the
following types. Table 9-8 lists common BGP attributes.
● Well-known mandatory attribute
All BGP devices can identify this type of attribute, which must be carried in
Update messages. Without this type of attribute, errors occur in routing
information.
● Well-known discretionary attribute
All BGP devices can identify this type of attribute, which is optional in Update
messages. Errors do not occur in routing information even if there is a lack of
this type of attribute.
● Optional transitive attribute
This type of attribute can be transmitted between ASs. A BGP device may not
identify this type of attribute but still accepts and advertises them to peers.
● Optional non-transitive attribute
A BGP device may not identify this type of attribute, in which case it ignores
them without advertising them to peers.
Table 9-8 Common BGP attributes
Attribute Type
Origin Well-known mandatory
AS_Path Well-known mandatory
Next_Hop Well-known mandatory
Local_Pref Well-known discretionary
Community Optional transitive
MED Optional non-transitive
Originator_ID Optional non-transitive
Cluster_List Optional non-transitive
The following describes common BGP route attributes:
● Origin
The Origin attribute defines the origin of a route and marks the path of a
BGP route. The Origin attribute is classified into three types:
– IGP
A route with IGP as the Origin attribute has the highest priority. The
Origin attribute of the routes imported into a BGP routing table using the
network command is IGP.
– EGP
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 725
A route with EGP as the Origin attribute has the second highest priority.
The Origin attribute of the routes obtained through EGP is EGP.
– Incomplete
A route with Incomplete as the Origin attribute has the lowest priority.
The Origin attribute of the routes learned by other means is Incomplete.
For example, the Origin attribute of the routes imported by BGP using
the import-route command is Incomplete.
● AS_Path
The AS_Path attribute records all of the ASs that a route passes through from
the source to the destination in the vector order. To prevent inter-AS routing
loops, a BGP device does not receive the routes whose AS_Path list contains
the local AS number.
When a BGP speaker advertises an imported route:
– If the route is advertised to EBGP peers, the BGP speaker creates an
AS_Path list containing the local AS number in an Update message.
– If the route is advertised to IBGP peers, the BGP speaker creates an
empty AS_Path list in an Update message.
When a BGP speaker advertises a route learned in the Update message sent
by another BGP speaker:
– If the route is advertised to EBGP peers, the BGP speaker adds the local
AS number to the leftmost of the AS_Path list. According to the AS_Path
list, the BGP speaker that receives the route can determine the ASs
through which the route passes to reach the destination. The number of
the AS that is nearest to the local AS is placed on the top of the AS_Path
list. The other AS numbers are listed according to the sequence in which
the route passes through ASs.
– If the route is advertised to IBGP peers, the BGP speaker does not change
the AS_Path attribute of the route.
● Next_Hop
The Next_Hop attribute records the next hop that a route passes through. The
Next_Hop attribute of BGP is different from that of an IGP because it may not
be a neighboring IP address. A BGP speaker processes the Next_Hop attribute
based on the following rules:
– When advertising a route to an EBGP peer, a BGP speaker sets the
Next_Hop attribute of the route to the address of the local interface
through which the BGP peer relationship is established.
– When advertising a locally originated route to an IBGP peer, the BGP
speaker sets the Next_Hop attribute of the route to the address of the
local interface through which the BGP peer relationship is established.
– When advertising a route learned from an EBGP peer to an IBGP peer, the
BGP speaker does not change the Next_Hop attribute of the route.
● Local_Pref
The Local_Pref attribute indicates the BGP preference of a device and helps
determine the optimal route when traffic leaves an AS. When a BGP device
obtains multiple routes to the same destination address but with different
next hops from different IBGP peers, the BGP device prefers the route with the
highest Local_Pref. The Local_Pref attribute is exchanged only between IBGP
peers and is not advertised to other ASs. The Local_Pref attribute can be
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 726
manually configured. If no Local_Pref attribute is configured for a route, the
Local_Pref attribute of the route uses the default value 100.
● MED
The multi-exit discriminator (MED) attribute helps determine the optimal
route when traffic enters an AS. When a BGP device obtains multiple routes to
the same destination address but with different next hops from EBGP peers,
the BGP device selects the route with the smallest MED value as the optimal
route.
The MED attribute is exchanged only between two neighboring ASs. The AS
that receives the MED attribute does not advertise it to any other ASs. The
MED attribute can be manually configured. If no MED attribute is configured
for a route, the MED attribute of the route uses the default value 0.
● Community
The Community attribute:
– Identifies the BGP routes with the same characteristics.
– Simplifies the applications of routing policies.
– Facilitates route maintenance and management.
The Community attribute includes self-defined community attributes and
well-known community attributes. Table 9-9 lists well-known community
attributes.
Table 9-9 Well-known community attributes
Community
Attribute
Value Description
Internet 0
(0x00000000)
A BGP device can advertise the
received route with the Internet
attribute to all peers.
No_Advertise 4294967042
(0xFFFFFF02)
A BGP device does not advertise the
received route with the No_Advertise
attribute to any peer.
No_Export 4294967041
(0xFFFFFF01)
A BGP device does not advertise the
received route with the No_Export
attribute to devices outside the local
AS.
No_Export_Subc
onfed
4294967043
(0xFFFFFF03)
A BGP device does not advertise the
received route with the
No_Export_Subconfed attribute to
devices outside the local AS or to
devices outside the local sub-AS.
● Originator_ID and Cluster_List
The Originator_ID attribute and Cluster_List attribute help eliminate loops in
route reflector scenarios. For details, see 9.2.6 Route Reflector.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 727
9.2.18.2 Next_Hop
Unlike the Next_Hop attribute in an IGP, the Next_Hop attribute in BGP is not
necessarily the IP address of a neighboring device. In most cases, the Next_Hop
attribute in BGP complies with the following rules:
● When advertising a route to an EBGP peer, a BGP speaker sets the Next_Hop
of the route to the address of the local interface through which the BGP peer
relationship is established.
● When advertising a locally generated route to an IBGP peer, a BGP speaker
sets the Next_Hop of the route to the address of the local interface through
which the BGP peer relationship is established.
● When advertising a route learned from an EBGP peer to an IBGP peer, the
BGP speaker does not modify the Next_Hop of the route.
Modifying the Next_Hop
In some scenarios, the Next_Hop needs to be modified. Table 9-10 describes
whether the Next_Hop needs to be modified in specific scenarios.
Table 9-10 Next_Hop processing
Objectives Command Usage Scenarios Remarks
To enable an
ASBR to
modify the
Next_Hops
of the routes
to be
advertised to
IBGP peers.
peer {
group-
name |
ipv4-
address |
ipv6-
address } next-
hop-local
By default, when an
ASBR forwards a route
learned from an EBGP
peer to its IBGP peers,
the ASBR does not
change the Next_Hop
of the route. Therefore,
the Next_Hop address
of the route remains
the EBGP peer IP
address. After being
forwarded to the IBGP
peers, the route cannot
become active as the
Next_Hop is
unreachable. To
address this issue,
configure the ASBR to
modify the Next_Hop
of the route to the
local IP address before
advertising the route
to IBGP peers. After
being forwarded to the
IBGP peers, the route
can be active because
the Next_Hop is
reachable (an IGP is
configured in the AS).
If BGP load
balancing has
been configured
using the
maximum load-
balancing
number
command, the
switch modifies
the Next_Hop of
each route to the
local IP address
through which the
IBGP peer
relationship is
established before
it advertises the
route to IBGP
peers, regardless
of whether the
peer next-hop-
local command is
configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 728
Objectives Command Usage Scenarios Remarks
To prevent a
device from
modifying
the
Next_Hops
of the routes
imported
from an IGP
before
advertising
the routes to
IBGP peers.
peer {
ipv4-
address |
group-
name } next-hop-
invariable
- By default, a
device modifies
the Next_Hops of
the routes
imported from an
IGP to the local IP
address before
advertising the
routes to IBGP
peers.
To prevent a
device from
modifying
the
Next_Hops
of routes
before
advertising
the routes to
EBGP peers.
peer {
ipv4-
address |
group-
name } next-hop-
invariable
In an inter-AS VPN
Option C scenario
where an RR is used,
the peer next-hop-
invariable command
needs to be run on the
RR to prevent the RR
from modifying the
Next_Hops of routes
before advertising the
routes to EBGP peers.
This ensures that the
remote PE recurses
routes to the LSP
destined for the local
PE during traffic
transmission.
By default, a
device modifies
the Next_Hops of
routes to the local
IP address before
advertising the
routes to EBGP
peers.
In addition, a
device does not
modify the
Next_Hops of
non-labeled
routes if the
routes are learned
from EBGP peers
and are to be
advertised to IBGP
peers; the device
sets its interface
IP address as the
Next_Hops of
labeled routes if
the routes are
learned from
EBGP peers and
are to be
advertised to IBGP
peers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 729
Objectives Command Usage Scenarios Remarks
To configure
BGP
Next_Hop
recursion
based on a
route-policy.
nexthop
recursive-lookup
route-policy
route-policy-name
To enable a device to
recurse only desired
routes, configure
Next_Hop recursion
based on a specified
route-policy so that
only the routes that
match the route-policy
are recursed.
By default,
Next_Hop
recursion based
on a specified
route-policy is not
configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 730
Objectives Command Usage Scenarios Remarks
To enable a
device to
modify the
Next_Hops
of BGP
routes using
a route-
policy.
apply ip-address
next-hop{
ipv4-
address | peer-
address }
The Next_Hops of BGP
routes can be modified
using a route-policy in
the following
situations:
● For IBGP peers, the
route-policy can be
an import or export
policy. Even if the
next hop address
configured in the
route-policy is
unreachable, the
IBGP peers still add
the routes whose
next hop addresses
have been changed
to the address
configured in the
route-policy to the
BGP routing table.
However, the routes
are invalid.
● For EBGP peers, the
route-policy can
only be an import
policy in most cases.
If the route-policy is
configured as an
export policy, the
routes whose next
hop addresses have
been changed to
the address
configured in the
route-policy are
discarded by the
EBGP peers because
the next hop
address is
unreachable.
If a route-policy
has been specified
in the import-
route or network
command, the
apply clause
configured for the
route-policy using
the apply ip-
address next-hop
command does
not take effect.
Obtaining a Reachable Next Hop
During route selection, BGP first checks whether the next hop addresses of routes
are reachable. Routes carrying unreachable next hop addresses are invalid and are
not selected. Table 9-11 shows how to obtain a reachable next hop IP address or
tunnel.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 731
Table 9-11 Unreachable next hop
Item Description Solutions
Unreachable next hop IP
address
A next hop IP address is
obtained through route
recursion, but no active
routes to the IP address
are available in the IP
routing table.
Common solutions are as
follows:
● Configure static
routes or an IGP.
● Run the import-route
command.
● Run the network
command.
Alternatively, you can
run the peer next-hop-
local command to
change the Next_Hop to
the local IP address.
Unreachable next hop
tunnel
Routes fail to be
recursed to tunnels.
Configure a tunnel policy
or a tunnel selector to
ensure that the routes
can be recursed to
tunnels.
A next hop tunnel is
obtained through route
recursion, but the tunnel
is unavailable.
Ensure that the tunnel is
correctly configured and
is Up.
The following example shows how to obtain a reachable next hop IP address. In
Figure 9-25, an IBGP peer relationship is established between Switch A and Switch
B, and an EBGP peer relationship is established between Switch B and Switch C.
Switch A imports the route 1.1.1.9/32, and Switch C imports the route 3.3.3.9/32.
Figure 9-25 Networking
# Display the BGP routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 732
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
i 3.3.3.9/32 10.1.2.1 0 100 0 65001i
The preceding command output shows that no asterisk (*) is in front of the route
3.3.3.9/32, which indicates that the route is invalid.
# Display the IP routing table of Switch A.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 5 Routes : 5
Destination/Mask Proto Pre Cost Flags NextHop Interface
1.1.1.9/32 Direct 0 0 D 127.0.0.1 LoopBack1
10.1.1.0/30 Direct 0 0 D 10.1.1.1 GigabitEthernet0/0/0
10.1.1.1/32 Direct 0 0 D 127.0.0.1 GigabitEthernet0/0/0
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
The preceding command output shows that the next hop IP address (10.1.2.1) of
the route 3.3.3.9/32 is not in the IP routing table, which indicates that the route is
not selected due to the unreachable next hop IP address. The following solutions
can address this issue:
● Configure a static route destined for 10.1.2.1/30 on Switch A.
● Configure an IGP on Switch B and Switch C and configure BGP to import the
route 10.1.2.1 on Switch B. This solution is not applicable to this specific
scenario because Switch B and Switch C are located in different ASs.
● Run the import-route direct command on Switch B. This solution is not
optimal because unnecessary routes may be imported.
● Run the network 10.1.2.0 30 command on Switch B to advertise the route
10.1.2.0/30 to Switch A.
● Run the peer 10.1.1.1 next-hop-local command on Switch B to configure
Switch B to modify the Next_Hop of the route 3.3.3.9/32 before advertising
the route to Switch A.
In this example, the network 10.1.2.0 30 command is configured on Switch B.
After the command is configured, check the BGP routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
*>i 3.3.3.9/32 10.1.2.1 0 100 0 65001i
*>i 10.1.2.0/30 10.1.1.2 0 100 0 i
The preceding command output shows that both * and > are in front of the route
3.3.3.9/32, which indicates that the route is valid and optimal.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 733
9.2.18.3 PrefVal
PrefVal is Huawei-specific and valid only on the device where it is configured. The
PreVal attribute is set by customers. Therefore, BGP first compares the PreVal
values during route selection.
If multiple routes are available to the same destination, the route with the largest
PreVal value is selected as the optimal route. By default, the PreVal of the routes
learned from BGP peers is 0.
Table 9-12 lists two methods to modify the PreVal value.
Table 9-12 Methods to modify the PreVal value
Method Usage Scenario
Run the peer {
group-name |
ipv4-
address |
ipv6-address } preferred-
value
value command.
This method sets a PreVal value for
the routes learned from a peer or peer
group.
Configure an import policy and run the
apply preferred-value
preferred-value
command to configure an apply clause
for the policy.
This method sets different PreVal
values for different routes learned
from a peer or peer group.
NOTE
If both the methods are used, the method
with the import policy takes effect if routes
match the conditions specified in the peer
preferred-value command and the import
policy.
The following example shows how the PreVal value is used during BGP route
selection. In Figure 9-26, both ISP1 and ISP2 advertise the routes 10.11.0.0/16 and
10.22.0.0/16 to AS 65001.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 734
Figure 9-26 PreVal application networking
Scenario 1: When no PreVal value is configured on Switch A, check the BGP
routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.11.0.0/16 10.1.3.2 0 200?
* 10.1.2.2 0 300 100?
*> 10.22.0.0/16 10.1.3.2 0 200?
* 10.1.2.2 0 300 100?
The BGP routing table of Switch A shows that Switch A receives the routes
10.11.0.0/16 and 10.22.0.0/16 from ISP1 and ISP2. Check the information about
the route 10.11.0.0/16 on Switch A.
[SwitchA] display bgp routing-table 10.11.0.0
BGP local router ID : 10.1.2.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 735
From: 10.1.3.2 (10.1.3.2)
Route Duration: 00h08m35s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 200, origin incomplete, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.2.2
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h04m38s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 300 100, origin incomplete, pref-val 0, valid, external, pre 255, not preferred for AS-Path
Not advertised to any peer yet
The preceding command output shows that the AS_Path of the route learned from
ISP2 is shorter than that of the route learned from ISP1. Therefore, the route
learned from ISP2 is selected as the optimal route. Table 9-13 shows the route
attribute comparison of the routes 10.11.0.0/16 learned from ISP1 and ISP2.
Table 9-13 Route attribute comparison of the route learned from ISP1 and that
learned from ISP2
Route Attribute Route Learned
from ISP1
Route Learned
from ISP2
Comparison
PrefVal 0 0 The same.
Local_Pref - - The same.
NOTE
If a route does not
carry Local_Pref,
the default value
100 takes effect.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 300 100 200 The route learned
from ISP2 is
selected as the
optimal route
because its
AS_Path is shorter
than that of the
route learned
from ISP1.
Scenario 2: The administrator of AS 65001 requires that ISP1 be active and ISP2
be backup for the traffic to 10.11.0.0/16 and 10.22.0.0/16.
To meet the preceding requirements, run the peer {
group-name |
ipv4-address |
ipv6-address } preferred-value
value command on Switch A to increase the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 736
PrefVal values of the routes learned from ISP1. This configuration ensures that the
routes learned from ISP1 are selected as the optimal routes. Detailed
configurations are as follows:
bgp 65001
#
ipv4-family unicast
peer 10.1.2.2 preferred-value 120 //Set the PrefVal of the routes learned from AS 300 to 120.
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.11.0.0/16 10.1.2.2 120 300 100?
* 10.1.3.2 0 200?
*> 10.22.0.0/16 10.1.2.2 120 300 100?
* 10.1.3.2 0 200?
The preceding command output shows that Switch A selects the routes learned
from ISP1.
# Display detailed information about the route 10.11.0.0/16 or 10.22.0.0/16 on
Switch A. The route 10.11.0.0/16 is used as an example.
[SwitchA] display bgp routing-table 10.11.0.0
BGP local router ID : 10.1.2.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h05m36s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 300 100, origin incomplete, pref-val 120, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.2.2
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.3.2 (10.1.3.2)
Route Duration: 00h23m11s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 200, origin incomplete, pref-val 0, valid, external, pre 255, not preferred for PreVal
Not advertised to any peer yet
The preceding command output shows that the PrefVal value of the route learned
from ISP1 is greater than that of the route learned from ISP2 and that the route
learned from ISP1 is selected as the optimal route.
Scenario 3: The expected configurations of the administrator of AS 65001 are as
follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 737
● For the traffic destined to 10.11.0.0/16, ISP1 is active and ISP2 is backup.
● For the traffic destined to 10.22.0.0/16, ISP2 is active and ISP1 is backup.
To meet the preceding requirements, ensure that Switch A selects the route
10.11.0.0/16 learned from ISP1 and the route 10.22.0.0/16 learned from ISP2. In
this situation, the peer preferred-value command can no longer be used because
different PrefVal values are required for the routes learned from the same ISP. To
allow different PrefVal values for the routes learned from the same ISP, configure
import policies. Detailed configurations are as follows:
#
bgp 65001
#
ipv4-family unicast
peer 10.1.2.2 route-policy for_isp1_in import //Apply import policy named for_isp1_in to the routes
learned from 10.1.2.2 and use for_isp1_in to modify the PrefVal value.
peer 10.1.3.2 route-policy for_isp2_in import //Apply import policy named for_isp2_in to the routes
learned from 10.1.3.2 and use for_isp2_in to modify the PrefVal value.
#
route-policy for_isp1_in permit node 10 //Define the first node of for_isp1_in and set the PrefVal
value of the route 10.11.0.0/16 to 80.
if-match ip-prefix for_isp1
apply preferred-value 80
#
route-policy for_isp1_in permit node 20 //Define the second node of for_isp1_in and allow
for_isp1_in to permit all routes.
#
route-policy for_isp2_in permit node 10 //Define the first node of for_isp2_in and set the PrefVal
value of the route 10.22.0.0/16 to 120.
if-match ip-prefix for_isp2
apply preferred-value 120
#
route-policy for_isp2_in permit node 20 //Define the second node of for_isp2_in and allow
for_isp2_in to permit all routes.
#
ip ip-prefix for_isp1 index 10 permit 10.11.0.0 16 //Configure an IP prefix list to match the route
10.11.0.0/16.
ip ip-prefix for_isp2 index 10 permit 10.22.0.0 16 //Configure an IP prefix list to match the route
10.22.0.0/16.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.11.0.0/16 10.1.2.2 80 300 100?
* 10.1.3.2 0 200?
*> 10.22.0.0/16 10.1.3.2 120 200?
* 10.1.2.2 0 300 100?
The preceding command output shows that Switch A selects the route
10.11.0.0/16 learned from ISP1 and the route 10.22.0.0/16 learned from ISP2.
# Display detailed information about the route 10.22.0.0/16 on Switch A.
[SwitchA] display bgp routing-table 10.22.0.0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 738
BGP local router ID : 10.1.2.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.22.0.0/16:
From: 10.1.3.2 (10.1.3.2)
Route Duration: 00h14m14s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 200, origin incomplete, pref-val 120, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.2.2
BGP routing table entry information of 10.22.0.0/16:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h07m54s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 300 100, origin incomplete, pref-val 0, valid, external, pre 255, not preferred for PreVal
Not advertised to any peer yet
The preceding command output shows that two routes 10.22.0.0/16 are available
in the BGP routing table of Switch A and that the route with the next hop address
10.1.3.2 is selected because its PrefVal (120) is greater than the PrefVal (0) of the
route with next hop address 10.1.2.2. The PrefVal value is sufficient enough to
determine the optimal route, and therefore, Switch A does not compare other
route attributes.
The preceding examples show that PrefVal values can be configured as required to
control the traffic forwarding path.
9.2.18.4 Local_Pref
The Local_Pref attribute is used to determine the optimal route when traffic leaves
an AS. The Local_Pref attribute is available only to IBGP peers and is not
advertised to other ASs.
Table 9-14 lists two methods to modify the Local_Pref value.
Table 9-14 Methods to modify the Local_Pref value
Method Usage Scenario
Run the default local-preference
command.
This method sets a default Local_Pref
for the routes that the local device
advertises to IBGP peers.
Configure an import or export policy
and run the apply local-preference
command to configure an apply clause
for the policy.
This method sets different Local_Pref
values for different routes that the
local device advertises to IBGP peers.
NOTE
If both the methods are used, the method
with the import policy takes effect if routes
match the conditions specified in the apply
local-preference command and the policy.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 739
The following example shows how the Local_Pref value is used during BGP route
selection. In Figure 9-27, both ISP1 and ISP2 advertise the routes 10.11.0.0/16 and
10.22.0.0/16 to AS 65001.
Figure 9-27 Local_Pref application networking
Scenario 1: When no Local_Pref value is configured on Switch A and Switch B,
check the BGP routing tables of Switch A and Switch B.
[SwitchA] display bgp routing-table
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/30 0.0.0.0 0 0 i
*>i 10.1.2.0/30 10.1.3.2 0 100 0 i
*> 10.11.0.0/16 10.1.1.1 0 100 10i
* i 10.1.2.1 100 0 200 10i
*> 10.22.0.0/16 10.1.1.1 0 100 10i
* i 10.1.2.1 100 0 200 10i
The BGP routing table of Switch A shows that Switch A receives the routes
10.11.0.0/16 and 10.22.0.0/16 from ISP1 and Switch B. Check the information
about the route 10.11.0.0/16 on Switch A.
[SwitchA] display bgp routing-table 10.11.0.0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 740
BGP local router ID : 192.168.2.3
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.1.1 (192.168.2.5)
Route Duration: 04h41m03s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.4.2
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.3.2 (192.168.2.2)
Route Duration: 01h42m40s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet1/0/3
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for peer type
Not advertised to any peer yet
The preceding command output shows that the route learned from ISP1 is
selected as the optimal route because it is an EBGP route and the route learned
from Switch B is an IBGP route. Table 9-15 shows the route attribute comparison
of the routes 10.11.0.0/16 learned from ISP1 and Switch B.
Table 9-15 Route attribute comparison of the routes 10.11.0.0/16 learned from
ISP1 and Switch B
Route Attribute Route Learned
from ISP1
Route Learned
from Switch B
Comparison
PrefVal 0 0 The same.
Local_Pref - 100 The same.
NOTE
If a route does not
carry Local_Pref,
the default value
100 takes effect.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 100 10 200 10 The same length.
Origin IGP IGP The same.
MED - - The same.
Peer type EBGP IBGP Route
10.11.0.0/16
learned from ISP1
is optimal.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 741
The route selection process on Switch B is the same as that on Switch A. Then,
Switch A and Switch B advertise the optimal routes to Switch C. Check the routing
table of Switch C.
[SwitchC] display bgp routing-table
Total Number of Routes: 6
BGP Local router ID is 192.168.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.4.1 0 100 0 i
*>i 10.1.2.0/30 10.1.5.1 0 100 0 i
*>i 10.11.0.0/16 10.1.2.1 100 0 200 10i
* i 10.1.1.1 100 0 100 10i
*>i 10.22.0.0/16 10.1.2.1 100 0 200 10i
* i 10.1.1.1 100 0 100 10i
The preceding command output shows that Switch C selects the routes advertised
by Switch B.
Check the reason why the routes learned from Switch A are not selected on Switch
C. The route 10.11.0.0/16 is used as an example.
[SwitchC] display bgp routing-table 10.11.0.0
BGP local router ID : 192.168.2.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.5.1 (192.168.2.2)
Route Duration: 00h12m46s
Relay IP Nexthop: 10.1.5.1
Relay IP Out-Interface: GigabitEthernet1/0/1
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Not advertised to any peer yet
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.4.1 (192.168.2.3)
Route Duration: 00h17m30s
Relay IP Nexthop: 10.1.4.1
Relay IP Out-Interface: GigabitEthernet1/0/0
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for router ID
Not advertised to any peer yet
The preceding command output shows that Switch C selects the route
10.11.0.0/16 learned from Switch B because the router ID (192.168.2.2) of Switch
B is smaller than that (192.168.2.3) of Switch A. Table 9-16 shows the route
attribute comparison of the routes 10.11.0.0/16 learned from Switch A and Switch
B.
Table 9-16 Route attribute comparison of the routes 10.11.0.0/16 learned from
Switch A and Switch B
Route Attribute Route Learned
from Switch A
Route Learned
from Switch B
Comparison
PrefVal 0 0 The same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 742
Route Attribute Route Learned
from Switch A
Route Learned
from Switch B
Comparison
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 100 10 200 10 The same length.
Origin IGP IGP The same.
MED - - The same.
Peer type IBGP IBGP The same.
IGP cost - - The same.
Cluster_List - - The same length.
Router ID 192.168.2.3 192.168.2.2 Route
10.11.0.0/16
learned from
Switch B is
optimal.
Scenario 2: The administrator of AS 65001 requires that ISP1 be active and ISP2
be backup for the traffic to 10.11.0.0/16 and 10.22.0.0/16.
To meet the preceding requirements, run the default local-preference command
on Switch A to increase the Local_Pref values of the routes learned from Switch A.
This configuration ensures that the routes learned from ISP1 are selected as the
optimal routes. Detailed configurations are as follows:
#
bgp 65001
#
ipv4-family unicast
default local-preference 120 //Set the Local_Pref of the routes to be advertised to 120.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/30 0.0.0.0 0 0 i
*>i 10.1.2.0/30 10.1.3.2 0 100 0 i
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 743
*> 10.11.0.0/16 10.1.1.1 0 100 10i
*> 10.22.0.0/16 10.1.1.1 0 100 10i
The preceding command output shows that Switch A selects the routes learned
from ISP1.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 192.168.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.3.1 0 120 0 i
*> 10.1.2.0/30 0.0.0.0 0 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
* 10.1.2.1 0 200 10i
*>i 10.22.0.0/16 10.1.1.1 120 0 100 10i
* 10.1.2.1 0 200 10i
The preceding command output shows that Switch B selects the routes learned
from Switch A. Switch B does not advertise the routes learned from ISP2 to its
IBGP peers because those routes are not selected.
# Display detailed information about the route 10.11.0.0/16 or 10.22.0.0/16 on
Switch B. The route 10.11.0.0/16 is used as an example.
[SwitchB] display bgp routing-table 10.11.0.0
BGP local router ID : 192.168.2.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.3.1 (192.168.2.3)
Route Duration: 00h22m16s
Relay IP Nexthop: 10.1.3.1
Relay IP Out-Interface: GigabitEthernet1/0/4
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, localpref 120, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
10.1.2.1
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.2.1 (192.168.2.4)
Route Duration: 00h22m23s
Direct Out-interface: GigabitEthernet1/0/0
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, pref-val 0, valid, external, pre 255, not preferred for Local_Pref
Not advertised to any peer yet
The preceding command output shows that the Local_Pref value of the route
learned from Switch A is greater than that of the route learned from ISP2 and that
the route learned from Switch A is selected as the optimal route. Table 9-17
shows the route attribute comparison of the routes 10.11.0.0/16 learned from
Switch A and ISP2.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 744
Table 9-17 Route attribute comparison of the routes 10.11.0.0/16 learned from
Switch A and ISP2
Route Attribute Route Learned
from Switch A
Route Learned
from ISP2
Comparison
PrefVal 0 0 The same.
Local_Pref 120 - Route
10.11.0.0/16
learned from
Switch A is
optimal.
NOTE
If a route does not
carry Local_Pref,
the default value
100 takes effect.
# Display the routing table of Switch C.
[SwitchC] display bgp routing-table
Total Number of Routes: 4
BGP Local router ID is 192.168.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.4.1 0 120 0 i
*>i 10.1.2.0/30 10.1.5.1 0 100 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
*>i 10.22.0.0/16 10.1.1.1 120 0 100 10i
Switch C selects the routes advertised by ISP1 because Switch B did not advertise
the routes learned from ISP2 to Switch C.
Scenario 3: The requirements of the administrator of AS 65001 are as follows:
● ISP1 is active and ISP2 is backup for the traffic to 10.11.0.0/16.
● ISP2 is active and ISP1 is backup for the traffic to 10.22.0.0/16.
To meet the preceding requirements, ensure that AS 65001 selects the route
10.11.0.0/16 learned from Switch A and the route 10.22.0.0/16 learned from
Switch B. Detailed configurations are as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 745
Figure 9-28 Local_Pref-based BGP route selection networking (1)
In this situation, different Local_Pref values are required for the routes learned
from the same ISP. To configure different Local_Pref values for the routes learned
from the same ISP, configure route-policies. Detailed configurations are as follows:
● Configurations on Switch A
#
bgp 65001
#
ipv4-family unicast
peer 10.1.1.1 route-policy rp1 import //Apply import policy named rp1 to the routes
learned from 10.1.1.1 and use rp1 to modify the Local_Pref.
#
route-policy rp1 permit node 10 //Define the first node of rp1 and set the Local_Pref
value of the route 10.11.0.0/16 to 120.
if-match ip-prefix addpref
apply local-preference 120
#
route-policy rp1 permit node 20 //Define the second node of rp1 and set the
Local_Pref value of the route 10.22.0.0/16 to 80.
if-match ip-prefix reducepref
apply local-preference 80
#
route-policy rp1 permit node 30 //Define the third node of rp1 and allow rp1 to
permit all routes.
#
ip ip-prefix addpref index 10 permit 10.11.0.0 16 //Configure an IP prefix list to match the route
10.11.0.0/16.
ip ip-prefix reducepref index 10 permit 10.22.0.0 16 //Configure an IP prefix list to match the route
10.22.0.0/16.
#
● Configurations on Switch B
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 746
bgp 65001
#
ipv4-family unicast
peer 10.1.2.1 route-policy rp2 import //Apply import policy named rp2 to the routes
learned from 10.1.1.1 and use rp2 to modify the Local_Pref.
#
route-policy rp2 permit node 10 //Define the first node of rp2 and set the Local_Pref
value of the route 10.22.0.0/16 to 200.
if-match ip-prefix addpref
apply local-preference 200
#
route-policy rp2 permit node 20 //Define the second node of rp2 and set the
Local_Pref value of the route 10.11.0.0/16 to 60.
if-match ip-prefix reducepref
apply local-preference 60
#
route-policy rp2 permit node 30 //Define the third node of rp2 and allow rp2 to
permit all routes.
#
ip ip-prefix addpref index 10 permit 10.22.0.0 16 //Configure an IP prefix list to match the route
10.22.0.0/16.
ip ip-prefix reducepref index 10 permit 10.11.0.0 16 //Configure an IP prefix list to match the route
10.11.0.0/16.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/30 0.0.0.0 0 0 i
*>i 10.1.2.0/30 10.1.3.2 0 100 0 i
*> 10.11.0.0/16 10.1.1.1 120 0 100 10i
*>i 10.22.0.0/16 10.1.2.1 200 0 200 10i
* 10.1.1.1 80 0 100 10i
# Display detailed information about the route 10.22.0.0/16 on Switch A.
[SwitchA] display bgp routing-table 10.22.0.0
BGP local router ID : 192.168.2.3
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.22.0.0/16:
From: 10.1.3.2 (192.168.2.2)
Route Duration: 00h20m12s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet1/0/3
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 200, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
10.1.1.1
BGP routing table entry information of 10.22.0.0/16:
From: 10.1.1.1 (192.168.2.5)
Route Duration: 00h19m40s
Direct Out-interface: GigabitEthernet1/0/1
Original nexthop: 10.1.1.1
Qos information : 0x0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 747
AS-path 100 10, origin igp, localpref 80, pref-val 0, valid, external, pre 255, not preferred for Local_Pref
Not advertised to any peer yet
The preceding command output shows that two routes 10.22.0.0/16 are available
in the BGP routing table of Switch A and that the route with next hop address
10.1.2.1 is selected because its Local_Pref (200) is greater than the Local_Pref (80)
of the route with next hop address 10.1.1.1.
Table 9-18 shows the route attribute comparison of the routes 10.22.0.0/16
learned from ISP1 and Switch B.
Table 9-18 Route attribute comparison of the routes 10.22.0.0/16 learned from
ISP1 and Switch B.
Route Attribute Route Learned
from ISP1
Route Learned
from Switch B
Comparison
PrefVal 0 0 The same.
Local_Pref 80 200 Route
10.22.0.0/16
learned from
Switch B is
optimal.
The route with next hop address 10.1.1.1 is not optimal, and therefore, it is not
advertised to Switch B and Switch C. In addition, the route 10.11.0.0/16 with next
hop address 10.1.2.1 is not optimal on Switch B, and therefore, Switch B does not
advertise this route to Switch A and Switch C. As a result, only one route
10.11.0.0/16 with next hop address 10.1.1.1 is available in the BGP routing table of
Switch A.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 192.168.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.3.1 0 100 0 i
*> 10.1.2.0/30 0.0.0.0 0 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
* 10.1.2.1 60 0 200 10i
*> 10.22.0.0/16 10.1.2.1 200 0 200 10i
# Display detailed information about the route 10.11.0.0/16 on Switch B.
[SwitchB] display bgp routing-table 10.11.0.0
BGP local router ID : 192.168.2.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.3.1 (192.168.2.3)
Route Duration: 00h40m28s
Relay IP Nexthop: 10.1.3.1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 748
Relay IP Out-Interface: GigabitEthernet1/0/4
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, localpref 120, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
10.1.2.1
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.2.1 (192.168.2.4)
Route Duration: 00h41m00s
Direct Out-interface: GigabitEthernet1/0/0
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 60, pref-val 0, valid, external, pre 255, not preferred for Local_Pref
Not advertised to any peer yet
The preceding command output shows that two routes 10.11.0.0/16 are available
in the BGP routing table of Switch B and that the route with next hop address
10.1.1.1 is selected because its Local_Pref (120) is greater than the Local_Pref (60)
of the route with next hop address 10.1.2.1. The route with next hop address
10.1.2.1 is not advertised to Switch A and Switch C because it is not optimal.
# Display the routing table of Switch C.
[SwitchC] display bgp routing-table
Total Number of Routes: 4
BGP Local router ID is 192.168.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.4.1 0 100 0 i
*>i 10.1.2.0/30 10.1.5.1 0 100 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
*>i 10.22.0.0/16 10.1.2.1 200 0 200 10i
The preceding command output shows that the next hop address of the route
10.11.0.0/16 is 10.1.1.1 and that the next hop address of the route 10.22.0.0/16 is
10.1.2.1.
Scenario 4: The requirements of the administrator of AS 65001 are as follows:
● ISP1 is active and ISP2 is backup for the traffic from Switch A and Switch C to
10.11.0.0/16 and 10.22.0.0/16.
● ISP2 is active and ISP1 is backup for the traffic from Switch B to 10.11.0.0/16
and 10.22.0.0/16.
To meet the preceding requirements, ensure that Switch A and Switch C select the
routes learned from ISP1. Detailed configurations are as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 749
Figure 9-29 Local_Pref-based BGP route selection networking (2)
You can perform either of the following operations:
● Configure an export policy on Switch A to modify the Local_Pref of the routes
to be advertised to Switch C.
● Configure an import policy on Switch C to modify the Local_Pref of the routes
learned from Switch A.
The configurations on Switch A are used as an example. Detailed configurations
are as follows:
#
bgp 65001
#
ipv4-family unicast
peer 10.1.4.2 route-policy rp2 export //Apply the export route-policy rp2 to the route destined
for the peer 10.1.4.1 to modify the Local_Pref of the route.
#
route-policy rp2 permit node 10 //Define the node index of the route-policy rp2 to 10 and
set the Local_Pref to 120.
apply local-preference 120
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 750
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/30 0.0.0.0 0 0 i
*>i 10.1.2.0/30 10.1.3.2 0 100 0 i
*> 10.11.0.0/16 10.1.1.1 0 100 10i
* i 10.1.2.1 100 0 200 10i
*> 10.22.0.0/16 10.1.1.1 0 100 10i
* i 10.1.2.1 100 0 200 10i
The preceding command output shows that Switch A selects the routes learned
from ISP1.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 192.168.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.3.1 0 100 0 i
*> 10.1.2.0/30 0.0.0.0 0 0 i
*> 10.11.0.0/16 10.1.2.1 0 200 10i
* i 10.1.1.1 100 0 100 10i
*> 10.22.0.0/16 10.1.2.1 0 200 10i
* i 10.1.1.1 100 0 100 10i
The preceding command output shows that Switch B selects the routes learned
from ISP2.
# Display the routing table of Switch C.
[SwitchC] display bgp routing-table
Total Number of Routes: 6
BGP Local router ID is 192.168.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.4.1 0 120 0 i
*>i 10.1.2.0/30 10.1.5.1 0 100 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
* i 10.1.2.1 100 0 200 10i
*>i 10.22.0.0/16 10.1.1.1 120 0 100 10i
* i 10.1.2.1 100 0 200 10i
The preceding command output shows that Switch C selects the routes learned
from ISP1.
# Display detailed information about the route 10.11.0.0/16 or 10.22.0.0/16 on
Switch C. The route 10.11.0.0/16 is used as an example.
[SwitchC] display bgp routing-table 10.11.0.0
BGP local router ID : 192.168.2.1
Local AS number : 65001
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 751
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.4.1 (192.168.2.3)
Route Duration: 00h06m26s
Relay IP Nexthop: 10.1.4.1
Relay IP Out-Interface: GigabitEthernet1/0/0
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, localpref 120, pref-val 0, valid, internal, best, select, active, pre 255
Not advertised to any peer yet
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.5.1 (192.168.2.2)
Route Duration: 00h08m05s
Relay IP Nexthop: 10.1.5.1
Relay IP Out-Interface: GigabitEthernet1/0/1
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for Local_Pref
Not advertised to any peer yet
The preceding command output shows that Switch C selects the routes learned
from ISP1 because the Local_Pref of the routes learned from ISP1 is greater than
that of the route learned from ISP2.
The preceding examples show that the modification of the Local_Pref values
affects not only BGP route advertisement but also BGP route selection with an AS.
We can configure Local_Pref values as required to control the forwarding path of
the traffic that leaves an AS.
9.2.18.5 Route Type
BGP routes can be locally imported or learned from peers. The locally imported
routes take precedence over the routes learned from peers during BGP route
selection. It is unusual for locally imported routes and the routes learned from
peers to carry the same destination IP address and coexist in the routing table.
Generally, locally imported routes can be the routes imported using the network
or import-route command and the automatically and manually summarized
routes. Precedences of these routes are described as follows:
1. Summarized routes take precedence over non-summarized routes.
2. Summarized routes that are manually generated using the aggregate
command take precedence over summarized routes that are automatically
generated based on the summary automatic command settings.
3. The routes imported using the network command take precedence over the
routes imported using the import-route command.
In Figure 9-30, Switch A and Switch B are EBGP peers, and Switch B, Switch C, and
Switch D are IBGP peers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 752
Figure 9-30 Networking
The configurations on Switch C are as follows:
#
bgp 65001
#
ipv4-family unicast
network 10.1.2.0 255.255.255.252 //Advertise the route 10.1.2.0/30.
network 10.1.4.0 255.255.255.252 //Advertise the route 10.1.4.0/30.
import-route direct //Import direct routes.
#
The configurations on Switch D are as follows:
#
bgp 65001
#
ipv4-family unicast
network 10.1.3.0 255.255.255.252 //Advertise the route 10.1.3.0/30.
network 10.1.4.0 255.255.255.252 //Advertise the route 10.1.4.0/30.
import-route direct //Import direct routes.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch D.
[SwitchD] display bgp routing-table
BGP Local router ID is 10.1.3.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 10
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.2.0/30 10.1.4.2 0 100 0 i
*> 10.1.3.0/30 0.0.0.0 0 0 i
* 0.0.0.0 0 0 ?
*> 10.1.3.2/32 0.0.0.0 0 0 ?
*> 10.1.4.0/30 0.0.0.0 0 0 i
* 0.0.0.0 0 0 ?
i 10.1.4.2 0 100 0 ?
*> 10.1.4.1/32 0.0.0.0 0 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
The preceding command output shows that three routes 10.1.4.0/30 are available
in the routing table. The route with the next hop address 10.1.4.2 is learned from
a peer (Switch C). Therefore, BGP first excludes this route from route selection.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 753
[SwitchD] display bgp routing-table 10.1.4.0 30
BGP local router ID : 10.1.3.2
Local AS number : 65001
Paths: 3 available, 1 best, 1 select
BGP routing table entry information of 10.1.4.0/30:
Network route.
From: 0.0.0.0 (0.0.0.0)
Route Duration: 00h03m51s
Direct Out-interface: GigabitEthernet0/0/4
Original nexthop: 10.1.4.1
Qos information : 0x0
AS-path Nil, origin igp, MED 0, pref-val 0, valid, local, best, select, pre 0
Advertised to such 2 peers:
10.1.3.1
10.1.4.2
BGP routing table entry information of 10.1.4.0/30:
Imported route.
From: 0.0.0.0 (0.0.0.0)
Route Duration: 00h04m10s
Direct Out-interface: GigabitEthernet0/0/4
Original nexthop: 10.1.4.1
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, pref-val 0, valid, local, pre 0, not preferred for route type
Not advertised to any peer yet
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.4.2 (10.1.2.2)
Route Duration: 00h02m24s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/4
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, localpref 100, pref-val 0, internal, pre 255
Not advertised to any peer yet
The preceding command output shows that the route imported using the network
command is selected as the optimal route.
The configurations on Switch B are as follows:
bgp 65001
#
ipv4-family unicast
summary automatic
aggregate 10.0.0.0 255.0.0.0
import-route direct
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.1.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 14
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.0.0 127.0.0.1 0 ?
* 127.0.0.1 0 ?
s> 10.1.1.0/30 0.0.0.0 0 0 ?
*> 10.1.1.2/32 0.0.0.0 0 0 ?
s> 10.1.2.0/30 0.0.0.0 0 0 ?
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 754
i 10.1.2.2 0 100 0 i
*> 10.1.2.1/32 0.0.0.0 0 0 ?
s> 10.1.3.0/30 0.0.0.0 0 0 ?
i 10.1.3.2 0 100 0 i
*> 10.1.3.1/32 0.0.0.0 0 0 ?
*>i 10.1.4.0/30 10.1.3.2 0 100 0 i
* i 10.1.2.2 0 100 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
The preceding command output shows that two summarized routes 10.0.0.0 are
available in the routing table.
[SwitchB] display bgp routing-table 10.0.0.0
BGP local router ID : 10.1.1.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.0.0.0/8:
Aggregated route.
Route Duration: 00h17m04s
Direct Out-interface: NULL0
Original nexthop: 127.0.0.1
Qos information : 0x0
AS-path Nil, origin incomplete, pref-val 0, valid, local, best, select, active, pre 255
Aggregator: AS 65001, Aggregator ID 10.1.1.2
Advertised to such 3 peers:
10.1.1.1
10.1.3.2
10.1.2.2
BGP routing table entry information of 10.0.0.0/8:
Summary automatic route
Route Duration: 00h17m04s
Direct Out-interface: NULL0
Original nexthop: 127.0.0.1
Qos information : 0x0
AS-path Nil, origin incomplete, pref-val 0, valid, local, pre 255, not preferred for route type
Aggregator: AS 65001, Aggregator ID 10.1.1.2
Not advertised to any peer yet
The preceding command output shows that the route generated using the
aggregate command is selected as the optimal route.
9.2.18.6 AS_Path
Four types of AS_Path attributes are available:
● AS_Sequence: records in reverse order all the ASs through which a route
passes from the local device to the destination.
● AS_Set: records in random order all the ASs through which a route passes
from the local device to the destination. The AS_Set attribute is used in route
summarization scenarios.
● AS_Confed_Sequence: records in reverse order all the sub-ASs within a BGP
confederation through which a route passes from the local device to the
destination.
● AS_Confed_Set: records in random order all the sub-ASs within a BGP
confederation through which a route passes from the local device to the
destination.
Table 9-19 describes the AS_Path-based route selection rules.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 755
Table 9-19 AS_Path-based route selection rules
Item Description
AS_Set BGP takes an AS_Set as one AS number even if the
AS_Set contains multiple AS numbers.
When the aggregate (BGP) command is
configured to generate a manually summarized
route, if as-set is specified in the command, AS_Set
will be carried in the summarized route. The
information in the AS_Set is as follows:
● If the routes used in the summarization carry
the same AS_Sequence, this AS_Sequence is
carried in the summarized route, and the AS_Set
of the summarized route is null.
● If the routes used in the summarization carry
different AS_Sequences, all the AS numbers
carried in the AS_Sequences are included in the
AS_Set of the summarized route.
AS_Confed_Sequence and
AS_Confed_Set
BGP ignores AS_Confed_Sequence and
AS_Confed_Set when calculating the AS_Path
length.
bestroute as-path-ignore After the command is configured, BGP does not
compare the AS_Path attribute during route
selection.
apply as-path The command can be run to configure an apply
clause for a route-policy so that the ASs in the
AS_Path of the route that matches the route-policy
are cleared or replaced, or new ASs are added.
NOTE
The configuration of the apply as-path command may
change the traffic forwarding path, or cause routing loops
or route selection errors. Therefore, exercise caution when
configuring the command.
peer public-as-only After the command is configured, BGP deletes
private AS numbers (if any) from the AS_Path
attribute before sending Update packets. Private AS
numbers range from 64512 to 65534.
peer fake-as After the command is configured, BGP can use a
fake AS number to set up a BGP peer relationship.
If the local device uses the actual AS number to
establish an EBGP peer relationship with a remote
device, the actual AS number is carried in the
AS_Path of the route sent to the remote device. If
the local device uses the fake AS number to
establish the EBGP peer relationship, the fake AS
number is carried in the AS_Path of the route sent
to the remote device.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 756
Item Description
peer substitute-as If the command is configured and an AS in the
AS_Path carried in the route sent by a PE to the CE
of the specified peer is the same as the AS of the
CE, the PE replaces the AS with the local AS.
NOTE
The peer substitute-as command applies only to PEs in
BGP MPLS IP/VPN scenarios and may cause routing loops
if it is improperly configured. Therefore, exercise caution
when using the command.
During BGP route selection, BGP compares the AS_Path length by calculating the
number of ASs included in the AS_Sequence if AS_Sequence is carried in a route. If
both AS_Sequence and AS_Set are carried in the route, BGP considers the AS_Path
length to be the number of ASs included in the AS_Sequence plus 1.
Deleting Private AS Numbers
As public AS resources are limited, carriers generally use private AS numbers when
deploying VPNs. Private AS numbers, however, must not be advertised to the
Internet because they may cause routing loops. In Figure 9-31, both ISP1 and ISP2
use 65001 as a private AS number.
Figure 9-31 Networking in which a private AS needs to be deleted
In Figure 9-31, Switch A advertises the route 10.0.0.0/8 to Switch D through ISP1
and ISP2. After receiving this route, Switch D checks its AS_Path. This AS_Path
carries AS 65001, which is the same as the AS of Switch D. As a result, Switch D
discards this route.
To address this problem, run the peer public-as-only command on Switch B so
that Switch B deletes AS 65001 before adding AS 100 (public AS) to the AS_Path
and forwarding the route to Switch C.
In the following situations, after the peer public-as-only command is configured,
BGP does not delete any private AS number from the AS_Path:
● The AS_Path of a route carries the AS number of the remote peer. In this case,
deleting private AS numbers may lead to a routing loop.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 757
● The AS_Path carries both public and private AS numbers, which indicates that
the route has passed through the public network. In this case, deleting private
AS numbers may lead to incorrect traffic forwarding.
The preceding limitations also apply to confederation scenarios.
Adding AS Numbers
In Figure 9-32, AS 65005 imports three routes and advertises them to AS 65001
through two paths.
Figure 9-32 Networking in which new AS numbers are added to the AS_Path
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 172.16.1.0/24 10.1.3.2 0 65003 65005?
* 10.1.1.2 0 65002 65004 65005?
*> 172.16.2.0/24 10.1.3.2 0 65003 65005?
* 10.1.1.2 0 65002 65004 65005?
*> 172.16.3.0/24 10.1.3.2 0 65003 65005?
* 10.1.1.2 0 65002 65004 65005?
[SwitchA] display bgp routing-table 172.16.1.0
BGP local router ID : 10.1.1.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 758
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.3.2 (10.1.5.1)
Route Duration: 00h00m56s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 65003 65005, origin incomplete, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.1.2
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.1.2 (10.1.1.2)
Route Duration: 00h34m43s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path 65002 65004 65005, origin incomplete, pref-val 0, valid, external, pre 255, not preferred for AS-
Path
Not advertised to any peer yet
The preceding command output shows that Switch A selects the route learned
from Switch C because this route has a shorter AS_Path length than that learned
from Switch B. To enable Switch A to select the route learned from Switch B,
configure Switch B to reduce the AS_Path length of the route or configure Switch
C to increase the AS_Path length of the route. In the following example, Switch C
is configured to increase the AS_Path length of the route. The detailed
configurations on Switch C are as follows:
#
bgp 65003
#
ipv4-family unicast
undo synchronization
peer 10.1.3.1 route-policy add_asn export //Apply export policy named add_asn to routes to be
advertised to 10.1.3.1.
#
route-policy add_asn permit node 10 //Define the first node of add_asn.
if-match ip-prefix prefix1 //Configure IP prefix list named prefix1.
apply as-path 65003 65003 65003 additive //Add 65003, 65003, 65003 to the AS_Path of the
route that matches prefix1.
#
route-policy add_asn permit node 20 //Define the second node of add_asn to permit all other
routes.
#
ip ip-prefix prefix1 index 10 permit 172.16.1.0 24 //Define the first index of prefix1 to match the route
172.16.1.0/24.
ip ip-prefix prefix1 index 20 permit 172.16.2.0 24 //Define the second index of prefix1 to match the
route 172.16.2.0/24.
ip ip-prefix prefix1 index 30 permit 172.16.3.0 24 //Define the third index of prefix1 to match the route
172.16.3.0/24.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 759
*> 172.16.1.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65003 65003 65003 65003 65005?
*> 172.16.2.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65003 65003 65003 65003 65005?
*> 172.16.3.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65003 65003 65003 65003 65005?
[SwitchA] display bgp routing-table 172.16.1.0
BGP local router ID : 10.1.1.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.1.2 (10.1.1.2)
Route Duration: 00h33m30s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path 65002 65004 65005, origin incomplete, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.1.2
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.3.2 (10.1.5.1)
Route Duration: 00h02m12s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 65003 65003 65003 65003 65005, origin incomplete, pref-val 0, valid, external, pre 255, not
preferred for AS-Path
Not advertised to any peer yet
The preceding command output shows that the AS_Path length of the route
learned from Switch B is shorter than that of the route learned from Switch C and
that the route learned from Switch B is selected as the optimal route. Table 9-20
shows the attribute comparison of the routes 172.16.1.0 learned from Switch B
and Switch C.
Table 9-20 Attribute comparison of the routes 172.16.1.0 learned from Switch B
and Switch C
Route Attribute Route Learned
from Switch B
Route Learned
from Switch C
Comparison
PrefVal 0 0 The same.
Local_Pref - - The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 65002 65004
65005
65003 65003
65003 65003
65005
The route learned
from Switch B is
optimal.
AS numbers can be added to the AS_Path as required. However, if an AS number is
added to the AS_Path of a route, the route cannot be received by devices in this
AS. Therefore, the local AS number is added in most cases. For example in Figure
9-32, if Switch C adds AS 65001 to the AS_Path of a route before advertising the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 760
route to Switch A, Switch A will discard the route upon receipt because the route
carries Switch A's AS number.
Replacing AS Numbers
When the apply as-path command is configured, if overwrite is specified in the
command, the device will replace the AS numbers in the original AS_Path attribute
to achieve the following goals:
● Hide the actual path information.
● Prevent a route from being discarded by replacing the AS_Path of the route
with a shorter one if the as-path-limit command is configured on the device
that receives this route.
● Reduce the AS_Path length.
AS number replacement can also be used for the purpose of load balancing. For
example in Figure 9-32, the apply as-path 65002 65004 65005 overwrite
command can be configured on Switch A to replace the AS_Path of the route
learned from Switch C so that the route has the same AS_Path as that of the route
learned from Switch B, and the two routes are used to load-balance traffic.
Detailed configurations on Switch A are as follows:
#
bgp 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.3.2 route-policy replace_asn import //Apply export policy named replace_asn to routes to
be advertised to 10.1.3.2.
#
route-policy replace_asn permit node 10 //Define the first node of replace_asn.
if-match as-path-filter filter1 //Configure AS_Path filter named filter1.
apply as-path 65002 65004 65005 overwrite //Replace the AS_Path of the route that matches
filter1 with 65002, 65004, 65005.
#
route-policy replace_asn permit node 20 //Define the second node of replace_asn to permit all
other routes.
#
ip as-path-filter filter1 permit ^65003 //Define AS_Path filter named filter1 to match all the
routes learned from AS 65003.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 172.16.1.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65002 65004 65005?
*> 172.16.2.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65002 65004 65005?
*> 172.16.3.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65002 65004 65005?
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 761
The preceding command output shows that the AS_Path of the route received
from AS 65003 has been replaced, after which the routes received from AS 65002
and AS 65003 have the same AS_Path. Run the maximum load-balancing 2
command on Switch A to set the maximum number of routes for load balancing
to 2. Then, check the detailed route information. The route 172.16.1.0/24 is used in
the following example:
[SwitchA] display bgp routing-table 172.16.1.0
BGP local router ID : 10.1.1.1
Local AS number : 65001
Paths: 2 available, 1 best, 2 select
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.1.2 (10.1.1.2)
Route Duration: 19h57m51s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path 65002 65004 65005, origin incomplete, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.1.2
10.1.3.2
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.3.2 (10.1.5.1)
Route Duration: 00h10m21s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 65002 65004 65005, origin incomplete, pref-val 0, valid, external, select, active, pre 255, not
preferred for router ID
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch B is
optimal and is used along with the route learned from Switch C (not optimal) for
load balancing. Check the information about the route 172.16.1.0/24 in the IP
routing table.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 9 Routes : 12
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/30 Direct 0 0 D 10.1.1.1 GigabitEthernet0/0/1
10.1.1.1/32 Direct 0 0 D 127.0.0.1 GigabitEthernet0/0/1
10.1.3.0/30 Direct 0 0 D 10.1.3.1 GigabitEthernet0/0/0
10.1.3.1/32 Direct 0 0 D 127.0.0.1 GigabitEthernet0/0/0
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.1.0/24 EBGP 255 0 D 10.1.1.2 GigabitEthernet0/0/1
EBGP 255 0 D 10.1.3.2 GigabitEthernet0/0/0
172.16.2.0/24 EBGP 255 0 D 10.1.1.2 GigabitEthernet0/0/1
EBGP 255 0 D 10.1.3.2 GigabitEthernet0/0/0
172.16.3.0/24 EBGP 255 0 D 10.1.1.2 GigabitEthernet0/0/1
EBGP 255 0 D 10.1.3.2 GigabitEthernet0/0/0
The preceding command output shows that BGP has delivered the two routes with
the same route prefix to the IP routing table for load balancing.
Clearing the AS_Path
When the apply as-path command is configured, if none overwrite is specified in
the command, the device clears the AS_Path to hide the actual path information
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 762
and shorten the AP_Path list. If the AS_Path is null, BGP considers its length as 0
during route selection.
9.2.18.7 Origin
Three types of Origin attributes are available:
● IGP: indicates that routes are added to the BGP routing table using the
network command. IGP has the highest priority.
● EGP: indicates that routes are learned through the EGP protocol. EGP has the
second highest priority.
NOTE
The switch can receive and send BGP routes with EGP as the Origin. However, the
switch does not support the EGP protocol; therefore, to set the Origin of routes to EGP,
you need to run the apply origin { egp {
as-number-plain |
as-number-dot } | igp |
incomplete } command to configure an apply clause for a route-policy.
● Incomplete: indicates that routes are added to the BGP routing table using
the import-route command. Incomplete has the lowest priority.
The routes imported using the network command are more specific than those
imported using the import-route command. Therefore, IGP takes precedence over
Incomplete in route selection. In Figure 9-33, Switch A and Switch B are EBGP
peers, and Switch B, Switch C, and Switch D are IBGP peers.
Figure 9-33 Networking diagram with Origin configurations
The configurations on Switch D are as follows:
#
bgp 65001
#
ipv4-family unicast
network 10.1.4.0 255.255.255.252 //Advertise the route 10.1.4.0/30.
#
The configurations on Switch C are as follows:
#
bgp 65001
#
ipv4-family unicast
import-route direct //Import direct routes.
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 763
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.1.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
i 10.1.2.0/30 10.1.2.2 0 100 0 ?
*>i 10.1.4.0/30 10.1.3.2 0 100 0 i
* i 10.1.2.2 0 100 0 ?
The preceding command output shows that two active routes 10.1.4.0/30 are
available in the routing table.
[SwitchB] display bgp routing-table 10.1.4.0
BGP local router ID : 10.1.1.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.3.2 (10.1.3.2)
Route Duration: 01h14m48s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/2
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
10.1.1.1
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 01h13m20s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for
Origin
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch D is
selected because it is imported using the network command and its Origin
priority is higher than that of the route learned from Switch C. Table 9-21
describes the attribute comparison of the routes learned from Switch C and Switch
D.
Table 9-21 Attribute comparison of the routes learned from Switch C and Switch
D
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 764
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path - - The same length.
Origin Incomplete IGP The route learned
from Switch D is
optimal.
The Origin attribute can be modified using a route-policy. In the following
example, a route-policy is configured on Switch B to modify the Origin attribute,
and the detailed configurations are as follows:
#
bgp 65001
#
ipv4-family unicast
peer 10.1.3.2 route-policy for_d import //Apply import policy named for_d to the routes learned
from 10.1.3.2 and use for_d to modify the Origin value.
#
route-policy for_d permit node 10 //Define the route-policy named for_d.
apply origin incomplete //Set the Origin type to Incomplete.
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.1.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
i 10.1.2.0/30 10.1.2.2 0 100 0 ?
*>i 10.1.4.0/30 10.1.2.2 0 100 0 ?
* i 10.1.3.2 0 100 0 ?
The preceding command output shows that the route learned from Switch C
becomes the optimal route.
[SwitchB] display bgp routing-table 10.1.4.0
BGP local router ID : 10.1.1.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 01h28m19s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 765
10.1.1.1
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.3.2 (10.1.3.2)
Route Duration: 00h03m18s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/2
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for
router ID
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch C
becomes the optimal route because it has a smaller router ID than the route
learned from Switch D. Table 9-22 shows the attribute comparison of the routes
learned from Switch C and Switch D.
Table 9-22 Attribute comparison of the routes learned from Switch C and Switch
D
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path - - The same.
Origin Incomplete Incomplete The same.
MED 0 0 The same.
Peer type IBGP IBGP The same.
IGP cost - - The same.
Cluster_List - - The same.
Router ID 10.1.2.2 10.1.3.2 The route learned
from Switch C is
optimal.
9.2.18.8 MED
The MED attribute is transmitted only within an AS or between two neighboring
ASs. The AS that receives the MED attribute does not advertise it to a third AS.
Similar to the cost used by an IGP, the MED is used to determine the optimal route
when traffic enters an AS. When a BGP peer learns multiple routes that have the
same destination address but different next hop addresses from EBGP peers, the
route with the smallest MED value is selected as the optimal route if all the other
attributes are the same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 766
Table 9-23 lists two methods used to modify the MED value.
Table 9-23 Methods to modify the MED value
Method Usage Scenario
Run the default med command. This method sets a default MED for all
the routes that the local device
advertises to its BGP peers. The
default med command takes effect
only with the routes imported locally
using the import-route command and
BGP summarized routes.
Configure an import or export policy
and run the apply cost command to
configure an apply clause for the
policy.
This method sets different MED values
for different routes advertised by the
local device to its EBGP peers.
Configure an export policy and run the
apply cost-type internal command to
configure an apply clause for the
export policy.
This method enables a device to set
MED values for the BGP routes that
are learned from IBGP peers and to be
advertised to EBGP peers and match
the export policy to the costs of the
IGP routes to which the BGP routes are
recursed.
The major points about MED attributes that require consideration are as follows:
● If routes are received from different ASs, traffic will be sent to different ASs. In
addition, BGP selects the optimal route only from the routes destined for the
same address. Therefore, BGP only compares the MEDs of routes that are
from the same AS (excluding confederation sub-ASs). MEDs of two routes are
compared only if the leftmost AS number in the AS_Sequence (excluding
AS_Confed_Sequence) of one route is the same as its counterpart in the other
route.
● If the compare-different-as-med command is run, BGP compares MEDs of
routes even when the routes are received from peers in different ASs. Do not
run this command unless the ASs use the same IGP and route selection mode.
Otherwise, a routing loop may occur.
● If a route does not carry MED, BGP uses the default value (0) as the MED of
the route during route selection. If the bestroute med-none-as-maximum
command is run, BGP considers the largest MED value (4294967295) to be
the MED of the route. After route selection is complete, the MED is restored
to the original value.
● After the bestroute med-confederation command is configured, BGP
compares the MEDs of routes only when the AS_Path attributes of the routes
carry no external AS numbers (ASs that do not belong to the confederation)
and the leftmost AS numbers in each AS_Confed_Sequence are the same.
● After the deterministic-med command is configured, routes will not be
selected in the same sequence they are received.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 767
Figure 9-34 shows an example of using the MED attribute in BGP route selection.
In Figure 9-34, ISP1 and ISP2 can learn the route 1.1.1.9/32 from Switch C or
Switch D.
Figure 9-34 Networking diagram for MED applications
Scenario 1: Check the BGP routing tables of Switch A and Switch B before Switch
C and Switch D are configured to modify the MED of the route 1.1.1.9/32.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 10.1.1.2 0 65001i
* 10.1.3.2 0 65001i
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 768
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 10.1.4.2 0 65001i
* 10.1.2.2 0 65001i
The preceding command output shows that both ISP1 and ISP2 select the route
learned from Switch C as the optimal route. As a result, Switch C and Switch D
cannot load-balance the traffic from ISP1 or ISP2 to 1.1.1.9/32.
Run the display bgp routing-table
ip-address command on Switch B to check the
reason why Switch B chooses the route learned from Switch C.
[SwitchB] display bgp routing-table 1.1.1.9
BGP local router ID : 10.1.2.1
Local AS number : 200
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.4.2 (10.1.1.2)
Route Duration: 00h00m58s
Direct Out-interface: GigabitEthernet0/0/2
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path 65001, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.2.2
10.1.4.2
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h01m07s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 65001, origin igp, pref-val 0, valid, external, pre 255, not preferred for router ID
Not advertised to any peer yet
The preceding command output shows that Switch B selects the route learned
from Switch C because the router ID (10.1.1.2) of Switch C is smaller than that
(10.1.2.2) of Switch D. Table 9-24 describes the attribute comparison of the routes
learned from Switch C and Switch D.
Table 9-24 Attribute comparison of the routes learned from Switch C and Switch
D
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
PrefVal 0 0 The same.
Local_Pref - - The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 65001 65001 The same length.
Origin IGP IGP The same.
MED - - The same.
Peer type EBGP EBGP The same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 769
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
IGP cost - - The same.
Cluster_List - - The same length.
Router ID 10.1.1.2 10.1.2.2 The route learned
from Switch C is
optimal.
Scenario 2: The requirements of the administrator of AS 65001 are as follows:
● For the traffic from ISP1 to 1.1.1.9/32, the link Switch A -> Switch C is active
and the link Switch A -> Switch D is backup.
● For the traffic from ISP2 to 1.1.1.9/32, the link Switch B -> Switch D is active
and the link Switch B -> Switch C is backup.
To meet the preceding requirements, ensure that ISP1 selects the route learned
from Switch C and that ISP2 selects the route learned from Switch D. Figure 9-35
shows the networking in which MED is used to control route selection.
Figure 9-35 Networking diagram for MED applications
Configure route-policies to set different MED values for the routes learned from
different peers. Detailed configurations are as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 770
● Configurations on Switch C:
#
bgp 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.4.1 route-policy addmed100 export //Apply export policy named addmed100 to the
routes to be advertised to 10.1.4.1 and use addmed100 to modify the MED value.
#
route-policy addmed100 permit node 10 //Define the first node of addmed100 and set the
MED of the route 1.1.1.9/32 to 100.
if-match ip-prefix p1
apply cost 100
#
route-policy addmed100 permit node 20 //Define the second node of addmed100 to allow
addmed100 to permit all other routes.
#
ip ip-prefix p1 index 10 permit 1.1.1.9 32 //Configure an IP prefix list to match the route
1.1.1.9/32.
● Configurations on Switch D:
NOTE
The following configurations are intended to ensure that Switch A selects the route
learned from Switch C. However, Switch A has already selected the route learned from
Switch C because the router ID of Switch C is smaller than that of Switch D. Therefore,
the following configurations on Switch D are optional.
#
bgp 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.3.1 route-policy addmed200 export //Apply export policy named addmed200 to the
routes to be advertised to 10.1.3.1 and use addmed200 to modify the MED value.
#
route-policy addmed200 permit node 10 //Define the first node of addmed200 and set the
MED of the route 1.1.1.9/32 to 200.
if-match ip-prefix p1
apply cost 200
#
route-policy addmed200 permit node 20 //Define the second node of addmed200 to allow
addmed200 to permit all other routes.
#
ip ip-prefix p1 index 10 permit 1.1.1.9 32 //Configure an IP prefix list to match the route
1.1.1.9/32.
Run the display bgp routing-table [
ip-address ] command to check the
configurations. Use Switch B as an example.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 10.1.2.2 0 65001i
* 10.1.4.2 100 0 65001i
# Display detailed information about the route 1.1.1.9/32 on Switch B.
[SwitchB] display bgp routing-table 1.1.1.9 32
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 771
BGP local router ID : 10.1.2.1
Local AS number : 200
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 01h20m38s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 65001, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.2.2
10.1.4.2
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.4.2 (10.1.1.2)
Route Duration: 01h16m28s
Direct Out-interface: GigabitEthernet0/0/2
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path 65001, origin igp, MED 100, pref-val 0, valid, external, pre 255, not preferred for MED
Not advertised to any peer yet
The preceding command output shows that two routes 1.1.1.9/32 are available in
the BGP routing table of Switch B and that only the route with next hop address
10.1.2.2 is selected as the optimal route.
Table 9-25 describes the attribute comparison of the routes learned from Switch C
and Switch D.
Table 9-25 Attribute comparison of the routes learned from Switch C and Switch
D
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
PrefVal 0 0 The same.
Local_Pref - - The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 65001 65001 The same length.
Origin IGP IGP The same.
MED 100 - The route learned
from Switch D
carries no MED
value, and
therefore, the
default value (0)
is used.
The route learned
from Switch D is
optimal.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 772
Figure 9-35 shows that the route learned from Switch D does not carry the MED
value. During route selection, BGP uses the default value (0) as the MED of the
route. Therefore, this route is selected as the optimal route. To change the route
selection result on Switch B, run the bestroute med-none-as-maximum
command on Switch B. Detailed configurations are as follows:
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 10.1.4.2 100 0 65001i
* 10.1.2.2 0 65001i
[SwitchB] display bgp routing-table 1.1.1.9
BGP local router ID : 10.1.2.1
Local AS number : 200
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.4.2 (10.1.1.2)
Route Duration: 00h08m42s
Direct Out-interface: GigabitEthernet0/0/2
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path 65001, origin igp, MED 100, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.2.2
10.1.4.2
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 16h33m10s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 65001, origin igp, pref-val 0, valid, external, pre 255, not preferred for MED
Not advertised to any peer yet
The preceding command output shows that two routes 1.1.1.9/32 are available in
the BGP routing table of Switch B. The MED of the route with the next hop
address 10.1.4.2 is 100, and the MED of the route with the next hop address
10.1.2.2 is considered as 4294967295 because it carries no MED. Therefore, the
route with the next hop address 10.1.4.2 is selected as the optimal route.
In addition, BGP selects routes in the same sequence they are received. Therefore,
the route selection result is relevant to the sequence in which the routes are
received. For example, the following three BGP routes are available on a device:
● Route A1: AS_Path { 65001 200 }, med 100, igp cost 13, internal, Router id
4.4.4.4
● Route A2: AS_Path { 65001 100 }, med 150, igp cost 11, internal, Router id
5.5.5.5
● Route B: AS_Path { 65002 300 }, med 0, igp cost 12, internal, Router id 6.6.6.6
If the compare-different-as-med (BGP) command is run, route B is the optimal
route, regardless of the sequence in which the routes are received. If the compare-
different-as-med (BGP) command is not configured, BGP does not compare the
MED values of routes learned from different ASs. The route selection is described
in the following cases:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 773
● Case 1: Route A1 is received first, followed by route B, and then route A2.
– BGP first compares route A1 and route B. The leftmost AS number in the
AS_Path of route A1 is 65001, which is different from its counterpart in
route B (65002). Therefore, BGP does not compare the MED values, and
prefers route B to route A1 because the IGP cost (12) of route B is
smaller than that of route A1 (13).
– BGP then compares route A2 and route B. The leftmost AS number in the
AS_Path of route A2 is 65001, which is different from its counterpart in
route B (65002). Therefore, BGP does not compare the MED values, and
selects route A2 as the optimal route because its IGP cost (11) is smaller
than that of route B (12).
● Case 2: Route A2 is received first, followed by route B, and then route A1.
– BGP then compares route A2 and route B. The leftmost AS number in the
AS_Path of route A2 is 65001, which is different from its counterpart in
route B (65002). Therefore, BGP does not compare the MED values and
prefers route A2 to route B because the IGP cost (11) of route A2 is
smaller than that of route B (12).
– BGP then compares route A1 and route A2. The leftmost AS number in
the AS_Path of route A1 is the same as its counterpart in route A2
(65001). In this situation, BGP selects route A1 as the optimal route
because its MED value (100) is smaller than that of route A2 (150).
● Case 3: If the deterministic-med command is run, BGP groups the routes that
are learned from different ASs but are destined for the same network
segment based on the leftmost AS number in the AS_Path, selects one
optimal route from each group, and then compares the optimal routes of all
the groups. Detailed steps are as follows:
– BGP first compares route A1 and route A2. The leftmost AS number in
the AS_Path of route A1 is the same as its counterpart in route A2
(65001). In this situation, BGP selects route A1 as the optimal route
because its MED value (100) is smaller than that of route A2 (150).
– BGP then compares route A1 and route B. The leftmost AS number in the
AS_Path of route A1 is 65001, which is different from its counterpart in
route B (65002). Therefore, BGP does not compare the MED values and
selects route B as the optimal route because the IGP cost (12) of route B
is smaller than that of route A1 (13).
Case 1 and case 2 show that the route selection result is relevant to the sequence
in which routes are received if the deterministic-med is not configured. Case 3
shows that the route selection result is irrelevant to the sequence in which routes
are received if the deterministic-med is configured.
9.2.18.9 Peer Type
When one EBGP route and multiple IBGP routes are available, BGP selects the
optimal route based on the peer type. If no EBGP route is available or multiple
EBGP routes are available, BGP is unable to select the optimal route based on the
peer type.
When multiple egress devices reside on a carrier network and receive routes from
the Internet, the egress devices select the optimal route based on the peer type in
most cases. In Figure 9-36, all devices reside in the same AS, Switch A and Switch
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 774
B function as egress devices and are IBGP peers of all devices in the AS. In
addition, Switch A and Switch B receive routes from the Internet and advertise
EBGP routes to all their IBGP peers. Therefore, Switch A and Switch B have an
IBGP route and an EBGP route, and the two routes have the same AS_Path. In this
situation, Switch A and Switch B select the EBGP route as the optimal route.
Figure 9-36 Peer type application networking
The EBGP route is selected as the optimal route, which prevents the traffic that
leaves Switch A or Switch B for the Internet from being forwarded to the other
egress device.
For more peer type-based route selection examples, see 9.2.18.4 Local_Pref.
9.2.18.10 IGP Cost
This rule helps BGP to choose the route with the smallest cost to its recursive next
hop address quickly. If the bestroute igp-metric-ignore command is configured,
BGP does not compare the IGP cost. In Figure 9-37, OSPF runs in AS 65001, an
EBGP peer relationship is established between Switch E and Switch A and between
Switch E and Switch B, and an IBGP peer relationship is established between
Switch A and Switch C, between Switch A and Switch D, between Switch B and
Switch C, and between Switch B and Switch D; Switch E is configured to import
routes (10.1.1.1/32 for example) from AS 100 to BGP.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 775
Figure 9-37 Networking diagram with IGP cost configurations
Run the display bgp routing-table [
ip-address ] command on Switch C and
Switch D to check the configurations. Switch C is used as an example.
# Display the routing table of Switch C.
[SwitchC] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.1/32 10.1.5.2 0 100 0 100i
* i 10.1.6.2 0 100 0 100i
*>i 10.1.5.0/30 10.1.3.2 0 100 0 i
*>i 10.1.6.0/30 10.1.2.2 0 100 0 i
The preceding command output shows that two routes 10.1.1.1/32 are available in
the routing table of Switch C and that Switch C selects the route learned from
Switch A.
[SwitchC] display bgp routing-table 10.1.1.1
BGP local router ID : 10.1.1.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.1/32:
From: 10.1.3.2 (10.1.1.2)
Route Duration: 00h00m44s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.5.2
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 776
Not advertised to any peer yet
BGP routing table entry information of 10.1.1.1/32:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h00m39s
Relay IP Nexthop: 10.1.1.2
Relay IP Out-Interface: GigabitEthernet0/0/1
Original nexthop: 10.1.6.2
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, IGP cost 2, not preferred
for IGP cost
Not advertised to any peer yet
The preceding command output shows that the route with next hop address
10.1.6.2 is ignored because its IGP cost is larger than that of the other route. Table
9-26 describes the attribute comparison of the routes learned from Switch A and
Switch B.
Table 9-26 Attribute comparison of the routes learned from Switch A and Switch
B.
Route Attribute Route Learned
from Switch A
Route Learned
from Switch B
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 100 100 The same length.
Origin IGP IGP The same.
MED 0 0 The same.
Peer type IBGP IBGP The same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 777
Route Attribute Route Learned
from Switch A
Route Learned
from Switch B
Comparison
IGP cost - 2 The route learned
from Switch A is
optimal.
NOTE
If a BGP route
carries no IGP cost
value, BGP
considers its IGP
cost to be 0. If no
IGP routes are
used during BGP
peer relationship
establishment or
the costs of used
IGP routes are 0,
the IGP cost is not
displayed in the
display bgp
routing-table
ip-
address command
output.
9.2.18.11 Cluster_List
An RR and its clients form a cluster. In an AS, each RR is uniquely identified by a
Cluster_ID.
Similar to an AS_Path, a Cluster_List is composed of a series of Cluster_IDs and is
generated by an RR. The Cluster_List records all the RRs through which a route
passes.
● Before an RR reflects a route between its clients or between its clients and
non-clients, the RR adds the local Cluster_ID to the leftmost position of the
Cluster_List. If a route does not carry any Cluster_List, the RR creates one for
the route.
● After the RR receives an updated route, it checks the Cluster_List of the route.
If the RR finds that its cluster ID is included in the Cluster_List, the RR discards
the route. If its cluster ID is not included in the Cluster_List, the RR adds its
cluster ID to the Cluster_List and then reflects the route.
The following example shows how Cluster_List is used in BGP route selection. In
Figure 9-38, an IBGP peer relationship is established between each two
neighboring devices in AS 65001. Switch B functions as a level-1 RR, and Switch D
is its client. Switch D functions as a level-2 RR, and Switch E is its client. Switch C
functions as an RR, and Switch E is its client. Switch E is configured to import the
route 1.1.1.9/32 to BGP.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 778
Figure 9-38 Networking diagram with Cluster_List configurations
Run the display bgp routing-table [
ip-address ] command on Switch A to check
the configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.3.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 1.1.1.9/32 10.1.5.2 0 100 0 i
* i 10.1.4.2 0 100 0 i
The preceding command output shows that two routes 1.1.1.9/32 are available in
the routing table of Switch C and that Switch A selects the route learned from
Switch C.
[SwitchA] display bgp routing-table 1.1.1.9
BGP local router ID : 10.1.3.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.3.2 (2.2.2.9)
Route Duration: 00h53m08s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet0/0/1
Original nexthop: 10.1.5.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255, IGP cost
3
Originator: 1.1.1.9
Cluster list: 0.0.0.3
Not advertised to any peer yet
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.1.2 (10.1.2.1)
Route Duration: 00h28m05s
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 779
Relay IP Nexthop: 10.1.1.2
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, IGP cost 3, not preferred
for Cluster List
Originator: 1.1.1.9
Cluster list: 0.0.0.2, 0.0.0.1
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch B is
ignored because its Cluster_List is longer than that of the route learned from
Switch C. Table 9-27 describes attribute comparison of the routes learned from
Switch B and Switch C.
Table 9-27 Attribute comparison of the routes learned from Switch B and Switch
C
Route Attribute Route Learned
from Switch B
Route Learned
from Switch C
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path - - The same length.
Origin IGP IGP The same.
MED 0 0 The same.
Peer type IBGP IBGP The same.
IGP cost 3 3 The same.
Cluster_List 0.0.0.2, 0.0.0.1 0.0.0.3 The route learned
from Switch C is
optimal.
In most cases, BGP does not advertise the routes learned from an AS to the AS
again. When RRs are deployed, such routes may be advertised to the AS again
although routing loops may occur. Using the Cluster_List attribute can prevent
such routing loops.
9.2.18.12 Originator_ID
The Originator_ID attribute is four bytes long and is generated by an RR. It carries
the router ID of the route originator in the local AS.
● When a route is reflected by an RR for the first time, the RR adds the
Originator_ID to this route. If a route already carries the Originator_ID
attribute, the RR does not create a new one.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 780
● After receiving the route, a BGP speaker checks whether the Originator_ID is
the same as its router ID. If Originator_ID is the same as its router ID, the BGP
speaker discards this route.
The following example shows how Originator_ID is used during BGP route
selection. In Figure 9-39, an IBGP peer relationship is established between each
two neighboring devices in AS 65001. The router IDs of Switch B and Switch C are
2.2.2.9 and 3.3.3.9, respectively, and they function as RRs. Switch D is a client of
Switch B, and Switch E is a client of Switch C. Switch D and Switch E are
configured to import the route 10.1.4.0/30 to BGP.
Figure 9-39 Networking diagram with Originator_ID configurations
Run the display bgp routing-table [
ip-address ] command on Switch A to check
the configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.3.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.4.0/30 10.1.5.2 0 100 0 i
* i 10.1.2.2 0 100 0 i
The preceding command output shows that two routes 10.1.4.0/30 are available in
the routing table of Switch A and that Switch A selects the route learned from
Switch C.
[SwitchA] display bgp routing-table 1.1.1.9
BGP local router ID : 10.1.3.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.3.2 (3.3.3.9)
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 781
Route Duration: 00h00m01s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet0/0/1
Original nexthop: 10.1.5.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, pre 255, IGP cost 2
Originator: 10.1.4.1
Cluster list: 0.0.0.3
Not advertised to any peer yet
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.1.2 (2.2.2.9)
Route Duration: 00h00m17s
Relay IP Nexthop: 10.1.1.2
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, IGP cost 2, not preferred
for router ID
Originator: 10.1.4.2
Cluster list: 0.0.0.2
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch B is not
selected due to a router ID issue. In fact, the router ID of Switch B is 2.2.2.9,
smaller than that (3.3.3.9) of Switch C. The route learned from Switch B should be
selected if the router IDs are used to determine the optimal route. However, the
routes carry Originator_ID attributes. In this situation, the Originator_ID attributes
(rather than router IDs) are compared. Switch A selects the route learned from
Switch C because its Originator_ID (10.1.4.1) is smaller than that (10.1.4.2) of the
route learned from Switch B.
Table 9-28 describes the attribute comparison of the routes learned from Switch B
and Switch C.
Table 9-28 Attribute comparison of the routes learned from Switch B and Switch
C
Route Attribute Route Learned
from Switch B
Route Learned
from Switch C
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path - - The same length.
Origin IGP IGP The same.
MED 0 0 The same.
Peer type IBGP IBGP The same.
IGP cost 2 2 The same.
Cluster_List 0.0.0.2 0.0.0.3 The same length.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 782
Route Attribute Route Learned
from Switch B
Route Learned
from Switch C
Comparison
Originator_ID 10.1.4.2 10.1.4.1 The route learned
from Switch C is
optimal.
If routes carry Originator_ID attributes, the Originator_ID attributes (rather than
router IDs) are compared.
9.2.18.13 BGP Router ID
A router ID uniquely identifies a router in an AS, and the router ID can be
configured as follows:
● Run the router-id(BGP) {
ipv4-address | vpn-instance auto-select }
command. If no router ID is configured in the BGP view, BGP selects the
global router ID. For details on how a global router ID is selected, see router-
id.
● Run the router-id (BGP-VPN Instance IPv4 Address Family View) {
ipv4-
address | auto-select } command in the BGP VPN instance IPv4 address
family view. The router-id (BGP-VPN Instance IPv4 Address Family View)
command takes precedence over the router-id(BGP) command.
If each route carries an Originator_ID, the Originator_IDs rather than router IDs
are compared during route selection. The route with the smallest Originator_ID is
preferred. By default, Cluster_List takes precedence over Originator_ID during BGP
route selection. To enable Originator_ID to take precedence over Cluster_List
during BGP route selection, run the bestroute router id-prior-clusterlist
command.
For more router ID-based route selection examples, see 9.2.18.4 Local_Pref,
9.2.18.7 Origin, and 9.2.18.8 MED.
9.2.18.14 Peer IP Address
The peer IP address is the IP address specified in
ipv4-address or
ipv6-address in
the peer {
group-name |
ipv4-address |
ipv6-address } as-number {
as-number-
plain |
as-number-dot } command. The
group-name parameter specified in the
command is the one specified in the peer {
ipv4-address |
ipv6-address } group
group-name command.
If the optimal route has not been selected yet before BGP begins to compare peer
IP addresses, the local device may have established multiple BGP peer
relationships with another device through equal-cost links. In most cases, if a
backup physical link is available between two devices, using loopback interfaces to
establish a BGP peer relationship is recommended although multiple BGP peer
relationships may be established between the two devices through the physical
links.
In Figure 9-40, two physical links are available between Switch A and Switch B.
Switch A and Switch B can use loopback interfaces to establish a BGP peer
relationship or use the two links to establish two BGP peer relationships. In the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 783
following example, the two links are used to establish two BGP peer relationships
to show how peer addresses are used in route selection.
Figure 9-40 Networking in which two links are used to establish two BGP peer
relationships
The configurations on Switch A are as follows:
#
bgp 65001
peer 10.1.1.2 as-number 65002
peer 10.1.2.2 as-number 65002
#
ipv4-family unicast
peer 10.1.1.2 enable
peer 10.1.2.2 enable
#
The configurations on Switch B are as follows:
#
bgp 65002
peer 10.1.1.1 as-number 65001
peer 10.1.2.1 as-number 65001
#
ipv4-family unicast
network 2.2.2.9 255.255.255.255
peer 10.1.1.1 enable
peer 10.1.2.1 enable
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 2.2.2.9/32 10.1.1.2 0 0 65002i
* 10.1.2.2 0 0 65002i
The preceding command output shows that two routes 2.2.2.9/32 are available in
the routing table and that the route with the next hop address 10.1.1.2 is selected
as the optimal route.
[SwitchA] display bgp routing-table 2.2.2.9
BGP local router ID : 192.168.2.3
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 784
BGP routing table entry information of 2.2.2.9/32:
From: 10.1.1.2 (192.168.2.4)
Route Duration: 00h19m10s
Direct Out-interface: GigabitEthernet1/0/5
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path 65002, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.1.2
10.1.2.2
BGP routing table entry information of 2.2.2.9/32:
From: 10.1.2.2 (192.168.2.4)
Route Duration: 00h19m05s
Direct Out-interface: GigabitEthernet1/0/10
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 65002, origin igp, MED 0, pref-val 0, valid, external, pre 255, not preferred for peer address
Not advertised to any peer yet
The preceding command output shows that the route with the next hop address
10.1.1.2 is selected as the optimal route because its peer IP address is smaller than
that of the other route.
9.3 Summary of BGP Configuration Tasks
Table 9-29 describes the BGP configuration tasks.
NOTE
If BGP is configured on an IPv6 network, all the peer addresses specified in the peer
command must be IPv6 addresses.
Table 9-29 BGP configuration tasks
Scenario Description Task
Configuring basic BGP
functions
The configuration of
basic BGP functions is
the foundation of the
BGP network
construction and the
precondition for other
BGP functions.
9.6 Configuring Basic
BGP Functions
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 785
Scenario Description Task
Configuring BGP security On BGP networks,
unauthorized users can
attack the BGP network
by modifying data
packets or forging
authorized users. To
ensure security of
services carried on BGP
networks, configure BGP
MD5 authentication, BGP
keychain authentication,
or Generalized TTL
Security Mechanism
(GTSM) function.
9.7 Configuring BGP
Security
Simplifying IBGP
network connections
Because routes received
from an IBGP peer will
not be sent to other
IBGP peers, fully-meshed
connections must be
established on the IBGP
network. However, when
there are many devices,
peer configuration is very
complex on the fully-
meshed IBGP network,
and the consumption of
network resources and
device CPU resources will
increase. To reduce the
number of IBGP network
connections and better
plan the network,
configure the route
reflector and
confederation.
9.8 Simplifying IBGP
Network Connections
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 786
Scenario Description Task
Configuring BGP route
selection and load
balancing
In a BGP routing table,
there may be multiple
routes to the same
destination. To guide
route selection, BGP
defines next-hop policies
and route selection rules.
The priority of next-hop
policies is higher than
that of BGP route
selection rules. After the
next-hop policies are
performed, BGP selects
routes according to the
route selection rules.
Usually there are
multiple valid routes to
the same destination on
the network. If BGP only
advertises the optimal
route to its peer,
unbalanced traffic on
different routes will
occur. The BGP load-
balancing configuration
can balance load on
different routes and
reduce network
congestion.
9.9 Configuring BGP
Route Selection and
Load Balancing
Controlling the
advertising and receiving
of BGP routes
With the expansion of
the network scale, the
sharp increase of routing
tables leads to greater
load on networks and
increasing network
security problems. To
solve this problem, filter
routes according to the
routing policies and only
send and receive
required BGP routes. In
addition, multiple routes
to the same destination
may exist. If these routes
need to pass through
different ASs, direct
service traffic to specific
ASs or filter the routes to
be advertised.
9.10 Controlling the
Receiving and
Advertisement of BGP
Routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 787
Scenario Description Task
Adjusting the BGP
network convergence
speed
To enable BGP to rapidly
detect network changes,
speed up the BGP
network convergence. To
minimize the effect on
networks from route
flapping and reduce load
on the device, slow down
the BGP network
convergence.
9.11 Adjusting the BGP
Network Convergence
Speed
Configuring BGP
reliability
To avoid long service
interruption when faults
occur on BGP networks,
adopt the solution of
standby link. However,
the BGP mechanism
requires more than 1
second to detect the
faults and perform an
active/standby
switchover. To ensure
that users of delay-
sensitive services such as
the voice service do not
detect the service
interruption, associate
BGP tracking, BGP, and
BFD to implement fast
fault detection, and use
BGP GR to perform a
fast switchover after the
fault detection.
9.12 Configuring BGP
Reliability
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 788
Scenario Description Task
Configuring BGP route
summarization
The BGP routing table on
a medium or large BGP
network contains a large
number of routing
entries. Storing the
routing table consumes a
lot of memory, and
transmitting and
processing the routing
information consumes a
lot of network resources.
Route summarization
can reduce the size of a
routing table, prevent
specific routes from
being advertised, and
minimize the impact of
route flapping on
networks. Although BGP
automatic route
summarization is easy to
configure, it only
summarizes routes
according to the natural
network segment. BGP
manual route
summarization can be
used with flexible
routing policies to enable
BGP to effectively
transmit and control
routes.
9.13 Configuring BGP
Route Summarization
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 789
Scenario Description Task
Configuring BGP to
advertise default routes
to peers
The BGP routing table on
a medium or large BGP
network contains a large
number of routing
entries. Storing the
routing table consumes a
large number of memory
resources, and
transmitting and
processing the routing
information consumes a
large number of network
resources. If multiple
routes in a peer BGP
routing table are sent
only from a local device,
configure the local
device to send a default
route to its peer. In this
case, the local device will
send a default route with
the next-hop address as
the local address to its
peer, regardless of
whether there is a
default route in the local
routing table. After the
local device is configured
to send only the default
route to its peer using
the routing policies, the
number of network
routes is greatly reduced
and the peer and
network memory
resources are greatly
saved.
9.14 Configuring BGP to
Advertise Default
Routes to Peers
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 790
Scenario Description Task
Configuring MP-BGP Traditional BGP-4 only
manages IPv4 unicast
routing information and
does not support route
transmission between
ASs of other networks
such as multicast
networks. To support
multiple types of
network layer protocols,
the Internet Engineering
Task Force (IETF)
extends BGP-4 to
Multiprotocol Extensions
for BGP-4 (MP-BGP)
defined in RFC 4760. MP-
BGP is called Multicast
BGP (MBGP) on
multicast networks.
9.15 Configuring MP-
BGP
9.4 Licensing Requirements and Limitations for BGP
Involved Network Elements
Other network elements are required to support BGP.
Licensing Requirements
The BGP4/BGP4+ feature is a basic feature of a switch and is not under license
control.
Feature Support in V200R024C00
Only the following switch models support BGP:
S5720I-SI, S500, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S,
S5731S-H, S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S,
and S6730S-S
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 791
Feature Limitations
None.
9.5 Default Settings for BGP
Table 9-30 describes the default settings for BGP.
Table 9-30 Default settings for BGP
Parameter Default Setting
BGP Disabled
Keepalive message interval 60s
Hold time 180s
9.6 Configuring Basic BGP Functions
Pre-configuration Tasks
Before configuring basic BGP functions, configure IP addresses for interfaces to
ensure network-layer communication between neighbor nodes.
Configuration Procedure
Perform the following operations in sequence and as required.
9.6.1 Starting a BGP Process
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
BGP is started, the local AS number is specified, and the BGP view is displayed.
NOTICE
After BGP peers are configured, changing the router ID of a BGP peer resets BGP
peer relationships.
Step 3 Run router-id
ipv4-address
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 792
A router ID is set.
NOTE
By default, BGP automatically selects the global router ID. If the IP address of a physical
interface is used as the router ID, route flapping occurs when the IP address of the physical
interface changes. To enhance network stability, configuring the address of a loopback
interface as the router ID is recommended. For router ID selection rules in the system view,
see descriptions in Command Reference about the router-id command.
----End
9.6.2 Configuring BGP Peers
Context
During the configuration of BGP peers, if the AS number of the specified peer is
the same as the local AS number, an IBGP peer is configured. If the AS number of
the specified peer is different from the local AS number, an EBGP peer is
configured. To enhance the stability of BGP connections, you are advised to use
the reachable loopback interface addresses to establish BGP connections.
When loopback interface addresses are used to establish a BGP connection, run
the peer connect-interface command on both ends of the BGP connection to
ensure the correctness of interfaces and addresses on the TCP connection. If the
command is run on only one end, the BGP connection may fail to be established.
When loopback interface addresses are used to establish an EBGP connection, the
peer ebgp-max-hop command with
hop-count greater than or equal to 2 must
be run. Otherwise, the EBGP connection cannot be established.
To perform the same configuration on a large number of peers, configure a BGP
peer group according to 9.6.3 (Optional) Configuring a BGP Peer Group to
reduce the configuration workload.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run peer {
ipv4-address |
ipv6-address } as-number {
as-number-plain |
as-
number-dot }
The BGP peer is created.
By default, no BGP peer is created.
Step 4 (Optional) Run peer
ipv4-address connect-interface
interface-type interface-
number [
ipv4-source-address ]
Or run peer
ipv6-address connect-interface
interface-type interface-number
[
ipv6-source-address ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 793
A source interface and a source IP address are specified for the peer to establish a
TCP connection.
By default, BGP uses the interface that is directly connected to the peer to
establish a TCP connection.
Step 5 (Optional) Run peer {
ipv4-address |
ipv6-address } ebgp-max-hop [
hop-count ]
The maximum number of hops allowed for the establishment of an EBGP
connection is set.
By default, the maximum number of hops allowed for an EBGP connection is 1.
That is, an EBGP connection must be established on a directly connected physical
link.
If a one-hop EBGP peer relationship is established using loopback interface
addresses, you can also run the peer connected-check-ignore command to
establish an EBGP peer relationship.
Step 6 (Optional) Run peer {
ipv4-address |
ipv6-address } description
description-text
The description of the peer is configured.
NOTE
If a BGP peer is configured on an IPv4 unicast network, steps 7 and 8 are not required. If a
BGP peer is configured on an IPv4 multicast network and an IPv6 unicast network, steps 7
and 8 are required.
Step 7 (Optional) Run the following commands as required.
● Run ipv4-family multicast
The BGP-IPv4 multicast address family view is displayed.
● Run ipv6-family [ unicast ]
The BGP-IPv6 unicast address family view is displayed.
Step 8 (Optional) Run peer {
ipv4-address |
ipv6-address } enable
MP-BGP is enabled on the BGP peers to configure them as MP-BGP peers.
----End
9.6.3 (Optional) Configuring a BGP Peer Group
Context
A large BGP network has a large number of peers. It is difficult to configure and
maintain these peers. You can add the BGP peers with the same configurations to
a BGP peer group and then configure the BGP peers in batches. This simplifies
peer management and improves route advertisement efficiency.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 794
NOTE
● If a function is configured on a peer and its peer group, the function configured on the peer
takes precedence over that configured on the peer group.
● When loopback interface addresses are used to establish a BGP connection, you are advised
to perform step 6 on the both ends of the BGP connection simultaneously to ensure the
correct establishment of the connection. If step 6 is performed on only one end, the BGP
connection may fail to be established.
● When loopback interfaces are used to establish an EBGP connection, step 7 is required and
hop-count in the
peer ebgp-max-hop command must be greater than or equal to 2.
Otherwise, the EBGP connection cannot be established.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run group
group-name [ external | internal ]
A BGP peer group is created.
NOTE
The AS number of an IBGP peer group is the local AS number. Therefore, step 4 is not
required.
Step 4 Run peer
group-name as-number {
as-number-plain |
as-number-dot }
An AS number is configured for the EBGP peer group.
NOTE
To add an EBGP peer to a peer group, configure the EBGP peer according to 9.6.2
Configuring BGP Peers and then perform step 5.
To add an IBGP peer to a peer group, perform step 5. The system creates an IBGP peer in
the BGP view and sets its AS number as the AS number of the peer group.
Step 5 Run peer {
ipv4-address |
ipv6-address } group
group-name
A peer is added to the peer group.
NOTE
You can repeat step 5 to add multiple peers to a peer group.
Step 6 (Optional) Run peer
group-name connect-interface
interface-type interface-
number [
ipv4-source-address ] or peer
group-name connect-interface
interface-
type interface-number [
ipv6-source-address ]
A source interface and a source IP address are specified for the peer to establish a
TCP connection.
By default, the outbound interface of a BGP packet serves as the source interface
of a BGP packet.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 795
NOTE
The configurations of GTSM and EBGP-MAX-HOP affect the TTL values of BGP packets,
which may cause a conflict between TTL values. Therefore, you can configure only one of
the two functions for a peer or peer group.
Step 7 (Optional) Run peer
group-name ebgp-max-hop [
hop-count ]
The maximum number of hops allowed for the establishment of an EBGP
connection is set.
By default, the maximum number of hops allowed for an EBGP connection is 1.
That is, an EBGP connection must be established on a directly connected physical
link.
If a one-hop EBGP peer relationship is established using loopback interface
addresses, you can also run the peer connected-check-ignore command to
establish an EBGP peer relationship.
Step 8 (Optional) Run peer
group-name description
description-text
The description is configured for the peer group.
NOTE
If you want to configure an IPv4 peer group in the BGP-IPv4 unicast address family view,
skip steps 9, 10, and 11. To configure a BGP peer group in another address family view,
perform steps 9, 10, and 11.
Step 9 Enter the required address family view based on the actual network. The following
example uses the BGP-IPv6 unicast address family view.
Run ipv6-family [ unicast ]
The BGP-IPv6 unicast address family view is displayed.
Step 10 Run peer
group-name enable
The switch is enabled to exchange routing information with the specified peer or
peer group in the address family view.
Step 11 Run peer {
ipv4-address |
ipv6-address } group
group-name
The specified peer is added to the peer group.
----End
9.6.4 (Optional) Configuring Dynamic BGP Peers
Context
If static BGP peers change frequently, the local device needs to add or delete BGP
peer configurations in response to each change, which requires a heavy
maintenance workload. To address this problem, configure the dynamic BGP peer
function, which allows BGP to listen to BGP connection requests from a specified
network segment, establish BGP peer relationships dynamically, and add the peers
to a peer group. This spares the local device from adding or deleting BGP peer
configurations in response to each change in the peer number, which reduces the
maintenance workload.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 796
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 (Optional) Run bgp dynamic-session-limit
limit-value
The maximum number of dynamic BGP peer sessions is configured.
By default, a maximum of 100 dynamic BGP peer sessions can be established after
the dynamic BGP peer function is enabled.
Step 4 (Optional) Run ipv4-family vpn-instance
vpn-instance-name
The BGP-VPN instance IPv4 address family view is displayed.
Perform this step if you need to configure the dynamic BGP peer function in the
BGP-VPN instance IPv4 address family view in a BGP/MPLS IP VPN scenario.
Step 5 Run group
group-name [ external | internal ]
A BGP peer group is created.
● If the local device and its peers reside in the same AS, configure internal to
create an IBGP peer group.
● If the local device and its peers reside in different ASs, configure external to
create an EBGP peer group.
Step 6 Run peer
group-name listen-net
network {
mask |
mask-length }
BGP is configured to listen to BGP connection requests from a specified network
segment and establish BGP peer relationships dynamically.
If you run the command multiple times, BGP listens to BGP connection requests
from multiple network segments.
Step 7 Run peer
group-name as-number {
as-number-plain |
as-number-dot }
[ optional-as {
optional-as-number-plain |
optional-as-number-dot } &<1-5> ]
An AS number is configured for the peer group.
● If the dynamic peers in the peer group reside in the same AS, configure {
as-
number-plain |
as-number-dot } to set a fixed AS number.
● If the dynamic peers in the peer group may reside in different ASs, in addition
to a fixed AS number, you need to configure optional-as {
optional-as-
number-plain |
optional-as-number-dot } &<1-5> to set an optional AS
number. A maximum of five optional AS numbers can be set.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 797
9.6.5 Configuring BGP to Import Routes
Context
BGP cannot discover routes and needs to import routes such as IGP routes into
BGP routing tables so that the imported routes can be transmitted within an AS or
between ASs. BGP imports routes in either import or network mode:
● In import mode, BGP imports IGP routes, including RIP, OSPF, and IS-IS routes,
into BGP routing tables based on protocol type. To ensure the validity of
imported IGP routes, BGP can also import static routes and direct routes in
import mode.
● In network mode, BGP imports the routes in the IP routing table one by one
into BGP routing tables. The network mode is more accurate than the import
mode.
Procedure
● In import mode
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Run import-route
protocol [
process-id ] [ med
med | route-policy
route-policy-name ] *
BGP is configured to import routes of other routing protocols.
e. (Optional) Run default-route imported
BGP is allowed to import default routes from the local IP routing table.
To import default routes, you need to run both the default-route
imported command and the import-route (BGP) command. If only the
import-route (BGP) command is used, default routes cannot be
imported. In addition, the default-route imported command is used to
import only the default routes that exist in the local routing table.
By default, BGP does not add default routes to BGP routing tables.
● In network mode
a. Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 798
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Run network
ipv4-address [
mask |
mask-length ] [ route-policy
route-
policy-name ]
Or run network
ipv6-address prefix-length [ route-policy
route-policy-
name ]
BGP is configured to import routes from the IPv4 or IPv6 routing table
one by one.
----End
9.6.6 Verifying the Basic BGP Function Configuration
Procedure
● Run the display bgp peer [ verbose ] command to check information about
all BGP peers.
● Run the display bgp peer
ipv4-address { log-info | verbose } command to
check information about the specified BGP peer.
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check BGP routing information.
● Run the display bgp group [
group-name ] command to check information
about the specified BGP peer group.
● Run the display bgp multicast peer [ [
peer-address ] verbose ] command to
check information about the specified MBGP peer.
● Run the display bgp multicast group [
group-name ] command to check
information about an MBGP peer group.
● Run the display bgp multicast network command to check the routing
information that MBGP advertises.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check the
MBGP routing table.
----End
9.7 Configuring BGP Security
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 799
Pre-configuration Tasks
Before configuring BGP security, configure basic BGP functions.
Configuration Procedure
You can perform the following configuration tasks as required. The following
configuration tasks (excluding the task of Verifying the BGP Security
Configuration) can be performed in any sequence.
9.7.1 Configuring MD5 Authentication
Context
BGP uses TCP as the transmission protocol, and considers a packet valid as long as
the source address, destination address, source port, destination port, and TCP
sequence number of the packet are correct. However, most parameters in a packet
may be easily obtained by attackers. To protect BGP from attacks, use MD5
authentication or keychain authentication between BGP peers to reduce the
possibility of attacks. The MD5 algorithm is easy to configure and generates a
single password that can only be manually changed.
NOTICE
If simple is selected during the configuration of the MD5 authentication
password, the password is saved in the configuration file in plain text. This brings
security risks. It is recommended that you select cipher to save the password in
cipher text. MD5 authentication has potential security risks.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run peer {
ipv4-address |
group-name |
ipv6-address } password { cipher
cipher-
password | simple
simple-password }
The MD5 authentication password is set.
NOTE
● To prevent the MD5 password set on BGP peers from being decrypted, update the MD5
password periodically.
● BGP MD5 authentication and BGP keychain authentication are mutually exclusive, and
only either of them can be configured for a BGP peer.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 800
9.7.2 Configuring Keychain Authentication
Context
BGP uses TCP as the transmission protocol, and considers a packet valid as long as
the source address, destination address, source port, destination port, and TCP
sequence number of the packet are correct. However, most parameters in a packet
may be easily obtained by attackers. To protect BGP from attacks, use MD5
authentication or keychain authentication between BGP peers to reduce the
possibility of attacks. The keychain algorithm is complex to configure and
generates a set of passwords. Keychain authentication allows automatically
changing a password based on the configuration. Therefore, keychain
authentication applies to networks requiring high security.
NOTE
Before configuring BGP keychain authentication, configure a keychain corresponding to
keychain-name. Otherwise, the TCP connection cannot be established. For details about
configuring a keychain, see Keychain Configuration in the
S300, S500, S2700, S5700, and
S6700 V200R024C00 Configuration Guide - Security.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run peer {
ipv4-address |
group-name |
ipv6-address } keychain
keychain-name
Keychain authentication is configured.
NOTE
● You must configure keychain authentication on both ends of the BGP connection.
Encryption algorithms and passwords configured on both ends must be the same;
otherwise, the TCP connection cannot be established between BGP peers and BGP
messages cannot be transmitted. SHA256 and HMAC-SHA256 encryption algorithms are
recommended in keychain authentication.
● BGP MD5 authentication and BGP keychain authentication are mutually exclusive, and
only either of them can be configured for a BGP peer.
● Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support keychain
keychain-name.
----End
9.7.3 Configuring BGP GTSM
Context
To protect a device against the attacks of forged BGP packets, you can configure
GTSM to check whether the TTL value in the IP packet header is within the
specified range. GTSM allows or discards packets with TTL values outside of the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 801
specified range according to networking requirements. When the default action to
be taken on packets is set to drop in GTSM, set a proper TTL range according to
the network topology. Then packets with TTL values outside of the specified range
are discarded. This prevents attackers from sending forged BGP packets to
consume CPU resources.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
NOTE
The configurations of GTSM and peer ebgp-max-hop affect the TTL values of BGP packets,
which may cause a conflict between TTL values. Therefore, you can configure only either of
the two functions for a peer or peer group.
Step 3 Run peer {
group-name |
ipv4-address |
ipv6-address } valid-ttl-hops [
hops ]
BGP GTSM is configured.
By default, GTSM is not configured on any BGP peer or peer group.
Step 4 (Optional) Run the gtsm default-action { drop | pass } command in the system
view:
The default action to be taken on the packets that do not match a GTSM policy is
set.
By default, the action to be taken on the packets that do not match the GTSM
policy is pass.
Step 5 (Optional) Run the gtsm log drop-packet all command in the system view:
The function of recording logs about discarded GTSM packet is enabled on the
device.
The logs help locate faults.
----End
9.7.4 Verifying the BGP Security Configuration
Procedure
● Run the display bgp peer verbose command to check detailed authentication
information about the specified BGP peer.
----End
9.8 Simplifying IBGP Network Connections
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 802
Pre-configuration Tasks
Before simplifying IBGP network connections, configure basic BGP functions.
Configuration Procedure
Perform the following configuration tasks in any sequence as required.
9.8.1 Configuring a BGP Route Reflector
Context
To ensure the connectivity between IBGP peers within an AS, you need to establish
full-mesh connections between the IBGP peers. When there are many IBGP peers,
it is costly to establish a fully-meshed network. A route reflector (RR) can solve
this problem.
A cluster ID can help prevent routing loops between multiple RRs within a cluster
and between clusters. When a cluster has multiple RRs, the same cluster ID must
be configured for all the RRs within the cluster.
If full-mesh IBGP connections are established between clients of multiple RRs,
route reflection between clients is not required and wastes bandwidth resources.
In this case, prohibit route reflection between clients to reduce the network
burden.
Within an AS, an RR transmits routing information and forwards traffic. When an
RR connects to a large number of clients and non-clients, many CPU resources are
consumed if the RR transmits routing information and forwards traffic
simultaneously. This also reduces route transmission efficiency. To improve route
transmission efficiency, prohibit BGP from adding preferred routes to IP routing
tables on the RR to enable the RR only to transmit routing information.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
BGP is enabled and the BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family unicast
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run peer {
group-name |
ipv4-address |
ipv6-address } reflect-client
An RR and its client are configured.
By default, the route reflector and its client are not configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 803
Step 5 (Optional) Run reflector cluster-id
cluster-id
A cluster ID is configured for the RR.
By default, each RR uses its router ID as the cluster ID.
Step 6 (Optional) Run undo reflect between-clients
Route reflection is prohibited between clients.
By default, route reflection is allowed between clients.
Step 7 (Optional) Run routing-table rib-only [ route-policy
route-policy-name ]
BGP is prohibited from adding preferred routes to IP routing tables.
By default, BGP adds preferred routes to IP routing tables.
----End
Verifying the Configuration
● Run the display bgp group [
group-name ] command to check information
about the specified BGP peer group.
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check routing information in a BGP
routing table.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check the
MBGP routing table.
9.8.2 Configuring a BGP Confederation
Context
A confederation divides an AS into sub-ASs. Within each sub-AS, IBGP peers
establish full-mesh connections or have an RR configured. Sub-ASs establish EBGP
connections. On a large BGP network, configuring a confederation can reduce the
number of IBGP connections, simplify routing policy management, and improve
route advertisement efficiency.
Other devices may implement the confederation not in accordance with RFC 3065.
You can configure confederation compatibility to make standard devices
compatible with nonstandard devices.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
BGP is enabled and the BGP view is displayed.
Step 3 Run confederation id {
as-number-plain |
as-number-dot }
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 804
A confederation ID is configured.
By default, no BGP confederation is configured.
NOTICE
An old speaker that has a 2-byte AS number cannot be in the same confederation
with a new speaker that has a 4-byte AS number. Otherwise, a routing loop may
occur. This is because the AS4_Path attribute does not support confederations.
Step 4 Run confederation peer-as {
as-number-plain |
as-number-dot } &<1-32>
A sub-AS number is configured for a confederation.
By default, no sub-AS number of the confederation is configured.
Step 5 (Optional) Run confederation nonstandard
Confederation compatibility is configured.
By default, confederations comply with RFC 3065.
----End
Verifying the Configuration
● Run the display bgp peer [
ipv4-address ] verbose command to check
detailed information about BGP peers.
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check routing information in a BGP
routing table.
9.9 Configuring BGP Route Selection and Load
Balancing
Pre-configuration Tasks
Before configuring BGP route attributes, configure basic BGP functions.
Configuration Procedure
Perform the following configuration tasks as required. The following configuration
tasks (excluding the task of Verifying the BGP Route Selection and Load Balancing
Configuration) can be performed in any sequence. For detailed route selection
rules, see 9.2.5 BGP Route Selection Rules and Load Balancing.
9.9.1 Configuring the BGP Priority
Context
The routing protocols may share and select routing information because switches
may run multiple dynamic routing protocols at the same time. The system sets a
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 805
default priority for each routing protocol. When multiple routing protocols are
used to select routes, the route selected by the routing protocol with a higher
priority takes effect.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run preference {
external internal local | route-policy
route-policy-name }
Or run preference
external internal local route-policy
route-policy-name
The BGP priority is set.
The default BGP priority is 255.
The smaller the preference value, the higher the preference.
BGP has the following types of routes:
● EBGP routes learned from peers in other ASs
● IBGP routes learned from peers in the same AS
● Locally originated routes (A locally originated route is a route summarized by
using the summary automatic command or the aggregate command.)
Different preference values can be set for these three types of routes.
In addition, a routing policy can also be used to set the preferences for the routes
that match the policy. The routes that do not match the policy use the default
preference.
NOTE
You cannot use the peer route-policy command on BGP peers to apply routing policies to
set the BGP priority.
----End
9.9.2 Configuring the Next_Hop Attribute
Context
When an Autonomous System Boundary Router (ASBR) forwards the route
learned from an EBGP peer to an IBGP peer, the ASBR does not change the next
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 806
hop of the route by default. When the IBGP peer receives this route, it finds the
next hop unreachable, sets the route to inactive, and does not use this route to
guide traffic forwarding. To enable the IBGP peer to use this route to guide traffic
forwarding, configure the ASBR to set its IP address as the next hop of the route
when the ASBR forwards this route to the IBGP peer. After the IBGP peer receives
the route from the ASBR, it finds the next hop of the route reachable, sets the
route to active, and uses this route to guide traffic forwarding.
When a BGP route changes, BGP needs to recurse the indirect next hop of the
route again. If no restriction is imposed on the recursed route, BGP may recurse
the next hop to an incorrect forwarding path, causing traffic loss. To prevent traffic
loss, configure routing policy-based route recursion.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Perform any of the following operations as required:
● Run peer {
ipv4-address |
group-name |
ipv6-address } next-hop-local
A BGP device is configured to set its IP address as the next hop when the
device advertises routes to an IBGP peer or an IBGP peer group.
By default, a BGP device does not change the next-hop address when
advertising routes to its IBGP peers.
● Run nexthop recursive-lookup route-policy
route-policy-name
BGP is configured to recurse the next hop based on a routing policy.
BGP does not recurse the next hop based on a routing policy.
● Run the peer {
ipv4-address |
group-name } next-hop-invariable command
in the IPv4 unicast address family view:
The device is prevented from changing the next-hop address of a route
imported from an IGP before advertising the route to an IBGP peer.
By default, a device changes the next-hop address of a route imported from
an IGP to the address of the interface connecting the device to its peer when
advertising the route to an IBGP peer.
NOTE
The nexthop recursive-lookup route-policy
route-policy-name command does not take
effect for the routes received from directly connected EBGP peers.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 807
9.9.3 Configuring the PrefVal Attribute
Context
The PrefVal attribute is a Huawei proprietary attribute and is valid only on the device where
it is configured. When a BGP routing table contains multiple routes to the same
destination, BGP prefers the route with the highest PrefVal.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run peer {
group-name |
ipv4-address |
ipv6-address } preferred-value
value
The PrefVal attribute is configured for all the routes learned from a specified peer.
By default, the PrefVal of a route learned from a peer is 0.
----End
9.9.4 Configuring the Default Local_Pref Attribute
Context
The Local_Pref attribute is used to determine the optimal route for outgoing traffic
of an AS. When a BGP device obtains multiple routes to the same destination
address but with different next hops from different IBGP peers, the BGP device
prefers the route with the highest Local_Pref value.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 808
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run default local-preference
local-preference
The default Local_Pref attribute is configured.
By default, the Local_Pref attribute is 100.
----End
9.9.5 Configuring the AS_Path Attribute
Context
The AS_Path attribute records all of the ASs that a route passes through from the
source to the destination in the vector order. You can configure the AS_Path
attribute to implement flexible route selection.
● Generally, BGP compares the AS_Path lists of routes and prefers the route
with the shortest AS_Path list. When the AS_Path attribute is not required in
route selection, configure BGP not to compare the AS_Path lists of routes
during route selection.
● In most cases, BGP detects routing loops based on the AS number. However,
to ensure correct route transmission on a hub-and-spoke network, you need
to configure all the BGP peers that VPN routes advertised from a hub CE to a
spoke CE pass through to accept the routes with a repeated AS number.
● Public AS numbers can be used on the Internet, but not private AS numbers
because they may cause routing loops. To prevent routing loops, configure the
AS_Path attribute to carry only public AS numbers in EBGP Update messages.
● When the AS_Path attribute is reconstructed or summarized routes are
generated, you can set the maximum number of AS numbers in the AS_Path
attribute. Then a BGP device checks whether the number of AS numbers in
the AS_Path attribute of a route exceeds the maximum value. If so, the BGP
device discards the route.
● A device usually supports only one BGP process. This indicates that a device
supports only one AS number. In some cases, for example, when network
migration changes an AS number, you can set a fake AS number to ensure
successful network migration.
● BGP checks the first AS number in the AS_Path list that is carried in the
Update message sent by an EBGP peer. If the first AS number specifies the AS
where the EBGP peer resides, BGP accepts the Update message. Otherwise,
BGP rejects the Update message and interrupts the EBGP connection. If you
do not want BGP to check the first AS number, disable the option.
Procedure
Step 1 Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 809
Step 2 Run route-policy
route-policy-name { deny | permit } node
node
A node is configured for a route-policy, and the view of the route-policy is
displayed.
Step 3 (Optional) Configure matching rules for the route-policy to change only the
community attributes of the routes that meet the matching rules.
By default, all routes meet matching rules. For details, see 10.6.2 (Optional)
Configuring an if-match Clause.
Step 4 Run apply as-path {
as-number-plain |
as-number-dot } &<1-10> { additive |
overwrite }
The AS_Path attribute is set for BGP routes.
Step 5 Run quit
Return to the system view.
Step 6 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 7 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 8 Add the AS_Path attribute to routes.
● Run peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-
policy-name export
The AS_Path attribute is added to the routes advertised to BGP peers or peer
groups.
● Run peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-
policy-name import
The AS_Path attribute is added to the routes received from BGP peers or peer
groups.
● Run import-route
protocol [
process-id ] route-policy
route-policy-name
The AS_Path attribute is added to the routes imported by BGP in import
mode.
● Run network {
ipv4-address [
mask |
mask-length ] |
ipv6-address prefix-
length } route-policy
route-policy-name
The AS_Path attribute is added to the routes imported by BGP in network
mode.
Step 9 (Optional) Run any of the following commands to configure the AS_Path attribute
as required.
● Run bestroute as-path-ignore
BGP is configured not to compare the AS_Path attributes of routes during
route selection.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 810
By default, BGP compares the AS_Path attributes of routes during route
selection.
● Run peer {
ipv4-address |
group-name |
ipv6-address } allow-as-loop
[
number ]
Repeated local AS numbers are allowed in routes.
By default, repeated local AS numbers are not allowed.
● Run peer {
ipv4-address |
group-name |
ipv6-address } public-as-only
[ force ]
BGP is configured to carry only public AS numbers in the AS_Path attribute in
an EBGP Update message.
By default, the AS_Path attribute can carry both public and private AS
numbers in an EBGP Update message.
● Run peer {
group-name |
ipv4-address |
ipv6-address } substitute-as
AS number substitution is enabled. The device replaces the AS number of the
peer specified in the AS_Path attribute with the local AS number.
By default, AS number substitution is disabled.
NOTE
Enabling BGP AS number substitution may cause route loops in a CE multi-homing
network.
● Return to the BGP view to configure the AS_Path attribute.
a. Run quit
Return to the BGP view.
b. (Optional) Run any of the following commands to configure the AS_Path
attribute as required.
▪ Run as-path-limit
as-path-limit-num
The maximum number of AS numbers in the AS_Path attribute is set.
By default, the maximum number of AS numbers in the AS_Path
attribute is 255.
▪ Run peer {
ipv4-address |
group-name |
ipv6-address } fake-as
[ prepend-global-as ]
The peer fake-as command can be used to hide the actual AS
number of a BGP device. EBGP peers in other ASs will use the fake
AS number of this BGP device to set up EBGP peer relationships with
this device.
A fake AS number is configured for an EBGP peer group.
By default, EBGP peers establish a connection using the actual AS
number.
NOTICE
Running the undo check-first-as command increases the probability
of routing loops. Therefore, exercise caution when using this
command.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 811
▪ Run undo check-first-as
BGP is configured not to check the first AS number in the AS_Path
list that is carried in the Update message sent by an EBGP peer.
By default, BGP checks the first AS number in the AS_Path list that is
carried in the Update message sent by an EBGP peer.
NOTE
When BGP is disabled from checking the first AS number, run the refresh
bgp command in the user view if you want BGP to check the first AS
number of received routes.
----End
9.9.6 Configuring the MED Attribute
Context
The multi-exit discriminator (MED) helps determine the optimal route for
incoming traffic of an AS. It is similar to the metric used in IGP. When a BGP
device obtains multiple routes to the same destination address but with different
next hops from EBGP peers, the BGP device selects the route with the smallest
MED value as the optimal route.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Perform any of the following operations as required:
● Run default med
med
The default MED value is set.
By default, the MED is 0.
● Run bestroute med-none-as-maximum
BGP defines the MED value as the maximum value if a route does not have
the MED attribute.
By default, BGP uses the default MED value when a route does not have the
MED attribute.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 812
● Run compare-different-as-med
BGP is allowed to compare the MED values of routes received from EBGP
peers in any AS.
By default, BGP compares only the MEDs of the routes received from EBGP
peers within the same AS.
● Run deterministic-med
The deterministic-MED function is enabled.
By default, the BGP deterministic-MED function is disabled.
● Run bestroute med-confederation
The MED values of routes in a confederation are compared.
By default, BGP compares only the MEDs of the routes from the same AS.
----End
9.9.7 Configuring the BGP Community Attribute
Context
The Community attribute is a private BGP route attribute. It is transmitted
between BGP peers and is not restricted within an AS. The Community attribute
allows a group of BGP devices in multiple ASs to share the same routing policies,
which simplifies routing policy applications and facilitates routing policy
management and maintenance. A BGP device can add or change the community
attributes of routes to be advertised.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run route-policy
route-policy-name { deny | permit } node
node
A node is configured for a route-policy, and the view of the route-policy is
displayed.
Step 3 (Optional) Configure matching rules for the route-policy to change only the
community attributes of the routes that meet the matching rules.
By default, all routes meet matching rules. For details, see 10.6.2 (Optional)
Configuring an if-match Clause.
Step 4 Run either of the following commands to configure the Community attribute.
● Run apply community {
community-number |
aa:nn | internet | no-advertise
| no-export | no-export-subconfed } &<1-32> [ additive ]
Common community attributes are configured for BGP routes.
NOTE
You can run this command to configure a maximum of 32 community attributes at a
time.
● Run apply extcommunity { rt {
as-number:nn |
ipv4-address:nn } } &<1-16>
[ additive ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 813
A BGP extended community attribute (route-target) is configured.
Extended community attributes are extensions to community attributes in
services. Currently, only the route-target attribute is supported in VPN.
Step 5 Run quit
Return to the system view.
Step 6 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 7 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 8 Add the Community attribute to routes.
● Run peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-
policy-name export
The Community attribute is added to the routes advertised to BGP peers or
peer groups.
● Run peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-
policy-name import
The Community attribute is added to the routes received from BGP peers or
peer groups.
● Run import-route
protocol [
process-id ] route-policy
route-policy-name
The Community attribute is added to the routes imported by BGP in import
mode.
● Run network {
ipv4-address [
mask |
mask-length ] |
ipv6-address prefix-
length } route-policy
route-policy-name
The Community attribute is added to the routes imported by BGP in network
mode.
NOTE
Step 9 is required only when the Community attribute needs to be added to the routes
advertised to BGP peers or peer groups.
Step 9 (Optional) Allow BGP to advertise community attributes when BGP adds
community attributes to the routes advertised to BGP peers or peer groups.
● Run peer {
ipv4-address |
group-name |
ipv6-address } advertise-community
BGP is allowed to advertise community attributes to BGP peers or peer
groups.
By default, BGP does not advertise community attributes to any peer or peer
group.
● To advertise an extended community attribute to a specified peer or peer
group, perform the following steps:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 814
a. Run the peer {
ipv4-address |
group-name |
ipv6-address } advertise-ext-
community command to advertise an extended community attribute to a
specified peer or peer group.
b. Run the ext-community-change enable command to enable the device
to change extended community attributes using a routing policy.
By default, BGP peers cannot change extended community attributes
using a route-policy; specifically, BGP peers advertise only the extended
community attributes carried in routes to a specified peer or peer group,
and the peer route-policy command cannot be used to modify the
extended community attributes.
----End
9.9.8 Configuring BGP Load Balancing
Context
On a large network, there may be multiple valid BGP routes to the same
destination. A switch will select and add the optimal BGP route to its routing table
for traffic forwarding and advertises this route to its peers. This, however, will
result in uneven load balancing of much traffic. Configuring BGP load balancing
can enable the switch to add these multiple equal-cost BGP routes to its routing
table, implementing traffic load balancing and reducing network congestion. After
BGP load balancing is configured, the switch will still select the optimal route
among the multiple routes and advertise only this route to its peers.
Equal-cost BGP routes can be generated for traffic load balancing only when the
first eight route attributes described in "BGP Route Selection Policies" are the
same. Change load balancing rules by adjusting some configurations, for example,
ignoring the comparison of the AS_Path attribute. When adjusting these
configurations, ensure that these configurations do not result in routing loops.
NOTE
If BGP load balancing is configured, the local device changes the next-hop address of routes
to its address when advertising routes to IBGP peer groups, regardless of whether the peer
next-hop-local command is used.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 815
The IPv6 address family view is displayed.
Step 4 Run maximum load-balancing [ ebgp | ibgp ]
number [ ecmp-nexthop-
changed ]
The maximum number of BGP routes to be used for load balancing is set.
By default, the maximum number of BGP routes to be used for load balancing is
1, indicating that load balancing is not implemented.
NOTE
● On a public network, if the routes to the same destination implement load balancing,
the system will determine the optimal route type. If the optimal routes are IBGP routes,
only IBGP routes carry out load balancing. If the optimal routes are EBGP routes, only
EBGP routes carry out load balancing. This means that load balancing cannot be
implemented among IBGP and EBGP routes with the same destination address.
● On an IPv4 multicast network, BGP compares the AS_Path attributes of the routes to be
used for load balancing. In this case, step 5 is not supported.
NOTICE
Configuring BGP not to compare the AS_Path attributes of the routes to be used
for load balancing may cause routing loops.
Step 5 (Optional) Run load-balancing as-path-ignore
BGP is configured not to compare the AS_Path attributes of the routes to be used
for load balancing.
By default, BGP compares the AS_Path attributes of the routes to be used for load
balancing.
----End
9.9.9 Verifying the BGP Route Selection and Load Balancing
Configuration
Procedure
● Run the display bgp paths [
as-regular-expression ] command to check BGP
AS_Path information.
● Run the display bgp routing-table different-origin-as command to check
the routes with the same destination address but different origin ASs.
● Run the display bgp routing-table regular-expression
as-regular-expression
command to check information about routes that match the AS regular
expression.
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check routing information in a BGP
routing table.
● Run the display bgp routing-table community [
community-number |
aa:nn ] &<1-29> [ internet | no-advertise | no-export | no-export-
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 816
subconfed ] * [ whole-match ] command to check routing information with
the specified BGP community.
● Run the display bgp routing-table community-filter { {
community-filter-
name |
basic-community-filter-number } [ whole-match ] |
advanced-
community-filter-number } command to check information about routes
matching a specified BGP community filter.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check the
MBGP routing table.
● Run the display bgp multicast routing-table statistics command to check
statistics about the MBGP routing table.
----End
9.10 Controlling the Receiving and Advertisement of
BGP Routes
Pre-configuration Tasks
Before controlling the receiving and advertisement of BGP routes, configure basic
BGP functions.
Configuration Procedure
Figure 9-41 Flowchart of controlling the receiving and advertisement of BGP
routes
9.10.1 Configuring a Routing Policy
Context
Before controlling the receiving and advertisement of BGP routes, configure
routing policies or filters of routing policies for route selection. For details, see 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 817
Routing Policy Configuration in the
S300, S500, S2700, S5700, and S6700
V200R024C00 Configuration Guide - IP Unicast Routing.
9.10.2 Controlling the Advertisement of BGP Routes
Context
There are usually a large number of routes in a BGP routing table. Transmitting a
great deal of routing information heavily burdens devices. To address this problem,
you can configure devices to advertise only the routes that they want to advertise
or routes that their peers require. Multiple routes to the same destination may
exist and traverse different ASs. Routes to be advertised need to be filtered in
order to direct routes to specific ASs.
Procedure
● Configure the BGP device to filter the routes advertised by all its peers or peer
groups.
You can configure a BGP device to filter routes to be advertised.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform either of the following operations to configure the BGP device to
advertise routes to all peers or peer groups:
▪ To filter routes based on an ACL, run the filter-policy {
acl-number |
acl-name
acl-name } export [
protocol [
process-id ] ] or the filter-
policy {
acl6-number | acl6-name
acl6-name } export [
protocol
[
process-id ] ] command.
▪ To filter routes based on an IP prefix list, run the filter-policy ip-
prefix
ip-prefix-name export [
protocol [
process-id ] ] or the filter-
policy ipv6-prefix
ipv6-prefix-name export [
protocol [
process-id ] ]
command.
NOTE
If an ACL has been referenced in the filter-policy command but no VPN instance
is specified in the ACL rule, BGP will filter routes including public and private
network routes in all address families. If a VPN instance is specified in the ACL
rule, only the data traffic from the VPN instance will be filtered, and no route of
this VPN instance will be filtered.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 818
● Configure BGP to filter the routes advertised by a specified peer or peer
group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform any of the following operations to configure the BGP device to
advertise routes to a specific peer or peer group:
▪ To filter routes based on an ACL, run the peer {
group-name |
ipv4-
address |
ipv6-address } filter-policy {
acl-number | acl-name
acl-
name |
acl6-number | acl6-name
acl6-name } export command.
▪ To filter routes based on an IP prefix list, run the peer {
ipv4-address
|
group-name } ip-prefix
ip-prefix-name export or the peer {
group-
name |
ipv4-address |
ipv6-address } ipv6-prefix
ipv6-prefix-name
export command.
▪ To filter routes based on an AS_Path filter, run the peer {
ipv4-
address |
group-name |
ipv6-address } as-path-filter {
as-path-filter-
number |
as-path-filter-name } export command.
▪ To filter routes based on a route-policy, run the peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-policy-name export
command.
NOTE
The routing policy applied in the peer route-policy export command does not
support a specific interface as one matching rule. That is, the routing policy does
not support the if-match interface command.
----End
9.10.3 Controlling the Receiving of BGP Routes
Context
When a BGP device is attacked or network configuration errors occur, the BGP
device will receive a large number of routes from its peer. As a result, many device
resources are consumed. Therefore, the administrator must limit the resources
used by the device based on network planning and device capacity. BGP provides
peer-based route control to limit the number of routes to be sent by a peer. This
addresses the preceding problem.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 819
Procedure
● Configure the BGP device to filter the routes received from all its peers or
peer groups.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform either of the following operations to configure the BGP device to
filter the routes received from all its peers or peer groups:
▪ To filter routes based on an ACL, run the filter-policy {
acl-number |
acl-name
acl-name } import or the filter-policy {
acl6-number |
acl6-name
acl6-name } import command.
▪ To filter routes based on an IP prefix list, run the filter-policy ip-
prefix
ip-prefix-name import or the filter-policy ipv6-prefix
ipv6-
prefix-name import command.
NOTE
If an ACL has been referenced in the filter-policy command but no VPN instance
is specified in the ACL rule, BGP will filter routes including public and private
network routes in all address families. If a VPN instance is specified in the ACL
rule, only the data traffic from the VPN instance will be filtered, and no route of
this VPN instance will be filtered.
● Configure BGP to filter the routes received from a specified peer or peer
group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform any of the following operations to configure the BGP device to
filter the routes received from a specific peer or peer group:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 820
▪ To filter routes based on an ACL, run the peer {
group-name |
ipv4-
address |
ipv6-address } filter-policy {
acl-number | acl-name
acl-
name |
acl6-number | acl6-name
acl6-name } import command.
▪ To filter routes based on an IP prefix list, run the peer {
ipv4-address
|
group-name } ip-prefix
ip-prefix-name import or the peer {
group-
name |
ipv4-address |
ipv6-address } ipv6-prefix
ipv6-prefix-name
import command.
▪ To filter routes based on an AS_Path filter, run the peer {
ipv4-
address |
group-name |
ipv6-address } as-path-filter {
as-path-filter-
number |
as-path-filter-name } import command.
▪ To filter routes based on a route-policy, run the peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-policy-name import
command.
NOTE
The routing policy applied in the peer route-policy import command does not
support a specific interface as one matching rule. That is, the routing policy does
not support the if-match interface command.
NOTICE
If the number of routes received by the local device exceeds the upper
limit and the peer route-limit command is used for the first time, the
local device and its peer reestablish the peer relationship, regardless of
whether alert-only is set.
e. (Optional) Run peer {
group-name |
ipv4-address |
ipv6-address } route-
limit
limit [
percentage ] [ alert-only | idle-forever | idle-timeout
times ]
The maximum number of routes that can be received from the peer or
peer group is set.
----End
9.10.4 Configuring BGP Soft Reset
Context
After changing a BGP import policy, you must reset BGP connections for the new
import policy to take effect. This, however, interrupts the BGP connections
temporarily. BGP route-refresh allows the system to softly reset BGP connections
to refresh a BGP routing table without tearing down any BGP connection. If a
device's peer does not support route-refresh, configure the device to retain all
routing updates received from the peer so that the device can refresh its routing
table without tearing down the BGP connection with the peer.
Procedure
● If a device's peer supports route-refresh, configure the device to softly reset
the BGP connection with the peer and update the BGP routing table.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 821
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. (Optional) Run peer {
ipv4-address |
group-name } capability-advertise
route-refresh
Or run peer
ipv6-address capability-advertise { 4-byte-as | route-
refresh }
Route-refresh is enabled.
By default, route-refresh is enabled.
d. Run quit
Return to the system view.
e. Run quit
Return to the user view.
f. Run refresh bgp [ vpn-instance
vpn-instance-name ipv4-family |
vpnv4 ] { all |
ipv4-address | group
group-name | external | internal }
{ export | import }
Or run refresh bgp ipv6 { all | group
group-name |
ipv4-address |
ipv6-
address | external | internal } { export | import }
BGP soft reset is configured.
● If a device's peer does not support route-refresh, configure the device to
retain all routing updates received from the peer so that the device can
refresh its routing table without tearing down the BGP connection with the
peer.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
NOTICE
If the peer keep-all-routes command is used on the device for the first
time, the sessions between the device and its peers are reestablished.
The refresh bgp command takes effect when the peer keep-all-routes
command is used on the device supporting route-refresh.
d. Run peer {
ipv4-address |
group-name |
ipv6-address } keep-all-routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 822
The device is configured to store all the routing updates received from its
peers or peer groups.
By default, the device stores only the routing updates that are received
from peers or peer groups and match a configured import policy.
----End
9.10.5 Verifying the BGP Route Receiving and Advertisement
Configuration
Procedure
● Run the display ip as-path-filter [
as-path-filter-number |
as-path-filter-
name ] command to check information about a configured AS_Path filter.
● Run the display ip community-filter [
basic-comm-filter-num |
adv-comm-
filter-num |
comm-filter-name ] command to check information about a
configured community filter.
● Run the display ip extcommunity-filter [
extcomm-filter-number |
extcomm-
filter-name ] command to check information about a configured extended
community filter.
● Run the display bgp routing-table as-path-filter {
as-path-filter-number |
as-path-filter-name } command to check information about routes matching
a specified AS_Path filter.
● Run the display bgp routing-table community-filter { {
community-filter-
name |
basic-community-filter-number } [ whole-match ] |
advanced-
community-filter-number } command to check information about routes
matching a specified BGP community filter.
● Run the display bgp routing-table peer
ipv4-address received-routes
[ active ] [ statistics ] command to check information about routes received
by a BGP device from its peers.
● Run the display bgp multicast routing-table different-origin-as command
to check information about MBGP routes with different origin ASs.
● Run the display bgp multicast routing-table regular-expression
as-regular-
expression to check information about MBGP routes matching the AS regular
expression.
● Run the display bgp multicast paths [
as-regular-expression ] command to
check information about AS paths.
● Run the display bgp multicast routing-table as-path-filter {
as-path-filter-
number |
as-path-filter-name } command to check information about MBGP
routes matching the AS_Path filter.
● Run the display bgp multicast routing-table community-filter
{ {
community-filter-name |
basic-community-filter-number } [ whole-
match ] |
advanced-community-filter-number } command to check
information about routes matching a specified MBGP community filter.
● Run the display bgp multicast routing-table peer
peer-address
{ advertised-routes [
network [ {
mask |
mask-length } [ longer-prefixes ] ] ]
| received-routes [ active ] | accepted-routes } command to check
information about routes that are sent by and received from the specified
MBGP peer.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 823
● Run the display bgp multicast network command to check the routing
information that MBGP advertises.
----End
9.11 Adjusting the BGP Network Convergence Speed
Pre-configuration Tasks
Before adjusting the BGP network convergence speed, configure basic BGP
functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the BGP Network Convergence Speed Adjustment Configuration) in any sequence.
9.11.1 Configuring a BGP ConnectRetry Timer
Context
After BGP initiates a TCP connection, the ConnectRetry timer will be stopped if the
TCP connection is established successfully. If the first attempt to establish a TCP
connection fails, BGP tries again to establish the TCP connection after the
ConnectRetry timer expires.
● Setting a short ConnectRetry interval reduces the period BGP waits between
attempts to establish a TCP connection. This speeds up the establishment of
the TCP connection.
● Setting a long ConnectRetry interval suppresses routing flapping caused by
peer relationship flapping.
A ConnectRetry timer can be configured either for all peers or peer groups, or for
a specific peer or peer group. A ConnectRetry timer configured for a specific peer
takes precedence over that configured for the peer group of this peer. In addition,
a ConnectRetry timer configured for a specific peer or peer group takes
precedence over that configured for all peers or peer groups.
Procedure
● Configure a BGP ConnectRetry timer for all peers or peer groups.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run timer connect-retry
connect-retry-time
A BGP ConnectRetry timer is configured for all peers or peer groups.
By default, the ConnectRetry timer value is 32s.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 824
● Configure a ConnectRetry timer for a specific peer or peer group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run peer {
group-name |
ipv4-address |
ipv6-address } timer connect-
retry
connect-retry-time
A ConnectRetry timer is configured for a specific peer or peer group.
By default, the ConnectRetry timer value is 32s.
----End
9.11.2 Configuring BGP Keepalive and Hold Timers
Context
Keepalive messages are used by BGP to maintain peer relationships.
● If short Keepalive time and holdtime are set, BGP can detect a link fault
quickly. This speeds up BGP network convergence, but increases the number
of Keepalive messages on the network and loads of devices, and consumes
more network bandwidth resources.
● If long Keepalive time and holdtime are set, the number of Keepalive
messages on the network is reduced, loads of devices are reduced, and less
network bandwidth is consumed. If the Keepalive time is too long, BGP is
unable to detect link status changes in a timely manner. This hinders the
implementation of rapid BGP network convergence and may cause significant
packet loss.
Keepalive and hold timers can be configured either for all peers or peer groups, or
for a specific peer or peer group. Keepalive and hold timers configured for a
specific peer take precedence over those configured for the peer group of the peer.
In addition, Keepalive and hold timers configured for a specific peer or peer group
take precedence over those configured for all peers or peer groups.
NOTICE
Changing timer values using the timer command or the peer timer command
interrupts BGP peer relationships between switches.
Setting the Keepalive time to 20s is recommended. If the Keepalive time is less
than 20s, sessions between peers may be closed.
Procedure
● Configure BGP timers for all peers or peer groups.
a. Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 825
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run timer keepalive
keepalive-time hold
hold-time [ min-holdtime
min-holdtime ]
BGP timers are configured.
The proper maximum interval at which Keepalive messages are sent is
one third the holdtime. By default, the Keepalive time is 60s and the
holdtime is 180s.
● Configure BGP timers for a specific peer or peer group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run peer {
ipv4-address |
group-name |
ipv6-address } timer keepalive
keepalive-time hold
hold-time [ min-holdtime
min-holdtime ]
The Keepalive and hold timers are configured for a specific peer or peer
group.
The proper maximum interval at which Keepalive messages are sent is
one third the holdtime. By default, the Keepalive time is 60s and the
holdtime is 180s.
----End
9.11.3 Configuring an Update Message Timer
Context
BGP does not periodically update a routing table. When BGP routes change, BGP
updates the changed BGP routes in the BGP routing table by sending Update
messages.
● If a short Update message interval is set, BGP can fast detect route changes.
This speeds up BGP network convergence, but increases the number of
Update messages on the network and loads of devices, and consumes more
network bandwidth resources.
● If a long Update message interval is set, the number of Update messages on
the network is reduced, loads of devices are reduced, and less network
bandwidth is consumed. This avoids network flapping. If the Update message
interval is too long, BGP is unable to detect route changes in a timely manner.
This hinders the implementation of rapid BGP network convergence and may
cause significant packet loss.
Procedure
Step 1 Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 826
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run peer {
ipv4-address |
group-name |
ipv6-address } route-update-interval
interval
An Update message timer is configured.
By default, the interval at which Update messages are sent to IBGP peers is 15s,
and the interval at which Update messages are sent to EBGP peers is 30s.
----End
9.11.4 Disabling Rapid EBGP Connection Reset
Context
Rapid EBGP connection reset is enabled by default. This allows BGP to
immediately respond to a fault on an interface and delete the direct EBGP sessions
on the interface without waiting for the hold timer to expire and implements rapid
BGP network convergence.
If the status of an interface used to establish an EBGP connection changes
frequently, the EBGP session will be deleted and reestablished repeatedly, causing
network flapping. Rapid EBGP connection reset can be disabled in such a situation.
BGP will delete direct EBGP sessions on the interface until the hold timer expires.
This suppresses BGP network flapping and reduces network bandwidth
consumption.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run undo ebgp-interface-sensitive
Rapid EBGP connection reset is disabled.
By default, rapid EBGP connection reset is enabled.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 827
NOTE
Rapid EBGP connection reset enables BGP to quickly respond to interface faults but
prevents BGP from quickly responding to interface recovery. After the interface recovers,
BGP uses its state machine to restore relevant sessions.
Rapid EBGP connection reset is disabled in a situation where the status of an interface used
to establish an EBGP connection changes frequently. If the status of the interface becomes
stable, run the ebgp-interface-sensitive command to enable rapid EBGP connection reset
to implement rapid BGP network convergence.
----End
9.11.5 Configuring the BGP Next Hop Delayed Response
Context
Configuring the BGP next hop delayed response can speed up BGP route
convergence and minimize traffic loss.
As shown in Figure 9-42, PE1, PE2, and PE3 are the clients of the RR. CE2 is dual-
homed to PE1 and PE2. PE1 and PE2 advertise their routes to CE2 to the RR. The
RR advertises the route from PE1 to PE3. PE3 has a route to CE2 only and
advertises this route to CE1. After the route exchange, CE1 and CE2 can
communicate. If PE1 fails, PE3 detects that the next hop is unreachable and
instructs CE1 to delete the route to CE2. Traffic is then interrupted. After BGP
route convergence is complete, the RR selects the route advertised by PE2 and
sends a route update message to PE3. PE3 then advertises this route to CE1, and
traffic forwarding is restored to the normal state. A high volume of traffic will be
lost during traffic interruption because BGP route convergence is rather slow.
If the BGP next hop delayed response is enabled on PE3, PE3 does not reselect a
route or instruct CE1 to delete the route to CE2 immediately after detecting that
the route to PE1 is unreachable. After BGP convergence is complete, the RR selects
the route advertised by PE2 and sends the route to PE3. PE3 then reselects a route
and sends a route update message to CE1. Traffic forwarding is restored to the
normal state. After the BGP next hop delayed response is enabled on PE3, PE3
does not need to delete the route or instruct CE1 to delete the route. This delayed
response speeds up BGP route convergence and minimizes traffic loss.
Figure 9-42 Networking diagram of configuring the BGP next hop delayed
response
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 828
The BGP next hop delayed response applies to scenarios where the next hop has
multiple links to reach the same destination. If there is only one link between the
next hop and the destination, configuring the BGP next hop delayed response may
cause heavier traffic loss when the link fails because link switching is impossible.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Set a delay in responding to next hop changes.
The recursion results are as follows:
● Urgent recursion result change
The recursive next hop is changed, and BGP route reachability is also changed.
For example, if a fault occurs on a network, a device finds no next-hop route
or tunnel to which a BGP route is recursed. As a result, traffic is interrupted.
● Non-urgent recursion result change
The recursive next hop is changed, and BGP route reachability is not affected.
For example, after the interface or type of a tunnel to which the next hop of a
BGP route is recursed is changed (that is, the recursed tunnel is changed),
traffic keeps traveling over the BGP route.
Run either of the following commands to set a delay time after which a device
responds to a BGP next hop change:
● Run nexthop recursive-lookup delay [
delay-time ]
A device is enabled to delay responses to all next hop changes.
● Run nexthop recursive-lookup non-critical-event delay [
delay-time ]
A device is enabled to delay responses to non-urgent next hop changes.
If
delay-time is not specified, the default delay time is 5s.
The preceding commands can be run separately or simultaneously. The nexthop
recursive-lookup non-critical-event delay command takes precedence over the
nexthop recursive-lookup delay command if both commands are run.
The delay time specified in the nexthop recursive-lookup non-critical-event
delay command must be greater than or equal to that specified in the nexthop
recursive-lookup delay command if both commands are run.
----End
9.11.6 Configuring BGP Route Dampening
Context
A route is considered to be flapping when it repeatedly appears and then
disappears in the routing table. BGP generally applies to complex networks where
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 829
routes change frequently. Frequent route flapping consumes lots of bandwidths
and CPU resources and even affects normal network operation. BGP route
dampening prevents frequent route flapping.
BGP can differentiate routes based on policies and use different route dampening
parameters to suppress different routes. For example, on a network, you can set a
long suppression time for routes with a long mask and set a short suppression
time for routes with a short mask (such as 8-bit mask).
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast | vpnv4 [ unicast ] | vpn-instance
vpn-
instance-name }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast | vpn-instance
vpn-instance-name ]
The IPv6 address family view is displayed.
Step 4 Run dampening [ ibgp ] [
half-life-reach reuse suppress ceiling | route-policy
route-policy-name ] *
BGP route dampening parameters are configured.
NOTE
The dampening command is valid only for EBGP routes.
----End
9.11.7 Configuring Slow Peer Detection
Context
An update peer-group may consist of multiple BGP peers. If a network problem
(congestion for example) occurs and slows down the speed at which the local
device advertises routes to a BGP peer in the update peer-group, the speed at
which the local device advertises routes to other BGP peers in the update peer-
group is affected. To address this problem, slow peer detection is enabled by
default.
When slow peer detection is enabled, the local device identifies the BGP peer to
which routes are sent the slowest based on the time taken to send 100 packets to
each BGP peer. If this time is greater than the period threshold for slow peer
detection plus the average time taken to send 100 packets to BGP peers
(excluding the longest and shortest times), the local device considers the peer a
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 830
slow peer and removes it from the update peer-group. Slow peer detection
prevents this slow peer from affecting route advertisement to other peers in the
update peer-group. By default, the period threshold for slow peer detection is
300s.
To adjust the period threshold for slow peer detection or disable slow peer
detection, run the following steps.
NOTE
After a slow peer is removed from the update peer-group, the peer relationship between
the local device and the slow peer is reestablished.
Procedure
● Adjust the period threshold for slow peer detection
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run slow-peer detection threshold
threshold-value
Set a period threshold for slow peer detection.
By default, the period threshold for slow peer detection is 300s.
threshold-value specifies a period threshold for slow peer detection. If the
time taken to send 100 packets to a BGP peer is X, the configured period
is Y, the average time taken to send 100 packets to BGP peers (excluding
the longest and shortest times) is Z, and the inequality (X > Y + Z) is met,
the local device considers the BGP peer a slow peer and removes it from
the update peer-group.
● Disable slow peer detection
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run slow-peer detection disable
The slow peer detection is disabled.
----End
9.11.8 Verifying the BGP Network Convergence Speed
Adjustment Configuration
Procedure
● Run the display bgp peer [ verbose ] command to check information about
all BGP peers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 831
● Run the display bgp group [
group-name ] command to check information
about the specified BGP peer group.
● Run the display bgp routing-table dampened command to check dampened
BGP routes.
● Run the display bgp routing-table dampening parameter command to
check configured BGP route dampening parameters.
● Run the display bgp routing-table flap-info [ regular-expression
as-
regular-expression | as-path-filter
as-path-filter-number |
network-address
[ {
mask |
mask-length } [ longer-match ] ] ] command to check route
flapping statistics.
● Run the display bgp multicast routing-table dampened command to check
dampened MBGP routes.
● Run the display bgp multicast routing-table dampening parameter
command to check MBGP route dampening parameters.
● Run the following commands to check statistics about flapping MBGP routes:
– display bgp multicast routing-table flap-info [
ip-address [
mask
[ longer-match ] |
mask-length [ longer-match ] ] | as-path-filter
as-
path-filter-number | regular-expression
as-regular-expression ]
– display bgp multicast routing-table flap-info regular-expression
as-
regular-expression
----End
9.12 Configuring BGP Reliability
Pre-configuration Tasks
Before configuring BGP reliability, configure basic BGP functions.
Configuration Procedure
You can perform the following configuration tasks in any sequence.
9.12.1 Enabling BGP Tracking
Context
BFD can be configured to detect peer relationship status changes in order to
implement rapid BGP convergence. BFD, however, needs to be configured on the
entire network, and has poor extensibility. If BFD cannot be deployed on a device
to detect BGP peer relationship status, BGP peer tracking can be enabled on the
device to quickly detect link or peer unreachability, implementing rapid network
convergence.
BGP tracking can be used to adjust the interval between peer unreachability
discovery and connection interruption. This suppresses BGP peer relationship
flapping caused by route flapping and improves BGP network stability.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 832
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run peer {
group-name |
ipv4-address |
ipv6-address } tracking [ delay
delay-
time ]
BGP peer tracking is enabled on the device to detect the status of a specified peer.
By default, BGP peer tracking is disabled.
----End
9.12.2 Configuring BFD for BGP
Context
BGP periodically sends Keepalive messages to its peers to detect the status of its
peers. It takes more than 1 second for this detection mechanism to detect a fault.
When data is transmitted at gigabit rates, long-time fault detection will cause
packet loss and cannot meet high reliability requirements of carrier-class
networks. BFD for BGP can solve this problem. BFD is a millisecond-level fault
detection mechanism. It can fast detect faults on the link between BGP neighbors.
Therefore, BFD speeds up BGP route convergence, ensures fast link switching, and
reduces traffic loss.
When a peer joins a peer group on which BFD is enabled, BFD also takes effect on
the peer and a BFD session is created on the peer. To prevent BFD from taking
effect on the peer, run the peer bfd block command.
By default, Huawei devices establish multi-hop IBGP sessions with each other.
When a Huawei device communicates with a non-Huawei device that establishes
a single-hop IBGP session by default, you are advised to configure only association
between IGP and BFD or association between IBGP and BFD.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support BFD for BGP.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bfd
Global BFD is enabled on the local device.
Step 3 Run quit
Return to the system view.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 833
Step 4 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 5 Run peer {
group-name |
ipv4-address |
ipv6-address } bfd enable [ single-hop-
prefer ]
BFD is configured for the peer or peer group, and default BFD parameters are
used to establish BFD sessions.
single-hop-prefer takes effect only on IBGP peers. By default, if single-hop-
prefer is not specified, multi-hop sessions are established between direct IBGP
peers (Huawei devices). To interconnect a Huawei device and a non-Huawei
device that defaults the sessions between IBGP peers to single-hop, configure
single-hop-prefer in the command.
If BFD is configured for a peer group, BFD sessions are created for the peers on
which the peer bfd block command is not used.
Step 6 Run peer {
group-name |
ipv4-address |
ipv6-address } bfd { min-tx-interval
min-
tx-interval | min-rx-interval
min-rx-interval | detect-multiplier
multiplier | wtr
wtr-value } *
BFD session parameters are configured.
Step 7 (Optional) Run peer {
ipv4-address |
ipv6-address } bfd block
The peer is disabled from inheriting the BFD function of the peer group to which
the peer belongs.
NOTE
● BFD sessions are established when they are in Established state.
● If BFD parameters are configured on a peer, BFD sessions are established using these
parameters.
● The peer {
ipv4-address |
ipv6-address } bfd block and peer {
group-name |
ipv4-
address |
ipv6-address } bfd enable [ single-hop-prefer ] commands are mutually
exclusive.
----End
Verifying the Configuration
● Run the display bgp bfd session { [ vpnv4 vpn-instance
vpn-instance-
name ] peer
ipv4-address | all } command to check information about the
BFD sessions established between BGP peers.
● Run the display bgp [ vpnv4 vpn-instance
vpn-instance-name ] peer
[ [
ipv4-address ] verbose ] command to check information about BGP peers.
● Run the display bgp group [
group-name ] command to check information
about the specified BGP peer group.
● Run the display bgp vpnv4 { all | vpn-instance
vpn-instance-name } group
[
group-name ] command to check information about the BGP VPNv4 peer
group.
9.12.3 Configuring BGP GR
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 834
Context
After the graceful-restart command is configured to enable GR for the switch, to
prevent traffic interruption, another GR-capable device can assist the switch to
perform GR when BGP on the switch restarts due to an active/standby switchover,
and the switch can assist other GR-capable devices to perform GR when BGP on
other devices restarts.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run graceful-restart
BGP GR is enabled.
By default, BGP GR is disabled.
Step 4 (Optional) Run graceful-restart timer wait-for-rib
timer
The time during which the restarting speaker and receiving speaker wait for End-
of-RIB messages is set.
By default, the time for waiting for End-of-RIB messages is 600 seconds.
Step 5 (Optional) Run graceful-restart peer-reset
The device is enabled to reset a BGP session in GR mode.
By default, a device is disabled from resetting a BGP connection in GR mode.
----End
Verifying the Configuration
● Run the display bgp peer verbose command to check detailed information
about BGP GR.
9.13 Configuring BGP Route Summarization
Pre-configuration Tasks
Before configuring BGP route summarization, configure basic BGP functions.
Procedure
● Configure automatic route summarization.
a. Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 835
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
d. Run summary automatic
BGP summarizes subnet routes based on natural mask.
NOTE
The command summarizes the routes imported by BGP. These routes can be direct
routes, static routes, RIP routes, OSPF routes, or IS-IS routes. The command, however,
is invalid for the routes imported using the network command.
● Configure manual route summarization.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform any of the following operations to configure manual route
summarization.
▪ To advertise the summarized routes and specific routes, run the
aggregate
ipv4-address {
mask |
mask-length } command.
▪ To advertise only the summarized routes, run the aggregate
ipv4-
address {
mask |
mask-length } detail-suppressed or the aggregate
ipv6-address prefix-length detail-suppressed command.
▪ To advertise the summarized routes and specific routes that meet the
specified route-policy, run the aggregate
ipv4-address {
mask |
mask-length } suppress-policy
route-policy-name or the aggregate
ipv6-address prefix-length suppress-policy
route-policy-name
command.
▪ To advertise the summarized routes of which the AS_Set attribute
helps detect routing loops, run the aggregate
ipv4-address {
mask |
mask-length } as-set or the aggregate
ipv6-address prefix-length as-
set command.
▪ To set attributes for the summarized routes, run the aggregate
ipv4-
address {
mask |
mask-length } attribute-policy
route-policy-name
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 836
or the aggregate
ipv6-address prefix-length attribute-policy
route-
policy-name command.
▪ To summarize the specific routes that meet the specified route-policy,
run the aggregate
ipv4-address {
mask |
mask-length } origin-policy
route-policy-name or the aggregate
ipv6-address prefix-length
origin-policy
route-policy-name command.
NOTE
Manual route summarization is valid for the routes in the local BGP routing table. For
example, if the local BGP routing table does not contain routes with mask longer than
16 bits, such as 10.1.1.1/24, BGP will not generate an aggregated route for it even if
the aggregate 10.1.1.1 16 command is used.
----End
Verifying the Configuration
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check information about summarized
routes.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check the
MBGP routing table.
9.14 Configuring BGP to Advertise Default Routes to
Peers
Pre-configuration Tasks
Before configuring BGP to send default routes to peers, configure basic BGP
functions.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run peer {
group-name |
ipv4-address |
ipv6-address } default-route-advertise
[ route-policy
route-policy-name ] [ conditional-route-match-all {
ipv4-address1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 837
{
mask1 |
mask-length1 } } &<1-4> | conditional-route-match-any {
ipv4-
address2 {
mask2 |
mask-length2 } } &<1-4> ]
Or run peer {
group-name |
ipv4-address |
ipv6-address } default-route-advertise
[ route-policy
route-policy-name ] [ conditional-route-match-all {
ipv6-address1
prefix-length1 } &<1-4> | conditional-route-match-any {
ipv6-address2 prefix-
length2 } &<1-4> ]
A BGP device is configured to send default routes to a peer or peer group.
----End
Verifying the Configuration
● Run the display bgp routing-table [
ipv4-address [
mask |
mask-length
[ longer-prefixes ] ] ] command to check received BGP default routes.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check received
MBGP default routes.
9.15 Configuring MP-BGP
Pre-configuration Tasks
Before configuring MP-BGP, 9.6.1 Starting a BGP Process.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
BGP is started, the local AS number is specified, and the BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family unicast
The BGP-IPv4 unicast address family view is displayed.
● Run ipv4-family vpnv4
The BGP-VPNv4 address family view is displayed.
● Run ipv4-family vpn-instance
vpn-instance-name
The BGP-VPN instance IPv4 address family view is displayed.
● Run ipv4-family multicast
The BGP-IPv4 multicast address family view is displayed.
● Run ipv6-family unicast
The BGP-IPv6 unicast address family view is displayed.
● Run ipv6-family vpnv6
The BGP-VPNv6 address family view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 838
● Run ipv6-family vpn-instance
vpn-instance-name
The BGP-VPN instance IPv6 address family view is displayed.
NOTE
● Only the S5731-H, S5731S-H, S5732-H, S6735-S, S6730S-H, and S6730-H support BGP-
VPNv4 address family view and BGP-VPNv6 address family view.
● Different extended BGP functions must be configured in their respective address family
views, while common BGP functions are configured in the BGP view.
● The Switch supports the following MBGP features: basic BGP functions, BGP security
(MD5 authentication and keychain authentication), simplifying IBGP network
connections (route reflector and confederation), BGP route selection and load balancing,
controlling the receiving and advertisement of BGP routes, adjusting the BGP network
convergence speed, BGP reliability, BGP route summarization, and advertising default
routes to peers.
● Some BGP4+ functions can be configured in the BGP view, and some BGP4+ functions
need to be configured in the IPv6 unicast address family view. For example, the
following BGP4+ functions need to be configured in the IPv6 unicast address family
view: load balancing, manual route summarization, route dampening, community, and
route reflector.
----End
9.16 Maintaining BGP
9.16.1 Configuring Alarm and Clear Alarm Thresholds for the
Number of BGP Routes
Context
There are a limited number of BGP routes that can be added to a routing table. If
the limit is reached, new routes cannot be added, which may interrupt services. To
address this problem, configure alarm and clear alarm thresholds for the number
of BGP routes as required. With the alarm and clear alarm thresholds, alarms are
generated and cleared as expected. The alarms prompt you to check whether an
exception occurs and to take preventive measures.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run routing-table limit threshold-alarm upper-limit
upper-limit-value lower-
limit
lower-limit-value
Alarm and clear alarm thresholds are configured for the number of BGP routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 839
●
upper-limit-value specifies the alarm threshold. If the ratio of BGP routes to
the maximum number that is allowed exceeds the alarm threshold, an alarm
is generated.
●
lower-limit-value specifies the clear alarm threshold. If the ratio of BGP routes
to the maximum number that is allowed falls below this threshold, the alarm
is cleared.
●
upper-limit-value must be greater than
lower-limit-value; otherwise, alarms
are generated and cleared repeatedly if route flapping occurs.
By default,
upper-limit-value is 80%, and
lower-limit-value is 70%.
----End
9.16.2 Resetting BGP Connections
Context
NOTICE
Running the reset bgp command to reset BGP connections will interrupt BGP peer
relationships between BGP devices. Exercise caution when you use this command.
When the BGP routing policy changes, for example, the switch does not support
the route-refresh capability, reset BGP connections to make the modification take
effect.
Procedure
● To reset all BGP connections, run the reset bgp all command in the user view.
● To reset the BGP connection with a specified AS, run the reset bgp {
as-
number-plain |
as-number-dot } command in the user view.
● To reset the BGP connection with a specified peer, run the reset bgp
ipv4-
address command in the user view.
● To reset all EBGP connections, run the reset bgp external command in the
user view.
● To reset the BGP connection with a specified peer group, run the reset bgp
group
group-name command in the user view.
● To reset all IBGP connections, run the reset bgp internal command in the
user view.
● To reset the MBGP connection with a specified peer, run the reset bgp
multicast
peer-address command in the user view.
● To reset all MBGP connections, run the reset bgp multicast all command in
the user view.
● To reset the MBGP connection with all the peers in a specified peer group, run
the reset bgp multicast group
group-name command in the user view.
● To reset all external connections, run the reset bgp multicast external
command in the user view.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 840
● To reset all internal connections, run the reset bgp multicast internal
command in the user view.
----End
9.16.3 Clearing BGP Statistics
Context
NOTICE
BGP statistics cannot be restored after being cleared. Exercise caution when you
clear BGP statistics.
Procedure
● To clear route flapping statistics, run the reset bgp flap-info [ regexp
as-
path-regexp | as-path-filter
as-path-filter-number |
ipv4-address [
mask |
mask-length ] ] command in the user view.
● To clear route flapping statistics on a specified peer, run the reset bgp
ipv4-
address flap-info command in the user view.
● To clear route dampening statistics and release suppressed routes, run the
reset bgp dampening [
ipv4-address [
mask |
mask-length ] ] command in
the user view.
● To clear MBGP route dampening statistics, run the reset bgp multicast
dampening [
ip-address [
mask |
mask-length ] ] command in the user view.
● To clear MBGP route flapping statistics, run the reset bgp multicast flap-info
[
ip-address [
mask |
mask-length ] | as-path-filter {
as-path-list-number |
as-
path-list-name } | regexp
regexp ] command in the user view.
----End
9.17 Configuration Examples for BGP
9.17.1 Example for Configuring Basic BGP Functions
Networking Requirements
As shown in Figure 9-43, BGP runs between Switches; an EBGP connection is
established between SwitchA and SwitchB; IBGP full-mesh connections are
established between SwitchB, SwitchC, and SwitchD.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 841
Figure 9-43 Networking diagram of configuring basic BGP functions
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IBGP connections between SwitchB, SwitchC, and SwitchD.
2. Configure an EBGP connection between SwitchA and SwitchB.
Procedure
Step 1 Create VLANs and add interfaces to the corresponding VLANs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 50
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 50
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.2 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 50
[SwitchA-Vlanif50] ip address 10.1.1.1 16
[SwitchA-Vlanif50] quit
Step 3 Configure IBGP connections.
# Configure SwitchB.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 842
[SwitchB] bgp 65009
[SwitchB-bgp] router-id 172.17.2.2
[SwitchB-bgp] peer 172.16.1.2 as-number 65009
[SwitchB-bgp] peer 172.16.3.2 as-number 65009
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 65009
[SwitchC-bgp] router-id 172.17.3.3
[SwitchC-bgp] peer 172.16.3.1 as-number 65009
[SwitchC-bgp] peer 172.16.2.2 as-number 65009
[SwitchC-bgp] quit
# Configure SwitchD.
[SwitchD] bgp 65009
[SwitchD-bgp] router-id 172.17.4.4
[SwitchD-bgp] peer 172.16.1.1 as-number 65009
[SwitchD-bgp] peer 172.16.2.1 as-number 65009
[SwitchD-bgp] quit
Step 4 Configure EBGP connections.
# Configure SwitchA.
[SwitchA] bgp 65008
[SwitchA-bgp] router-id 172.17.1.1
[SwitchA-bgp] peer 192.168.1.1 as-number 65009
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] peer 192.168.1.2 as-number 65008
[SwitchB-bgp] quit
# Check the status of BGP connections.
[SwitchB] display bgp peer
BGP local router ID : 172.17.2.2
Local AS number : 65009
Total number of peers : 3 Peers in established state : 3
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
172.16.1.2 4 65009 49 62 0 00:44:58 Established 0
172.16.3.2 4 65009 56 56 0 00:40:54 Established 0
192.168.1.2 4 65008 49 65 0 00:44:03 Established 0
You can view that the BGP connections between SwitchB and all the other
Switches are set up.
Step 5 Configure SwitchA to advertise route 10.1.0.0/16.
# Configure SwitchA to advertise routes.
[SwitchA] bgp 65008
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] network 10.1.0.0 255.255.0.0
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.17.1.1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 843
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.0.0/16 0.0.0.0 0 0 i
# Check the routing table of SwitchB.
[SwitchB] display bgp routing-table
BGP Local router ID is 172.17.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.0.0/16 192.168.1.2 0 0 65008i
# Check the routing table of SwitchC.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.17.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
i 10.1.0.0/16 192.168.1.2 0 100 0 65008i
According to the routing table, you can view that SwitchC has learned the route to
the destination 10.1.0.0 in AS 65008, but the next hop 192.168.1.2 is unreachable.
Therefore, this route is invalid.
Step 6 Configure BGP to import direct routes.
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] import-route direct
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Check the BGP routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.17.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.0.0/16 0.0.0.0 0 0 i
*> 172.16.1.0/24 192.168.1.1 0 0 65009?
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 844
*> 172.16.3.0/24 192.168.1.1 0 0 65009?
192.168.1.0 192.168.1.1 0 0 65009?
# Check the routing table of SwitchC.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.17.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.0.0/16 192.168.1.2 0 100 0 65008i
*>i 172.16.1.0/24 172.16.3.1 0 100 0 ?
i 172.16.3.0/24 172.16.3.1 0 100 0 ?
*>i 192.168.1.0 172.16.3.1 0 100 0 ?
You can view that the route destined for 10.1.0.0 becomes valid, and the next hop
is the address of SwitchA.
# Perform the ping operation to verify the configuration.
[SwitchC] ping 10.1.1.1
PING 10.1.1.1: 56 data bytes, press CTRL_C to break
Reply from 10.1.1.1: bytes=56 Sequence=1 ttl=255 time=31 ms
Reply from 10.1.1.1: bytes=56 Sequence=2 ttl=255 time=47 ms
Reply from 10.1.1.1: bytes=56 Sequence=3 ttl=255 time=31 ms
Reply from 10.1.1.1: bytes=56 Sequence=4 ttl=255 time=16 ms
Reply from 10.1.1.1: bytes=56 Sequence=5 ttl=255 time=31 ms
--- 10.1.1.1 ping statistics ---
5 packet(s) transmitted
5 packet(s) received
0.00% packet loss
round-trip min/avg/max = 16/31/47 ms
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 50
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif50
ip address 10.1.1.1 255.255.0.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 65008
router-id 172.17.1.1
peer 192.168.1.1 as-number 65009
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 845
ipv4-family unicast
undo synchronization
network 10.1.0.0 255.255.0.0
peer 192.168.1.1 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20 30
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface Vlanif20
ip address 172.16.3.1 255.255.255.0
#
interface Vlanif30
ip address 172.16.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65009
router-id 172.17.2.2
peer 172.16.1.2 as-number 65009
peer 172.16.3.2 as-number 65009
peer 192.168.1.2 as-number 65008
#
ipv4-family unicast
undo synchronization
import-route direct
peer 172.16.1.2 enable
peer 172.16.3.2 enable
peer 192.168.1.2 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 40
#
interface Vlanif20
ip address 172.16.3.2 255.255.255.0
#
interface Vlanif40
ip address 172.16.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
bgp 65009
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 846
router-id 172.17.3.3
peer 172.16.2.2 as-number 65009
peer 172.16.3.1 as-number 65009
#
ipv4-family unicast
undo synchronization
peer 172.16.2.2 enable
peer 172.16.3.1 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30 40
#
interface Vlanif30
ip address 172.16.1.2 255.255.255.0
#
interface Vlanif40
ip address 172.16.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
bgp 65009
router-id 172.17.4.4
peer 172.16.1.1 as-number 65009
peer 172.16.2.1 as-number 65009
#
ipv4-family unicast
undo synchronization
peer 172.16.1.1 enable
peer 172.16.2.1 enable
#
return
9.17.2 Example for Configuring Basic BGP4+ Functions
Networking Requirements
As shown in Figure 9-44, there are two ASs: 65008 and 65009. SwitchA belongs to
AS 65008, and SwitchB, SwitchC, and SwitchD belong to AS 65009. BGP4+ is
required to exchange the routing information between the two ASs.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 847
Figure 9-44 Networking diagram of configuring basic BGP4+ functions
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IBGP connections between SwitchB, SwitchC, and SwitchD.
2. Configure an EBGP connection between SwitchA and SwitchB.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Enable the IPv6 forwarding capability, and assign an IPv6 address for each
interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] ipv6
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ipv6 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 848
[SwitchA-Vlanif10] ipv6 address fc00:0:0:8::1/64
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ipv6 enable
[SwitchA-Vlanif20] ipv6 address fc00:0:0:100::2/64
[SwitchA-Vlanif20] quit
Step 3 Configure IBGP.
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer fc00:0:0:91::2 as-number 65009
[SwitchB-bgp] peer fc00:0:0:93::2 as-number 65009
[SwitchB-bgp] ipv6-family unicast
[SwitchB-bgp-af-ipv6] peer fc00:0:0:91::2 enable
[SwitchB-bgp-af-ipv6] peer fc00:0:0:93::2 enable
[SwitchB-bgp-af-ipv6] network fc00:0:0:91:: 64
[SwitchB-bgp-af-ipv6] network fc00:0:0:93:: 64
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 65009
[SwitchC-bgp] router-id 10.3.3.3
[SwitchC-bgp] peer fc00:0:0:93::1 as-number 65009
[SwitchC-bgp] peer fc00:0:0:92::2 as-number 65009
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer fc00:0:0:93::1 enable
[SwitchC-bgp-af-ipv6] peer fc00:0:0:92::2 enable
[SwitchC-bgp-af-ipv6] network fc00:0:0:93:: 64
[SwitchC-bgp-af-ipv6] network fc00:0:0:92:: 64
[SwitchC-bgp-af-ipv6] quit
[SwitchC-bgp] quit
# Configure SwitchD.
[SwitchD] bgp 65009
[SwitchD-bgp] router-id 10.4.4.4
[SwitchD-bgp] peer fc00:0:0:91::1 as-number 65009
[SwitchD-bgp] peer fc00:0:0:92::1 as-number 65009
[SwitchD-bgp] ipv6-family unicast
[SwitchD-bgp-af-ipv6] peer fc00:0:0:91::1 enable
[SwitchD-bgp-af-ipv6] peer fc00:0:0:92::1 enable
[SwitchD-bgp-af-ipv6] network fc00:0:0:92:: 64
[SwitchD-bgp-af-ipv6] network fc00:0:0:91:: 64
[SwitchD-bgp-af-ipv6] quit
[SwitchD-bgp] quit
Step 4 Configure an EBGP connection.
# Configure SwitchA.
[SwitchA] bgp 65008
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer fc00:0:0:100::1 as-number 65009
[SwitchA-bgp] ipv6-family unicast
[SwitchA-bgp-af-ipv6] peer fc00:0:0:100::1 enable
[SwitchA-bgp-af-ipv6] network fc00:0:0:100:: 64
[SwitchA-bgp-af-ipv6] network fc00:0:0:8:: 64
[SwitchA-bgp-af-ipv6] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] peer fc00:0:0:100::2 as-number 65008
[SwitchB-bgp] ipv6-family unicast
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 849
[SwitchB-bgp-af-ipv6] peer fc00:0:0:100::2 enable
[SwitchB-bgp-af-ipv6] network fc00:0:0:100:: 64
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# View the status of the BGP4+ peers.
[SwitchB] display bgp ipv6 peer
BGP local router ID : 10.2.2.2
Local AS number : 65009
Total number of peers : 3 Peers in established state : 3
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
FC00:0:0:91::2 4 65009 8 9 0 00:05:37 Established 2
FC00:0:0:93::2 4 65009 2 2 0 00:00:09 Established 2
FC00:0:0:100::2 4 65008 9 7 0 00:05:38 Established 1
The preceding information shows that the BGP4+ connections between SwitchB
and other Switches are set up.
# Display the routing table of SwitchA.
[SwitchA] display bgp ipv6 routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
*> Network : FC00:0:0:91:: PrefixLen : 64
NextHop : FC00:0:0:100::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 65009 i
*> Network : FC00:0:0:92:: PrefixLen : 64
NextHop : FC00:0:0:100::1 LocPrf :
MED : PrefVal : 0
Label :
Path/Ogn : 65009 i
*> Network : FC00:0:0:93:: PrefixLen : 64
NextHop : FC00:0:0:100::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 65009 i
*> Network : FC00:0:0:100:: PrefixLen : 64
NextHop : :: LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
NextHop : FC00:0:0:100::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 65009 i
The routing table shows that SwitchA has learned the route from AS 65009. AS
65008 and AS 65009 can exchange their routing information.
----End
Configuration Files
● SwitchA configuration file
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 850
#
sysname SwitchA
#
ipv6
#
vlan batch 10 20
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:8::1/64
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:100::2/64
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 65008
router-id 10.1.1.1
peer FC00:0:0:100::1 as-number 65009
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:8:: 64
network FC00:0:0:100:: 64
peer FC00:0:0:100::1 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
vlan batch 20 30 40
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:100::1/64
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:93::1/64
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:91::1/64
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 851
bgp 65009
router-id 10.2.2.2
peer FC00:0:0:91::2 as-number 65009
peer FC00:0:0:93::2 as-number 65009
peer FC00:0:0:100::2 as-number 65008
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:91:: 64
network FC00:0:0:93:: 64
network FC00:0:0:100:: 64
peer FC00:0:0:91::2 enable
peer FC00:0:0:93::2 enable
peer FC00:0:0:100::2 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 30 50
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:93::2/64
#
interface Vlanif50
ipv6 enable
ipv6 address FC00:0:0:92::1/64
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65009
router-id 10.3.3.3
peer FC00:0:0:92::2 as-number 65009
peer FC00:0:0:93::1 as-number 65009
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:92:: 64
network FC00:0:0:93:: 64
peer FC00:0:0:92::2 enable
peer FC00:0:0:93::1 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
ipv6
#
vlan batch 40 50
#
interface Vlanif40
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 852
ipv6 enable
ipv6 address FC00:0:0:91::2/64
#
interface Vlanif50
ipv6 enable
ipv6 address FC00:0:0:92::2/64
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 65009
router-id 10.4.4.4
peer FC00:0:0:91::1 as-number 65009
peer FC00:0:0:92::1 as-number 65009
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:91:: 64
network FC00:0:0:92:: 64
peer FC00:0:0:91::1 enable
peer FC00:0:0:92::1 enable
#
return
9.17.3 Example for Configuring Basic MBGP Functions
Networking Requirements
As shown in Figure 9-45, the receiver receives VoD information in multicast mode.
The receiver and the source reside in different ASs. Multicast routing information
needs to be transmitted between ASs.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 853
Figure 9-45 Networking diagram of MBGP configuration
Data Plan
Table 9-31 IP addresses of interconnected interfaces
Link
Name
(Local
End-
Remote
End)
Local Interface and IP Address Remote Interface and IP
Address
SwitchA-
SwitchB
GE0/0/1
VLANIF100: 192.168.1.1/24
GE0/0/1
VLANIF100: 192.168.1.2/24
SwitchA-
Source
GE0/0/2
VLANIF101: 10.10.10.1/24
-
SwitchB-
SwitchD
GE0/0/2
VLANIF200: 192.168.4.2/24
GE0/0/2
VLANIF200: 192.168.4.1/24
SwitchB-
SwitchC
GE0/0/3
VLANIF300: 192.168.3.2/24
GE0/0/3
VLANIF300: 192.168.3.1/24
SwitchC-
SwitchD
GE0/0/1
VLANIF400: 192.168.5.1/24
GE0/0/1
VLANIF400: 192.168.5.2/24
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 854
Link
Name
(Local
End-
Remote
End)
Local Interface and IP Address Remote Interface and IP
Address
SwitchC-
Receiver
GE0/0/2
VLANIF102: 10.22.22.1/24
-
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure MBGP peers for inter-AS multicast transmission.
2. Configure the routes advertised by MBGP.
3. Enable the multicast function on each switch.
4. Configure basic PIM-SM functions on each switch in ASs and enable IGMP on
receiver-side interfaces.
5. Configure a BSR boundary on the interfaces that connect to two ASs.
6. Configure MSDP peers to transmit inter-domain multicast source information.
Procedure
Step 1 Configure IP addresses for interfaces on each Switch and the OSPF protocol in the
ASs.
# Configure IP addresses and masks for the interfaces on each switch according to
Figure 9-45 and configure OSPF on the switches in ASs. Ensure that SwitchB,
SwitchC, and SwitchD in AS 200 can communicate with the receiver at the
network layer, learn routes to the loopback interfaces of each other, and
dynamically update routes using a unicast routing protocol. Configure OSPF
process 1. The configuration procedure is not mentioned here.
Step 2 Configure BGP, enable the MBGP protocol, and configure the MBGP peers.
# Configure BGP and the MBGP peer on SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] peer 192.168.1.2 as-number 200
[SwitchA-bgp] ipv4-family multicast
[SwitchA-bgp-af-multicast] peer 192.168.1.2 enable
[SwitchA-bgp-af-multicast] quit
[SwitchA-bgp] quit
# Configure BGP and the MBGP peer on SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] peer 192.168.1.1 as-number 100
[SwitchB-bgp] peer 192.168.3.1 as-number 200
[SwitchB-bgp] peer 192.168.4.1 as-number 200
[SwitchB-bgp] ipv4-family multicast
[SwitchB-bgp-af-multicast] peer 192.168.1.1 enable
[SwitchB-bgp-af-multicast] peer 192.168.3.1 enable
[SwitchB-bgp-af-multicast] peer 192.168.4.1 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 855
[SwitchB-bgp-af-multicast] quit
[SwitchB-bgp] quit
# Configure BGP and the MBGP peer on SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] peer 192.168.3.2 as-number 200
[SwitchC-bgp] peer 192.168.5.2 as-number 200
[SwitchC-bgp] ipv4-family multicast
[SwitchC-bgp-af-multicast] peer 192.168.3.2 enable
[SwitchC-bgp-af-multicast] peer 192.168.5.2 enable
[SwitchC-bgp-af-multicast] quit
[SwitchC-bgp] quit
# Configure BGP and the MBGP peer on SwitchD.
[SwitchD] bgp 200
[SwitchD-bgp] peer 192.168.4.2 as-number 200
[SwitchD-bgp] peer 192.168.5.1 as-number 200
[SwitchD-bgp] ipv4-family multicast
[SwitchD-bgp-af-multicast] peer 192.168.4.2 enable
[SwitchD-bgp-af-multicast] peer 192.168.5.1 enable
[SwitchD-bgp-af-multicast] quit
[SwitchD-bgp] quit
Step 3 Configure the routes to be advertised.
# Configure the routes to be advertised on SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] import-route direct
[SwitchA-bgp] ipv4-family multicast
[SwitchA-bgp-af-multicast] import-route direct
[SwitchA-bgp-af-multicast] quit
[SwitchA-bgp] quit
# Configure the routes to be advertised on SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] import-route direct
[SwitchB-bgp] import-route ospf 1
[SwitchB-bgp] ipv4-family multicast
[SwitchB-bgp-af-multicast] import-route direct
[SwitchB-bgp-af-multicast] import-route ospf 1
[SwitchB-bgp-af-multicast] quit
[SwitchB-bgp] quit
Step 4 Enable multicast on each Switch and the interfaces that are connected.
# Configure SwitchA.
[SwitchA] multicast routing-enable
[SwitchA] interface vlanif 100
[SwitchA-Vlanif100] pim sm
[SwitchA-Vlanif100] quit
[SwitchA] interface vlanif 101
[SwitchA-Vlanif101] pim sm
[SwitchA-Vlanif101] quit
# Configure SwitchB.
[SwitchB] multicast routing-enable
[SwitchB] interface vlanif 100
[SwitchB-Vlanif100] pim sm
[SwitchB-Vlanif100] quit
[SwitchB] interface vlanif 200
[SwitchB-Vlanif200] pim sm
[SwitchB-Vlanif200] quit
[SwitchB] interface vlanif 300
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 856
[SwitchB-Vlanif300] pim sm
[SwitchB-Vlanif300] quit
# Configure SwitchC.
[SwitchC] multicast routing-enable
[SwitchC] interface vlanif 400
[SwitchC-Vlanif400] pim sm
[SwitchC-Vlanif400] quit
[SwitchC] interface vlanif 102
[SwitchC-Vlanif102] pim sm
[SwitchC-Vlanif102] igmp enable
[SwitchC-Vlanif102] quit
[SwitchC] interface vlanif 300
[SwitchC-Vlanif300] pim sm
[SwitchC-Vlanif300] quit
# Configure SwitchD.
[SwitchD] multicast routing-enable
[SwitchD] interface vlanif 400
[SwitchD-Vlanif400] pim sm
[SwitchD-Vlanif400] quit
[SwitchD] interface vlanif 200
[SwitchD-Vlanif200] pim sm
[SwitchD-Vlanif200] quit
Step 5 Configure BSR and RP within each AS.
# Configure SwitchA.
[SwitchA] interface LoopBack 0
[SwitchA-LoopBack0] ip address 10.1.1.1 255.255.255.255
[SwitchA-LoopBack0] pim sm
[SwitchA-LoopBack0] quit
[SwitchA] pim
[SwitchA-pim] c-bsr LoopBack 0
[SwitchA-pim] c-rp LoopBack 0
[SwitchA-pim] quit
# Configure SwitchB.
[SwitchB] interface LoopBack 0
[SwitchB-LoopBack0] ip address 10.2.2.2 255.255.255.255
[SwitchB-LoopBack0] pim sm
[SwitchB-LoopBack0] quit
[SwitchB] pim
[SwitchB-pim] c-bsr LoopBack 0
[SwitchB-pim] c-rp LoopBack 0
[SwitchB-pim] quit
Step 6 Configure the BSR boundary on the interfaces connecting two ASs.
# Configure SwitchA.
[SwitchA] interface vlanif 100
[SwitchA-Vlanif100] pim bsr-boundary
[SwitchA-Vlanif100] quit
# Configure SwitchB.
[SwitchB] interface vlanif 100
[SwitchB-Vlanif100] pim bsr-boundary
[SwitchB-Vlanif100] quit
Step 7 Configure MSDP peers.
# Configure SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 857
[SwitchA] msdp
[SwitchA-msdp] peer 192.168.1.2 connect-interface Vlanif100
[SwitchA-msdp] quit
# Configure SwitchB.
[SwitchB] msdp
[SwitchB-msdp] peer 192.168.1.1 connect-interface Vlanif100
[SwitchB-msdp] quit
Step 8 Verify the configuration.
# Run the display bgp multicast peer command to view the MBGP peer
relationship between switches. For example, the following information shows the
MBGP peer relationship on SwitchA:
[SwitchA] display bgp multicast peer
BGP local router ID : 10.1.1.1
Local AS number : 100
Total number of peers : 1 Peers in established state : 1
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
192.168.1.2 4 200 82 75 0 00:30:29 Established 17
# Run the display msdp brief command to view information about the MSDP
peer relationship between switches. For example, the following information shows
the MSDP peer relationship on SwitchB:
[SwitchB] display msdp brief
MSDP Peer Brief Information
Configured Up Listen Connect Shutdown Down
1 1 0 0 0 0
Peer's Address State Up/Down time AS SA Count Reset Count
192.168.1.1 Up 00:07:17 100 1 0
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 100 to 101
#
multicast routing-enable
#
interface Vlanif100
ip address 192.168.1.1 255.255.255.0
pim bsr-boundary
pim sm
#
interface Vlanif101
ip address 10.10.10.1 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 100
#
interface GigabitEthernet0/0/2
port link-type access
port default vlan 101
#
interface LoopBack0
ip address 10.1.1.1 255.255.255.255
pim sm
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 858
#
pim
c-bsr LoopBack0
c-rp LoopBack0
#
bgp 100
peer 192.168.1.2 as-number 200
#
ipv4-family unicast
undo synchronization
import-route direct
peer 192.168.1.2 enable
#
ipv4-family multicast
undo synchronization
peer 192.168.1.2 enable
#
msdp
peer 192.168.1.2 connect-interface Vlanif100
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 100 200 300
#
multicast routing-enable
#
interface Vlanif100
ip address 192.168.1.2 255.255.255.0
pim bsr-boundary
pim sm
#
interface Vlanif200
ip address 192.168.4.2 255.255.255.0
pim sm
#
interface Vlanif300
ip address 192.168.3.2 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 100
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 200
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 300
#
interface LoopBack0
ip address 10.2.2.2 255.255.255.255
pim sm
#
pim
c-bsr LoopBack0
c-rp LoopBack0
#
ospf 1
area 0.0.0.0
network 10.2.2.2 0.0.0.0
network 192.168.3.0 0.0.0.255
network 192.168.4.0 0.0.0.255
#
bgp 200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 859
peer 192.168.1.1 as-number 100
peer 192.168.3.1 as-number 200
peer 192.168.4.1 as-number 200
#
ipv4-family unicast
undo synchronization
import-route direct
import-route ospf 1
peer 192.168.1.1 enable
peer 192.168.3.1 enable
peer 192.168.4.1 enable
#
ipv4-family multicast
undo synchronization
import-route direct
import-route ospf 1
peer 192.168.1.1 enable
peer 192.168.3.1 enable
peer 192.168.4.1 enable
#
msdp
peer 192.168.1.1 connect-interface Vlanif100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 102 300 400
#
multicast routing-enable
#
interface Vlanif102
ip address 10.22.22.1 255.255.255.0
pim sm
igmp enable
#
interface Vlanif300
ip address 192.168.3.1 255.255.255.0
pim sm
#
interface Vlanif400
ip address 192.168.5.1 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 400
#
interface GigabitEthernet0/0/2
port link-type access
port default vlan 102
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 300
#
interface LoopBack0
ip address 10.3.3.3 255.255.255.255
#
ospf 1
area 0.0.0.0
network 10.3.3.3 0.0.0.0
network 10.22.22.0 0.0.0.255
network 192.168.3.0 0.0.0.255
network 192.168.5.0 0.0.0.255
#
bgp 200
peer 192.168.3.2 as-number 200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 860
peer 192.168.5.2 as-number 200
#
ipv4-family unicast
undo synchronization
peer 192.168.3.2 enable
peer 192.168.5.2 enable
#
ipv4-family multicast
undo synchronization
peer 192.168.3.2 enable
peer 192.168.5.2 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 200 400
#
multicast routing-enable
#
interface Vlanif200
ip address 192.168.4.1 255.255.255.0
pim sm
#
interface Vlanif400
ip address 192.168.5.2 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 400
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 200
#
interface LoopBack0
ip address 10.4.4.4 255.255.255.255
#
ospf 1
area 0.0.0.0
network 10.4.4.4 0.0.0.0
network 192.168.4.0 0.0.0.255
network 192.168.5.0 0.0.0.255
#
bgp 200
peer 192.168.4.2 as-number 200
peer 192.168.5.1 as-number 200
#
ipv4-family unicast
undo synchronization
peer 192.168.4.2 enable
peer 192.168.5.1 enable
#
ipv4-family multicast
undo synchronization
peer 192.168.4.2 enable
peer 192.168.5.1 enable
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 861
9.17.4 Example for Configuring BGP to Interact with an IGP
Networking Requirements
The network shown in Figure 9-46 is divided into AS 65008 and AS 65009. In AS
65009, an IGP is used to calculate routes. In this example, OSPF is used as an IGP.
The two ASs need to communicate with each other.
Figure 9-46 Networking diagram of configuring BGP to interact with an IGP
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure OSPF on SwitchB and SwitchC so that these devices can access each
other.
2. Establish an EBGP connection between SwitchA and SwitchB so that these
devices can exchange routing information.
3. Configure BGP and OSPF to import routes from each other on SwitchB so that
the two ASs can communicate with each other.
4. (Optional) Configure BGP route summarization on SwitchB to simplify the
BGP routing table.
Procedure
Step 1 Create VLANs and add interfaces to the corresponding VLANs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 30
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 30
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 862
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.3.1.2 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 30
[SwitchA-Vlanif30] ip address 10.8.1.1 24
[SwitchA-Vlanif30] quit
Step 3 Configure OSPF.
# Configure SwitchB.
[SwitchB] ospf 1
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 10.9.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
# Configure SwitchC.
[SwitchC] ospf 1
[SwitchC-ospf-1] area 0
[SwitchC-ospf-1-area-0.0.0.0] network 10.9.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] network 10.9.2.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] quit
[SwitchC-ospf-1] quit
Step 4 Configure an EBGP connection.
# Configure SwitchA.
[SwitchA] bgp 65008
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer 10.3.1.1 as-number 65009
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] network 10.8.1.0 255.255.255.0
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer 10.3.1.2 as-number 65008
Step 5 Configure BGP to interact with an IGP.
# On SwitchB, configure BGP to import OSPF routes.
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] import-route ospf 1
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 863
*> 10.8.1.0/24 0.0.0.0 0 0 i
*> 10.9.1.0/24 10.3.1.1 0 0 65009?
*> 10.9.2.0/24 10.3.1.1 2 0 65009?
# On SwitchB, configure OSPF to import BGP routes.
[SwitchB] ospf
[SwitchB-ospf-1] import-route bgp
[SwitchB-ospf-1] quit
# Check the routing table of SwitchC.
[SwitchC] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 7 Routes : 7
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.8.1.0/24 O_ASE 150 1 D 10.9.1.1 Vlanif20
10.9.1.0/24 Direct 0 0 D 10.9.1.2 Vlanif20
10.9.1.2/32 Direct 0 0 D 127.0.0.1 Vlanif20
10.9.2.0/24 Direct 0 0 D 10.9.2.1 Vlanif40
10.9.2.1/32 Direct 0 0 D 127.0.0.1 Vlanif40
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
Step 6 Configure automatic summarization.
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] summary automatic
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Check the BGP routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.0.0 10.3.1.1 0 65009?
*> 10.8.1.0/24 0.0.0.0 0 0 i
# Perform the ping operation to verify the configuration.
[SwitchA] ping -a 10.8.1.1 10.9.2.1
PING 10.9.2.1: 56 data bytes, press CTRL_C to break
Reply from 10.9.2.1: bytes=56 Sequence=1 ttl=253 time=15 ms
Reply from 10.9.2.1: bytes=56 Sequence=2 ttl=253 time=31 ms
Reply from 10.9.2.1: bytes=56 Sequence=3 ttl=253 time=47 ms
Reply from 10.9.2.1: bytes=56 Sequence=4 ttl=253 time=46 ms
Reply from 10.9.2.1: bytes=56 Sequence=5 ttl=253 time=47 ms
--- 10.9.2.1 ping statistics ---
5 packet(s) transmitted
5 packet(s) received
0.00% packet loss
round-trip min/avg/max = 15/37/47 ms
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 864
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 30
#
interface Vlanif10
ip address 10.3.1.2 255.255.255.0
#
interface Vlanif30
ip address 10.8.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65008
router-id 10.1.1.1
peer 10.3.1.1 as-number 65009
#
ipv4-family unicast
undo synchronization
network 10.8.1.0 255.255.255.0
peer 10.3.1.1 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.3.1.1 255.255.255.0
#
interface Vlanif20
ip address 10.9.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 65009
router-id 10.2.2.2
peer 10.3.1.2 as-number 65008
#
ipv4-family unicast
undo synchronization
summary automatic
import-route ospf 1
peer 10.3.1.2 enable
#
ospf 1
import-route bgp
area 0.0.0.0
network 10.9.1.0 0.0.0.255
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 865
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 40
#
interface Vlanif20
ip address 10.9.1.2 255.255.255.0
#
interface Vlanif40
ip address 10.9.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
ospf 1
area 0.0.0.0
network 10.9.1.0 0.0.0.255
network 10.9.2.0 0.0.0.255
#
return
9.17.5 Example for Configuring AS_Path Filter
Networking Requirements
On the network shown in Figure 9-47, SwitchB establish EBGP connections with
SwitchA and SwitchC. The user wants to disable the devices in AS 10 from
communicating with devices in AS 30.
Figure 9-47 Networking diagram of configuring the AS_Path filter
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 866
Configuration Roadmap
The configuration roadmap is as follows:
1. Establish EBGP connections between SwitchA and SwitchB and between
SwitchB and SwitchC and configure these devices to import direct routes so
that the ASs can communicate with each other through these EBGP
connections.
2. Configure AS_Path filters on SwitchB and use filtering rules to prevent AS 20
from advertising routes of AS 30 to AS 10 or routes of AS 10 to AS 30.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 1/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.0.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.2.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure EBGP connections.
# Configure SwitchA.
[SwitchA] bgp 10
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] peer 192.168.2.2 as-number 20
[SwitchA-bgp] import-route direct
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 20
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] peer 192.168.2.1 as-number 10
[SwitchB-bgp] peer 192.168.3.2 as-number 30
[SwitchB-bgp] import-route direct
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 30
[SwitchC-bgp] router-id 172.16.3.3
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 867
[SwitchC-bgp] peer 192.168.3.1 as-number 20
[SwitchC-bgp] import-route direct
[SwitchC-bgp] quit
# Check the routing table advertised by SwitchB. Take the routing table advertised
by SwitchB to SwitchC as an example. You can find that SwitchB advertises the
direct route of AS 10.
[SwitchB] display bgp routing-table peer 192.168.3.2 advertised-routes
BGP Local router ID is 172.16.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.1.0/24 192.168.3.1 0 20 10?
*> 10.1.1.0/24 192.168.3.1 0 20 30?
*> 192.168.2.0 192.168.3.1 0 0 20?
*> 192.168.3.0 192.168.3.1 0 0 20?
Check the routing table of SwitchC. You can find that SwitchC learns this route
advertised by SwitchB.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.16.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 9
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.1.0/24 192.168.3.1 0 20 10?
*> 10.1.1.0/24 0.0.0.0 0 0 ?
*> 10.1.1.1/32 0.0.0.0 0 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
*> 192.168.2.0 192.168.3.1 0 0 20?
*> 192.168.3.0 0.0.0.0 0 0 ?
192.168.3.1 0 0 20?
*> 192.168.3.2/32 0.0.0.0 0 0 ?
Step 4 Configure the AS_Path filter on SwitchB and apply the filter on the outbound
interface of SwitchB.
# Create AS_Path filter 1, denying the passing of routes carrying AS 30. The
regular expression "_30_" indicates any AS list that contains AS 30 and ".*"
matches any character.
[SwitchB] ip as-path-filter path-filter1 deny _30_
[SwitchB] ip as-path-filter path-filter1 permit .*
# Create AS_Path filter 2, denying the passing of routes carrying AS 10. The
regular expression "_10_" indicates any AS list that contains AS 10 and "*"
matches any character.
[SwitchB] ip as-path-filter path-filter2 deny _10_
[SwitchB] ip as-path-filter path-filter2 permit .*
# Apply the AS_Path filter on two outbound interfaces of SwitchB.
[SwitchB] bgp 20
[SwitchB-bgp] peer 192.168.2.1 as-path-filter path-filter1 export
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 868
[SwitchB-bgp] peer 192.168.3.2 as-path-filter path-filter2 export
[SwitchB-bgp] quit
Step 5 Check the routing table advertised by SwitchB.
Check the routing table advertised by SwitchB to AS 30. You can find that the
direct route of AS 10 advertised by SwitchB does not exist.
[SwitchB] display bgp routing-table peer 192.168.3.2 advertised-routes
BGP Local router ID is 172.16.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 192.168.2.0 192.168.3.1 0 0 20?
*> 192.168.3.0 192.168.3.1 0 0 20?
Similarly, the BGP routing table of SwitchC does not have the route.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.16.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 8
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 0.0.0.0 0 0 ?
*> 10.1.1.1/32 0.0.0.0 0 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
*> 192.168.2.0 192.168.3.1 0 0 20?
*> 192.168.3.0 0.0.0.0 0 0 ?
192.168.3.1 0 0 20?
*> 192.168.3.2/32 0.0.0.0 0 0 ?
Check the routing table advertised by SwitchB to AS 10. You can find that the
direct route of AS 30 advertised by SwitchB does not exist.
[SwitchB] display bgp routing-table peer 192.168.2.1 advertised-routes
BGP Local router ID is 172.16.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 192.168.2.0 192.168.2.2 0 0 20?
*> 192.168.3.0 192.168.2.2 0 0 20?
Similarly, the BGP routing table of SwitchA does not have the route.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.16.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 869
Total Number of Routes: 8
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.1.0/24 0.0.0.0 0 0 ?
*> 10.0.1.1/32 0.0.0.0 0 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
*> 192.168.2.0 0.0.0.0 0 0 ?
192.168.2.2 0 0 20?
*> 192.168.2.1/32 0.0.0.0 0 0 ?
*> 192.168.3.0 192.168.2.2 0 0 20?
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.0.1.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 10
router-id 172.16.1.1
peer 192.168.2.2 as-number 20
#
ipv4-family unicast
undo synchronization
import-route direct
peer 192.168.2.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 20 30
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.3.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 20
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 870
router-id 172.16.2.2
peer 192.168.2.1 as-number 10
peer 192.168.3.2 as-number 30
#
ipv4-family unicast
undo synchronization
import-route direct
peer 192.168.2.1 enable
peer 192.168.2.1 as-path-filter path-filter1 export
peer 192.168.3.2 enable
peer 192.168.3.2 as-path-filter path-filter2 export
#
ip as-path-filter path-filter1 deny _30_
ip as-path-filter path-filter1 permit .*
ip as-path-filter path-filter2 deny _10_
ip as-path-filter path-filter2 permit .*
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 30 40
#
interface Vlanif30
ip address 192.168.3.2 255.255.255.0
#
interface Vlanif40
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 30
router-id 172.16.3.3
peer 192.168.3.1 as-number 20
#
ipv4-family unicast
undo synchronization
import-route direct
peer 192.168.3.1 enable
#
return
9.17.6 Example for Configuring MED Attributes to Control BGP
Route Selection
Networking Requirements
As shown in Figure 9-48, BGP is configured on all switches; SwitchA resides in AS
65008; SwitchB and SwitchC reside in AS 65009. EBGP connections are established
between SwitchA and SwitchB, and between SwitchA and SwitchC. An IBGP
connection is established between SwitchB and SwitchC. After a period, traffic
from AS 65008 to AS 65009 needs to first pass through SwitchC.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 871
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-48 Networking diagram of configuring MED attributes of routes to
control route selection
Configuration Roadmap
The configuration roadmap is as follows:
1. Establish EBGP connections between SwitchA and SwitchB and between
SwitchA and SwitchC, and establish an IBGP connection between SwitchB and
SwitchC.
2. Apply a routing policy to increase the MED value of the route sent by SwitchB
to SwitchA so that SwitchA will send traffic to AS 65009 through SwitchC.
Procedure
Step 1 Create VLANs and add interfaces to the corresponding VLANs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 872
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.2 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.2.2 24
[SwitchA-Vlanif20] quit
Step 3 Establish a BGP connection.
# Configure SwitchA.
[SwitchA] bgp 65008
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] peer 192.168.1.1 as-number 65009
[SwitchA-bgp] peer 192.168.2.1 as-number 65009
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] peer 192.168.1.2 as-number 65008
[SwitchB-bgp] peer 10.1.1.2 as-number 65009
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] network 10.1.1.0 255.255.255.0
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 65009
[SwitchC-bgp] router-id 172.16.3.3
[SwitchC-bgp] peer 192.168.2.2 as-number 65008
[SwitchC-bgp] peer 10.1.1.1 as-number 65009
[SwitchC-bgp] ipv4-family unicast
[SwitchC-bgp-af-ipv4] network 10.1.1.0 255.255.255.0
[SwitchC-bgp-af-ipv4] quit
[SwitchC-bgp] quit
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.16.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.1.1 0 0 65009i
* 192.168.2.1 0 0 65009i
According to the routing table, you can view that there are two valid routes
destined for 10.1.1.0/24. The route whose next hop is 192.168.1.1 is the optimal
route because the router ID of SwitchB is smaller.
Step 4 Configure load balancing.
# Configure SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 873
[SwitchA] bgp 65008
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] maximum load-balancing 2
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.16.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.1.1 0 0 65009i
*> 192.168.2.1 0 0 65009i
According to the routing table, you can view that the BGP route 10.1.1.0/24 has
two next hops that are 192.168.1.1 and 192.168.2.1. Both of them are optimal
routes.
Step 5 Set the MED.
# Set the MED sent from SwitchB to SwitchA through the policy.
[SwitchB] route-policy 10 permit node 10
[SwitchB-route-policy] apply cost 100
[SwitchB-route-policy] quit
[SwitchB] bgp 65009
[SwitchB-bgp] peer 192.168.1.2 route-policy 10 export
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.16.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.2.1 0 0 65009i
* 192.168.1.1 100 0 65009i
According to the routing table, you can view that the MED of the next hop
192.168.1.1 (SwitchB) is 100, and that of the next hop 192.168.2.1 is 0. Therefore,
the route with the smaller MED is selected.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif20
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 874
ip address 192.168.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 65008
router-id 172.16.1.1
peer 192.168.1.1 as-number 65009
peer 192.168.2.1 as-number 65009
#
ipv4-family unicast
undo synchronization
maximum load-balancing 2
peer 192.168.1.1 enable
peer 192.168.2.1 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 30
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface Vlanif30
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65009
router-id 172.16.2.2
peer 10.1.1.2 as-number 65009
peer 192.168.1.2 as-number 65008
#
ipv4-family unicast
undo synchronization
network 10.1.1.0 255.255.255.0
peer 10.1.1.2 enable
peer 192.168.1.2 enable
peer 192.168.1.2 route-policy 10 export
#
route-policy 10 permit node 10
apply cost 100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 30
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface Vlanif30
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 875
ip address 10.1.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65009
router-id 172.16.3.3
peer 10.1.1.1 as-number 65009
peer 192.168.2.2 as-number 65008
#
ipv4-family unicast
undo synchronization
network 10.1.1.0 255.255.255.0
peer 10.1.1.1 enable
peer 192.168.2.2 enable
#
return
9.17.7 Example for Configuring a BGP Route Reflector
Networking Requirements
In Figure 9-49, four switches belong to two ASs, SwitchA and SwitchB establish an
EBGP neighbor relationship, and SwitchC establishes an IBGP neighbor relationship
with SwitchB and SwitchD. To prevent IBGP fully meshed connections and simplify
network configurations, the user requires that devices in the two ASs
communicate when no IBGP connection is established between SwitchB and
SwitchD.
Figure 9-49 Networking diagram of configuring a BGP route reflector (RR)
Configuration Roadmap
The configuration roadmap is as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 876
1. Configure basic BGP functions to allow BGP neighbors to communicate.
2. Configure SwitchC as an RR and configure SwitchB and SwitchD as two clients
of the RR. Subsequently, SwitchB and SwitchD can learn the routes advertised
by SwitchA without establishing an IBGP connection, simplifying
configurations.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA, and are not mentioned here.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Configure IP addresses for interfaces and set the IP address of LoopBack0 on
SwitchA as the destination IP address of a ping test.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA, and are not mentioned here.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.10.10.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface LoopBack 0
[SwitchA-LoopBack0] ip address 192.168.10.1 32
[SwitchA-LoopBack0] quit
Step 3 Configure basic BGP functions and advertise direct network segments in the BGP
processes of the four switches.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer 10.10.10.2 as-number 200
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] network 192.168.10.1 32
[SwitchA-bgp-af-ipv4] network 10.10.10.0 24
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer 10.10.10.1 as-number 100
[SwitchB-bgp] peer 10.10.20.2 as-number 200
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] network 10.10.10.0 24
[SwitchB-bgp-af-ipv4] network 10.10.20.0 24
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] router-id 10.3.3.3
[SwitchC-bgp] peer 10.10.20.1 as-number 200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 877
[SwitchC-bgp] peer 10.10.30.2 as-number 200
[SwitchC-bgp] ipv4-family unicast
[SwitchC-bgp-af-ipv4] network 10.10.20.0 24
[SwitchC-bgp-af-ipv4] network 10.10.30.0 24
[SwitchC-bgp-af-ipv4] quit
[SwitchC-bgp] quit
# Configure SwitchD.
[SwitchD] bgp 200
[SwitchD-bgp] router-id 10.4.4.4
[SwitchD-bgp] peer 10.10.30.1 as-number 200
[SwitchD-bgp] ipv4-family unicast
[SwitchD-bgp-af-ipv4] network 10.10.30.0 24
[SwitchD-bgp-af-ipv4] quit
[SwitchD-bgp] quit
Step 4 Configure an RR.
# Configure SwitchC as an RR and configure SwitchB and SwitchD as two clients
of the RR.
[SwitchC] bgp 200
[SwitchC-bgp] ipv4-family unicast
[SwitchC-bgp-af-ipv4] peer 10.10.20.1 reflect-client
[SwitchC-bgp-af-ipv4] peer 10.10.30.2 reflect-client
[SwitchC-bgp-af-ipv4] quit
[SwitchC-bgp] quit
Step 5 Verify the configuration.
# Check the BGP routing table of SwitchB.
[SwitchB] display bgp routing-table 192.168.10.1 32
BGP local router ID : 10.2.2.2
Local AS number : 200
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 192.168.10.1/32:
From: 10.10.10.1 (10.1.1.1)
Route Duration: 00h34m09s
Direct Out-interface: Vlanif10
Original nexthop: 10.10.10.1
Qos information : 0x0
AS-path 100, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 1 peers:
10.10.20.2
The command output shows that SwitchB has learned and advertised the route
192.168.10.1/32 to SwitchC.
# Check the BGP routing table of SwitchC.
[SwitchC] display bgp routing-table 192.168.10.1 32
BGP local router ID : 10.3.3.3
Local AS number : 200
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 192.168.10.1/32:
RR-client route.
From: 10.10.20.1 (10.2.2.2)
Route Duration: 00h34m17s
Relay IP Nexthop: 10.10.20.1
Relay IP Out-Interface: Vlanif20
Original nexthop: 10.10.10.1
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 2 peers:
10.10.20.1
10.10.30.2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 878
The command output shows that SwitchC has learned and advertised the route
192.168.10.1/32 to its two clients SwitchB and SwitchD.
# Check the BGP routing table of SwitchD.
[SwitchD] display bgp routing-table 192.168.10.1 32
BGP local router ID : 10.4.4.4
Local AS number : 200
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 192.168.10.1/32:
From: 10.10.30.1 (10.3.3.3)
Route Duration: 00h34m25s
Relay IP Nexthop: 10.10.30.1
Relay IP Out-Interface: Vlanif30
Original nexthop: 10.10.10.1
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Originator: 10.2.2.2
Cluster list: 10.3.3.3
Not advertised to any peer yet
The command output shows that SwitchD has learned from SwitchC the route
192.168.10.1/32 advertised by SwitchA.
# On SwitchD, ping the IP address of LoopBack0 on SwitchA to test route
reachability.
[SwitchD] ping 192.168.10.1
PING 192.168.10.1: 56 data bytes, press CTRL_C to break
Reply from 192.168.10.1: bytes=56 Sequence=1 ttl=255 time=31 ms
Reply from 192.168.10.1: bytes=56 Sequence=2 ttl=255 time=16 ms
Reply from 192.168.10.1: bytes=56 Sequence=3 ttl=255 time=40 ms
Reply from 192.168.10.1: bytes=56 Sequence=4 ttl=255 time=30 ms
Reply from 192.168.10.1: bytes=56 Sequence=5 ttl=255 time=26 ms
--- 192.168.10.1 ping statistics ---
5 packet(s) transmitted
5 packet(s) received
0.00% packet loss
round-trip min/avg/max = 70/84/100 ms
The command output shows that SwitchD pings the IP address of LoopBack0 on
SwitchA successfully, indicating that routes to SwitchA are reachable.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10
#
interface Vlanif10
ip address 10.10.10.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface LoopBack0
ip address 192.168.10.1 255.255.255.255
#
bgp 100
router-id 10.1.1.1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 879
peer 10.10.10.2 as-number 200
#
ipv4-family unicast
undo synchronization
network 10.10.10.0 255.255.255.0
network 192.168.10.1 255.255.255.255
peer 10.10.10.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.10.10.2 255.255.255.0
#
interface Vlanif20
ip address 10.10.20.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 200
router-id 10.2.2.2
peer 10.10.10.1 as-number 100
peer 10.10.20.2 as-number 200
#
ipv4-family unicast
undo synchronization
network 10.10.10.0 255.255.255.0
network 10.10.20.0 255.255.255.0
peer 10.10.10.1 enable
peer 10.10.20.2 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 30
#
interface Vlanif20
ip address 10.10.20.2 255.255.255.0
#
interface Vlanif30
ip address 10.10.30.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 200
router-id 10.3.3.3
peer 10.10.20.1 as-number 200
peer 10.10.30.2 as-number 200
#
ipv4-family unicast
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 880
undo synchronization
network 10.10.20.0 255.255.255.0
network 10.10.30.0 255.255.255.0
peer 10.10.20.1 enable
peer 10.10.20.1 reflect-client
peer 10.10.30.2 enable
peer 10.10.30.2 reflect-client
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30
#
interface Vlanif30
ip address 10.10.30.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 200
router-id 10.4.4.4
peer 10.10.30.1 as-number 200
#
ipv4-family unicast
undo synchronization
network 10.10.30.0 255.255.255.0
peer 10.10.30.1 enable
#
return
9.17.8 Example for Configuring a BGP4+ Route Reflector
Networking Requirements
As shown in Figure 9-50, four devices belong to two ASs. You are required to
perform simplified configuration to ensure that the two ASs communicate with
each other.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 881
Figure 9-50 Networking diagram of configuring a BGP4+ route reflector
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic BGP4+ functions to allow BGP neighbors to communicate.
2. Configure SwitchC as a route reflector so that no IBGP connection needs to be
established between SwitchB and SwitchD. This simplifies the configuration.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Enable the IPv6 forwarding capability, and assign an IPv6 address for each
interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] ipv6
[SwitchA] interface vlanif 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 882
[SwitchA-Vlanif10] ipv6 enable
[SwitchA-Vlanif10] ipv6 address fc00:0:0:0:1::1/64
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ipv6 enable
[SwitchA-Vlanif20] ipv6 address fc00:0:0:0:10::1/96
[SwitchA-Vlanif20] quit
Step 3 Configure basic BGP4+ functions.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer fc00:0:0:0:10::2 as-number 200
[SwitchA-bgp] ipv6-family unicast
[SwitchA-bgp-af-ipv6] peer fc00:0:0:0:10::2 enable
[SwitchA-bgp-af-ipv6] network fc00:0:0:0:1:: 64
[SwitchA-bgp-af-ipv6] network fc00:0:0:0:10:: 96
[SwitchA-bgp-af-ipv6] quit
# Configure SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer fc00:0:0:0:10::1 as-number 100
[SwitchB-bgp] peer fc00:0:0:0:11::1 as-number 200
[SwitchB-bgp] ipv6-family unicast
[SwitchB-bgp-af-ipv6] peer fc00:0:0:0:10::1 enable
[SwitchB-bgp-af-ipv6] peer fc00:0:0:0:11::1 enable
[SwitchB-bgp-af-ipv6] network fc00:0:0:0:10:: 96
[SwitchB-bgp-af-ipv6] network fc00:0:0:0:11:: 96
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] router-id 10.3.3.3
[SwitchC-bgp] peer fc00:0:0:0:11::2 as-number 200
[SwitchC-bgp] peer fc00:0:0:0:12::2 as-number 200
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer fc00:0:0:0:11::2 enable
[SwitchC-bgp-af-ipv6] peer fc00:0:0:0:12::2 enable
[SwitchC-bgp-af-ipv6] network fc00:0:0:0:11:: 96
[SwitchC-bgp-af-ipv6] network fc00:0:0:0:12:: 96
[SwitchC-bgp-af-ipv6] quit
# Configure SwitchD.
[SwitchD] bgp 200
[SwitchD-bgp] router-id 10.4.4.4
[SwitchD-bgp] peer fc00:0:0:0:12::1 as-number 200
[SwitchD-bgp] ipv6-family unicast
[SwitchD-bgp-af-ipv6] peer fc00:0:0:0:12::1 enable
[SwitchD-bgp-af-ipv6] network fc00:0:0:0:12:: 96
[SwitchD-bgp-af-ipv6] quit
[SwitchD-bgp] quit
Step 4 Configure the route reflector.
# Configure SwitchC as the route reflector and SwitchB and SwitchD as the clients.
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer fc00:0:0:0:11::2 reflect-client
[SwitchC-bgp-af-ipv6] peer fc00:0:0:0:12::2 reflect-client
# View the routing table of SwitchB.
[SwitchB] display bgp ipv6 routing-table
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 883
BGP Local router ID is 10.2.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
*> Network : 1:: PrefixLen : 64
NextHop : FC00:0:0:0:10::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 100 i
*> Network : FC00:0:0:0:10:: PrefixLen : 96
NextHop : :: LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
NextHop : FC00:0:0:0:10::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 100 i
*> Network : FC00:0:0:0:11:: PrefixLen : 96
NextHop : :: LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
i
NextHop : FC00:0:0:0:11::1 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
*>i Network : FC00:0:0:0:12:: PrefixLen : 96
NextHop : FC00:0:0:0:11::1 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
# View the routing table of SwitchD.
[SwitchD] display bgp ipv6 routing-table
BGP Local router ID is 10.4.4.4
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
*>i Network : FC00:0:0:1:: PrefixLen : 64
NextHop : FC00:0:0:10::1 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : 100 i
*>i Network : FC00:0:0:10:: PrefixLen : 96
NextHop : FC00:0:0:11::2 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
*>i Network : FC00:0:0:11:: PrefixLen : 96
NextHop : FC00:0:0:12::1 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
*> Network : FC00:0:0:12:: PrefixLen : 96
NextHop : :: LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
i
NextHop : FC00:0:0:12::1 LocPrf : 100
MED : 0 PrefVal : 0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 884
Label :
Path/Ogn : i
The routing tables show that SwitchD and SwitchB have learned the routing
information advertised by SwitchA from SwitchC.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
vlan batch 10 20
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:1::1/64
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:10::1/96
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 100
router-id 10.1.1.1
peer FC00:0:0:10::2 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:1:: 64
network FC00:0:0:10:: 96
peer FC00:0:0:10::2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
vlan batch 20 30
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:10::2/96
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:11::2/96
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 885
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 200
router-id 10.2.2.2
peer FC00:0:0:10::1 as-number 100
peer FC00:0:0:11::1 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:10:: 96
network FC00:0:0:11:: 96
peer FC00:0:0:10::1 enable
peer FC00:0:0:11::1 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 30 40
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:11::1/96
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:12::1/96
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 200
router-id 10.3.3.3
peer FC00:0:0:11::2 as-number 200
peer FC00:0:0:12::2 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:11:: 96
network FC00:0:0:12:: 96
peer FC00:0:0:11::2 enable
peer FC00:0:0:11::2 reflect-client
peer FC00:0:0:12::2 enable
peer FC00:0:0:12::2 reflect-client
#
return
● SwitchD configuration file
#
sysname SwitchD
#
ipv6
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 886
#
vlan batch 40
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:12::2/96
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
bgp 200
router-id 10.4.4.4
peer FC00:0:0:12::1 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:12:: 96
peer FC00:0:0:12::1 enable
#
return
9.17.9 Example for Configuring a BGP Confederation
Networking Requirements
In Figure 9-51, there are multiple BGP switches in AS 200. It is required that the
number of IBGP connections be reduced.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 887
Figure 9-51 Networking diagram of configuring a BGP confederation
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure a BGP confederation on each switch in AS 200 to divide AS 200 into
three sub-ASs: AS 65001, AS 65002, and AS 65003. Three switches in AS
65001 establish full-mesh IBGP connections to reduce the number of IBGP
connections.
Procedure
Step 1 Create VLANs and add interfaces to the corresponding VLANs.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20 30 40 60
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
[SwitchA] interface gigabitethernet 0/0/3
[SwitchA-GigabitEthernet0/0/3] port link-type trunk
[SwitchA-GigabitEthernet0/0/3] port trunk allow-pass vlan 30
[SwitchA-GigabitEthernet0/0/3] quit
[SwitchA] interface gigabitethernet 0/0/4
[SwitchA-GigabitEthernet0/0/4] port link-type trunk
[SwitchA-GigabitEthernet0/0/4] port trunk allow-pass vlan 40
[SwitchA-GigabitEthernet0/0/4] quit
[SwitchA] interface gigabitethernet 0/0/5
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 888
[SwitchA-GigabitEthernet0/0/5] port link-type trunk
[SwitchA-GigabitEthernet0/0/5] port trunk allow-pass vlan 60
[SwitchA-GigabitEthernet0/0/5] quit
The configurations of SwitchB, SwitchC, SwitchD, SwitchE, and SwitchF are similar
to the configuration of SwitchA, and are not mentioned here.
Step 2 Assign an IP address to each VLANIF interface.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 10.1.2.1 24
[SwitchA-Vlanif20] quit
[SwitchA] interface vlanif 30
[SwitchA-Vlanif30] ip address 10.1.3.1 24
[SwitchA-Vlanif30] quit
[SwitchA] interface vlanif 40
[SwitchA-Vlanif40] ip address 10.1.4.1 24
[SwitchA-Vlanif40] quit
[SwitchA] interface vlanif 60
[SwitchA-Vlanif60] ip address 192.168.1.1 24
[SwitchA-Vlanif60] quit
The configurations of SwitchB, SwitchC, SwitchD, SwitchE, and SwitchF are similar
to the configuration of SwitchA, and are not mentioned here.
Step 3 Configure the BGP confederation.
# Configure SwitchA.
[SwitchA] bgp 65001
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] confederation id 200
[SwitchA-bgp] confederation peer-as 65002 65003
[SwitchA-bgp] peer 10.1.1.2 as-number 65002
[SwitchA-bgp] peer 10.1.2.2 as-number 65003
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] peer 10.1.1.2 next-hop-local
[SwitchA-bgp-af-ipv4] peer 10.1.2.2 next-hop-local
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65002
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] confederation id 200
[SwitchB-bgp] confederation peer-as 65001 65003
[SwitchB-bgp] peer 10.1.1.1 as-number 65001
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 65003
[SwitchC-bgp] router-id 172.16.3.3
[SwitchC-bgp] confederation id 200
[SwitchC-bgp] confederation peer-as 65001 65002
[SwitchC-bgp] peer 10.1.2.1 as-number 65001
[SwitchC-bgp] quit
Step 4 Establish IBGP connection in AS 65001.
# Configure SwitchA.
[SwitchA] bgp 65001
[SwitchA-bgp] peer 10.1.3.2 as-number 65001
[SwitchA-bgp] peer 10.1.4.2 as-number 65001
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 889
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] peer 10.1.3.2 next-hop-local
[SwitchA-bgp-af-ipv4] peer 10.1.4.2 next-hop-local
[SwitchA-bgp-af-ipv4] quit
# Configure SwitchD.
[SwitchD] bgp 65001
[SwitchD-bgp] router-id 172.16.4.4
[SwitchD-bgp] peer 10.1.3.1 as-number 65001
[SwitchD-bgp] peer 10.1.5.2 as-number 65001
[SwitchD-bgp] quit
# Configure SwitchE.
[SwitchE] bgp 65001
[SwitchE-bgp] router-id 172.16.5.5
[SwitchE-bgp] peer 10.1.4.1 as-number 65001
[SwitchE-bgp] peer 10.1.5.1 as-number 65001
[SwitchE-bgp] quit
Step 5 Establish an EBGP connection between AS 100 and AS 200.
# Configure SwitchA.
[SwitchA] bgp 65001
[SwitchA-bgp] peer 192.168.1.2 as-number 100
[SwitchA-bgp] quit
# Configure SwitchF.
[SwitchF] bgp 100
[SwitchF-bgp] router-id 172.16.6.6
[SwitchF-bgp] peer 192.168.1.1 as-number 200
[SwitchF-bgp] ipv4-family unicast
[SwitchF-bgp-af-ipv4] network 10.0.1.0 255.255.255.0
[SwitchF-bgp-af-ipv4] quit
[SwitchF-bgp] quit
Step 6 Verify the configuration.
# Check the BGP routing table of SwitchB.
[SwitchB] display bgp routing-table
BGP Local router ID is 172.16.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.0.1.0/24 10.1.1.1 0 100 0 (65001) 100i
[SwitchB] display bgp routing-table 10.0.1.0
BGP local router ID : 172.16.2.2
Local AS number : 65002
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.0.1.0/24:
From: 10.1.1.1 (172.16.1.1)
Route Duration: 00h01m22s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: Vlanif10
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path (65001) 100, origin igp, MED 0, localpref 100, pref-val 0, valid, external-confed, best,select, active,
pre 255
Not advertised to any peer yet
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 890
# Check the BGP routing table of SwitchD.
[SwitchD] display bgp routing-table
BGP Local router ID is 172.16.4.4
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.0.1.0/24 10.1.3.1 0 100 0 100i
[SwitchD] display bgp routing-table 10.0.1.0
BGP local router ID : 172.16.4.4
Local AS number : 65001
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.0.1.0/24:
From: 10.1.3.1 (172.16.1.1)
Route Duration: 00h18m34s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: Vlanif30
Original nexthop: 10.1.3.1
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best,select, active, pre 255
Not advertised to any peer yet
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20 30 40 60
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
#
interface Vlanif20
ip address 10.1.2.1 255.255.255.0
#
interface Vlanif30
ip address 10.1.3.1 255.255.255.0
#
interface Vlanif40
ip address 10.1.4.1 255.255.255.0
#
interface Vlanif60
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/4
port link-type trunk
port trunk allow-pass vlan 40
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 891
#
interface GigabitEthernet0/0/5
port link-type trunk
port trunk allow-pass vlan 60
#
bgp 65001
router-id 172.16.1.1
confederation id 200
confederation peer-as 65002 65003
peer 10.1.1.2 as-number 65002
peer 10.1.2.2 as-number 65003
peer 10.1.3.2 as-number 65001
peer 10.1.4.2 as-number 65001
peer 192.168.1.2 as-number 100
#
ipv4-family unicast
undo synchronization
peer 10.1.1.2 enable
peer 10.1.1.2 next-hop-local
peer 10.1.2.2 enable
peer 10.1.2.2 next-hop-local
peer 10.1.3.2 enable
peer 10.1.3.2 next-hop-local
peer 10.1.4.2 enable
peer 10.1.4.2 next-hop-local
peer 192.168.1.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
bgp 65002
router-id 172.16.2.2
confederation id 200
confederation peer-as 65001 65003
peer 10.1.1.1 as-number 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.1.1 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20
#
interface Vlanif20
ip address 10.1.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 65003
router-id 172.16.3.3
confederation id 200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 892
confederation peer-as 65001 65002
peer 10.1.2.1 as-number 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.2.1 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30 50
#
interface Vlanif30
ip address 10.1.3.2 255.255.255.0
#
interface Vlanif50
ip address 10.1.5.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 65001
router-id 172.16.4.4
peer 10.1.3.1 as-number 65001
peer 10.1.5.2 as-number 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.3.1 enable
peer 10.1.5.2 enable
#
return
● SwitchE configuration file
#
sysname SwitchE
#
vlan batch 40 50
#
interface Vlanif40
ip address 10.1.4.2 255.255.255.0
#
interface Vlanif50
ip address 10.1.5.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 65001
router-id 172.16.5.5
peer 10.1.4.1 as-number 65001
peer 10.1.5.1 as-number 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.4.1 enable
peer 10.1.5.1 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 893
#
return
● SwitchF configuration file
#
sysname SwitchF
#
vlan batch 60 70
#
interface Vlanif60
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif70
ip address 10.0.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 60
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 70
#
bgp 100
router-id 172.16.6.6
peer 192.168.1.1 as-number 200
#
ipv4-family unicast
undo synchronization
network 10.0.1.0 255.255.255.0
peer 192.168.1.1 enable
#
return
9.17.10 Example for Configuring the BGP Community
Attribute
Networking Requirements
As shown in Figure 9-52, EBGP connections are established between SwitchB and
SwitchA, and between SwitchB and SwitchC. It is required that the routes
advertised from AS 10 to AS 20 are not advertised to other ASs by AS 20.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 894
Figure 9-52 Networking diagram of configuring the BGP community
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure a route-policy on SwitchA to advertise the No_Export attribute so
that AS 20 does not advertise the routes received from AS 10 to other ASs.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.2.1 24
[SwitchA-Vlanif20] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 895
Step 3 Configure EBGP.
# ConfigureSwitchA.
[SwitchA] bgp 10
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] peer 192.168.2.2 as-number 20
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] network 10.1.1.0 255.255.255.0
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 20
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] peer 192.168.2.1 as-number 10
[SwitchB-bgp] peer 192.168.3.2 as-number 30
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 30
[SwitchC-bgp] router-id 172.16.3.3
[SwitchC-bgp] peer 192.168.3.1 as-number 20
[SwitchC-bgp] quit
# Check the routing table of SwitchB.
[SwitchB] display bgp routing-table 10.1.1.0
BGP local router ID : 172.16.2.2
Local AS number : 20
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.2.1 (172.16.1.1)
Route Duration: 00h00m15s
Direct Out-interface: Vlanif20
Original nexthop: 192.168.2.1
Qos information : 0x0
AS-path 10, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
192.168.2.1
192.168.3.2
You can view that SwitchB advertises the received routes to SwitchC in AS 30.
# Check the routing table of SwitchC.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.16.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.3.1 0 20 10i
You can find that SwitchC has learned a route to the destination 10.1.1.0/24 from
SwitchB.
Step 4 Configure BGP community attributes.
# Configure the routing policy on SwitchA to enable SwitchB not to advertise the
routes advertised by SwitchA to any other AS.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 896
[SwitchA] route-policy comm_policy permit node 10
[SwitchA-route-policy] apply community no-export
[SwitchA-route-policy] quit
# Apply routing policies.
[SwitchA] bgp 10
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] peer 192.168.2.2 route-policy comm_policy export
[SwitchA-bgp-af-ipv4] peer 192.168.2.2 advertise-community
# Check the routing table of SwitchB.
[SwitchB] display bgp routing-table 10.1.1.0
BGP local router ID : 172.16.2.2
Local AS number : 20
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.2.1 (172.16.1.1)
Route Duration: 00h00m33s
Direct Out-interface: Vlanif20
Original nexthop: 192.168.2.1
Qos information : 0x0
Community:no-export
AS-path 10, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
Not advertised to any peer yet
You can view the configured community attribute in the BGP routing table of
SwitchB. At this time, there are no routes to the destination 10.1.1.0/24 in the BGP
routing table of SwitchC.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 10
router-id 172.16.1.1
peer 192.168.2.2 as-number 20
#
ipv4-family unicast
undo synchronization
network 10.1.1.0 255.255.255.0
peer 192.168.2.2 enable
peer 192.168.2.2 route-policy comm_policy export
peer 192.168.2.2 advertise-community
#
route-policy comm_policy permit node 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 897
apply community no-export
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 20 30
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.3.1 255.255.255.0
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 20
router-id 172.16.2.2
peer 192.168.2.1 as-number 10
peer 192.168.3.2 as-number 30
#
ipv4-family unicast
undo synchronization
peer 192.168.2.1 enable
peer 192.168.3.2 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan 30
#
interface Vlanif30
ip address 192.168.3.2 255.255.255.0
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 30
router-id 172.16.3.3
peer 192.168.3.1 as-number 20
#
ipv4-family unicast
undo synchronization
peer 192.168.3.1 enable
#
return
9.17.11 Example for Configuring BGP Load Balancing
Networking Requirements
On the network shown in Figure 9-53, BGP is configured on all switches. SwitchA
is in AS 100. SwitchB and SwitchC are in AS 300. SwitchD is in AS 200. Network
congestion from SwitchA to destination address 10.1.1.0/24 needs to be relieved
and network resources need to be fully utilized.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 898
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-53 Networking diagram of configuring BGP load balancing
Configuration Roadmap
The configuration roadmap is as follows:
1. Establish EBGP connections between SwitchA and SwitchB and between
SwitchA and SwitchC, between SwitchD and SwitchB and between SwitchD
and SwitchC to enable ASs to communicate with each other using BGP.
2. Configuring load balancing on SwitchA so that SwitchA can send traffic to
SwitchD through either SwitchB or SwitchC.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 899
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.2.1 24
[SwitchA-Vlanif20] quit
Step 3 Establish BGP connections.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] peer 192.168.1.2 as-number 300
[SwitchA-bgp] peer 192.168.2.2 as-number 300
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 300
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] peer 192.168.1.1 as-number 100
[SwitchB-bgp] peer 192.168.3.1 as-number 200
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 300
[SwitchC-bgp] router-id 172.16.3.3
[SwitchC-bgp] peer 192.168.2.1 as-number 100
[SwitchC-bgp] peer 192.168.4.1 as-number 200
[SwitchC-bgp] quit
# Configure SwitchD.
[SwitchD] bgp 200
[SwitchD-bgp] router-id 172.16.4.4
[SwitchD-bgp] peer 192.168.3.2 as-number 300
[SwitchD-bgp] peer 192.168.4.2 as-number 300
[SwitchD-bgp] ipv4-family unicast
[SwitchD-bgp-af-ipv4] network 10.1.1.0 255.255.255.0
[SwitchD-bgp-af-ipv4] quit
[SwitchD-bgp] quit
# View the routing table of SwitchA.
[SwitchA] display bgp routing-table 10.1.1.0 24
BGP local router ID : 172.16.1.1
Local AS number : 100
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.1.2 (172.16.2.2)
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 900
Route Duration: 0d00h00m50s
Direct Out-interface: Vlanif10
Original nexthop: 192.168.1.2
Qos information : 0x0
AS-path 300 200, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
192.168.2.2
192.168.1.2
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.2.2 (172.16.3.3)
Route Duration: 0d00h00m51s
Direct Out-interface: Vlanif20
Original nexthop: 192.168.2.2
Qos information : 0x0
AS-path 300 200, origin igp, pref-val 0, valid, external, pre 255, not preferred for router ID
Not advertised to any peer yet
The preceding command output shows that there are two valid routes from
SwitchA to destination 10.1.1.0/24. The route with the next-hop address of
192.168.1.2 is the optimal route because the router ID of SwitchB is smaller.
Step 4 Configure BGP load balancing.
# Configure load balancing on SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] maximum load-balancing 2
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
Step 5 Verify the configuration.
# View the routing table of SwitchA.
[SwitchA] display bgp routing-table 10.1.1.0 24
BGP local router ID : 172.16.1.1
Local AS number : 100
Paths: 2 available, 1 best, 2 select
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.1.2 (172.16.2.2)
Route Duration: 0d00h03m55s
Direct Out-interface: Vlanif10
Original nexthop: 192.168.1.2
Qos information : 0x0
AS-path 300 200, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
192.168.2.2
192.168.1.2
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.2.2 (172.16.3.3)
Route Duration: 0d00h03m56s
Direct Out-interface: Vlanif20
Original nexthop: 192.168.2.2
Qos information : 0x0
AS-path 300 200, origin igp, pref-val 0, valid, external, select, active, pre 255, not preferred for router ID
Not advertised to any peer yet
The preceding command output shows that BGP route 10.1.1.0/24 has two next
hops: 192.168.1.2 and 192.168.2.2. Both of them are optimal routes.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 901
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 100
router-id 172.16.1.1
peer 192.168.1.2 as-number 300
peer 192.168.2.2 as-number 300
#
ipv4-family unicast
undo synchronization
maximum load-balancing 2
peer 192.168.1.2 enable
peer 192.168.2.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 30
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.3.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 300
router-id 172.16.2.2
peer 192.168.1.1 as-number 100
peer 192.168.3.1 as-number 200
#
ipv4-family unicast
undo synchronization
peer 192.168.1.1 enable
peer 192.168.3.1 enable
#
return
● SwitchC configuration file
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 902
#
sysname SwitchC
#
vlan batch 20 40
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif40
ip address 192.168.4.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 300
router-id 172.16.3.3
peer 192.168.2.1 as-number 100
peer 192.168.4.1 as-number 200
#
ipv4-family unicast
undo synchronization
peer 192.168.2.1 enable
peer 192.168.4.1 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30 40 50
#
interface Vlanif30
ip address 192.168.3.1 255.255.255.0
#
interface Vlanif40
ip address 192.168.4.1 255.255.255.0
#
interface Vlanif50
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 200
router-id 172.16.4.4
peer 192.168.3.2 as-number 300
peer 192.168.4.2 as-number 300
#
ipv4-family unicast
undo synchronization
network 10.1.1.0 255.255.255.0
peer 192.168.3.2 enable
peer 192.168.4.2 enable
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 903
9.17.12 Example for Configuring a BGP Routing Policy
Networking Requirements
Figure 9-54 shows the simplified MPLS network that carries multiple types of
L3VPN services, such as multimedia, signaling, and accounting. In Figure 9-54,
two sites, each of which has two PEs accessing the core layer, are taken as an
example. The core layer is divided into two planes. All the P nodes on the same
plane are full-meshed P nodes. Nodes on different planes are connected to
provide backup paths across plane. MP-BGP is used to advertise inner labels and
VPNv4 routes between the PEs. All PEs set up MP-IBGP peer relationships with the
RR.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-54 Networking diagram
NOTE
Figure 9-54 is a simplified networking diagram, in which two sites are taken as an example
and each plane takes three P nodes and one RR as an example. In the actual network, there
are 14 sites with 28 PEs and each plane has four P nodes and two RR nodes, and each RR
needs to set up MP-IBGP connections with 28 PEs.
In Figure 9-54, each PE sends BGP Update messages to the RR, other PEs receive
BGP Update messages from different planes. Therefore, routing policies need to be
deployed to ensure that one VPN flow is transmitted only through one plane.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 904
Data Plan
Table 9-32 IP addresses of interconnected interfaces
Link
Name
(Local
End-
Remote
End)
Local Interface and IP Address Remote Interface and IP
Address
P1–P3 GE1/0/0
VLANIF10: 10.1.1.1/30
GE1/0/0
VLANIF10: 10.1.1.2/30
P1–P5 GE2/0/0
VLANIF20: 10.1.2.1/30
GE1/0/0
VLANIF20: 10.1.2.2/30
P1–RR GE3/0/0
VLANIF30: 10.1.3.1/30
GE1/0/0
VLANIF30: 10.1.3.2/30
P1–P2 GE4/0/0
VLANIF40: 10.1.4.1/30
GE1/0/0
VLANIF40: 10.1.4.2/30
P1–PE1 GE5/0/0
VLANIF50: 10.1.5.1/30
GE1/0/0
VLANIF50: 10.1.5.2/30
P2–P6 GE4/0/0
VLANIF80: 10.1.6.1/30
GE1/0/0
VLANIF80: 10.1.6.2/30
P2–P4 GE3/0/0
VLANIF70: 10.1.7.1/30
GE1/0/0
VLANIF70: 10.1.7.2/30
P2–RR GE2/0/0
VLANIF60: 10.1.8.1/30
GE2/0/0
VLANIF60: 10.1.8.2/30
P2–PE2 GE5/0/0
VLANIF90: 10.1.9.1/30
GE1/0/0
VLANIF90: 10.1.9.2/30
P3–P5 GE2/0/0
VLANIF110: 10.1.10.1/30
GE2/0/0
VLANIF110: 10.1.10.2/30
P3–P4 GE3/0/0
VLANIF120: 10.1.11.1/30
GE2/0/0
VLANIF120: 10.1.11.2/30
P3–PE3 GE4/0/0
VLANIF130: 10.1.12.1/30
GE1/0/0
VLANIF130: 10.1.12.2/30
P4–P6 GE3/0/0
VLANIF150: 10.1.13.1/30
GE3/0/0
VLANIF150: 10.1.13.2/30
P4–PE4 GE4/0/0
VLANIF160: 10.1.14.1/30
GE1/0/0
VLANIF160: 10.1.14.2/30
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 905
Link
Name
(Local
End-
Remote
End)
Local Interface and IP Address Remote Interface and IP
Address
P5–P6 GE3/0/0
VLANIF170: 10.1.15.1/30
GE2/0/0
VLANIF170: 10.1.15.2/30
PE1–PE2 GE2/0/0
VLANIF100: 10.1.16.1/30
GE2/0/0
VLANIF100: 10.1.16.2/30
PE3–PE4 GE2/0/0
VLANIF140: 10.1.17.1/30
GE2/0/0
VLANIF140: 10.1.17.2/30
Table 9-33 IP addresses of loopback interfaces
Local Device IP Address of the
local Loopback 0
Interface
Remote Device IP Address of the
Remote
Loopback 0
Interface
P1 10.1.1.9/32 P2 10.2.2.9/32
P3 10.3.3.9/32 P4 10.4.4.9/32
P5 10.5.5.9/32 P6 10.6.6.9/32
PE1 10.7.7.9/32 PE2 10.8.8.9/32
PE3 10.9.9.9/32 PE4 10.10.10.9/32
RR 10.11.11.9/32 - -
Table 9-34 BGP parameter Value
BGP Parameter Value
AS number 65000
Router ID Same as the address of Loopback 0
interface
BGP community attribute Plane A: 65000:100
Plane B: 65000:200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 906
BGP Parameter Value
BGP local preference Plane A: The local preference of
community attribute 65000:100 is set
to 200.
Plane B: The local preference of
community attribute 65000:200 is set
to 200.
NOTE
By default, the BGP local preference is 100.
The greater the value, the higher the
preference.
Routing policy name Route import policy: local_pre
Route export policy: comm
Community filter name 1
BGP peer group name Client
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure different RDs for two PEs in the same site to ensure that each PE
can receive two routes from different BGP next hops in the remote site. When
two PEs in a site advertise the routes to the same destination, configuring
different RDs for the two PEs can ensure that BGP peers consider the
advertised routes as two different routes. This is because BGP-VPNv4 uses the
VPNv4 addresses that consist of IPv4 addresses and RDs.
2. Assign different communities for BGP routes from PE in plane A and BGP
routes from PE in plane B.
3. Set different local preferences for routes based on the community attributes
of the routes. In this manner, the PEs in plane A choose the routes advertised
by remote PEs in plane A, and the PEs in plane B always choose the routes
advertised by the remote PEs in plane B.
Procedure
Step 1 Configure names for devices and IP addresses for interfaces.
For detailed configurations, see the configuration files of this example.
Step 2 Configure an IGP.
In this example, IS-IS is used as an IGP. For detailed configurations, see the
configuration files of this example.
After the configuration, run the display ip routing-table command. You can view
that PEs, Ps and PEs, and Ps have learned the addresses of Loopback 0 interfaces
from each other.
Step 3 Establish MP-IBGP connections between the PEs and RR.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 907
# Take the configuration of PE1 as an example. Configurations of other PEs are
similar to that of PE1, and are not mentioned here.
[PE1] bgp 65000
[PE1-bgp] peer 10.11.11.9 as-number 65000
[PE1-bgp] peer 10.11.11.9 connect-interface LoopBack0
[PE1-bgp] ipv4-family unicast
[PE1-bgp-af-ipv4] undo peer 10.11.11.9 enable
[PE1-bgp-af-ipv4] quit
[PE1-bgp] ipv4-family vpnv4
[PE1-bgp-af-vpnv4] peer 10.11.11.9 enable
# Configure the RR.
[RR] bgp 65000
[RR-bgp] group client internal
[RR-bgp] peer client connect-interface LoopBack0
[RR-bgp] ipv4-family unicast
[RR-bgp-af-ipv4] undo peer client enable
[RR-bgp-af-ipv4] quit
[RR-bgp] ipv4-family vpnv4
[RR-bgp-af-vpnv4] undo policy vpn-target
[RR-bgp-af-vpnv4] peer client enable
[RR-bgp-af-vpnv4] peer 10.7.7.9 group client
[RR-bgp-af-vpnv4] peer 10.8.8.9 group client
[RR-bgp-af-vpnv4] peer 10.9.9.9 group client
[RR-bgp-af-vpnv4] peer 10.10.10.9 group client
[RR-bgp-af-vpnv4] peer client reflect-client
NOTE
You need to run the undo policy vpn-target command in the BGP-VPNv4 address family
view of the RR to ensure that VPN-target-based filtering is not performed on VPNv4 routes.
By default, an RR performs VPN-target-based filtering on the received VPNv4 routes. The
matching routes are added to the VPN routing table, and the other routes are discarded. In
this example, VPN instances are not configured on the RR. As a result, if VPN-target-based
filtering is enabled, all the received VPNv4 routes will be discarded.
After the configuration, run the display bgp vpnv4 all peer command on the RR.
You can view that the RR sets up MP-IBGP peers with all PEs.
[RR] display bgp vpnv4 all peer
BGP local router ID : 10.11.11.9
Local AS number : 65000
Total number of peers : 4 Peers in established state : 4
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
10.7.7.9 4 65000 79 82 0 00:01:31 Established 0
10.8.8.9 4 65000 42 66 0 00:01:16 Established 0
10.9.9.9 4 65000 21 34 0 00:00:50 Established 0
10.10.10.9 4 65000 2 4 0 00:00:21 Established 0
Step 4 Configure a routing policy.
NOTE
Take the configurations of PE1, PE2, and the RR as an example. The configurations of PE3
and PE4 are similar to the configurations of PE1 and PE2 respectively, and are not
mentioned here.
# Configure a routing policy on PE1 so that the BGP VPNv4 route advertised by
PE1 can carry community attribute 65000:100.
[PE1] route-policy comm permit node 10
[PE1-route-policy] apply community 65000:100
# Configure the routing policy on PE2 so that the BGP VPNv4 route advertised by
PE2 can carry community attribute 65000:200.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 908
[PE2] route-policy comm permit node 10
[PE2-route-policy] apply community 65000:200
# On PE1, apply the routing policy to the BGP VPNv4 route advertised by PE1 to
the RR so that the route can carry the community attribute.
[PE1] bgp 65000
[PE1-bgp] ipv4-family vpnv4
[PE1-bgp-af-vpnv4] peer 10.11.11.9 route-policy comm export
[PE1-bgp-af-vpnv4] peer 10.11.11.9 advertise-community
# On PE2, apply the routing policy to the advertised BGP VPNv4 route advertised
by PE2 to the RR so that the route can carry the community attribute.
[PE2] bgp 65000
[PE2-bgp] ipv4-family vpnv4
[PE2-bgp-af-vpnv4] peer 10.11.11.9 route-policy comm export
[PE2-bgp-af-vpnv4] peer 10.11.11.9 advertise-community
# Configure the RR to advertise the community attribute to the PEs.
[RR] bgp 65000
[RR-bgp] ipv4-family vpnv4
[RR-bgp-af-vpnv4] peer client advertise-community
# Configure the community attribute filter on PE1.
[PE1] ip community-filter 1 permit 65000:100
# Configure the community attribute filter on PE2.
[PE2] ip community-filter 1 permit 65000:200
# On PE1, configure a routing policy and set the local preference of the route with
community attribute 65000:100 to 200.
[PE1] route-policy local_pre permit node 10
[PE1-route-policy] if-match community-filter 1
[PE1-route-policy] apply local-preference 200
[PE1-route-policy] quit
# On PE2, configure a routing policy and set the local preference of the route with
community attribute 65000:200 to 200.
[PE2] route-policy local_pre permit node 10
[PE2-route-policy] if-match community-filter 1
[PE2-route-policy] apply local-preference 200
[PE2-route-policy] quit
# On PE1, apply the routing policy to the imported BGP VPNv4 route so that the
PE1 chooses the route advertised by the remote PEs in plane A.
[PE1] bgp 65000
[PE1-bgp] ipv4-family vpnv4
[PE1-bgp-af-vpnv4] peer 10.11.11.9 route-policy local_pre import
# On PE2, apply the routing policy to the imported BGP VPNv4 route so that the
PE2 chooses the route advertised by the remote PEs in plane B.
[PE2] bgp 65000
[PE2-bgp] ipv4-family vpnv4
[PE2-bgp-af-vpnv4] peer 10.11.11.9 route-policy local_pre import
NOTE
After this configuration, you also need to configure MPLS, establish tunnels, configure MPLS
L3VPN, and configure PEs to access CEs. For detailed configurations, see the configuration files
of this example.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 909
Step 5 Verify the configuration.
Run the display bgp vpnv4 all routing-table community command on a PE. You
can view information about the VPNv4 routes with community attributes. Take the
display on PE1 and PE2 as an example.
[PE1] display bgp vpnv4 all routing-table community
BGP Local router ID is 10.7.7.9
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes from all PE: 2
Route Distinguisher: 65000:10001012
Network NextHop MED LocPrf PrefVal Community
*> 10.22.1.0/24 10.9.9.9 0 200 65000:100
* 10.10.10.9 0 100 65000:200
VPN-Instance NGN_Media, router ID 10.7.7.9:
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Community
*>i 10.22.1.0/24 10.9.9.9 0 200 0 65000:100
* 10.10.10.9 0 100 0 65000:200
[PE2] display bgp vpnv4 all routing-table community
BGP Local router ID is 10.8.8.9
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes from all PE: 2
Route Distinguisher: 65000:10001011
Route Distinguisher: 65000:10001011
Network NextHop MED LocPrf PrefVal Community
*> 10.22.1.0/24 10.10.10.9 0 200 65000:200
* 10.9.9.9 0 100 65000:100
VPN-Instance NGN_Media, router ID 10.7.7.9:
Total Number of Routes: 2
Total routes of vpn-instance NGN_Media: 2
Network NextHop MED LocPrf PrefVal Community
*>i 10.22.1.0/24 10.10.10.9 0 200 0 65000:200
* 10.9.9.9 0 100 0 65000:100
Run the display ip routing-table vpn-instance NGN_Media 10.22.1.0 24
command on PE1, and you can find that the next hop of route 10.22.1.0/24 is PE3.
That is, PE1 chooses the route advertised by PE3.
[PE1] display ip routing-table vpn-instance NGN_Media 10.22.1.0 24
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 910
Routing Table: NGN_Media
Summary Count: 1
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.22.1.0/24 IBGP 255 0 RD 10.9.9.9 Vlanif50
----End
Configuration Files
● P1 configuration file
#
sysname P1
#
vlan batch 10 20 30 40 50
#
mpls lsr-id 10.1.1.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0100.1009.00
#
interface Vlanif10
description toP3Vlanif10
ip address 10.1.1.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif20
description toP5Vlanif20
ip address 10.1.2.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif30
description toRRVlanif30
ip address 10.1.3.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif40
description toP2Vlanif40
ip address 10.1.4.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif50
description toP1Vlanif50
ip address 10.1.5.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet3/0/0
port link-type trunk
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 911
port trunk allow-pass vlan 30
#
interface GigabitEthernet4/0/0
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet5/0/0
port link-type trunk
port trunk allow-pass vlan 50
#
interface LoopBack0
ip address 10.1.1.9 255.255.255.255
isis enable 64
#
return
● P2 configuration file
#
sysname P2
#
vlan batch 40 60 70 80 90
#
mpls lsr-id 10.2.2.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0200.2009.00
#
interface Vlanif40
description toP1Vlanif40
ip address 10.1.4.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif60
description toRRVlanif60
ip address 10.1.8.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif70
description toP4Vlanif70
ip address 10.1.7.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif80
description toP6Vlanif80
ip address 10.1.6.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif90
description toPE2Vlanif90
ip address 10.1.9.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet2/0/0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 912
port link-type trunk
port trunk allow-pass vlan 60
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 70
#
interface GigabitEthernet4/0/0
port link-type trunk
port trunk allow-pass vlan 80
#
interface GigabitEthernet5/0/0
port link-type trunk
port trunk allow-pass vlan 90
#
interface LoopBack0
ip address 10.2.2.9 255.255.255.255
isis enable 64
#
return
● P3 configuration file
#
sysname P3
#
vlan batch 10 110 120 130
#
mpls lsr-id 10.3.3.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0300.3009.00
#
interface Vlanif10
description toP1Vlanif10
ip address 10.1.1.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif110
description toP5Vlanif110
ip address 10.1.10.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif120
description toP4Vlanif120
ip address 10.1.11.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif130
description toPE3Vlanif130
ip address 10.1.12.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 110
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 913
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 120
#
interface GigabitEthernet4/0/0
port link-type trunk
port trunk allow-pass vlan 130
#
interface LoopBack0
ip address 10.3.3.9 255.255.255.255
isis enable 64
#
return
● P4 configuration file
#
sysname P4
#
vlan batch 70 120 150 160
#
mpls lsr-id 10.4.4.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0400.4009.00
#
interface Vlanif70
description toP2Vlanif70
ip address 10.1.7.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif120
description toP3Vlanif120
ip address 10.1.11.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif150
description toP6Vlanif150
ip address 10.1.13.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif160
description toPE4Vlanif160
ip address 10.1.14.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 70
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 120
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 150
#
interface GigabitEthernet4/0/0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 914
port link-type trunk
port trunk allow-pass vlan 160
#
interface LoopBack0
ip address 10.4.4.9 255.255.255.255
isis enable 64
#
return
● P5 configuration file
#
sysname P5
#
vlan batch 20 110 170
#
mpls lsr-id 10.5.5.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0500.5009.00
#
interface Vlanif20
description toP1Vlanif20
ip address 10.1.2.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif110
description toP3Vlanif110
ip address 10.1.10.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif170
description toP6Vlanif170
ip address 10.1.15.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 110
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 170
#
interface LoopBack0
ip address 10.5.5.9 255.255.255.255
isis enable 64
#
return
● P6 configuration file
#
sysname P6
#
vlan batch 80 150 170
#
mpls lsr-id 10.6.6.9
mpls
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 915
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0600.6009.00
#
interface Vlanif80
description toP2Vlanif80
ip address 10.1.6.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif150
description toP4Vlanif150
ip address 10.1.13.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif170
description toP5Vlanif170
ip address 10.1.15.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 80
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 170
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 150
#
interface LoopBack0
ip address 10.6.6.9 255.255.255.255
isis enable 64
#
return
● PE1 configuration file
#
sysname PE1
#
vlan batch 50 100
#
ip vpn-instance NGN_Media
ipv4-family
route-distinguisher 65000:10001012
apply-label per-instance
vpn-target 65000:100 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Other
ipv4-family
route-distinguisher 65000:30001012
apply-label per-instance
vpn-target 65000:300 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Signaling
ipv4-family
route-distinguisher 65000:20001012
apply-label per-instance
vpn-target 65000:200 export-extcommunity
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 916
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
mpls lsr-id 10.7.7.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0700.7009.00
#
interface Vlanif50
description toP1Vlanif50
ip address 10.1.5.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif100
description toPE2Vlanif100
ip address 10.1.16.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet3/0/0
#
interface GigabitEthernet3/0/0.10
dot1q termination vid 180
ip binding vpn-instance NGN_Media
ip address 10.21.1.73 255.255.255.252
#
interface GigabitEthernet3/0/0.11
dot1q termination vid 190
ip binding vpn-instance NGN_Signaling
ip address 10.21.1.77 255.255.255.252
#
interface GigabitEthernet3/0/0.12
dot1q termination vid 200
ip binding vpn-instance NGN_Other
ip address 10.21.1.81 255.255.255.252
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 50
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 100
#
interface LoopBack0
ip address 10.7.7.9 255.255.255.255
isis enable 64
#
bgp 65000
peer 10.11.11.9 as-number 65000
peer 10.11.11.9 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
undo peer 10.11.11.9 enable
#
ipv4-family vpnv4
policy vpn-target
peer 10.11.11.9 enable
peer 10.11.11.9 route-policy local_pre import
peer 10.11.11.9 route-policy comm export
peer 10.11.11.9 advertise-community
#
ipv4-family vpn-instance NGN_Media
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 917
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Other
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Signaling
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
route-policy comm permit node 10
apply community 65000:100
#
route-policy local_pre permit node 10
if-match community-filter 1
apply local-preference 200
#
ip community-filter 1 permit 65000:100
#
return
● PE2 configuration file
#
sysname PE2
#
vlan batch 90 100
#
ip vpn-instance NGN_Media
ipv4-family
route-distinguisher 65000:10001011
apply-label per-instance
vpn-target 65000:100 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Other
ipv4-family
route-distinguisher 65000:30001011
apply-label per-instance
vpn-target 65000:300 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Signaling
ipv4-family
route-distinguisher 65000:20001011
apply-label per-instance
vpn-target 65000:200 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
mpls lsr-id 10.8.8.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0800.8009.00
#
interface Vlanif90
description toP2Vlanif90
ip address 10.1.9.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif100
description toPE1Vlanif100
ip address 10.1.16.2 255.255.255.252
isis enable 64
mpls
mpls ldp
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 918
#
interface GigabitEthernet3/0/0
#
interface GigabitEthernet3/0/0.10
dot1q termination vid 210
ip binding vpn-instance NGN_Media
ip address 10.21.1.13 255.255.255.252
#
interface GigabitEthernet3/0/0.11
dot1q termination vid 220
ip binding vpn-instance NGN_Signaling
ip address 10.21.1.17 255.255.255.252
#
interface GigabitEthernet3/0/0.12
dot1q termination vid 230
ip binding vpn-instance NGN_Other
ip address 10.21.1.21 255.255.255.252
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 90
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 100
#
interface LoopBack0
ip address 10.8.8.9 255.255.255.255
isis enable 64
#
bgp 65000
peer 10.11.11.9 as-number 65000
peer 10.11.11.9 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
undo peer 10.11.11.9 enable
#
ipv4-family vpnv4
policy vpn-target
peer 10.11.11.9 enable
peer 10.11.11.9 route-policy local_pre import
peer 10.11.11.9 route-policy comm export
peer 10.11.11.9 advertise-community
#
ipv4-family vpn-instance NGN_Media
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Other
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Signaling
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
route-policy comm permit node 10
apply community 65000:200
#
route-policy local_pre permit node 10
if-match community-filter 1
apply local-preference 200
#
ip community-filter 1 permit 65000:200
#
return
● PE3 configuration file
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 919
#
sysname PE3
#
vlan batch 130 140
#
ip vpn-instance NGN_Media
ipv4-family
route-distinguisher 65000:10000811
apply-label per-instance
vpn-target 65000:100 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Other
ipv4-family
route-distinguisher 65000:30000811
apply-label per-instance
vpn-target 65000:300 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Signaling
ipv4-family
route-distinguisher 65000:20000811
apply-label per-instance
vpn-target 65000:200 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
mpls lsr-id 10.9.9.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0900.9009.00
#
interface Vlanif130
description toP3Vlanif130
ip address 10.1.12.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif140
description toPE4Vlanif140
ip address 10.1.17.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet3/0/0
#
interface GigabitEthernet3/0/0.10
dot1q termination vid 240
ip binding vpn-instance NGN_Media
ip address 10.22.1.73 255.255.255.252
#
interface GigabitEthernet3/0/0.11
dot1q termination vid 250
ip binding vpn-instance NGN_Signaling
ip address 10.22.1.77 255.255.255.252
#
interface GigabitEthernet3/0/0.12
dot1q termination vid 260
ip binding vpn-instance NGN_Other
ip address 10.22.1.81 255.255.255.252
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 130
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 920
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 140
#
interface LoopBack0
ip address 10.9.9.9 255.255.255.255
isis enable 64
#
bgp 65000
peer 10.11.11.9 as-number 65000
peer 10.11.11.9 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
undo peer 10.11.11.9 enable
#
ipv4-family vpnv4
policy vpn-target
peer 10.11.11.9 enable
peer 10.11.11.9 route-policy local_pre import
peer 10.11.11.9 route-policy comm export
peer 10.11.11.9 advertise-community
#
ipv4-family vpn-instance NGN_Media
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Other
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Signaling
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
route-policy comm permit node 10
apply community 65000:100
#
route-policy local_pre permit node 10
if-match community-filter 1
apply local-preference 200
#
route-policy local_pre permit node 20
#
ip community-filter 1 permit 65000:100
#
return
● PE4 configuration file
#
sysname PE4
#
vlan batch 140 160
#
ip vpn-instance NGN_Media
ipv4-family
route-distinguisher 65000:10000712
apply-label per-instance
vpn-target 65000:100 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Other
ipv4-family
route-distinguisher 65000:30000712
apply-label per-instance
vpn-target 65000:300 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Signaling
ipv4-family
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 921
route-distinguisher 65000:20000712
apply-label per-instance
vpn-target 65000:200 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
mpls lsr-id 10.10.10.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.1001.0009.00
#
interface Vlanif140
description toPE3Vlanif140
ip address 10.1.17.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif160
description toP4Vlanif160
ip address 10.1.14.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet3/0/0
#
interface GigabitEthernet3/0/0.10
dot1q termination vid 270
ip binding vpn-instance NGN_Media
ip address 10.22.1.13 255.255.255.252
#
interface GigabitEthernet3/0/0.11
dot1q termination vid 280
ip binding vpn-instance NGN_Signaling
ip address 10.22.1.17 255.255.255.252
#
interface GigabitEthernet3/0/0.12
dot1q termination vid 290
ip binding vpn-instance NGN_Other
ip address 10.22.1.21 255.255.255.252
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 160
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 140
#
interface LoopBack0
ip address 10.10.10.9 255.255.255.255
isis enable 64
#
bgp 65000
peer 10.11.11.9 as-number 65000
peer 10.11.11.9 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
undo peer 10.11.11.9 enable
#
ipv4-family vpnv4
policy vpn-target
peer 10.11.11.9 enable
peer 10.11.11.9 route-policy local_pre import
peer 10.11.11.9 route-policy comm export
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 922
peer 10.11.11.9 advertise-community
#
ipv4-family vpn-instance NGN_Media
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Other
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Signaling
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
route-policy comm permit node 10
apply community 65000:200
#
route-policy local_pre permit node 10
if-match community-filter 1
apply local-preference 200
#
ip community-filter 1 permit 65000:200
#
return
● RR configuration file
#
sysname RR
#
vlan batch 30 60
#
isis 64
network-entity 49.0091.0100.1101.1009.00
#
interface Vlanif30
description toP1Vlanif30
ip address 10.1.3.2 255.255.255.252
isis enable 64
#
interface Vlanif60
description toP2Vlanif60
ip address 10.1.8.2 255.255.255.252
isis enable 64
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 60
#
interface LoopBack0
ip address 10.11.11.9 255.255.255.255
isis enable 64
#
bgp 65000
group client internal
peer client connect-interface LoopBack0
peer 10.7.7.9 as-number 65000
peer 10.8.8.9 as-number 65000
peer 10.9.9.9 as-number 65000
peer 10.10.10.9 as-number 65000
#
ipv4-family unicast
undo synchronization
undo peer client enable
undo peer 10.7.7.9 enable
undo peer 10.8.8.9 enable
undo peer 10.9.9.9 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 923
undo peer 10.10.10.9 enable
#
ipv4-family vpnv4
undo policy vpn-target
peer client enable
peer client reflect-client
peer client advertise-community
peer 10.7.7.9 enable
peer 10.7.7.9 group client
peer 10.8.8.9 enable
peer 10.8.8.9 group client
peer 10.9.9.9 enable
peer 10.9.9.9 group client
peer 10.10.10.9 enable
peer 10.10.10.9 group client
#
return
9.17.13 Example for Configuring BFD for BGP
Networking Requirements
As shown in Figure 9-55, SwitchA belongs to AS 100, and SwitchB and SwitchC
belong to AS 200. EBGP connections are established between SwitchA and
SwitchB, and between SwitchA and SwitchC.
Service traffic is transmitted along the primary link SwitchA→SwitchB. The link
SwitchA→SwitchC→SwitchB functions as the backup link. Fast fault detection is
required to allow traffic to be fast switched from the primary link to the backup
link.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-55 Networking diagram of configuring BFD for BGP
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 924
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic BGP functions on each switch.
2. Configure the MED attribute to control route selection.
3. Enable BFD on SwitchA and SwitchB.
NOTE
If two switches establish an EBGP peer relationship over a direct link, BFD for BGP does not
need to be configured. This is because the ebgp-interface-sensitive command is enabled
by default for directly-connected EBGP peers.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.2.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.1.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure basic BGP functions. Establish EBGP peer relationships between SwitchA
and SwitchB, and between SwitchA and SwitchC and an IBGP peer relationship
between SwitchB and SwitchC.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 172.17.1.1
[SwitchA-bgp] peer 192.168.1.2 as-number 200
[SwitchA-bgp] peer 192.168.1.2 ebgp-max-hop
[SwitchA-bgp] peer 192.168.2.2 as-number 200
[SwitchA-bgp] peer 192.168.2.2 ebgp-max-hop
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] router-id 172.17.2.2
[SwitchB-bgp] peer 192.168.1.1 as-number 100
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 925
[SwitchB-bgp] peer 192.168.1.1 ebgp-max-hop
[SwitchB-bgp] peer 10.1.1.2 as-number 200
[SwitchB-bgp] network 172.16.1.0 255.255.255.0
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] router-id 172.17.3.3
[SwitchC-bgp] peer 192.168.2.1 as-number 100
[SwitchC-bgp] peer 192.168.2.1 ebgp-max-hop
[SwitchC-bgp] peer 10.1.1.1 as-number 200
[SwitchC-bgp] import-route direct
[SwitchC-bgp] quit
# Check the status of BGP peer relationships on SwitchA. The command output
shows that the BGP peer relationships are in the Established state.
[SwitchA] display bgp peer
BGP local router ID : 172.17.1.1
Local AS number : 100
Total number of peers : 2 Peers in established state : 2
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
192.168.1.2 4 200 2 5 0 00:01:25 Established 0
192.168.2.2 4 200 2 4 0 00:00:55 Established 0
Step 4 Set the MED.
Set the MED sent from SwitchB to SwitchC through the policy.
# Configure SwitchB.
[SwitchB] route-policy 10 permit node 10
[SwitchB-route-policy] apply cost 100
[SwitchB-route-policy] quit
[SwitchB] bgp 200
[SwitchB-bgp] peer 192.168.1.1 route-policy 10 export
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] route-policy 10 permit node 10
[SwitchC-route-policy] apply cost 150
[SwitchC-route-policy] quit
[SwitchC] bgp 200
[SwitchC-bgp] peer 192.168.2.1 route-policy 10 export
[SwitchC-bgp] quit
# View all BGP routing information on SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.17.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.2.2 150 0 200?
*> 172.16.1.0/24 192.168.1.2 100 0 200i
* 192.168.2.2 150 0 200i
*> 192.168.2.0 192.168.1.2 100 0 200?
192.168.2.2 150 0 200?
According to the BGP routing table, the next-hop address of the route destined for
172.16.1.0/24 is 192.168.1.2 and service flow is transmitted on the active link
SwitchA → SwitchB.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 926
Step 5 Configure BFD, and set the interval for transmitting BFD packets, the interval for
receiving BFD packets, and the local detection multiplier.
# Enable BFD on SwitchA. Set the minimum intervals for transmitting and
receiving BFD packets to 100 ms and the local detection multiplier to 4.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] bgp 100
[SwitchA-bgp] peer 192.168.1.2 bfd enable
[SwitchA-bgp] peer 192.168.1.2 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchA-bgp] quit
# Enable BFD on SwitchB. Set the minimum intervals for transmitting and
receiving BFD packets to 100 ms and the local detection multiplier to 4.
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] bgp 200
[SwitchB-bgp] peer 192.168.1.1 bfd enable
[SwitchB-bgp] peer 192.168.1.1 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchB-bgp] quit
# Display all BFD sessions on SwitchA.
[SwitchA] display bgp bfd session all
Local_Address Peer_Address LD/RD Interface
192.168.1.1 192.168.1.2 8201/8201 Vlanif20
Tx-interval(ms) Rx-interval(ms) Multiplier Session-State
100 100 4 Up
Wtr-interval(m)
0
Step 6 Verify the configuration.
# Run the shutdown command on VLANIF20 of SwitchB to simulate faults on the
active link.
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] shutdown
# Check the BGP routing table on SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.17.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.2.2 150 0 200?
*> 172.16.1.0/24 192.168.2.2 150 0 200i
192.168.2.0 192.168.2.2 150 0 200?
According to the BGP routing table, the standby link SwitchA → SwitchC →
SwitchB takes effect after the active link fails. The next-hop address of the route
destined for 172.16.1.0/24 becomes 192.168.2.2.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 927
#
vlan batch 10 20
#
bfd
#
interface Vlanif10
ip address 192.168.2.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 100
router-id 172.17.1.1
peer 192.168.1.2 as-number 200
peer 192.168.1.2 ebgp-max-hop 255
peer 192.168.1.2 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
peer 192.168.1.2 bfd enable
peer 192.168.2.2 as-number 200
peer 192.168.2.2 ebgp-max-hop 255
#
ipv4-family unicast
undo synchronization
peer 192.168.1.2 enable
peer 192.168.2.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 20 30 40
#
bfd
#
interface Vlanif20
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif30
ip address 10.1.1.1 255.255.255.0
#
interface Vlanif40
ip address 172.16.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 40
#
bgp 200
router-id 172.17.2.2
peer 10.1.1.2 as-number 200
peer 192.168.1.1 as-number 100
peer 192.168.1.1 ebgp-max-hop 255
peer 192.168.1.1 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 928
peer 192.168.1.1 bfd enable
#
ipv4-family unicast
undo synchronization
network 172.16.1.0 255.255.255.0
peer 10.1.1.2 enable
peer 192.168.1.1 enable
peer 192.168.1.1 route-policy 10 export
#
route-policy 10 permit node 10
apply cost 100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 10 30
#
bfd
#
interface Vlanif10
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif30
ip address 10.1.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 200
router-id 172.17.3.3
peer 10.1.1.1 as-number 200
peer 192.168.2.1 as-number 100
peer 192.168.2.1 ebgp-max-hop 255
#
ipv4-family unicast
undo synchronization
import-route direct
peer 10.1.1.1 enable
peer 192.168.2.1 enable
peer 192.168.2.1 route-policy 10 export
#
route-policy 10 permit node 10
apply cost 150
#
return
9.17.14 Example for Configuring BFD for BGP4+
Networking Requirements
In Figure 9-56, SwitchA belongs to AS 100, and SwitchB and SwitchC belong to AS
200. SwitchA establishes EBGP connections with both SwitchB and SwitchC.
Service traffic is forwarded along the primary link SwitchA→SwitchB. The link
SwitchA→SwitchC→SwitchB is used as a backup. Customers require that a fault on
the primary link be detected in milliseconds so that service traffic can be fast
switched to the backup link if the primary link fails.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 929
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-56 Networking diagram of configuring BFD for BGP4+
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic BGP4+ functions on all switches so that they can establish
BGP peer relationships with each other.
2. Configure MED-based route selection on SwitchA and SwitchB to forward
traffic on the primary link between SwitchA and SwitchB.
3. Enable BFD on SwitchA and SwitchB to detect faults in milliseconds so that
service traffic can be fast switched to the backup link if the primary link fails.
Procedure
Step 1 Enable the IPv6 forwarding capability and configure IPv6 addresses for interfaces.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] ipv6
[SwitchA] interface GigabitEthernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] undo portswitch
[SwitchA-GigabitEthernet0/0/1] ipv6 enable
[SwitchA-GigabitEthernet0/0/1] ipv6 address FC00:3::1 64
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface GigabitEthernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] undo portswitch
[SwitchA-GigabitEthernet0/0/2] ipv6 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 930
[SwitchA-GigabitEthernet0/0/2] ipv6 address FC00:1::1 64
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure basic BGP4+ functions, establish EBGP connections between SwitchA
and SwitchB and between SwitchA and SwitchC, and establish an IBGP connection
between SwitchB and SwitchC.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer FC00:3::2 as-number 200
[SwitchA-bgp] peer FC00:1::2 as-number 200
[SwitchA-bgp] ipv6-family unicast
[SwitchA-bgp-af-ipv6] peer FC00:3::2 enable
[SwitchA-bgp-af-ipv6] peer FC00:1::2 enable
[SwitchA-bgp-af-ipv6] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer FC00:3::1 as-number 100
[SwitchB-bgp] peer FC00:2::1 as-number 200
[SwitchB-bgp] ipv6-family unicast
[SwitchB-bgp-af-ipv6] peer FC00:3::1 enable
[SwitchB-bgp-af-ipv6] peer FC00:2::1 enable
[SwitchB-bgp-af-ipv6] network FC00:4:: 64
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] router-id 10.3.3.3
[SwitchC-bgp] peer FC00:1::1 as-number 100
[SwitchC-bgp] peer FC00:2::2 as-number 200
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer FC00:1::1 enable
[SwitchC-bgp-af-ipv6] peer FC00:2::2 enable
[SwitchC-bgp-af-ipv6] quit
[SwitchC-bgp] quit
# Run the display bgp ipv6 peer command on SwitchA. The command output
shows that BGP peer relationships have been established.
[SwitchA] display bgp ipv6 peer
BGP local router ID : 10.1.1.1
Local AS number : 100
Total number of peers : 2 Peers in established state : 2
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
FC00:1::2 4 200 2 4 0 00:00:27 Established 0
FC00:3::2 4 200 2 3 0 00:00:27 Established 0
Step 3 Configure the MED attribute.
Set the MED values of routes sent from SwitchB and SwitchC to SwitchA through
routing policies.
# Configure SwitchB.
[SwitchB] route-policy 10 permit node 10
[SwitchB-route-policy] apply cost 100
[SwitchB-route-policy] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 931
[SwitchB] bgp 200
[SwitchB-bgp] ipv6-family unicast
[SwitchB-bgp-af-ipv6] peer FC00:3::1 route-policy 10 export
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] route-policy 10 permit node 10
[SwitchC-route-policy] apply cost 150
[SwitchC-route-policy] quit
[SwitchC] bgp 200
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer FC00:1::1 route-policy 10 export
[SwitchC-bgp-af-ipv6] quit
[SwitchC-bgp] quit
# Check the BGP routing table on SwitchA.
[SwitchA] display bgp ipv6 routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
*> Network : FC00:4:: PrefixLen : 64
NextHop : FC00:3::2 LocPrf :
MED : 100 PrefVal : 0
Label :
Path/Ogn : 200 i
*
NextHop : FC00:1::2 LocPrf :
MED : 150 PrefVal : 0
Label :
Path/Ogn : 200 i
In the BGP routing table, you can view that the next-hop address of the route to
FC00:4::1/64 is FC00:3::2, and traffic is transmitted on the primary link
SwitchA→SwitchB.
Step 4 Configure BFD, and set the intervals at which BFD packets are sent and received
and the local detection multiplier.
# Configure BFD on SwitchA, and set the minimum intervals for sending and
receiving BFD packets to both 100 ms and the local detection multiplier to 4.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] bgp 100
[SwitchA-bgp] peer FC00:3::2 bfd enable
[SwitchA-bgp] peer FC00:3::2 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchA-bgp] quit
# Configure BFD on SwitchB, and set the minimum intervals for sending and
receiving BFD packets to both 100 ms and the local detection multiplier to 4.
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] bgp 200
[SwitchB-bgp] peer FC00:3::1 bfd enable
[SwitchB-bgp] peer FC00:3::1 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchB-bgp] quit
# Check all BFD sessions on SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 932
[SwitchA] display bgp ipv6 bfd session all
Local_Address : FC00:3::1
Peer_Address : FC00:3::2
Tx-interval(ms): 100 Rx-interval(ms): 100
Multiplier : 4 Interface : GigabitEthernet0/0/1
LD/RD : 8199/8200 Session-State : Up
Wtr-interval(m): 0
Step 5 Verify the configuration.
# Run the shutdown command on GE0/0/1 of SwitchB to simulate a primary link
fault.
[SwitchB] interface GigabitEthernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] shutdown
# Check the BGP routing table on SwitchA.
[SwitchA] display bgp ipv6 routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
*> Network : FC00:4:: PrefixLen : 64
NextHop : FC00:1::2 LocPrf :
MED : 150 PrefVal : 0
Label :
Path/Ogn : 200 i
In the BGP routing table, you can view that the backup link
SwitchA→SwitchC→SwitchB transmits traffic after the primary link
SwitchA→SwitchB fails, and the next-hop address of the route to FC00:4::1/64
becomes FC00:1::2.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
bfd
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:3::1/64
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:1::1/64
#
bgp 100
router-id 10.1.1.1
peer FC00:1::2 as-number 200
peer FC00:3::2 as-number 200
peer FC00:3::2 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
peer FC00:3::2 bfd enable
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 933
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
peer FC00:1::2 enable
peer FC00:3::2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
bfd
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:3::2/64
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:2::2/64
#
interface GigabitEthernet0/0/3
undo portswitch
ipv6 enable
ipv6 address FC00:4::1/64
#
bgp 200
router-id 10.2.2.2
peer FC00:2::1 as-number 200
peer FC00:3::1 as-number 100
peer FC00:3::1 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
peer FC00:3::1 bfd enable
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:4:: 64
peer FC00:2::1 enable
peer FC00:3::1 enable
peer FC00:3::1 route-policy 10 export
#
route-policy 10 permit node 10
apply cost 100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:2::1/64
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:1::2/64
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 934
#
bgp 200
router-id 10.3.3.3
peer FC00:1::1 as-number 100
peer FC00:2::2 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
peer FC00:1::1 enable
peer FC00:1::1 route-policy 10 export
peer FC00:2::2 enable
#
route-policy 10 permit node 10
apply cost 150
#
return
9.17.15 Example for Configuring BGP GTSM
Networking Requirements
As shown in Figure 9-57, SwitchA belongs to AS 10, and SwitchB, SwitchC, and
SwitchD belong to AS 20. BGP runs on the network. To protect a device against
the attacks of forged BGP packets, you can configure GTSM to check whether the
TTL value in the IP packet header is within the specified range.
Figure 9-57 Networking diagram of configuring BGP GTSM
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure OSPF on SwitchB, SwitchC, and SwitchD to implement interworking
in AS 20.
2. Set up an EBGP connection between SwitchA and SwitchB, and set up IBGP
connections between SwitchB, SwitchC, and SwitchD through loopback
interfaces to implement interworking between ASs.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 935
3. Configure GTSM on SwitchA, SwitchB, SwitchC, and SwitchD so that it can
protect SwitchB against CPU-utilization attacks.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign an IP address to each interface.
# Configure SwitchB. The configurations of SwitchA, SwitchC, and SwitchD are
similar to the configuration of SwitchB.
[SwitchB] interface vlanif 10
[SwitchB-Vlanif10] ip address 10.1.1.2 24
[SwitchB-Vlanif10] quit
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] ip address 10.2.1.2 24
[SwitchB-Vlanif20] quit
[SwitchB] interface loopback 0
[SwitchB-LoopBack0] ip address 172.16.2.9 32
[SwitchB-LoopBack0] quit
Step 3 Configure OSPF.
# Configure SwitchB. The configurations of SwitchC and SwitchD are similar to the
configuration of SwitchB.
[SwitchB] ospf
[SwitchB-ospf-1] area 0.0.0.0
[SwitchB-ospf-1-area-0.0.0.0] network 10.2.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] network 172.16.2.9 0.0.0.0
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
Step 4 Configure an IBGP connection.
# Configure SwitchB.
[SwitchB] bgp 20
[SwitchB-bgp] router-id 172.16.2.9
[SwitchB-bgp] peer 172.16.3.9 as-number 20
[SwitchB-bgp] peer 172.16.3.9 connect-interface LoopBack0
[SwitchB-bgp] peer 172.16.3.9 next-hop-local
[SwitchB-bgp] peer 172.16.4.9 as-number 20
[SwitchB-bgp] peer 172.16.4.9 connect-interface LoopBack0
[SwitchB-bgp] peer 172.16.4.9 next-hop-local
# Configure SwitchC.
[SwitchC] bgp 20
[SwitchC-bgp] router-id 172.16.3.9
[SwitchC-bgp] peer 172.16.2.9 as-number 20
[SwitchC-bgp] peer 172.16.2.9 connect-interface LoopBack0
[SwitchC-bgp] peer 172.16.4.9 as-number 20
[SwitchC-bgp] peer 172.16.4.9 connect-interface LoopBack0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 936
# Configure SwitchD.
[SwitchD] bgp 20
[SwitchD-bgp] router-id 172.16.4.9
[SwitchD-bgp] peer 172.16.2.9 as-number 20
[SwitchD-bgp] peer 172.16.2.9 connect-interface LoopBack0
[SwitchD-bgp] peer 172.16.3.9 as-number 20
[SwitchD-bgp] peer 172.16.3.9 connect-interface LoopBack0
Step 5 Configure an EBGP connection.
# Configure SwitchA.
[SwitchA] bgp 10
[SwitchA-bgp] router-id 172.16.1.9
[SwitchA-bgp] peer 10.1.1.2 as-number 20
# Configure SwitchB.
[SwitchB-bgp] peer 10.1.1.1 as-number 10
[SwitchB-bgp] quit
# Display the connection status of the BGP peers.
[SwitchB] display bgp peer
BGP local router ID : 172.16.2.9
Local AS number : 20
Total number of peers : 3 Peers in established state : 3
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
172.16.3.9 4 20 8 7 0 00:05:06 Established 0
172.16.4.9 4 20 8 10 0 00:05:33 Established 0
10.1.1.1 4 10 7 7 0 00:04:09 Established 0
You can view that SwitchB has set up BGP connections with other routers.
Step 6 Configure GTSM on SwitchA and SwitchB. SwitchA and SwitchB are directly
connected, so the range of the TTL value between the two switches is [255, 255].
The value of valid-ttl-hops is 1.
# Configure GTSM on SwitchA.
[SwitchA-bgp] peer 10.1.1.2 valid-ttl-hops 1
# Configure GTSM of the EBGP connection on SwitchB.
[SwitchB-bgp] peer 10.1.1.1 valid-ttl-hops 1
# Check the GTSM configuration.
[SwitchB] display bgp peer 10.1.1.1 verbose
BGP Peer is 10.1.1.1, remote AS 10
Type: EBGP link
BGP version 4, Remote router ID 172.16.1.9
Update-group ID : 0
BGP current state: Established, Up for 00h49m35s
BGP current event: RecvKeepalive
BGP last state: OpenConfirm
BGP Peer Up count: 1
Received total routes: 0
Received active routes total: 0
Received mac routes: 0
Advertised total routes: 0
Port: Local - 179 Remote - 52876
Configured: Connect-retry Time: 32 sec
Configured: Min Hold Time: 0 sec
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 937
Configured: Active Hold Time: 180 sec Keepalive Time:60 sec
Received : Active Hold Time: 180 sec
Negotiated: Active Hold Time: 180 sec Keepalive Time:60 sec
Peer optional capabilities:
Peer supports bgp multi-protocol extension
Peer supports bgp route refresh capability
Peer supports bgp 4-byte-as capability
Address family IPv4 Unicast: advertised and received
Received: Total 59 messages
Update messages 0
Open messages 2
KeepAlive messages 57
Notification messages 0
Refresh messages 0
Sent: Total 79 messages
Update messages 5
Open messages 2
KeepAlive messages 71
Notification messages 1
Refresh messages 0
Authentication type configured: None
Last keepalive received: 2012/03/06 19:17:37 Last keepalive sent : 2012/03/06 19:17:37 Last update
received: 2012/03/06 19:17:43 Last update sent : 2012/03/06 19:17:37
Minimum route advertisement interval is 30 seconds
Optional capabilities:
Route refresh capability has been enabled
4-byte-as capability has been enabled
GTSM has been enabled, valid-ttl-hops: 1
Peer Preferred Value: 0
Routing policy configured:
No routing policy is configured
You can view that GTSM is enabled, the valid hop count is 1, and the BGP
connection is in the Established state.
Step 7 Configure GTSM on SwitchB and SwitchC. SwitchB and SwitchC are directly
connected, so the range of the TTL value between the two switches is [255, 255].
The value of valid-ttl-hops is 1.
# Configure GTSM on SwitchB.
[SwitchB-bgp] peer 172.16.3.9 valid-ttl-hops 1
# Configure GTSM of the IBGP connection on SwitchC.
[SwitchC-bgp] peer 172.16.2.9 valid-ttl-hops 1
# View the GTSM configuration.
[SwitchB] display bgp peer 172.16.3.9 verbose
BGP Peer is 172.16.3.9, remote AS 20
Type: IBGP link
BGP version 4, Remote router ID 172.16.3.9
Update-group ID : 1
BGP current state: Established, Up for 00h54m36s
BGP current event: KATimerExpired
BGP last state: OpenConfirm
BGP Peer Up count: 2
Received total routes: 0
Received active routes total: 0
Received mac routes: 0
Advertised total routes: 0
Port: Local - 54998 Remote - 179
Configured: Connect-retry Time: 32 sec
Configured: Min Hold Time: 0 sec
Configured: Active Hold Time: 180 sec Keepalive Time:60 sec
Received : Active Hold Time: 180 sec
Negotiated: Active Hold Time: 180 sec Keepalive Time:60 sec
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 938
Peer optional capabilities:
Peer supports bgp multi-protocol extension
Peer supports bgp route refresh capability
Peer supports bgp 4-byte-as capability
Address family IPv4 Unicast: advertised and received
Received: Total 63 messages
Update messages 0
Open messages 1
KeepAlive messages 62
Notification messages 0
Refresh messages 0
Sent: Total 69 messages
Update messages 10
Open messages 1
KeepAlive messages 58
Notification messages 0
Refresh messages 0
Authentication type configured: None
Last keepalive received: 2012/03/06 19:18:37 Last keepalive sent : 2012/03/06 19:18:37 Last update
received: 2012/03/06 19:18:43 Last update sent : 2012/03/06 19:18:37
Minimum route advertisement interval is 15 seconds
Optional capabilities:
Route refresh capability has been enabled
4-byte-as capability has been enabled
Nexthop self has been configured
Connect-interface has been configured
GTSM has been enabled, valid-ttl-hops: 1
Peer Preferred Value: 0
Routing policy configured:
No routing policy is configured
You can view that GTSM is enabled, the valid hop count is 1, and the BGP
connection is in the Established state.
Step 8 Configure GTSM on SwitchC and SwitchD. SwitchC and SwitchD are directly
connected, so the range of the TTL value between the two switches is [255, 255].
The value of valid-ttl-hops is 1.
# Configure GTSM of the IBGP connection on SwitchC.
[SwitchC-bgp] peer 172.16.4.9 valid-ttl-hops 1
# Configure GTSM of the IBGP connection on SwitchD.
[SwitchD-bgp] peer 172.16.3.9 valid-ttl-hops 1
# Check the GTSM configuration.
[SwitchC] display bgp peer 172.16.4.9 verbose
BGP Peer is 172.16.4.9, remote AS 20
Type: IBGP link
BGP version 4, Remote router ID 172.16.4.9
Update-group ID : 1
BGP current state: Established, Up for 00h56m06s
BGP current event: KATimerExpired
BGP last state: OpenConfirm
BGP Peer Up count: 2
Received total routes: 0
Received active routes total: 0
Received mac routes: 0
Advertised total routes: 0
Port: Local - 179 Remote - 53758
Configured: Connect-retry Time: 32 sec
Configured: Min Hold Time: 0 sec
Configured: Active Hold Time: 180 sec Keepalive Time:60 sec
Received : Active Hold Time: 180 sec
Negotiated: Active Hold Time: 180 sec Keepalive Time:60 sec
Peer optional capabilities:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 939
Peer supports bgp multi-protocol extension
Peer supports bgp route refresh capability
Peer supports bgp 4-byte-as capability
Address family IPv4 Unicast: advertised and received
Received: Total 63 messages
Update messages 0
Open messages 1
KeepAlive messages 62
Notification messages 0
Refresh messages 0
Sent: Total 63 messages
Update messages 0
Open messages 2
KeepAlive messages 61
Notification messages 0
Refresh messages 0
Authentication type configured: None
Last keepalive received: 2012/03/06 19:19:37 Last keepalive sent : 2012/03/06 19:19:37 Last update
received: 2012/03/06 19:19:43 Last update sent : 2012/03/06 19:19:37
Minimum route advertisement interval is 15 seconds
Optional capabilities:
Route refresh capability has been enabled
4-byte-as capability has been enabled
Connect-interface has been configured
GTSM has been enabled, valid-ttl-hops: 1
Peer Preferred Value: 0
Routing policy configured:
No routing policy is configured
You can view that GTSM is enabled, the valid hop count is 1, and the BGP
connection is in the Established state.
Step 9 Configure GTSM on SwitchB and SwitchD. SwitchB and SwitchD are connected by
SwitchC, so the range of the TTL value between the two switches is [254, 255].
The value of valid-ttl-hops is 2.
# Configure GTSM of the IBGP connection on SwitchB.
[SwitchB-bgp] peer 172.16.4.9 valid-ttl-hops 2
# Configure GTSM on SwitchD.
[SwitchD-bgp] peer 172.16.2.9 valid-ttl-hops 2
# Check the GTSM configuration.
[SwitchB] display bgp peer 172.16.4.9 verbose
BGP Peer is 172.16.4.9, remote AS 20
Type: IBGP link
BGP version 4, Remote router ID 172.16.4.9
Update-group ID : 1
BGP current state: Established, Up for 00h57m48s
BGP current event: RecvKeepalive
BGP last state: OpenConfirm
BGP Peer Up count: 2
Received total routes: 0
Received active routes total: 0
Received mac routes: 0
Advertised total routes: 0
Port: Local - 53714 Remote - 179
Configured: Connect-retry Time: 32 sec
Configured: Min Hold Time: 0 sec
Configured: Active Hold Time: 180 sec Keepalive Time:60 sec
Received : Active Hold Time: 180 sec
Negotiated: Active Hold Time: 180 sec Keepalive Time:60 sec
Peer optional capabilities:
Peer supports bgp multi-protocol extension
Peer supports bgp route refresh capability
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 940
Peer supports bgp 4-byte-as capability
Address family IPv4 Unicast: advertised and received
Received: Total 72 messages
Update messages 0
Open messages 1
KeepAlive messages 71
Notification messages 0
Refresh messages 0
Sent: Total 82 messages
Update messages 10
Open messages 1
KeepAlive messages 71
Notification messages 0
Refresh messages 0
Authentication type configured: None
Last keepalive received: 2012/03/06 19:20:37 Last keepalive sent : 2012/03/06 19:20:37 Last update
received: 2012/03/06 19:20:43 Last update sent : 2012/03/06 19:20:37
Minimum route advertisement interval is 15 seconds
Optional capabilities:
Route refresh capability has been enabled
4-byte-as capability has been enabled
Nexthop self has been configured
Connect-interface has been configured
GTSM has been enabled, valid-ttl-hops: 2
Peer Preferred Value: 0
Routing policy configured:
No routing policy is configured
You can view that GTSM is configured, the valid hop count is 2, and the BGP
connection is in the Established state.
NOTE
● In this example, if the value of valid-ttl-hops of either SwitchB or SwitchD is smaller
than 2, the IBGP connection cannot be set up.
● GTSM must be configured on the two ends of the BGP connection.
Step 10 Verify the configuration.
# Run the display gtsm statistics all command on SwitchB to check the GTSM
statistics of SwitchB. By default, SwitchB does not discard any packet when all
packets match the GTSM policy.
[SwitchB] display gtsm statistics all
GTSM Statistics Table
----------------------------------------------------------------
SlotId Protocol Total Counters Drop Counters Pass Counters
----------------------------------------------------------------
0 BGP 17 0 17
0 BGPv6 0 0 0
0 OSPF 0 0 0
0 LDP 0 0 0
0 OSPFv3 0 0 0 0 RIP 0 0 0
----------------------------------------------------------------
If the host simulates the BGP packets of SwitchA to attack SwitchB, the packets
are discarded because their TTL value is not 255 when reaching SwitchB. In the
GTSM statistics of SwitchB, the number of dropped packets increases accordingly.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 941
#
vlan batch 10
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
bgp 10
router-id 172.16.1.9
peer 10.1.1.2 as-number 20
peer 10.1.1.2 valid-ttl-hops 1
#
ipv4-family unicast
undo synchronization
peer 10.1.1.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
#
interface Vlanif20
ip address 10.2.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface LoopBack0
ip address 172.16.2.9 255.255.255.255
#
bgp 20
router-id 172.16.2.9
peer 172.16.3.9 as-number 20
peer 172.16.3.9 connect-interface LoopBack0
peer 172.16.3.9 valid-ttl-hops 1
peer 172.16.4.9 as-number 20
peer 172.16.4.9 connect-interface LoopBack0
peer 172.16.4.9 valid-ttl-hops 2
peer 10.1.1.1 as-number 10
peer 10.1.1.1 valid-ttl-hops 1
#
ipv4-family unicast
undo synchronization
import-route ospf 1
peer 172.16.3.9 enable
peer 172.16.3.9 next-hop-local
peer 172.16.4.9 enable
peer 172.16.4.9 next-hop-local
peer 10.1.1.1 enable
#
ospf 1
area 0.0.0.0
network 172.16.2.9 0.0.0.0
network 10.2.1.0 0.0.0.255
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 942
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 30
#
interface Vlanif20
ip address 10.2.1.2 255.255.255.0
#
interface Vlanif30
ip address 10.2.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
interface LoopBack0
ip address 172.16.3.9 255.255.255.255
#
bgp 20
router-id 172.16.3.9
peer 172.16.2.9 as-number 20
peer 172.16.2.9 connect-interface LoopBack0
peer 172.16.2.9 valid-ttl-hops 1
peer 172.16.4.9 as-number 20
peer 172.16.4.9 connect-interface LoopBack0
peer 172.16.4.9 valid-ttl-hops 1
#
ipv4-family unicast
undo synchronization
peer 172.16.2.9 enable
peer 172.16.4.9 enable
#
ospf 1
area 0.0.0.0
network 172.16.3.9 0.0.0.0
network 10.2.1.0 0.0.0.255
network 10.2.2.0 0.0.0.255
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30
#
interface Vlanif30
ip address 10.2.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface LoopBack0
ip address 172.16.4.9 255.255.255.255
#
bgp 20
router-id 172.16.4.9
peer 172.16.2.9 as-number 20
peer 172.16.2.9 connect-interface LoopBack0
peer 172.16.2.9 valid-ttl-hops 2
peer 172.16.3.9 as-number 20
peer 172.16.3.9 connect-interface LoopBack0
peer 172.16.3.9 valid-ttl-hops 1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 943
#
ipv4-family unicast
undo synchronization
peer 172.16.2.9 enable
peer 172.16.3.9 enable
#
ospf 1
area 0.0.0.0
network 172.16.4.9 0.0.0.0
network 10.2.2.0 0.0.0.255
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 944