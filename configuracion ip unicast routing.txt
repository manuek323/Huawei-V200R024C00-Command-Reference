S300, S500, S2700, S5700 and S6700 Series
Ethernet Switches
V200R024C00
Configuration Guide - IP Unicast
Routing
Issue 01
Date 2024-09-30
HUAWEI TECHNOLOGIES CO., LTD.
Copyright © Huawei Technologies Co., Ltd. 2024. All rights reserved.
No part of this document may be reproduced or transmitted in any form or by any means without prior
written consent of Huawei Technologies Co., Ltd.
Trademarks and Permissions
and other Huawei trademarks are trademarks of Huawei Technologies Co., Ltd.
All other trademarks and trade names mentioned in this document are the property of their respective
holders.
Notice
The purchased products, services and features are stipulated by the contract made between Huawei and
the customer. All or part of the products, services and features described in this document may not be
within the purchase scope or the usage scope. Unless otherwise specified in the contract, all statements,
information, and recommendations in this document are provided "AS IS" without warranties, guarantees
or representations of any kind, either express or implied.
The information in this document is subject to change without notice. Every effort has been made in the
preparation of this document to ensure accuracy of the contents, but all statements, information, and
recommendations in this document do not constitute a warranty of any kind, express or implied.
Huawei Technologies Co., Ltd.
Address: Huawei Industrial Base
Bantian, Longgang
Shenzhen 518129
People's Republic of China
Website: https://e.huawei.com
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. i
About This Document
Intended Audience
This document is intended for network engineers responsible for switch
configuration and management. You should be familiar with basic Ethernet
knowledge and have extensive experience in network deployment and
management.
Symbol Conventions
The symbols that may be found in this document are defined as follows.
Symbol Description
Indicates a potentially hazardous
situation which, if not avoided, could
result in equipment damage, data loss,
performance deterioration, or
unanticipated results.
NOTICE is used to address practices
not related to personal injury.
Supplements the important
information in the main text.
NOTE is used to address information
not related to personal injury,
equipment damage, and environment
deterioration.
Command Conventions
The command conventions that may be found in this document are defined as
follows.
Convention Description
Boldface The keywords of a command line are in boldface.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing About This Document
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. ii
Convention Description
Italic Command arguments are in
italics.
[ ] Items (keywords or arguments) in brackets [ ] are
optional.
{ x | y | ... } Optional items are grouped in braces and separated
by vertical bars. One item is selected.
[ x | y | ... ] Optional items are grouped in brackets and
separated by vertical bars. One item is selected or
no item is selected.
{ x | y | ... }* Optional items are grouped in braces and separated
by vertical bars. A minimum of one item or a
maximum of all items can be selected.
[ x | y | ... ]* Optional items are grouped in brackets and
separated by vertical bars. Several items or no item
can be selected.
&<1-n> The parameter before the & sign can be repeated 1
to n times.
# A line starting with the # sign is comments.
Interface Numbering Conventions
Interface numbers used in this manual are examples. In device configuration, use
the existing interface numbers on devices.
Security Conventions
● Password setting
– To ensure device security, use ciphertext when configuring a password
and change the password periodically.
– The switch considers all passwords starting and ending with %^%#, %#
%#, %@%@ or @%@% as ciphertext and attempts to decrypt them. If
you configure a plaintext password that starts and ends with %^%#, %#
%#, %@%@ or @%@%, the switch decrypts it and records it into the
configuration file (plaintext passwords are not recorded for the sake of
security). Therefore, do not set a password starting and ending with %^
%#, %#%#, %@%@ or @%@%.
– When you configure passwords in ciphertext, different features must use
different ciphertext passwords. For example, the ciphertext password set
for the AAA feature cannot be used for other features.
● Encryption algorithms
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing About This Document
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. iii
The switch currently supports the 3DES, AES, RSA, SHA1, SHA2, and MD5.
3DES, RSA, and AES are reversible, whereas SHA1, SHA2, and MD5 are
irreversible. Using the encryption algorithms DES, 3DES, RSA (RSA-1024 or
lower), MD5 (in digital signature scenarios and password encryption), or
SHA1 (in digital signature scenarios) is a security risk. If protocols allow, use
more secure encryption algorithms, such as AES, RSA (RSA-2048 or higher),
SHA2, or HMAC-SHA2.
An irreversible encryption algorithm must be used for the administrator
password. SHA2 is recommended for this purpose.
● Personal data
Some personal data (such as MAC or IP addresses of terminals) may be
obtained or used during operation or fault location of your purchased
products, services, features, so you have an obligation to make privacy policies
and take measures according to the applicable law of the country to protect
personal data.
● Mirroring
The terms mirrored port, port mirroring, traffic mirroring, and mirroring in this
document are mentioned only to describe the product's function of
communication error or failure detection, and do not involve collection or
processing of any personal information or communication data of users.
● Reliability design declaration
Network planning and site design must comply with reliability design
principles and provide device- and solution-level protection. Device-level
protection includes planning principles of dual-network and inter-board dual-
link to avoid single point or single link of failure. Solution-level protection
refers to a fast convergence mechanism, such as FRR and VRRP. If solution-
level protection is used, ensure that the primary and backup paths do not
share links or transmission devices. Otherwise, solution-level protection may
fail to take effect.
Reference Standards and Protocols
To obtain reference standards and protocols, log in to Huawei official website,
search for "standard and protocol compliance list", and download the
Huawei S-
Series Switch Standard and Protocol Compliance List. You need to have
permissions to access the document. For any questions, contact technical support.
Disclaimer
● This document is designed as a reference for you to configure your devices. Its
contents, including web pages, command line input and output, are based on
laboratory conditions. It provides instructions for general scenarios, but does
not cover all use cases of all product models. The examples given may differ
from your use case due to differences in software versions, models, and
configuration files. When configuring your device, alter the configuration
depending on your use case.
● The specifications provided in this document are tested in a lab environment
(for example, a certain type of cards have been installed on the tested device
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing About This Document
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. iv
or only one protocol is run on the device). Results may differ from the listed
specifications when you attempt to obtain the maximum values due to factors
such as differences in hardware configurations and carried services.
● In this document, public IP addresses may be used in feature introduction and
configuration examples and are for reference only unless otherwise specified.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing About This Document
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. v
Contents
About This Document................................................................................................................ ii
1 IP Routing.................................................................................................................................. 1
1.1 Overview of IP Routing......................................................................................................................................................... 1
1.2 Understanding IP Routing.................................................................................................................................................... 2
1.2.1 Routers and Routing........................................................................................................................................................... 2
1.2.2 Static Routes and Dynamic Routes................................................................................................................................2
1.2.3 Routing Table and FIB Table............................................................................................................................................ 3
1.2.4 Route Recursion....................................................................................................................................................................6
1.2.5 Routing Protocol Preference.............................................................................................................................................6
1.2.6 Route Metric.......................................................................................................................................................................... 8
1.2.7 Load Balancing and Route Backup................................................................................................................................ 9
1.2.8 IP FRR.................................................................................................................................................................................... 10
1.2.9 Route Convergence........................................................................................................................................................... 12
1.2.10 Default Routes................................................................................................................................................................. 14
1.2.11 Route Importing.............................................................................................................................................................. 14
1.2.12 Autonomous System...................................................................................................................................................... 14
1.2.13 Router ID............................................................................................................................................................................ 15
2 Static Route Configuration................................................................................................. 16
2.1 Overview of Static Routes..................................................................................................................................................16
2.2 Understanding Static Routes............................................................................................................................................ 17
2.2.1 Static Route Basics............................................................................................................................................................ 17
2.2.2 BFD for Static Routes....................................................................................................................................................... 18
2.2.3 NQA for Static Routes......................................................................................................................................................19
2.2.4 Permanent Advertisement of Static Routes............................................................................................................. 20
2.3 Application Scenarios for Static Routes........................................................................................................................ 22
2.3.1 Load Balancing and Route Backup..............................................................................................................................22
2.3.2 Default Static Routes....................................................................................................................................................... 23
2.4 Summary of Static Route Configuration Tasks........................................................................................................... 24
2.5 Default Settings for Static Routes................................................................................................................................... 25
2.6 Configuring IPv4 Static Routes......................................................................................................................................... 25
2.6.1 Creating IPv4 Static Routes............................................................................................................................................ 25
2.6.2 (Optional) Setting the Default Preference Value for IPv4 Static Routes....................................................... 26
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. vi
2.6.3 (Optional) Configuring Permanent Advertisement of IPv4 Static Routes.....................................................27
2.6.4 (Optional) Preventing a Static Route from Being Selected If the Associated BFD Session Is in
AdminDown State........................................................................................................................................................................ 27
2.6.5 (Optional) Preventing Static Routes from Being Recursed to a Blackhole Route...................................... 28
2.6.6 Verifying the IPv4 Static Route Configuration.........................................................................................................29
2.7 Configuring Static BFD for IPv4 Static Routes............................................................................................................ 29
2.8 Configuring NQA for IPv4 Static Routes....................................................................................................................... 30
2.9 Configuring EFM for IPv4 Static Routes........................................................................................................................ 32
2.10 Configuring Association Between IPv4 Static Routes and a Route Monitoring Group.............................. 33
2.11 Configuring IPv6 Static Routes...................................................................................................................................... 34
2.11.1 Creating IPv6 Static Routes......................................................................................................................................... 35
2.11.2 (Optional) Setting the Default Preference Value for IPv6 Static Routes.....................................................36
2.11.3 Verifying the IPv6 Static Route Configuration...................................................................................................... 36
2.12 Configuring Static BFD for IPv6 Static Routes..........................................................................................................36
2.13 Configuring NQA for IPv6 Static Routes.................................................................................................................... 38
2.14 Configuration Examples for Static Routes................................................................................................................. 39
2.14.1 Example for Configuring IPv4 Static Routes.......................................................................................................... 39
2.14.2 Example for Configuring IPv6 Static Routes.......................................................................................................... 43
2.14.3 Example for Configuring Static BFD for IPv4 Static Routes............................................................................. 47
2.14.4 Example for Configuring Static BFD for IPv6 Static Routes............................................................................. 51
2.14.5 Example for Configuring NQA for IPv4 Static Routes........................................................................................ 54
2.14.6 Example for Configuring NQA for IPv6 Static Routes........................................................................................ 58
2.14.7 Example for Configuring EFM for Static IPv4 Routes......................................................................................... 64
2.14.8 Example for Configuring Association Between IPv4 Static Routes and a Route Monitoring Group
............................................................................................................................................................................................................ 67
3 RIP Configuration.................................................................................................................. 74
3.1 Overview of RIP..................................................................................................................................................................... 74
3.2 Understanding RIP................................................................................................................................................................ 75
3.2.1 RIP Fundamentals............................................................................................................................................................. 75
3.2.2 RIP-2 Enhanced Features................................................................................................................................................ 78
3.2.3 Split Horizon and Poison Reverse................................................................................................................................ 80
3.2.4 Multi-Process and Multi-Instance................................................................................................................................ 81
3.2.5 BFD for RIP.......................................................................................................................................................................... 82
3.2.6 Hot Standby........................................................................................................................................................................ 83
3.3 Summary of RIP Configuration Tasks............................................................................................................................ 83
3.4 Licensing Requirements and Limitations for RIP....................................................................................................... 87
3.5 Default Settings for RIP...................................................................................................................................................... 88
3.6 Configuring Basic RIP Functions...................................................................................................................................... 88
3.6.1 Enabling RIP........................................................................................................................................................................ 89
3.6.2 Enabling RIP on the Specified Network Segment.................................................................................................. 89
3.6.3 (Optional) Configuring RIP Neighbors on an NBMA Network......................................................................... 90
3.6.4 (Optional) Configuring the RIP Version.....................................................................................................................90
3.6.5 Verifying the Basic RIP Function Configuration...................................................................................................... 91
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. vii
3.7 Configuring RIP-2.................................................................................................................................................................. 92
3.7.1 Configuring RIP-2 Route Summarization.................................................................................................................. 92
3.7.2 Configuring RIP-2 Packet Authentication..................................................................................................................93
3.7.3 Verifying the RIP-2 Configuration................................................................................................................................ 94
3.8 Preventing Routing Loops.................................................................................................................................................. 95
3.8.1 Configuring Split Horizon............................................................................................................................................... 95
3.8.2 Configuring Poison Reverse........................................................................................................................................... 96
3.8.3 Verifying the RIP Routing Loop Prevention Configuration..................................................................................96
3.9 Controlling RIP Routing...................................................................................................................................................... 96
3.9.1 Configuring RIP Preference............................................................................................................................................ 97
3.9.2 Configuring Additional Metrics of an Interface...................................................................................................... 97
3.9.3 Setting the Maximum Number of Equal-Cost Routes.......................................................................................... 98
3.9.4 Verifying the RIP Routing Control Configuration................................................................................................... 99
3.10 Controlling RIP Route Advertisement.......................................................................................................................... 99
3.10.1 Configuring RIP to Advertise Default Routes........................................................................................................ 99
3.10.2 Disabling an Interface from Sending Update Packets..................................................................................... 100
3.10.3 Configuring RIP to Import Routes...........................................................................................................................101
3.10.4 Verifying the RIP Route Advertisement Control Configuration.................................................................... 102
3.11 Controlling Receiving of RIP Routing Information............................................................................................... 102
3.11.1 Disabling an Interface from Receiving RIP Update Packets.......................................................................... 102
3.11.2 Configuring RIP to Deny Host Routes................................................................................................................... 103
3.11.3 Configuring RIP to Filter Received Routes........................................................................................................... 103
3.11.4 Verifying the RIP Route Receiving Control Configuration.............................................................................. 104
3.12 Improving RIP Network Performance....................................................................................................................... 104
3.12.1 Configuring RIP Timers............................................................................................................................................... 105
3.12.2 Setting the Interval for Sending Update Packets and Maximum Number of Sent Packets............... 106
3.12.3 Enabling the Replay Protection Function............................................................................................................. 106
3.12.4 Configuring RIP to Check the Validity of Update Packets..............................................................................107
3.12.5 Verifying the RIP Network Performance Optimization Configuration....................................................... 108
3.13 Configuring BFD for RIP.................................................................................................................................................108
3.13.1 Configuring Dynamic BFD for RIP.......................................................................................................................... 109
3.13.2 Configuring Static BFD for RIP................................................................................................................................. 111
3.14 Configuring the Network Management Function for RIP..................................................................................113
3.15 Maintaining RIP................................................................................................................................................................ 114
3.15.1 Resetting RIP.................................................................................................................................................................. 114
3.15.2 Clearing RIP Statistics..................................................................................................................................................114
3.16 Configuration Examples for RIP.................................................................................................................................. 114
3.16.1 Example for Configuring Basic RIP Functions..................................................................................................... 115
3.16.2 Example for Configuring RIP to Import Routes..................................................................................................118
3.16.3 Example for Configuring One-Arm Static BFD for RIP.................................................................................... 123
3.16.4 Example for Configuring Dynamic BFD for RIP................................................................................................. 128
3.17 Troubleshooting RIP........................................................................................................................................................ 133
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. viii
3.17.1 Failed to Receive RIP Update Packets from Neighbors................................................................................... 133
3.17.2 Failed to Send RIP Update Packets to Neighbors..............................................................................................133
3.17.3 Route Flapping Occurs on a RIP Network........................................................................................................... 134
4 RIPng Configuration........................................................................................................... 135
4.1 Overview of RIPng............................................................................................................................................................. 135
4.2 Understanding RIPng........................................................................................................................................................ 136
4.2.1 RIPng................................................................................................................................................................................... 136
4.3 Summary of RIPng Configuration Tasks..................................................................................................................... 136
4.4 Licensing Requirements and Limitations for RIPng................................................................................................ 138
4.5 Default Settings for RIPng............................................................................................................................................... 139
4.6 Configuring Basic RIPng Functions............................................................................................................................... 139
4.6.1 Enabling RIPng................................................................................................................................................................. 139
4.6.2 Enabling RIPng on Interfaces...................................................................................................................................... 140
4.6.3 Verifying the Basic RIPng Function Configuration...............................................................................................141
4.7 Preventing Routing Loops............................................................................................................................................... 141
4.7.1 Configuring Split Horizon.............................................................................................................................................141
4.7.2 Configuring Poison Reverse......................................................................................................................................... 142
4.7.3 Verifying the RIPng Routing Loop Prevention Configuration.......................................................................... 143
4.8 Controlling RIPng Routing............................................................................................................................................... 143
4.8.1 Configuring RIPng Preference..................................................................................................................................... 143
4.8.2 Configuring Additional Metrics of an Interface....................................................................................................143
4.8.3 Setting the Maximum Number of Equal-Cost Routes....................................................................................... 144
4.8.4 Verifying the RIPng Routing Control Configuration............................................................................................145
4.9 Controlling RIPng Route Advertisement..................................................................................................................... 145
4.9.1 Configuring RIPng Route Summarization...............................................................................................................145
4.9.2 Advertising a Default Route........................................................................................................................................ 146
4.9.3 Configuring a RIPng Process to Import External Routes................................................................................... 147
4.9.4 Disabling Sending of RIPng Packets on an Interface..........................................................................................148
4.9.5 Disabling Receiving of RIPng Packets on an Interface.......................................................................................148
4.9.6 Verifying the RIPng Route Advertisement Control Configuration..................................................................149
4.10 Controlling the Receiving of RIPng Routes............................................................................................................. 149
4.11 Improving RIPng Network Performance.................................................................................................................. 150
4.11.1 Configuring RIPng Timers.......................................................................................................................................... 150
4.11.2 Setting the Interval for Sending Update Packets and Maximum Number of Sent Packets............... 151
4.11.3 Enabling Zero Field Check for RIPng Packets..................................................................................................... 152
4.11.4 Verifying the RIPng Network Performance Optimization Configuration.................................................. 152
4.12 Configuring IPSec Authentication for RIPng........................................................................................................... 153
4.12.1 Configuring an IPSec Session for Encryption...................................................................................................... 153
4.12.2 Configuring RIPng IPSec Authentication.............................................................................................................. 156
4.12.3 Verifying the RIPng IPSec Authentication Configuration................................................................................ 157
4.13 Clearing RIPng................................................................................................................................................................... 157
4.14 Example for Configuring RIPng to Filter the Received Routes......................................................................... 158
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. ix
5 OSPF Configuration............................................................................................................ 163
5.1 Overview of OSPF.............................................................................................................................................................. 164
5.2 Understanding OSPF......................................................................................................................................................... 165
5.2.1 OSPF Fundamentals....................................................................................................................................................... 165
5.2.1.1 OSPF Characteristics................................................................................................................................................... 165
5.2.1.2 OSPF Mechanism......................................................................................................................................................... 166
5.2.1.3 OSPF Packet Types...................................................................................................................................................... 170
5.2.1.4 OSPF Network Types.................................................................................................................................................. 171
5.2.1.5 DR/BDR Election.......................................................................................................................................................... 172
5.2.1.6 OSPF State Machine................................................................................................................................................... 181
5.2.1.7 OSPF Adjacency Establishment...............................................................................................................................185
5.2.1.8 OSPF Areas.....................................................................................................................................................................190
5.2.1.9 OSPF LSA Types............................................................................................................................................................ 200
5.2.1.10 OSPF Fast Convergence.......................................................................................................................................... 207
5.2.1.11 OSPF Virtual Link...................................................................................................................................................... 209
5.2.1.12 OSPF Route Summarization and Filtering........................................................................................................210
5.2.1.13 OSPF Multi-Process.................................................................................................................................................. 211
5.2.1.14 OSPF RFC 1583 Compatibility............................................................................................................................... 211
5.2.2 Enhanced OSPF Functions........................................................................................................................................... 212
5.2.2.1 OSPF VPN....................................................................................................................................................................... 212
5.2.2.2 OSPF TE...........................................................................................................................................................................218
5.2.2.3 OSPF Security................................................................................................................................................................ 220
5.2.2.4 OSPF GR.......................................................................................................................................................................... 221
5.2.2.5 OSPF Neighbor Relationship Flapping Suppression........................................................................................ 225
5.2.2.6 OSPF Smart-Discover................................................................................................................................................. 232
5.2.2.7 OSPF Database Overflow......................................................................................................................................... 232
5.2.2.8 OSPF Mesh-Group....................................................................................................................................................... 234
5.2.3 Association Between OSPF and Other Protocols................................................................................................. 235
5.3 Application Scenarios for OSPF..................................................................................................................................... 239
5.3.1 OSPF GR............................................................................................................................................................................. 239
5.3.2 OSPF GTSM....................................................................................................................................................................... 239
5.4 OSPF Deployment Guide................................................................................................................................................. 240
5.4.1 OSPF Network Planning and Design........................................................................................................................240
5.4.2 OSPF Network Design Deployment Case............................................................................................................... 243
5.5 Summary of OSPF Configuration Tasks...................................................................................................................... 256
5.6 Licensing Requirements and Limitations for OSPF................................................................................................. 258
5.7 Default Settings for OSPF................................................................................................................................................ 259
5.8 Configuring Basic OSPF Functions................................................................................................................................259
5.8.1 Creating an OSPF Process............................................................................................................................................ 259
5.8.2 Creating an OSPF Area..................................................................................................................................................260
5.8.3 Enabling OSPF.................................................................................................................................................................. 261
5.8.4 (Optional) Creating OSPF Virtual Links.................................................................................................................. 262
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. x
5.8.5 (Optional) Restricting the Flooding of LSA Packets........................................................................................... 263
5.8.6 Verifying the Basic OSPF Function Configuration................................................................................................264
5.9 Configuring Session Parameters for OSPF Neighbor or Adjacency Relationships....................................... 264
5.9.1 Setting an OSPF Packet Retransmission Limit...................................................................................................... 265
5.9.2 Configuring an Interface to Insert the Actual MTU into DD Packets........................................................... 265
5.9.3 Verifying the OSPF Session Parameter Configuration........................................................................................266
5.10 Configuring OSPF Attributes on Different Types of Networks.........................................................................267
5.10.1 Configuring a Network Type for an OSPF Interface.........................................................................................268
5.10.2 Configuring P2MP Network Attributes................................................................................................................. 269
5.10.3 Configuring NBMA Network Attributes................................................................................................................ 270
5.10.4 Verifying the OSPF Attribute Configuration........................................................................................................ 272
5.11 Configuring OSPF Stub Areas...................................................................................................................................... 272
5.11.1 Configuring an Area as a Stub Area...................................................................................................................... 273
5.11.2 Verifying the OSPF Stub Area Configuration...................................................................................................... 274
5.12 Configuring an OSPF NSSA.......................................................................................................................................... 274
5.13 Configuring Local MT..................................................................................................................................................... 277
5.14 Adjusting OSPF Route Selection................................................................................................................................. 279
5.14.1 Setting a Link Cost for an OSPF Interface........................................................................................................... 279
5.14.2 Configuring Equal-Cost Routes................................................................................................................................ 281
5.14.3 Configuring a Route Selection Rule....................................................................................................................... 282
5.14.4 Verifying the OSPF Route Selection Adjustment Configuration...................................................................282
5.15 Controlling OSPF Routing Information.....................................................................................................................283
5.15.1 Configuring OSPF to Import External Routes..................................................................................................... 283
5.15.2 Configuring OSPF to Advertise Default Routes to an OSPF Area................................................................284
5.15.3 Configuring OSPF Route Summarization............................................................................................................. 286
5.15.4 Configuring OSPF to Filter Received Routes....................................................................................................... 287
5.15.5 Configuring OSPF to Filter the Routes to Be Advertised................................................................................ 288
5.15.6 Configuring a Switch to Filter LSAs to Be Sent.................................................................................................. 288
5.15.7 Configuring OSPF to Filter ABR Type3 LSAs........................................................................................................289
5.15.8 (Optional) Enabling the Mesh-Group Function................................................................................................. 290
5.15.9 Setting the Maximum Number of External LSAs in the LSDB...................................................................... 290
5.15.10 Verifying the OSPF Route Control Configuration............................................................................................291
5.16 Configuring BFD for OSPF............................................................................................................................................ 291
5.16.1 Configuring Global BFD..............................................................................................................................................292
5.16.2 Configuring BFD for OSPF......................................................................................................................................... 292
5.16.3 (Optional) Preventing an Interface from Dynamically Setting Up a BFD Session................................ 293
5.16.4 (Optional) Configuring BFD on an Interface...................................................................................................... 294
5.16.5 Verifying the BFD for OSPF Configuration...........................................................................................................296
5.17 Configuring OSPF IP FRR............................................................................................................................................... 296
5.17.1 Enabling OSPF IP FRR................................................................................................................................................. 297
5.17.2 (Optional) Binding OSPF IP FRR and BFD........................................................................................................... 298
5.17.3 (Optional) Disabling OSPF IP FRR on an Interface.......................................................................................... 299
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. xi
5.17.4 Verifying the OSPF IP FRR Configuration............................................................................................................. 300
5.18 Configuring OSPF Fast Convergence......................................................................................................................... 300
5.18.1 Setting a Convergence Priority for OSPF Routes............................................................................................... 301
5.18.2 Setting an Interval for Sending Hello Packets.................................................................................................... 301
5.18.3 Setting a Dead Time for a Neighbor Relationship............................................................................................ 302
5.18.4 Configuring Smart-discover...................................................................................................................................... 303
5.18.5 Setting an Interval for Updating LSAs...................................................................................................................303
5.18.6 Setting an Interval for Receiving LSAs.................................................................................................................. 304
5.18.7 Setting an Interval for SPF Calculations............................................................................................................... 305
5.18.8 Verifying the OSPF Fast Convergence Configuration....................................................................................... 306
5.19 Configuring OSPF GR...................................................................................................................................................... 307
5.19.1 Enabling the Opaque-LSA Capability of OSPF................................................................................................... 307
5.19.2 (Optional) Configuring GR Session Parameters on the Restarter............................................................... 308
5.19.3 (Optional) Configuring GR Session Parameters on the Helper.................................................................... 308
5.19.4 Verifying the OSPF GR Configuration.................................................................................................................... 309
5.20 Improving Stability of an OSPF Network................................................................................................................ 309
5.20.1 Setting a Priority for OSPF Routes..........................................................................................................................309
5.20.2 Configuring an LSA Transmission Delay on an Interface................................................................................310
5.20.3 Configuring an Interval for Retransmitting LSAs Between Adjacent Switches....................................... 310
5.20.4 Configuring a Stub Router.........................................................................................................................................311
5.20.5 Prohibiting an OSPF Interface from Sending and Receiving Protocol Packets....................................... 312
5.20.6 Disabling the Function of Triggering Active/Standby Board Switchover upon Abnormal OSPF LSA
Aging.............................................................................................................................................................................................. 312
5.20.7 Verifying the OSPF Network Stability Optimization Configuration............................................................ 313
5.21 Improving the Security of an OSPF Network......................................................................................................... 314
5.21.1 Configuring OSPF GTSM............................................................................................................................................ 314
5.21.2 Configuring an Area Authentication Mode......................................................................................................... 315
5.21.3 Configuring an Interface Authentication Mode................................................................................................. 317
5.21.4 Verifying the OSPF Network Security Optimization Configuration............................................................ 318
5.22 Configuring OSPF Neighbor Relationship Flapping Suppression.................................................................... 318
5.23 Suppressing the Advertisement of Interface IP Addresses.................................................................................321
5.24 Configuring Network Management for OSPF........................................................................................................322
5.24.1 Configuring OSPF MIB Binding................................................................................................................................ 322
5.24.2 Configuring the OSPF Trap Function..................................................................................................................... 322
5.24.3 Configuring the OSPF Log Function.......................................................................................................................323
5.24.4 Verifying the OSPF Network Management Configuration.............................................................................323
5.25 Maintaining OSPF............................................................................................................................................................ 323
5.25.1 Clearing OSPF Information....................................................................................................................................... 323
5.25.2 Resetting OSPF Information..................................................................................................................................... 324
5.26 Configuration Examples for OSPF.............................................................................................................................. 324
5.26.1 Example for Configuring Basic OSPF Functions.................................................................................................325
5.26.2 Example for Configuring OSPF DR Election........................................................................................................ 328
5.26.3 Example for Configuring OSPF Stub Areas.......................................................................................................... 334
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. xii
5.26.4 Example for Configuring an OSPF NSSA.............................................................................................................. 338
5.26.5 Example for Configuring OSPF Load Balancing.................................................................................................343
5.26.6 Example for Configuring OSPF-BGP Synchronization...................................................................................... 348
5.26.7 Example for Configuring OSPF GR......................................................................................................................... 356
5.26.8 Example for Configuring BFD for OSPF................................................................................................................ 361
5.26.9 Example for Configuring OSPF IP FRR.................................................................................................................. 366
5.26.10 Example for Configuring Local OSPF MT.......................................................................................................... 370
5.27 Troubleshooting OSPF.................................................................................................................................................... 379
5.27.1 An OSPF Neighbor Relationship Cannot Be Established................................................................................ 379
5.27.2 OSPF Cannot Discover Routes of a Non-Local Area........................................................................................ 381
6 OSPFv3 Configuration........................................................................................................ 383
6.1 Overview of OSPFv3.......................................................................................................................................................... 384
6.2 Understanding OSPFv3.....................................................................................................................................................384
6.2.1 OSPFv3 Fundamentals.................................................................................................................................................. 384
6.2.2 OSPFv3 GR.........................................................................................................................................................................391
6.2.3 OSPFv3-BGP Synchronization..................................................................................................................................... 394
6.2.4 OSPFv3 Neighbor Relationship Flapping Suppression....................................................................................... 395
6.2.5 OSPFv3 and OSPFv2 Comparison..............................................................................................................................400
6.3 Summary of OSPFv3 Configuration Tasks................................................................................................................. 401
6.4 Licensing Requirements and Limitations for OSPFv3............................................................................................ 404
6.5 Default Settings for OSPFv3........................................................................................................................................... 404
6.6 Configuring Basic OSPFv3 Functions........................................................................................................................... 405
6.6.1 Enabling OSPFv3............................................................................................................................................................. 405
6.6.2 Enabling OSPFv3 on an Interface.............................................................................................................................. 406
6.6.3 Entering an OSPFv3 Area View.................................................................................................................................. 407
6.6.4 (Optional) Configuring a Route Selection Rule....................................................................................................408
6.6.5 Verifying the Basic OSPFv3 Function Configuration........................................................................................... 408
6.7 Establishing and Maintaining an OSPFv3 Neighbor Relationship.....................................................................409
6.7.1 Configuring an Interval at Which Hello Packets are Sent................................................................................ 409
6.7.2 Configuring a Dead Time for a Neighbor Relationship..................................................................................... 410
6.7.3 Configuring an LSA Retransmission Interval......................................................................................................... 411
6.7.4 Configuring an LSA Transmission Delay................................................................................................................. 411
6.7.5 Verifying the OSPFv3 Neighbor Relationship Establishment and Maintenance Configuration...........412
6.8 Configuring an OSPFv3 Area.......................................................................................................................................... 412
6.8.1 Configuring an OSPFv3 Stub Area............................................................................................................................ 413
6.8.2 Configuring OSPFv3 Virtual Links............................................................................................................................. 413
6.8.3 Verifying the OSPFv3 Area Configuration.............................................................................................................. 414
6.9 Configuring an OSPFv3 NSSA........................................................................................................................................ 415
6.9.1 Defining an Area as an NSSA..................................................................................................................................... 415
6.9.2 Verifying the OSPFv3 NSSA Configuration.............................................................................................................416
6.10 Configuring OSPFv3 Route Attributes.......................................................................................................................416
6.10.1 Setting a Cost for an OSPFv3 Interface................................................................................................................ 416
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. xiii
6.10.2 Setting the Maximum Number of Equal-Cost Routes..................................................................................... 417
6.10.3 Verifying the OSPFv3 Route Attribute Configuration...................................................................................... 417
6.11 Controlling OSPFv3 Routing Information................................................................................................................ 418
6.11.1 Configuring OSPFv3 Route Summarization.........................................................................................................418
6.11.2 Configuring OSPFv3 to Filter the Received Routes........................................................................................... 419
6.11.3 Configuring OSPFv3 to Import External Routes................................................................................................ 420
6.11.4 (Optional) Configuring OSPFv3 to Filter LSAs in an Area............................................................................. 421
6.11.5 Verifying the OSPFv3 Route Control Configuration..........................................................................................421
6.12 Optimizing an OSPFv3 Network................................................................................................................................. 422
6.12.1 Configuring an SPF Timer.......................................................................................................................................... 422
6.12.2 Suppressing an Interface from Sending and Receiving OSPFv3 Packets...................................................423
6.12.3 Configuring a DR Priority for an Interface...........................................................................................................424
6.12.4 Configuring a Stub Router.........................................................................................................................................425
6.12.5 Ignoring MTU Check on DD Packets..................................................................................................................... 425
6.12.6 Verifying the OSPFv3 Network Optimization Configuration.........................................................................426
6.13 Configuring BFD for OSPFv3........................................................................................................................................ 426
6.13.1 Configuring BFD Globally.......................................................................................................................................... 427
6.13.2 Configuring BFD for OSPFv3.................................................................................................................................... 428
6.13.3 (Optional) Preventing an Interface from Dynamically Setting Up a BFD Session................................ 428
6.13.4 (Optional) Configuring BFD for a Specified Interface..................................................................................... 429
6.13.5 Verifying the BFD for OSPFv3 Configuration...................................................................................................... 430
6.14 Configuring OSPFv3 IP FRR.......................................................................................................................................... 430
6.14.1 Enabling OSPFv3 IP FRR............................................................................................................................................. 431
6.14.2 (Optional) Disabling OSPFv3 IP FRR on an Interface...................................................................................... 432
6.14.3 Verifying the OSPFv3 IP FRR Configuration........................................................................................................ 432
6.15 Configuring OSPFv3 GR................................................................................................................................................. 432
6.15.1 Enabling OSPFv3 GR....................................................................................................................................................433
6.15.2 Enabling the OSPFv3 GR Helper............................................................................................................................. 433
6.15.3 Verifying the OSPFv3 GR Configuration............................................................................................................... 434
6.16 Improving OSPFv3 Network Security........................................................................................................................ 434
6.16.1 Configuring OSPFv3 GTSM........................................................................................................................................435
6.16.2 Configuring an Authentication Mode....................................................................................................................436
6.16.3 Verifying the OSPFv3 Network Security Optimization Configuration........................................................437
6.17 Configuring OSPFv3 Neighbor Relationship Flapping Suppression................................................................437
6.18 Configuring OSPFv3 IPSec.............................................................................................................................................440
6.18.1 Configuring an IPSec Session for Encryption...................................................................................................... 440
6.18.2 Configuring OSPFv3 IPSec Authentication...........................................................................................................443
6.18.3 Verifying the OSPFv3 IPSec Configuration...........................................................................................................445
6.19 Configuring the Network Management Function of OSPFv3.......................................................................... 445
6.19.1 Configuring OSPFv3 MIB Binding........................................................................................................................... 446
6.19.2 Configuring OSPFv3 Trap........................................................................................................................................... 446
6.19.3 Verifying the OSPFv3 Network Management Function Configuration......................................................447
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. xiv
6.20 Resetting OSPFv3............................................................................................................................................................. 447
6.21 Configuration Examples for OSPFv3......................................................................................................................... 447
6.21.1 Example for Configuring an OSPFv3 Stub Area................................................................................................. 447
6.21.2 Example for Configuring DR Election Through OSPFv3..................................................................................452
6.21.3 Example for Configuring an OSPFv3 Virtual Link............................................................................................. 458
6.21.4 Example for Configuring OSPFv3 GR.....................................................................................................................462
6.21.5 Example for Configuring BFD for OSPFv3........................................................................................................... 466
7 IPv4 IS-IS Configuration.................................................................................................... 473
7.1 Overview of IS-IS................................................................................................................................................................ 474
7.2 Understanding IS-IS........................................................................................................................................................... 474
7.2.1 Basic Concepts of IS-IS.................................................................................................................................................. 474
7.2.2 IS-IS Fundamentals.........................................................................................................................................................481
7.2.3 IS-IS Authentication....................................................................................................................................................... 486
7.2.4 IS-IS Route Leaking........................................................................................................................................................ 488
7.2.5 IS-IS Overload.................................................................................................................................................................. 489
7.2.6 IS-IS Network Convergence......................................................................................................................................... 490
7.2.7 IS-IS Neighbor Relationship Flapping Suppression............................................................................................. 491
7.2.8 IS-IS Administrative Tag................................................................................................................................................ 498
7.2.9 IS-IS Wide Metric............................................................................................................................................................ 499
7.2.10 IS-IS LSP Fragment Extension...................................................................................................................................500
7.2.11 IS-IS Host Name Mapping......................................................................................................................................... 503
7.2.12 IS-IS GR............................................................................................................................................................................ 504
7.2.13 BFD for IS-IS................................................................................................................................................................... 510
7.2.14 IS-IS Auto FRR................................................................................................................................................................ 513
7.2.15 IS-IS TE............................................................................................................................................................................. 517
7.2.16 IS-IS Local MT................................................................................................................................................................ 521
7.2.17 IS-IS Multi-Instance and Multi-Process................................................................................................................. 524
7.3 Default Settings for IPv4 IS-IS........................................................................................................................................525
7.4 Summary of IPv4 IS-IS Configuration Tasks.............................................................................................................. 525
7.5 Licensing Requirements and Limitations for IPv4 IS-IS......................................................................................... 530
7.6 Configure Basic IS-IS Functions..................................................................................................................................... 530
7.6.1 Creating IS-IS Processes................................................................................................................................................ 531
7.6.2 Configuring a NET.......................................................................................................................................................... 531
7.6.3 Configuring the Device Level...................................................................................................................................... 532
7.6.4 Establishing IS-IS Neighbor Relationships.............................................................................................................. 533
7.6.5 Verifying the Basic IS-IS Function Configuration................................................................................................. 537
7.7 Improving IS-IS Network Security.................................................................................................................................537
7.7.1 Configuring Interface Authentication...................................................................................................................... 537
7.7.2 Configuring Area or Domain Authentication........................................................................................................ 539
7.7.3 Configuring the Optional Checksum........................................................................................................................ 540
7.7.4 Verifying the IS-IS Network Security Optimization Configuration................................................................ 541
7.8 Controlling IS-IS Route Selection.................................................................................................................................. 541
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. xv
7.8.1 Configuring a Preference Value for IS-IS................................................................................................................ 541
7.8.2 Configuring the Cost of an IS-IS Interface............................................................................................................. 542
7.8.3 Configuring Equal-Cost IS-IS Routes........................................................................................................................ 544
7.8.4 Configuring IS-IS Route Leaking................................................................................................................................ 546
7.8.5 Controlling Whether a Level-1 Device Generates a IPv4 Default Route..................................................... 547
7.8.6 Verifying the IS-IS Route Selection Control Configuration............................................................................... 548
7.9 Controlling IS-IS Route Exchange................................................................................................................................. 548
7.9.1 Configuring IS-IS to Advertise a Default Route.................................................................................................... 548
7.9.2 Configuring IS-IS to Import External Routes......................................................................................................... 549
7.9.3 Configuring IS-IS to Advertise Specified External Routes to an IS-IS Routing Domain..........................550
7.9.4 Adding Specified IS-IS Routes to the IP Routing Table...................................................................................... 550
7.9.5 Verifying the IS-IS Route Exchange Control Configuration.............................................................................. 551
7.10 Configuring IS-IS Route Summarization.................................................................................................................. 551
7.11 Controlling IS-IS Route Convergence........................................................................................................................ 552
7.11.1 Configuring Attributes for Hello Packets..............................................................................................................552
7.11.2 Configuring Attributes for LSPs............................................................................................................................... 553
7.11.3 Configuring Attributes for CSNPs............................................................................................................................559
7.11.4 Setting the SPF Calculation Interval...................................................................................................................... 559
7.11.5 Configuring Convergence Priorities for IS-IS Routes........................................................................................ 560
7.11.6 Verifying the IS-IS Route Convergence Control Configuration..................................................................... 561
7.12 Configuring LSP Fragment Extension........................................................................................................................561
7.13 Configuring a Mesh Group on an NBMA Network.............................................................................................. 563
7.14 Configuring IS-IS Reliability.......................................................................................................................................... 563
7.14.1 Configuring Static BFD for IS-IS.............................................................................................................................. 564
7.14.2 Configuring Dynamic BFD for IS-IS........................................................................................................................ 566
7.14.3 Enabling IS-IS GR.......................................................................................................................................................... 568
7.15 Configuring IPv4 IS-IS Auto FRR................................................................................................................................. 569
7.15.1 Enabling IPv4 IS-IS Auto FRR....................................................................................................................................569
7.15.2 (Optional) Disabling an Interface from Being Involved in IPv4 LFA Calculation................................... 570
7.15.3 Verifying the IPv4 IS-IS Auto FRR Configuration............................................................................................... 570
7.16 Configuring the Overload Bit for an IS-IS Device................................................................................................. 571
7.17 Configuring IS-IS Neighbor Relationship Flapping Suppression...................................................................... 571
7.18 Maintaining IS-IS.............................................................................................................................................................. 574
7.18.1 Resetting IS-IS................................................................................................................................................................ 574
7.18.2 Improving the Maintainability of IS-IS.................................................................................................................. 575
7.18.3 Configuring the Output of IS-IS Adjacency Status............................................................................................576
7.19 Configuration Examples for IPv4 IS-IS...................................................................................................................... 576
7.19.1 Example for Configuring Basic IS-IS Functions.................................................................................................. 576
7.19.2 Example for Configuring IS-IS Route Summarization......................................................................................582
7.19.3 Example for Configuring DIS Election................................................................................................................... 586
7.19.4 Example for Configuring IS-IS Load Balancing.................................................................................................. 592
7.19.5 Example for Configuring IS-IS Auto FRR (IP Protecting IP)........................................................................... 597
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. xvi
7.19.6 Example for Configuring Static BFD for IS-IS..................................................................................................... 605
7.19.7 Example for Configuring Dynamic BFD for IS-IS............................................................................................... 610
7.19.8 Example for Configuring IS-IS GR........................................................................................................................... 617
7.20 Troubleshooting IPv4 IS-IS............................................................................................................................................ 620
7.20.1 Failed to Establish IS-IS Neighbor Relationships............................................................................................... 621
7.20.2 A Device Cannot Learn IS-IS Routes from Its Neighbor..................................................................................622
8 IPv6 IS-IS Configuration.................................................................................................... 624
8.1 Overview of IS-IS................................................................................................................................................................ 624
8.2 Understanding IPv6 IS-IS................................................................................................................................................. 625
8.2.1 IPv6 IS-IS............................................................................................................................................................................ 625
8.3 Summary of IPv6 IS-IS Configuration Tasks.............................................................................................................. 625
8.4 Licensing Requirements and Limitations for IPv6 IS-IS......................................................................................... 629
8.5 Default Settings for IPv6 IS-IS........................................................................................................................................630
8.6 Configuring Basic IPv6 IS-IS Functions........................................................................................................................630
8.6.1 Creating an IS-IS Process.............................................................................................................................................. 631
8.6.2 Configuring a NET and Enabling IPv6 IS-IS........................................................................................................... 631
8.6.3 Configuring a Device Level.......................................................................................................................................... 632
8.6.4 Establishing an IS-IS Neighbor Relationship......................................................................................................... 633
8.6.5 Verifying the Basic IPv6 IS-IS Function Configuration........................................................................................636
8.7 Improving IPv6 IS-IS Network Security....................................................................................................................... 636
8.7.1 Configuring Interface Authentication...................................................................................................................... 636
8.7.2 Configuring Area or Domain Authentication........................................................................................................ 638
8.7.3 Configuring the Optional Checksum........................................................................................................................ 640
8.7.4 Verifying the IPv6 IS-IS Network Security Optimization Configuration.......................................................641
8.8 Controlling IPv6 IS-IS Route Selection........................................................................................................................ 641
8.8.1 Configuring a Preference Value for IPv6 IS-IS.......................................................................................................641
8.8.2 Configuring a Cost for IS-IS Interfaces on an IPv6 Network........................................................................... 642
8.8.3 Configuring Equal-Cost IPv6 IS-IS Routes.............................................................................................................. 644
8.8.4 Configuring IS-IS IPv6 Route Leaking...................................................................................................................... 645
8.8.5 Controlling Whether a Level-1 Device Generates an IPv6 Default Route...................................................646
8.8.6 Verifying the IPv6 IS-IS Route Selection Control Configuration..................................................................... 647
8.9 Controlling IPv6 IS-IS Route Exchange........................................................................................................................647
8.9.1 Configuring IS-IS to Advertise a Default Route.................................................................................................... 648
8.9.2 Configuring IS-IS to Import External Routes......................................................................................................... 648
8.9.3 Configuring IS-IS to Advertise Specified External Routes to an IS-IS Routing Domain..........................649
8.9.4 Adding Specified IS-IS Routes to an IPv6 Routing Table................................................................................... 650
8.9.5 Verifying the IPv6 IS-IS Route Exchange Control Configuration.....................................................................650
8.10 Configuring IPv6 IS-IS Route Summarization........................................................................................................ 650
8.11 Controlling IPv6 IS-IS Route Convergence...............................................................................................................651
8.11.1 Configuring Attributes for Hello Packets..............................................................................................................651
8.11.2 Configuring Attributes for LSPs............................................................................................................................... 653
8.11.3 Configuring Attributes for CSNPs............................................................................................................................658
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. xvii
8.11.4 Setting an SPF Calculation Interval........................................................................................................................ 659
8.11.5 Configuring Convergence Priorities for IS-IS Routes........................................................................................ 660
8.11.6 Verifying the IPv6 IS-IS Route Convergence Control Configuration............................................................661
8.12 Configuring LSP Fragment Extension........................................................................................................................661
8.13 Configuring a Mesh Group on an NBMA Network.............................................................................................. 662
8.14 Configuring IPv6 IS-IS Reliability................................................................................................................................ 663
8.14.1 Configuring Dynamic BFD for IPv6 IS-IS.............................................................................................................. 663
8.15 Configuring the Overload Bit for an IS-IS Device................................................................................................. 666
8.16 Maintaining IS-IS.............................................................................................................................................................. 666
8.16.1 Resetting IS-IS................................................................................................................................................................ 667
8.16.2 Improving the Maintainability of IS-IS.................................................................................................................. 667
8.16.3 Configuring the Output of IS-IS Adjacency Status............................................................................................668
8.17 Configuration Examples for IPv6 IS-IS...................................................................................................................... 669
8.17.1 Example for Configuring Basic IPv6 IS-IS Functions.........................................................................................669
8.17.2 Example for Configuring Dynamic BFD for IPv6 IS-IS..................................................................................... 675
9 BGP Configuration.............................................................................................................. 682
9.1 Overview of BGP................................................................................................................................................................. 682
9.2 Understanding BGP........................................................................................................................................................... 683
9.2.1 Basic Concepts of BGP................................................................................................................................................... 683
9.2.2 BGP Fundamentals......................................................................................................................................................... 685
9.2.3 Interaction Between BGP and IGPs........................................................................................................................... 688
9.2.4 BGP Security......................................................................................................................................................................690
9.2.5 BGP Route Selection Rules and Load Balancing.................................................................................................. 690
9.2.6 Route Reflector................................................................................................................................................................ 694
9.2.7 BGP Confederation......................................................................................................................................................... 699
9.2.8 Route Summarization.................................................................................................................................................... 700
9.2.9 Route Dampening........................................................................................................................................................... 701
9.2.10 BFD for BGP.................................................................................................................................................................... 701
9.2.11 BGP Tracking.................................................................................................................................................................. 702
9.2.12 BGP GR............................................................................................................................................................................. 703
9.2.13 Dynamic Update Peer-Groups..................................................................................................................................703
9.2.14 MP-BGP and Address Families................................................................................................................................. 706
9.2.15 BGP VPN Route Crossing........................................................................................................................................... 714
9.2.16 Route Processing on the BGP router......................................................................................................................718
9.2.17 BGP Routing Table....................................................................................................................................................... 719
9.2.18 Route Attributes............................................................................................................................................................ 724
9.2.18.1 BGP Route Attributes............................................................................................................................................... 724
9.2.18.2 Next_Hop..................................................................................................................................................................... 728
9.2.18.3 PrefVal........................................................................................................................................................................... 734
9.2.18.4 Local_Pref..................................................................................................................................................................... 739
9.2.18.5 Route Type................................................................................................................................................................... 752
9.2.18.6 AS_Path......................................................................................................................................................................... 755
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. xviii
9.2.18.7 Origin.............................................................................................................................................................................763
9.2.18.8 MED............................................................................................................................................................................... 766
9.2.18.9 Peer Type...................................................................................................................................................................... 774
9.2.18.10 IGP Cost...................................................................................................................................................................... 775
9.2.18.11 Cluster_List................................................................................................................................................................ 778
9.2.18.12 Originator_ID............................................................................................................................................................ 780
9.2.18.13 BGP Router ID.......................................................................................................................................................... 783
9.2.18.14 Peer IP Address........................................................................................................................................................ 783
9.3 Summary of BGP Configuration Tasks........................................................................................................................ 785
9.4 Licensing Requirements and Limitations for BGP................................................................................................... 791
9.5 Default Settings for BGP.................................................................................................................................................. 792
9.6 Configuring Basic BGP Functions.................................................................................................................................. 792
9.6.1 Starting a BGP Process.................................................................................................................................................. 792
9.6.2 Configuring BGP Peers.................................................................................................................................................. 793
9.6.3 (Optional) Configuring a BGP Peer Group.............................................................................................................794
9.6.4 (Optional) Configuring Dynamic BGP Peers......................................................................................................... 796
9.6.5 Configuring BGP to Import Routes........................................................................................................................... 798
9.6.6 Verifying the Basic BGP Function Configuration.................................................................................................. 799
9.7 Configuring BGP Security................................................................................................................................................ 799
9.7.1 Configuring MD5 Authentication.............................................................................................................................. 800
9.7.2 Configuring Keychain Authentication...................................................................................................................... 801
9.7.3 Configuring BGP GTSM................................................................................................................................................. 801
9.7.4 Verifying the BGP Security Configuration...............................................................................................................802
9.8 Simplifying IBGP Network Connections......................................................................................................................802
9.8.1 Configuring a BGP Route Reflector.......................................................................................................................... 803
9.8.2 Configuring a BGP Confederation............................................................................................................................. 804
9.9 Configuring BGP Route Selection and Load Balancing......................................................................................... 805
9.9.1 Configuring the BGP Priority....................................................................................................................................... 805
9.9.2 Configuring the Next_Hop Attribute........................................................................................................................ 806
9.9.3 Configuring the PrefVal Attribute............................................................................................................................. 808
9.9.4 Configuring the Default Local_Pref Attribute....................................................................................................... 808
9.9.5 Configuring the AS_Path Attribute........................................................................................................................... 809
9.9.6 Configuring the MED Attribute.................................................................................................................................. 812
9.9.7 Configuring the BGP Community Attribute........................................................................................................... 813
9.9.8 Configuring BGP Load Balancing.............................................................................................................................. 815
9.9.9 Verifying the BGP Route Selection and Load Balancing Configuration....................................................... 816
9.10 Controlling the Receiving and Advertisement of BGP Routes.......................................................................... 817
9.10.1 Configuring a Routing Policy.................................................................................................................................... 817
9.10.2 Controlling the Advertisement of BGP Routes................................................................................................... 818
9.10.3 Controlling the Receiving of BGP Routes............................................................................................................. 819
9.10.4 Configuring BGP Soft Reset...................................................................................................................................... 821
9.10.5 Verifying the BGP Route Receiving and Advertisement Configuration......................................................823
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. xix
9.11 Adjusting the BGP Network Convergence Speed..................................................................................................824
9.11.1 Configuring a BGP ConnectRetry Timer............................................................................................................... 824
9.11.2 Configuring BGP Keepalive and Hold Timers..................................................................................................... 825
9.11.3 Configuring an Update Message Timer................................................................................................................ 826
9.11.4 Disabling Rapid EBGP Connection Reset.............................................................................................................. 827
9.11.5 Configuring the BGP Next Hop Delayed Response...........................................................................................828
9.11.6 Configuring BGP Route Dampening...................................................................................................................... 829
9.11.7 Configuring Slow Peer Detection............................................................................................................................ 830
9.11.8 Verifying the BGP Network Convergence Speed Adjustment Configuration........................................... 831
9.12 Configuring BGP Reliability.......................................................................................................................................... 832
9.12.1 Enabling BGP Tracking................................................................................................................................................ 832
9.12.2 Configuring BFD for BGP........................................................................................................................................... 833
9.12.3 Configuring BGP GR.....................................................................................................................................................834
9.13 Configuring BGP Route Summarization................................................................................................................... 835
9.14 Configuring BGP to Advertise Default Routes to Peers...................................................................................... 837
9.15 Configuring MP-BGP....................................................................................................................................................... 838
9.16 Maintaining BGP.............................................................................................................................................................. 839
9.16.1 Configuring Alarm and Clear Alarm Thresholds for the Number of BGP Routes..................................839
9.16.2 Resetting BGP Connections....................................................................................................................................... 840
9.16.3 Clearing BGP Statistics................................................................................................................................................ 841
9.17 Configuration Examples for BGP................................................................................................................................ 841
9.17.1 Example for Configuring Basic BGP Functions................................................................................................... 841
9.17.2 Example for Configuring Basic BGP4+ Functions.............................................................................................. 847
9.17.3 Example for Configuring Basic MBGP Functions............................................................................................... 853
9.17.4 Example for Configuring BGP to Interact with an IGP.................................................................................... 862
9.17.5 Example for Configuring AS_Path Filter............................................................................................................... 866
9.17.6 Example for Configuring MED Attributes to Control BGP Route Selection..............................................871
9.17.7 Example for Configuring a BGP Route Reflector............................................................................................... 876
9.17.8 Example for Configuring a BGP4+ Route Reflector.......................................................................................... 881
9.17.9 Example for Configuring a BGP Confederation..................................................................................................887
9.17.10 Example for Configuring the BGP Community Attribute............................................................................. 894
9.17.11 Example for Configuring BGP Load Balancing.................................................................................................898
9.17.12 Example for Configuring a BGP Routing Policy............................................................................................... 904
9.17.13 Example for Configuring BFD for BGP................................................................................................................ 924
9.17.14 Example for Configuring BFD for BGP4+........................................................................................................... 929
9.17.15 Example for Configuring BGP GTSM................................................................................................................... 935
10 Routing Policy Configuration.........................................................................................945
10.1 Overview of Routing Policies....................................................................................................................................... 945
10.2 Understanding Routing Policies.................................................................................................................................. 947
10.2.1 Routing Policy Fundamentals................................................................................................................................... 947
10.2.2 IP Prefix List.................................................................................................................................................................... 951
10.2.3 Route-Policy Implementation and Applications................................................................................................ 956
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. xx
10.2.4 Filter-Policy Implementation and Applications.................................................................................................. 959
10.2.5 AS_Path Filter Applications in BGP......................................................................................................................... 968
10.2.6 Community Attribute Applications in BGP.......................................................................................................... 975
10.3 Summary of Routing Policy Configuration Tasks..................................................................................................981
10.4 Licensing Requirements and Limitations for Routing Policies..........................................................................984
10.5 Configuring Filters........................................................................................................................................................... 984
10.5.1 Configuring an IP Prefix List..................................................................................................................................... 984
10.5.2 Configuring an AS_Path Filter.................................................................................................................................. 985
10.5.3 Configuring a Community Filter..............................................................................................................................986
10.5.4 Configuring an Extended Community Filter........................................................................................................987
10.5.5 Configuring an RD Filter............................................................................................................................................ 987
10.6 Configuring a Routing Policy....................................................................................................................................... 988
10.6.1 Creating a Routing Policy.......................................................................................................................................... 988
10.6.2 (Optional) Configuring an if-match Clause........................................................................................................ 989
10.6.3 (Optional) Configuring an apply Clause.............................................................................................................. 991
10.6.4 (Optional) Enabling Further Route Matching Against a Specified Node................................................. 992
10.6.5 Applying a Route-Policy............................................................................................................................................. 993
10.6.6 Verifying the Routing Policy Configuration.......................................................................................................1007
10.7 Configuring Filter-Policy.............................................................................................................................................. 1007
10.7.1 Applying Filters to Received Routes.....................................................................................................................1007
10.7.2 Applying Filters to Advertised Routes................................................................................................................. 1010
10.8 Controlling the Valid Time of Routing Policies................................................................................................... 1013
10.9 Maintaining Routing Policies..................................................................................................................................... 1014
10.10 Configuration Examples for Routing Policies.................................................................................................... 1014
10.10.1 Example for Filtering the Routes to Be Received or Advertised.............................................................. 1014
10.10.2 Example for Applying a Routing Policy for Importing Routes................................................................. 1019
11 IP Routing Table Management................................................................................... 1025
11.1 Licensing Requirements and Limitations for IP Routing Table Management.......................................... 1025
11.2 Managing IP Routing Tables...................................................................................................................................... 1026
11.2.1 Displaying and Maintaining an IP Routing Table........................................................................................... 1026
11.2.2 Displaying and Maintaining the Routing Management Module...............................................................1027
11.2.3 Displaying and Maintaining FIB Tables.............................................................................................................. 1029
11.2.4 Configuring IP FRR on the Public Network....................................................................................................... 1032
11.2.5 Configuring IPv6 FRR on the Public Network.................................................................................................. 1034
11.2.6 Configuring the ECMP Load Balancing Mode.................................................................................................. 1035
11.2.7 Configuring the Advertisement of IPv4 ARP Vlink Direct Routes..............................................................1036
11.3 Example for Configuring IP FRR on the Public Network................................................................................. 1038
12 PBR Configuration.......................................................................................................... 1043
12.1 Overview of PBR............................................................................................................................................................ 1043
12.2 Licensing Requirements and Limitations for PBR...............................................................................................1044
12.3 Configuring PBR............................................................................................................................................................. 1045
12.4 Configuring NQA for PBR........................................................................................................................................... 1048
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. xxi
12.5 (Optional) Configuring PBR to Take Precedence over Blackhole Routes...................................................1051
12.6 Configuration Examples for PBR.............................................................................................................................. 1052
12.6.1 Example for Configuring PBR Based on IP Addresses................................................................................... 1052
12.6.2 Example for Configuring PBR.................................................................................................................................1056
12.6.3 Example for Configuring PBR to Import Traffic to the Firewall in Bypass Mode.................................1059
12.6.4 Example for Configuring NQA for PBR............................................................................................................... 1063
13 Route Monitoring Group Configuration....................................................................1069
13.1 Overview of Route Monitoring Groups.................................................................................................................. 1069
13.2 Application Scenarios for Route Monitoring Groups.........................................................................................1070
13.2.1 Preventing Network Congestion........................................................................................................................... 1070
13.2.2 Preventing Traffic Loss..............................................................................................................................................1071
13.3 Understanding Route Monitoring Groups.............................................................................................................1072
13.4 Licensing Requirements and Limitations for Route Monitoring Group...................................................... 1073
13.5 Configuring Association Between IPv4 Static Routes and a Route Monitoring Group......................... 1073
13.6 Example for Configuring Association Between IPv4 Static Routes and a Route Monitoring Group 1075
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing Contents
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. xxii
1 IP Routing
1.1 Overview of IP Routing
1.2 Understanding IP Routing
1.1 Overview of IP Routing
Routing is the basic element of data communications networks. It is the process of
selecting paths on a network along which packets are sent from a source to a
destination.
According to the destination address, routes are classified into one of the
following types:
● Network segment route
The destination is a network segment. In this case, if the destination is an
IPv4 address, the subnet mask is less than 32 bits, and if the destination is an
IPv6 address, the prefix length is less than 128 bits.
● Host route
The destination is a host. In this case, if the destination is an IPv4 address, the
subnet mask is 32 bits, and if the destination is an IPv6 address, the prefix
length is 128 bits.
According to whether the destination directly connects to a router, routes are
classified into one of the following types:
● Direct route
The router directly connects to the network where the destination is located.
● Indirect route
The router indirectly connects to the network where the destination is located.
According to the destination address type, routes are classified into one of the
following types:
● Unicast route
The destination address is a unicast address.
● Multicast route
The destination address is a multicast address.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1
1.2 Understanding IP Routing
1.2.1 Routers and Routing
On the Internet, network connecting devices such as hubs, bridges, switches, and
routers control traffic and ensure data transmission quality. Each of these devices
serves as a different role, but for a common purpose: forming a functioning
network. The following describes a router's role in a network, and the purpose and
nature of routes.
A router selects routes and forwards packets. Upon receiving a packet, a router
selects a proper path, which may have one or more hops, to send the packet to
the next router according to the destination address in the packet. The last router
is responsible for sending the packet to the destination host.
A route is a path along which packets are sent from the source to the destination.
When multiple routes are available to send packets from a router to the
destination, the router can select the optimal route from an IP routing table.
Optimal route selection depends on routing protocol preferences and metrics of
routes. When multiple routes have the same routing protocol preference and
metric, load balancing can be implemented among these routes to relieve network
pressure. When multiple routes have different routing protocol preferences and
metrics, route backup can be implemented among these routes to improve
network reliability.
1.2.2 Static Routes and Dynamic Routes
Routers support direct, static, and dynamic routes. Dynamic routes include Routing
Information Protocol (RIP) routes, Open Shortest Path First (OSPF) routes,
Intermediate System-to-Intermediate System (IS-IS) routes, and Border Gateway
Protocol (BGP) routes.
Differences Between Static Routes and Dynamic Routes
Routing protocols are the rules used by routers to discover routes, generate
routing tables, and guide packet forwarding. Routes are classified into the
following types according to their origin:
● Direct routes: are discovered by link layer protocols.
● Static routes: are manually configured by network administrators.
● Dynamic routes: are discovered by dynamic routing protocols.
Static routes are easy to configure, have low system requirements, and apply to
simple, stable, and small networks. The disadvantage of static routes is that they
require subsequent maintenance as they cannot automatically adapt to network
topology changes.
Dynamic routing protocols have routing algorithms. Therefore, dynamic routes can
automatically adapt to network topology changes and apply to networks on which
Layer 3 devices are deployed. The disadvantages of dynamic routes are that they
are complex to configure, have higher system requirements than static ones, and
consume network and system resources.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 2
Classification of Dynamic Routing Protocols
Dynamic routing protocols are classified based on the following two criteria.
According to the application range, dynamic routing protocols are classified into
the following types:
● Interior Gateway Protocols (IGPs)
Run inside an autonomous system (AS), including RIP, OSPF, and IS-IS.
● Exterior Gateway Protocols (EGPs)
Run between ASs, including BGP (most widely used EGP).
According to the type of algorithm they use, dynamic routing protocols are
classified into the following types:
● Distance-vector routing protocols
Include RIP and BGP. BGP is also called a path-vector protocol.
● Link-state routing protocols
Include OSPF and IS-IS.
The preceding algorithms differ mainly in route discovery and calculation
methods.
1.2.3 Routing Table and FIB Table
Routers forward packets based on routing tables and forwarding information base
(FIB) tables. Each router maintains at least one routing table and one FIB table.
Routers select routes based on routing tables and forward packets based on FIB
tables.
Routing Table
Each router maintains a local core routing table (namely, an IP routing table), and
each routing protocol maintains its own routing table.
● Local core routing table
A router uses the local core routing table to store preferred routes. The router
then sends the preferred routes to the FIB table to guide packet forwarding.
The router selects routes according to routing protocol preferences and costs
stored in the routing table.
● Protocol routing table
A protocol routing table stores routing information discovered by the protocol.
A routing protocol can import and advertise routes that are discovered by
other routing protocols. For example, a router runs the Open Shortest Path
First (OSPF) protocol. To use OSPF to advertise direct routes, static routes, or
Intermediate System-Intermediate System (IS-IS) routes, the router must
import the routes into the OSPF routing table.
Routing Table Contents
You can run the display ip routing-table command on a router to view basic
information about the routing table of the router. The command output is as
follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 3
<HUAWEI> display ip routing-table
Proto: Protocol Pre: Preference
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 14 Routes : 14
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 Static 60 0 RD 10.137.216.1 Vlanif20
10.10.10.0/24 Direct 0 0 D 10.10.10.10 Vlanif20
10.10.10.10/32 Direct 0 0 D 127.0.0.1 InLoopBack0
10.10.10.255/32 Direct 0 0 D 127.0.0.1 InLoopBack0
10.10.11.0/24 Direct 0 0 D 10.10.11.1 LoopBack0
10.10.11.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
10.10.11.255/32 Direct 0 0 D 127.0.0.1 InLoopBack0
10.137.216.0/23 Direct 0 0 D 10.137.217.208 Vlanif20
10.137.217.208/32 Direct 0 0 D 127.0.0.1 InLoopBack0
10.137.217.255/32 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
127.255.255.255/32 Direct 0 0 D 127.0.0.1 InLoopBack0
255.255.255.255/32 Direct 0 0 D 127.0.0.1 InLoopBack0
A routing table contains the following key data for each IP packet:
● Destination: identifies the destination IP address or destination network
address of an IP packet.
● Mask: supplements the destination address to specially identify the address of
the network segment where the destination host or router resides.
The network segment address of a destination host or router is obtained
through the "AND" operation on the destination address and network mask.
For example, if the destination address is 10.1.1.1 and the mask is
255.255.255.0, the address of the network segment where the host or router
resides is 10.1.1.0.
The network mask is composed of several consecutive 1s. These 1s can be
expressed in either the dotted decimal notation or the number of consecutive
1s in the mask. For example, the network mask can be expressed either as
255.255.255.0 or 24.
● Proto: indicates the protocol through which routes are learned.
● Pre: indicates the routing protocol preference of a route. There may be
multiple routes to the same destination, which have different next hops and
outbound interfaces. These routes may be discovered by different routing
protocols or manually configured. A router selects the route with the highest
preference (the smallest value) as the optimal route. For the routing protocol
preference, see 1.2.5 Routing Protocol Preference.
● Cost: indicates the route cost. When multiple routes to the same destination
have the same preference, the route with the lowest cost is selected as the
optimal route.
NOTE
The Preference value is used to compare the preferences of different routing protocols,
while the Cost value is used to compare the preferences of different routes of the
same routing protocol.
● NextHop: indicates the IP address of the next device that an IP packet passes
through.
● Interface: indicates the outbound interface through which an IP packet is
forwarded.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 4
In Figure 1-1, the routing table of RouterA shows that it connects to three
networks, so it has three IP addresses and three outbound interfaces.
Figure 1-1 Routing table
Matching with FIB Table
After selecting an optimal route from the routing table, a router sends it to the FIB
table. When receiving a packet, the router compares it against the FIB table to
find the optimal route to forward the packet.
Each entry in the FIB table contains the physical or logical interface through which
a packet is sent to a network segment or host to reach the next router. An entry
can also indicate whether the packet can be sent to a destination host in a directly
connected network.
The router performs the "AND" operation on the destination address in the packet
and the network mask of each entry in the FIB table. The router then compares
the result of the "AND" operation with the entries in the FIB table to find a match
and chooses the optimal route to forward packets according to the longest match
rule.
For example, assume that a router has the following routing table:
Routing Tables:
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 Static 60 0 D 192.168.0.2 GigabitEthernet1/0/0
10.8.0.0/16 Static 60 3 D 192.168.0.2 GigabitEthernet1/0/0
10.9.0.0/16 Static 60 50 D 172.16.0.2 GigabitEthernet3/0/0
10.9.1.0/24 Static 60 4 D 192.168.0.2 GigabitEthernet2/0/0
10.20.0.0/16 Direct 0 0 D 172.16.0.1 GigabitEthernet4/0/0
After receiving a packet carrying the destination address 10.9.1.2, the router
searches the following FIB table:
FIB Table:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 5
Total number of Routes : 5
Destination/Mask Nexthop Flag TimeStamp Interface TunnelID
0.0.0.0/0 192.168.0.2 SU t[37] GigabitEthernet1/0/0 0x0
10.8.0.0/16 192.168.0.2 DU t[37] GigabitEthernet1/0/0 0x0
10.9.0.0/16 172.16.0.2 DU t[9992] GigabitEthernet3/0/0 0x0
10.9.1.0/24 192.168.0.2 DU t[9992] GigabitEthernet2/0/0 0x0
10.20.0.0/16 172.16.0.1 U t[9992] GigabitEthernet4/0/0 0x0
The router performs the "AND" operation on the destination address 10.9.1.2 and
the masks 0, 16, and 24 to obtain the network segment addresses: 0.0.0.0/0,
10.9.0.0/16, and 10.9.1.0/24. The three addresses match three entries in the FIB
table. The router chooses the entry 10.9.1.0/24 according to the longest match
rule, and forwards the packet through GigabitEthernet2/0/0.
1.2.4 Route Recursion
Routes can be used to forward traffic only when they have directly connected next
hops. However, this condition may not be met when routes are generated. The
system then needs to search for directly connected next hops and corresponding
outbound interfaces. This process is called route recursion. In most cases, BGP
routes, static routes, and user network routes (UNRs) do not have directly
connected next hops, and route recursion is required. The following examples
demonstrate how route recursion generates an FIB entry.
A next-hop IP address of a BGP route is often the IP address of an indirectly
connected peer's Loopback interface, and therefore the BGP route needs to be
recursed. The system searches the IP routing table for a direct route (an IGP route
in most cases) that is destined for the next-hop IP address of the BGP route. Then,
the system adds the next-hop IP address and outbound interface of the IGP route
to the IP routing table, generating a FIB entry.
A next-hop IP address of a BGP VPN route is often the IP address of an indirectly
connected PE's Loopback interface, and the BGP route needs torecurse to a tunnel.
The system searches the tunnel list for a tunnel that is destined for this Loopback
IP address. Then, the system adds the tunnel information to the routing table,
generating a FIB entry.
1.2.5 Routing Protocol Preference
Routing protocols (including static routing) may discover different routes to the
same destination, but not all routes are optimal. Only one routing protocol at a
time determines the optimal route to a destination. To select the optimal route,
each routing protocol (including static routing) is assigned a preference (a smaller
value indicates a higher preference). When multiple routing information sources
coexist, the route discovered by the routing protocol with the highest preference is
selected as the optimal route and added to the local routing table.
Routers define external and internal preferences. External preference is manually
configured for each routing protocol. Table 1-1 lists the default external
preferences of routing protocols.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 6
Table 1-1 Routing protocols and their default external preferences
Routing Protocol or
Route Type
Default External Preference
Direct 0
OSPF 10
IS-IS 15
Static 60
RIP 100
OSPF ASE 150
OSPF NSSA 150
IBGP 255
EBGP 255
NOTE
In Table 1-1, the value 0 indicates direct routes and the value 255 indicates routes learned
from unreliable sources. A smaller value indicates a higher preference.
You can manually configure the external preference of all routing protocols except direct
routes. The preference for each static route varies.
Internal preferences of routing protocols cannot be manually configured. Table
1-2 lists the internal preferences of routing protocols.
Table 1-2 Internal preferences of routing protocols
Routing Protocol or
Route Type
Internal Preference
Direct 0
OSPF 10
IS-IS Level-1 15
IS-IS Level-2 18
Static 60
RIP 100
OSPF ASE 150
OSPF NSSA 150
IBGP 200
EBGP 20
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 7
During route selection, a router first compares the external preferences of routes.
When the same external preference is set for different routing protocols, the
router selects the optimal route based on the internal preference. For example,
assume that there are two routes to 10.1.1.0/24: a static route and an OSPF route.
Both routes have the same external preference: 5. In this case, the router
determines the optimal route based on the internal preference listed in Table 1-2.
An OSPF route has an internal preference of 10, and a static route has an internal
preference of 60. This indicates that the OSPF route has a higher preference than
the static route, so the router selects the OSPF route as the optimal route.
NOTE
● If multiple OSPFv2 or OSPFv3 processes learn routes to the same destination and the
external and internal preferences of the routes are the same, the system selects the
route with the smallest link cost; if the link costs of the routes are the same, the routes
participate in load balancing.
● If multiple IS-IS processes learn routes to the same destination and the external and
internal preferences of the routes are the same, the system selects the route with the
smallest link cost; if the link costs of the routes are the same, the routes participate in
load balancing.
● If multiple RIP or RIPng processes learn routes to the same destination and the external
and internal preferences of the routes are the same, the system selects the route with
the smallest link cost; if the link costs of the routes are the same, the routes participate
in load balancing.
In addition, policy-based routing (PBR) provides a mechanism for selecting routes
based on user-defined policies. It allows switches to forward packets based on
users even after routing entries are generated. PBR takes precedence over direct
routes, static routes, and routes generated by dynamic routing protocols.
1.2.6 Route Metric
A route metric specifies the cost of a route to a specified destination address. The
following factors often affect the route metric:
● Path length
Path length is the most common factor that affects the route metric. Link-
state routing protocols allow you to assign a link cost for each link to identify
the path length of a link. In this case, the path length is the sum of the link
costs of all the links that packets pass through. Distance-vector routing
protocols use the hop count to identify the path length. The hop count is the
number of devices that packets pass through from the source to the
destination. For example, the hop count from a router to its directly
connected network is 0, and the hop count from a router to a network that
can be reached through just another router is 1. Other lengths can be
deduced in the same manner.
● Network bandwidth
Network bandwidth is the transmission capability of a link. For example, a 10-
Gigabit link has a higher transmission capability than a 1-Gigabit link.
Although bandwidth defines the maximum transmission rate of a link, routes
over high-bandwidth links are not necessarily better than routes over low-
bandwidth links. For example, when a high-bandwidth link is congested,
forwarding packets over this link will require more time.
● Load
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 8
The load is the degree to which a network resource is busy. You can obtain
the load by calculating the CPU usage and packets processed per second.
Continually monitoring the CPU usage and packets processed per second
helps you learn more about network usage.
● Communication cost
The communication cost is the operating cost of a route over a link. The
communication cost is another important indicator, especially if you do not
care about network performance but are concerned about the operating
expenditure.
1.2.7 Load Balancing and Route Backup
When multiple routes have the same routing protocol preference and metric, these
routes are called equal-cost routes, among which load balancing can be
implemented. When multiple routes have different routing protocol preferences
and metrics, route backup can be implemented among these routes.
Load Balancing
Routers support the multi-route mode, which allows you to configure multiple
routes with the same destination and preference. If the destinations and costs of
multiple routes discovered by the same routing protocol are the same, load
balancing can be performed among the routes.
Currently, static routes and routing protocols (such as RIP, OSPF, BGP, and IS-IS)
use per-flow load balancing. During load balancing, a router forwards packets
based on the packets' 5-tuple (source IP address, destination IP address, source
port, destination port, and transmission protocol). When the 5-tuple information is
the same, the router always chooses the next-hop address that is the same as the
last one to send packets. When the 5-tuple information is different, the router
forwards packets over idle paths.
Figure 1-2 Networking diagram of load balancing
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 9
In the example shown in Figure 1-2, RouterA forwards the first packet P1 to
10.1.1.0/24 through GE0/0/1 and needs to forward subsequent packets to
10.1.1.0/24 and 10.2.1.0/24 respectively. The forwarding process is as follows:
● If the 5-tuple information of P2 destined for 10.1.1.0/24 is the same as that of
P1 destined for 10.1.1.0/24, RouterA forwards P2 and subsequent packets
destined for 10.1.1.0/24 through GE0/0/1.
● If the 5-tuple information of P1 destined for 10.2.1.0/24 is different from that
of P1 destined for 10.1.1.0/24, RouterA forwards P1 and subsequent packets
destined for 10.2.1.0/24 through GE0/0/2.
NOTE
The number of equal-cost routes for load balancing varies with product models.
Route Backup
Route backup can improve network reliability. You can configure multiple routes
to the same destination as required. The route with the highest preference
functions as the primary route, and other routes with lower preferences function
as backup routes.
A router generally uses the primary route to forward data. When the primary link
fails, the primary route becomes inactive. The router selects a backup route with
the highest preference to forward data. In this manner, data is switched from the
primary route to a backup route. When the primary link recovers, the router
selects the primary route to forward data again because the primary route has the
highest preference. Data is then switched back from the backup route to the
primary route.
1.2.8 IP FRR
Definition
IP fast reroute (FRR) is a method that implements fast route backup. It enables a
router to immediately use a backup link for packet forwarding if the router detects
a fault at the physical or data link layer. With IP FRR, the router also reports the
fault to the upper-layer routing system.
Purpose
On traditional IP networks, when a fault occurs at the lower layer on a network,
the physical interface on the router becomes Down. After the router detects the
fault, it informs the upper-layer routing system to recalculate routes and then
updates routing information. Usually, it takes the routing system several seconds
to re-select an available route.
Second-level convergence is intolerable to services that are sensitive to delay and
packet loss because it may lead to service interruptions. For example, Voice over
Internet Protocol (VoIP) services are only tolerant of millisecond-level
interruptions.
IP FRR resolves this by ensuring that the forwarding system rapidly detects a link
fault and then uses a backup route to restore services as soon as possible.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 10
IP FRR Classification and Implementation
IP FRR, which is designed for routes on IP networks, is classified into IP FRR on
public networks and IP FRR on private networks.
● Public network IP FRR protects routers on public networks.
● Private network IP FRR protects Customer Edges (CEs).
IP FRR is implemented as follows:
1. If the primary link is available, you can configure an IP FRR policy to provide
the forwarding information of the backup route to the forwarding engine.
2. If the forwarding engine detects a primary link fault, the engine uses the
backup link to forward traffic before the routes on the control plane converge.
Comparison Between IP FRR and VPN FRR
Table 1-3 Comparison Between IP FRR and VPN FRR
Item Description
IP FRR IP FRR is suitable for IP services that
require a low delay and low packet
loss ratio.
● Protects the public network and
CEs.
● Implements FRR through a backup
route.
VPN FRR VPN FRR is suitable for services that
require a low delay and low packet
loss ratio on VPNs.
● Protects provider edges (PEs).
● Implements FRR through a backup
tunnel.
Comparison Between IP FRR and Load Balancing
Table 1-4 Comparison Between IP FRR and Load Balancing
Item Description
IP FRR Implements FRR through a backup
route. IP FRR is applicable to networks
where a primary link and a backup
link exist and load balancing is not
configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 11
Item Description
Load Balancing Implements fast route switching
through equal-cost routes. Load
balancing is applicable to multi-link
networking with load balancing.
IP FRR Typical Application
In the example shown in Figure 1-3, IP FRR is configured to improve network
reliability. CE1 is dual-homed to PE1 and PE2 and has two outbound interfaces
and two next hops configured. That is, link B functions as the backup of link A.
When link A fails, traffic can be rapidly switched to link B.
Figure 1-3 IP FRR
1.2.9 Route Convergence
Definition
Route convergence is the action of recalculating routes to replace existing routes
in the case of network topology changes. The integration of multiple network
services urgently requires differentiated services. Routes for key services, such as
Voice over IP (VoIP), video conferences, and multicast services, need to be
converged rapidly, while routes for common services can be converged relatively
slowly. In this case, the system needs to converge routes based on their
convergence priorities to improve network reliability.
Priority-based convergence is a mechanism that allows the system to converge
routes based on the convergence priority. You can set different convergence
priorities for routes: critical, high, medium, and low (in descending order of
priority). The system then converges routes based on the convergence priorities
and certain convergence rules, that is, schedules these routes in proportion, to
guide service forwarding.
Principles
Routing protocols first compute and deliver routes of high convergence priority to
the system. You can reconfigure the scheduling weight values as required. Table
1-5 lists the default convergence priorities of public routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 12
Table 1-5 Default convergence priorities of public routes
Routing Protocol or Route Type Convergence Priority
Direct High
Static Medium
32-bit host routes of OSPF and IS-IS Medium
OSPF routes (excluding 32-bit host
routes)
Low
IS-IS routes (excluding 32-bit host
routes)
Low
RIP Low
BGP Low
NOTE
For private routes, only the convergence priorities of 32-bit OSPF and IS-IS host routes are
identified as medium, and the convergence priorities of the other routes are identified as
low.
Priority-based Route Convergence
Figure 1-4 shows a networking arrangement for multicast services. OSPF and IS-IS
run on the network. The receiver connects to RouterA, and the multicast source
server 10.10.10.10/32 connects to RouterB. The route to the multicast source
server must be converged faster than other routes such as 10.12.10.0/24. You can
set the convergence priority of route 10.10.10.10/32 to be higher than that of
route 10.12.10.0/24. When routes are converged on the network, the route to the
multicast source server 10.10.10.10/32 is converged first. This ensures the
transmission of multicast services.
Figure 1-4 Networking diagram of priority-based route convergence
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 13
1.2.10 Default Routes
Default routes are special routes used only when packets to be forwarded do not
match any routing entry in a routing table. If the destination address of a packet
does not match any entry in the routing table, the packet is sent through a default
route. If no default route exists and the destination address of the packet does not
match any entry in the routing table, the packet is discarded. An Internet Control
Message Protocol (ICMP) packet is then sent, informing the originating host that
the destination host or network is unreachable.
In a routing table, a default route is the route to network 0.0.0.0 (with the mask
0.0.0.0). You can run the display ip routing-table command to check whether a
default route is configured. Generally, administrators can manually configure
default static routes. Default routes can also be generated through dynamic
routing protocols such as OSPF and IS-IS.
1.2.11 Route Importing
Different routing protocols using different algorithms may discover different
routes. If multiple routing protocols run on a large network, the routing protocols
need to re-advertise the routes they discover.
Each routing protocol can import routes discovered by other routing protocols,
direct routes, and static routes.
1.2.12 Autonomous System
An Autonomous System (AS) is a set of IP networks and routers under one
administration entity and with common routing policies.
Each AS supports multiple IGPs. All the networks in an AS are assigned the same
AS number and managed by the same administration group. Two types of AS
numbers are available: a 2-byte AS number (ranges from 1 to 65535) and a 4-byte
AS number (ranges from 1 to 4294967295). Available AS numbers can become
exhausted and thereby 2-byte AS numbers need to be extended to 4-byte AS
numbers. A 4-byte AS number can also be shown in the X.Y format, where X
ranges from 1 to 65535 and Y ranges from 0 to 65535.
AS numbers are classified into public AS numbers and private AS numbers,
depending on the network where they are used. Table 1-6 lists the two types of
AS numbers and their ranges.
Table 1-6 AS number types and ranges
AS Number Type 2-Byte AS Number 4-Byte AS Number
Public AS number 1 to 64511 1 to 64511, 65536 to
4294967295
Private AS number 64512 to 65535 64512 to 65535
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 14
1.2.13 Router ID
A router ID is a 32-bit integer used to uniquely identify a device that uses a
specific dynamic routing protocol for route exchange. A router ID uses the same
format as an IP address. Router IDs are classified into global router IDs of devices
and router IDs of dynamic routing protocols.
A router ID can be manually configured or automatically selected by a device. To
ensure OSPF stability, you are advised to manually configure the IP address of a
loopback interface as a router ID.
Manually Configured Router ID
● If a router ID of a specific dynamic routing protocol is configured, this router
ID takes effect.
● If no router ID of a specific dynamic routing protocol is configured and a
global router ID is configured for the device, the global router ID takes effect.
Router ID Automatically Selected by a Device
If the administrator does not configure a global router ID or configure a router ID
for a specific dynamic routing protocol on the device, the router selects a router ID
based on IP addresses of current interfaces:
● If there are loopback interfaces that have IP addresses configured, the device
selects the largest IP address among loopback interface addresses as the
global router ID.
● If no loopback interface is configured or loopback interfaces do not have IP
addresses configured, the device selects the largest IP address among
interface addresses as the global router ID without considering the Up/Down
state of interfaces.
The device selects a router ID again only when the interface IP address that has
been selected as the router ID is deleted or changed.
When a device is being initialized and there is no interface address on the device,
the first configured IP address on the device, which may be a loopback interface
address or another interface address, will become the global router ID of the
device. This global router ID remains unchanged even if there is a larger interface
IP address on the device. The device selects a new global router ID based on the
preceding rules when the IP address that has been used as the existing global
router ID is deleted.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 1 IP Routing
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 15
2 Static Route Configuration
2.1 Overview of Static Routes
2.2 Understanding Static Routes
2.3 Application Scenarios for Static Routes
2.4 Summary of Static Route Configuration Tasks
2.5 Default Settings for Static Routes
2.6 Configuring IPv4 Static Routes
2.7 Configuring Static BFD for IPv4 Static Routes
2.8 Configuring NQA for IPv4 Static Routes
2.9 Configuring EFM for IPv4 Static Routes
2.10 Configuring Association Between IPv4 Static Routes and a Route Monitoring
Group
2.11 Configuring IPv6 Static Routes
2.12 Configuring Static BFD for IPv6 Static Routes
2.13 Configuring NQA for IPv6 Static Routes
2.14 Configuration Examples for Static Routes
2.1 Overview of Static Routes
Definition
A static route is a fixed route that allows network traffic to reach its target
destination. Typically, static routes are manually configured by network
administrators.
Purpose
Static routes are used in different ways on different types of network.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 16
● On simple networks, static routes can be used alone, without the need for
dynamic routes.
● On complex networks, static routes can be used alongside dynamic routes to
improve network performance and ensure that bandwidth is available for
important applications.
● Static routes can be associated with VPN instances to manage VPN routes.
2.2 Understanding Static Routes
2.2.1 Static Route Basics
A router forwards data packets based on routing entries in a routing table. These
routing entries can be manually configured or calculated using dynamic routing
protocols. A static route normally refers to a manually configured route.
In contrast to dynamic routing, static routing is easier to configure, has higher
controllability, uses less bandwidth, and does not use CPU resources for route
calculation and update analysis. When a network fault occurs or the topology
changes, static routes cannot be automatically updated and must be manually
reconfigured to adapt to the network change. Therefore, static routes are not
suitable for large and complex networks. In addition, it is difficult for network
administrators to know the entire network topology. When the network topology
or link state changes, a large amount of static routing information of routers
needs to be adjusted, which is a laborious.
A static route has five parameters: destination IP address, mask, outbound
interface, next-hop IP address, and preference.
Destination Address and Mask
The IPv4 destination address of a static route is expressed in dotted decimal
notation. The mask of the route can be expressed either in dotted decimal
notation or by the mask length. The mask length is the number of consecutive 1s
in the mask. For details about the IPv6 destination address and mask of a static
route, see IPv6 Addresses in "Basic IPv6 Configuration" in the
S300, S500, S2700,
S5700, and S6700 V200R024C00 Configuration Guide - IP Service. Setting the
destination and mask to all 0s configures a default static route. For details about a
default static route, see 2.3.2 Default Static Routes.
Outbound Interface and Next-Hop IP Address
When configuring a static route, depending on the outbound interface type, you
need to specify either an outbound interface or a next-hop IP address.
● For point-to-point (P2P) interfaces, specify an outbound interface. This
automatically sets the IP address of the remote interface connected to the
outbound interface as the next-hop address.
● For non-broadcast multiple access (NBMA) interfaces such as Asynchronous
Transfer Mode (ATM) interfaces, specify a next-hop IP address. This type of
interface supports point-to-multipoint (P2MP) networks, which require
mappings between IP addresses and link-layer addresses to be configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 17
Therefore, during the configuration of static routes, only a next-hop IP address
needs to be specified, and no outbound interface needs to be specified.
● For broadcast interfaces (such as Ethernet interfaces), specify a next-hop IP
address. Ethernet interfaces are broadcast interfaces. If an Ethernet interface
is specified as the outbound interface, there will be multiple next hops, and
the system will not be able to decide which next hop to use.
Static Route Preference
Different static routes can have different preference values configured. A smaller
preference value indicates a higher priority. Specifying the same preference value
for static routes with the same destination implements load balancing among
these routes. Conversely, specifying different preference values for static routes
with the same destination implements route backup among the routes. For details,
see 2.3.1 Load Balancing and Route Backup.
2.2.2 BFD for Static Routes
Unlike dynamic routing protocols, static routes do not have a detection
mechanism. When a fault occurs on the network, the administrator needs to
handle it. To assist the administrator, Bidirectional Forwarding Detection (BFD) for
static routes can be introduced into the network to bind a static route to a BFD
session. Then the BFD session can detect the status of the link where the static
route resides.
After BFD for static routes is configured, each static route can be associated with a
BFD session. In addition to route selection rules, whether a static route can be
selected as the optimal route is subject to BFD session status.
● If a BFD session associated with a static route detects a link failure when the
BFD session is Down, the BFD session reports the link failure to the system.
The system then deletes the static route from the IP routing table.
● If a BFD session associated with a static route detects that a faulty link
recovers when the BFD session is Up, the BFD session reports the fault
recovery to the system. The system then adds the static route to the IP
routing table again.
● By default, a static route can still be selected even though the BFD session
associated with it is AdminDown (triggered by the shutdown command run
either locally or remotely). If a device is restarted, the BFD session needs to be
re-negotiated. In this case, whether the static route associated with the BFD
session can be selected as the optimal route is subject to the re-negotiated
BFD session status.
BFD for static routes has two modes:
● Single-hop detection
For a non-recursive static route, the configured outbound interface and next-
hop address provide the information about the directly connected next hop. In
this case, the outbound interface bound to the BFD session is the outbound
interface of the static route, and the peer address is the next-hop address of
the static route.
● Multi-hop detection
For a recursive static route, only the next-hop address is configured. Therefore,
the static route needs to recurse to the directly connected next-hop and the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 18
outbound interface. In this case, the peer address of the BFD session is the
original next-hop address of the static route, and the outbound interface is
not specified. Generally, the original next hop is an indirect next hop.
Therefore, multi-hop detection is performed on the static routes that support
route recursion.
NOTE
If the next hop of a route is not directly reachable, the route cannot be used for packet
forwarding. Based on information about the current next hop of this route, the system will
calculate an actual outbound interface and an actual next hop. This process is called route
recursion. In the display ip routing-table command output, if the Flags value of a route is
displayed R, the route is a recursive route. Otherwise, the route is not a recursive route.
For more details about BFD, see Understanding BFD in "BFD Configuration" in the
S300, S500, S2700, S5700, and S6700 V200R024C00 Configuration Guide -
Reliability.
2.2.3 NQA for Static Routes
As mentioned previously, static routes do not have a dedicated fault detection
mechanism. If a fault occurs on a non-directly connected link, the corresponding
static route will not be automatically deleted from the IP routing table. This can
interrupt services for a significant amount of time. The network administrator
must delete the corresponding static route to allow traffic to switch to an
available path.
This problem requires an effective solution to detect faults in links for static
routes. BFD for static routes is applicable only in situations where both
communicating devices support it. However, if either of the two communicating
devices supports Network Quality Analysis (NQA), NQA for static routes can be
used to detect faults.
NQA for static routes refers to the association between a static route and an NQA
test instance. The system can use the NQA test instance to check the link status.
Based on the NQA test result, the system can determine an optimal route in time
to prevent communication interruptions and ensure service quality. NQA for static
routes works as follows:
● If NQA detects a fault in the link, the system sets the static route to inactive.
The route becomes unavailable and is deleted from the IP routing table.
● If NQA detects that the link has recovered, the system sets the static route to
active. The route becomes available and is re-added to the IP routing table.
For details about NQA, see NQA Configuration in the
S300, S500, S2700, S5700,
and S6700 V200R024C00 Configuration Guide - Network Management and
Monitoring.
NOTE
When a static route is associated with an NQA test instance, only ICMP test instances are
used to test whether the source and destination can be reached through routes.
Each static route can be associated with only one NQA test instance.
Applications
On the network shown in Figure 2-1, access switches connect to users. Because
dynamic routing protocols are not available for communication between RouterB
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 19
and users, static routes are configured on RouterB. To make the network more
stable, RouterC is configured with static routes to the same destination as
RouterB, providing route backup. RouterA, RouterB, and RouterC run a dynamic
routing protocol to learn routes from each other. RouterB and RouterC import
static routes using a dynamic routing protocol and have different costs configured
for these static routes. After configuration is complete, RouterA can use the
dynamic routing protocol to learn from RouterB and RouterC the routes to users.
RouterA uses the link associated with the static route with the lower cost as the
active link, and the other link as the standby link.
NQA for static routes is also configured on RouterB. NQA tests are performed to
check the active link of RouterB → SwitchA → SwitchC (SwitchD). If the active link
fails, the static route is deleted from the routing table, and traffic diverts to the
standby link of RouterC → SwitchB → SwitchC (SwitchD). If both links are working
properly, traffic travels along the active link.
Figure 2-1 NQA for static routes
2.2.4 Permanent Advertisement of Static Routes
Link connectivity determines the stability and availability of a network. Therefore,
link detection plays an important role in network maintenance. BFD cannot be
used for link detection in all scenarios. For example, a simpler method is required
for link detection between different ISPs.
Permanent advertisement of static routes provides a simple, low-cost link
detection mechanism and improves compatibility between Huawei and non-
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 20
Huawei devices. If service traffic needs to be forwarded along a specified path, you
can ping the destination addresses of static routes to detect link connectivity.
When permanent advertisement of static routes is configured, static routes that
cannot be advertised are still preferred and added to the routing table in the
following cases:
● If an outbound interface configured with an IP address is specified for a static
route, the static route is always preferred and added to the routing table
regardless of whether the outbound interface is Up or Down.
● If no outbound interface is specified for a static route, the static route is
always preferred and added to the routing table regardless of whether the
static route can recurse to an outbound interface.
In addition, you also need to control the priority and prefix length of a static route
to enable ping packets to always be forwarded through this static route. The
permanent advertisement mechanism provides a way for you to monitor services
and detect link connectivity.
NOTICE
A device enabled with this feature always stores static routes in its IP routing
table, regardless of whether the static routes are reachable. If a path is
unreachable, the corresponding static route may become a blackhole route.
Applications
In Figure 2-2, border routers BR1, BR2, and BR3 belong to ISP1, ISP2, and ISP3
respectively. There are two links between BR1 and BR2, Link A and Link B.
However, ISP1 requires that service traffic be forwarded to ISP2 over Link A
without traveling through ISP3.
Figure 2-2 Permanent advertisement of static routes
An External Border Gateway Protocol (EBGP) peer relationship is established
between BR1 and BR2, making them BGP peers. For service monitoring purposes,
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 21
a static route destined for BR2 at 10.1.1.2/24 is configured on BR1, and permanent
advertisement of static routes is enabled on BR1. The interface that connects BR1
to BR2 is specified as the outbound interface of the static route. The network
monitoring system periodically pings 10.1.1.2 to determine the status of Link A.
If Link A is working properly, BR1 forwards ping packets over Link A. If Link A
becomes faulty, the static route is still preferred because permanent advertisement
of static routes is enabled, despite the fact that service traffic can reach BR2 over
Link B. BR1 still attempts to forward ping packets over Link A, but fails. This
scenario also applies to BGP packets, resulting in a link fault that interrupts the
BGP peer relationship. The monitoring system detects service faults as returned in
the ping result and prompts maintenance engineers to rectify the faults before
services are affected.
2.3 Application Scenarios for Static Routes
2.3.1 Load Balancing and Route Backup
Load Balancing Among Static Routes
To implement load balancing, set the same preference value for different routes to
the same destination, as shown in Figure 2-3.
Figure 2-3 Load balancing among static routes
Both static routes from SwitchA to SwitchC have a preference value of 60 and are
stored in the routing table.
Route Backup
To implement route backup, set different preference values for different routes to
the same destination, as shown in Figure 2-4.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 22
Figure 2-4 Route backup
There are two static routes with different preference values from SwitchA to
SwitchC. Static route B with next hop SwitchB has a smaller value, which signifies
a higher preference. The link associated with static route B functions as the active
link. Static route D with next hop SwitchD has a lower preference. The link
associated with static route D functions as the standby link, providing link backup
if a fault occurs on the active link.
● In normal situations, the link associated with static route B is the active link.
Static route B is included in the routing table and is used to forward data.
Static route D is not included in the routing table and is not used to forward
data.
● If a fault occurs on the active link, static route B is deleted from the routing
table. Static route D is added to the routing table and is used to forward data.
● When the fault on the active link is resolved, static route B is reactivated, and
is once again used to forward data. Static route D is deleted from the routing
table and functions as the backup route.
● Static routes used for backup are also known as floating static routes.
2.3.2 Default Static Routes
A default route is a route with the destination IP address set to all 0s. It can be
automatically generated using a routing protocol or manually configured.
Manually configured default routes are called default static routes. Using default
static routes can simplify network configuration. If the destination address of a
packet does not match any entries in a router's routing table, the switch forwards
the packet along the default route instead.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 23
Figure 2-5 Default static routes
In Figure 2-5, if no default static route is configured, static routes destined for
networks 3, 4, and 5 must be configured on SwitchA, static routes destined for
networks 1 and 5 must be configured on SwitchB, and static routes destined for
networks 1, 2, and 3 must be configured on SwitchC. Once all of these static
routes are configured, SwitchA, SwitchB, and SwitchC can communicate with each
other.
The next hop of packets sent by SwitchA to networks 3, 4, and 5 is SwitchB.
Therefore, configuring a single default route on SwitchA can replace the three
static routes destined for networks 3, 4, and 5. Similarly, configuring a single
default route from SwitchC to SwitchB can replace the three static routes destined
for networks 1, 2, and 3.
2.4 Summary of Static Route Configuration Tasks
You can accurately control route selection on a network by configuring static
routes. If static route functions other than route selection control are required,
configure them according to reference sections. Table 2-1 describes static route
configuration tasks.
Table 2-1 Static route configuration tasks
Scenario Description Task
Configuring static routes Static routes are
manually configured by
administrators to ensure
normal operations of
simple networks and
required bandwidth for
important network
applications.
● 2.6 Configuring IPv4
Static Routes
● 2.11 Configuring
IPv6 Static Routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 24
Scenario Description Task
Configuring fault
detection protocols for
static routes
In actual networking,
static routes are
associated with fault
detection protocols to
improve network
performance.
● 2.7 Configuring
Static BFD for IPv4
Static Routes
● 2.8 Configuring NQA
for IPv4 Static
Routes
● 2.9 Configuring EFM
for IPv4 Static
Routes
2.5 Default Settings for Static Routes
Table 2-2 describes the default settings for static routes.
Table 2-2 Default settings for static routes
Parameter Default Setting
Preference of static routes 60
2.6 Configuring IPv4 Static Routes
Pre-configuration Tasks
Before configuring IPv4 static routes, configure link layer parameters and IP
addresses for interfaces to ensure network-layer communication between
neighbor nodes.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the IPv4 Static Route Configuration) as required and in any sequence.
2.6.1 Creating IPv4 Static Routes
Context
When creating static routes, you can specify both the outbound interface and next
hop. Alternatively, you can specify only the outbound interface or next hop,
depending on the interface type:
● For point-to-point (P2P) interfaces, specify the outbound interface.
● For non-broadcast multiple access (NBMA) interfaces, specify the next hop.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 25
● For broadcast interfaces (for example, Ethernet interfaces), specify the next
hop.
Specifying the same preference value for static routes to the same destination
implements load balancing among these routes. Conversely, specifying different
preference values for static routes to the same destination implements route
backup among the routes.
Setting the destination IP address and mask to all 0s configures the default IPv4
static route. By default, no default IPv4 static route is configured.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Configure IPv4 static routes.
● Run ip route-static
ip-address {
mask |
mask-length } {
nexthop-address |
interface-type interface-number [
nexthop-address ] | vpn-instance
vpn-
instance-name nexthop-address } [ preference
preference | tag
tag ] *
[ description
text ]
Or run ip route-static
ip-address {
mask |
mask-length } vpn-instance
vpn-
instance-name [ preference
preference | tag
tag ] * [ description
text ]
An IPv4 static route is configured on the public network.
● Run ip route-static vpn-instance
vpn-source-name destination-address
{
mask |
mask-length } {
nexthop-address [ public ] |
interface-type interface-
number [
nexthop-address ] | vpn-instance
vpn-destination-name nexthop-
address } [ preference
preference | tag
tag ] * [ description
text ]
Or run ip route-static vpn-instance
vpn-source-name destination-address
{
mask |
mask-length } { public | vpn-instance
vpn-destination-name }
[ preference
preference | tag
tag ] * [ description
text ]
An IPv4 static route is configured on a VPN instance.
NOTE
To implement load balancing among an Ethernet interface's static route and other static
routes, configure the outbound interface and next hop.
----End
2.6.2 (Optional) Setting the Default Preference Value for IPv4
Static Routes
Context
The default preference value of IPv4 static routes affects route selection. When an
IPv4 static route is configured without specifying a preference value, the default
preference value is used.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 26
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ip route-static default-preference
preference
The default preference value of static routes is set.
The default preference value of static routes is initially set to 60.
NOTE
After the default preference value is reconfigured, the new default preference value is valid
only for new IPv4 static routes.
----End
2.6.3 (Optional) Configuring Permanent Advertisement of
IPv4 Static Routes
Context
Link connectivity directly affects network stability and availability. Monitoring link
status is an important part of network maintenance. If service traffic needs to be
forwarded along a specified path, you can monitor the status of the path by
pinging the destination addresses of static routes. In this manner, you can monitor
services at a very low cost.
Permanent advertisement of static routes can detect link connectivity by pinging
the destination addresses of the static routes. After permanent advertisement of
static routes is configured, static routes always take effect regardless of the
outbound interface status. In this case, the system forwards ping packets along a
specified path only, which helps monitor the link status of the path.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ip route-static
ip-address {
mask |
mask-length } {
nexthop-address |
interface-type interface-number [
nexthop-address ] | vpn-instance
vpn-instance-
name nexthop-address } permanent
Permanent advertisement of IPv4 static routes is configured.
By default, permanent advertisement of IPv4 static routes is not configured.
----End
2.6.4 (Optional) Preventing a Static Route from Being
Selected If the Associated BFD Session Is in AdminDown State
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 27
Context
If the BFD session associated with a static route on the switch is in AdminDown
state, you can configure the switch not to select the static route. This ensures that
the switch can work together with non-Huawei devices.
By default, a static route can still be selected by the switch even if the BFD session
associated with it is in AdminDown state. However, this is not the case for non-
Huawei devices. As a result, the switch cannot interwork with non-Huawei devices.
To address this problem, run the ip route-static track bfd-session admindown
invalid command to configure the switch not to select the static route if the
associated BFD session is in AdminDown state.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ip route-static track bfd-session session-name
bfd-name admindown
invalid
The switch is configured not to select the static route if the associated BFD session
is in AdminDown state.
By default, a static route can still be selected by the switch even if the associated
BFD session is in AdminDown state.
----End
2.6.5 (Optional) Preventing Static Routes from Being
Recursed to a Blackhole Route
Context
If a link failure occurs on a network with IGP (OSPF for example), static, and
blackhole routes, static routes may be recursed to a blackhole route to remain
active. Static routes are preferentially selected over OSPF routes because they have
a higher priority. Although active, the static routes are unreachable because they
have been recursed to a blackhole route, resulting in service interruptions.
To address this problem, prevent static routes from being recursed to a blackhole
route so that OSPF routes will be preferentially selected.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ip route recursive-lookup blackhole protocol static disable
Static routes are prevented from being recursed to a blackhole route.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 28
By default, static routes can be recursed to a blackhole route.
----End
2.6.6 Verifying the IPv4 Static Route Configuration
Procedure
● Run the display ip routing-table command to check brief information about
the IPv4 routing table.
● Run the display ip routing-table verbose command to check detailed
information about the IPv4 routing table.
----End
2.7 Configuring Static BFD for IPv4 Static Routes
Pre-configuration Tasks
Before configuring static BFD for IPv4 static routes, complete the following tasks:
● Configure link layer parameters and IP addresses for interfaces to ensure
network-layer communication between neighbor nodes.
● Configure a BFD session.
For details, see BFD Configuration in the
S300, S500, S2700, S5700, and S6700
V200R024C00 Configuration Guide - Reliability.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ip route-static
ip-address {
mask |
mask-length } {
nexthop-address |
interface-type interface-number [
nexthop-address ] } [ preference
preference |
tag
tag ] * track bfd-session
cfg-name [ description
text ]
An IPv4 static route on a public network is associated with a BFD session.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 29
NOTE
● Only the S5720I-SI, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S, S5731S-
H, S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and S6730S-S
support BFD for IPv4 static routes.
● Before associating a static route with a BFD session, ensure that the BFD session and
static route are on the same link.
● BFD Echo function can be associated with a static route.
● When a BFD session is associated with VRRP or a static route, by default, the system
does not allow the associated BFD session to be deleted. To delete the associated BFD
session, run the bfd session nonexistent-config-check disable command to prevent
the device from checking whether the associated BFD session is deleted. Note that
deleting the BFD session will prevent the configured association function from being
implemented.
----End
Verifying the Configuration
Run the following command to check the previous configuration.
● Run the display bfd session all [ verbose ] command to check information
about the BFD session.
2.8 Configuring NQA for IPv4 Static Routes
Pre-configuration Tasks
Before associating IPv4 static routes with NQA, configure link layer parameters for
interfaces to ensure that the link layer protocol status on the interfaces is Up.
Procedure
Step 1 Configure an NQA ICMP test instance.
1. Run system-view
The system view is displayed.
2. Run nqa test-instance
admin-name test-name
An NQA test instance is created, and its view is displayed.
3. Run test-type icmp
The test type is set to ICMP.
NOTE
When a static route is associated with an NQA test instance, only ICMP test instances
are used to test whether there are reachable routes between the source and
destination.
4. Run destination-address ipv4
ip-address
The destination address is set.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 30
In an NQA test instance, you can specify an NQA server by running the
destination-address command to configure a destination address for the
NQA test instance.
5. (Optional) Run frequency
interval
The interval for automatically performing an NQA test is set.
By default, no interval is set, and only one test is performed.
6. (Optional) Run probe-count
number
The number of probes to be sent each time is set for the NQA test instance.
By default, the number of probes is 3.
By sending probes multiple times in an NQA test instance, you can accurately
estimate network quality based on the collected statistics.
7. Run start
The NQA test instance is started.
The start command can be used to configure an NQA test instance to start
immediately, at a specified time, or after a specified delay period. You can
perform one of the following operations as required:
– Run start now [ end { at [
yyyy/
mm/
dd ]
hh:
mm:
ss | delay { seconds
second |
hh:
mm:
ss } | lifetime { seconds
second |
hh:
mm:
ss } } ]
The NQA test instance starts immediately.
– Run start at [
yyyy/
mm/dd ]
hh:
mm:
ss [ end { at [
yyyy/
mm/
dd ]
hh:
mm:
ss | delay { seconds
second |
hh:
mm:
ss } | lifetime { seconds
second |
hh:
mm:
ss } } ]
The NQA test instance will start at a specified time.
– Run start delay { seconds
second |
hh:
mm:
ss } [ end { at [
yyyy/
mm/
dd ]
hh:
mm:
ss | delay { seconds
second |
hh:
mm:
ss } | lifetime { seconds
second |
hh:
mm:
ss } } ]
The NQA test instance will start after a specified delay period.
8. Run quit
Return to the system view.
Step 2 Associate static routes with an NQA test instance.
1. Run ip route-static
ip-address {
mask |
mask-length } {
nexthop-address |
interface-type interface-number [
nexthop-address ] } [ preference
preference
| tag
tag ] * track nqa
admin-name test-name [ description
text ]
IPv4 static routes are associated with an NQA test instance.
NOTE
The destination address of an NQA test instance cannot be the destination address of
an associated static route.
If the static route to be associated with an NQA test instance is already associated
with a different NQA test instance, the static route is disassociated from the first NQA
test instance once it becomes associated with the new NQA test instance.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 31
Verifying the Configuration
Once IPv4 static routes are associated with NQA, run the following commands to
check the configuration.
● Run the display current-configuration | include nqa command to check the
configuration of association between static routes and NQA.
● Run the display nqa results [ collection ] [ test-instance
admin-name test-
name ] command to check the NQA test result.
The NQA test result cannot be displayed automatically. You must run the
display nqa results command to view the NQA test result. By default, the
command output shows the results of the latest five NQA tests.
2.9 Configuring EFM for IPv4 Static Routes
Background
EFM for static routes can be configured to provide a fault detection mechanism for
static routes so that the static routes can detect the link quality changes in real
time and switch services immediately. You can associate Ethernet in the First Mile
(EFM) with an IPv4 static route so that the associated static route can be deleted
from the IP routing table when the EFM session of a specified interface goes
Down. Traffic is then switched to a route without link faults to prevent lengthy
service interruptions.
Pre-configuration Tasks
Before associating IPv4 static routes with EFM, set link layer protocol parameters
and assign IP addresses to interfaces to ensure that the link layer protocol status
of the interfaces is Up.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ip route-static
ip-address {
mask |
mask-length } {
nexthop-address |
interface-type interface-number [
nexthop-address ] } [ preference
preference ]
track efm-state
interface-type interface-number [ description
text ]
EFM is associated with the IPv4 static route.
----End
Verifying the Configuration
● Run the display efm session { all | interface
interface-type interface-number
command to check information about EFM OAM on a specified interface.
● Run the display current-configuration | include efm command to check
associations between EFM and IPv4 static routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 32
2.10 Configuring Association Between IPv4 Static
Routes and a Route Monitoring Group
Context
To quickly detect link quality changes for static routes and ensure timely link
switching, you can associate the IPv4 static routes with a route monitoring group.
If a network-side link fails, the route monitoring group detects the status change
of the corresponding network-side route and triggers switching between the active
and standby links on the access side. This prevents network congestion and traffic
loss and ensures service continuity.
Pre-configuration Tasks
Before configuring association between IPv4 static routes and a route monitoring
group, configure link-layer protocol parameters and IP addresses for interfaces to
ensure that the link-layer protocol status of the interfaces is Up.
Procedure
1. Configure a route monitoring group.
a. Run system-view
The system view is displayed.
b. Run ip route-monitor-group
group-name
A route monitoring group is created and the route monitoring group view
is displayed.
By default, no route monitoring group is created on a switch.
c. Run track ip route [ vpn-instance
vpn-instance-name ]
dest-address
{
mask |
mask-length }
A route is added to the route monitoring group.
By default, no route is added to a route monitoring group.
To add more routes to the route monitoring group, repeat this step. A
route monitoring group can monitor a maximum of 16 routes.
d. (Optional) Run operator and
The relationship between routes in the route monitoring group is set to
AND.
By default, the status of routes in a route monitoring group is of the OR
relationship. That is, the status of the route monitoring group is Up as
long as one route in the group is Up. The status of the monitoring group
is Down only when all routes in the group are Down.
e. (Optional) Run trigger-down-delay
delay-value
A delay after which the RM module instructs the associated service
modules to perform link switchovers is configured.
By default, the delay is 0s.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 33
f. (Optional) Run trigger-up-delay
delay-value
A delay after which the RM module instructs the associated service
modules to perform link switchbacks is configured.
By default, the delay is 5s.
g. Run monitor enable
The route monitoring group is enabled.
2. Configure association between IPv4 static routes and the route monitoring
group.
a. Run system-view
The system view is displayed.
b. Run ip route-static
ip-address {
mask |
mask-length } {
nexthop-address |
interface-type interface-number [
nexthop-address ] | vpn-instance
vpn-
instance-name nexthop-address } [ preference
preference | tag
tag ]
track route-monitor-group
route-monitor-group-name [ description
text ]
Association between IPv4 static routes and the route monitoring group is
configured.
NOTE
The destination address of a route monitored by a route monitoring group cannot be
the destination address of an associated static route.
Verifying the Configuration
● Run the display ip route-monitor-group [
group-name ] command to check
information about the route monitoring group.
● Run the display ip route-monitor-group track-route [ vpn-instance
vpn-
instance-name ]
dest-address {
mask |
mask-length } command to check
information about all route monitoring groups to which a route is added.
● Run the display current-configuration | include track route-monitor-group
command to check the configuration of the association between IPv4 static
routes and route monitoring groups.
2.11 Configuring IPv6 Static Routes
Pre-configuration Tasks
Before configuring IPv6 static routes, configure link layer parameters and IPv6
addresses for interfaces to ensure network-layer communication between
neighbor nodes.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the IPv6 Static Route Configuration) as required and in any sequence.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 34
2.11.1 Creating IPv6 Static Routes
Context
When creating IPv6 static routes, you can specify both the outbound interface and
next hop. Alternatively, you can specify only the outbound interface or next hop,
depending on the interface type:
● For point-to-point (P2P) interfaces, specify the outbound interface.
● For non-broadcast multiple access (NBMA) interfaces, specify the next hop.
● For broadcast interfaces, specify the next-hop address. If a link-local address is
specified as the next-hop address, you must also specify the outbound
interface.
Specifying the same preference value for IPv6 static routes to the same destination
implements load balancing among these routes. Conversely, specifying different
preference values for IPv6 static routes to the same destination implements route
backup among the routes.
Setting the destination IP address and mask to all 0s configures the default IPv6
static route. By default, no default IPv6 static route is configured.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Configure IPv6 static routes.
● Run ipv6 route-static
dest-ipv6-address prefix-length {
interface-type
interface-number [
nexthop-ipv6-address ] |
nexthop-ipv6-address }
[ preference
preference | tag
tag ] * [ description
text ]
Or run ipv6 route-static
dest-ipv6-address prefix-length vpn-instance
vpn-
destination-name [ preference
preference | tag
tag ] * [ description
text ]
An IPv6 static route is configured on the public network.
● Run ipv6 route-static vpn-instance
vpn-instance-name dest-ipv6-address
prefix-length { [
interface-type interface-number ]
nexthop-ipv6-address |
nexthop-ipv6-address [ public ] | vpn-instance
vpn-destination-name
nexthop-ipv6-address } [ preference
preference | tag
tag ] * [ description
text ]
Or run ipv6 route-static vpn-instance
vpn-instance-name dest-ipv6-address
prefix-length { public | vpn-instance
vpn-destination-name } [ preference
preference | tag
tag ] * [ description
text ]
An IPv6 static route is configured on a VPN instance.
NOTE
To implement load balancing among an Ethernet interface's static route and other static
routes, configure the outbound interface and next hop.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 35
2.11.2 (Optional) Setting the Default Preference Value for
IPv6 Static Routes
Context
The default preference value of IPv6 static routes affects route selection. When an
IPv6 static route is configured without specifying a preference value, the default
preference value is used.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ipv6 route-static default-preference
preference
The default preference value of IPv6 static routes is set.
The default preference value of static routes is initially set to 60.
After the default preference value is reconfigured, the new default preference
value is valid only for new IPv6 static routes.
----End
2.11.3 Verifying the IPv6 Static Route Configuration
Procedure
● Run the display ipv6 routing-table command to check brief information
about the IPv6 routing table.
● Run the display ipv6 routing-table verbose command to check detailed
information about the IPv6 routing table.
----End
2.12 Configuring Static BFD for IPv6 Static Routes
Usage Scenario
To use BFD sessions to provide link detection for IPv6 static routes, you can bind
IPv6 static routes to BFD sessions. One IPv6 static route can be bound to one BFD
session.
Optimal IPv6 static routes are delivered to the forwarding table for packet
forwarding. However, IPv6 static routes cannot detect the status of the link to the
next hop. You can bind IPv6 static routes to BFD sessions. A BFD session can fast
detect changes over a link and inform the routing management system of the
changes. The routing management system immediately deletes the static route
that is bound to the BFD session from the forwarding table and recalculates
another active route. In this manner, fast route convergence is implemented.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 36
Pre-configuration Tasks
Before configuring static BFD for IPv6 static routes, complete the following tasks:
● Configure link layer protocol parameters and IP addresses for interfaces and
ensure that the link layer protocol of the interfaces is Up.
● Configure a BFD session. For details, see BFD Configuration in the
S300, S500,
S2700, S5700, and S6700 V200R024C00 Configuration Guide - Reliability.
.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ipv6 route-static
dest-ipv6-address prefix-length {
interface-type interface-
number [
nexthop-ipv6-address ] |
nexthop-ipv6-address | vpn-instance
vpn-
destination-name nexthop-ipv6-address } [ preference
preference | tag
tag ] *
[ track bfd-session
cfg-name ] [ description
text ]
A BFD session is bound to an IPv6 static route.
NOTE
Only the S5720I-SI, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S, S5731S-H,
S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and S6730S-S
support static BFD for IPv6 static routes.
Before associating a static route with a BFD session, ensure that the BFD session and static
route are on the same link.
When a BFD session is associated with VRRP or a static route, the system does not allow
the associated BFD session to be deleted by default. To delete the associated BFD session,
run the bfd session nonexistent-config-check disable command to prevent the device
from checking whether the associated BFD session is deleted. However, deleting the BFD
session will prevent the configured association function from being implemented.
----End
Verifying the Configuration
Run the following commands to check the previous configuration.
Information about a BFD session can be viewed only after parameters of the BFD
session are set and the BFD session is established.
● Run the display bfd session { all | discriminator
discr-value } [ verbose ]
command to check information about BFD sessions.
● Run the display current-configuration | include bfd command to check
configurations of BFD for IPv6 static routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 37
2.13 Configuring NQA for IPv6 Static Routes
Pre-configuration Tasks
Before associating IPv6 static routes with NQA, configure link layer parameters for
interfaces to ensure that the link layer protocol status on the interfaces is Up.
Procedure
Step 1 Configure an NQA ICMP test instance.
1. Run system-view
The system view is displayed.
2. Run nqa test-instance
admin-name test-name
An NQA test instance is created, and its view is displayed.
3. Run test-type icmp
The test type is set to ICMP.
NOTE
When a static route is associated with an NQA test instance, only ICMP test instances
are used to test whether there are reachable routes between the source and
destination.
4. Run destination-address ipv6
ipv6-address
The destination address is set.
In an NQA test instance, you can specify an NQA server by running the
destination-address command to configure a destination address for the
NQA test instance.
5. (Optional) Run frequency
interval
The interval for automatically performing an NQA test is set.
By default, no interval is set, and only one test is performed.
6. (Optional) Run probe-count
number
The number of probes to be sent each time is set for the NQA test instance.
By default, the number of probes is 3.
By sending probes multiple times in an NQA test instance, you can accurately
estimate network quality based on the collected statistics.
7. Run start
The NQA test instance is started.
The start command can be used to configure an NQA test instance to start
immediately, at a specified time, or after a specified delay period. You can
perform one of the following operations as required:
– Run start now [ end { at [
yyyy/
mm/
dd ]
hh:
mm:
ss | delay { seconds
second |
hh:
mm:
ss } | lifetime { seconds
second |
hh:
mm:
ss } } ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 38
The NQA test instance starts immediately.
– Run start at [
yyyy/mm/dd ]
hh:
mm:
ss [ end { at [
yyyy/
mm/
dd ]
hh:
mm:
ss | delay { seconds
second |
hh:
mm:
ss } | lifetime { seconds
second |
hh:
mm:
ss } } ]
The NQA test instance will start at a specified time.
– Run start delay { seconds
second |
hh:
mm:
ss } [ end { at [
yyyy/
mm/
dd ]
hh:
mm:
ss | delay { seconds
second |
hh:
mm:
ss } | lifetime { seconds
second |
hh:
mm:
ss } } ]
The NQA test instance will start after a specified delay period.
8. Run quit
Return to the system view.
Step 2 Associate static routes with an NQA test instance.
1. Run ipv6 route-static
dest-ipv6-address prefix-length {
interface-type
interface-number [
nexthop-ipv6-address ] |
nexthop-ipv6-address }
[ preference
preference | tag
tag ] * track nqa
admin-name test-name
[ description
text ]
IPv6 static routes are associated with an NQA test instance.
NOTE
The destination address of an NQA test instance cannot be the destination address of
an associated static route.
If the static route to be associated with an NQA test instance is already associated
with a different NQA test instance, the static route is disassociated from the first NQA
test instance once it becomes associated with the new NQA test instance.
----End
Verifying the Configuration
Once IPv6 static routes are associated with NQA, run the following commands to
check the configuration.
● Run the display current-configuration | include nqa command to check the
configuration of association between static routes and NQA.
● Run the display nqa results [ collection ] [ test-instance
admin-name test-
name ] command to check the NQA test result.
The NQA test result cannot be displayed automatically. You must run the
display nqa results command to view the NQA test result. By default, the
command output shows the results of the latest five NQA tests.
2.14 Configuration Examples for Static Routes
2.14.1 Example for Configuring IPv4 Static Routes
Networking Requirements
In Figure 2-6, PC1, PC2, and PC3 are on different network segments, and are
connected through SwitchA, SwitchB, and SwitchC. Any two PCs must be
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 39
connected using static routes to communicate with each other without using
dynamic routing protocols.
Figure 2-6 Configuring IPv4 static routes
Configuration Roadmap
The configuration roadmap is as follows:
1. Create VLANs, add interfaces to VLANs, and assign IPv4 addresses to VLANIF
interfaces so that neighboring devices can communicate with each other.
2. Configure an IPv4 default gateway on each PC, and configure IPv4 static
routes or default static routes on each Switch so that any two PCs on different
network segments can communicate with each other.
Procedure
Step 1 Create VLANs and add interfaces to the VLANs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 30
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type access
[SwitchA-GigabitEthernet0/0/2] port default vlan 30
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign IPv4 addresses to VLANIF interfaces.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 40
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.4.1 30
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 30
[SwitchA-Vlanif30] ip address 10.1.1.1 24
[SwitchA-Vlanif30] quit
Step 3 Configure PCs.
Set the default gateway addresses of PC1, PC2, and PC3 to 10.1.1.1, 10.1.2.1, and
10.1.3.1 respectively.
Step 4 Configure IPv4 static routes.
# Configure a default IPv4 static route on SwitchA.
[SwitchA] ip route-static 0.0.0.0 0.0.0.0 10.1.4.2
# Configure two IPv4 static routes on SwitchB.
[SwitchB] ip route-static 10.1.1.0 255.255.255.0 10.1.4.1
[SwitchB] ip route-static 10.1.3.0 255.255.255.0 10.1.4.6
# Configure a default IPv4 static route on SwitchC.
[SwitchC] ip route-static 0.0.0.0 0.0.0.0 10.1.4.5
Step 5 Verify the configuration.
# Check the IP routing table on SwitchA.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 7 Routes : 7
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 Static 60 0 RD 10.1.4.2 Vlanif10
10.1.1.0/24 Direct 0 0 D 10.1.1.1 Vlanif30
10.1.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif30
10.1.4.0/30 Direct 0 0 D 10.1.4.1 Vlanif10
10.1.4.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
# Run the ping command to verify the connectivity.
[SwitchA] ping 10.1.3.1
PING 10.1.3.1: 56 data bytes, press CTRL_C to break
Reply from 10.1.3.1: bytes=56 Sequence=1 ttl=253 time=62 ms
Reply from 10.1.3.1: bytes=56 Sequence=2 ttl=253 time=63 ms
Reply from 10.1.3.1: bytes=56 Sequence=3 ttl=253 time=63 ms
Reply from 10.1.3.1: bytes=56 Sequence=4 ttl=253 time=62 ms
Reply from 10.1.3.1: bytes=56 Sequence=5 ttl=253 time=62 ms
--- 10.1.3.1 ping statistics ---
5 packet(s) transmitted
5 packet(s) received
0.00% packet loss
round-trip min/avg/max = 62/62/63 ms
# Run the tracert command to verify the connectivity.
[SwitchA] tracert 10.1.3.1
traceroute to 10.1.3.1(10.1.3.1), max hops: 30 ,packet length: 40,press CTRL_C to break
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 41
1 10.1.4.2 31 ms 32 ms 31 ms
2 10.1.3.1 62 ms 63 ms 62 ms
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 30
#
interface Vlanif10
ip address 10.1.4.1 255.255.255.252
#
interface Vlanif30
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type access
port default vlan 30
#
ip route-static 0.0.0.0 0.0.0.0 10.1.4.2
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20 40
#
interface Vlanif10
ip address 10.1.4.2 255.255.255.252
#
interface Vlanif20
ip address 10.1.4.5 255.255.255.252
#
interface Vlanif40
ip address 10.1.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type access
port default vlan 40
#
ip route-static 10.1.1.0 255.255.255.0 10.1.4.1
ip route-static 10.1.3.0 255.255.255.0 10.1.4.6
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 50
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 42
#
interface Vlanif20
ip address 10.1.4.6 255.255.255.252
#
interface Vlanif50
ip address 10.1.3.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type access
port default vlan 50
#
ip route-static 0.0.0.0 0.0.0.0 10.1.4.5
#
return
2.14.2 Example for Configuring IPv6 Static Routes
Networking requirements
Figure 2-7 shows an IPv6 network. PC1, PC2, and PC3 are on different network
segments, and are connected through SwitchA, SwitchB, and SwitchC. Any two PCs
must be connected using static routes to communicate with each other without
using dynamic routing protocols.
Figure 2-7 Configuring IPv6 static routes
Configuration Roadmap
The configuration roadmap is as follows:
1. Create VLANs, add interfaces to the VLANs, and assign IPv6 addresses to
VLANIF interfaces so that neighboring devices can communicate with each
other.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 43
2. Configure an IPv6 default gateway on each PC, and configure IPv6 static
routes or default static routes on each Switch so that any two PCs on different
network segments can communicate with each other.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type access
[SwitchA-GigabitEthernet0/0/2] port default vlan 10
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign IPv6 addresses to VLANIF interfaces.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] ipv6
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ipv6 enable
[SwitchA-Vlanif10] ipv6 address fc00:0:0:2001::1/64
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ipv6 enable
[SwitchA-Vlanif20] ipv6 address fc00:0:0:2010::1/64
[SwitchA-Vlanif20] quit
Step 3 Configure IPv6 addresses for the PCs and default gateway addresses.
Assign IPv6 addresses to the PCs, and set the default gateway address of PC1, PC2,
and PC3 to fc00:0:0:2001::1, fc00:0:0:2002::1, and fc00:0:0:2003::1 respectively.
Step 4 Configure IPv6 static routes.
# Configure a default IPv6 static route on SwitchA.
[SwitchA] ipv6 route-static :: 0 vlanif20 fc00:0:0:2010::2
# Configure two IPv6 static routes on SwitchB.
[SwitchB] ipv6 route-static fc00:0:0:2001:: 64 vlanif20 fc00:0:0:2010::1
[SwitchB] ipv6 route-static fc00:0:0:2003:: 64 vlanif40 fc00:0:0:2020::2
# Configure a default IPv6 static route on SwitchC.
[SwitchC] ipv6 route-static :: 0 vlanif40 fc00:0:0:2020::1
Step 5 Verify the configuration.
# Check the IPv6 routing table on SwitchA.
[SwitchA] display ipv6 routing-table
Routing Table : Public
Destinations : 7 Routes : 7
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 44
Destination : :: PrefixLength : 0
NextHop : FC00:0:0:2010::2 Preference : 60
Cost : 0 Protocol : Static
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif20 Flags : D
Destination : ::1 PrefixLength : 128
NextHop : ::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : InLoopBack0 Flags : D
Destination : FC00:0:0:2001:: PrefixLength : 64
NextHop : FC00:0:0:2001::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif10 Flags : D
Destination : FC00:0:0:2001::1 PrefixLength : 128
NextHop : ::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif10 Flags : D
Destination : FC00:0:0:2010:: PrefixLength : 64
NextHop : FC00:0:0:2010::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif20 Flags : D
Destination : FC00:0:0:2010::1 PrefixLength : 128
NextHop : ::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif20 Flags : D
Destination : FE80:: PrefixLength : 10
NextHop : :: Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : NULL0 Flags : D
# Run the ping command to verify the connectivity.
[SwitchA] ping ipv6 fc00:0:0:2003::1
PING fc00:0:0:2003::1 : 56 data bytes, press CTRL_C to break
Reply from FC00:0:0:2003::1
bytes=56 Sequence=1 hop limit=63 time = 63 ms
Reply from FC00:0:0:2003::1
bytes=56 Sequence=2 hop limit=63 time = 62 ms
Reply from FC00:0:0:2003::1
bytes=56 Sequence=3 hop limit=63 time = 62 ms
Reply from FC00:0:0:2003::1
bytes=56 Sequence=4 hop limit=63 time = 63 ms
Reply from FC00:0:0:2003::1
bytes=56 Sequence=5 hop limit=63 time = 63 ms
--- fc00:0:0:2003::1 ping statistics ---
5 packet(s) transmitted
5 packet(s) received
0.00% packet loss
round-trip min/avg/max = 62/62/63 ms
# Run the tracert command to verify the connectivity.
[SwitchA] tracert ipv6 fc00:0:0:2003::1
traceroute to fc00:0:0:2003::1 30 hops max,60 bytes packet
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 45
1 FC00:0:0:2010::2 31 ms 32 ms 31 ms
2 FC00:0:0:2003::1 62 ms 63 ms 62 ms
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
vlan batch 10 20
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:2001::1/64
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:2010::1/64
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type access
port default vlan 10
#
ipv6 route-static :: 0 Vlanif20 FC00:0:0:2010::2
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
vlan batch 20 30 40
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:2010::2/64
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:2002::1/64
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:2020::1/64
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/3
port link-type access
port default vlan 30
#
ipv6 route-static FC00:0:0:2001:: 64 Vlanif20 FC00:0:0:2010::1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 46
ipv6 route-static FC00:0:0:2003:: 64 Vlanif40 FC00:0:0:2020::2
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 40 50
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:2020::2/64
#
interface Vlanif50
ipv6 enable
ipv6 address FC00:0:0:2003::1/64
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type access
port default vlan 50
#
ipv6 route-static :: 0 Vlanif40 FC00:0:0:2020::1
#
return
2.14.3 Example for Configuring Static BFD for IPv4 Static
Routes
Networking Requirements
In Figure 2-8, SwitchA connects to the network management system (NMS)
across a network segment through SwitchB. Static routes need to be configured on
SwitchA so that SwitchA can communicate with the NMS. Link fault detection
between SwitchA and SwitchB must be completed within a few milliseconds to
speed up route convergence.
Figure 2-8 Configuring static BFD for IPv4 static routes
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure a BFD session between SwitchA and SwitchB to complete link fault
detection within a few milliseconds.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 47
2. Configure a static route from SwitchA to the NMS and bind a BFD session to
the static route to complete link fault detection within a few milliseconds and
speed up route convergence.
Procedure
Step 1 Create VLANs and add interfaces to the VLANs.
# Configure SwitchA. The configurations of SwitchB are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan 10
[SwitchA-vlan10] quit
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign IP addresses to VLANIF interfaces.
# Configure SwitchA. The configurations of SwitchB are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
Step 3 Configure a BFD session between SwitchA and SwitchB.
# Create a BFD session on SwitchA.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] bfd aa bind peer-ip 10.1.1.2
[SwitchA-bfd-session-aa] discriminator local 10
[SwitchA-bfd-session-aa] discriminator remote 20
[SwitchA-bfd-session-aa] commit
[SwitchA-bfd-session-aa] quit
# Create a BFD session on SwitchB.
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] bfd bb bind peer-ip 10.1.1.1
[SwitchB-bfd-session-bb] discriminator local 20
[SwitchB-bfd-session-bb] discriminator remote 10
[SwitchB-bfd-session-bb] commit
[SwitchB-bfd-session-bb] quit
Step 4 Configure a static route and bind it to the BFD session.
# On SwitchA, configure a default static route to the external network and bind it
to the BFD session named aa.
[SwitchA]ip route-static 10.2.2.0 24 10.1.1.2 track bfd-session aa
Step 5 Verify the configuration.
# After the configuration is complete, run the display bfd session all command
on SwitchA and SwitchB. The command output shows that the BFD session has
been established and is Up.
The display on SwitchA is used as an example.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 48
[SwitchA] display bfd session all
--------------------------------------------------------------------------------
Local Remote PeerIpAddr State Type InterfaceName
--------------------------------------------------------------------------------
10 20 10.1.1.2 Up S_IP_PEER -
--------------------------------------------------------------------------------
Total UP/DOWN Session Number : 1/0
# Check the IP routing table on SwitchA. The command output shows that the
static route 10.2.2.0/24 exists in the routing table.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 5 Routes : 5
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/24 Direct 0 0 D 10.1.1.1 Vlanif10
10.1.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
10.2.2.0/24 Static 60 0 RD 10.1.1.2 Vlanif10
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
# Run the shutdown command on GE 0/0/1 of SwitchB to simulate a link fault.
[SwitchB] interface gigabitethernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] shutdown
# Check the IP routing table on SwitchA. The command output shows that the
static route 10.2.2.0/24 does not exist. This is because the static route has been
bound to a BFD session, and BFD immediately notifies that the bound static route
becomes unavailable after detecting a link fault.
[SwitchA]display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 2 Routes : 2
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
# Run the undo shutdown command on GE0/0/1 of SwitchB to simulate link
recovery.
[SwitchB-GigabitEthernet0/0/1]undo shutdown
# Check the IP routing table on SwitchA. The command output shows that the
static route 10.2.2.0/24 exists in the routing table. This is because BFD
immediately notifies that the bound static route becomes reachable again after
detecting link recovery.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 5 Routes : 5
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/24 Direct 0 0 D 10.1.1.1 Vlanif10
10.1.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
10.2.2.0/24 Static 60 0 RD 10.1.1.2 Vlanif10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 49
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10
#
bfd
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
bfd aa bind peer-ip 10.1.1.2
discriminator local 10
discriminator remote 20
commit
#
ip route-static 10.2.2.0 255.255.255.0 10.1.1.2 track bfd-session aa
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20
#
bfd
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
#
interface Vlanif20
ip address 10.2.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bfd bb bind peer-ip 10.1.1.1
discriminator local 20
discriminator remote 10
commit
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 50
2.14.4 Example for Configuring Static BFD for IPv6 Static
Routes
Networking Requirements
In Figure 2-9, SwitchA and SwitchB connect to each other. An IPv6 static route to
SwitchB needs to be configured on SwitchA. It is required that fast fault detection
be implemented on SwitchA and the IPv6 routing table of SwitchA be updated in a
timely manner.
Figure 2-9 Configuring static BFD for IPv6 static routes
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure a BFD session between SwitchA and SwitchB for fast fault detection
on SwitchA.
2. Configure an IPv6 static route from SwitchA to SwitchB and bind the static
route to the BFD session so that SwitchA can update its IPv6 routing table
after a fault is detected.
Procedure
Step 1 Configure IPv6 addresses for interfaces of SwitchA and SwitchB.
# Configure SwitchA. The configuration of SwitchB is similar to that of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] ipv6
[SwitchA] interface GigabitEthernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] undo portswitch
[SwitchA-GigabitEthernet0/0/1] ipv6 enable
[SwitchA-GigabitEthernet0/0/1] ipv6 address fc00::1 64
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Configure a BFD session between SwitchA and SwitchB.
# On SwitchA, create a BFD session with SwitchB.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] bfd aa bind peer-ipv6 fc00::2
[SwitchA-bfd-session-aa] discriminator local 10
[SwitchA-bfd-session-aa] discriminator remote 20
[SwitchA-bfd-session-aa] commit
[SwitchA-bfd-session-aa] quit
# On SwitchB, create a BFD session with SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 51
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] bfd bb bind peer-ipv6 fc00::1
[SwitchB-bfd-session-bb] discriminator local 20
[SwitchB-bfd-session-bb] discriminator remote 10
[SwitchB-bfd-session-bb] commit
[SwitchB-bfd-session-bb] quit
Step 3 Configure a default static route and bind the route to the BFD session.
# On SwitchA, configure a default static route to SwitchB and bind the route to
the BFD session named aa.
[SwitchA] ipv6 route-static 0::0 0 fc00::2 track bfd-session aa
Step 4 Verify the configuration.
# After the configuration is complete, run the display bfd session all command
on SwitchA and SwitchB. The display on SwitchA is used as an example:
[SwitchA] display bfd session all
--------------------------------------------------------------------------------
Local Remote PeerIpAddr State Type InterfaceName
--------------------------------------------------------------------------------
10 20 FC00::2
Up S_IP_PEER -
--------------------------------------------------------------------------------
Total UP/DOWN Session Number : 1/0
The command output shows that the BFD session has been established and is Up.
Run the display current-configuration | include bfd command in the system
view on SwitchA. The command output shows that the default static route has
been bound to the BFD session.
[SwitchA] display current-configuration | include bfd
bfd
bfd aa bind peer-ipv6 FC00::2
ipv6 route-static :: 0 FC00::2 track bfd-session aa
# Check the IPv6 routing table on SwitchA. The command output shows that the
default static route exists in the routing table.
[SwitchA] display ipv6 routing-table
Routing Table : Public
Destinations : 5 Routes : 5
Destination : :: PrefixLength : 0
NextHop : FC00::2 Preference : 60
Cost : 0 Protocol : Static
RelayNextHop : :: TunnelID : 0x0
Interface : GigabitEthernet0/0/1 Flags : RD
Destination : ::1 PrefixLength : 128
NextHop : ::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : InLoopBack0 Flags : D
Destination : FC00:: PrefixLength : 64
NextHop : FC00::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : GigabitEthernet0/0/1 Flags : D
Destination : FC00::1 PrefixLength : 128
NextHop : ::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 52
Interface : GigabitEthernet0/0/1 Flags : D
Destination : FE80:: PrefixLength : 10
NextHop : :: Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : NULL0 Flags : D
# Run the shutdown command on GE0/0/1 of SwitchB to simulate a link fault.
[SwitchB] interface GigabitEthernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] shutdown
# Check the IPv6 routing table on SwitchA. The command output shows that the
default static route 0::0/0 does not exist. This is because the default static route
has been bound to a BFD session, and BFD immediately notifies that the bound
static route becomes unavailable after detecting a link fault.
[SwitchA] display ipv6 routing-table
Routing Table : Public
Destinations : 1 Routes : 1
Destination : ::1 PrefixLength : 128
NextHop : ::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : InLoopBack0 Flags : D
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
bfd
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00::1/64
#
bfd aa bind peer-ipv6 FC00::2
discriminator local 10
discriminator remote 20
commit
#
ipv6 route-static :: 0 FC00::2 track bfd-session aa
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
bfd
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00::2/64
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 53
bfd bb bind peer-ipv6 FC00::1
discriminator local 20
discriminator remote 10
commit
#
return
2.14.5 Example for Configuring NQA for IPv4 Static Routes
Networking Requirements
As shown in Figure 2-10, SwitchA on a company network is connected to two
egress routers (RouterA and RouterB) through two default static routes to
implement load balancing. The company wants to deploy a link failure detection
mechanism for the default static routes, so that traffic can be switched from a
faulty link to the other functioning link promptly to prevent services from being
interrupted.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 2-10 Configuring NQA for IPv4 static routes
Configuration Roadmap
1. Create VLANs, add interfaces to the VLANs, and configure IP addresses for
VLANIF interfaces, so that neighboring devices can communicate with each
other.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 54
2. Create ICMP NQA test instances to monitor the status of links.
ICMP NQA test instances need to be created on the NQA client SwitchA to
detect the status of links between SwitchA and RouterA and between SwitchA
and RouterB.
3. Configure default static routes and bind them to the NQA test instances.
Default static routes destined for RouterA and RouterB need to be configured
on SwitchA and bound to NQA test instances. In this way, if an NQA test
instance detects a link failure, traffic is switched to the other link.
Procedure
Step 1 On SwitchA, create VLANs and add interfaces to them.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 100 200 300
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 100
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 200
[SwitchA-GigabitEthernet0/0/2] quit
[SwitchA] interface gigabitethernet 0/0/3
[SwitchA-GigabitEthernet0/0/3] port link-type trunk
[SwitchA-GigabitEthernet0/0/3] port trunk allow-pass vlan 300
[SwitchA-GigabitEthernet0/0/3] quit
Step 2 On SwitchA, configure an IP address for each VLANIF interface.
[SwitchA] interface vlanif 100
[SwitchA-Vlanif100] ip address 10.1.10.2 24
[SwitchA-Vlanif100] quit
[SwitchA] interface vlanif 200
[SwitchA-Vlanif200] ip address 10.1.20.2 24
[SwitchA-Vlanif200] quit
[SwitchA] interface vlanif 300
[SwitchA-Vlanif300] ip address 10.1.30.2 24
[SwitchA-Vlanif300] quit
Step 3 On SwitchA, configure NQA test instances.
[SwitchA] nqa test-instance user test1
[SwitchA-nqa-user-test1] test-type icmp
[SwitchA-nqa-user-test1] destination-address ipv4 10.1.10.1
[SwitchA-nqa-user-test1] frequency 11
[SwitchA-nqa-user-test1] probe-count 2
[SwitchA-nqa-user-test1] interval seconds 5
[SwitchA-nqa-user-test1] timeout 4
[SwitchA-nqa-user-test1] start now
[SwitchA-nqa-user-test1] quit
[SwitchA] nqa test-instance user test2
[SwitchA-nqa-user-test2] test-type icmp
[SwitchA-nqa-user-test2] destination-address ipv4 10.1.20.1
[SwitchA-nqa-user-test2] frequency 11
[SwitchA-nqa-user-test2] probe-count 2
[SwitchA-nqa-user-test2] interval seconds 5
[SwitchA-nqa-user-test2] timeout 4
[SwitchA-nqa-user-test2] start now
[SwitchA-nqa-user-test2] quit
Step 4 Configure default static routes and bind them to the NQA test instances.
[SwitchA] ip route-static 0.0.0.0 0.0.0.0 10.1.10.1 track nqa user test1
[SwitchA] ip route-static 0.0.0.0 0.0.0.0 10.1.20.1 track nqa user test2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 55
Step 5 Verify the configuration.
# Check the configuration of NQA for default static routes. The command output
shows that the default static routes have been bound to NQA test instances.
[SwitchA] display current-configuration | include nqa
ip route-static 0.0.0.0 0.0.0.0 10.1.10.1 track nqa user test1
ip route-static 0.0.0.0 0.0.0.0 10.1.20.1 track nqa user test2
nqa test-instance user test1
nqa test-instance user test2
# Check NQA test results.
[SwitchA] display nqa results test-instance user test1
NQA entry(user, test1) :testflag is active ,testtype is icmp
1 . Test 10 result The test is finished
Send operation times: 2 Receive response times: 2
Completion:success RTD OverThresholds number: 0
Attempts number:1 Drop operation number:0
Disconnect operation number:0 Operation timeout number:0
System busy operation number:0 Connection fail number:0
Operation sequence errors number:0 RTT Status errors number:0
Destination ip address:10.1.10.1
Min/Max/Average Completion Time: 30/30/30
Sum/Square-Sum Completion Time: 7/25
Last Good Probe Time: 2014-09-09 09:55:38.2
Lost packet ratio: 0 %
[SwitchA] display nqa results test-instance user test2
NQA entry(user, test2) :testflag is active ,testtype is icmp
1 . Test 11 result The test is finished
Send operation times: 2 Receive response times: 2
Completion:success RTD OverThresholds number: 0
Attempts number:1 Drop operation number:0
Disconnect operation number:0 Operation timeout number:0
System busy operation number:0 Connection fail number:0
Operation sequence errors number:0 RTT Status errors number:0
Destination ip address:10.1.20.1
Min/Max/Average Completion Time: 30/30/30
Sum/Square-Sum Completion Time: 7/25
Last Good Probe Time: 2014-09-09 09:56:38.2
Lost packet ratio: 0 %
Completion:success and Lost packet ratio: 0 % in the command output show
that the links between SwitchA and RouterA and between SwitchA and RouterB
are normal.
# Check the routing table. The command output shows that there are two default
static routes destined for RouterA and RouterB, respectively.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 9 Routes : 10
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 Static 60 0 RD 10.1.10.1 Vlanif100
Static 60 0 RD 10.1.20.1 Vlanif200
10.1.10.0/24 Direct 0 0 D 10.1.10.2 Vlanif100
10.1.10.2/32 Direct 0 0 D 127.0.0.1 Vlanif100
10.1.20.0/24 Direct 0 0 D 10.1.20.2 Vlanif200
10.1.20.2/32 Direct 0 0 D 127.0.0.1 Vlanif200
10.1.30.0/24 Direct 0 0 D 10.1.30.2 Vlanif300
10.1.30.2/32 Direct 0 0 D 127.0.0.1 Vlanif300
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 56
# Shut down GigabitEthernet0/0/2 on SwitchA to simulate a link fault.
[SwitchA] interface GigabitEthernet0/0/2
[SwitchA-GigabitEthernet0/0/2] shutdown
[SwitchA-GigabitEthernet0/0/2] quit
# Check NQA test results.
[SwitchA] display nqa results test-instance user test1
NQA entry(user, test1) :testflag is active ,testtype is icmp
1 . Test 12 result The test is finished
Send operation times: 2 Receive response times: 2
Completion:success RTD OverThresholds number: 0
Attempts number:1 Drop operation number:0
Disconnect operation number:0 Operation timeout number:0
System busy operation number:0 Connection fail number:0
Operation sequence errors number:0 RTT Status errors number:0
Destination ip address:10.1.10.1
Min/Max/Average Completion Time: 30/30/30
Sum/Square-Sum Completion Time: 7/25
Last Good Probe Time: 2014-09-09 09:57:38.2
Lost packet ratio: 0 %
[SwitchA] display nqa results test-instance user test2
NQA entry(user, test2) :testflag is active ,testtype is icmp
1 . Test 13 result The test is finished
Send operation times: 2 Receive response times: 0
Completion:failed RTD OverThresholds number: 0
Attempts number:1 Drop operation number:0
Disconnect operation number:0 Operation timeout number:2
System busy operation number:0 Connection fail number:0
Operation sequence errors number:0 RTT Status errors number:0
Destination ip address:10.1.20.1
Min/Max/Average Completion Time: 0/0/0
Sum/Square-Sum Completion Time: 0/0
Last Good Probe Time: 0000-00-00 00:00:00.0
Lost packet ratio: 100 %
Completion:failed and Lost packet ratio: 100 % in the command output show
that the link between SwitchA and RouterB is faulty.
# Check the routing table. Only the default static route to RouterA is available.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 7 Routes : 7
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 Static 60 0 RD 10.1.10.1 Vlanif100
10.1.10.0/24 Direct 0 0 D 10.1.10.2 Vlanif100
10.1.10.2/32 Direct 0 0 D 127.0.0.1 Vlanif100
10.1.30.0/24 Direct 0 0 D 10.1.30.2 Vlanif300
10.1.30.2/32 Direct 0 0 D 127.0.0.1 Vlanif300
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
----End
Configuration Files
SwitchA configuration file
#
sysname SwitchA
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 57
vlan batch 100 200 300
#
interface Vlanif100
ip address 10.1.10.2 255.255.255.0
#
interface Vlanif200
ip address 10.1.20.2 255.255.255.0
#
interface Vlanif300
ip address 10.1.30.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 100
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 200
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 300
#
ip route-static 0.0.0.0 0.0.0.0 10.1.10.1 track nqa user test1
ip route-static 0.0.0.0 0.0.0.0 10.1.20.1 track nqa user test2
#
nqa test-instance user test1
test-type icmp
destination-address ipv4 10.1.10.1
frequency 11
interval seconds 5
timeout 4
probe-count 2
start now
#
nqa test-instance user test2
test-type icmp
destination-address ipv4 10.1.20.1
frequency 11
interval seconds 5
timeout 4
probe-count 2
start no
#
return
2.14.6 Example for Configuring NQA for IPv6 Static Routes
Networking Requirements
As shown in Figure 2-11, SwitchA on a company network is connected to two
egress routers (RouterA and RouterB) through two default static routes to
implement load balancing. The company wants to deploy a link failure detection
mechanism for the default static routes, so that traffic can be switched from a
faulty link to the other functioning link promptly to prevent services from being
interrupted.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 58
Figure 2-11 Configuring NQA for IPv6 static routes
Configuration Roadmap
1. Create VLANs, add interfaces to the VLANs, and configure IP addresses for
VLANIF interfaces, so that neighboring devices can communicate with each
other.
2. Create ICMP NQA test instances to monitor the status of links.
ICMP NQA test instances need to be created on the NQA client SwitchA to
detect the status of links between SwitchA and RouterA and between SwitchA
and RouterB.
3. Configure default static routes and bind them to the NQA test instances.
Default static routes destined for RouterA and RouterB need to be configured
on SwitchA and bound to NQA test instances. In this way, if an NQA test
instance detects a link failure, traffic is switched to the other link.
Procedure
Step 1 On SwitchA, create VLANs and add interfaces to them.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 100 200 300
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 100
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 200
[SwitchA-GigabitEthernet0/0/2] quit
[SwitchA] interface gigabitethernet 0/0/3
[SwitchA-GigabitEthernet0/0/3] port link-type trunk
[SwitchA-GigabitEthernet0/0/3] port trunk allow-pass vlan 300
[SwitchA-GigabitEthernet0/0/3] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 59
Step 2 On SwitchA, configure an IP address for each VLANIF interface.
[SwitchA] interface vlanif 100
[SwitchA-Vlanif100] ipv6 enable
[SwitchA-Vlanif100] ip address fc00:0:0:2001::2/64
[SwitchA-Vlanif100] quit
[SwitchA] interface vlanif 200
[SwitchA-Vlanif200] ipv6 enable
[SwitchA-Vlanif200] ip address fc00:0:0:2002::2/64
[SwitchA-Vlanif200] quit
[SwitchA] interface vlanif 300
[SwitchA-Vlanif300] ipv6 enable
[SwitchA-Vlanif300] ip address fc00:0:0:2003::2/64
[SwitchA-Vlanif300] quit
Step 3 On SwitchA, configure NQA test instances.
[SwitchA] nqa test-instance user test1
[SwitchA-nqa-user-test1] test-type icmp
[SwitchA-nqa-user-test1] destination-address ipv6 fc00:0:0:2001::1
[SwitchA-nqa-user-test1] frequency 11
[SwitchA-nqa-user-test1] probe-count 2
[SwitchA-nqa-user-test1] interval seconds 5
[SwitchA-nqa-user-test1] timeout 4
[SwitchA-nqa-user-test1] start now
[SwitchA-nqa-user-test1] quit
[SwitchA] nqa test-instance user test2
[SwitchA-nqa-user-test2] test-type icmp
[SwitchA-nqa-user-test2] destination-address ipv6 fc00:0:0:2002::1
[SwitchA-nqa-user-test2] frequency 11
[SwitchA-nqa-user-test2] probe-count 2
[SwitchA-nqa-user-test2] interval seconds 5
[SwitchA-nqa-user-test2] timeout 4
[SwitchA-nqa-user-test2] start now
[SwitchA-nqa-user-test2] quit
Step 4 Configure default static routes and bind them to the NQA test instances.
[SwitchA] ipv6 route-static :: 0 fc00:0:0:2001::1 track nqa user test1
[SwitchA] ipv6 route-static :: 0 fc00:0:0:2002::1 track nqa user test2
Step 5 Verify the configuration.
# Check the configuration of NQA for default static routes. The command output
shows that the default static routes have been bound to NQA test instances.
[SwitchA] display current-configuration | include nqa
ip route-static :: 0 fc00:0:0:2001::1 track nqa user test1
ip route-static :: 0 fc00:0:0:2002::1 track nqa user test2
nqa test-instance user test1
nqa test-instance user test2
# Check NQA test results.
[SwitchA] display nqa results test-instance user test1
NQA entry(user, test1) :testflag is active ,testtype is icmp
1 . Test 10 result The test is finished
Send operation times: 2 Receive response times: 2
Completion:success RTD OverThresholds number: 0
Attempts number:1 Drop operation number:0
Disconnect operation number:0 Operation timeout number:0
System busy operation number:0 Connection fail number:0
Operation sequence errors number:0 RTT Status errors number:0
Destination ip address:FC00:0:0:2001::1
Min/Max/Average Completion Time: 30/30/30
Sum/Square-Sum Completion Time: 7/25
Last Good Probe Time: 2020-06-17 16:06:28.0
Lost packet ratio: 0 %
[SwitchA] display nqa results test-instance user test2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 60
NQA entry(user, test2) :testflag is active ,testtype is icmp
1 . Test 11 result The test is finished
Send operation times: 2 Receive response times: 2
Completion:success RTD OverThresholds number: 0
Attempts number:1 Drop operation number:0
Disconnect operation number:0 Operation timeout number:0
System busy operation number:0 Connection fail number:0
Operation sequence errors number:0 RTT Status errors number:0
Destination ip address:FC00:0:0:2002::1
Min/Max/Average Completion Time: 30/30/30
Sum/Square-Sum Completion Time: 7/25
Last Good Probe Time: 2020-06-17 16:10:14.2
Lost packet ratio: 0 %
Completion:success and Lost packet ratio: 0 % in the command output show
that the links between SwitchA and RouterA and between SwitchA and RouterB
are normal.
# Check the routing table. The command output shows that there are two default
static routes destined for RouterA and RouterB, respectively.
[SwitchA] display ipv6 routing-table
Routing Table : Public
Destinations :9 Routes : 10
Destination : :: PrefixLength : 0
NextHop : FC00:0:0:2001::1 Preference : 60
Cost : 0 Protocol : Static
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif100 Flags : RD
Destination : :: PrefixLength : 0
NextHop : FC00:0:0:2002::1 Preference : 60
Cost : 0 Protocol : Static
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif200 Flags : RD
Destination : ::1 PrefixLength : 128
NextHop : ::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : InLoopBack0 Flags : D
Destination : FC00:0:0:2001:: PrefixLength : 64
NextHop : FC00:0:0:2001::2 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif100 Flags : D
Destination : FC00:0:0:2001::2 PrefixLength : 128
NextHop : ::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif100 Flags : D
Destination : FC00:0:0:2002:: PrefixLength : 64
NextHop : FC00:0:0:2002::2 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif200 Flags : D
Destination : FC00:0:0:2002::2 PrefixLength : 128
NextHop : ::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif200 Flags : D
Destination : FC00:0:0:2003:: PrefixLength : 64
NextHop : FC00:0:0:2003::1 Preference : 0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 61
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif300 Flags : D
Destination : FC00:0:0:2003::1 PrefixLength : 128
NextHop : ::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif300 Flags : D
Destination : FE80:: PrefixLength : 10
NextHop : :: Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : NULL0 Flags : D
# Shut down GigabitEthernet0/0/2 on SwitchA to simulate a link fault.
[SwitchA] interface GigabitEthernet0/0/2
[SwitchA-GigabitEthernet0/0/2] shutdown
[SwitchA-GigabitEthernet0/0/2] quit
# Check NQA test results.
[SwitchA] display nqa results test-instance user test1
NQA entry(user, test1) :testflag is active ,testtype is icmp
1 . Test 12 result The test is finished
Send operation times: 2 Receive response times: 2
Completion:success RTD OverThresholds number: 0
Attempts number:1 Drop operation number:0
Disconnect operation number:0 Operation timeout number:0
System busy operation number:0 Connection fail number:0
Operation sequence errors number:0 RTT Status errors number:0
Destination ip address:FC00:0:0:2001::1
Min/Max/Average Completion Time: 30/30/30
Sum/Square-Sum Completion Time: 7/25
Last Good Probe Time: 2020-06-17 16:21:41.0
Lost packet ratio: 0 %
[SwitchA] display nqa results test-instance user test2
NQA entry(user, test2) :testflag is active ,testtype is icmp
1 . Test 13 result The test is finished
Send operation times: 2 Receive response times: 0
Completion:failed RTD OverThresholds number: 0
Attempts number:1 Drop operation number:0
Disconnect operation number:0 Operation timeout number:2
System busy operation number:0 Connection fail number:0
Operation sequence errors number:0 RTT Status errors number:0
Destination ip address:FC00:0:0:2002::1
Min/Max/Average Completion Time: 0/0/0
Sum/Square-Sum Completion Time: 0/0
Last Good Probe Time: 0000-00-00 00:00:00.0
Lost packet ratio: 100 %
Completion:failed and Lost packet ratio: 100 % in the command output show
that the link between SwitchA and RouterB is faulty.
# Check the routing table. Only the default static route to RouterA is available.
[SwitchA] display ipv6 routing-table
Routing Table : Public
Destinations :7 Routes : 7
Destination : :: PrefixLength : 0
NextHop : FC00:0:0:2001::1 Preference : 60
Cost : 0 Protocol : Static
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif100 Flags : RD
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 62
Destination : ::1 PrefixLength : 128
NextHop : ::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : InLoopBack0 Flags : D
Destination : FC00:0:0:2001:: PrefixLength : 64
NextHop : FC00:0:0:2001::2 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif100 Flags : D
Destination : FC00:0:0:2001::2 PrefixLength : 128
NextHop : ::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif100 Flags : D
Destination : FC00:0:0:2003:: PrefixLength : 64
NextHop : FC00:0:0:2003::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif300 Flags : D
Destination : FC00:0:0:2003::1 PrefixLength : 128
NextHop : ::1 Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : Vlanif300 Flags : D
Destination : FE80:: PrefixLength : 10
NextHop : :: Preference : 0
Cost : 0 Protocol : Direct
RelayNextHop : :: TunnelID : 0x0
Interface : NULL0 Flags : D
----End
Configuration Files
SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
vlan batch 100 200 300
#
interface Vlanif100
ipv6 enable
ipv6 address fc00:0:0:2001::2/64
#
interface Vlanif200
ipv6 enable
ipv6 address fc00:0:0:2002::2/64
#
interface Vlanif300
ipv6 enable
ipv6 address fc00:0:0:2003::2/64
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 100
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 200
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 63
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 300
#
ipv6 route-static :: 0 fc00:0:0:2001::1 track nqa user test1
ipv6 route-static :: 0 fc00:0:0:2002::1 track nqa user test2
#
nqa test-instance user test1
test-type icmp
destination-address ipv6 fc00:0:0:2001::1
frequency 11
interval seconds 5
timeout 4
probe-count 2
start now
#
nqa test-instance user test2
test-type icmp
destination-address ipv6 fc00:0:0:2002::1
frequency 11
interval seconds 5
timeout 4
probe-count 2
start now
#
return
2.14.7 Example for Configuring EFM for Static IPv4 Routes
Networking Requirements
In Figure 2-12, SwitchA connects to the NMS across a network segment through
SwitchB. SwitchA communicates with the NMS using static routes. SwitchA and
SwitchB need to detect the link quality in real time. When the link between them
becomes faulty, the corresponding static route will be deleted from the IP routing
table. Traffic is then switched from the route using the faulty link to a working
route to improve network reliability.
Figure 2-12 Configuring EFM for IPv4 static routes
Configuration Roadmap
The configuration roadmap is as follows:
1. Enable Ethernet in the First Mile (EFM) OAM globally and on interfaces of
SwitchA and SwitchB to implement real-time link quality detection.
2. Configure an IPv4 static route from SwitchA to the NMS and bind the static
route to the EFM state to associate the static route with EFM. When a link
where the static route resides becomes faulty, traffic is switched to a route
without link faults.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 64
Procedure
Step 1 Configure VLANs and add interfaces to the VLANs.
# Configure SwitchA. The configuration of SwitchB is similar to that of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan 10
[SwitchA-vlan10] quit
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Configure IP addresses for VLANIF interfaces.
# Configure SwitchA. The configuration of SwitchB is similar to that of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.1 24
[SwitchA-Vlanif10] quit
Step 3 Configure an EFM session between SwitchA and SwitchB.
# Enable EFM OAM on SwitchA.
[SwitchA] efm enable
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] efm enable
[SwitchA-GigabitEthernet0/0/1] quit
# Enable EFM OAM on SwitchB.
[SwitchB] efm enable
[SwitchB] interface gigabitethernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] efm enable
[SwitchB-GigabitEthernet0/0/1] quit
Step 4 Configure a static route and bind it to the EFM state.
# Configure a static route from SwitchA to an external network and bind it to the
EFM state of GigabitEthernet0/0/1.
[SwitchA] ip route-static 192.168.2.0 24 192.168.1.2 track efm-state gigabitethernet0/0/1
Step 5 Verify the configuration.
# After the configuration is complete, run the display efm session all command
on SwitchA and SwitchB. The command output shows that an EFM session has
been set up and is in detect mode. That is, the interface is in handshake state. The
following uses the display on SwitchA as an example.
[SwitchA] display efm session all
Interface EFM State Loopback Timeout
----------------------------------------------------------------------
GigabitEthernet0/0/1 detect --
# Check the IP routing table on SwitchA. The IP routing table contains the static
route 192.168.2.0/24.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 5 Routes : 5
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 65
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.1.0/24 Direct 0 0 D 192.168.1.1 Vlanif10
192.168.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
192.168.2.0/24 Static 60 0 RD 192.168.1.2 Vlanif10
# Run the undo efm enable command in the view of GigabitEthernet0/0/1 on
SwitchB to simulate a link fault.
[SwitchB] interface gigabitethernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] undo efm enable
# Run the display efm session all command on SwitchA. The command output
shows that the EFM OAM protocol state is discovery, indicating that the interface
is in OAM discovery state.
[SwitchA] display efm session all
Interface EFM State Loopback Timeout
----------------------------------------------------------------------
GigabitEthernet0/0/1 discovery --
# Check the IP routing table on SwitchA. The IP routing table does not contain the
static route 192.168.2.0/24. This is because the static route has been bound to the
EFM state, and EFM OAM rapidly notifies SwitchA that the static route becomes
unavailable after detecting a link fault.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 4 Routes : 4
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.1.0/24 Direct 0 0 D 192.168.1.1 Vlanif10
192.168.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
# Run the efm enable command in the view of GigabitEthernet0/0/1 on SwitchB
to simulate link recovery.
[SwitchB-GigabitEthernet0/0/1]efm enable
# Run the display efm session all command on SwitchA. The command output
shows that the EFM OAM protocol state is detect, indicating that the interface is
in handshake state again.
[SwitchA] display efm session all
Interface EFM State Loopback Timeout
----------------------------------------------------------------------
GigabitEthernet0/0/1 detect --
# Check the IP routing table on SwitchA. The IP routing table contains the static
route 192.168.2.0/24 again. This is because EFM OAM rapidly notifies that the
bound static route becomes reachable again after detecting link recovery.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 5 Routes : 5
Destination/Mask Proto Pre Cost Flags NextHop Interface
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 66
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.1.0/24 Direct 0 0 D 192.168.1.1 Vlanif10
192.168.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
192.168.2.0/24 Static 60 0 RD 192.168.1.2 Vlanif10
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10
#
efm enable
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
efm enable
#
ip route-static 192.168.2.0 255.255.255.0 192.168.1.2 track efm-state GigabitEthernet0/0/1
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20
#
efm enable
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
efm enable
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
return
2.14.8 Example for Configuring Association Between IPv4
Static Routes and a Route Monitoring Group
Networking Requirements
On a company's network shown in Figure 2-13, SwitchC at the access layer
connects to SwitchB and SwitchD at the aggregation layer through static routes.
SwitchB and SwitchD work in redundancy mode. The customer requirements are
as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 67
● A link failure detection mechanism is deployed for static routes, so that traffic
can be switched from a faulty link to a normal link in a timely manner to
prevent service interruption for a long time.
● In normal situations, service traffic from the access side is forwarded to the IP
network through SwitchB.
● If the link between SwitchB and SwitchA fails, only the link between SwitchD
and the IP network is available. In this case, service traffic from the access
side is switched to SwitchD to prevent traffic loss.
Figure 2-13 Configuring association between IPv4 static routes and a route
monitoring group
Device Name Interface IP Address
SwitchA
VLANIF 10 192.168.10.1/24
VLANIF 20 192.168.20.1/24
VLANIF 100 192.168.100.1/24
SwitchB
VLANIF 10 192.168.10.2/24
VLANIF 40 192.168.40.1/24
SwitchC VLANIF 30 192.168.30.2/24
VLANIF 40 192.168.40.2/24
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 68
Device Name Interface IP Address
VLANIF 50 192.168.50.1/24
SwitchD VLANIF 20 192.168.20.2/24
VLANIF 30 192.168.30.1/24
Configuration Roadmap
The configuration roadmap is as follows:
1. Create VLANs, add interfaces to the VLANs, and configure IP addresses for
VLANIF interfaces, so that neighboring devices can communicate with each
other.
2. Configure static routes and bind them to a route monitoring group. On
SwitchC, configure static routes, set a low cost for the route corresponding to
the active link, and bind the static routes to a route monitoring group. In this
way, the links can work in active/standby mode, and IPv4 static routes are
associated with the route monitoring group.
Procedure
1. Configure VLANs to which interfaces belong.
# Configure SwitchC. The configurations of other devices are similar to those
of SwitchC.
<HUAWEI> system-view
[HUAWEI] sysname SwitchC
[SwitchC] vlan batch 30 40 50
[SwitchC] interface gigabitethernet 0/0/1
[SwitchC-gigabitethernet0/0/1] port link-type trunk
[SwitchC-gigabitethernet0/0/1] port trunk allow-pass vlan 30
[SwitchC-gigabitethernet0/0/1] quit
[SwitchC] interface gigabitethernet 0/0/2
[SwitchC-gigabitethernet0/0/2] port link-type trunk
[SwitchC-gigabitethernet0/0/2] port trunk allow-pass vlan 40
[SwitchC-gigabitethernet0/0/2] quit
[SwitchC] interface gigabitethernet 0/0/3
[SwitchC-gigabitethernet0/0/3] port link-type trunk
[SwitchC-gigabitethernet0/0/3] port trunk allow-pass vlan 50
[SwitchC-gigabitethernet0/0/3] quit
2. Configure an IP address for each VLANIF interface.
# Configure SwitchC. The configurations of other devices are similar to those
of SwitchC.
[SwitchC] interface vlanif 30
[SwitchC-Vlanif10] ip address 192.168.30.2 24
[SwitchC-Vlanif10] quit
[SwitchC] interface vlanif 40
[SwitchC-Vlanif40] ip address 192.168.40.2 24
[SwitchC-Vlanif40] quit
[SwitchC] interface vlanif 50
[SwitchC-Vlanif50] ip address 192.168.50.1 24
[SwitchC-Vlanif50] quit
3. Configure static routes and bind them to a route monitoring group.
# On SwitchC, create the route monitoring group uplink.
[SwitchC] ip route-monitor-group uplink
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 69
# On SwitchC, add routes to be monitored to the route monitoring group
uplink.
[SwitchC-route-monitor-group-uplink] track ip route 192.168.100.0 255.255.255.0
# On SwitchC, enable the route monitoring group.
[SwitchC-route-monitor-group-uplink] monitor enable
[SwitchC-route-monitor-group-uplink] quit
# On SwitchC, configure static routes to the external network and bind the
static routes to the route monitoring group uplink.
[SwitchC] ip route-static 0.0.0.0 0.0.0.0 192.168.40.1 preference 50 track route-monitor-group
uplink
[SwitchC] ip route-static 0.0.0.0 0.0.0.0 192.168.30.1
# On SwitchB, configure a static route to Client1.
<HUAWEI> system-view
[HUAWEI] sysname SwitchB
[SwitchB] ip route-static 192.168.50.0 255.255.255.0 192.168.40.2
# On SwitchD, configure a static route to Client1.
<HUAWEI> system-view
[HUAWEI] sysname SwitchD
[SwitchD] ip route-static 192.168.50.0 255.255.255.0 192.168.30.2
4. Verify the configuration.
# Check information about the route monitoring group uplink on SwitchC.
The command output shows that the route monitoring group has been
enabled and the route to 192.168.100.0/24 is an active route.
[SwitchC] display ip route-monitor-group uplink
route monitor group uplink
State : Enabled
-------------------------------------------------------
route monitor group tracking route number : 1
-------------------------------------------------------
VPN name : Public
Destination : 192.168.100.0
Mask : 255.255.255.0
State : Active
# Check information about static routes on SwitchC to determine the active
and standby links.
[SwitchC] display ip routing-table protocol static
Route Flags: R - relay, D - download to fib, T - to vpn-
instance
------------------------------------------------------------------------------
Public routing table : Static
Destinations : 1 Routes : 2 Configured Routes : 6
Static routing table status : <Active>
Destinations : 1 Routes : 1
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 Static 50 0 D 192.168.40.1 Vlanif40
Static routing table status : <Inactive>
Destinations : 1 Routes : 1
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 Static 60 0 192.168.30.1 Vlanif30
# Disable gigabitethernet0/0/1 on SwitchB to simulate a link failure.
[SwitchB] interface gigabitethernet 0/0/1
[SwitchB-gigabitethernet0/0/1] shutdown
[SwitchB-gigabitethernet0/0/1] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 70
# Check information about the route monitoring group uplink on SwitchC.
The command output shows that the route status corresponding to the faulty
link is Inactive.
[SwitchC] display ip route-monitor-group uplink
route monitor group uplink
State : Enabled
-------------------------------------------------------
route monitor group tracking route number : 1
-------------------------------------------------------
VPN name : Public
Destination : 192.168.100.0
Mask : 255.255.255.0
State : Inactive
# Check information about static routes on SwitchC. The command output
shows that static routes on SwitchC have been bound to a route monitoring
group. If the route monitoring group detects a link failure, the RM module
immediately notifies the access device that the corresponding route is
unavailable.
[SwitchC] display ip routing-table protocol static
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Public routing table : Static
Destinations : 1 Routes : 2 Configured Routes : 6
Static routing table status : <Active>
Destinations : 1 Routes : 1
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 Static 60 0 D 192.168.30.1 Vlanif40
Static routing table status : <Inactive>
Destinations : 1 Routes : 1
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 Static 50 0 192.168.40.1 Vlanif30
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20 100
#
interface Vlanif10
ip address 192.168.100.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.20.1 255.255.255.0
#
interface Vlanif100
ip address 192.168.100.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 71
port trunk allow-pass vlan 100
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 40
#
interface Vlanif10
ip address 192.168.10.2 255.255.255.0
#
interface Vlanif40
ip address 192.168.40.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
ip route-static 192.168.50.0 255.255.255.0 192.168.40.2
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 30 40 50
#
interface Vlanif30
ip address 192.168.30.2 255.255.255.0
#
interface Vlanif40
ip address 192.168.40.2 255.255.255.0
#
interface Vlanif50
ip address 192.168.50.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 50
#
ip route-monitor-group uplink
track ip route 192.168.100.0 255.255.255.0
monitor enable
#
ip route-static 0.0.0.0 0.0.0.0 192.168.40.1 preference 50 track route-monitor-group uplink
ip route-static 0.0.0.0 0.0.0.0 192.168.30.1
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 20 30
#
interface Vlanif20
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 72
ip address 192.168.20.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.30.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
ip route-static 192.168.50.0 255.255.255.0 192.168.30.2
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 2 Static Route Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 73
3 RIP Configuration
3.1 Overview of RIP
3.2 Understanding RIP
3.3 Summary of RIP Configuration Tasks
3.4 Licensing Requirements and Limitations for RIP
3.5 Default Settings for RIP
3.6 Configuring Basic RIP Functions
3.7 Configuring RIP-2
3.8 Preventing Routing Loops
3.9 Controlling RIP Routing
3.10 Controlling RIP Route Advertisement
3.11 Controlling Receiving of RIP Routing Information
3.12 Improving RIP Network Performance
3.13 Configuring BFD for RIP
3.14 Configuring the Network Management Function for RIP
3.15 Maintaining RIP
3.16 Configuration Examples for RIP
3.17 Troubleshooting RIP
3.1 Overview of RIP
Definition
RIP is a distance-vector protocol that uses hop count to measure the distance to a
destination. It is a simple Interior Gateway Protocol (IGP) that is easier to
implement, configure, and manage than other routing protocols such as OSPF and
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 74
IS-IS. RIP exchanges routing information using UDP packets through UDP port
520.
Two RIP versions are used in IPv4 networks: RIP version 1 (RIP-1) and RIP version
2 (RIP-2). RIP-2 is an extension to RIP-1.
Purpose
RIP is widely used on small-sized networks to discover routes and generate routing
information. It is not suitable for complex or large-sized networks.
3.2 Understanding RIP
3.2.1 RIP Fundamentals
RIP Routing Table
When RIP starts on a switch, the RIP routing table on the switch contains only
direct routes. Neighboring switches on different network segments can
communicate with each other only after they learn routing entries from each
other.
Figure 3-1 shows the process of generating a RIP routing table.
Figure 3-1 RIP routing table generation
1. RIP starts on SwitchA and SwitchB.
2. SwitchA broadcasts a Request packet to neighboring routers.
3. SwitchB receives the Request packet, encapsulates its RIP routing table into a
Response packet, and then broadcasts the Response packet to the network
segment connected to the interface that received the Request packet.
4. SwitchA receives the Response packet and then generates its RIP routing table
based on this packet.
RIP updates and selects routes through route advertisements. In this situation,
switches do not know the entire network topology and just know the distances to
destination networks and the direction or interface used to reach destination
networks. In Figure 3-2, SwitchB receives a route advertisement from SwitchA and
knows that it can reach the network 192.168.1.0/24 through SwitchA with the hop
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 75
count 1. Even though information contained in this advertisement becomes
incorrect, SwitchB still considers that it can reach the network 192.168.1.0/24
through SwitchA with the hop count 1. This is the root cause for routing loops on
a RIP network.
Figure 3-2 RIP route update and selection based on route advertisements
RIP Metric
In RIP, the default hop count from a device to its directly connected network is 0,
and the hop count from a device to a reachable network through another device is
1. That is, the hop count (the metric) equals the number of devices along the path
from the local network to the destination network.
In Figure 3-3, S1 has two paths to the network segment 192.168.10.0/24:
● One path is S1-S2-S5, passing through two devices: S2 and S5. It has a hop
count of 2 and bandwidth of 1.544 Mbit/s.
● The other path is S1-S3-S4-S5, passing through three devices: S3, S4, and S5.
It has a hop count of 3 and bandwidth of 1 Gbit/s.
Figure 3-3 RIP metric
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 76
As required by the RIP metric standards, packets will be forwarded along the path
passing through S2; however, the link bandwidth of this path is not the highest.
This causes low bandwidth efficiency on the RIP network and hinders QoS
management.
To prevent the hop count from becoming infinite when RIP routes are flooded
indefinitely on the network, and to limit the convergence time, RIP allows a
maximum of 15 hops. A hop count of 16 or greater is defined as infinity, making
the destination network or host unreachable. This design limits the network scale
that RIP supports. Therefore, RIP is not suitable for large-scale networks.
RIP Route Update and Maintenance
RIP uses three timers to update and maintain routing information:
● Update timer
When this timer expires, a RIP device immediately sends an Update packet.
● Age timer
If a RIP device does not receive any Update packet of a route from a neighbor
within the Age timer, the RIP device considers this route unreachable.
● Garbage-collect timer
If a RIP device does not receive any Update packet of an unreachable route
within the Garbage-collect timer, the device deletes this route from its RIP
routing table.
The interval for sending Update packets is determined by the Update timer, which
is 30 seconds by default.
Each routing entry has two timers: Age timer and Garbage-collect timer. When a
RIP device adds a learned route to the local RIP routing table, the Age timer starts
for the route. If the RIP device does not receive an Update packet from the
neighbor within the aging time, the RIP device sets the Cost value of the route to
16 (unreachable) and starts the Garbage-collect timer. If the RIP device still does
not receive any Update packet before the Garbage-collect timer expires, the RIP
device deletes the route from the RIP routing table.
Triggered Route Update
When routing information changes, a device immediately sends an Update packet
to its neighbors without waiting for the Update timer to expire. This function
prevents routing loops.
Figure 3-4 shows the process of triggering a route update.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 77
Figure 3-4 Triggered route update
SwitchC first learns that network 10.4.0.0 becomes unreachable.
If SwitchC does not support triggered route update when detecting a network
fault, it must wait until the Update timer expires. Before this timer expires, if
SwitchC receives an Update packet from SwitchB, it learns an incorrect route to
network 10.4.0.0. In this case, SwitchB and SwitchC are each other's next hop to
network 10.4.0.0. This results in a routing loop.
If SwitchC supports triggered route update when detecting a network fault, it
immediately sends to SwitchB an Update packet, preventing a routing loop.
3.2.2 RIP-2 Enhanced Features
RIP has two versions: RIP-1 and RIP-2. RIP-2 is an extension to RIP-1.
Comparison Between RIP-1 and RIP-2
RIP-1 is a classful routing protocol, whereas RIP-2 is a classless routing protocol. In
RIP-1, protocol packets can be advertised only in broadcast mode. Because RIP-1
packets do not carry any mask information, they identify only the routes of
natural network segments (Class A, Class B, and Class C). Therefore, RIP-1 does
not support route summarization or discontiguous subnets.
Figure 3-5 and Figure 3-6 show the RIP-1 and RIP-2 packet formats.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 78
Figure 3-5 RIP-1 packet format
Figure 3-6 RIP-2 packet format
RIP-2 has the following advantages over RIP-1:
● Supports route tag and can flexibly control routes based on the tag in routing
policies.
● Supports mask information and can therefore support route summarization
and Classless Inter-Domain Routing (CIDR).
● Supports a next-hop address and can select the optimal next-hop address on
broadcast networks.
● Supports the sending of update packets in multicast mode. Only RIP-2 devices
can receive RIP-2 packets, saving resources.
● Provides packet authentication to enhance security.
RIP-2 Route Summarization
When different subnet routes within the same natural network segment are
transmitted to other network segments, these routes are summarized into one
route of the same network segment. This process is called route summarization.
RIP-2 route summarization improves scalability and efficiency and reduces the size
of the routing table for large networks.
RIP-2 route summarization is classified into two types:
● RIP process-based classful summarization
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 79
Summarized routes are advertised using natural masks. For example, route
10.1.1.0/24 (metric=2) and route 10.1.2.0/24 (metric=3) are summarized as
one route 10.0.0.0/8 (metric=2) in the natural network segment. RIP-2
supports classful summarization to obtain the optimal metric.
● Interface-based summarization
You can specify a summarized address. For example, configure route
10.1.0.0/16 (metric=2) on an interface as the summarized route of route
10.1.1.0/24 (metric=2) and route 10.1.2.0/24 (metric=3).
3.2.3 Split Horizon and Poison Reverse
Split Horizon
Split horizon prevents a route learned by RIP on an interface from being sent to
neighbors through this interface. This function reduces bandwidth consumption
and avoids routing loops.
Split horizon provides two models for different networks:
● Interface-based split horizon
● Neighbor-based split horizon
Interface-based split horizon is used on broadcast, point-to-point (P2P), and point-
to-multipoint (P2MP) networks.
Figure 3-7 illustrates interface-based split horizon.
Figure 3-7 Interface-based split horizon
RouterA sends routing information destined for 10.0.0.0/8 to RouterB. If split
horizon is not configured, RouterB sends the route learned from RouterA back to
RouterA. Therefore, RouterA learns two routes destined for 10.0.0.0/8: a direct
route with hop count 0 and a route with the next hop RouterB and hop count 2.
However, only the direct route in the RIP routing table of RouterA is active. If the
route from RouterA to network 10.0.0.0 becomes unreachable, RouterB does not
receive the route unreachable message immediately and continues to notify
RouterA that network 10.0.0.0/8 is reachable.
Therefore, RouterA receives incorrect routing information and considers that
network 10.0.0.0/8 is reachable through RouterB, and RouterB considers that
network 10.0.0.0/8 is reachable through RouterA, resulting in a routing loop.
Using the split horizon function, RouterB does not send the route destined for
10.0.0.0/8 back to RouterA, avoiding a routing loop.
On a Non-Broadcast Multiple Access (NBMA) network, an interface connects to
multiple neighbors; therefore, neighbor-based split horizon is used, as shown in
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 80
Figure 3-8. Routes are advertised in unicast mode and the routes received by an
interface are differentiated by neighbors. The route learned from a neighbor will
not be sent back through the same interface.
Figure 3-8 Neighbor-based split horizon
RouterA sends route 172.16.0.0/16 learned from RouterB to RouterC, but does not
send it back to RouterB.
Poison Reverse
Poison reverse enables RIP to set the cost of the route learned through a local
interface from a neighbor to 16 (unreachable) and then send this route through
the same interface back to the neighbor. This function deletes invalid routes from
the neighbor's routing table and prevents routing loops.
In Figure 3-9, after receiving a route from RouterA, RouterB sends a route
unreachable message (with the route cost set to 16) to RouterA, avoiding a
routing loop.
Figure 3-9 Poison reverse
3.2.4 Multi-Process and Multi-Instance
The multi-process feature associates a RIP process with multiple interfaces. This
ensures that a specific process performs all the protocol-related operations only on
designated interfaces. In this situation, multiple RIP processes can run on a device
independently. Route exchange between these RIP processes is similar to route
exchange between different routing protocols.
RIP multi-instance associates a VPN instance with a RIP process so that the VPN
instance can be associated with all the interfaces in this RIP process.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 81
3.2.5 BFD for RIP
Bidirectional Forwarding Detection (BFD) detects faults on links between
neighboring routers. It is often associated with routing protocols so that these
protocols can be notified of link faults in order to quickly trigger route
convergence. Traffic loss caused by topology changes is therefore minimized. After
RIP is associated with BFD, BFD rapidly detects link faults and reports the faults to
RIP. This ensures that RIP quickly responds to network topology changes.
Table 3-1 lists link fault detection mechanisms and the convergence speed before
and after BFD for RIP is enabled.
Table 3-1 BFD speeds up convergence
BFD for RIP Link Fault Detection Mechanism Convergence
Speed
Disabled The RIP Age timer expires. By default,
this timer is 180 seconds.
> 180 seconds
Enabled The BFD session goes Down. < 30 seconds
Implementation
BFD is classified into static BFD and dynamic BFD:
● Static BFD
BFD session setup is manually triggered, and BFD session parameters
(including local and remote discriminators) are manually configured using
commands. A device can implement static BFD even if the peer device does
not support BFD.
● Dynamic BFD
BFD session setup is dynamically triggered by routing protocols. The local
discriminator is dynamically allocated and the remote discriminator is
obtained from the BFD packet of the peer device. Therefore, dynamic BFD is
more flexible than static BFD. After establishing a new neighbor relationship,
a routing protocol notifies BFD of the neighbor parameters (including
destination and source addresses), and then BFD sets up a session based on
the received parameters. When a link fault occurs, the routing protocol
quickly detects that the BFD session is Down and switches traffic to the
backup link, minimizing data loss.
Application
After BFD for RIP is enabled, BFD reports link faults to RIP within several
milliseconds. A RIP router then deletes the route of the faulty link from its RIP
routing table and starts the backup link.
Figure 3-10 illustrates the BFD for RIP process.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 82
Figure 3-10 BFD for RIP
RouterA, RouterB, RouterC, and RouterD establish RIP neighbor relationships.
RouterB is the next hop of the route from RouterA to RouterD. A dynamic BFD
session is set up between RouterA and RouterB, and dynamic BFD for RIP is
enabled on RouterA and RouterB.
When the link between RouterA and RouterB becomes faulty, BFD quickly detects
the fault and notifies RouterA of the fault. RouterA deletes the route with RouterB
as the next hop from its RIP routing table, and then recalculates a route. The new
route passes through RouterC and RouterB to reach RouterD.
When the link between RouterA and RouterB recovers, a dynamic BFD session is
set up again between RouterA and RouterB. RouterA receives routing information
from RouterB and selects the optimal route for packet forwarding.
3.2.6 Hot Standby
The RIP hot standby feature is supported by devices with distributed architecture.
During hot standby, a device backs up RIP data from the active main board (AMB)
to the standby main board (SMB). When the AMB becomes faulty, the SMB
becomes active and takes over AMB tasks. This ensures normal data forwarding.
3.3 Summary of RIP Configuration Tasks
Table 3-2 describes RIP configuration tasks.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 83
Table 3-2 RIP configuration tasks
Scenario Description Task
Configuring basic RIP
functions
Basic RIP functions
include enabling RIP,
specifying the network
segment where RIP runs,
and specifying the RIP
version. The basic RIP
functions must be
configured before you
use RIP features.
3.6 Configuring Basic
RIP Functions
Configuring RIP-2
features
RIP-2 is a classless
routing protocol, and
RIP-2 packets carry
subnet masks. Therefore,
deploying a RIP-2
network can save IP
addresses. Only RIP-2
can be deployed on a
network where IP
addresses are
discontinuous, and RIP-1
cannot be used.
RIP-2 supports
authentication for
protocol packets and
provides multiple
authentication modes to
enhance security.
3.7 Configuring RIP-2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 84
Scenario Description Task
Preventing routing loops RIP is a distance-vector
routing protocol. RIP
devices advertise their
local routing tables to
neighbors, so routing
loops may occur.
RIP uses split horizon
and poison reverse to
prevent routing loops:
● Split horizon: A route
learnt by RIP through
an interface is not
sent to neighbors
through the interface.
This saves bandwidth
and prevents routing
loops.
● Poison reverse: RIP
sets the cost of a
route learnt through
an interface to 16
(unreachable), and
sends the route to
neighbors through the
interface. In this way,
RIP deletes useless
routes from the
neighbor's routing
table and prevents
routing loops.
3.8 Preventing Routing
Loops
Controlling RIP routing To use RIP more flexibly
on the existing network
and meet various user
requirements, you can
configure different
parameters to control
RIP routing.
3.9 Controlling RIP
Routing
Controlling the
advertising and receiving
of RIP routes
To meet network
requirements, you can
configure different
parameters to accurately
control the advertising
and receiving of RIP
routes.
3.10 Controlling RIP
Route Advertisement
3.11 Controlling
Receiving of RIP
Routing Information
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 85
Scenario Description Task
Improving RIP network
performance
The following are ways
of improving RIP
network performance:
● Adjust the RIP timer
to change the RIP
network convergence
rate.
● Adjust the number
and interval of
Update packets sent
by an interface to
save device resources
and network
bandwidth.
● Enable the replay-
protect function to
ensure normal
communication
between neighboring
devices after a RIP
process restarts.
● Check packet validity
to ensure high
network security.
3.12 Improving RIP
Network Performance
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 86
Scenario Description Task
Configuring BFD for RIP RIP maintains neighbor
relationships by
periodically sending and
receiving Update
packets. If a device does
not receive any Update
packet from a neighbor
within the aging time, it
considers the neighbor
Down. The default value
of the aging timer is 180
seconds, so RIP can
detect a link fault only
after 180 seconds. If
high-speed data services
are deployed on the
network, a large amount
of data will be lost in
this period.
BFD provides the
millisecond-level fault
detection mechanism. It
can rapidly detect faults
on the protected links or
nodes, and report the
faults to RIP. BFD
improves the RIP
process's response to
network topology
changes, which
implements fast
convergence of RIP
routes.
3.13 Configuring BFD
for RIP
Configuring the network
management function
for RIP
By binding RIP to the
MIB, you can view RIP
information and
configure RIP through
the NMS.
3.14 Configuring the
Network Management
Function for RIP
3.4 Licensing Requirements and Limitations for RIP
Involved Network Elements
Other network elements are required to support RIP.
Licensing Requirements
RIP is a basic feature of a switch and is not under license control.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 87
Feature Support in V200R024C00
All models of S300, S500, S2700, S5700, and S6700 series switches (except the
S5751-L, S5731-L and S5731S-L) support RIP.
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
Feature Limitations
When the maximum number of RIP routes supported by a switch is fixed, the
maximum number of running RIP routes supported on the switch is limited by the
CAR value of RIP protocol packets, interval for sending RIP update packets, and
values of RIP Age and Garbage-collect timers. To increase the maximum number
of running RIP routes on a switch if there are large numbers of RIP routes running
on the network, increase the values of the Age timer, Garbage-collect timer, or
CAR for RIP protocol packets, as well as reducing the interval for sending RIP
update packets.
3.5 Default Settings for RIP
Table 3-3 describes the default settings for RIP.
Table 3-3 Default settings for RIP
Parameter Default Setting
Maximum number of equal-cost
routes
By default, the maximum number of
equal-cost routes on the S5720I-SI,
S5735-S, S5735-S-I, S5735S-H,
S6720S-S, and S5736-S is 8, and the
maximum number of equal-cost
routes on the S5731-H, S5731-S,
S5731S-H, S5731S-S, S5732-H, S6735-
S, S6730-H, S6730S-H, S6730-S, and
S6730S-S is 16.
RIP function Disabled
Split horizon Enabled
3.6 Configuring Basic RIP Functions
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 88
Pre-configuration Tasks
Before configuring basic RIP functions, configure IP addresses for interfaces to
ensure network-layer communication between neighbor nodes.
Configuration Procedure
You must enable RIP before specifying the network segment where RIP runs and
configuring RIP neighbors and RIP version on an NBMA network.
3.6.1 Enabling RIP
Context
You must enable RIP before performing any RIP configurations. RIP command
configurations in the interface view take effect only after RIP is enabled.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run rip [
process-id ] [ vpn-instance
vpn-instance-name ]
RIP is enabled, a RIP process is created, and the RIP view is displayed.
If a VPN instance is specified, the RIP process belongs to this VPN instance. If no
VPN instance is specified, the RIP process belongs to a public network instance.
Step 3 (Optional) Run description
text
A description is configured for the RIP process.
----End
3.6.2 Enabling RIP on the Specified Network Segment
Context
After enabling RIP, specify the network segment where RIP runs. RIP runs only on
the interfaces that reside on the specified network segment. RIP does not receive,
send, or forward routes on the interfaces that do not reside on the specified
network segment.
Procedure
● Enable RIP to send and receive routes on the specified network segment.
a. Run system-view
The system view is displayed.
b. Run rip [
process-id ]
The RIP view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 89
c. (Optional) Run undo verify-source
Source check is disabled for RIP packets.
If IP addresses of devices on both ends of a P2P link belong to different
network segments, the two devices cannot establish a neighbor
relationship unless source check is disabled.
d. Run network
network-address
RIP is enabled on the specified network segment.
NOTE
●
network-address specifies the address of a natural network segment.
● An interface can be associated with only one RIP process.
----End
3.6.3 (Optional) Configuring RIP Neighbors on an NBMA
Network
Context
RIP often uses a broadcast or multicast address to send packets. If the link running
RIP does not support broadcast or multicast packets, specify RIP neighbors on
both ends of the link. This allows packets to be sent between the two ends in
unicast mode.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run rip [
process-id ]
The RIP view is displayed.
Step 3 Run peer
ip-address
A RIP neighbor is configured.
----End
3.6.4 (Optional) Configuring the RIP Version
Context
RIP versions include RIP-1 and RIP-2. The RIP version must be configured on the
device running RIP. Configure the global RIP version unless you need to specify a
different RIP version on an interface.
Procedure
● Configure the global RIP version.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 90
a. Run system-view
The system view is displayed.
b. Run rip [
process-id ]
The RIP view is displayed.
c. Run version { 1 | 2 }
The global RIP version is configured.
NOTE
By default, an interface sends only RIP-1 packets and receives both RIP-1 and
RIP-2 packets.
● Configure the RIP version on an interface.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run rip version { 1 | 2 [ broadcast | multicast ] }
The RIP version is configured on the interface.
NOTE
● By default, an interface sends only RIP-1 packets and receives both RIP-1 and
RIP-2 packets.
● If no RIP version is configured in the interface view, the global RIP version is
used. The RIP version configured on an interface takes precedence over the
global RIP version.
----End
3.6.5 Verifying the Basic RIP Function Configuration
Procedure
● Run the display rip [
process-id | vpn-instance
vpn-instance-name ]
command to view the RIP running status and configuration.
● Run the display rip
process-id route command to view all the RIP routes
learned from other devices.
● Run the display default-parameter rip command to view default RIP
configuration.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 91
● Run the display rip
process-id statistics interface { all |
interface-type
interface-number [ verbose | neighbor
neighbor-ip-address ] } command to
view statistics on RIP interfaces.
----End
3.7 Configuring RIP-2
Pre-configuration Tasks
Before configuring RIP-2, configure basic RIP functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the RIP-2 Configuration) in any sequence.
3.7.1 Configuring RIP-2 Route Summarization
Context
A large RIP network requires significant device memory to maintain large RIP
routing tables. Transmitting and processing routing information requires large
amounts of network resources. Route summarization can reduce the routing table
size and minimize impact of route flapping on a network.
RIP-2 supports automatic summarization and manual summarization. Manual
summarization takes precedence over automatic summarization. To advertise all
subnet routes, disable automatic route summarization.
NOTE
By default, if split horizon or poison reverse has been configured, classful route
summarization becomes invalid. When summarized routes are sent to the natural network
segment border, split horizon or poison reverse must be disabled.
Procedure
● Configure RIP-2 automatic route summarization.
a. Run the system-view command to enter the system view.
b. Run the rip [
process-id ] command to enter the RIP view.
c. Run the version 2 command to set the RIP version to RIP-2.
d. Run the summary command to enable RIP-2 automatic route
summarization.
e. (Optional) Run the summary always command to enable RIP-2
automatic route summarization regardless of whether split horizon and
poison reverse are enabled.
NOTE
The summary command is used in the RIP view to enable RIP-2 classful network-
based route summarization.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 92
● Configure RIP-2 manual route summarization.
a. Run the system-view command to enter the system view.
b. Run the interface
interface-type interface-number command to enter the
interface view.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run the rip summary-address
ip-address mask [ avoid-feedback ]
command to configure RIP-2 to advertise the summarized local IP
address.
NOTE
The rip summary-address
ip-address mask [ avoid-feedback ] command is used
in the interface view to enable RIP-2 classless network-based route
summarization.
----End
3.7.2 Configuring RIP-2 Packet Authentication
Context
Configure RIP-2 packet authentication on a RIP network requiring high security.
RIP-2 supports simple authentication, MD5 authentication, and HMAC-SHA256
ciphertext authentication for protocol packets to enhance security. In simple
authentication, a plaintext authentication key is used. Therefore, simple
authentication has low security.
NOTICE
If plain is selected during the configuration of RIP-2 packet authentication, the
password is saved in the configuration file in plain text. This brings security risks. It
is recommended that you select cipher to save the password in cipher text.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 93
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Configure RIP-2 packet authentication.
● Run the rip authentication-mode simple { plain
plain-text | [ cipher ]
password-key } command to set RIP-2 packet authentication to simple
authentication.
● Run one of the following commands to set RIP-2 packet authentication to
MD5 authentication.
– rip authentication-mode md5 usual { plain
plain-text | [ cipher ]
password-key }
– rip authentication-mode md5 nonstandard { keychain
keychain-name |
{ plain
plain-text | [ cipher ]
password-key }
key-id }
NOTICE
Simple authentication and MD5 authentication have potential security risks.
HMAC-SHA256 ciphertext authentication is recommended.
If MD5 authentication is used, you must set the packet format for MD5
authentication. If the usual keyword is specified, MD5 ciphertext
authentication packets use the universal format (private standard). If the
nonstandard keyword is specified, MD5 ciphertext authentication packets use
the non-standard format (IETF standard).
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support the keychain
keychain-name
parameter.
● Run the rip authentication-mode hmac-sha256 { plain
plain-text |
[ cipher ]
password-key }
key-id command to set RIP-2 packet authentication
to HMAC-SHA256 authentication.
----End
3.7.3 Verifying the RIP-2 Configuration
Procedure
● Run the display rip [
process-id | vpn-instance
vpn-instance-name ]
command to view the RIP running status and configuration.
● Run the display rip
process-id database [ verbose ] command to view all the
active routes in the RIP database.
● Run the display rip
process-id route command to view all RIP routes learned
from other devices.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 94
● Run the display rip
process-id interface [
interface-type interface-number ]
[ verbose ] command to view information about the RIP interface.
----End
3.8 Preventing Routing Loops
Pre-configuration Tasks
Before configuring split horizon and poison reverse, configure basic RIP
functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the RIP Routing Loop Prevention Configuration) in any sequence.
3.8.1 Configuring Split Horizon
Context
Split horizon can prevent routing loops.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run rip split-horizon
Split horizon is configured.
NOTE
● By default, split horizon is disabled on an NBMA network.
● If both split horizon and poison reverse are configured, only poison reverse takes effect.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 95
3.8.2 Configuring Poison Reverse
Context
Poison reverse can prevent routing loops.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run rip poison-reverse
Poison reverse is enabled.
NOTE
If both split horizon and poison reverse are configured, only poison reverse takes effect.
----End
3.8.3 Verifying the RIP Routing Loop Prevention Configuration
Procedure
● Run the display rip
process-id interface [
interface-type interface-number ]
[ verbose ] command to view information about the specified RIP interface.
----End
3.9 Controlling RIP Routing
Pre-configuration Tasks
Before configuring RIP route attributes, configure basic RIP functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the RIP Routing Control Configuration) in any sequence.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 96
3.9.1 Configuring RIP Preference
Context
When different routing protocols discover routes to the same destination, set the
RIP preference to select the required route.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run rip [
process-id ]
The RIP view is displayed.
Step 3 Run preference {
preference | route-policy
route-policy-name } *
The RIP preference is set.
By default, the RIP preference is 100.
----End
3.9.2 Configuring Additional Metrics of an Interface
Context
Configuring additional metrics on a RIP interface can change the route selection
sequence.
The additional metric is the metric (hop count) to be added to the original metric
of a RIP route. You can use commands to set additional metrics for incoming and
outgoing RIP routes.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 97
Step 4 Run the following commands as required:
● Run the rip metricin {
value | {
acl-number | acl-name
acl-name | ip-prefix
ip-prefix-name }
value1 } command to set the additional metric for receiving
routes.
● Run the rip metricout {
value | {
acl-number | acl-name
acl-name | ip-prefix
ip-prefix-name }
value1 } command to set the additional metric for
advertising routes.
NOTE
● The rip metricin command is used to add an additional metric to an incoming route.
After this route is added to the routing table, its metric in the routing table changes.
Running this command affects route selection on the local device and other devices on
the network.
● The rip metricout command is used to add an additional metric to an outgoing route.
When this route is advertised, an additional metric is added to this route, but the metric
of the route in the routing table does not change. Running this command does not
affect route selection on the local device but affects route selection on other devices in
the network.
----End
3.9.3 Setting the Maximum Number of Equal-Cost Routes
Context
By setting the maximum number of equal-cost RIP routes, you can change the
number of routes for load balancing.
NOTE
Only the S5720I-SI, S5735-S, S500, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S,
S5731S-H, S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and
S6730S-S support this function.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run rip [
process-id ]
The RIP view is displayed.
Step 3 Run maximum load-balancing
number
The maximum number of equal-cost routes is set.
By default, the maximum number of equal-cost routes on the S5720I-SI, S5735-S,
S500, S5735-S-I, S5735S-H, or S5736-S is 8, and the maximum number of equal-
cost routes on the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S,
S6730-H, S6730S-H, S6730-S, or S6730S-S is 16.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 98
3.9.4 Verifying the RIP Routing Control Configuration
Procedure
● Run the display rip [
process-id | vpn-instance
vpn-instance-name ]
command to view the RIP running status and configuration.
● Run the display rip
process-id database [ verbose ] command to view all the
active routes in the RIP database.
● Run the display rip
process-id route command to view all RIP routes learned
from other devices.
----End
3.10 Controlling RIP Route Advertisement
Pre-configuration Tasks
Before controlling RIP route advertisement, configure basic RIP functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the Route Advertisement Control Configuration) in any sequence.
3.10.1 Configuring RIP to Advertise Default Routes
Context
In a routing table, a default route is the route to the network segment 0.0.0.0
(with the mask being 0.0.0.0). If the destination address of a packet does not
match any entry in the routing table, the packet is sent along the default route.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run rip [
process-id ]
The RIP view is displayed.
Step 3 Run default-route originate [ cost
cost | { { match default | route-policy
route-
policy-name } [ avoid-learning ] } ]*
The device is configured to originate a default route or advertise the default route
in the routing table to neighbors.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 99
3.10.2 Disabling an Interface from Sending Update Packets
Context
Routing loops can be avoided by disabling interfaces from sending Update
packets.
There are two ways to prevent interfaces from sending Update packets:
● Suppress an interface in the RIP process view.
● Disable an interface from sending RIP packets in the interface view.
The configuration in the RIP process view has a higher priority than the
configuration in the interface view.
Procedure
● Configuration in a RIP process view
a. Run system-view
The system view is displayed.
b. Run rip [
process-id ]
The RIP view is displayed.
c. Run one of the following commands depending on the site requirements:
Run silent-interface all
All interfaces are disabled from sending Update packets.
Run silent-interface
interface-type interface-number
An interface is disabled from sending Update packets,
You can set an interface to silent so that it only receives Update packets
to update its routing table. The silent-interface command takes
precedence over the undo rip output command in the interface view.
By default, an interface can receive and send Update packets.
● Configuration in the interface view
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 100
d. Run undo rip output
The interface is disabled from sending RIP Update packets.
By running this command, you can determine whether to send RIP
Update packets on an interface. The silent-interface command takes
precedence over the undo rip output command. By default, an interface
is allowed to send RIP Update packets.
----End
3.10.3 Configuring RIP to Import Routes
Context
A RIP process can import the routes learned by other RIP processes or routing
protocols.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run rip [
process-id ]
The RIP view is displayed.
Step 3 (Optional) Run default-cost
cost
The default metric for imported routes is set.
If the metric of imported routes is not specified in step 4, the default metric is
used.
Step 4 Run import-route bgp [ permit-ibgp ] [ cost {
cost | transparent } | route-policy
route-policy-name ] * or import-route { { static | direct | unr } | { { rip | ospf |
isis } [
process-id ] } } [ cost
cost | route-policy
route-policy-name ] *
External routes are imported to RIP.
NOTE
When RIP imports IBGP routes, routing loops may occur. Configure this function with
caution.
Step 5 (Optional) Run filter-policy {
acl-number | acl-name
acl-name | ip-prefix
ip-
prefix-name } export [
protocol [
process-id ] |
interface-type interface-number ]
The imported routes are filtered before being advertised.
The routing information advertised by RIP may contain the routing information
imported from other protocols. You can use the
protocol parameter to filter the
routing information imported from a specified routing protocol. If the
protocol
parameter is not used, all the routes advertised by RIP are filtered, including the
imported routes and the local routes (direct routes).
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 101
NOTE
RIP-2 defines a 16-bit tag, while other routing protocols define 32-bit tags. If the routes of
other protocols are imported to RIP and the tag is used in the routing policy, the tag value
cannot exceed 65535. If the tag value exceeds 65535, the routing policy becomes invalid or
the matching result is incorrect.
----End
3.10.4 Verifying the RIP Route Advertisement Control
Configuration
Procedure
● Run the display rip [
process-id | vpn-instance
vpn-instance-name ]
command to view the RIP running status and configuration.
● Run the display rip
process-id database [ verbose ] command to view all the
active routes in the RIP database.
● Run the display rip
process-id route command to view all RIP routes learned
from other devices.
----End
3.11 Controlling Receiving of RIP Routing Information
Pre-configuration Tasks
Before controlling receiving of RIP routing information, configure basic RIP
functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the RIP Route Receiving Control Configuration) in any sequence.
3.11.1 Disabling an Interface from Receiving RIP Update
Packets
Context
Routing loops can be avoided by disabling interfaces from receiving Update
packets.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 102
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run undo rip input
The interface is disabled from receiving RIP Update packets.
By default, an interface is allowed to receive RIP update packets.
----End
3.11.2 Configuring RIP to Deny Host Routes
Context
In certain cases, the switch receives a large number of host routes with 32 bits
from the same network segment. These host routes are unnecessary for routing,
and they waste network resources. You can configure the switch to reject all the
host routes it receives.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run rip [
process-id ]
The RIP view is displayed.
Step 3 Run undo host-route
Host routes are not added to the RIP routing table.
By default, host routes can be added to the routing table on the switch.
NOTE
The undo host-route command is invalid for RIP-2.
----End
3.11.3 Configuring RIP to Filter Received Routes
Context
The filtering policy can be configured on the inbound interface by configuring the
ACL and IP prefix list to filter received routes. Only the routes not filtered out by
the filtering policy are added to the local routing table.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 103
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run rip [
process-id ]
The RIP view is displayed.
Step 3 Depending on type of desired filtering, run one of following commands to
configure RIP to filter the received routes:
● Run filter-policy {
acl-number | acl-name
acl-name } import [
interface-type
interface-number ]
The learned routing information is filtered based on an ACL.
● Run filter-policy gateway
ip-prefix-name import
The routing information advertised by neighbors is filtered based on the IP
prefix list.
● Run filter-policy ip-prefix
ip-prefix-name [ gateway
ip-prefix-name ] import
[
interface-type interface-number ]
The routes learned by the specified interface are filtered based on the IP
prefix list and neighbors.
----End
3.11.4 Verifying the RIP Route Receiving Control
Configuration
Procedure
● Run the display rip [
process-id | vpn-instance
vpn-instance-name ]
command to check the RIP running status and configuration.
● Run the display rip
process-id database [ verbose ] command to check all
activated RIP routes in the database.
● Run the display rip
process-id interface [
interface-type interface-number ]
[ verbose ] command to check information about the RIP interface.
● Run the display rip
process-id neighbor [ verbose ] command to check
information about RIP neighbors.
● Run the display rip
process-id route command to check all the RIP routes
that are learned from other switches.
----End
3.12 Improving RIP Network Performance
Pre-configuration Tasks
Before improving the network performance of RIP, configure basic RIP functions.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 104
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the RIP Network Performance Optimization Configuration) in any sequence.
3.12.1 Configuring RIP Timers
Context
RIP uses three timers: Update, Age, and Garbage-collect. Changing the timer
values affects the convergence speed of RIP routes.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run rip [
process-id ]
The RIP view is displayed.
Step 3 Run timers rip
update age garbage-collect
RIP timers are configured.
NOTE
● RIP timers take effect immediately after being changed.
● Route flapping occurs if the values of the three timers are set improperly. The
relationship between the values is:
update must be smaller than both
age and
garbage-
collect. If the update time is longer than the aging time and, for example, a RIP route
changes within the update time, the switch cannot inform its neighbors of the change
on time.
● Configure RIP timers based on the network performance and ensure that these timers
are consistent on all RIP devices. This avoids unnecessary network traffic or route
flapping.
By default, the Update timer is 30s, the Age timer is 180s, and the Garbage-collect
timer is 120s (four times the Update timer).
In practice, the Garbage-collect timer is not fixed. If the Update timer is set to 30s,
the Garbage-collect timer may range from 90s to 120s.
Before permanently deleting an unreachable route from its RIP routing table, a RIP
device advertises this route (with the metric set to 16) four times by periodically
sending Update packets. Subsequently, all the neighbors learn that this route is
unreachable. Because a route may not always become unreachable at the
beginning of an Update period, the Garbage-collect timer ranges from three to
four times the Update timer.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 105
3.12.2 Setting the Interval for Sending Update Packets and
Maximum Number of Sent Packets
Context
To limit memory resources used to process RIP Update packets, set the interval for
sending RIP Update packets and the maximum number of Update packets to be
sent at a time.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run rip pkt-transmit { interval
interval | number
pkt-count } *
The interval for sending RIP Update packets and the maximum number of Update
packets to be sent at a time are set.
----End
3.12.3 Enabling the Replay Protection Function
Context
If an interface goes Down and then goes Up, RIP routing information on both ends
of a link may be desynchronized or lost. Specifically, if the Identification field in
the last RIP packet sent before a RIP interface goes Down is X, after the interface
goes Up, the Identification field in the subsequent RIP packet sent by this interface
becomes 0. If the peer end does not receive the RIP packet with the Identification
field being 0, the peer end discards subsequent RIP packets until it receives the RIP
packet with the Identification field being X+1. This leads to RIP routing
information on both ends of the link being desynchronized or lost.
To solve this problem, enable the replay protection function so that RIP can obtain
the Identification field in the last RIP packet sent before the RIP interface goes
Down and increase the Identification field in the subsequent RIP packet by 1.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 106
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run rip authentication-mode md5 nonstandard
password-key key-id
RIP-2 is configured to use MD5 authentication, and authentication packets use the
nonstandard packet format.
Step 5 Run rip replay-protect
The replay protection function is enabled.
NOTE
If you run the rip replay-protect command in the same view multiple times, only the latest
configuration takes effect.
----End
3.12.4 Configuring RIP to Check the Validity of Update
Packets
Context
Checking the validity of RIP Update packets improves network security. Validity
check includes zero field check for RIP-1 packets and source address check for RIP
Update packets.
● Zero field check
In RIP-1 packets, the values of some fields must be zero. These fields are zero
fields. After zero field check is enabled, a switch checks the zero fields in RIP-1
packets and discards the packets in which the zero field values are not 0.
● Source address check
Source address check for RIP Update packets verifies the source IP address of
received RIP Update packets. Specifically, a switch checks whether the IP
address of the interface that sends the packet is in the same network
segment as that of the interface that receives the packet. If the IP addresses
are not in the same network segment, the switch will not process the RIP
packet.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 107
Procedure
● Configure zero field check for RIP-1 packets.
a. Run system-view
The system view is displayed.
b. Run rip [
process-id ]
The RIP view is displayed.
c. Run checkzero
Zero field check is configured for RIP-1 packets.
Zero field check configuration is invalid in RIP-2.
● Configure source address check for RIP Update packets.
a. Run system-view
The system view is displayed.
b. Run rip [
process-id ]
The RIP view is displayed.
c. Run verify-source
Source IP address check is configured for RIP Update packets.
----End
3.12.5 Verifying the RIP Network Performance Optimization
Configuration
Procedure
● Run the display rip [
process-id | vpn-instance
vpn-instance-name ]
command to view the RIP running status and configuration.
● Run the display rip
process-id database [ verbose ] command to view all the
active routes in the RIP database.
● Run the display rip
process-id interface [
interface-type interface-number ]
[ verbose ] command to view information about the specified RIP interface.
● Run the display rip
process-id neighbor [ verbose ] command to view RIP
neighbor configuration.
● Run the display rip
process-id route command to view all RIP routes learned
from other devices.
----End
3.13 Configuring BFD for RIP
NOTE
Only the S5720I-SI, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S, S5731S-H,
S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and S6730S-S
support BFD for RIP.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 108
Pre-configuration Tasks
Before configuring BFD for RIP, configure basic RIP functions.
Configuration Procedure
You can perform the following configuration tasks in any sequence.
3.13.1 Configuring Dynamic BFD for RIP
Applicable Environment
RIP often uses timers to receive and send Update messages to maintain neighbor
relationships. If a RIP device does not receive an Update message from a neighbor
after the Age timer expires, the RIP device will announce that this neighbor goes
Down. The default value of the Age timer is 180s, therefore, if a link fault occurs,
RIP may detect this fault after 180s. If high-rate data services are deployed on a
network, a large amount of data will be lost during the aging time.
BFD provides millisecond-level fault detection. It can rapidly detect faults in
protected links or nodes and report them to RIP. This speeds up RIP processes'
responses to network topology changes and achieves rapid RIP route convergence.
Either of the following methods can be used to configure BFD for RIP:
● Enable BFD in a RIP process.
This method is recommended when BFD for RIP needs to be enabled on most
RIP interfaces.
● Enable BFD on RIP interfaces.
This method is recommended when BFD for RIP needs to be enabled on a
small number of RIP interfaces.
Procedure
● Enable BFD in a RIP process.
a. Run system-view
The system view is displayed.
b. Run bfd
BFD is enabled globally.
c. Run quit
Return to the system view.
d. Run rip [
process-id ]
The RIP view is displayed.
e. Run bfd all-interfaces enable
BFD is enabled in the RIP process to establish a BFD session.
If BFD is enabled globally, RIP will use default BFD parameters to
establish BFD sessions on all the interfaces where RIP neighbor
relationships are in Up state.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 109
f. (Optional) Run bfd all-interfaces { min-rx-interval
min-receive-value |
min-tx-interval
min-transmit-value | detect-multiplier
detect-multiplier-
value } *
The values of BFD parameters used to establish the BFD session are set.
BFD parameter values are determined by the actual network situation
and network reliability requirement.
▪ If links have a high reliability requirement, reduce the interval at
which BFD packets are sent.
▪ If links have a low reliability requirement, increase the interval at
which BFD packets are sent.
Running the bfd all-interfaces command changes BFD session
parameters on all RIP interfaces.
g. (Optional) Perform the following operations to prevent an interface in
the RIP process from establishing a BFD session:
▪ Run the quit command to return to the system view.
▪ Run the interface
interface-type interface-number command to
enter the view of a specified interface.
▪ Run the rip bfd block command to prevent the interface from
establishing a BFD session.
● Enable BFD on RIP interfaces.
a. Run system-view
The system view is displayed.
b. Run bfd
BFD is enabled globally.
c. Run quit
Return to the system view.
d. Run interface
interface-type interface-number
The view of the specified interface is displayed.
e. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
f. Run rip bfd enable
BFD is enabled on the interface to establish a BFD session.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 110
g. (Optional) Run rip bfd { min-rx-interval
min-receive-value | min-tx-
interval
min-transmit-value | detect-multiplier
detect-multiplier-value }
*
The values of BFD parameters used to establish the BFD session are set.
----End
Verifying the Configuration
After enabling BFD for RIP at both ends of a link:
● Run the display rip
process-id bfd session { interface
interface-type
interface-number |
neighbor-id | all } command. The command output shows
that the BFDState field on the local switch displays Up.
3.13.2 Configuring Static BFD for RIP
Context
BFD provides link failure detection featuring light load and high speed. Static BFD
for RIP is a method to implement the BFD function.
Establishing BFD sessions between RIP neighbors can rapidly detect faults on links
and speed up response of RIP to network topology changes. Static BFD
implements the following functions:
● One-arm BFD
If not all devices on a network support BFD, configure one-arm BFD to
implement fault detection.
● Two-arm BFD
If all the devices on a network support BFD, configure two-arm BFD to
implement fault detection.
To configure a static BFD session, you need to set parameters for the BFD session.
Procedure
Step 1 Enable BFD globally.
1. Run system-view
The system view is displayed.
2. Run bfd
BFD is enabled globally.
3. Run quit
Return to the system view.
NOTE
To configure one-arm BFD, go to Step 2. To configure two-arm BFD, go to Step 3.
Step 2 Configure one-arm BFD.
1. Run bfd
session-name bind peer-ip
peer-ip interface
interface-type interface-
number [ source-ip
source-ip ] one-arm-echo
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 111
BFD is enabled between the specified interface and peer device.
If a peer IP address and a local interface are specified, BFD detects only a
single-hop link, that is, a route with the interface specified in the bfd
command as the outbound interface and with the peer IP address specified in
the peer-ip command as the next-hop address.
NOTE
When configuring the one-arm Echo function on the device, set the source-ip
source-
ip to the IP address of an interface on the device. Ensure that the peer device can ping
this IP address.
2. Run discriminator local
discr-value
The local discriminator is set.
3. (Optional) Run min-echo-rx-interval
interval
The minimum interval at which BFD packets are received is configured.
4. Run commit
The configuration is committed.
5. Run quit
Return to the system view.
Step 3 Configure two-arm BFD.
1. Run bfd
session-name bind peer-ip
ip-address [ interface
interface-type
interface-number ] [ source-ip
ip-address ]
BFD binding is created.
If a peer IP address and a local interface are specified, BFD detects only a
single-hop link, that is, a route with the interface specified in the bfd
command as the outbound interface and with the peer IP address specified in
the peer-ip command as the next-hop address.
2. Set discriminators.
– Run discriminator local
discr-value
The local discriminator is set.
– Run discriminator remote
discr-value
The remote discriminator is set.
The local discriminator must be the remote discriminator of the device on the
other end; otherwise, a BFD session cannot be established. The local and
remote discriminators cannot be modified after being configured.
NOTE
local
discr-value set on the local device is the same as that of remote
discr-value set
on the remote device.remote
discr-value set on the local device is the same as that of
local
discr-value set on the remote device.
3. Run commit
The configuration is committed.
4. Run quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 112
Return to the system view.
Step 4 Enable static BFD on an interface.
1. Run interface
interface-type interface-number
The view of the specified interface is displayed.
2. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
3. Run rip bfd static
Static BFD is enabled on the interface.
4. Run quit
Return to the system view.
----End
Verifying the Configuration
After configuring static BFD for RIP:
● Run the display rip
process-id interface [
interface-type interface-number ]
verbose command to check BFD for RIP configurations on the specified
interface.
3.14 Configuring the Network Management Function
for RIP
Pre-configuration Tasks
Before configuring the network management function for RIP, configure basic RIP
functions.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run rip mib-binding
process-id
RIP is bound to the MIB.
This command is used to bind a RIP process ID to MIBs and specify the ID of the
RIP process that accepts Simple Network Management Protocol (SNMP) requests.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 113
Verifying the Configuration
● Run the display current-configuration command to view the binding
relationships of RIP.
3.15 Maintaining RIP
3.15.1 Resetting RIP
Context
To reset RIP connections, run the following reset commands in the user view.
NOTICE
The RIP neighbor relationship is deleted after you reset RIP connections with the
reset rip command. Exercise caution when running this command.
Procedure
● Run the reset rip
process-id configuration command in the user view to reset
the system parameters of a RIP process. When a RIP process restarts, all the
parameters of the process retain the default values.
----End
3.15.2 Clearing RIP Statistics
Context
To clear RIP statistics, run the following reset commands in the user view.
NOTICE
RIP information cannot be restored after it is cleared. Exercise caution when
running the commands.
Procedure
● Run the reset rip
process-id statistics [ interface { all |
interface-type
interface-number [ neighbor
neighbor-ip-address ] } ] command in the user
view to clear the counters of a RIP process.
----End
3.16 Configuration Examples for RIP
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 114
3.16.1 Example for Configuring Basic RIP Functions
Networking Requirements
In Figure 3-11, SwitchA, SwitchB, SwitchC, and SwitchD are located on a small-
sized network and need to communicate with each other.
Figure 3-11 Configuring basic RIP functions
Configuration Roadmap
RIP-2 is recommended if the network size is small. The configuration roadmap is
as follows:
1. Configure VLAN and IP address for each interface to ensure network
reachability.
2. Enable RIP on each switch to implement network connections between
processes.
3. Configure RIP-2 on each switch to improve RIP performance.
Procedure
Step 1 Configure VLANs and add interfaces to the VLANs. The configurations of SwitchB,
SwitchC, and SwitchD are similar to the configuration of SwitchA, and are not
mentioned here.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan 10
[SwitchA-vlan10] quit
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 115
Step 2 Configure an IP address to each VLANIF interface. The configurations of SwitchB,
SwitchC, and SwitchD are similar to the configuration of SwitchA, and are not
mentioned here.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.1 24
[SwitchA-Vlanif10] quit
Step 3 Configure basic RIP functions.
# Configure SwitchA.
[SwitchA] rip
[SwitchA-rip-1] network 192.168.1.0
[SwitchA-rip-1] quit
# Configure SwitchB.
[SwitchB] rip
[SwitchB-rip-1] network 192.168.1.0
[SwitchB-rip-1] network 172.16.0.0
[SwitchB-rip-1] network 10.0.0.0
[SwitchB-rip-1] quit
# Configure SwitchC.
[SwitchC] rip
[SwitchC-rip-1] network 172.16.0.0
[SwitchC-rip-1] quit
# Configure SwitchD.
[SwitchD] rip
[SwitchD-rip-1] network 10.0.0.0
[SwitchD-rip-1] quit
# Check the RIP routing table of SwitchA.
[SwitchA] display rip 1 route
Route Flags : R - RIP
A - Aging, G - Garbage-collect
----------------------------------------------------------------------------
Peer 192.168.1.2 on Vlanif10
Destination/Mask Nexthop Cost Tag Flags Sec
172.16.0.0/16 192.168.1.2 1 0 RA 14
10.0.0.0/8 192.168.1.2 1 0 RA 14
The command output shows that the routes advertised by RIP-1 use natural
masks.
Step 4 Configure the RIP version.
# Configure RIP-2 on SwitchA.
[SwitchA] rip
[SwitchA-rip-1] version 2
[SwitchA-rip-1] quit
# Configure RIP-2 on SwitchB.
[SwitchB] rip
[SwitchB-rip-1] version 2
[SwitchB-rip-1] quit
# Configure RIP-2 on SwitchC.
[SwitchC] rip
[SwitchC-rip-1] version 2
[SwitchC-rip-1] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 116
# Configure RIP-2 on SwitchD.
[SwitchD] rip
[SwitchD-rip-1] version 2
[SwitchD-rip-1] quit
Step 5 Verify the configuration.
# Check the RIP routing table of SwitchA.
[SwitchA] display rip 1 route
Route Flags : R - RIP
A - Aging, G - Garbage-collect
----------------------------------------------------------------------------
Peer 192.168.1.2 on Vlanif10
Destination/Mask Nexthop Cost Tag Flags Sec
172.16.1.0/24 192.168.1.2 1 0 RA 32
10.1.1.0/24 192.168.1.2 1 0 RA 32
From the routing table, you can find that the routes advertised by RIP-2 contain
more accurate subnet masks.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
rip 1
version 2
network 192.168.1.0
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20 30
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif20
ip address 172.16.1.1 255.255.255.0
#
interface Vlanif30
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 117
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
rip 1
version 2
network 192.168.1.0
network 172.16.0.0
network 10.0.0.0
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20
#
interface Vlanif20
ip address 172.16.1.2 255.255.255.0
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
rip 1
version 2
network 172.16.0.0
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30
#
interface Vlanif30
ip address 10.1.1.2 255.255.255.0
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
rip 1
version 2
network 10.0.0.0
#
return
3.16.2 Example for Configuring RIP to Import Routes
Networking Requirements
In Figure 3-12, two RIP processes, RIP 100 and RIP 200, run on SwitchB. SwitchA
needs to communicate with network segment 192.168.3.0/24.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 118
Figure 3-12 Configuring RIP to import external routes
Configuration Roadmap
The configuration roadmap is as follows:
1. Enable RIP on each switch to implement network connections between
processes.
2. Import routes between RIP 100 and RIP 200 on SwitchB and set the default
metric of routes imported from RIP 200 to 3.
3. Configure an ACL on SwitchB to filter route 192.168.4.0/24 imported from RIP
200 so that SwitchA can only communicate with network segment
192.168.3.0/24.
Procedure
Step 1 Configure VLANs and add interfaces to the VLANs. The configurations of Switch B,
and Switch C are similar to the configuration of Switch A, and are not mentioned
here.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 50
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 50
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure an IP address to each VLANIF interface. The configurations of Switch B,
and Switch C are similar to the configuration of Switch A, and are not mentioned
here.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 50
[SwitchA-Vlanif50] ip address 192.168.0.1 24
[SwitchA-Vlanif50] quit
Step 3 Configure basic RIP functions.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 119
# Enable RIP 100 on SwitchA.
[SwitchA] rip 100
[SwitchA-rip-100] network 192.168.0.0
[SwitchA-rip-100] network 192.168.1.0
[SwitchA-rip-100] quit
# Enable RIP 100 and RIP 200 on SwitchB.
[SwitchB] rip 100
[SwitchB-rip-100] network 192.168.1.0
[SwitchB-rip-100] quit
[SwitchB] rip 200
[SwitchB-rip-200] network 192.168.2.0
[SwitchB-rip-200] quit
# Enable RIP 200 on SwitchC.
[SwitchC] rip 200
[SwitchC-rip-200] network 192.168.2.0
[SwitchC-rip-200] network 192.168.3.0
[SwitchC-rip-200] network 192.168.4.0
[SwitchC-rip-200] quit
# View the routing table on SwitchA.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 6 Routes : 6
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.0.0/24 Direct 0 0 D 192.168.0.1 Vlanif50
192.168.0.1/32 Direct 0 0 D 127.0.0.1 Vlanif50
192.168.1.0/24 Direct 0 0 D 192.168.1.1 Vlanif10
192.168.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
The routing table of SwitchA does not contain the routes imported from other
processes.
Step 4 Configure RIP to import external routes.
# On SwitchB, set the default metric of imported routes to 3 in RIP 100 and
configure the two RIP processes to import routes into each other's routing table.
[SwitchB] rip 100
[SwitchB-rip-100] default-cost 3
[SwitchB-rip-100] import-route rip 200
[SwitchB-rip-100] quit
[SwitchB] rip 200
[SwitchB-rip-200] import-route rip 100
[SwitchB-rip-200] quit
# View the routing table of SwitchA after the routes are imported.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 9 Routes : 9
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 120
192.168.0.0/24 Direct 0 0 D 192.168.0.1 Vlanif50
192.168.0.1/32 Direct 0 0 D 127.0.0.1 Vlanif50
192.168.1.0/24 Direct 0 0 D 192.168.1.1 Vlanif10
192.168.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
192.168.2.0/24 RIP 100 4 D 192.168.1.2 Vlanif10
192.168.3.0/24 RIP 100 4 D 192.168.1.2 Vlanif10
192.168.4.0/24 RIP 100 4 D 192.168.1.2 Vlanif10
The routing table of SwitchA contains routes 192.168.2.0/24, 192.168.3.0/24, and
192.168.4.0/24, which are learned by RIP 200 on SwitchB.
Step 5 Configure RIP to filter imported routes.
# Configure an ACL on SwitchB and add a rule to the ACL. The rule denies the
packets sent from 192.168.4.0/24.
[SwitchB] acl 2000
[SwitchB-acl-basic-2000] rule deny source 192.168.4.0 0.0.0.255
[SwitchB-acl-basic-2000] rule permit
[SwitchB-acl-basic-2000] quit
# Configure SwitchB to filter route 192.168.4.0/24 imported from RIP 200 based
on the preceding ACL.
[SwitchB] rip 100
[SwitchB-rip-100] filter-policy 2000 export
[SwitchB-rip-100] quit
Step 6 Verify the configuration.
# Display the RIP routing table of SwitchA after the routes are filtered.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 8 Routes : 8
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.0.0/24 Direct 0 0 D 192.168.0.1 Vlanif50
192.168.0.1/32 Direct 0 0 D 127.0.0.1 Vlanif50
192.168.1.0/24 Direct 0 0 D 192.168.1.1 Vlanif10
192.168.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
192.168.2.0/24 RIP 100 4 D 192.168.1.2 Vlanif10
192.168.3.0/24 RIP 100 4 D 192.168.1.2 Vlanif10
The routing table of SwitchA does not contain the route originating from
192.168.4.0/24.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 50
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface Vlanif50
ip address 192.168.0.1 255.255.255.0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 121
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 50
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 10
#
rip 100
network 192.168.0.0
network 192.168.1.0
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20
#
acl number 2000
rule 5 deny source 192.168.4.0 0.0.0.255
rule 10 permit
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 10
#
rip 100
default-cost 3
network 192.168.1.0
filter-policy 2000 export
import-route rip 200
#
rip 200
network 192.168.2.0
import-route rip 100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 30 40
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.3.1 255.255.255.0
#
interface Vlanif40
ip address 192.168.4.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 122
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 40
#
rip 200
network 192.168.2.0
network 192.168.3.0
network 192.168.4.0
#
return
3.16.3 Example for Configuring One-Arm Static BFD for RIP
Networking Requirements
In Figure 3-13, four switches communicate using RIP on a small-sized network.
Services are transmitted through the primary link SwitchA→SwitchB→SwitchD.
Reliability must be improved for data transmitted from SwitchA to SwitchB so that
services can be rapidly switched to another path when the primary link fails.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 3-13 One-arm static BFD for RIP
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IP address for each interface to ensure network reachability.
2. Enable RIP on each switch to implement network connections between
processes.
3. Configure one-arm static BFD on SwitchA. BFD can rapidly detect the link
status and help RIP speed up route convergence to implement fast link
switching.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 123
Procedure
Step 1 Configure VLANs and add interfaces to the VLANs. The configurations of SwitchB,
SwitchC, and SwitchD are similar to the configuration of SwitchA, and are not
mentioned here.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure an IP address to each VLANIF interface. The configurations of SwitchB,
SwitchC, and SwitchD are similar to the configuration of SwitchA, and are not
mentioned here.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.2.2.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 10.3.3.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure basic RIP functions.
# Configure SwitchA.
[SwitchA] rip 1
[SwitchA-rip-1] version 2
[SwitchA-rip-1] network 10.0.0.0
[SwitchA-rip-1] quit
# Configure SwitchB.
[SwitchB] rip 1
[SwitchB-rip-1] version 2
[SwitchB-rip-1] network 10.0.0.0
[SwitchB-rip-1] network 172.16.0.0
[SwitchB-rip-1] quit
# Configure SwitchC.
[SwitchC] rip 1
[SwitchC-rip-1] version 2
[SwitchC-rip-1] network 10.0.0.0
[SwitchC-rip-1] quit
# Configure SwitchD.
[SwitchD] rip 1
[SwitchD-rip-1] version 2
[SwitchD-rip-1] network 172.16.0.0
[SwitchD-rip-1] quit
# After completing the preceding operations, run the display rip neighbor
command. The command output shows that SwitchA, SwitchB, and SwitchC have
established neighbor relationships with each other. In the following example, the
display on SwitchA is used.
[SwitchA] display rip 1 neighbor
---------------------------------------------------------------------
IP Address Interface Type Last-Heard-Time
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 124
---------------------------------------------------------------------
10.2.2.2 Vlanif10 RIP 0:0:10
Number of RIP routes : 2
10.3.3.2 Vlanif20 RIP 0:0:8
Number of RIP routes : 1
# Run the display ip routing-table command. The command output shows that
the devices have imported routes from each other. In the following example, the
display on SwitchA is used.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 8 Routes : 9
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.2.2.0/24 Direct 0 0 D 10.2.2.1 Vlanif10
10.2.2.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
10.3.3.0/24 Direct 0 0 D 10.3.3.1 Vlanif20
10.3.3.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
10.4.4.0/24 RIP 100 1 D 10.2.2.2 Vlanif10
RIP 100 1 D 10.3.3.2 Vlanif20
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.1.0/24 RIP 100 1 D 10.2.2.2 Vlanif10
The preceding command output shows that the next-hop address and outbound
interface of the route to destination 172.16.1.0/24 are 10.2.2.2 and VLANIF10, and
traffic is transmitted over the active link SwitchA->SwitchB.
Step 4 Configure one-arm static BFD on SwitchA.
# Configure one-arm BFD on SwitchA.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] bfd 1 bind peer-ip 10.2.2.2 interface vlanif 10 source-ip 10.1.1.1 one-arm-echo
[SwitchA-bfd-session-1] discriminator local 1
[SwitchA-bfd-session-1] min-echo-rx-interval 200
[SwitchA-bfd-session-1] commit
[SwitchA-bfd-session-1] quit
The source IP address 10.1.1.1 can be configured as the IP address of another
interface (such as loopback interface) on the device. This parameter must be
configured. Otherwise, the BFD session cannot be set up.
# Enable static BFD on VLANIF 10.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] rip bfd static
[SwitchA-Vlanif10] quit
# After the configurations are completed, run the display bfd session all
command on SwitchA. The command output shows that a static BFD session has
been set up.
[SwitchA] display bfd session all
--------------------------------------------------------------------------------
Local Remote PeerIpAddr State Type InterfaceName
--------------------------------------------------------------------------------
1 - 10.2.2.2 Up S_IP_IF Vlanif10
--------------------------------------------------------------------------------
Total UP/DOWN Session Number : 1/0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 125
Step 5 Verify the configuration.
# Run the shutdown command on GigabitEthernet0/0/1 of SwitchB to simulate a
fault in the active link.
NOTE
The link fault is simulated to verify the configuration. In actual situations, the operation is
not required.
[SwitchB] interface gigabitethernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] shutdown
# Check the routing table of SwitchA.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 6 Routes : 6
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.3.3.0/24 Direct 0 0 D 10.3.3.1 Vlanif20
10.3.3.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
10.4.4.0/24 RIP 100 1 D 10.3.3.2 Vlanif20
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.1.0/24 RIP 100 2 D 10.3.3.2 Vlanif20
The preceding command output shows that the standby link SwitchA->SwitchC-
>SwitchB is used after the active link fails, and the next-hop address and
outbound interface of the route to destination 172.16.1.0/24 are 10.3.3.2 and
VLANIF20.
----End
Configuration files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
bfd
#
interface Vlanif10
ip address 10.2.2.1 255.255.255.0
rip bfd static
#
interface Vlanif20
ip address 10.3.3.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bfd 1 bind peer-ip 10.2.2.2 interface Vlanif10 source-ip 10.1.1.1 one-arm-echo
discriminator local 1
min-echo-rx-interval 200
commit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 126
#
rip 1
version 2
network 10.0.0.0
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 30 40
#
interface Vlanif10
ip address 10.2.2.2 255.255.255.0
#
interface Vlanif30
ip address 10.4.4.1 255.255.255.0
#
interface Vlanif40
ip address 172.16.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 40
#
rip 1
version 2
network 10.0.0.0
network 172.16.0.0
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 30
#
interface Vlanif20
ip address 10.3.3.2 255.255.255.0
#
interface Vlanif30
ip address 10.4.4.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
rip 1
version 2
network 10.0.0.0
#
return
● SwitchD configuration file
#
sysname SwitchD
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 127
#
vlan batch 40
#
interface Vlanif40
ip address 172.16.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
rip 1
version 2
network 172.16.0.0
#
return
3.16.4 Example for Configuring Dynamic BFD for RIP
Networking Requirements
In Figure 3-14, four switches communicate using RIP on a small-sized network.
Services are transmitted through the primary link SwitchA→SwitchB→SwitchD.
Reliability must be improved for data transmitted from SwitchA to SwitchB so that
services can be rapidly switched to another path when the primary link fails.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 3-14 Configuring dynamic BFD for RIP
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IP address for each interface to ensure network reachability.
2. Enable RIP on each switch to implement network connections between
processes.
3. Configure BFD for RIP on interfaces at both ends of the link between SwitchA
and SwitchB. BFD can rapidly detect the link status and help RIP speed up
route convergence to implement fast link switching.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 128
Procedure
Step 1 Configure VLANs and add interfaces to the VLANs. The configurations of SwitchB,
SwitchC, and SwitchD are similar to the configuration of SwitchA, and are not
mentioned here.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure an IP address to each VLANIF interface. The configurations of SwitchB,
SwitchC, and SwitchD are similar to the configuration of SwitchA, and are not
mentioned here.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.2.2.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 10.3.3.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure basic RIP functions.
# Configure SwitchA.
[SwitchA] rip 1
[SwitchA-rip-1] version 2
[SwitchA-rip-1] network 10.0.0.0
[SwitchA-rip-1] quit
# Configure SwitchB.
[SwitchB] rip 1
[SwitchB-rip-1] version 2
[SwitchB-rip-1] network 10.0.0.0
[SwitchB-rip-1] network 172.16.0.0
[SwitchB-rip-1] quit
# Configure SwitchC.
[SwitchC] rip 1
[SwitchC-rip-1] version 2
[SwitchC-rip-1] network 10.0.0.0
[SwitchC-rip-1] quit
# Configure SwitchD.
[SwitchD] rip 1
[SwitchD-rip-1] version 2
[SwitchD-rip-1] network 172.16.0.0
[SwitchD-rip-1] quit
# After completing the preceding operations, run the display rip neighbor
command. The command output shows that SwitchA, SwitchB, and SwitchC have
established neighbor relationships with each other. In the following example, the
display on SwitchA is used.
[SwitchA] display rip 1 neighbor
---------------------------------------------------------------------
IP Address Interface Type Last-Heard-Time
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 129
---------------------------------------------------------------------
10.2.2.2 Vlanif10 RIP 0:0:14
Number of RIP routes : 2
10.3.3.2 Vlanif20 RIP 0:0:19
Number of RIP routes : 1
# Run the display ip routing-table command. The command output shows that
the switches have imported routes from each other. In the following example, the
display on SwitchA is used.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 8 Routes : 9
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.2.2.0/24 Direct 0 0 D 10.2.2.1 Vlanif10
10.2.2.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
10.3.3.0/24 Direct 0 0 D 10.3.3.1 Vlanif20
10.3.3.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
10.4.4.0/24 RIP 100 1 D 10.3.3.2 Vlanif20
RIP 100 1 D 10.2.2.2 Vlanif10
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.1.0/24 RIP 100 1 D 10.2.2.2 Vlanif10
The preceding command output shows that the next-hop address and outbound
interface of the route to destination 172.16.1.0/24 are 10.2.2.2 and VLANIF10, and
traffic is transmitted over the active link SwitchA->SwitchB.
Step 4 Configure BFD in RIP processes.
# Configure BFD on all interfaces of SwitchA. The configuration of SwitchB is
similar to that of SwitchA, and is not provided here.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] rip 1
[SwitchA-rip-1] bfd all-interfaces enable
[SwitchA-rip-1] bfd all-interfaces min-tx-interval 100 min-rx-interval 100 detect-multiplier 10
[SwitchA-rip-1] quit
# After completing the preceding operations, run the display rip bfd session
command on SwitchA. The command output shows that SwitchA and SwitchB
have established a BFD session and the BFDState field displays Up. In the
following example, the display on SwitchA is used.
[SwitchA] display rip 1 bfd session all
LocalIp : 10.2.2.1 RemoteIp : 10.2.2.2 BFDState : Up
TX : 100 RX : 100 Multiplier : 10
BFD Local Dis : 8192 Interface : Vlanif10
Diagnostic Info : No diagnostic information
LocalIp : 10.3.3.1 RemoteIp : 10.3.3.2 BFDState : Down
TX : 2800 RX : 2800 Multiplier : 0
BFD Local Dis : 8193 Interface : Vlanif20
Diagnostic Info : No diagnostic information
Step 5 Verify the configuration.
# Run the shutdown command on GigabitEthernet0/0/1 of SwitchB to simulate a
fault in the active link.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 130
NOTE
The link fault is simulated to verify the configuration. In actual situations, the operation is
not required.
[SwitchB] interface gigabitethernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] shutdown
# Check the routing table of SwitchA.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 6 Routes : 6
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.3.3.0/24 Direct 0 0 D 10.3.3.1 Vlanif20
10.3.3.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
10.4.4.0/24 RIP 100 1 D 10.3.3.2 Vlanif20
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.1.0/24 RIP 100 2 D 10.3.3.2 Vlanif20
The preceding command output shows that the standby link SwitchA->SwitchC-
>SwitchB is used after the active link fails, and the next-hop address and
outbound interface of the route to destination 172.16.1.0/24 are 10.3.3.2 and
VLANIF20.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
bfd
#
interface Vlanif10
ip address 10.2.2.1 255.255.255.0
#
interface Vlanif20
ip address 10.3.3.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
rip 1
version 2
network 10.0.0.0
bfd all-interfaces enable
bfd all-interfaces min-tx-interval 100 min-rx-interval 100 detect-multiplier 10
#
return
● SwitchB configuration file
#
sysname SwitchB
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 131
#
vlan batch 10 30 40
#
bfd
#
interface Vlanif10
ip address 10.2.2.2 255.255.255.0
#
interface Vlanif30
ip address 10.4.4.1 255.255.255.0
#
interface Vlanif40
ip address 172.16.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 40
#
rip 1
version 2
network 10.0.0.0
network 172.16.0.0
bfd all-interfaces enable
bfd all-interfaces min-tx-interval 100 min-rx-interval 100 detect-multiplier 10
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 30
#
interface Vlanif20
ip address 10.3.3.2 255.255.255.0
#
interface Vlanif30
ip address 10.4.4.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
rip 1
version 2
network 10.0.0.0
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 40
#
interface Vlanif40
ip address 172.16.1.2 255.255.255.0
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 132
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
rip 1
version 2
network 172.16.0.0
#
return
3.17 Troubleshooting RIP
3.17.1 Failed to Receive RIP Update Packets from Neighbors
Fault Description
A device cannot receive RIP Update packets from neighbors when the link runs
properly.
Procedure
Step 1 Run the display current-configuration configuration rip command to check RIP
configurations.
● Check whether RIP has been enabled on the interface. Only the RIP-enabled
interface can receive RIP packets.
● Check whether the version number in the RIP packet sent by the peer
interface matches the version number in the RIP packet received by the local
interface. If not, the two interfaces cannot establish the RIP neighbor
relationship.
Step 2 Run the display current-configuration interface
interface-type interface-number
command to view the interface configuration.
● Check whether the undo rip input command has been executed on the
interface. If the command has been executed, the interface does not receive
RIP packets.
● Check whether the authentication modes on the two ends of the link are the
same. If the authentication modes are different, the interface cannot receive
RIP packets from the peer.
----End
3.17.2 Failed to Send RIP Update Packets to Neighbors
Fault Description
A device cannot send RIP Update packets to neighbors when the link runs
properly.
Procedure
Step 1 Run the display current-configuration configuration rip command to check RIP
configurations.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 133
● Check whether RIP has been enabled on the interface. Only the RIP-enabled
interface can send RIP packets.
● Check whether the silent-interface command has been executed on the
interface. If the command has been executed, the interface does not send RIP
packets.
Step 2 Run the display current-configuration interface
interface-type interface-number
command to view the interface configuration.
● Check whether the undo rip output command has been executed on the
interface. If the command has been executed, the interface does not send RIP
packets.
● Check whether the authentication modes on the two ends of the link are the
same. If the authentication modes are different, the interface cannot send RIP
packets to the peer.
● Check whether split horizon has been enabled on the interface. If split horizon
has been enabled, the interface cannot send the route learned by itself to
neighbors.
NOTE
Split horizon is enabled on all interfaces by default, but the display current-
configuration command output does not show the split horizon option. If the
command output for an interface connected to an NBMA network does not contain
the split horizon option, split horizon is disabled on the interface.
----End
3.17.3 Route Flapping Occurs on a RIP Network
Fault Description
Route flapping occurs on a RIP network when the link runs properly. Some routes
intermittently disappear in the routing table.
Procedure
Step 1 Run the display rip command to check the configuration of RIP timers.
The RIP timers on the entire network must be consistent; otherwise, route flapping
occurs. The relationships between the timer values are
update <
age,
update <
garbage-collect.
Step 2 Run the timers rip
update age garbage-collect command to set the RIP timers.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 3 RIP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 134
4 RIPng Configuration
4.1 Overview of RIPng
4.2 Understanding RIPng
4.3 Summary of RIPng Configuration Tasks
4.4 Licensing Requirements and Limitations for RIPng
4.5 Default Settings for RIPng
4.6 Configuring Basic RIPng Functions
4.7 Preventing Routing Loops
4.8 Controlling RIPng Routing
4.9 Controlling RIPng Route Advertisement
4.10 Controlling the Receiving of RIPng Routes
4.11 Improving RIPng Network Performance
4.12 Configuring IPSec Authentication for RIPng
4.13 Clearing RIPng
4.14 Example for Configuring RIPng to Filter the Received Routes
4.1 Overview of RIPng
The Routing Information Protocol Next Generation (RIPng) is a simple Interior
Gateway Protocol (IGP). It is an extension to RIP on IPv6 networks. RIPng applies
to small-scale networks, such as campus networks and regional networks with
simple structure. RIPng is widely used on networks because it is easier to
implement, configure, and manage than OSPFv3 and IPv6 IS-IS.
NOTE
RIPng does not have any security authentication mechanism. For security purposes, use
OSPFv3, IPv6 IS-IS, or BGP4+.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 135
4.2 Understanding RIPng
4.2.1 RIPng
In addition to IPv4 networks, RIP is also applicable to IPv6 networks to provide
accurate route information for IPv6 packets. The IETF has defined RIP next
generation (RIPng) based on RIP for IPv6 networks. RIPng is an important protocol
for IPv6 networks.
Comparison Between RIPng and RIP
RIPng made the following modifications to RIP:
● RIPng uses UDP port 521 to send and receive routing information.
● RIPng uses the destination addresses with 128-bit prefixes (mask length).
● RIPng uses 128-bit IPv6 addresses as next-hop addresses.
● RIPng uses the local-link address FE80::/10 as the source address to send
RIPng Update packets.
● RIPng periodically sends routing information in multicast mode and uses
FF02::9 as multicast address.
● A RIPng packet consists of a header and multiple route table entries (RTEs). In
a RIPng packet, the maximum number of RTEs depends on the MTU of an
interface.
4.3 Summary of RIPng Configuration Tasks
Table 4-1 describes RIPng configuration tasks.
Table 4-1 RIPng configuration tasks
Scenario Description Task
Configuring basic RIPng
functions
Basic RIPng functions
include enabling RIPng
and enabling the RIPng
process on interfaces.
Basic RIPng functions
must be configured
before you use the RIPng
features.
4.6 Configuring Basic
RIPng Functions
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 136
Scenario Description Task
Preventing routing loops RIPng is a distance-
vector routing protocol.
RIPng devices advertise
their local IPv6 routing
tables to neighbors, so
routing loops may occur.
RIPng uses split horizon
and poison reverse to
prevent routing loops:
● Split horizon: A route
learned by RIPng
from an interface is
not sent to neighbors
from this interface.
This reduces
bandwidth
consumption and
prevents routing
loops.
● Poison reverse: RIPng
sets the cost of a
route learned from an
interface to 16
(unreachable), and
sends this route to
neighbors through
this interface. In this
way, RIPng can delete
useless routes from
neighbors' routing
table and prevent
routing loops.
4.7 Preventing Routing
Loops
Controlling RIPng routing To use RIPng more
flexibly on the existing
network and meet
various user
requirements, you can
configure different
parameters to control
RIPng routing.
4.8 Controlling RIPng
Routing
Controlling the
advertising and receiving
of RIPng routes
To meet network
requirements, you can
configure different
parameters to accurately
control the advertising
and receiving of RIPng
routes.
4.9 Controlling RIPng
Route Advertisement
4.10 Controlling the
Receiving of RIPng
Routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 137
Scenario Description Task
Improving RIPng
network performance
You can configure special
RIPng functions to
improve RIPng network
performance.
● Adjust the RIPng
timer to change the
RIPng network
convergence speed.
● Adjust the number
and interval of
Update packets sent
by an interface to
reduce consumption
of device resources
and network
bandwidth.
● Check the zero fields
in RIPng packets to
ensure high network
security.
4.11 Improving RIPng
Network Performance
4.4 Licensing Requirements and Limitations for RIPng
Involved Network Elements
Other network elements are required to support RIPng.
Licensing Requirements
RIPng is a basic feature of a switch and is not under license control.
Feature Support in V200R024C00
All models of S300, S500, S2700, S5700, and S6700 series switches (except the
S5751-L, S5731-L and S5731S-L) support RIPng.
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 138
Feature Limitations
When the maximum number of RIPng routes supported by a switch is fixed, the
maximum number of running RIPng routes supported on the switch is limited by
the CAR value of RIPng protocol packets, interval for sending RIP update packets,
and values of RIPng Age and Garbage-collect timers. To increase the maximum
number of running RIPng routes on a switch if there are large numbers of RIPng
routes running on the network, increase the values of the Age timer, Garbage-
collect timer, or CAR for RIPng protocol packets, as well as reducing the interval
for sending RIPng update packets.
4.5 Default Settings for RIPng
Table 4-2 describes the default settings for RIPng.
Table 4-2 Default settings for RIPng
Parameter Default Setting
Maximum number of equal-cost
routes
8
RIPng function Disabled
4.6 Configuring Basic RIPng Functions
Pre-configuration Tasks
Before configuring basic RIPng functions, complete the following tasks:
● Enable IPv6 on the switch.
● Configure IPv6 addresses for interfaces to ensure that neighboring nodes are
reachable at the network layer.
Configuration Procedure
Creating RIPng processes is the prerequisite for enabling RIPng on interfaces.
4.6.1 Enabling RIPng
Context
Enabling RIPng is the prerequisite for all RIPng configurations. If you run RIPng
commands in the interface view before enabling RIPng, the configurations take
effect only after RIPng is enabled.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 139
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ripng [
process-id ] [ vpn-instance
vpn-instance-name ]
A RIPng process is created, RIPng is enabled, and the RIPng view is displayed.
If a VPN instance is specified, the RIPng process belongs to this VPN instance. If no
VPN instance is specified, the RIPng process belongs to a public network instance.
Step 3 (Optional) Run description
text
A description is configured for the RIP process.
----End
4.6.2 Enabling RIPng on Interfaces
Context
After RIPng is enabled on an interface, devices can exchange RIPng routing
information through this interface.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ripng
process-id enable
RIPng is enabled on the specified interface.
NOTE
If IPv6 is not enabled on this interface, this command does not take effect on this interface.
If RIPng needs to be enabled on multiple interfaces of a switch, repeat steps 2 and
3.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 140
4.6.3 Verifying the Basic RIPng Function Configuration
Procedure
● Run the display ripng [
process-id | vpn-instance
vpn-instance-name ]
command to check the configuration of the specified RIPng process.
● Run the display ripng
process-id route command to check all the RIPng
routes that are learned from other switches.
● Run the display default-parameter ripng command to check the default
RIPng configuration.
● Run the display ripng
process-id statistics interface { all |
interface-type
interface-number [ neighbor
neighbor-ipv6-address | verbose ] } command
to check statistics about RIPng interfaces.
----End
4.7 Preventing Routing Loops
Pre-configuration Tasks
Before configuring split horizon and poison reverse, configure basic RIPng
functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the RIPng Routing Loop Prevention Configuration) in any sequence as required.
4.7.1 Configuring Split Horizon
Context
Split horizon can prevent routing loops.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 141
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ripng split-horizon
Split horizon is configured.
NOTE
● By default, split horizon is disabled on a Non-Broadcast Multiple Access (NBMA)
network.
● If both split horizon and poison reverse are configured, only poison reverse takes effect.
----End
4.7.2 Configuring Poison Reverse
Context
Poison reverse can prevent routing loops.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ripng poison-reverse
Poison reverse is enabled.
NOTE
If both split horizon and poison reverse are configured, only poison reverse takes effect.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 142
4.7.3 Verifying the RIPng Routing Loop Prevention
Configuration
Procedure
● Run the display ripng
process-id interface [
interface-type interface-
number ] [ verbose ] command to check information about the specified
RIPng interface.
----End
4.8 Controlling RIPng Routing
Pre-configuration Tasks
Before configuring RIPng route attributes, configure basic RIPng functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the RIPng Routing Control Configuration) in any sequence as required.
4.8.1 Configuring RIPng Preference
Context
When different routing protocols discover the routes to the same destination, set
the RIPng preference to select the required route.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ripng [
process-id ] [ vpn-instance
vpn-instance-name ]
The RIPng view is displayed.
Step 3 Run preference {
preference | route-policy
route-policy-name } *
The RIPng preference value is set.
By default, the RIPng preference value is 100.
----End
4.8.2 Configuring Additional Metrics of an Interface
Context
Configuring the additional metrics of a RIPng interface can change the route
selection sequence.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 143
The additional metric is the metric (hop count) to be added to the original metric
of a RIPng route. You can set additional metrics for incoming and outgoing RIPng
routes using commands.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run the following commands as required:
● Run the ripng metricin
value command to set the additional metric for
receiving routes. By default, an interface does not add the metric to a received
RIPng route.
● Run the ripng metricout {
value | {
acl6-number | acl6-name
acl6-name |
ipv6-prefix
ipv6-prefix-name }
value1 } command to set the additional metric
for advertising routes. By default, the metric that is added to the RIPng route
sent by an interface is 1.
NOTE
● The ripng metricin command adds an additional metric to an incoming route. After this
route is added to the routing table, its metric in the routing table changes. Running this
command affects route selection on the local device and other devices on the network.
● The ripng metricout command adds an additional metric to an outgoing route. When
this route is advertised, an additional metric is added to this route, but the metric of the
route in the routing table does not change. Running this command does not affect route
selection on the local device but other devices on the network.
----End
4.8.3 Setting the Maximum Number of Equal-Cost Routes
Context
By setting the maximum number of equal-cost RIPng routes, you can change the
number of routes for load balancing.
NOTE
Only the S5720I-SI, S5735-S, S500, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S,
S5731S-H, S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and
S6730S-S support this function.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 144
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ripng [
process-id ] [ vpn-instance
vpn-instance-name ]
RIPng is enabled and the RIPng view is displayed.
Step 3 Run maximum load-balancing
number
The maximum number of equal-cost routes is set.
The default value is 8.
----End
4.8.4 Verifying the RIPng Routing Control Configuration
Procedure
● Run the display ripng [
process-id | vpn-instance
vpn-instance-name ]
command to check the running status and configurations of RIPng.
● Run the display ripng
process-id database [ verbose ] command to check all
the active routes in the RIPng database.
● Run the display ripng
process-id route command to check all RIPng routes
learned from other devices.
----End
4.9 Controlling RIPng Route Advertisement
Pre-configuration Tasks
Before controlling RIPng route advertisement, configure basic RIPng functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the RIPng Route Advertisement Control Configuration) in any sequence as
required.
4.9.1 Configuring RIPng Route Summarization
Context
Route summarization can reduce the routing table size and minimize impact of
route flapping on the network.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 145
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ripng summary-address
ipv6-address prefix-length [ avoid-feedback ]
RIPng route summarization is configured.
By default, a RIPng router does not advertise summarized IPv6 addresses.
----End
4.9.2 Advertising a Default Route
Context
In an IPv6 routing table, a default route is a route to network ::/0. If the
destination address of a packet does not match any entry in the routing table, the
packet is sent through a default route.
There are two methods to advertise RIPng default routes. You can configure a
device to advertise RIPng default routes according to networking requirements.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 146
Step 4 Run ripng default-route { only | originate } [ cost
cost ]
The device is configured to advertise RIPng default routes.
By default, there is no default route in the RIPng routing domain.
Configure the device to advertise default routes according to networking
requirements:
● only: configures the device to advertise only IPv6 default routes (::/0),
suppressing the advertisement of other routes. If the local device is located on
the network edge and the details of the local network need to be hidden, you
can set this parameter to enable the devices on other networks to access the
local network only through the local device.
● originate: configures the device to advertise IPv6 default routes (::/0) without
affecting the advertisement of other routes. If the local device is located on
the network edge and some details of the local network need to be hidden,
you can set this parameter to enable the devices on other networks to use the
default route when connecting to certain devices on the local network.
The device advertises generated RIPng default routes using Update packets
through a specified interface regardless of whether these routes exist in the local
IPv6 routing table.
----End
4.9.3 Configuring a RIPng Process to Import External Routes
Context
A RIPng process can import the routes learned by other processes or routing
protocols to enrich its routing information.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ripng [
process-id ] [ vpn-instance
vpn-instance-name ]
The RIPng view is displayed.
Step 3 (Optional) Run default-cost
cost
The default cost of external routes to be imported is set.
By default, the default cost of RIPng routes is 0.
If no cost is set for external routes to be imported, the default cost is used.
NOTE
When a RIPng process imports IBGP routes, routing loops may occur. Therefore, exercise
caution before you configure this function.
Step 4 Run import-route { { ripng | isis | ospfv3 } [
process-id ] | bgp [ permit-ibgp ] |
unr | direct | static } [ [ cost
cost | inherit-cost ] | route-policy
route-policy-
name ] *
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 147
External routes are imported.
Step 5 (Optional) Run filter-policy {
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-prefix-name | route-policy
route-policy-name } export [
protocol [
process-
id ] ]
The RIPng process is configured to filter imported routes.
A RIPng process can use ACL6, route policy and IPv6 prefix lists to filter imported
routes, allowing only the routes matching ACL6, route policy and IPv6 prefix lists
to be advertised to RIPng neighbors. If
protocol is not specified, the RIPng process
filters all the routes to be advertised, including imported routes and local RIPng
routes (similar to direct routes).
----End
4.9.4 Disabling Sending of RIPng Packets on an Interface
Context
When a device running RIPng is connected to a network running other routing
protocols, you can run the undo ripng output command on the interface that
connects the device to the network to prevent the interface from sending useless
packets to the network.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run undo ripng output
The interface is disabled from sending RIPng packets.
By default, an interface is allowed to send RIPng packets.
----End
4.9.5 Disabling Receiving of RIPng Packets on an Interface
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 148
Context
When a device running RIPng is connected to a network running other routing
protocols, you can run the undo ripng input command on the interface that
connects the device to the network to prevent the interface from receiving useless
packets from the network.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run undo ripng input
The interface is disabled from receiving RIPng packets.
By default, an interface is allowed to receive RIPng packets.
----End
4.9.6 Verifying the RIPng Route Advertisement Control
Configuration
Procedure
● Run the display ripng
process-id database [ verbose ] command to check all
activated routes in the RIPng database.
● Run the display ripng
process-id route command to check all the RIPng
routes that are learned from other switches.
----End
4.10 Controlling the Receiving of RIPng Routes
Pre-configuration Tasks
Before controlling the receiving of RIPng routes, configure basic RIPng functions.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 149
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ripng [
process-id ]
The RIPng view is displayed.
Step 3 Run filter-policy {
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-prefix-
name | route-policy
route-policy-name } import
The RIPng process is configured to filter received routes.
You can use ACL6, route policy and IPv6 prefix lists to filter received RIPng routes,
allowing only the routes matching ACL6, route policy and IPv6 prefix lists to be
added to RIPng routing tables.
----End
Verifying the Configuration
● Run the display ripng
process-id database [ verbose ] command to check all
the active routes in the RIPng database.
● Run the display ripng
process-id route command to check all the RIPng
routes learned from other switches.
4.11 Improving RIPng Network Performance
Pre-configuration Tasks
Before improving RIPng network performance, configure basic RIPng functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the RIPng Network Performance Optimization Configuration) in any sequence as
required.
4.11.1 Configuring RIPng Timers
Context
RIPng uses 3 timers: Update, Age, and Garbage-collect. Changing the timer values
affects the convergence speed of RIPng routes.
Procedure
Step 1 Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 150
Step 2 Run ripng [
process-id ] [ vpn-instance
vpn-instance-name ]
The RIPng process is enabled and the RIPng view is displayed.
Step 3 Run timers ripng
update age garbage-collect
RIPng timers are configured.
NOTE
● RIPng timers take effect immediately after being changed.
● Route flapping occurs if the values of the three timers are set improperly. The
relationship between the values is:
update must be smaller than
age and
garbage-
collect. If the update time is longer than the aging time and for example, a RIPng route
changes within the update time, the switch cannot inform its neighbors of the change
on time.
● Configure RIPng timers based on the network performance ensure that these timers are
consistent on all RIPng devices. This avoids unnecessary network traffic or route
flapping.
By default, the Update timer is 30s; the Age timer is 180s; the Garbage-collect
timer is 120s (four times the Update timer).
In practice, the Garbage-collect timer is not fixed. If the Update timer is set to 30s,
the Garbage-collect timer may range from 90s to 120s.
Before permanently deleting an unreachable route from its RIPng routing table, a
RIPng device advertises this route (with the metric set to 16) four times by
periodically sending Update packets. Subsequently, all the neighbors learn that
this route is unreachable. Because a route may not always become unreachable at
the beginning of an Update period, the Garbage-collect timer ranges from three
or four times the Update timer.
----End
4.11.2 Setting the Interval for Sending Update Packets and
Maximum Number of Sent Packets
Context
To limit memory resources occupied by RIPng Update packets, set the interval for
sending RIPng Update packets and the maximum number of Update packets to be
sent at a time to appropriate values.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 151
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ripng pkt-transmit { interval
interval | number
pkt-count }*
The interval for sending RIPng Update packets and the maximum number of
Update packets to be sent at a time are set.
----End
4.11.3 Enabling Zero Field Check for RIPng Packets
Context
In a RIPng packet, some fields must be zero. These fields are called zero fields.
When receiving a packet, a RIPng process checks the zero fields of the packet. If
the value of a zero field in the packet is not 0, the RIPng process discards the
packet.
Enabling zero field check on RIPng Update packets can improve network security.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ripng [
process-id ] [ vpn-instance
vpn-instance-name ]
The RIPng view is displayed.
Step 3 Run checkzero
Zero field check is enabled for RIPng packets.
----End
4.11.4 Verifying the RIPng Network Performance
Optimization Configuration
Procedure
● Run the display ripng [
process-id | vpn-instance
vpn-instance-name ]
command to check the configuration of the RIPng process.
● Run the display ripng
process-id database [ verbose ] command to check all
activated routes in the RIPng database.
● Run the display ripng
process-id interface [
interface-type interface-
number ] [ verbose ] command to check information about the RIPng
interface.
● Run the display ripng
process-id neighbor [ verbose ] command to check
information about RIPng neighbors.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 152
● Run the display ripng
process-id route command to check all the RIPng
routes that are learned from other switches.
----End
4.12 Configuring IPSec Authentication for RIPng
4.12.1 Configuring an IPSec Session for Encryption
Context
Internet Protocol Security (IPSec) can be configured to prevent data theft and
spoofing during data transmission in a network.
A security association (SA) must be established so that IPSec can protect
transmitted data. An SA is a unidirectional logical connection set up for security
purpose and specifies the elements used by two IPSec peers (two parties that use
the IPSec protocol to protect data transmitted between them). The elements of an
SA include the following:
● Security protocol
● Authentication or encryption algorithm supported by the security protocol
● Data encapsulation mode
● Security parameter index (SPI) of the SA
● Authentication key or encryption key of the SA
The first three elements are specified in an IPSec proposal. To configure IPSec
functions, first configure an IPSec proposal on the IPSec peers, and then configure
an SA.
Procedure
Step 1 Configure an IPSec proposal.
1. Run system-view
The system view is displayed.
2. Run ipsec proposal
proposal-name
An IPSec proposal is created and the IPSec proposal view is displayed.
3. Run transform { ah | esp }
A security protocol is specified for the IPSec proposal.
By default, the security protocol used by an IPSec proposal is the
Encapsulation Security Protocol (ESP).
4. An authentication or encryption algorithm is configured.
– If AH is used, you can only configure the AH-specific authentication
algorithm because AH only authenticates packets.
Run the ah authentication-algorithm { sha1 | sha2-256 } command to
specify the authentication algorithm for the AH protocol.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 153
By default, the AH protocol uses the Secure Hash Algorithm 2-256
(SHA2-256) authentication algorithm.
– When ESP is specified, ESP can encrypt/authenticate, or encrypt and
authenticate packets. Configure the ESP-specific authentication or
encryption algorithm.
▪ Run the esp authentication-algorithm { sha1 | sha2-256 }
command to specify the authentication algorithm for the ESP
protocol.
By default, the authentication algorithm SHA2-256 is used for ESP.
▪ Run the esp encryption-algorithm { 3des | aes [ 128 | 192 | 256 ] }
command to specify the encryption algorithm for the ESP protocol.
By default, the encryption algorithm Advanced Encryption
Standard-256 (AES-256) is used for ESP.
The SHA-1 and 3DES algorithm is not recommended because it cannot meet
your security defense requirements.
5. Run encapsulation-mode { transport | tunnel }
A data encapsulation mode is specified for the security protocol.
By default, the data encapsulation mode is tunnel.
NOTE
In transport mode, the packet encryption device and decryption device must be the
originator and receiver of packets.
6. Run quit
Return to the system view.
Step 2 Configure an IPSec SA.
1. Run ipsec sa
sa-name
An IPSec SA is created and the IPSec SA view is displayed.
By default, no IPSec SA exists in the system.
2. Run proposal
proposal-name
The IPSec proposal is bound to the IPSec SA.
By default, an IPSec policy does not reference any IPSec proposal.
NOTE
An IPSec can use only one IPSec proposal. To bind a new IPSec proposal to the IPSec
SA, delete the original IPSec proposal.
3. Run sa spi { inbound | outbound } { ah | esp }
spi-number
An SPI is configured for the SA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 154
NOTE
– An SPI uniquely identifies an SA. Each SA must be configured with an inbound SPI
and an outbound SPI. The outbound SPI on the local end must be the same as the
inbound SPI on the remote end.
– The security protocol (AH or ESP) you select when configuring the SPI must be the
same as that used in the IPSec proposal bound to the SA.
4. Configure a key according to the security protocol used in the IPSec proposal
bound to the SA.
– If the AH protocol is used, you can configure an authentication key that is
a hexadecimal number or a character string.
▪ Run the sa authentication-hex { inbound | outbound } ah
[ cipher ]
hex-cipher-key command to configure a hexadecimal
authentication key.
▪ Run the sa string-key { inbound | outbound } ah [ cipher ]
string-
cipher-key command to configure a character string as the
authentication key.
– If the ESP protocol is used, you can run one of the following commands
to configure the authentication key or the encryption key. You can also
configure both the authentication key and encryption key. If the two keys
are configured at the same time, they can only be hexadecimal keys.
▪ Run the sa authentication-hex { inbound | outbound } esp
[ cipher ]
hex-cipher-key command to configure a hexadecimal
authentication key.
▪ Run the sa string-key { inbound | outbound } esp [ cipher ]
string-
cipher-key command to configure a character string as the
authentication key.
▪ Run the sa encryption-hex { inbound | outbound } esp [ cipher ]
hex-cipher-key command to configure a hexadecimal encryption key.
NOTE
– The security protocol (AH or ESP) you select when configuring the key must be the
same as that used in the IPSec proposal bound to the SA.
– The outbound key on the local end must be the same as the inbound key on the
remote end.
– The IPSec peers must use the authentication or encryption key in the same format.
For example, if the key on one end is a character string but the key on the other
end is a hexadecimal number, the IPSec tunnel cannot be set up.
– If you configure multiple keys in different formats, the last configured key takes
effect.
Step 3 Verify the configuration.
1. Run the display ipsec sa [ name
sa-name ] [ brief ] command to check
information about the SA.
2. Run the display ipsec proposal [ name
proposal-name ] command to check
information about the security proposal.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 155
3. Run the display ipsec statistics [ sa-name
sa-name slot
slot-number ]
command to check statistics about packets processed by IPSec.
----End
4.12.2 Configuring RIPng IPSec Authentication
Context
As networks develop rapidly, network security has become a major concern. If
IPSec authentication is configured on a RIPng network, the sent and received
RIPng packets will be authenticated, and those cannot pass authentication will be
discarded. This can improve the security of the RIPng network.
There are two methods of configuring IPSec authentication for RIPng:
● One method is to configure IPSec authentication in RIPng processes. If IPSec
authentication is enabled in a RIPng process, this configuration takes effect on
all interfaces in this RIPng process. This method is recommended if IPSec
authentication needs to be applied to all interfaces in a RIPng process.
● The other method is to configure IPSec authentication on RIPng interfaces.
This method is recommended if IPSec authentication needs to be applied only
to some interfaces in a RIPng process.
Procedure
● Configuring IPSec authentication in a RIPng process
a. Run system-view
The system view is displayed.
b. Run ripng [
process-id ]
The RIPng view is displayed.
c. Run ipsec sa
sa-name
IPSec authentication is enabled, and the name of an SA is specified.
By default, IPSec authentication is disabled in a RIPng process.
● Configuring IPSec authentication on a RIPng interface
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 156
d. Run ripng ipsec sa
sa-name
IPSec authentication is enabled on the interface, and the name of an SA
is specified.
By default, IPSec authentication is disabled on a RIPng interface.
NOTE
The ripng ipsec sa command takes precedence over the ipsec sa command. If
both commands are run in respective views and different SA names are specified,
only the configuration of the ripng ipsec sa command takes effect.
----End
4.12.3 Verifying the RIPng IPSec Authentication Configuration
Procedure
● Run the display ipsec proposal [ name
proposal-name ] command to check
IPSec proposal information.
● Run the display ipsec sa [ name
sa-name ] [ brief ] command to check
information about a Security Association (SA).
● Run the display ipsec statistics [ sa-name
sa-name slot
slot-number ]
command to check statistics about packets processed by IPSec.
● Run the display ripng
process-id interface [
interface-type interface-
number ] [ verbose ] command to check the SA used in IPSec authentication.
● Run the display ripng
process-id statistics interface { all |
interface-type
interface-number [ verbose | neighbor
neighbor-ipv6-address ] } command
to check the number of RIPng packets that failed authentication.
----End
4.13 Clearing RIPng
Context
NOTICE
RIPng information cannot be restored after it is cleared. Exercise caution before
clearing RIPng information.
Procedure
● Run the reset ripng
process-id statistics [ interface {
interface-type
interface-number [ neighbor
neighbor-ip-address ] } ] command in the user
view to clear statistics about the counter that is maintained by a specified
RIPng process.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 157
4.14 Example for Configuring RIPng to Filter the
Received Routes
Networking Requirements
In Figure 4-1, the prefix length of all the IPv6 addresses is 64 bits, and the VLANIF
interfaces between neighboring Switches are assigned IPv6 link-local addresses.
All the Switches must learn IPv6 routing information on the network using RIPng.
SwitchB should filter the routes received from SwitchC (at FC00:0:0:3::/64). That is,
SwitchB does not add the routes to its own RIPng routing table or advertise the
routes to SwitchA.
Figure 4-1 Configuring RIPng to filter the received routes
Configuration Roadmap
The configuration roadmap is as follows:
1. Enable RIPng on each Switch so that the Switches can communicate with
each other.
2. Configure an ACL on SwitchB to filter the received routes.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. Ensure that the configurations of SwitchB, and SwitchC are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan 10
[SwitchA-vlan10] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 158
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/2] quit
[SwitchA] vlan 20
[SwitchA-vlan20] quit
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign IP addresses to the VLANIF interfaces.
# Configure SwitchA. Ensure that the configurations of SwitchB, and SwitchC are
similar to the configuration of SwitchA.
[SwitchA] ipv6
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ipv6 enable
[SwitchA-Vlanif10] ipv6 address fc00:0:0:1::1/64
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ipv6 enable
[SwitchA-Vlanif20] ipv6 address auto link-local
[SwitchA-Vlanif20] quit
Step 3 Configure basic RIPng functions.
# Configure SwitchA.
[SwitchA] ripng 1
[SwitchA-ripng-1] quit
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ripng 1 enable
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ripng 1 enable
[SwitchA-Vlanif20] quit
# Configure SwitchB.
[SwitchB] ripng 1
[SwitchB-ripng-1] quit
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] ripng 1 enable
[SwitchB-Vlanif20] quit
[SwitchB] interface vlanif 30
[SwitchB-Vlanif30] ripng 1 enable
[SwitchB-Vlanif30] quit
# Configure SwitchC.
[SwitchC] ripng 1
[SwitchC-ripng-1] quit
[SwitchC] interface vlanif 30
[SwitchC-Vlanif30] ripng 1 enable
[SwitchC-Vlanif30] quit
[SwitchC] interface vlanif 40
[SwitchC-Vlanif40] ripng 1 enable
[SwitchC-Vlanif40] quit
[SwitchC] interface vlanif 50
[SwitchC-Vlanif50] ripng 1 enable
[SwitchC-Vlanif50] quit
# Check the RIPng routing table of SwitchB.
[SwitchB] display ripng 1 route
Route Flags: R - RIPng
A - Aging, G - Garbage-collect
----------------------------------------------------------------
Peer FE80::D472:0:3C23:1 on Vlanif20
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 159
Dest FC00:0:0:1::/64,
via FE80::D472:0:3C23:1, cost 1, tag 0, RA, 4 Sec
Peer FE80::F54C:0:9FDB:1 on Vlanif30
Dest FC00:0:0:2::/64,
via FE80::F54C:0:9FDB:1, cost 1, tag 0, RA, 3 Sec
Dest FC00:0:0:3::/64,
via FE80::F54C:0:9FDB:1, cost 1, tag 0, RA, 3 Sec
The preceding information shows that the RIPng routing table of SwitchB contains
the route of network segment FC00:0:0:3::/64.
# Check the RIPng routing table of SwitchA.
[SwitchA] display ripng 1 route
Route Flags: R - RIPng
A - Aging, G - Garbage-collect
----------------------------------------------------------------
Peer FE80::476:0:3624:1 on Vlanif20
Dest FC00:0:0:2::/64,
via FE80::476:0:3624:1, cost 2, tag 0, RA, 21 Sec
Dest FC00:0:0:3::/64,
via FE80::476:0:3624:1, cost 2, tag 0, RA, 21 Sec
The preceding information shows that the RIPng routing table of SwitchA contains
the route of network segment FC00:0:0:3::/64 advertised by SwitchB.
Step 4 Configure SwitchB to filter the received routes.
[SwitchB] acl ipv6 number 2000
[SwitchB-acl6-basic-2000] rule deny source fc00:0:0:3:: 64
[SwitchB-acl6-basic-2000] rule permit
[SwitchB-acl6-basic-2000] quit
[SwitchB] ripng 1
[SwitchB-ripng-1] filter-policy 2000 import
[SwitchB-ripng-1] quit
Step 5 Verify the configuration.
NOTE
After the aging time of the filtered routing entry expires, check the verification result. The
default aging time is 180 seconds.
# Check the RIPng routing table of SwitchB. The RIPng routing table should not
contain the route of network segment FC00:0:0:3::/64.
[SwitchB] display ripng 1 route
Route Flags: R - RIPng
A - Aging, G - Garbage-collect
----------------------------------------------------------------
Peer FE80::D472:0:3C23:1 on Vlanif20
Dest FC00:0:0:1::/64,
via FE80::D472:0:3C23:1, cost 1, tag 0, RA, 25 Sec
Peer FE80::F54C:0:9FDB:1 on Vlanif30
Dest FC00:0:0:2::/64,
via FE80::F54C:0:9FDB:1, cost 1, tag 0, RA, 14 Sec
# Check the RIPng routing table of SwitchA. The RIPng routing table should not
contain the route of network segment FC00:0:0:3::/64.
[SwitchA] display ripng 1 route
Route Flags: R - RIPng
A - Aging, G - Garbage-collect
----------------------------------------------------------------
Peer FE80::476:0:3624:1 on Vlanif20
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 160
Dest FC00:0:0:2::/64,
via FE80::476:0:3624:1, cost 2, tag 0, RA, 7 Sec
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
vlan batch 10 20
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:1::1/64
ripng 1 enable
#
interface Vlanif20
ipv6 enable
ipv6 address auto link-local
ripng 1 enable
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 10
#
ripng 1
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
vlan batch 20 30
#
acl ipv6 number 2000
rule 0 deny source FC00:0:0:3::/64
rule 1 permit
#
interface Vlanif20
ipv6 enable
ipv6 address auto link-local
ripng 1 enable
#
interface Vlanif30
ipv6 enable
ipv6 address auto link-local
ripng 1 enable
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
ripng 1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 161
filter-policy 2000 import
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 30 40 50
#
interface Vlanif30
ipv6 enable
ipv6 address auto link-local
ripng 1 enable
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:2::1/64
ripng 1 enable
#
interface Vlanif50
ipv6 enable
ipv6 address FC00:0:0:3::1/64
ripng 1 enable
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 50
#
ripng 1
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 4 RIPng Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 162
5 OSPF Configuration
5.1 Overview of OSPF
5.2 Understanding OSPF
5.3 Application Scenarios for OSPF
5.4 OSPF Deployment Guide
5.5 Summary of OSPF Configuration Tasks
5.6 Licensing Requirements and Limitations for OSPF
5.7 Default Settings for OSPF
5.8 Configuring Basic OSPF Functions
5.9 Configuring Session Parameters for OSPF Neighbor or Adjacency Relationships
5.10 Configuring OSPF Attributes on Different Types of Networks
5.11 Configuring OSPF Stub Areas
5.12 Configuring an OSPF NSSA
5.13 Configuring Local MT
5.14 Adjusting OSPF Route Selection
5.15 Controlling OSPF Routing Information
5.16 Configuring BFD for OSPF
5.17 Configuring OSPF IP FRR
5.18 Configuring OSPF Fast Convergence
5.19 Configuring OSPF GR
5.20 Improving Stability of an OSPF Network
5.21 Improving the Security of an OSPF Network
5.22 Configuring OSPF Neighbor Relationship Flapping Suppression
5.23 Suppressing the Advertisement of Interface IP Addresses
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 163
5.24 Configuring Network Management for OSPF
5.25 Maintaining OSPF
5.26 Configuration Examples for OSPF
5.27 Troubleshooting OSPF
5.1 Overview of OSPF
Definition
The Open Shortest Path First (OSPF) protocol is a link-state Interior Gateway
Protocol (IGP) developed by the Internet Engineering Task Force (IETF).
OSPF constructs network topologies and routing tables by:
● Dividing an Autonomous System (AS) into one or more logical areas
● Advertising routes by sending Link State Advertisements (LSAs)
● Exchanging OSPF packets between devices in an OSPF area to synchronize
routing information
● Encapsulating OSPF packets into IP packets and sending the packets in
unicast or multicast mode
OSPF Version 2, as defined in RFC 2328, is designed for IPv4. OSPF Version 3, as
defined in RFC 2740, is designed for IPv6. Unless otherwise stated, OSPF in this
document refers to OSPF Version 2.
Advantages
Before the introduction of OSPF, the Routing Information Protocol (RIP) was the
most widely used IGP. The rapid growth and expansion of networks have pushed
RIP to its limits. RIP has certain limitations that can cause problems in large
networks. OSPF can address many issues facing RIP. Table 5-1 compares RIP and
OSPF.
Table 5-1 RIP versus OSPF
RIP OSPF
RIP uses a distance-vector algorithm to
calculate routes and uses the hop
count as the metric, without
considering the bandwidth.
OSPF uses a link-state algorithm to
build and calculate the shortest path
to all known destinations. It uses the
link cost as the metric and considers
the bandwidth while calculating
routes.
RIP has a limit of 15 hops, which limits
the RIP network scale.
OSPF does not have the hop limit and
applies to large networks.
RIP updates and selects routes through
route advertisements. Routers do not
know the entire network topology,
which can easily cause routing loops.
Each router knows the entire network
topology and calculates routes using
the shortest path first (SPF) algorithm,
which can prevent routing loops.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 164
RIP OSPF
RIP converges slower than OSPF. Route
updates go through a period of a
hold-down and garbage collection.
This could cause routing
inconsistencies between routers.
OSPF converges faster than RIP
because route updates are propagated
instantaneously to the entire network.
RIP cannot handle variable length
subnet mask (VLSM).
OSPF can handle VLSM, which is
helpful in IP address allocation.
In addition to the preceding advantages, OSPF has the following characteristics:
● Multicast packet transmission, reducing the load on the switches not running
OSPF
● Classless Inter-Domain Routing (CIDR)
● Load balancing among equal-cost routes
● Packet authentication
5.2 Understanding OSPF
5.2.1 OSPF Fundamentals
5.2.1.1 OSPF Characteristics
In an OSPF network, each router generates a link-state advertisement (LSA) based
on its surrounding network topology and transmits this LSA in an update packet
to other routers in the network.
RIP devices exchange routes, whereas OSPF devices exchange link state
information. That is, in RIP, routers select routes based on routing information of
neighbors, without checking whether the information transmitted by neighbors is
correct. In OSPF, routers calculate routes by themselves and select routes based on
LSAs.
Each router learns about the whole network topology based on its link state
database (LSDB). In Figure 5-1, each router collects LSAs sent from other routers,
and all LSAs form the LSDB of this router. An LSA describes the surrounding
network topology of a router, whereas an LSDB describes the network topology of
the entire AS. A router transforms its LSDB into a weighted and directed graph,
which reflects the topology of the entire AS. When the network topology is stable,
all routers in the same area have the same graph.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 165
Figure 5-1 Obtaining the whole network topology through an LSDB
A router calculates shortest paths to destinations using a shortest path first (SPF)
algorithm instead of obtaining routing information through route advertisements.
In Figure 5-2, based on the weighted and directed graph, each router uses an SPF
algorithm to calculate a shortest path tree (SPT) with itself as the root. The SPT
shows routes to nodes in the AS. This mechanism greatly improves routers'
capabilities in independent route selection and frees routers from selecting routes
based on route advertisements.
Figure 5-2 Calculating shortest paths to destinations using an SPF algorithm
An LSDB ensures that a router can learn about the whole network topology, and
an SPF algorithm ensures that a router can quickly calculate shortest paths to
destinations.
5.2.1.2 OSPF Mechanism
The OSPF mechanism includes the following steps:
1. Exchanging Hello packets to establish OSPF neighbor relationships
In Figure 5-3, after OSPF is run on the four routers, these routers send Hello
packets on all OSPF-enabled interfaces. If two routers share a data link and
successfully negotiate certain parameters specified in their Hello packets, they
establish an OSPF neighbor relationship.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 166
Figure 5-3 Exchanging Hello packets to establish OSPF neighbor relationships
2. Flooding LSAs to advertise link state information
Routers that have established an OSPF neighbor relationship can exchange
LSAs to form an OSPF adjacency, as shown in Figure 5-4. Each router
generates LSAs based on its surrounding network topology. LSAs describe
information about a router, including all links, interfaces, neighbors, and link
state of the router. Routers exchange the link information to learn about the
entire network topology. Because of the link diversity, OSPF defines multiple
LSA types. For details, see 5.2.1.9 OSPF LSA Types.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 167
Figure 5-4 Flooding LSAs to advertise link state information
3. Forming an LSDB to create a weighted and directed graph
A router floods LSAs and records received LSAs in its LSDB. Subsequently, all
routers have the same LSDB, as shown in Figure 5-5. An LSA describes the
surrounding network topology of a router, whereas an LSDB describes the
network topology of the entire AS and is the summary of LSAs.
Figure 5-5 Forming an LSDB to create a weighted and directed graph
4. Using an SPF algorithm to calculate and generate routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 168
In Figure 5-6, after LSDB synchronization is complete, each router uses an
SPF algorithm to calculate a loop-free topology with itself as the root and
describe the shortest path (with the minimum path cost) to each destination.
The topology is the SPT, which shows the optimal paths to nodes in an AS.
Figure 5-6 Using an SPF algorithm to calculate and generate routes
5. Maintaining and updating routing tables
After each router uses an SPF algorithm to calculate the SPT, it installs the
shortest paths in its routing table. These paths are installed as routing entries
to guide data forwarding. The routers then update their routing tables in real
time, as shown in Figure 5-7. Meanwhile, neighbors exchange Hello packets
to maintain their neighbor relationships or adjacencies and periodically
retransmit LSAs.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 169
Figure 5-7 Maintaining and updating routing tables
5.2.1.3 OSPF Packet Types
OSPF uses five packet types:
● Hello packet
OSPF uses Hello packets to implement the following functions:
– Neighbor discovery: OSPF routers periodically send Hello packets on
every OSPF-enabled interface, and negotiate the specific parameters in
the Hello packets with other routers that receive Hello packets to
determine whether to establish an OSPF neighbor relationship.
– Bidirectional communications: If a router sees its own router ID in the
neighbor list of a received Hello packet, bidirectional communication has
been established between this receiving router and the router that
originates the packet. An OSPF neighbor relationship has been
established between the two routers.
– Designated router (DR) and backup designated router (BDR) election:
Hello packets contain information about the DR priority and router ID.
Each router writes its selected DR and BDR to the DR and BDR fields of
Hello packets for DR and BDR election. For details, see 5.2.1.5 DR/BDR
Election.
– Keepalives: After an OSPF neighbor relationship is established, OSPF-
enabled interfaces still periodically send Hello packets to maintain the
neighbor relationship. If an interface does not receive a Hello packet from
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 170
a neighbor within a certain period, it terminates the neighbor relationship
with this neighbor.
● Database Description (DD) packet
During adjacency initialization, two routers send DD packets to negotiate
their master/slave relationship. In this phase, the DD packets contain only an
LSA header. When two routers exchange DD packets, one functions as the
master and the other functions as the slave. The master defines a start
sequence number and increments the sequence number by 1 each time it
sends a DD packet. After the slave receives a DD packet, it uses the sequence
number carried in the DD packet for acknowledgement.
After an adjacency is established, routers use DD packets to describe their
own LSDBs for LSDB synchronization. A DD packet contains the header of
each LSA in an LSDB and is the summary of all LSAs. An LSA header uniquely
identifies an LSA. The LSA header occupies only a small portion of the LSA,
which reduces the amount of traffic transmitted between routers. A neighbor
can use the LSA header to check whether it already has the LSA.
● Link State Request (LSR) packet
After two routers have exchanged DD packets, they send LSR packets to
request each other's LSAs. The LSR packets contain the summaries of the
requested LSAs.
● Link State Update (LSU) packet
A router uses an LSU packet to transmit LSAs requested by its neighbors or to
flood its own updated LSAs. The LSU packet contains a set of LSAs. To ensure
reliable LSA flooding, the router uses an LSAck packet to acknowledge the
LSAs contained in an LSU packet that it received from a neighbor. If an LSA
fails to be acknowledged, the router directly retransmits the LSA to the
neighbor.
● Link State Acknowledgement (LSAck) packet
A router uses an LSAck packet to acknowledge the LSAs contained in a
received LSU packet. The LSAs can be acknowledged using LSA headers.
5.2.1.4 OSPF Network Types
OSPF classifies networks into four types, depending on the link layer protocols:
● Broadcast
OSPF defaults networks using Ethernet or Fiber Distributed Data Interface
(FDDI) at the link layer to broadcast networks.
On broadcast networks:
– Hello packets, LSU packets, and LSAck packets are sent in multicast
mode. The address 224.0.0.5 is the IP multicast address reserved for OSPF
DR others. The address 224.0.0.6 is the IP multicast address reserved for
OSPF DRs or BDRs.
– DD and LSR packets are sent in unicast mode.
● Non-Broadcast Multi-Access (NBMA)
OSPF defaults networks using frame relay (FR) or X.25 at the link layer to
NBMA networks.
On NBMA networks, protocol packets such as Hello packets, DD packets, LSR
packets, LSU packets, and LSAck packets are all sent in unicast mode.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 171
● Point-to-Multipoint (P2MP)
OSPF does not default a network to a P2MP network regardless of the link
layer protocol used by the network. A P2MP network must be changed from
another network type. It is a typical practice to change partial-meshed NBMA
networks to P2MP networks.
On P2MP networks:
– Hello packets are transmitted in multicast mode using the multicast
address 224.0.0.5.
– DD packets, LSR packets, LSU packets, and LSAck packets are sent in
unicast mode.
● Point-to-Point (P2P)
OSPF defaults networks using Point-to-Point Protocol (PPP), High-Level Data
Link Control (HDLC), or Link Access Procedure Balanced (LAPB) at the link
layer to P2P networks.
On P2P networks, protocol packets such as Hello packets, DD packets, LSR
packets, LSU packets, and LSAck packets are all sent in multicast mode using
the multicast address 224.0.0.5.
5.2.1.5 DR/BDR Election
Router ID
During DR/BDR election, if two routers use the same DR priority, they need to
compare their router IDs, and the router with a larger router ID will become the
DR or BDR.
A router ID is a 32-bit integer used to uniquely identify an OSPF router in an AS.
Each OSPF router has a router ID, which is in the same format as an IP address.
An OSPF router ID can be manually configured or automatically selected. To
ensure OSPF stability, you are advised to manually configure the IP address of a
loopback interface as the router ID.
If no OSPF router ID is manually configured for a router, the router selects the
global router ID as its OSPF router ID. If both the OSPF router ID and global router
ID are not configured, the router selects a router ID based on specified rules. For
details, see 1.2.13 Router ID.
In any of the following situations, the router ID is re-selected:
● The ospf router-id
router-id command is run to reconfigure the OSPF router
ID, and the OSPF process is restarted.
● The global router ID is reconfigured, and the OSPF process is restarted.
● The IP address used as the original global router ID is deleted, and the OSPF
process is restarted.
Reason for DR/BDR Election
On broadcast and NBMA networks, any two routers need to exchange routing
information. As shown in Figure 5-8, there are
n routers that need to establish
n x
(
n - 1)/2 adjacencies. A route change on any router is transmitted to the other
routers, which consumes bandwidth resources.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 172
To solve this problem, the concept of DR is defined in OSPF. After a DR is elected,
all the other routers send routing information only to the DR, and the DR
broadcasts LSAs.
To prevent service interruption caused by DR re-election if the DR fails, a BDR is
also elected during DR election. The routers, excluding the DR and BDR, are called
DR others. The DR others do not establish adjacencies or exchange any routing
information with each other. This reduces the number of adjacencies established
between routers on broadcast and NBMA networks.
Figure 5-8 DR/BDR election
DR/BDR Election Principles
To ensure stable DR/BDR election on broadcast and NBMA networks, OSPF defines
three election principles: election, non-preemption, and inheritance.
Election Principle
The DR and BDR are not designated manually, but are elected by all routers on
the local network segment. In Figure 5-9, DR priorities of router interfaces
determine whether the interfaces are qualified for DR/BDR election. Routers with
DR priorities greater than 0 on the local network segment can be considered as
candidates. The ballots in this election are performed using Hello packets. Each
router adds elected DR information to a Hello packet and sends the packet to
other routers on the network segment. When two routers on the same network
segment declare that they are the DR, the router with a higher DR priority is
elected as the DR. If the two routers have the same DR priority, the router with
the greater router ID is elected as the DR. The router whose DR priority is 0
cannot be elected as the DR or BDR.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 173
Figure 5-9 Election principle
Non-preemption Principle
A router newly added to a network segment does not initiate a new election.
Instead, it checks whether a DR exists on the network segment. In Figure 5-10, a
DR exists on the network segment. Even if the DR priority of the newly added
router is higher than that of the existing DR, the newly added router does not
declare itself the DR, and acknowledges the existing DR. Routers on a network
segment establish adjacencies only with the DR and BDR. If the DR changes
frequently, all routers on the network segment need to establish adjacencies with
the new DR and BDR accordingly. As a result, a large number of OSPF packets are
transmitted on the network segment within a short period of time, consuming
bandwidth resources. The non-preemption principle improves network stability
and conserves bandwidth resources. On a broadcast or NBMA network, the two
routers that are qualified for DR election and start first become the DR and BDR
respectively.
Figure 5-10 Non-preemption principle
Inheritance Principle
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 174
If the DR on a network segment fails, the BDR is elected as the DR, and the other
routers compete to become the new BDR, as shown in Figure 5-11. This principle
prevents frequent DR elections and enables the BDR to become the new DR when
the DR fails, ensuring the DR stability. Because LSDBs of the DR and BDR are fully
synchronized, the BDR can immediately become the new DR when the DR fails,
providing the DR functions. The time consumed from role change to service
switching is short because adjacencies have been established. Meanwhile, a new
BDR will be elected after the original BDR becomes the DR. The new BDR election
process consumes a relatively long time, but route calculation is not affected.
Figure 5-11 Inheritance principle
DR/BDR Election Process
The DR/BDR election process on a broadcast or NBMA network is as follows:
1. After an interface goes Up, it sends a Hello packet and enters the Waiting
state. In Waiting state, a wait timer is triggered. The wait timer value is the
same as the dead timer value. The default wait timer value is 40 seconds and
cannot be changed. For details about OSPF interface status, see OSPF
Interface State Machine.
2. Before the wait timer is triggered, sent Hello packets do not contain DR or
BDR information. In Waiting state, if a received Hello packet contains DR and
BDR information, the interface directly acknowledges the DR and BDR on the
network, and does not trigger election. The interface directly exits the Waiting
state and starts neighbor synchronization.
3. Assume that a DR and a BDR exist on the network. A router newly connected
to the network acknowledges the existing DR and BDR regardless of its router
ID or DR priority.
4. If the DR fails and goes Down, the BDR takes over the role of the DR. The
other routers with DR priorities greater than 0 then compete to become the
new BDR.
5. DR election rules are used to elect a DR only when routers with different
router IDs or DR priorities are started at the same time. The election rules
state that the device with the highest DR priority is elected as the DR and the
device with the second highest DR priority as the BDR. A router with a DR
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 175
priority of 0 can only be a DR other. If routers have the same DR priority, the
router with the largest router ID is elected as the DR, the router with the
second largest router ID becomes the BDR, and other routers are DR others.
Verifying the DR/BDR Election Process
In Figure 5-12, five routers establish a broadcast network. R5 works as a Layer 2
device, and R1 to R4 work as routers. R1 to R4 are in OSPF area 0.
Figure 5-12 DR/BDR election networking
DR and BDR Are Properly Elected on the Network
Assume that interfaces on R1 to R4 have been configured. Only OSPF
configurations are provided here.
● R1 configuration
#
ospf 1 Router ID 10.1.1.1
area 0.0.0.0
network 192.168.1.0 0.0.0.255
#
● R2 configuration
#
ospf 1 Router ID 10.2.2.2
area 0.0.0.0
network 192.168.1.0 0.0.0.255
#
● R3 configuration
#
ospf 1 Router ID 10.3.3.3
area 0.0.0.0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 176
network 192.168.1.0 0.0.0.255
#
● R4 configuration
#
ospf 1 Router ID 10.4.4.4
area 0.0.0.0
network 192.168.1.0 0.0.0.255
#
After the configurations are complete and the network is stable, check the
DR/BDR election status.
# Check OSPF neighbor information on R1. The following command output shows
that DR/BDR election has been completed. R1 is the DR, R2 is the BDR, and R3
and R4 are DR others. R1 and R2 are elected as the DR and BDR respectively
because of their startup sequence. In this example, R1, R2, R3, and R4 are started
consecutively. Therefore, R1 and R2 complete initialization first and become the
DR and BDR, respectively.
<R1> display ospf peer
OSPF Process 1 with Router ID 10.1.1.1
Neighbors
Area 0.0.0.0 interface 192.168.1.1(GigabitEthernet0/0/1)'s neighbors
Router ID: 10.2.2.2 Address: 192.168.1.2
State: Full Mode:Nbr is Master Priority: 1
DR: 192.168.1.1 BDR: 192.168.1.2 MTU: 0
Dead timer due in 38 sec
Retrans timer interval: 5
Neighbor is up for 00:22:16
Authentication Sequence: [ 0 ]
Router ID: 10.3.3.3 Address: 192.168.1.3
State: Full Mode:Nbr is Master Priority: 1
DR: 192.168.1.1 BDR: 192.168.1.2 MTU: 0
Dead timer due in 35 sec
Retrans timer interval: 5
Neighbor is up for 00:21:30
Authentication Sequence: [ 0 ]
Router ID: 10.4.4.4 Address: 192.168.1.4
State: Full Mode:Nbr is Master Priority: 1
DR: 192.168.1.1 BDR: 192.168.1.2 MTU: 0
Dead timer due in 33 sec
Retrans timer interval: 5
Neighbor is up for 00:20:24
Authentication Sequence: [ 0 ]
# Check brief OSPF neighbor information on R1, R2, R3, and R4. The following
command output shows that the neighbor relationships between R1 and the other
three routers and those between R2 and the other three routers are in Full state,
and the neighbor relationship between R3 and R4 is in 2-Way state. The states
indicate that the DR and BDR establish adjacencies with other routers, and DR
others only establish neighbor relationships with each other. For details about
OSPF neighbor status, see OSPF Neighbor State Machine.
<R1> display ospf 1 peer brief
OSPF Process 1 with Router ID 10.1.1.1
Peer Statistic Information
----------------------------------------------------------------------------
Area Id Interface Neighbor id State
0.0.0.0 GigabitEthernet0/0/1 10.2.2.2 Full
0.0.0.0 GigabitEthernet0/0/1 10.3.3.3 Full
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 177
0.0.0.0 GigabitEthernet0/0/1 10.4.4.4 Full
----------------------------------------------------------------------------
Total Peer(s): 3
<R2> display ospf 1 peer brief
OSPF Process 1 with Router ID 10.2.2.2
Peer Statistic Information
----------------------------------------------------------------------------
Area Id Interface Neighbor id State
0.0.0.0 GigabitEthernet0/0/1 10.1.1.1 Full
0.0.0.0 GigabitEthernet0/0/1 10.3.3.3 Full
0.0.0.0 GigabitEthernet0/0/1 10.4.4.4 Full
----------------------------------------------------------------------------
Total Peer(s): 3
<R3> display ospf 1 peer brief
OSPF Process 1 with Router ID 10.3.3.3
Peer Statistic Information
----------------------------------------------------------------------------
Area Id Interface Neighbor id State
0.0.0.0 GigabitEthernet0/0/1 10.1.1.1 Full
0.0.0.0 GigabitEthernet0/0/1 10.2.2.2 Full
0.0.0.0 GigabitEthernet0/0/1 10.4.4.4 2-Way
----------------------------------------------------------------------------
Total Peer(s): 3
<R4> display ospf 1 peer brief
OSPF Process 1 with Router ID 10.4.4.4
Peer Statistic Information
----------------------------------------------------------------------------
Area Id Interface Neighbor id State
0.0.0.0 GigabitEthernet0/0/1 10.1.1.1 Full
0.0.0.0 GigabitEthernet0/0/1 10.2.2.2 Full
0.0.0.0 GigabitEthernet0/0/1 10.3.3.3 2-Way
----------------------------------------------------------------------------
Total Peer(s): 3
BDR Cannot Be Elected on the Network
If the ospf dr-priority command is run on GE0/0/1 of R2, R3, and R4 to set the
interface DR priority to 0, the three routers are unqualified for DR/BDR election
and can only work as DR others. Only one router (R1) on the network is qualified
for DR/BDR election.
# Check OSPF neighbor information on R1. The following command output shows
that R1 is the DR. The BDR field is displayed as None, indicating that no BDR
exists on the network.
<R1> display ospf peer
OSPF Process 1 with Router ID 10.1.1.1
Neighbors
Area 0.0.0.0 interface 192.168.1.1(GigabitEthernet0/0/1)'s neighbors
Router ID: 10.2.2.2 Address: 192.168.1.2
State: Full Mode:Nbr is Master Priority: 0
DR: 192.168.1.1 BDR: None MTU: 0
Dead timer due in 38 sec
Retrans timer interval: 5
Neighbor is up for 00:04:31
Authentication Sequence: [ 0 ]
Router ID: 10.3.3.3 Address: 192.168.1.3
State: Full Mode:Nbr is Master Priority: 0
DR: 192.168.1.1 BDR: None MTU: 0
Dead timer due in 35 sec
Retrans timer interval: 5
Neighbor is up for 00:03:45
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 178
Authentication Sequence: [ 0 ]
Router ID: 10.4.4.4 Address: 192.168.1.4
State: Full Mode:Nbr is Master Priority: 0
DR: 192.168.1.1 BDR: None MTU: 0
Dead timer due in 33 sec
Retrans timer interval: 5
Neighbor is up for 00:03:36
Authentication Sequence: [ 0 ]
# Check brief OSPF neighbor information on R1, R2, R3, and R4. The following
command output shows that R2, R3, and R4 each establish an adjacency with R1,
the corresponding states are Full, and the states of neighbor relationships among
R2, R3, and R4 are 2-Way.
<R1> display ospf 1 peer brief
OSPF Process 1 with Router ID 10.1.1.1
Peer Statistic Information
----------------------------------------------------------------------------
Area Id Interface Neighbor id State
0.0.0.0 GigabitEthernet0/0/1 10.2.2.2 Full
0.0.0.0 GigabitEthernet0/0/1 10.3.3.3 Full
0.0.0.0 GigabitEthernet0/0/1 10.4.4.4 Full
----------------------------------------------------------------------------
Total Peer(s): 3
<R2> display ospf 1 peer brief
OSPF Process 1 with Router ID 10.2.2.2
Peer Statistic Information
----------------------------------------------------------------------------
Area Id Interface Neighbor id State
0.0.0.0 GigabitEthernet0/0/1 10.1.1.1 Full
0.0.0.0 GigabitEthernet0/0/1 10.3.3.3 2-Way
0.0.0.0 GigabitEthernet0/0/1 10.4.4.4 2-Way
----------------------------------------------------------------------------
Total Peer(s): 3
<R3> display ospf 1 peer brief
OSPF Process 1 with Router ID 10.3.3.3
Peer Statistic Information
----------------------------------------------------------------------------
Area Id Interface Neighbor id State
0.0.0.0 GigabitEthernet0/0/1 10.1.1.1 Full
0.0.0.0 GigabitEthernet0/0/1 10.2.2.2 2-Way
0.0.0.0 GigabitEthernet0/0/1 10.4.4.4 2-Way
----------------------------------------------------------------------------
Total Peer(s): 3
<R4> display ospf 1 peer brief
OSPF Process 1 with Router ID 10.4.4.4
Peer Statistic Information
----------------------------------------------------------------------------
Area Id Interface Neighbor id State
0.0.0.0 GigabitEthernet0/0/1 10.1.1.1 Full
0.0.0.0 GigabitEthernet0/0/1 10.2.2.2 2-Way
0.0.0.0 GigabitEthernet0/0/1 10.3.3.3 2-Way
----------------------------------------------------------------------------
Total Peer(s): 3
In conclusion, if only one router on a broadcast or NBMA network is qualified for
DR/BDR election, the router becomes the DR, no BDR exists on the network, and
all the other routers establish adjacencies only with the DR.
No DR or BDR Can Be Elected on the Network
On the basis of the preceding configuration, if the ospf dr-priority command is
executed on GE0/0/1 of R1 to set the interface DR priority to 0, R1 is also
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 179
unqualified for DR/BDR election. No router on the network is qualified for DR/BDR
election.
# Check OSPF neighbor information on R1. The following command output shows
that both the DR and BDR fields are displayed as None, indicating that no DR or
BDR exists on the network.
<R1> display ospf peer
OSPF Process 1 with Router ID 10.1.1.1
Neighbors
Area 0.0.0.0 interface 192.168.1.1(GigabitEthernet0/0/1)'s neighbors
Router ID: 10.2.2.2 Address: 192.168.1.2
State: Full Mode:Nbr is Master Priority: 0
DR: None BDR: None MTU: 0
Dead timer due in 38 sec
Retrans timer interval: 5
Neighbor is up for 00:00:00
Authentication Sequence: [ 0 ]
Router ID: 10.3.3.3 Address: 192.168.1.3
State: Full Mode:Nbr is Master Priority: 0
DR: None BDR: None MTU: 0
Dead timer due in 35 sec
Retrans timer interval: 5
Neighbor is up for 00:00:00
Authentication Sequence: [ 0 ]
Router ID: 10.4.4.4 Address: 192.168.1.4
State: Full Mode:Nbr is Master Priority: 0
DR: None BDR: None MTU: 0
Dead timer due in 33 sec
Retrans timer interval: 5
Neighbor is up for 00:00:00
Authentication Sequence: [ 0 ]
# Check brief OSPF neighbor information on R1, R2, R3, and R4. The following
command output shows that all neighbor relationships are in 2-Way state, no
adjacency can be established on the network, and routers cannot exchange
routing information.
<R1> display ospf 1 peer brief
OSPF Process 1 with Router ID 10.1.1.1
Peer Statistic Information
----------------------------------------------------------------------------
Area Id Interface Neighbor id State
0.0.0.0 GigabitEthernet0/0/1 10.2.2.2 2-Way
0.0.0.0 GigabitEthernet0/0/1 10.3.3.3 2-Way
0.0.0.0 GigabitEthernet0/0/1 10.4.4.4 2-Way
----------------------------------------------------------------------------
Total Peer(s): 3
<R2> display ospf 1 peer brief
OSPF Process 1 with Router ID 10.2.2.2
Peer Statistic Information
----------------------------------------------------------------------------
Area Id Interface Neighbor id State
0.0.0.0 GigabitEthernet0/0/1 10.1.1.1 2-Way
0.0.0.0 GigabitEthernet0/0/1 10.3.3.3 2-Way
0.0.0.0 GigabitEthernet0/0/1 10.4.4.4 2-Way
----------------------------------------------------------------------------
Total Peer(s): 3
<R3> display ospf 1 peer brief
OSPF Process 1 with Router ID 10.3.3.3
Peer Statistic Information
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 180
----------------------------------------------------------------------------
Area Id Interface Neighbor id State
0.0.0.0 GigabitEthernet0/0/1 10.1.1.1 2-Way
0.0.0.0 GigabitEthernet0/0/1 10.2.2.2 2-Way
0.0.0.0 GigabitEthernet0/0/1 10.4.4.4 2-Way
----------------------------------------------------------------------------
Total Peer(s): 3
<R4> display ospf 1 peer brief
OSPF Process 1 with Router ID 10.4.4.4
Peer Statistic Information
----------------------------------------------------------------------------
Area Id Interface Neighbor id State
0.0.0.0 GigabitEthernet0/0/1 10.1.1.1 2-Way
0.0.0.0 GigabitEthernet0/0/1 10.2.2.2 2-Way
0.0.0.0 GigabitEthernet0/0/1 10.3.3.3 2-Way
----------------------------------------------------------------------------
Total Peer(s): 3
In conclusion, if no router on a broadcast or NBMA network is qualified for
DR/BDR election, the network has no DR or BDR, and routers on the network do
not establish adjacencies. In this case, all neighbor relationships among these
routers are in 2-Way state.
5.2.1.6 OSPF State Machine
OSPF Interface State Machine
An OSPF device obtains link information from an interface and then establishes
adjacencies with neighbors to exchange the link information. Before establishing
adjacencies, these devices need to determine their roles to establish connections.
The State field in OSPF interface information (displayed using the display ospf
interface command) indicates the function of an OSPF device on a link.
The OSPF interface state machine has the following states:
● Down: This state is the initial state of an OSPF interface. If an OSPF interface
is Down, it is unavailable and cannot receive or transmit traffic.
● Loopback: An OSPF interface that connects a device to a network is in
Loopback state. A loopback interface cannot transmit data but its IP address
can be advertised using Router-LSAs. Therefore, other devices can learn about
paths to this IP address during a connectivity test.
● Waiting: The device is determining the DR and BDR on the network. Before
the device participates in DR and BDR election, the wait timer starts on an
OSPF interface. Before this timer expires, the Hello packets sent by this device
do not contain DR and BDR information, and the device cannot be elected as
the DR or BDR. This prevents the existing DR and BDR on the link from being
changed unnecessarily and ensures stability. This state exists only on NBMA
and broadcast networks.
● P-2-P: An OSPF interface is connected to a P2P network or virtual link. In this
situation, the device establishes an adjacency with the device on the other
end of the link. This state exists only on P2MP networks.
● DROther: The device is not elected as the DR or BDR. This device will
establish an adjacency with the DR and BDR.
● BDR: The device functions as the BDR on the network and will become the
new DR if the existing DR fails. This device establishes adjacencies with all the
other devices on the network.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 181
● DR: The device functions as the DR on the network. This device establishes
adjacencies with all the other devices on the network.
OSPF interfaces alternate among the preceding states based on the InputEvents
(IEs), forming an efficient interface state machine, as shown in Figure 5-13.
Figure 5-13 OSPF interface state machine
Table 5-2 lists the IEs triggering interface state switchovers.
Table 5-2 InputEvents triggering OSPF interface state switchovers
InputEvent Description
IE1 InterfaceUP: Lower-layer protocols indicate that an OSPF interface
is available.
IE2 WaitTimer: The wait timer expires, indicating that the DR/BDR
election waiting time ends.
IE3 BackupSeen: The device with an OSPF interface has detected
whether there is a BDR on the network. This event occurs in either
of the following situations:
● The OSPF interface receives a Hello packet from a neighbor,
and the neighbor declares itself the BDR.
● The OSPF interface receives a Hello packet from a neighbor,
and the neighbor declares itself the DR but no BDR is specified.
Both situations indicate that neighbors have communicated with
each other and the Waiting state ends.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 182
InputEvent Description
IE4 The device is elected as the DR on the network.
IE5 The device is elected as the BDR on the network.
IE6 The device is not elected as the DR or BDR on the network.
IE7 NeighborChange: An interface-related neighbor relationship
change event occurs, indicating that the DR and BDR need to be
elected again. The following neighbor relationship changes may
result in DR/BDR re-election:
● The device implements bidirectional communication with a
neighbor.
● Bidirectional communication between the device and a
neighbor is interrupted.
● The device detects that the neighbor declares itself the DR or
BDR based on the Hello packet received by the neighbor.
● The device detects that the neighbor declares itself not the DR
or BDR based on the Hello packet sent by the neighbor.
● The device detects that the DR priorities of all neighbors have
changed based on the Hello packets sent by the neighbors.
IE8 UnLoopInd: The NMS or lower-layer protocols indicate that the
interface is not in Loopback state any longer.
IE9 InterfaceDown: Lower-layer protocols indicate that the interface is
unavailable. Any state may change to the Down state after this
event is triggered.
IE10 LoopInd: The NMS or lower-layer protocols indicate that the
interface is in Loopback state. Any state may change to the
Loopback state after this event is triggered.
OSPF Neighbor State Machine
On an OSPF network, neighbors establish adjacencies through neighbor state
switchovers, and then exchange LSAs.
The State field in OSPF neighbor information (displayed using the display ospf
peer command) indicates the neighbor status of an OSPF device.
The OSPF neighbor state machine has the following states:
● Down: This is the initial state of a neighbor session. This state occurs when a
device does not receive any Hello packets from its neighbors within a dead
interval. Only OSPF routers on an NBMA network send Hello packets to
neighbors at each poll interval, including the neighbors in Down state.
● Attempt: This state is only used on NBMA networks where neighbors are
manually configured. When the neighbor relationship is in Attempt state, an
OSPF router sends a Hello packet to its manually configured neighbors at
each Hello interval, attempting to establish neighbor relationships.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 183
● Init: This state occurs after the router has received a Hello packet from its
neighbor but has not established a two-way session. In Init state, the
neighbor does not receive any Hello packet from this router, and the neighbor
list in the received Hello packet does not contain the router ID of the local
router.
● 2-Way: This state occurs when a router and its neighbor receive Hello packets
containing their own router IDs from each other and establish an OSPF
neighbor relationship. If no adjacency needs to be established, the two
neighbors remain in 2-Way state. If an adjacency needs to be established, the
neighbor enters the Exstart state. The DR and BDR are elected only when the
neighbor state is 2-Way or higher.
● ExStart: This state occurs when two neighbors start to negotiate their master/
slave roles and determine the sequence numbers of DD packets. Entering the
Exstart state is the first step in setting up an adjacency.
● Exchange: This state occurs when two neighbors exchange DD packets. In this
state, DD packets contain LSDB information.
● Loading: This state occurs when two neighbors are synchronizing their LSDBs.
The two devices send LSR packets to request LSAs from each other to
synchronize their LSDBs.
● Full: This state occurs when two neighbors complete their LSDB
synchronization and establish an adjacency.
Figure 5-14 shows an OSPF neighbor state machine.
Figure 5-14 OSPF neighbor state machine
Table 5-3 lists the IEs triggering neighbor state switchovers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 184
Table 5-3 InputEvents triggering OSPF neighbor state switchovers
InputEvent Description
IE1 Start: A router sends a Hello packet to its neighbors at each Hello
interval, attempting to establish neighbor relationships. This event
exists only on NBMA networks.
IE2 HelloReceived: The router receives a Hello packet from a neighbor.
IE3 2-WayReceived: The router receives a Hello packet containing its
router ID from a neighbor and implements two-way
communication with this neighbor. The router then determines its
neighbor state:
● IE3(Y): If the router needs to establish an adjacency with the
neighbor, it changes its neighbor state to Exstart.
● IE3(N): If the router does not need to establish an adjacency
with the neighbor, it changes its neighbor state to 2-Way.
IE4 NegotiationDone: The two neighbors have negotiated their
master/slave roles and exchanged sequence numbers of DD
packets.
IE5 ExchangeDone: The two neighbors have exchanged their DD
packets. One of the two routers then determines its neighbor
state:
● IE5(Y): If the link state request list is empty, the router changes
its neighbor state to Full, indicating that all link state data has
been exchanged and an adjacency has been established.
● IE5(N): If the link state request list is not empty, the router
changes its neighbor state to Loading and begins or continues
sending LSR packets to its neighbor, requesting link state data
that the local router does not have.
IE6 LoadingDone: The link state request list is empty.
5.2.1.7 OSPF Adjacency Establishment
OSPF Neighbor Relationship
OSPF routers periodically send Hello packets on every OSPF-enabled interface, and
negotiate the specific parameters, including the area ID, authentication method,
Hello packet interval, and dead interval, in the Hello packets with other routers
that receive Hello packets. If the negotiation succeeds, the receiving router adds
the router ID of the originating router to the neighbor list of the returned Hello
packet. The two routers then establish bidirectional communication and an OSPF
neighbor relationship. If a router does not receive a Hello packet from its neighbor
within the dead interval, the router terminates the neighbor relationship with this
neighbor.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 185
OSPF Adjacency
After establishing an OSPF neighbor relationship, two neighbors need to exchange
DD packets and LSAs to establish an adjacency.
Not all neighbors establish adjacencies. Whether neighbors establish adjacencies
depends on the network type and DR/BDR establishment. On P2P and P2MP links,
all devices need to exchange LSAs and establish only adjacencies. On broadcast
and NBMA links, DR others do not need to exchange LSAs and establish only
neighbor relationships. LSAs need to be exchanged between the DR and BDR, and
between the DR, BDR, and DR others, so they establish adjacencies with each
other. In Figure 5-15, two DR others each have established three neighbor
relationships and two adjacencies.
Figure 5-15 OSPF neighbor relationship and adjacency
A neighbor relationship indicates that two neighbors reach the 2-Way state,
whereas an adjacency indicates that two neighbors reach the Exstart state or
higher.
OSPF Adjacency Establishment
The process of establishing an OSPF adjacency varies depending on the network
type.
Broadcast Network
On a broadcast network, the DR and BDR establish an adjacency with each router
on the same network segment, but DR others establish only neighbor
relationships with each other. Figure 5-16 shows the process of establishing an
OSPF adjacency.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 186
Figure 5-16 Process of establishing an OSPF adjacency on a broadcast network
1. Neighbor relationship establishment
a. RouterA uses the multicast address 224.0.0.5 to send a Hello packet
through the OSPF interface connected to a broadcast network. The
packet carries the DR field of 1.1.1.1 (ID of RouterA) and the Neighbors
Seen field of 0, indicating that a neighbor RouterB has not been
discovered and RouterA regards itself as the DR.
b. After RouterB receives the packet, it returns a Hello packet to RouterA.
The returned packet carries the DR field of 2.2.2.2 (ID of Router B) and
the Neighbors Seen field of 1.1.1.1 (RouterA's router ID). RouterA has
been discovered but its router ID is less than that of RouterB, and
therefore RouterB regards itself as the DR. Then RouterB's neighbor state
changes to Init.
c. After RouterA receives the response, RouterA's neighbor state changes to
2-Way. Then, RouterA and RouterB start to send their LSDB information
to each other, which does not occur between DR others on a broadcast
network.
2. Master/Slave negotiation and DD packet exchange
a. RouterA sends a DD packet to RouterB. The packet carries the following
fields:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 187
▪ Seq: The value X indicates the sequence number of X.
▪ I: The value 1 indicates that the packet is the first DD packet, which
is used to negotiate the master/slave roles and does not carry LSA
summaries.
▪ M: The value 1 indicates that the packet is not the last DD packet.
▪ MS: The value 1 indicates that RouterA declares itself the master.
To improve transmission efficiency, RouterA and RouterB determine which
LSAs in each other's LSDB need to be updated before sending LSR
packets. If one party detects that an LSA of the other party is already in
its own LSDB, it does not send an LSR packet for updating the LSA to its
own LSDB. To achieve the preceding purpose, RouterA and RouterB first
send DD packets, which carry summaries of LSAs in their own LSDBs.
Each summary identifies an LSA. To ensure reliable packet transmission,
the master/slave roles must be determined through DD packet exchange.
The party serving as the master uses the Seq field to define a sequence
number. The master increases the sequence number by 1 each time it
sends a new DD packet. When the other party serving as the slave sends
a DD packet, it sets the Seq field of the packet to the sequence number
carried in the last DD packet received from the master.
b. After RouterB receives the DD packet, RouterB's state changes to Exstart
and RouterB returns a DD packet to RouterA. The returned packet does
not carry LSA summaries. Because RouterB has a larger router ID than
RouterA, RouterB declares itself the master and sets the Seq field to Y.
c. After RouterA receives the DD packet, it agrees that RouterB is the
master and RouterA's state changes to Exchange. Then, RouterA sends a
DD packet to RouterB to transmit LSA summaries. The packet carries the
Seq field of Y and the MS field of 0 indicating that RouterA declares itself
the slave.
d. After RouterB receives the packet, RouterB's state changes to Exchange
and RouterB sends a new DD packet containing its own LSA summaries
to RouterA. The value of the Seq field carried in the new DD packet is
changed to Y+1. RouterA uses the same sequence number as RouterB to
acknowledge that it has received DD packets from RouterB. RouterB uses
the sequence number from RouterA plus 1 to acknowledge that it has
received DD packets from RouterA. When RouterB sends the last DD
packet, it sets the M field in the packet to 0.
3. LSDB synchronization (LSA request, LSA transmission, and LSA response)
a. After RouterA receives the last DD packet, it finds that many LSAs in
RouterB's LSDB do not exist in its own LSDB. Therefore, RouterA's
neighbor state changes to Loading. After RouterB receives the last DD
packet from RouterA, RouterB's neighbor state directly changes to Full
because RouterB's LSDB already contains all LSAs of RouterA.
b. RouterA sends an LSR packet for updating LSAs from RouterB to its own
LSDB. RouterB sends an LSU to After RouterA.
The preceding procedure ends when the LSAs in RouterA's LSDB are the same
as those in RouterB's LSDB. RouterA's neighbor state then changes to Full.
After RouterA and RouterB exchange DD packets and update all LSAs, an
adjacency is established between them.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 188
NBMA Network
On an NBMA network, all routers establish adjacencies only with the DR and BDR.
Figure 5-17 shows the process of establishing an OSPF adjacency.
Figure 5-17 Process of establishing an OSPF adjacency on an NBMA network
1. Neighbor relationship establishment
a. After RouterB sends a Hello packet to a Down interface of RouterA,
RouterB's neighbor state changes to Attempt. The packet carries the DR
field of 2.2.2.2 (ID of RouterB) and the Neighbors Seen field of 0. A
neighbor RouterA has not been discovered, and RouterB regards itself as
the DR.
b. After RouterA receives the packet, RouterA's state changes to Init and
RouterA returns a Hello packet. The returned packet carries the DR and
Neighbors Seen fields of 2.2.2.2. RouterB has been discovered but its
router ID is greater than that of RouterA, and therefore RouterA agrees
that RouterB is the DR. Then, RouterA and RouterB start to exchange DD
packets and LSDB information with each other, which does not occur
between DR others on a broadcast network.
2. The processes of negotiating master/slave roles and exchanging DD packets
on an NBMA network are the same as those on a broadcast network.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 189
3. The process of synchronizing LSDBs (LSA request, LSA transmission, and LSA
response) on an NBMA network is the same as that on a broadcast network.
P2P Network and P2MP Network
The process for establishing an adjacency on a P2P/P2MP network is similar to
that on a broadcast network except that no DR or BDR needs to be elected on a
P2P/P2MP network. DD packets are transmitted in multicast mode on P2P
networks and in unicast mode on P2MP networks.
5.2.1.8 OSPF Areas
When networks expand and all routers in a large network are running OSPF, the
following problems may occur:
● Network expansion increases the possibility of network topology changes,
leading to more frequent LSA flooding and reducing network bandwidth
efficiency.
● LSDBs of routers become large, requiring a large amount of storage space
and complicating SPF calculations.
● Routers need to maintain large routing tables.
OSPF resolves these problems by partitioning an AS into different areas. Area
partitioning contains LSA flooding within an area, improving network efficiency
and route convergence. The number of routers in each area becomes less,
reducing the size of routing tables and LSDBs maintained by routers and limiting
SPF calculations to LSAs within the area. Design of multiple areas also improves
network scalability and facilitates the setup of large networks.
An area is regarded as a logical group of routers and is identified by an area ID. A
router, not a link, resides on the border of an area. Each OSPF interface must
belong to an area, meaning that a link (or network segment) belongs to only one
area.
Before understanding OSPF areas, you need to get to know two concepts: router
type and route type.
Router Types
Figure 5-18 shows common router types involved in OSPF.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 190
Figure 5-18 Router types
Table 5-4 Router types
Router Type Description
Internal router A router that has all of its interfaces within the
same OSPF area.
Area Border Router (ABR) A router that has interfaces in two or more areas,
one of which must be a backbone area.
ABRs connect backbone and non-backbone areas
and can be physically or logically connected to a
backbone area.
Backbone router A router that has one or more interfaces within a
backbone area.
Internal routers in Area 0 and all ABRs are
backbone routers.
Autonomous System
Boundary Router (ASBR)
A router that exchanges routing information with
other ASs.
An ASBR is not required to reside on the border of
an AS. It may be an internal router or an ABR. An
OSPF device that imports external routing
information becomes an ASBR.
Route Types
Inter-area and intra-area routes in an AS describe the internal network structure
of the AS. AS external routes describe routes to destinations outside the AS. OSPF
classifies imported AS external routes into Type 1 and Type 2.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 191
Table 5-5 lists route types in descending order of priority.
Table 5-5 Route types
Route Type Description
Intra-area route Routes that are generated from within an area (the
destination belongs to the area).
Inter-area route Routes that originate from other areas.
External route Routes that are imported into OSPF from other
routing protocols or different OSPF processes.
External routes fall into two categories: Type 1 and
Type 2 external routes. The difference between the
two types is the way the cost of a route is
calculated.
● Type 1 external route: The cost of a Type 1
external route is the addition of the external cost
(from the local device to an ASBR) and the
internal cost (from the ASBR to the destination)
used to reach that route.
● Type 2 external route: The cost of a Type 2
external route is always the external cost (from
an ASBR to the destination), irrespective of the
internal cost to reach that route.
A Type 1 external route is always preferred over a
Type 2 external route for the same destination.
Area Types
OSPF areas include common areas, stub areas, and not-so-stubby areas (NSSAs),
as shown in Table 5-6.
Table 5-6 Area types
Area
Type
Function Description
Common
area
By default, OSPF areas are common areas
that include:
● Standard area: transmits intra-area,
inter-area, and external routes.
● Backbone area: connects to all other
OSPF areas and transmits inter-area
routes. The backbone area is
represented by area 0. Routes between
non-backbone areas must be
forwarded through the backbone area.
● The backbone area
must have all its
devices connected.
● All non-backbone
areas must have
themselves
connected to the
backbone area.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 192
Area
Type
Function Description
Stub area A stub area is a special area where an ABR
does not flood received AS external routes.
In a stub area, routers maintain fewer
routing entries and transmit less routing
information. Configuring a stub area is
optional and not every area can be
configured as such. A stub area is usually
a non-backbone area containing only one
ABR, located on the AS border. A stub area
is a non-backbone area containing only
one ABR and generally resides on the
border of an AS. The ABR in a stub area
does not transmit received AS external
routes, which significantly decreases the
routing table size on the ABR and the
amount of routing information
transmitted. To ensure the reachability of
AS external routes, the ABR generates a
default route and advertises the route to
non-ABRs in the stub area.
A totally stub area allows only intra-area
routes and ABR-advertised Type 3 LSAs
carrying a default route to be advertised
within the area.
● A backbone area
cannot be
configured as a stub
area.
● Stub area attributes
need to be
configured on all
the routers in the
area that needs to
be configured as a
stub area.
● An ASBR cannot
exist in a stub area.
Therefore, AS
external routes
cannot be
advertised within a
stub area.
● A virtual link cannot
pass through a stub
area.
NSSA An NSSA is similar to a stub area. An
NSSA does not advertise Type 5 LSAs, but
can import AS external routes. ASBRs in
an NSSA generate Type 7 LSAs to carry
the information about the AS external
routes. The Type 7 LSAs are advertised
only within the NSSA. When the Type 7
LSAs reach an ABR in the NSSA, the ABR
translates the Type 7 LSAs into Type 5
LSAs and floods them to the entire AS.
A totally NSSA allows only intra-area
routes to be advertised within the area.
● A backbone area
cannot be
configured as an
NSSA.
● NSSA attributes
need to be
configured on all
the routers in the
area that needs to
be configured as an
NSSA.
● An ABR in an NSSA
advertises default
routes in Type 7
LSAs within the
NSSA.
● All inter-area routes
are advertised by
ABRs.
● A virtual link cannot
pass through an
NSSA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 193
After an OSPF network is partitioned into multiple areas, only LSAs within an area
are used in SPF calculations of this area. For example, in Figure 5-19, the link in
Area 1 is always flapping, and therefore SPF calculations are frequently performed
in Area 1. However, frequent SPF calculations occur only in Area 1 without
affecting other areas, improving network stability.
Figure 5-19 Area partitioning reducing the impact of link flapping
Stub area and totally stub area
In Figure 5-20, an AS is partitioned into Area 0 and Area 2, and external routes
are imported by the ASBR in Area 0. Typically, all routes on the network are
advertised into OSPF to ensure network reachability. In this situation, network
expansion will increase the number of devices and routing entries on each device
and require a large amount of CPU and memory resources to maintain these
entries. In some edge areas, low-performance devices may be deployed, and
therefore maintaining a large number of routing entries brings heavy load on
these devices.
Figure 5-20 Stub area and totally stub area
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 194
To optimize network performance, you often need to minimize the routing table
size to reduce the number of LSAs to be flooded without compromising network
reachability. If Area 2 is a common area, five types of LSAs, Type 1, Type 2, Type 3,
Type 4, and Type 5, may exist in this area. Traffic from routers in Area 2 must first
reach the ABR, regardless of the traffic destination outside Area 2. Therefore, non-
ABR routers in Area 2 do not need to know detailed information about external
networks. To meet this requirement, Area 2 is designed as a stub area.
Routers in Area 2 do not need to know inter-area specific routes and only one
egress is required to transmit traffic of these routers outside Area 2. To meet this
requirement, a totally stub area is designed. In a totally stub area, AS external
routes and inter-area routes cannot be advertised, reducing the number of LSAs
transmitted within this area.
NSSA and totally NSSA
In Figure 5-21, Area 2 is a stub area. An external network needs to connect to the
OSPF network through Area 2. That is, AS external routes need to be imported to
and advertised within the entire AS. One method is to enable RouterA in Area 2 to
import AS external routes into the AS. RouterA then becomes an ASBR, indicating
that Area 2 is no longer a stub area. To meet this requirement, an NSSA is
designed.
Figure 5-21 NSSA and totally NSSA
An NSSA differs from a stub area in that an NSSA allows importing AS external
routes into and advertising them within the entire AS without transmitting routes
learned from other areas in the AS.
To ensure the reachability of AS external routes, the ABR in an NSSA generates a
default route and advertises the route to the other routers in this NSSA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 195
Multiple ABRs may be deployed in an NSSA. To prevent routing loops caused by
default routes, ABRs do not calculate the default routes advertised by each other.
All routers in an area must have the same area type configured. A router uses the
N-bit carried in a Hello packet to specify the area type that it supports. If routers
have different area types, they cannot establish OSPF neighbor relationships.
Some vendors' devices do not comply with this requirement, and the N-bit is also
set in Database Description (DD) packets. You can manually set the N-bit on
switches to enable interworking with these vendors' devices.
Similar to a totally stub area, a totally NSSA is defined to further reduce the
number of LSAs transmitted within an NSSA.
Inter-Area Loop and Loop Prevention
OSPF runs an SPF algorithm within an area, which prevents routing loops within
the area. However, the distance-vector algorithm is used for inter-area route
transmission, which may easily cause routing loops.
To prevent inter-area loops, OSPF prohibits routing information from being
advertised directly between two non-backbone areas and allows advertising
routing information within a single area or between the backbone and non-
backbone areas. Therefore, each ABR must be connected to the backbone area.
If OSPF allows advertising routing information directly between non-backbone
areas, an inter-area loop may occur, as shown in Figure 5-22. The route from the
backbone area to the external network can be transmitted from Area 0 to Area 1.
If transmitting routing information directly between non-backbone areas is
allowed, this route can be transmitted back to Area 0, forming an inter-area
routing loop. To prevent this loop, OSPF allows exchanging routing information
only between the backbone and non-backbone areas. That is, OSPF prohibits
routing information from being exchanged directly between Area 1 and Area 3 or
directly between Area 2 and Area 3.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 196
Figure 5-22 OSPF inter-area loop
OSPF Default Route
A default route has an all–0 destination address and an all-0 mask. A device uses
a default route to forward packets when no matching route is discovered.
Hierarchical management of OSPF routes prioritizes the default route carried in
Type 3 LSAs over that carried in Type 5 or Type 7 LSAs.
An OSPF default route is used in the following scenarios:
● An ABR advertises a default route in Type 3 LSAs for instructing routers within
an area to forward packets between areas.
● An ASBR advertises a default route in Type 5 LSAs or Type 7 LSAs for
instructing routers in an AS to forward packets to other ASs.
Advertising an OSPF default route must follow these rules:
● An OSPF router in an area can advertise LSAs carrying a default route only
when the router has an interface connected to a device outside the area.
● If an OSPF router has advertised LSAs carrying a default route, the router no
longer learns the same-type LSAs carrying a default route advertised by other
routers. That is, the router uses only the LSAs advertised by itself to calculate
routes. The LSAs advertised by other routers are still recorded in the LSDB.
● If a router must use a route to advertise LSAs carrying an external default
route, the route cannot be a route learned by the local process. This is
because external default routes guide packet forwarding outside an AS,
whereas routes within an AS have the next hops pointing to the devices
within the AS.
Table 5-7 lists default route advertisement principles in different areas.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 197
Table 5-7 OSPF areas and default route advertisement
Area Type Function
Common area By default, devices in a common OSPF area do not
generate default routes.
When a default route on the network is generated by
another non-OSPF routing process, the device that
generates the default route must advertise it within the
entire OSPF AS. You can use commands to configure an
ASBR to generate a default route. After configuration, the
ASBR generates a Type 5 LSA carrying the default route
and then advertises the LSA within the entire OSPF AS.
Stub area A stub area does not allow AS external routes (carried in
Type 5 LSAs) to be transmitted within the area.
All routers within a stub area must learn AS external routes
from the ABR. The ABR automatically generates a
Summary LSA (Type 3 LSA) carrying a default route and
then advertises it within the entire stub area. This makes
all routes to destinations outside an AS learnable from the
ABR.
Totally stub area A totally stub area does not allow AS external routes
(carried in Type 5 LSAs) or inter-area routes (carried in
Type 3 LSAs) to be transmitted within the area.
All routers within the totally stub area must learn AS
external routes and inter-area routes from the ABR. The
ABR automatically generates a Summary LSA (Type 3 LSA)
carrying a default route and advertises it within the entire
totally stub area. This makes all routes to destinations
outside an AS and to destinations in other areas learnable
from the ABR.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 198
Area Type Function
NSSA An NSSA allows its ASBRs to import a small number of AS
external routes. The ASBRs do not advertise Type 5 LSAs
received from other areas within the NSSA. That is, AS
external routes can be learned only from ASBRs in the
NSSA.
Devices in an NSSA do not automatically generate default
routes.
Use either of the following methods to generate default
routes:
● Method 1: To advertise AS external routes through the
ASBR in the NSSA and advertise other external routes
through other areas, configure a Type 7 LSA carrying a
default route on the ABR and advertise this LSA within
the entire NSSA. In this manner, a small number of AS
external routes can be learned from the ASBR in the
NSSA, and other routes can be learned from the ABR in
the NSSA.
● Method 2: To advertise all external routes through the
ASBR in the NSSA, configure a Type 7 LSA carrying a
default route on the ASBR and advertise this LSA within
the entire NSSA.
The difference between the two methods is:
● In method 1, an ABR generates a Type 7 LSA carrying a
default route regardless of whether the routing table
contains a default route.
● An ASBR generates a Type 7 LSA carrying a default
route only when the routing table contains a default
route.
Default routes are flooded only within the local NSSA and
are not flooded within the entire OSPF AS. If routers in the
local NSSA cannot discover routes to the outside of the AS,
the routers can forward packets outside of the AS through
an ASBR. However, packets of other OSPF areas cannot be
sent outside the AS through this ASBR. Type 7 LSAs
carrying default routes are not translated into Type 5 LSAs
to make the default routes be flooded within the entire
OSPF AS.
Totally NSSA A totally NSSA does not allow AS external routes (carried
in Type 5 LSAs) or inter-area routes (carried in Type 3
LSAs) to be transmitted within the area.
All routers within the totally NSSA must learn AS external
routes from the ABR. The ABR automatically generates a
Type 3 LSA carrying a default route and advertises it within
the entire totally NSSA. This allows all external routes
received from other areas and inter-area routes to be
advertised within the totally NSSA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 199
5.2.1.9 OSPF LSA Types
An OSPF network is partitioned into multiple areas. These areas need to maintain
their own LSDBs, and routers in these areas are classified into different types. LSAs
encapsulated with route description can also be classified based on the router
types.
Figure 5-23 shows an OSPF network that is partitioned into three areas. A static
route is configured on R4 and imported into an OSPF process.
Figure 5-23 OSPF network partitioned into three areas
Table 5-8 lists router IDs and interface IP addresses of R1, R2, R3, and R4.
Table 5-8 Data plan
Device Router ID Interface IP Address
R1 10.1.1.1/32 GE0/0/1: 192.168.12.1/24
R2 10.2.2.2/32 GE0/0/2: 192.168.12.2/24
GE0/0/1: 192.168.23.1/24
R3 10.3.3.3/32 GE0/0/2: 192.168.23.2/24
GE0/0/1: 192.168.34.1/24
R4 10.4.4.4/32 GE0/0/2: 192.168.34.2/24
The following describes LSA types based on the network shown in Figure 5-23.
Router-LSA
A Router-LSA is a Type 1 LSA. It describes a router's link state and cost.
Every router on the OSPF network generates Router-LSAs and advertises them
within its areas. In Figure 5-24, R2 advertises a Router-LSA within Area 0 and Area
1.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 200
Figure 5-24 Router-LSA (Type 1)
Figure 5-25 shows the information contained in the Router-LSA flooded by
GE0/0/1 on R2.
Figure 5-25 Information in a Router-LSA
An LSA includes the LSA header and LSA information fields. In all types of LSAs,
their LSA header contains the same fields with the only difference of the Link
State ID field meaning. You need to focus on the following fields in an LSA
header:
● Link-State Advertisement Type: indicates the LSA type.
● Link State ID: indicates a link state ID. In a Router-LSA, this field indicates the
router ID of the device that originates this LSA. Here, the value of this field is
the router ID of R2.
● Advertising Router: indicates the router that advertises this LSA.
A Router-LSA contains three information fields, which are used to advertise a
router's link states and costs to other routers in the area where this LSA is flooded.
The LSA shown in Figure 5-25 indicates that: The link type (Type) is a transit
network (Transit), the DR interface's IP address (ID) is 192.168.23.2, the interface
IP address of the advertising router connected to the network is 192.168.23.1
(Data), and the cost (Metric) to this network is 1. Routers that receive this LSA
generate the topology based on the link state information.
Four link types area available, and the ID and Data field values vary depending on
the link type:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 201
● P2P (the field value is 1): The ID field indicates the router ID of a neighbor,
and the Data field indicates the interface IP address of the advertising router
connected to the network.
● Transit (the field value is 2): The ID field indicates the IP address of the DR
interface, and the Data field indicates the interface IP address of the
advertising router connected to the network.
● Stub (the field value is 3): The ID field indicates the IP network or subnet
address, and the Data field indicates the network IP address or subnet mask.
● Virtual Link (the field value is 4): The ID field indicates the router ID of a
neighbor, and the Data field indicates the MIB-II ifIndex of the advertising
router's interface.
Network-LSA
A Network-LSA is a Type 2 LSA. It describes the link states of all routers on the
local network segment. A DR generates Network-LSAs and advertises them within
its area. In Figure 5-26, R3 sends R2 a Network-LSA that contains router IDs of all
the routers that establish adjacencies with the DR.
Figure 5-26 Network-LSA (Type 2)
Figure 5-27 shows the information contained in the Network-LSA.
Figure 5-27 Information in a Network-LSA
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 202
In a Network-LSA, the Link State ID field indicates the IP address of a DR
interface.
Flooding Router-LSAs and Network-LSAs within an area enables each router in this
area to complete LSDB synchronization, which implements intra-area
communication.
Network-summary-LSA
A Network-summary-LSA is a Type 3 LSA. It describes inter-area routing
information. An ABR generates Network-summary-LSAs and advertises them
within its area to notify destination addresses of routes from this area to other
areas. Actually, an ABR generates Network-summary-LSAs by collecting Type 1
and Type 2 LSAs within its area and summarizing related routes. In Figure 5-28,
R2 functions as an ABR to advertise routing information in Area 0 and Area 1 to
Area 1 and Area 0 respectively.
Figure 5-28 Network-summary-LSA (Type 3)
Figure 5-29 shows the information contained in a Network-summary-LSA
advertised by R2 on GE0/0/1.
Figure 5-29 Information in a Network-summary-LSA
In a Network-summary-LSA, the Link State ID field indicates the IP address of the
network described by this LSA. Information in this LSA shows that this LSA is
advertised by R2 (10.2.2.2) and can reach the network with the IP address
192.168.12.0 and the subnet mask 255.255.255.0 at the cost of 1. R2 advertises
the network address of Area 1 to Area 0 so that routers in Area 0 know how to
reach the network in Area 1, implementing inter-area communication.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 203
If an ABR has multiple routes within its area to reach a destination, it originates
only one Network-summary-LSA carrying the route with the lowest cost to the
backbone area.
Network-summary-LSAs will not be advertised within totally stub areas or totally
NSSAs.
ASBR-Summary-LSA
An ASBR-summary-LSA is a Type 4 LSA. It describes routes to an ASBR. An ABR
generates ASBR-summary-LSAs and advertises them to areas except the area to
which the ASBR is located. In Figure 5-30, R3 functions as an ABR to advertise an
ASBR-summary-LSA to Area 0.
Figure 5-30 ASBR-summary-LSA (Type 4)
Figure 5-31 shows information contained in an ASBR-summary-LSA. The Link
State ID field indicates the router ID (10.4.4.4) of the ASBR that this LSA
describes, namely, R4. The router that advertises this LSA is R3 (10.3.3.3), and the
cost of the route from R3 to R4 is 1.
Figure 5-31 Information in an ASBR-summary-LSA
AS-external-LSA
An AS-external-LSA is a Type 5 LSA. It describes routes to destinations outside an
AS. An ASBR generates AS-external-LSAs and advertises them to all areas except
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 204
stub areas and NSSAs. In Figure 5-32, R4 functions as an ASBR to advertise a
route to an external destination network outside the AS.
Figure 5-32 AS-external-LSA (Type 5)
Figure 5-33 shows the information contained in an AS-external-LSA. The Link
State ID field indicates the destination IP address of the external network. The
Forwarding Address field indicates the address to which packets destined for this
external network should be forwarded. Here, the forwarding address 0.0.0.0
indicates that packets will be forwarded to the ASBR that generates this LSA.
Figure 5-33 Information in an AS-external-LSA
NSSA LSA
In addition to the preceding LSAs, there is a special type of LSA, namely, NSSA
LSA. An NSSA LSA is a Type 7 LSA. It describes routes to destinations outside an
AS. An ASBR generates NSSA LSAs and advertises them only in NSSAs. When an
ABR in an NSSA receives NSSA LSAs, the ABR selectively translates them into Type
5 LSAs to advertise imported external routes to other areas on the OSPF network.
If Area 2 in Figure 5-23 is an NSSA, GE0/0/2 of R4 generates an NSSA LSA, as
shown in Figure 5-34.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 205
Figure 5-34 NSSA LSA
NSSA LSAs and AS-external-LSAs have the same fields but are flooded into
different areas. AS-external-LSAs are flooded within an AS, whereas NSSA LSAs
are flooded within NSSAs.
NSSAs allow importing external routes, but NSSA LSAs describing external routes
can only be flooded within NSSAs. To enable external routes to be imported into
all areas except NSSAs, the ABR (R3) translates NSSA LSAs into AS-external-LSAs
and floods the AS-external-LSAs within the entire AS. The following provides more
information about the translation:
● The propagate bit (P-bit) in Type 7 LSAs is used to notify a router of whether
the Type 7 LSAs need to be translated.
● By default, the translator is the ABR with the largest router ID in the NSSA.
● Only NSSA LSAs with the P-bit set to 1 and a non-zero forwarding address
(FA) can be translated into AS-external-LSAs. An FA indicates a specific
address that a packet will be forwarded to before arriving at the destination
address.
● The P-bit is not set for default routes in NSSA LSAs generated by an ABR.
Opaque LSA
Opaque LSAs include Type 9 LSAs, Type 10 LSAs, and Type 11 LSAs. They provide a
universal mechanism for OSPF extensions.
● Type 9 LSAs are advertised only on the network segment where the
originating interface resides. Grace LSAs used to support graceful restart (GR)
are Type 9 LSAs.
● Type 10 LSAs are advertised within an OSPF area. LSAs used to support traffic
engineering (TE) are Type 10 LSAs.
● Type 11 LSAs are advertised within an AS. At present, there are no
applications of Type 11 LSAs.
Table 5-9 describes whether a type of LSA is supported in an area.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 206
Table 5-9 Support status of LSAs in different types of areas
Area Type Router
-LSA
(Type
1)
Netwo
rk-LSA
(Type
2)
Netwo
rk-
summ
ary-
LSA
(Type
3)
ASBR-
summa
ry-LSA
(Type
4)
AS-
extern
al-LSA
(Type
5)
NSSA-
LSA
(Type
7)
Common area
(including standard
and backbone
areas)
Suppor
ted
Suppor
ted
Suppor
ted
Suppor
ted
Support
ed
Not
support
ed
Stub area Suppor
ted
Suppor
ted
Suppor
ted
Not
support
ed
Not
support
ed
Not
support
ed
Totally stub area Suppor
ted
Suppor
ted
Not
support
ed
Not
support
ed
Not
support
ed
Not
support
ed
NSSA Suppor
ted
Suppor
ted
Suppor
ted
Not
support
ed
Not
support
ed
Suppor
ted
Totally NSSA Suppor
ted
Suppor
ted
Not
support
ed
Not
support
ed
Not
support
ed
Suppor
ted
5.2.1.10 OSPF Fast Convergence
OSPF fast convergence speeds up the convergence of routes. It includes the
following components:
● Incremental SPF (I-SPF): recalculates only the routes of the changed nodes
rather than all the nodes when the network topology changes, which speeds
up route calculation.
● Partial Route Calculation (PRC): calculates only the changed routes when the
routes on the network change.
● OSPF intelligent timer: can dynamically adjust its value based on the user's
configuration and the frequency of a triggering event, such as route
calculation, which ensures rapid and stable network operation.
The OSPF intelligent timer uses the exponential backoff technology so that
the value of the timer is accurate to milliseconds.
I-SPF
In ISO 10589, the Dijkstra algorithm was adopted to calculate routes. When a
node changes on the network, this algorithm is used to recalculate all routes,
which takes a long time and consumes too many CPU resources, affecting the
convergence speed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 207
I-SPF improves the Dijkstra algorithm. Except for the first time, only changed
nodes instead of all nodes are involved in calculation. The SPT generated at last is
the same as that generated using the Dijkstra algorithm. I-SPF consumes fewer
CPU resources and speeds up network convergence.
PRC
Similar to I-SPF, PRC performs calculation only for the changed routes. The
difference is that PRC does not calculate the shortest paths. It updates routes
based on the SPTs calculated by I-SPF.
In route calculation, a leaf represents a route, and a node represents a router.
Either an SPT change or a leaf change causes a routing information change. The
SPT change is irrelevant to the leaf change. PRC processes routing information as
follows:
● If the SPT changes, PRC processes the routing information of all leaves on a
changed node.
● If the SPT remains unchanged, PRC does not process the routing information
on any node.
● If a leaf changes, RPC processes the routing information on the leaf only.
● If a leaf remains unchanged, PRC does not process the routing information on
any leaf.
For example, if OSPF is enabled on an interface of a node, the SPT calculated by I-
SPF remains unchanged. PRC updates only the routes of this interface, consuming
fewer CPU resources.
PRC improves the SPF algorithm. Working with I-SPF, RPC further improves
network convergence performance.
NOTE
On live networks, only I-SPF and PRC are used to calculate OSPF routes.
OSPF Intelligent Timer
On an unstable network, routes are calculated frequently, which consumes a great
number of CPU resources. In addition, LSAs that describe the unstable topology
are generated and transmitted on the unstable network. Frequent processing of
data such LSAs affects the rapid and stable operation of the entire network.
To speed up route convergence on the entire network, you can use the OSPF
intelligent timer that can control route calculation, LSA generation, and LSA
receipt.
The OSPF intelligent timer works in either of the following modes:
● On a network where routes are calculated repeatedly, the OSPF intelligent
timer dynamically adjusts the interval between two route calculations based
on user's configuration and the exponential backoff technology. In this way,
the number of route calculations can be reduced, and therefore fewer CPU
resources are consumed. Routes will be calculated again after the network
topology stabilizes.
● On an unstable network, a router generates or receives numerous LSAs due to
frequent topology changes. In this case, the OSPF intelligent timer can
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 208
dynamically adjust the interval at which the LSAs are generated or processed.
Within the interval, no LSAs are generated or processed. This prevents invalid
LSAs from being generated and advertised on the entire network.
The OSPF intelligent timer is started by default and has a default value.
5.2.1.11 OSPF Virtual Link
A virtual link is a logical channel set up between two ABRs through a non-
backbone area.
As required in RFC 2328, all non-backbone areas must be connected to the
backbone area to ensure that all areas are reachable. However, it is not true in
some scenarios due to certain restrictions. To resolve this issue, you can configure
an OSPF virtual link.
In Figure 5-35, Area 2 is not connected to Area 0. Therefore, RouterA cannot
function as an ABR to generate routing information of Network1 and advertise the
information to Area 2, and RouterB does not have routes to Network1. A virtual
link can be deployed to resolve this issue.
Figure 5-35 Non-backbone area not connected to the backbone area
In Figure 5-36, two ABRs use a virtual link to directly transmit OSPF packets. The
OSPF device between the two ABRs only forwards packets. Because the
destination of OSPF packets is not the OSPF device, the OSPF device transparently
transmits the OSPF packets as common IP packets.
Figure 5-36 OSPF virtual link implementation principles
A virtual link functions as a point-to-point connection between two ABRs. The
interfaces on both ends of the virtual link can be configured with parameters such
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 209
as the Hello interval in the same way these parameters are configured on physical
interfaces. The transmit area refers to the area that provides an internal route of a
non-backbone area for both ends of the virtual link. A virtual link must be
configured at both ends of the link, or it will not take effect.
A virtual link increases the network complexity and complicates fault locating. You
are not advised to use virtual links during network planning. Virtual links are only
a temporary measure to fix unavoidable network topology problems. When virtual
links are designed, you need to consider whether to re-plan the network.
5.2.1.12 OSPF Route Summarization and Filtering
OSPF Route Summarization
Route summarization allows multiple routes with the same prefix to be
summarized into a single summary route. Only the summary route is advertised to
other areas. This reduces both the routing table size and routing information
transmitted between areas, improving device performance.
OSPF supports two types of route summarization:
● Inter-area route summarization
Inter-area route summarization is performed on ABRs and applies to routes
from within an AS. An ABR generates Network-summary (Type 3) LSAs by
network segment while advertising routing information to other areas. If
network segments are contiguous, the ABR can summarize them into a single
segment. This allows the ABR to send only the summary LSA for all the
specified network segments.
● External route summarization
External route summarization is performed on ASBRs and is specific to
external routes that are imported into OSPF. ASBRs can summarize imported
AS-external (Type 5) LSAs within a summary address range. After an NSSA is
configured, an ASBR must summarize imported NSSA (Type 7) LSAs with the
summary address range.
Devices that are both ABRs and ASBRs summarize the Type 5 LSAs translated
from Type 7 LSAs.
OSPF Route Filtering
OSPF supports route filtering using routing policies, including route-policy, access-
list, and prefix-list. By default, OSPF does not filter routes.
OSPF route filtering can be used to:
● Import routes.
OSPF can import routes learned by other routing protocols. You can configure
routing policies to filter imported routes, allowing OSPF to import only routes
that match specific conditions.
● Advertise imported routes.
An OSPF device advertises imported routes to its neighbors.
You can configure filtering rules to filter the routes to be advertised, but the
rules take effect only on ASBRs.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 210
● Learn routes.
Filtering rules can be configured to allow OSPF to filter received intra-area,
inter-area, and AS external routes.
After receiving routes, an OSPF device adds only the routes that match
filtering rules to the local routing table. However, the device can advertise all
routes from the OSPF routing table.
● Learn inter-area LSAs.
You can configure an ABR to filter incoming Summary LSAs. This
configuration takes effect only on ABRs because only ABRs can advertise
Summary LSAs.
Difference between route filtering for inter-area LSA learning and that for
route learning: The former directly filters incoming LSAs but the latter filters
the routes calculated using LSAs to determine the routes to be added to the
local routing table. In route filtering for route learning, all incoming LSAs are
learned.
● Advertise inter-area LSAs.
You can configure an ABR to filter outgoing Summary LSAs. This configuration
takes effect only on ABRs.
5.2.1.13 OSPF Multi-Process
OSPF supports multi-process. This allows multiple OSPF processes to run
independently on the same router. Route exchanges between different OSPF
processes are similar to route exchanges between different routing protocols.
Each router interface belongs to only one OSPF process.
OSPF multi-process typically applies to the scenario where OSPF runs between
provider edges (PEs) and customer edges (CEs) in a VPN whereas OSPF is used as
an IGP on the backbone of the VPN. On the PEs, the two OSPF processes do not
affect each other.
5.2.1.14 OSPF RFC 1583 Compatibility
RFC 1583 is an early version of OSPFv2.
During OSPF external route calculations, routing loops may occur because RFC
2328 and RFC 1583 define different route selection rules. To prevent routing loops,
both communication ends must use the same route selection rules. The
mechanism is as follows:
● When RFC 1583 compatibility is enabled, OSPF uses route selection rules
defined in RFC 1583.
● When RFC 1583 compatibility is disabled, OSPF uses route selection rules
defined in RFC 2328.
OSPF calculates external routes using Type 5 LSAs. If the router with RFC 1583
compatibility enabled receives a Type 5 LSA:
● The router selects a route to the ASBR that originates the LSA or to the
forwarding address (FA) described in the LSA.
● The router selects external routes to the same destination.
By default, OSPF uses route selection rules defined in RFC 1583.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 211
5.2.2 Enhanced OSPF Functions
5.2.2.1 OSPF VPN
Definition
OSPF VPN enables Provider Edges (PEs) and Customer Edges (CEs) within VPNs to
run OSPF. This is useful for interworking and allows OSPF to learn and advertise
VPN routes.
Purpose
As a widely used IGP, in most cases, OSPF runs in VPNs. When OSPF runs between
PEs and CEs and PEs are advertising VPN routes using OSPF, CEs do not need to
support other routing protocols for interworking, simplifying the management and
configuration of CEs.
Running OSPF Between PEs and CEs
In BGP/MPLS VPN, routing information is transmitted between PEs using Multi-
Protocol BGP (MP-BGP), whereas routing information is learned and advertised
between PEs and CEs using OSPF.
Running OSPF between PEs and CEs has the following benefits:
● OSPF is used within a site to learn routes. Running OSPF between PEs and CEs
can reduce the protocol types that CEs must support, lowering the
requirements on the CEs.
● Running OSPF both within a site and between PEs and CEs frees network
administrators from getting familiarity with multiple protocols, simplifying the
workload of them.
● Running OSPF between PEs and CEs facilitates the transition from a non-VPN
backbone network to a BGP/MPLS VPN network.
As shown in Figure 5-37, CE1, CE3, and CE4 belong to VPN 1. The numbers
following OSPF refer to the IDs of OSPF multi-instance processes running on PEs.
Figure 5-37 Running OSPF between PEs and CEs
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 212
To advertise routes of CE1 to CE3 and CE4:
1. PE1 imports OSPF routes of CE1 into BGP and generates BGP VPNv4 routes.
2. PE1 advertises BGP VPNv4 routes to PE2 using MP-BGP.
3. PE2 imports BGP VPNv4 routes into OSPF, and then advertises these routes to
CE3 and CE4.
The process of advertising routes of CE4 or CE3 to CE1 is the same.
Configuring OSPF Areas Between PEs and CEs
OSPF areas between PEs and CEs can be either non-backbones or backbone areas
(Area 0). A PE can only be an area border router (ABR).
In the extended application of OSPF VPN, the MPLS VPN backbone network serves
as Area 0. OSPF requires that backbone areas (Area 0) be contiguous. Therefore,
Area 0 in all VPN sites must be connected to the MPLS VPN backbone network. If
a VPN site has OSPF Area 0, the PEs that CEs access must be connected to the
backbone area of this VPN site through the MPLS VPN backbone network. If no
physical link is available to directly connect PEs to Area 0 in the VPN site, a virtual
link can be used to implement logical connection between them, as shown in
Figure 5-38.
Figure 5-38 Configuring OSPF areas between PEs and CEs
In Figure 5-38, a non-backbone area (Area 1) is configured between PE1 and CE1,
and a backbone area (Area 0) is configured in Site 1. As a result, the backbone
area in Site 1 is isolated from the VPN backbone area. Therefore, a virtual link is
configured between PE1 and CE1 to ensure that the backbone areas are
continuous.
OSPF Domain ID
If inter-area routes are advertised between local and remote OSPF areas, these
areas are considered in the same OSPF domain.
Important characteristics of OSPF domain IDs include:
● Domain IDs identify and differentiate different domains.
● Each OSPF domain has one or more domain IDs, one of which is a primary ID
with the others being secondary IDs.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 213
● If an OSPF instance does not have a specific domain ID, NULL is used as its
domain ID.
Before a PE advertises the BGP routes learned from remote PEs to CEs, the PE
checks the domain IDs carried in the BGP routes to determine the type of OSPF
routes (Type 3, Type 5, or Type 7) to be advertised.
If local domain IDs are the same as or compatible with the remote domain IDs
carried in the BGP routes, the PE advertises Type 3 routes. Otherwise, the PE
advertises Type 5 or Type 7 routes.
Table 5-10 Domain ID
Comparison Between Local and Remote
Domain IDs
Advertised Route Type
Both the local and remote domain IDs are null. Inter-area route
The remote domain ID is the same as the local
primary domain ID or one of the local
secondary domain IDs.
Inter-area route
The remote domain ID is different from the
local primary domain ID and all the local
secondary domain IDs.
If the local area is a non-NSSA,
external routes are generated.
If the local area is an NSSA,
NSSA routes are generated.
Routing Loop Prevention
Routing loops may occur between PEs and CEs if OSPF and BGP learn routes from
each other.
Figure 5-39 OSPF VPN routing loop
As shown in Figure 5-39, a routing loop occurs in the following process:
1. PE1 uses OSPF to import a BGP route whose destination address is
10.1.1.1/32.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 214
2. OSPF then generates a Type 5 or Type 7 LSA and advertises it to CE1.
3. CE1 learns an OSPF route with the destination address of 10.1.1.1/32 and the
next hop of PE1 and advertises the route to PE2.
4. PE2 learns an OSPF route with the destination address and next hop being
10.1.1.1/32 and CE1 respectively.
5. Likewise, CE1 learns an OSPF route with the destination address of 10.1.1.1/32
and the next hop of PE2, and PE1 learns an OSPF route with the destination
address of 10.1.1.1/32 and the next hop of CE1.
6. In this way, CE1 has learned two equal-cost routes, with the next hop of one
being PE1 and the other being PE2. The next hops of the routes from PE1 and
PE2 to 10.1.1.1/32 are both CE1. That is, a routing loop occurs.
The preference of an OSPF route is higher than that of a BGP route. Therefore,
BGP routes on PE1 and PE2 to 10.1.1.1/32 are replaced by the OSPF routes. The
OSPF routes with the destination address of 10.1.1.1/32 and the next hop of CE1
are active in the routing tables of PE1 and PE2.
The BGP routes then become inactive, causing the deletion of the LSAs generated
when OSPF imports the routes. As a result, the active OSPF routes are withdrawn,
and the BGP route becomes active again. The above process occurs repeatedly,
leading to route flapping.
OSPF VPN provides a solution to this problem, as described in the following table.
Table 5-11 Routing loop prevention
Feature Definition Function
DN bit The DN bit is a 1-bit flag used by
an OSPF multi-instance process
to prevent routing loops.
When a PE advertises
generated Type 3, Type
5, or Type 7 LSAs to CEs,
it sets the DN bit of
these LSAs to 1 and
retains the default value
0 for the DN bit of other
LSAs.
When calculating routes,
the OSPF multi-instance
process of the PE ignores
LSAs with the DN bit set
to 1. This prevents the PE
from learning the self-
originated LSAs from
CEs, thereby avoiding
routing loops.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 215
Feature Definition Function
VPN route tag The VPN route tag is carried in
Type 5 or Type 7 LSAs generated
by PEs according to received BGP
private routes.
The VPN route tag is valid only
on the PEs that receive BGP
routes and generate OSPF LSAs.
It is not transmitted in BGP
extended community attributes.
When a PE detects that
the VPN route tag in the
received LSA is the same
as that in the local LSA,
the PE ignores this LSA.
This prevents routing
loops.
Default route A default route is a route with an
all-0 destination address and an
all-0 subnet mask.
Default routes are used
to forward traffic from
CEs or from the sites
where CEs reside
.
Disabling Routing Loop Prevention
NOTICE
Exercise caution when disabling routing loop prevention as it increases the
likelihood of routing loops.
After routing loop prevention is enabled, OSPF routing loops will not occur in VPN
sites during BGP/OSPF route exchanges.
In an inter-AS VPN Option A scenario, if OSPF runs between ASBRs to transmit
VPN routes, the remote ASBR will be unable to learn the OSPF routes sent by the
local ASBR due to the routing loop prevention mechanism.
Figure 5-40 illustrates an inter-AS VPN in Option A mode. OSPF runs between PE1
and CE1. Assume that CE1 sends VPN routes to CE3.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 216
Figure 5-40 Networking diagram of an inter-AS VPN deployed in Option A mode
In Figure 5-40:
1. PE1 learns routes to CE1 through the OSPF process within a VPN instance,
imports these routes into MP-BGP, and then sends the MP-BGP routes to
ASBR1.
2. ASBR1 receives the MP-BGP routes, imports the routes into the OSPF process
within a VPN instance, and then generates Type 3, Type 5, or Type 7 LSAs with
the DN bit set to 1.
3. When learning these LSAs using OSPF, ASBR2 checks the DN-bit in the LSAs.
When detecting that the DN-bit in the LSAs is 1, ASBR2 ignores these LSAs.
Because ASBR2 cannot learn OSPF routes sent from ASBR1, CE1 cannot
communicate with CE3.
The following methods are provided to solve this problem:
● Method 1: Disable devices from setting the DN bit to 1 when importing BGP
routes into OSPF. For example, ASBR1 is disabled from setting the DN-bit to 1
when importing BGP routes into OSPF. When ASBR2 receives these routes and
detects that the DN-bit in the LSAs carrying these routes is 0, ASBR2 uses
these LSAs to calculate routes.
● Method 2: Disable devices from checking the DN-bit in received LSAs. For
example, ASBR2 is disabled from checking the DN-bit in received LSAs. ASBR1
sets the DN-bit to 1 in LSAs when importing MP-BGP routes into OSPF.
ASBR2, however, does not check the DN-bit when receiving these LSAs and
uses these LSAs to calculate routes.
The two methods can be used more flexibly based on specific types of LSAs. For
Type 3 LSAs, you can configure a sender to determine whether to set the DN bit to
1 or configure a receiver to determine whether to check the DN bit in the Type 3
LSAs based on the router ID of the device that generates the LSAs.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 217
In an inter-AS VPN Option A scenario as shown in Figure 5-41, four ASBRs are
fully meshed and run OSPF. ASBR2 may receive Type 3, Type 5, or Type 7 LSAs
generated on ASBR4. If ASBR2 is disabled from checking the DN-bit in the LSAs,
ASBR2 will accept the Type 3 LSAs, and routing loops will occur. ASBR2 will deny
the Type 5 or Type 7 LSAs because the VPN route tags carried in the LSAs are the
same as the default VPN route tag of the OSPF process on ASBR2.
To address the routing loops caused by Type 3 LSAs, you can disable the check of
the DN-bit only for the Type 3 LSAs that are generated by devices with the router
ID 10.1.1.1 or 10.3.3.3. With the check disabled in such a way, if ASBR2 receives
Type 3 LSAs sent by ASBR4 with the router ID 10.4.4.4, ASBR2 will check the DN-
bit and deny these Type 3 LSAs because the DN-bit is set to 1.
Figure 5-41 Networking diagram of fully meshed ASBRs in the inter-AS VPN
Option A scenario
Multi-VPN-Instance CE
OSPF multi-instance generally runs on PEs. Multi-VPN-Instance CEs (MCEs) are
devices that run OSPF multi-instance within user LANs.
Compared with OSPF multi-instance running on PEs, MCEs have the following
characteristics:
● Support of OSPF-BGP synchronization is not required.
● A separate OSPF instance is created for each service. That is, different virtual
CEs transmit traffic for different services. This is a low-cost solution for LAN
security issues.
● Different OSPF multi-instances are implemented on a CE. To implement OSPF
multi-instances, routing loop detection needs to be disabled and route
calculation is performed directly. That is, MCEs also use the received LSAs with
the DN bit set to 1 for route calculations.
5.2.2.2 OSPF TE
Traffic engineering (TE) requires knowledge of the network topology and network
constraints, including the bandwidth, traffic engineering metrics, administrative
groups, and affinity attributes. By itself, OSPF cannot meet these requirements and
needs to be extended by introducing a new type of LSAs to advertise network
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 218
constraints. Then, the Constrained Shortest Path First (CSPF) algorithm can
calculate the path that satisfies defined constraints.
OSPF TE is designed to support MPLS TE and the establishment and maintenance
of the Label Switch Path (LSP). In MPLS TE architecture, OSPF is responsible for
collecting and advertising MPLS TE information.
Figure 5-42 OSPF functions in MPLS TE architecture
OSPF Functions in MPLS TE Architecture
In MPLS TE architecture, OSPF advertises information by collecting and then
flooding traffic engineering information to devices in the same area.
Collected information forms the traffic engineering database (TEDB) and is
utilized by the CSPF to calculate routes.
OSPF does not consider what the specific information is or how MPLS uses the
information.
TE-LSA
OSPF uses Type 10 Opaque LSAs to collect and advertise traffic engineering
information. Type 10 LSAs contain link state information required by traffic
engineering, including:
● Maximum link bandwidth
● Maximum reservable bandwidth
● Current reserved bandwidth
● Link color
Type 10 Opaque LSAs use OSPF flooding to synchronize link state information
among devices in an area. This forms a uniform TEDB for route calculation.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 219
Interaction Between OSPF TE and CSPF
OSPF uses Type 10 LSAs to collect traffic engineering information, including the
bandwidth, priority, and link metric. OSPF then processes and provides the
information for CSPF to calculate routes.
IGP Shortcut and Forwarding Adjacency
OSPF supports IGP shortcuts and forwarding adjacencies. These two features
enable OSPF packets to reach a destination through a tunnel interface as the
outbound interface. The differences between the two features are as follows:
Devices with IGP shortcuts enabled use a tunnel interface as an outbound
interface without advertising the tunnel interface link to neighbors. This prevents
other devices from using this tunnel. IGP shortcuts are unidirectional and need to
be configured only on devices that need to use IGP shortcuts.
Devices with forwarding adjacencies enabled use a tunnel interface as an
outbound interface while advertising the tunnel interface link to neighbors. This
allows other devices to use this tunnel.
OSPF DS-TE
DiffServ Aware Traffic Engineering (DS-TE) combines the advantages of MPLS TE
and Differentiated Services (DiffServ), and therefore it controls and forwards data
differently based on Class of Service (CoS) while precisely controlling data paths.
That is, DS-TE allows for efficient use of network resources while reserving
required resources for different services.
To support DE-TE in MPLS, OSPF TE-LSAs contain local overbooking multiplier
TLVs and bandwidth constraint (BC) TLVs. These TLVs are used to collect and
advertise the information about the reservable bandwidth of each class type (CT)
with a specific priority on the link. A class type refers to the bandwidth set of an
LSP or a group of LSPs sharing the same CoS.
OSPF SRLG
OSPF supports Shared Risk Link Group (SRLG) applications in MPLS by obtaining
information about the SRLG that floods traffic engineering information to devices
in an area.
5.2.2.3 OSPF Security
OSPF GTSM
The Generalized TTL Security Mechanism (GTSM) protects services over the IP
layer against attacks by checking whether the value of the time to live (TTL) in an
IP packet header is within a predefined range. An attacker may simulate real
unicast OSPF packets and continuously send the packets to a router. When the
router finds that these packets are destined for itself, it directly sends the packets
to the control plane for processing without checking the validity of these packets.
As a result, the router will remain busy processing these packets, leading to a high
CPU usage.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 220
GTSM protects a device's TCP/IP-based control plane from certain attacks that
consume CPU resources, for example, the CPU overload attack.
Devices with GTSM enabled check the TTL values in all received packets according
to configured policies. An action is then performed on the packets that do not
match the criteria specified in the policies. (For example, the packets may be
discarded).
A GTSM policy includes:
● Source address of an IP packet sent to the device
● VPN instance to which a packet belongs
● Protocol number of an IP packet (89 for OSPF and 6 for BGP)
● Source interface number and destination interface number of a protocol
above TCP/UDP
● Valid TTL range
GTSM can be implemented for different connections:
● For directly connected neighbors, the TTL of unicast protocol packets is set to
255.
● For multi-hop neighbors, an appropriate TTL range is defined.
The applicability of GTSM is as follows:
● GTSM is applicable to unicast packets instead of multicast packets. The TTL of
multicast packets cannot exceed 255, and therefore GTSM is not required for
multicast packets.
● GTSM does not apply to devices that use a tunnel to communicate with each
other.
OSPF Packet Authentication
On networks requiring high security, OSPF packet authentication can be
configured on routers to improve OSPF network security. During OSPF packet
authentication, routers must use the same authentication mode and can establish
a neighbor relationship to exchange routing information only after they pass the
authentication.
OSPF supports two authentication methods:
● Simple password authentication: uses a password in either plaintext or
ciphertext for authentication.
● Message digest authentication: uses Message Digest5 (MD5), Hash Message
Authentication Code (HMAC) MD5, or HMAC-Secure Hash Algorithm (SHA)
256 for authentication.
Packet Authentication can be configured for all networks in an area or for
individual interfaces in the area. Interface authentication configuration overrides
area authentication.
5.2.2.4 OSPF GR
The control plane and forwarding plane are generally separated on switches.
When the network topology remains stable, a restart of the control plane does not
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 221
affect the forwarding plane, which means that the forwarding plane can continue
to forward data. This separation ensures non-stop service forwarding.
In graceful restart (GR) mode, the forwarding plane continues to direct data
forwarding when a device restart occurs, without being affected by the actions on
the control plane, such as re-establishment of neighbor relationships and route
calculation. In this way, service interruption caused by route flapping is prevented
and the network reliability is improved.
Basic Concepts of OSPF GR
Graceful Restart (GR), also called non-stop forwarding (NSF), is used to ensure
normal traffic forwarding and proper running of key services during a routing
protocol restart.
Unless otherwise stated, GR described in this section refers to the GR technology
defined in RFC 3623.
GR is a fault-tolerant redundancy technology, one of high availability (HA)
technologies that include link protection, faulty node recovery, and traffic
engineering, and is used to ensure non-stop forwarding of key services during
active/standby switchovers and system upgrades.
The following concepts are involved in GR:
● Grace-LSA
OSPF supports GR by flooding Grace-LSAs. Grace-LSAs are used to inform
neighbors of the GR time, cause, and interface address when the GR starts
and ends.
● Role of a switch during GR
– Restarter: is the switch that restarts. The Restarter can be configured to
support full GR or partial GR.
– Helper: is the switch that helps the Restarter. The Helper can be
configured to:
▪ Selectively support GR based on policies.
▪ Support planned GR.
▪ Support unplanned GR.
● GR causes
– Unknown: indicates that GR is triggered by unknown events.
– Software restart: indicates that GR is triggered by commands.
– Software reload/upgrade: indicates that GR is triggered by a software
restart or upgrade.
– Switch to redundant control processor: indicates that GR is triggered by
an abnormal active/standby switchover.
● GR period
The GR period cannot exceed 1800 seconds. OSPF switches can exit GR before
GR timeout regardless of successful or failed GR.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 222
Classification of OSPF GR
● Full GR: When a neighbor of a switch does not support GR, the switch exits
GR.
● Partial GR: When a neighbor of a switch does not support GR, only the
interface associated with this neighbor exits GR, whereas the other interfaces
perform GR normally.
● Planned GR: Commands are manually configured to restart a switch or
perform an active/standby switchover for the switch. The Restarter sends a
Grace-LSA before the restart or switchover.
● Unplanned GR: A switch performs an active/standby switchover without
sending a Grace-LSA and then enters GR after the standby board goes Up.
The process of unplanned GR after the standby board goes Up is the same as
that of planned GR.
GR Process
Figure 5-43 shows an OSPF GR process.
Figure 5-43 OSPF GR process
An OSPF GR process includes the following phases:
1. The Restarter (SwitchA) enters the GR state.
a. The Restarter performs an active/standby switchover.
NOTE
In planned GR mode, the Restarter sends a Grace-LSA to notify the Helper of the
GR start, period, and cause before performing the switchover. In unplanned GR
mode, the Restarter does not send any Grace-LSA.
b. Before the Restarter enters the GR state, it sends a Grace-LSA to maintain
OSPF neighbor relationships.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 223
c. When the standby board goes Up, the Restarter immediately sends a
Grace-LSA to notify the Helper (SwitchB) of the GR start, period, and
cause. Then, the Restarter sends five consecutive Grace-LSAs to the
Helper to ensure that the Helper can receive a Grace-LSA.
NOTE
Sending five consecutive Grace-LSAs is proposed by vendors and has not been
defined by OSPF.
During the GR, the Helper retains the neighbor relationship with the Restarter
so that other switches do not detect the active/standby switchover performed
by the Restarter.
2. The Restarter stays in the GR state.
a. The Restarter and Helper establish an OSPF adjacency.
b. The Helper checks the Restarter status. If the Restarter status is Down,
the Helper considers that the Restarter can restore services within a
specified GR period. Before the specified GR period expires, the Helper
does not terminate sessions or delete the topology or routing information
obtained from the Restarter.
c. When the Restarter recovers, it sends a packet to the Helper. After the
Restarter receives a response, it reestablishes the neighbor relationship
list.
d. The Restarter establishes a session with the Helper to obtain topology or
routing information and uses the information to calculate its own routing
table.
An active/standby switchover or restart of the Restarter can be manually
performed or automatically triggered by faults. During the switchover or
restart, the Restarter does not delete the routing information from its routing
table or FIB or reset its interface boards. Therefore, the service continuity can
be implemented.
3. The Restarter exits the GR state.
– If the GR is successful, the Restarter reestablishes the neighbor
relationship with the Helper before the GR period expires. After the
Helper receives a Grace-LSA with an aging time of 3600 seconds from the
Restarter, the status of the neighbor relationship between the Helper and
Restarter changes to Full.
– If the GR fails, packet reception and status change on the Restarter and
Helper are as follows:
On the Restarter:
▪ The Restarter times out the GR and fails to completely recover the
neighbor relationships.
▪ The Restarter fails to perform the bidirectional check due to Type 1
or Type 2 LSAs sent by the Helper.
▪ The interface status of the Restarter changes.
▪ The Restarter receives 1-way Hello packets from the Helper.
▪ The Restarter receives a Grace-LSA generated by another switch on
the same network segment.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 224
NOTE
Only one switch can perform GR on the same network segment at the same
time.
▪ Different DRs or BDRs are elected among the Restarter and
neighbors on the same network segment due to topology changes.
On the Helper:
▪ The Helper fails to receive a Grace-LSA from the Restarter before the
neighbor relationship expires.
▪ The interface status of the Helper changes.
▪ The Helper receives LSAs different from those in its own LSDB from
other switches. You can configure the Helper not to perform a strict
LSA check to avoid this issue.
▪ The Helper receives Grace-LSAs from two switches on the same
network segment at the same time.
▪ The neighbor relationships between the Helper and other switches
change.
Comparison Between GR Mode and Non-GR Mode
Table 5-12 Comparison of an active/standby switchover in GR mode and non-GR
mode
Switchover in Non-GR Mode Switchover in GR Mode
● OSPF neighbor relationships are
re-established.
● Routes are recalculated.
● The forwarding table changes.
● The entire network detects the
route changes, and routes flap for
a short period of time.
● Packets are lost during
forwarding, and services are
interrupted.
● OSPF neighbor relationships are re-
established.
● Routes are recalculated.
● The forwarding table remains
unchanged.
● Except for neighbors of the device on
which an active/standby switchover
occurs, other switches do not detect
route changes.
● No packets are lost during
forwarding, and services are not
affected.
5.2.2.5 OSPF Neighbor Relationship Flapping Suppression
OSPF neighbor relationship flapping suppression works by delaying OSPF neighbor
relationship reestablishment or setting the link cost to the maximum value
(65535).
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 225
Background
If the status of an interface carrying OSPF services alternates between Up and
Down, OSPF neighbor relationship flapping occurs on the interface. During the
flapping, OSPF frequently sends Hello packets to reestablish the neighbor
relationship, synchronizes LSDBs, and recalculates routes. In this process, a large
number of packets are exchanged, adversely affecting the stability of the existing
neighbor relationships, OSPF services, and other OSPF-dependent services, such as
LDP and BGP. Suppression of OSPF neighbor relationship flapping can address this
problem by delaying OSPF neighbor relationship reestablishment or preventing
service traffic from passing through flapping links.
Related Concepts
Flapping_event: A flapping_event occurs when the status of a neighbor
relationship on an interface last changes from Full to a non-Full state. A
flapping_event triggers flapping detection.
Flapping_count: This parameter indicates the number of times flapping has
occurred.
Detect-interval: This parameter indicates the flapping detection interval. The
interval is used to determine whether to trigger a valid flapping_event.
Threshold: This parameter indicates the flapping suppression threshold. When the
flapping_count reaches or exceeds the threshold, flapping suppression takes effect.
Resume-interval: This parameter indicates the resumption interval. If the time
between two valid flapping_events is longer than the resume-interval, flapping
suppression exits.
Implementation
Flapping detection
A flapping counter is started on OSPF interfaces. Each time two consecutive
flapping_events occur within a detect-interval, a valid flapping_event is recorded
and the flapping_count increments by 1. When the flapping_count reaches or
exceeds the threshold, the system determines that flapping occurs, triggers
flapping suppression accordingly, and sets the flapping_count to 0. If two
consecutive valid flapping_events occur within a period longer than the resume-
interval before the flapping_count reaches the threshold again, the system also
sets the flapping_count to 0. Interfaces start the suppression timer when the
neighbor status last changes to ExStart or Down.
The detect-interval, threshold, and resume-interval are configurable.
Flapping suppression
Flapping suppression works in either Hold-down or Hold-max-cost mode.
● Hold-down mode: In the case of frequent flooding and topology changes,
interfaces prevent neighbor relationships from being reestablished within the
suppression period, which minimizes LSDB synchronization attempts and
packet exchanges.
● Hold-max-cost mode: In the case where the traffic forwarding path changes
frequently, interfaces use 65535 as the cost of the flapping link within the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 226
suppression period, which prevents traffic from passing through the flapping
link.
Flapping suppression can also work first in Hold-down mode and then in Hold-
max-cost mode after the Hold-down mode exits.
By default, the Hold-max-cost mode takes effect. The suppression mode and
period can be changed manually using command lines.
NOTE
When an interface enters the flapping suppression state, all neighbors of the interface enter
the state accordingly.
Exiting flapping suppression
Interfaces exit flapping suppression in the following scenarios:
● The suppression timer expires.
● The corresponding OSPF process is reset.
● Command lines are configured to force interfaces to exit flapping suppression.
Typical Scenarios
Basic scenario
In Figure 5-44, the traffic forwarding path is Switch A -> Switch B -> Switch C ->
Switch E before a link failure occurs. After the link between Switch B and Switch C
fails, the forwarding path switches to Switch A -> Switch B -> Switch D -> Switch
E. At the early stage of the path switchover, there is a high probability that the
status of the neighbor relationship between Switch B and Switch C flaps
frequently, leading to frequent switchovers of forwarding paths. Each switchover
triggered by faults causes traffic loss. The network stability is affected. In this
scenario, if the devices are configured with flapping suppression, flapping
suppression takes effect when the suppression conditions are met.
● If flapping suppression works in Hold-down mode, the neighbor relationship
between Switch B and Switch C is prevented from being reestablished within
the suppression period so that the traffic is forwarded along the path Switch
A -> Switch B -> Switch D -> Switch E.
● If flapping suppression works in Hold-max-cost mode, 65535 is used as the
cost of the link between Switch B and Switch C within the suppression period
so that the traffic is forwarded along the path Switch A -> Switch B -> Switch
D -> Switch E.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 227
Figure 5-44 Flapping suppression in a basic scenario
Single-forwarding path scenario
If only one forwarding path exists on the network, the neighbor relationship
flapping between any two devices on the path will interrupt traffic forwarding. In
Figure 5-45, the only traffic forwarding path is Switch A -> Switch B -> Switch C -
> Switch E. If the neighbor relationship between Switch B and Switch C flaps and
the flapping meets the suppression conditions, flapping suppression takes effect.
However, if the neighbor relationship between Switch B and Switch C is prevented
from being reestablished, the whole network will be divided. Therefore, the Hold-
max-cost mode (rather than the Hold-down mode) is recommended. If flapping
suppression works in Hold-max-cost mode, 65535 is used as the cost of the link
between Switch B and Switch C within the suppression period. After the network
stabilizes and the suppression timer expires, the link is restored.
NOTE
By default, the Hold-max-cost mode takes effect.
Figure 5-45 Flapping suppression in a single-forwarding path scenario
Broadcast scenario
In Figure 5-46, four devices are deployed on the same broadcast network using
switches, and the devices are broadcast network neighbors. If Switch C flaps due
to a link failure and Switch A and Switch B were deployed at different time
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 228
(Switch A was deployed earlier for example) or the flapping suppression
parameters on Switch A are different from those on Switch B, Switch A first
detects the flapping and suppresses Switch C. Consequently, the Hello packets sent
by Switch A do not carry the Switch ID of Switch C. However, Switch B has not
detected the flapping yet and still considers Switch C as a valid node. As a result,
the DR candidates identified by Switch A are Switch B and Switch D, whereas the
DR candidates identified by Switch B are Switch A, Switch C, and Switch D.
Different DR candidates result in a different DR election result, which may lead to
route calculation errors. To prevent this problem in scenarios where an interface
has multiple neighbors, such as on a broadcast, P2MP, or NBMA network, all
neighbors on the interface are suppressed when the status of a neighbor
relationship last changes to ExStart or Down. Specifically, if Switch C flaps, Switch
A, Switch B, and Switch D on the same broadcast network as Switch C are all
suppressed. After the network stabilizes and the suppression timer expires, Switch
A, Switch B, and Switch D are restored to normal status.
Figure 5-46 Flapping suppression on a broadcast network
Multi-area scenario
In Figure 5-47, Switch A, Switch B, Switch C, Switch E, and Switch F are connected
in area 1, and Switch B, Switch D, and Switch E are connected in backbone area 0.
Traffic from Switch A to Switch F is preferentially forwarded along intra-area
routes, and therefore the forwarding path is Switch A -> Switch B -> Switch C ->
Switch E -> Switch F. When the neighbor relationship between Switch B and
Switch C flaps and the flapping meets suppression conditions, flapping suppression
takes effect in the default mode of Hold-max-cost. Consequently, 65535 is used as
the cost of the link between Switch B and Switch C. However, the forwarding path
remains unchanged because intra-area routes take precedence over inter-area
routes during route selection according to OSPF route selection rules. Therefore,
the Hold-down mode must be used in this scenario to prevent the neighbor
relationship between Switch B and Switch C from being reestablished within the
suppression period. During this period, traffic is forwarded along the path Switch A
-> Switch B -> Switch D -> Switch E -> Switch F.
NOTE
By default, the Hold-max-cost mode takes effect. You can manually configure command
lines to change the mode to Hold-down.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 229
Figure 5-47 Flapping suppression in a multi-area scenario
Scenario with both LDP-IGP synchronization and OSPF neighbor relationship
flapping suppression configured
In Figure 5-48, if the link between PE1 and P1 fails, an LDP LSP switchover is
implemented immediately, causing the original LDP LSP to be deleted before a
new LDP LSP is established. To prevent traffic loss, LDP-IGP synchronization needs
to be configured. With LDP-IGP synchronization configured, 65535 is used as the
cost of the new LSP to be established. After the new LSP is established, the
original cost takes effect. Then, the original LSP is deleted, and LDP traffic is
forwarded along the new LSP.
Both LDP-IGP synchronization and OSPF neighbor relationship flapping
suppression work in either Hold-down or Hold-max-cost mode. If both functions
are configured, the Hold-down mode takes precedence over the Hold-max-cost
mode, followed by the configured link cost. Table 5-13 lists the suppression modes
that take effect in different situations.
Table 5-13 Principles for selecting suppression modes in different situations
LDP-IGP
Synchronization/
OSPF Neighbor
Relationship
Flapping
Suppression
Mode
Hold-down Mode
of LDP-IGP
Synchronization
Hold-max-cost
Mode of LDP-IGP
Synchronization
Exiting LDP-IGP
Synchronization
Suppression
Hold-down mode
of OSPF neighbor
relationship
flapping
suppression
Hold-down Hold-down Hold-down
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 230
LDP-IGP
Synchronization/
OSPF Neighbor
Relationship
Flapping
Suppression
Mode
Hold-down Mode
of LDP-IGP
Synchronization
Hold-max-cost
Mode of LDP-IGP
Synchronization
Exiting LDP-IGP
Synchronization
Suppression
Hold-max-cost
mode of OSPF
neighbor
relationship
flapping
suppression
Hold-down Hold-max-cost Hold-max-cost
Exiting OSPF
Neighbor
Relationship
Flapping
Suppression
Hold-down Hold-max-cost Exiting LDP-IGP
synchronization
and OSPF
neighbor
relationship
flapping
suppression
For example, the link between PE1 and P1 frequently flaps, as shown in Figure
5-48, and both LDP-IGP synchronization and OSPF neighbor relationship flapping
suppression are configured. In this case, the suppression mode is selected based on
the above principles. No matter which mode (Hold-down or Hold-max-cost) is
selected, the forwarding path is switched to PE1 -> P4 -> P3 -> PE2.
Figure 5-48 Scenario with both LDP-IGP synchronization and OSPF neighbor
relationship flapping suppression configured
Scenario with both bit-error-triggered protection switching and OSPF
neighbor relationship flapping suppression configured
If a link has a poor link quality, services transmitted along it may be adversely
affected. If bit-error-triggered protection switching is configured and the bit error
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 231
rate (BER) along a link exceeds a specified value, a bit error event is reported, and
65535 is used as the cost of the link, triggering route reselection. Consequently,
service traffic is switched to the backup link. If both bit-error-triggered protection
switching and OSPF neighbor relationship flapping suppression are configured,
they both take effect. The Hold-down mode takes precedence over the Hold-max-
cost mode, followed by the configured link cost.
5.2.2.6 OSPF Smart-Discover
Definition
Routers periodically send Hello packets through OSPF interfaces at the Hello
interval specified in the Hello timer. This fixed interval slows down the
establishment of OSPF neighbor relationships.
Enabling smart-discover can speed up establishment of OSPF neighbor
relationships in certain scenarios.
Table 5-14 OSPF smart-discover
Scenario Processing
Smart-discover is not
configured.
● Hello packets are sent only when the Hello
timer expires.
● Devices wait to receive Hello packets within
the Hello interval to establish neighbor
relationships.
Smart-discover is configured. ● Hello packets are sent directly regardless of
whether the Hello timer has expired.
● Devices receive packets without delay and
can immediately transmit their status to
establish neighbor relationships.
Principle
In the following scenarios, an interface with smart-discover enabled can send
Hello packets to target devices without waiting for the expiration of the Hello
timer:
● The neighbor status becomes 2-way for the first time.
● The neighbor status changes from 2-way or a higher state to Init.
5.2.2.7 OSPF Database Overflow
Definition
OSPF requires that routers in the same area have the same LSDB.
If the number of routes on a network increases, routers may fail to carry so much
routing information due to limited system resources. This is known as an OSPF
database overflow.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 232
Purpose
Configuring stub areas or NSSAs partially addresses database overflows. However,
stub areas or NSSAs fail to resolve the problem of an unexpected increase in
dynamic routes. To dynamically limit the LSDB capacity and thereby prevent
database overflows, you can set the maximum number of external LSAs allowed in
the LSDB.
Implementation
Setting the maximum number of non-default external routes on a router can
prevent database overflows.
All routers on an OSPF network must be configured with the same upper limit. If
the number of external routes on a router reaches the upper limit, the router
enters the overflow state and starts an overflow timer. The router automatically
exits the overflow state after the timer expires. By default, the timer value is 5
seconds.
Table 5-15 OSPF database overflow phases
Overflow Phase OSPF Processing
Entering the overflow
state
A router deletes all non-default external routes
generated by itself.
Staying in the overflow
state
● The router does not generate non-default
external routes.
● The router discards the newly received non-
default external routes, and does not reply with
LSAck packets.
● When the overflow timer expires, the router
checks whether the number of external routes
still exceeds the upper limit and performs the
following operations accordingly:
– If the number of external routes still exceeds
the upper limit, the router restarts the timer.
– If the number of external routes is less than
the upper limit, the router exits the overflow
state.
Exiting the overflow state ● The router resets the overflow timer.
● The router generates non-default routes.
● The router learns the newly received non-default
external routes, and replies with LSAck packets.
● The router prepares to enter the overflow state
in case of future occurrences.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 233
5.2.2.8 OSPF Mesh-Group
Definition
In scenarios with multiple concurrent links, you can deploy OSPF mesh-group to
classify links into a mesh group. This allows OSPF to flood LSAs to only one link
selected from the mesh group. OSPF mesh-group prevents repetitive flooding that
burdens the system.
The mesh-group feature is disabled by default.
Purpose
After receiving or generating an LSA, an OSPF process floods the LSA. If there are
multiple concurrent links, OSPF floods the LSA to each link and sends Update
messages. Flooding more than one LSA is unnecessary as only one is valid.
To prevent this unnecessary burden on the system, you can enable mesh-group to
classify multiple concurrent links between a router and its neighbor into a group
and then select a primary link for flooding.
Implementation
As shown in Figure 5-49, Router A and Router B are connected through three links
and establish an OSPF neighbor relationship. After receiving a new LSA from
interface 4, Router A floods the LSA to Router B through interfaces 1, 2, and 3.
This flooding causes an unnecessary load on the concurrent links.
Figure 5-49 LSA flooding with OSPF mesh-group disabled
If there are multiple concurrent links between a device with OSPF mesh-group
enabled and its neighbor, the device floods received LSAs only to the primary link,
as shown in Figure 5-50.
Figure 5-50 LSA flooding with OSPF mesh-group enabled
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 234
As defined in OSPF, LSAs can be flooded to a link only when the neighbor status
reaches Exchange or a higher state. When the status of the interface on the
primary link is lower than Exchange, OSPF reselects a primary link from
concurrent links for flooding LSAs. After receiving LSAs flooded by Router A
through link 1, Router B no longer floods the LSAs to Router A through link 2 and
link 3.
The Router ID of a neighbor uniquely identifies a mesh group. Interfaces
connected to the same neighbor with status higher than Exchange belong to the
same mesh group.
In Figure 5-51, a mesh group of Router A resides in Area 0, which contains the
links of interface 1 and interface 2. More than one neighbor of interface 3 resides
on the broadcast link. Therefore, interface 3 cannot be added to the mesh group.
Figure 5-51 Scenario where an interface cannot be added to a mesh group
NOTE
If a router with OSPF mesh-group enabled has the same router ID as its directly connected
neighbor, LSDBs cannot be synchronized and routes cannot be calculated correctly. In such
a scenario, you need to reconfigure the router ID of the neighbor. (The configuration with
the same router ID for two different devices is a configuration error.)
5.2.3 Association Between OSPF and Other Protocols
BFD for OSPF
Bidirectional Forwarding Detection (BFD) is a mechanism for detecting
communication faults between forwarding engines.
BFD detects the connectivity of a data protocol along a path between two
systems. Such a path can be a physical link, a logical link, or a tunnel.
BFD for OSPF allows BFD sessions to be associated with OSPF. If a BFD session
detects a link fault, it notifies OSPF of the fault, allowing OSPF to quickly respond
to the change in the network topology.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 235
Devices recalculate routes in the event of a link fault or a topology change.
Network performance is improved if the route convergence process of routing
protocols is completed faster.
As link faults are inevitable, rapidly detecting these faults and notifying routing
protocols is an effective way to quickly resolve such issues. BFD for OSPF speeds
up OSPF convergence if a fault occurs on the link between neighbors.
Table 5-16 Comparison before and after BFD for OSPF is enabled
BFD
Association
Link Fault Detection Condition Convergence
Speed
Disabled The OSPF dead timer expires. (The
default timeout interval is 40 seconds.)
Measured in
seconds
Enabled A BFD session goes Down. Measured in
milliseconds
Figure 5-52 shows the process of BFD for OSPF.
Figure 5-52 BFD for OSPF
1. OSPF neighbor relationships are established between SwitchA, SwitchB, and
SwitchC.
2. When the neighbor relationships enter the Full state, BFD is instructed to set
up a BFD session.
3. The outbound interface of the route from SwitchA to SwitchB is GE0/0/2. If
the link between SwitchA and SwitchB fails, BFD detects the fault and then
notifies SwitchA of the fault.
4. SwitchA processes the neighbor Down event, and recalculates routes.
Following recalculation, the outbound interface of the route from SwitchA to
SwitchB becomes GE0/0/1, with the route to SwitchB traversing SwitchC.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 236
OSPF-BGP Association
A device restart, or even a new device itself, may cause the loss of network traffic
during BGP route convergence. This happens because OSPF converges faster than
BGP.
The solution to this problem is association between OSPF and BGP.
If there is a backup link, BGP traffic is lost during traffic switchback because BGP
route convergence is slower than OSPF route convergence.
In Figure 5-53, SwitchA, SwitchB, SwitchC, and SwitchD are running OSPF and
have established IBGP connections. SwitchC functions as the backup of SwitchB.
When the network is stable, BGP and OSPF routes converge completely on the
devices.
Traffic from SwitchA to 10.3.1.0/30 normally passes through SwitchB. If SwitchB
becomes faulty, traffic is switched to SwitchC. After SwitchB recovers, traffic is
switched back to SwitchB.
During the switchback process, some packets are lost because OSPF route
convergence is faster than BGP route convergence. This means that the
convergence of OSPF routes is already complete while BGP routes are still
converging. As a result, SwitchB fails to learn the route to 10.3.1.0/30.
In this case, upon receipt of packets from SwitchA to 10.3.1.0/30, SwitchB discards
these packets.
Figure 5-53 OSPF-BGP association
A device with OSPF-BGP association enabled remains as a stub router in the
configured association period. The link metric in the LSAs advertised by the device
is set to the maximum value of 65535. In this way, the device instructs other OSPF
devices not to use it for data forwarding.
In Figure 5-53, OSPF-BGP association is enabled on SwitchB. SwitchA forwards
traffic to the backup device SwitchC before BGP route convergence on SwitchB is
complete.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 237
OSPF-LDP Association
On networks that use primary and backup links, OSPF-LDP association ensures
that, when a faulty primary link recovers, traffic interruptions are minimized.
As shown in Figure 5-54, the primary link travels along the path
PE1→P1→P2→P3→PE2, and the backup link travels along the path
PE1→P1→P4→P3→PE2.
If the primary link is faulty, traffic is switched to the backup link. When the
primary link recovers, traffic is switched back to the primary link, during which
traffic is interrupted for an extended period of time.
Figure 5-54 OSPF-LDP association
Synchronizing LDP and OSPF (IGP) on P1 and P2 can shorten the duration of
traffic interruption caused by traffic switchback to the primary link from seconds
to milliseconds.
Table 5-17 OSPF-LDP association
OSPF-LDP Association Traffic Interruption Time
Disabled Measured in seconds
Enabled Measured in milliseconds
OSPF-LDP association delays route switchback by suppressing the establishment
of OSPF neighbor relationships until LDP convergence is complete. Before an LSP
is established on the primary link, the backup link continues to forward traffic. The
backup link is then deleted following the LSP establishment on the primary link.
OSPF-LDP association involves three timers:
● Hold-down
● Hold-max-cost
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 238
● Delay
When the primary link recovers, a router responds as follows:
1. Starts the Hold-down timer. The OSPF interface does not establish OSPF
neighbor relationships but waits for the establishment of an LDP session. The
hold-down timer specifies the period that the OSPF interface waits.
2. Starts the Hold-max-cost timer after the Hold-down timer expires. The Hold-
max-cost timer specifies the interval for advertising the maximum link metric
of the interface in LSAs to the primary link.
3. Starts the Delay timer to wait for the establishment of an LSP after an LDP
session is re-established on the primary link.
4. Enables LDP to notify OSPF that synchronization is complete regardless of the
OSPF status after the Delay timer expires.
5.3 Application Scenarios for OSPF
5.3.1 OSPF GR
In Figure 5-55, RouterA, RouterB, RouterC, and RouterD run OSPF for
interworking, and RouterA and RouterB have GR enabled. When RouterA restarts,
RouterB helps RouterA perform GR, without notifying other neighbors of RouterA.
OSPF GR ensures service continuity.
Figure 5-55 OSPF GR
5.3.2 OSPF GTSM
In Figure 5-56, OSPF runs between routers, and GTSM is enabled on RouterC. The
valid TTL ranges of the packets sent from routers to RouterC are as follows:
● For RouterA and RouterE (which are neighbors of RouterC): (255 – hops + 1)
to 255.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 239
● For RouterB, RouterD, and RouterF: 254 to 255, 253 to 255, and 252 to 255,
respectively.
Figure 5-56 OSPF GTSM
5.4 OSPF Deployment Guide
5.4.1 OSPF Network Planning and Design
OSPF Network Stability: Router ID Design
Router ID selection is the first task in OSPF network design and implementation.
As a link-state routing protocol, OSPF calculates routes based on LSAs. All OSPF
routers on an OSPF network send and flood LSAs to the entire network. In this
way, each OSPF router on the network collects LSAs received from other routers,
saves the LSAs in its LSDB, and uses an SPF algorithm to calculate an SPT to other
networks with itself as the root. Therefore, ensuring the stability of the LSDB on
each OSPF router is a prerequisite for ensuring the stability of the OSPF network.
In an LSDB, LSAs received from different OSPF routers are distinguished by router
ID. If the router ID of a router changes, the router floods its LSAs again. As a
result, all the other OSPF routers on the network update their LSDBs and perform
SPF calculation again, leading to OSPF network flapping. Therefore, selecting
stable router IDs is the first task in OSPF network design.
Router IDs can be configured manually. If no router ID is specified for a router, the
system automatically selects an interface IP address as the router's router ID. The
router ID selection rules are as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 240
1. The router preferentially selects the largest IP address among loopback
interface addresses as the router ID.
2. If no loopback interface is configured, the router selects the largest IP address
among interface addresses as the router ID.
3. The router reselects a router ID only when the interface address used as the
router ID is deleted or changed.
On actual networks, it is recommended that router IDs of OSPF routers be
specified manually. First, plan a private network segment such as 192.168.1.0/24
for router ID selection. Before starting the OSPF process, create a loopback
interface on each OSPF router, and use a private IP address with a 32-bit mask as
the IP address of the loopback interface. The private IP address is then used as the
router's router ID. If there is no special requirement, the address of this loopback
interface does not need to be advertised to the OSPF network.
Hierarchical Network Design: OSPF Area Design
OSPF is a network protocol that requires hierarchical design. The concept of area
is used on an OSPF network. From a hierarchical perspective, areas on an OSPF
network are classified into backbone and non-backbone areas. The ID of the
backbone area is 0 and that of a non-backbone area is in the range 1 to
4294967295. An OSPF router on the border between the backbone area and a
non-backbone area is called ABR.
Actually, OSPF area design is the process of classifying OSPF routers on the
network. The first consideration in OSPF area design is the network scale. You can
only plan the backbone area for small networks such as a network with several
routers as the core and aggregation devices. However, hierarchical network design
is required on large OSPF networks.
For large OSPF networks, the core, aggregation, and access layers must be
planned in OSPF area design. In addition, OSPF backbone routers are generally
egress routers and core switches. These devices are typically high-end routing
devices such as Huawei NE series high-end routers and Huawei S series modular
switches. Non-backbone area design depends on the geographical locations and
device performance. If many low-end Layer 3 switching devices with product
positioning and performance limitations are deployed in a non-backbone area, the
number of routes should be minimized using small-sized areas or special areas.
The IDs of non-backbone areas on an actual network should not be planned
randomly. Consecutive IDs such as 1, 2, and 3 are not recommended. It is
recommended that IDs in ascending order such as 10, 20, and 30 be used,
facilitating area ID addition in future network capacity expansion.
Routing Entry Optimization for Non-Backbone Areas: Special Areas
Using special areas can optimize routing entries on routers in non-backbone areas.
Generally, the number of routing entries on routers in a non-backbone area needs
to be reduced in the following scenarios:
● The non-backbone area has only one ABR as the egress router and all traffic
for accessing external areas needs to pass through this egress router. In this
case, non-ABR routers in this non-backbone area do not need to obtain
detailed information about external areas, and only an egress is required to
send traffic outside this area.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 241
● Low-end Layer 3 switches are deployed in the non-backbone area and their
routing tables cannot contain too many routing entries due to performance
limitations. Special areas can be configured to reduce the number of routing
entries on the devices.
Switches support four types of special areas defined in OSPF: stub area, totally
stub area, NSSA, and totally NSSA.
In most cases, routers in non-backbone areas on a typical OSPF network only need
to know the outbound interface of the default route. Therefore, it is recommended
that non-backbone areas be planned as totally NSSAs. This can significantly
reduce the number of routing entries on internal routers in the non-backbone
areas and the number of OSPF packets to be exchanged among these routers. For
some networks with special requirements, the four types of special areas can be
used flexibly based on actual requirements.
Routing Entry Optimization for the Backbone Area: IP Subnetting and Route
Summarization in Non-Backbone Areas
Because routers in the backbone area are responsible for route exchange among
areas, these routers have large routing tables. You can properly plan IP subnets for
non-backbone areas and summarize routes on the routers residing on area
borders to optimize routing entries on routers in the backbone area.
It is recommended that an IP network facilitating route summarization be used as
a new OSPF network, and that IP addresses be planned again for expanded OSPF
networks. Route summarization can reduce the number of routing entries in the
routing tables of routers in the backbone area and the number of OSPF packets to
be exchanged among these routers. After routes are summarized, a single-point
link failure or network flapping will not affect route update on the entire network.
Therefore, route summarization also improves the network stability.
Uplink Traffic Diversion: Default OSPF Route Import and Route Selection
Optimization
Most service traffic on a large OSPF network is not transmitted inside the
network, but is forwarded to the Internet egress. Therefore, default route design is
a key design point for an OSPF network.
An actual OSPF network may have more than one egress. Configuring multiple
links to load balance egress traffic is a difficult task in OSPF network design.
Although there are many load balancing methods, the most simple and secure
method is to use the internal route selection mechanism of OSPF. An OSPF router
determines whether a route is optimal by calculating its cost, and preferentially
adds a route with a smaller cost to its routing table. Therefore, you can adjust the
costs of OSPF interfaces to make a router select different outbound interfaces for
load balancing.
OSPFv2 was developed earlier and rapid bandwidth development was not
considered at that time. By default, the reference bandwidth for OSPF cost
calculation is 100 Mbit/s. Therefore, by default, OSPF considers that the cost of an
interface with bandwidth greater than 100 Mbit/s is 1. The reference bandwidth is
outdated because the network backbone bandwidth develops towards 10 Tbit/s.
Switches provide the function of changing the reference bandwidth. In OSPF
network construction, you can run the bandwidth-reference command to
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 242
configure a proper reference bandwidth. In summary, to optimize route selection
on an OSPF network, you are advised to select a proper reference bandwidth to
adjust the costs of OSPF interfaces.
Loop Prevention in Route Summarization Scenarios: Blackhole Route
Route summarization can reduce the number of routes and improve the network
stability in many scenarios. However, routing loops may occur in route
summarization. Blackhole routes can solve this problem. A router discards packets
that match a blackhole route, and does not send any error information to the
packet sender. Therefore, route summarization and blackhole routes are often
used together in OSPF network design.
OSPF Network Security: Silent Interface
Security must be the first consideration for large OSPF networks. In OSPF network
design, OSPF packets are often prohibited from being sent to users, preventing
end users from obtaining OSPF packet information. If a user can intercept OSPF
packets, the user will know how to connect to the OSPF network, making the
OSPF network prone to attacks or damages. For example, if the user connects a
router to the OSPF network and makes the router's OSPF process unstable, the
OSPF network will flap or even break down.
To ensure security and stability of an OSPF network, it is recommended that silent
interfaces be configured on edge devices of the OSPF network to prevent OSPF
packets from being sent to users. These silent interfaces are prohibited from
receiving and sending OSPF packets. These interfaces can still advertise direct
routes, but cannot establish neighbor relationships because Hello packets are
blocked on the interfaces.
5.4.2 OSPF Network Design Deployment Case
Figure 5-57 shows a typical campus network topology. This is a large campus
network with the core, aggregation, and access layers and multiple egresses to the
Internet. On this network, dual-link redundancy and cluster protection among core
and aggregation switches have been deployed. Typically, on such a large campus
network, Huawei NE series high-end routers are deployed as egress devices, and
Huawei campus cluster-supporting modular switches are deployed as core and
aggregation switches. User gateways are deployed on the aggregation layer, and
aggregation switches are the boundary between Layer 2 and Layer 3 networks.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 243
Figure 5-57 Typical campus network topology
Core and aggregation switches on the typical campus network are deployed in
clusters, and one cluster functions as a single logical device. Multiple links are
bundled together to form a single logical link. The above network topology is
simplified into a logical topology, as shown in Figure 5-58. There may be multiple
buildings in a campus network, and the following example uses three buildings.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 244
Figure 5-58 Logical topology of a typical campus network
OSPF Network Stability: Router ID Design
The primary task of deploying OSPF is to design and deploy router IDs. In most
situations, an appropriate private IP address segment can be used to design router
IDs. This example uses IP addresses on the IP address segment 10.0.0.0/24 as
router IDs.
After router IDs are designed, you need to create loopback interfaces on each
OSPF device and configure an IP address 10.0.0.X/32 for each loopback interface.
The following configures router IDs for a core modular switch cluster:
[HUAWEI] interface LoopBack 0
[HUAWEI-LoopBack0] ip address 10.0.0.3 32 //Configure an IP address with a 32-bit mask for LoopBack0.
[HUAWEI-LoopBack0] quit
[HUAWEI] ospf 1 router-id 10.0.0.3 //Create OSPF process 1 and set the router ID to 10.0.0.3.
NOTE
If there are no special requirements, advertisement of the IP address of Loopback0 into
OSPF processes is not recommended because the advertisement is unnecessary.
Figure 5-59 shows the network topology with router IDs designed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 245
Figure 5-59 Network topology with router IDs designed
Hierarchical Network Design: OSPF Area Design
After router IDs are assigned to routers, you need to partition the OSPF network.
To obtain a hierarchical OSPF network, you can deploy egress routers and core
switches in Area 0 and design non-backbone areas based on geographical
locations. When designing area IDs for non-backbone areas, you need to ensure
that new areas are easy to add for network expansion. Based on geographical
locations involved in this case, egress routers and core switches are deployed in
the backbone area and the aggregation switches in each building are deployed in
a non-backbone area respectively. Figure 5-60 shows the OSPF network topology
after area partitioning.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 246
Figure 5-60 OSPF network topology after area partitioning
The following configures Area 0 and Area 10 for the core switch cluster:
[HUAWEI] ospf 1 //Enter the OSPF process view.
[HUAWEI-ospf-1] area 0 //Enter the view of Area 0.
[HUAWEI-ospf-1-area-0.0.0.0] network 10.200.10.0 0.0.0.3 //Advertise the network segment where the
uplink interface resides to Area 0.
[HUAWEI-ospf-1-area-0.0.0.0] network 10.200.20.0 0.0.0.3 //Advertise the network segment where the
uplink interface resides to Area 0.
[HUAWEI-ospf-1-area-0.0.0.0] quit
[HUAWEI-ospf-1] area 10 //Enter the view of Area 10.
[HUAWEI-ospf-1-area-0.0.0.10] network 10.100.10.0 0.0.0.3 //Advertise the network segment where the
downlink interface resides to Area 10.
[HUAWEI-ospf-1-area-0.0.0.10] quit
The preceding configuration commands show that an OSPF device is located on
the border between OSPF areas. The uplink and downlink interfaces of the core
switch cluster in the topology belong to Area 0 and Area 10 respectively. That is,
this cluster functions as an ABR.
NOTE
It is a bad design to deploy many low-end routers or Layer 3 switches in a single OSPF area,
and it is better to reduce the number of devices in a single OSPF area.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 247
Routing Entry Optimization for Non-Backbone Areas: Special Areas
After the OSPF network is partitioned into multiple areas, you may find that the
routing table size of devices in non-backbone areas is large. If devices in non-
backbone areas have low performance and are expected not to maintain a large
routing table, you can use special areas to reduce the number of routing entries in
the table. Figure 5-61 shows the network topology with all non-backbone areas
configured as totally NSSAs.
Figure 5-61 Network topology with non-backbone areas configured as totally
NSSAs
The following provides an example of configuring totally NSSAs by configuring a
core switch cluster and an aggregation switch cluster in Area 10.
The configuration of the core switch cluster is as follows:
[HUAWEI] ospf 1 //Enter the OSPF process view.
[HUAWEI-ospf-1] area 10 //Enter the view of Area 10.
[HUAWEI-ospf-1-area-0.0.0.10] nssa no-summary //Configure nssa no-summary for the ABR.
[HUAWEI-ospf-1-area-0.0.0.10] quit
The configuration of the aggregation switch cluster is as follows:
[HUAWEI] ospf 1 //Enter the OSPF process view.
[HUAWEI-ospf-1] area 10 //Enter the view of Area 10.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 248
[HUAWEI-ospf-1-area-0.0.0.10] nssa //Configure nssa for the non-ABR.
[HUAWEI-ospf-1-area-0.0.0.10] quit
Before a totally NSSA is configured, routing entries from the aggregation switch
cluster to non-backbone areas are as follows:
<HUAWEI> display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 21 Routes : 21
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.0.0.4/32 Direct 0 0 D 127.0.0.1 LoopBack0
10.10.1.0/24 Direct 0 0 D 10.10.1.1 Vlanif100
10.10.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif100
10.10.2.0/24 Direct 0 0 D 10.10.2.1 Vlanif200
10.10.2.1/32 Direct 0 0 D 127.0.0.1 Vlanif200
10.10.3.0/24 Direct 0 0 D 10.10.3.1 Vlanif300
10.10.3.1/32 Direct 0 0 D 127.0.0.1 Vlanif300
10.20.1.0/24 OSPF 10 3 D 10.100.10.1 Vlanif10
10.20.2.0/24 OSPF 10 3 D 10.100.10.1 Vlanif10
10.20.3.0/24 OSPF 10 3 D 10.100.10.1 Vlanif10
10.30.1.0/24 OSPF 10 3 D 10.100.10.1 Vlanif10
10.30.2.0/24 OSPF 10 3 D 10.100.10.1 Vlanif10
10.30.3.0/24 OSPF 10 3 D 10.100.10.1 Vlanif10
10.100.10.0/30 Direct 0 0 D 10.100.10.2 Vlanif10
10.100.10.2/32 Direct 0 0 D 127.0.0.1 Vlanif10
10.100.20.0/30 OSPF 10 2 D 10.100.10.1 Vlanif10
10.100.30.0/30 OSPF 10 2 D 10.100.10.1 Vlanif10
10.200.10.0/30 OSPF 10 2 D 10.100.10.1 Vlanif10
10.200.20.0/30 OSPF 10 2 D 10.100.10.1 Vlanif10
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
After a totally NSSA is configured, routing entries from the aggregation switch
cluster to non-backbone areas are as follows:
<HUAWEI> display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 12 Routes : 12
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 OSPF 10 2 D 10.100.10.1 Vlanif10
10.0.0.4/32 Direct 0 0 D 127.0.0.1 LoopBack0
10.10.1.0/24 Direct 0 0 D 10.10.1.1 Vlanif100
10.10.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif100
10.10.2.0/24 Direct 0 0 D 10.10.2.1 Vlanif200
10.10.2.1/32 Direct 0 0 D 127.0.0.1 Vlanif200
10.10.3.0/24 Direct 0 0 D 10.10.3.1 Vlanif300
10.10.3.1/32 Direct 0 0 D 127.0.0.1 Vlanif300
10.100.10.0/30 Direct 0 0 D 10.100.10.2 Vlanif10
10.100.10.2/32 Direct 0 0 D 127.0.0.1 Vlanif10
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
The preceding outputs show that the IP routing table size of Area 10 is reduced
significantly after a totally NSSA is configured. This indicates that configuring a
non-backbone area as a totally NSSA can reduce the routing table size.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 249
Routing Entry Optimization for the Backbone Area: IP Subnetting and Route
Summarization in Non-Backbone Areas
After non-backbone areas are configured as totally NSSAs, the routing table size
of routers in non-backbone areas are reduced significantly and the amount of
information to be exchanged between these routers is also reduced. Reduced
routing table size and information exchange are also required in the backbone
area. To implement this requirement, you need to use IP subnetting and perform
route summarization on ABRs in non-backbone areas.
Figure 5-62 shows summarized routes advertised from Area 10 to Area 0 after IP
subnetting is performed.
Figure 5-62 Using route summarization to optimize routing entries in the
backbone area
Route summarization will prevent specific routes from being advertised. The ABR
in Area 10 advertises only one summarized route 10.10.0.0/16 into Area 0,
reducing the routing entries on the backbone routers and number of OSPF packets
to be exchanged with Area 0 and ensuring the routing table stability. Proper IP
addressing facilitating route summarization is recommended during OSPF network
design.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 250
The following configures route summarization on the ABR (core switch cluster) in
Area 10:
[HUAWEI] ospf 1 //Enter the OSPF process view.
[HUAWEI-ospf-1] area 10 //Enter the view of Area 10.
[HUAWEI-ospf-1-area-0.0.0.10] abr-summary 10.10.0.0 255.255.0.0 //Summarize routes on the ABR.
[HUAWEI-ospf-1-area-0.0.0.10] quit
NOTE
The abr-summary command can be configured only on an ABR. Do not configure this
command on non-ABRs in an area. Otherwise, incorrect routing entries will be generated.
Before routes are summarized, the IP routing table of NE40E-1 is as follows:
<NE40E-1> display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 12 Routes : 12
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.0.0.1/32 Direct 0 0 D 127.0.0.1 LoopBack0
10.10.1.0/24 OSPF 10 3 D 10.200.10.2 GigabitEthernet0/0/1
10.10.2.0/24 OSPF 10 3 D 10.200.10.2 GigabitEthernet0/0/1
10.10.3.0/24 OSPF 10 3 D 10.200.10.2 GigabitEthernet0/0/1
After routes are summarized, the IP routing table of NE40E-1 is as follows:
<NE40E-1> display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 12 Routes : 12
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.0.0.1/32 Direct 0 0 D 127.0.0.1 LoopBack0
10.10.0.0/16 OSPF 10 3 D 10.200.10.2 GigabitEthernet0/0/1
The preceding outputs show that NE40E-1 in the backbone area has specific
routes to users' network segments before routes are summarized. After route
summarization is configured on the ABR, NE40E-1 has only one summarized route
with a 16-bit mask to users' network segments. If there are many user network
segments, route summarization can significantly reduce routing entries in the
backbone areas, decrease the number of LSAs to be exchanged between the
backbone and non-backbone areas, and therefore improve the network stability.
Uplink Traffic Diversion: Default OSPF Route Import and Route Selection
Optimization
Most traffic of a campus network is destined for the Internet. Therefore, on a
campus network with multiple egresses, you must consider importing default
routes and load balancing traffic among these egresses.
Multiple methods are available to import default routes. The recommended
method is to configure non-forcible delivery of default routes on an ASBR. Non-
forcible delivery of default routes indicates that a default route can be advertised
only when it exists in the IP routing table of this ASBR. This prevents loops and
suboptimal routes in special scenarios.
In Figure 5-63, after two ASBRs advertise default routes, the core switch cluster
receives two default routes with their next hops pointing to two egress routers
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 251
respectively. The core switch cluster can choose one link as the uplink or two
uplinks for load balancing. You can flexibly configure traffic direction based on
network requirements.
Figure 5-63 Using default routes for uplink traffic direction on the core switch
cluster
The following configures non-forcible delivery of default routes on NE40E-1 (the
configuration of NE40E-2 is similar to that of NE40E-1):
[NE40E-1] ip route-static 0.0.0.0 0.0.0.0 1.1.1.1 //On NE40E-1, configure a default route with the next
hop pointing to the public address of the telecom carrier.
[NE40E-1] ospf 1 //Enter the OSPF process view.
[NE40E-1-ospf-1] default-route-advertise //Advertise the default route without specifying the always
parameter. That is, the default route is delivered non-forcibly.
After the preceding configurations are complete, the core switch cluster learns two
equal-cost default routes. Uplink traffic of the core switch cluster will be
forwarded in load balancing mode.
<HUAWEI> display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 23 Routes : 24
Destination/Mask Proto Pre Cost Flags NextHop Interface
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 252
0.0.0.0/0 O_ASE 150 1 D 10.200.10.1 Vlanif40
O_ASE 150 1 D 10.200.20.1 Vlanif50
......
If you want two uplinks of the core switch cluster to work in active/standby mode,
the simplest method is to change their OSPF costs.
To implement route backup, you can change the OSPF cost of the link from the
core switch cluster to NE40-2 to be higher than that of the link from the cluster to
NE40-1. In this way, uplink traffic is preferentially sent to NE40E-1. If NE40E-1 is
faulty, the traffic is automatically switched to NE40E-2.
Configure the core switch cluster.
[HUAWEI] interface vlanif 50 //Enter the OSPF interface view.
[HUAWEI-Vlanif50] ospf cost 10 //Change the OSPF cost of this interface to 10.
Configure NE40E-2.
[NE40E-2] interface gigabitethernet 0/0/1 //Enter the OSPF interface view.
[NE40E-2-GigabitEthernet0/0/1] ospf cost 10 //Change the OSPF cost of this interface to 10.
NOTE
To adjust the cost of a link to affect OSPF route selection, you need to adjust the cost on
the devices on both ends of the link. Otherwise, asymmetric routing occurs, which causes
network faults.
The default OSPF cost of links providing more than 100 Mbit/s bandwidth is 1.
After the OSPF cost of the link from the core switch cluster to NE40-2 is changed
to 10, the cluster transmits its uplink traffic preferentially to NE40-1, and the IP
routing table of the cluster has only one default route pointing to NE40E-1.
<HUAWEI> display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 23 Routes : 23
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 O_ASE 150 1 D 10.200.10.1 Vlanif40
......
Loop Prevention in Route Summarization Scenarios: Blackhole Route
After the preceding design and deployment, this campus network has basic OSPF
functions and routing entries have been optimized. However, this network has the
risk of loops due to route summarization.
It is common that a campus network is under internal network attacks. Assume
that a host in Building 1 is attacked by viruses, which will make the host access all
IP addresses on the network segment 10.0.0.0. In this situation, a loop may easily
occur.
If the host accesses the IP address 10.10.50.1 (this address does not exist in
Building 1), a routing loop occurs:
1. When the host sends a packet, the packet is sent to its gateway, namely,
aggregation switch cluster 1 in Building 1.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 253
2. Aggregation switch cluster 1 does not have specific routes to the destination
address of this packet, and therefore it sends this packet to the core switch
cluster through a default route.
3. The IP address 10.10.50.1 does not exist on the entire campus network.
Therefore, after the packet reaches the core switch cluster, it matches only a
default route and then is sent to NE40E-1.
4. The route learned by NE40E-1 is summarized and then advertised by the core
switch cluster, so the packet matches the route 10.10.0.0/16 and is sent back
to the core switch cluster.
A routing loop occurs between the core switch cluster and NE40E-1, as shown in
Figure 5-64. This loop will seriously affect network operation and even cause
network crash. Therefore, you need to avoid routing loops in route summarization
scenarios.
Figure 5-64 Routing loop
The main reason for this routing loop is that the core switch cluster uses a default
route to forward a packet with a destination address that does not exist in the
campus network to the backbone area, and then the backbone area sends the
packet back to the cluster through a summarized return route.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 254
To address this problem, you need to configure a blackhole route on the core
switch cluster to block such a packet. Perform the following configuration:
[HUAWEI] ip route-static 10.10.0.0 255.255.0.0 NULL0
After a blackhole route is configured, the packet to be returned to the network
segment 10.10.0.0 will be directed to the user network segment through a specific
route. If such specific route is not found, this host address does not exist in the
campus network. The packet will match this blackhole route and be dropped to
prevent routing loops. When configuring route summarization in other areas, you
also need to configure a blackhole route to prevent routing loops.
OSPF Network Security: Silent Interface
After the preceding deployment is completed, the entire OSPF network can run
properly. However, this network has a large security vulnerability. That is, user-side
interfaces can receive OSPF Hello packets, so basic network information can be
easily obtained using a network sniffing tool for attack launch.
To ensure OSPF network security, you are advised to configure silent interfaces to
block OSPF packets sent to users, as shown in Figure 5-65.
Figure 5-65 Configuring silent interfaces to block OSPF packets sent to users
The following configures silent interfaces in core switch cluster 1 in Area 10:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 255
[HUAWEI] ospf 1
[HUAWEI-ospf-1] silent-interface vlanif100
[HUAWEI-ospf-1] silent-interface vlanif200
[HUAWEI-ospf-1] silent-interface vlanif300
NOTE
The silent-interface command prohibits specified interfaces from receiving and sending
OSPF packets and is typically configured on user-side interfaces. Configuring this command
on the link between two OSPF routers will cause a failure to establish an OSPF neighbor
relationship between them.
5.5 Summary of OSPF Configuration Tasks
This section provides a summary of OSPF configuration tasks. Perform
configurations according to your particular requirements.
Table 5-18 describes OSPF configuration tasks.
Table 5-18 OSPF configuration tasks
Scenario Description Task
Configuring Basic OSPF
Functions
Basic OSPF functions must be
configured before other OSPF
functions can be implemented.
5.8
Configuring
Basic OSPF
Functions
5.9
Configuring
Session
Parameters
for OSPF
Neighbor or
Adjacency
Relationshi
ps
5.10
Configuring
OSPF
Attributes
on Different
Types of
Networks
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 256
Scenario Description Task
Configuring OSPF Areas ● In a stub area, an area border
router (ABR) does not transmit
autonomous system (AS) external
routes, reducing route entries on
the ABR as well as the amount of
routing information to be
transmitted.
● An NSSA is a special type of OSPF
area. Similar to a stub area, an
NSSA does not transmit external
routes from other areas. Different
from a stub area, an NSSA imports
AS external routes and transmits
them in the entire AS (a stub area
does not import AS external
routes).
5.11
Configuring
OSPF Stub
Areas
5.12
Configuring
an OSPF
NSSA
Configuring OSPF Local-
MT
You can enable OSPF local multicast
topology (Local-MT) to allow TE
tunnel spanned devices to generate
multicast forwarding entries.
5.13
Configuring
Local MT
Adjusting OSPF Route
Selection
To implement flexible application of
OSPF on the live network, you can
adjust OSPF parameters to control
OSPF routing.
5.14
Adjusting
OSPF Route
Selection
Controlling OSPF
Routing Information
To implement network requirements,
you can configure OSPF parameters
to control advertisement and receipt
of OSPF routes.
5.15
Controlling
OSPF
Routing
Information
Controlling the
Convergence Speed of
OSPF Routes
You can increase the convergence
speed of OSPF routes to enable OSPF
to quickly respond to changes in the
network topology, or reduce the
convergence speed to decrease the
impact caused by route flapping over
OSPF networks and relieve loads on
devices.
5.18
Configuring
OSPF Fast
Convergenc
e
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 257
Scenario Description Task
Improving Reliability of
an OSPF Network
● If you configure BFD for OSPF in a
process or on an interface, the link
status can be rapidly detected.
This allows fault detection to
complete in milliseconds, speeding
up OSPF convergence.
● To avoid traffic interruption and
route flapping caused by standby/
active switchovers, you can
configure OSPF GR.
5.16
Configuring
BFD for
OSPF
5.19
Configuring
OSPF GR
Improving Stability of an
OSPF Network
You can improve the stability of an
OSPF network to reduce route
flapping on the network. This enables
the devices to work in a normal state
for an extended period of time.
5.20
Improving
Stability of
an OSPF
Network
Improving the Security of
an OSPF Network
In an OSPF network demanding high
security, you can configure OSPF
authentication and GTSM to improve
the network security.
5.21
Improving
the Security
of an OSPF
Network
5.6 Licensing Requirements and Limitations for OSPF
Involved Network Elements
Other network elements are required to support OSPF.
Licensing Requirements
OSPF is a basic feature of a switch and is not under license control.
Feature Support in V200R024C00
All models of S300, S500, S2700, S5700, and S6700 series switches (except the
S5751-L, S5731-L and S5731S-L) support OSPF.
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 258
Feature Limitations
None.
5.7 Default Settings for OSPF
Table 5-19 describes the default settings for OSPF.
Table 5-19 Default settings for OSPF
Parameter Default Setting
OSPF Disabled
Interval for sending Hello
packets
10 seconds on P2P and broadcast interfaces; 30
seconds on P2MP and NBMA interfaces
Dead interval after which
an OSPF neighbor
relationship expires
40 seconds on P2P and broadcast interfaces; 120
seconds on P2MP and NBMA interfaces
Period during which a
device acts as a stub router
500 seconds
Bandwidth reference value
used to calculate a link cost
100 Mbit/s
5.8 Configuring Basic OSPF Functions
Applicable Environment
When OSPF is configured on multiple switches in the same area, most
configuration data, such as the timer, filter, and aggregation, must be planned
uniformly by area. Incorrect configurations may prevent neighboring switches from
exchanging information or even cause routing information congestion and self-
loops.
OSPF configurations performed in interface views take effect regardless of
whether OSPF is enabled. These configurations remain in place even if OSPF is
disabled.
Pre-configuration Tasks
Before configuring basic OSPF functions, configure IP addresses for interfaces to
ensure that neighboring nodes are reachable at the network layer.
5.8.1 Creating an OSPF Process
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 259
Context
To run OSPF, each switch must have a router ID. A router ID is a 32-bit unsigned
integer, uniquely identifying a switch in an AS. To ensure the stability of OSPF,
manually plan and configure a unique router ID for each device.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id | router-id
router-id | vpn-instance
vpn-instance-name ] *
An OSPF process is created, and the OSPF view is displayed.
● The parameter
process-id specifies the ID of an OSPF process. The default
value is 1.
The switch supports OSPF multi-process. You can create different processes
for different types of services. An OSPF process ID is of local significance.
Different switches can exchange packets even if they have different process
IDs.
● The parameter router-id
router-id specifies the router ID of a switch.
By default, the system automatically selects the largest IP address among
loopback interface addresses as its router ID. The router ID of each device in
an AS must be unique. Using an interface IP address as a router ID is
recommended.
NOTE
The router ID of each OSPF process must be unique on the OSPF network; otherwise,
the OSPF neighbor relationship cannot be set up and routing information is incorrect.
Configuring a unique router ID for each OSPF process on each OSPF device is
recommended to ensure stability.
● The parameter vpn-instance
vpn-instance-name specifies the name of a VPN
instance.
If a VPN instance is specified, the OSPF process belongs to that VPN instance;
otherwise, the OSPF process belongs to a public network instance.
----End
5.8.2 Creating an OSPF Area
Context
Each device on an OSPF network must maintain an LSDB. The size of the LSDB
increases as more devices are deployed on the network, which can become a
burden. OSPF solves this problem by partitioning an AS into areas. An area is a
logical device group identified by an area ID. The borders of an area are devices
rather than links. Each OSPF interface must belong to an area, meaning that a link
(or network segment) belongs to only one area.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 260
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id | router-id
router-id | vpn-instance
vpn-instance-name ] *
An OSPF process is created, and the OSPF view is displayed.
Step 3 Run area
area-id
An OSPF area is created, and the OSPF area view is displayed.
The area with ID 0 is the backbone area, which is responsible for forwarding inter-
area routing information. Routing information between non-backbone areas must
be forwarded through the backbone area.
----End
5.8.3 Enabling OSPF
Context
After creating an OSPF process, you need to configure the network segments to
which the IP addresses of OSPF interfaces belong in an area. Each interface that
runs OSPF must belong to an area, meaning that a network segment can belong
to only one area.
OSPF checks the network mask carried in received Hello packets. If the network
mask carried in such a packet is different from that of the local device, OSPF
discards the Hello packet and does not establish any OSPF neighbor relationship.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run area
area-id
The OSPF area view is displayed.
OSPF can be enabled in an OSPF area or on a specific interface.
● Enable OSPF in an OSPF area.
1. Run network
ip-address wildcard-mask
A network segment belonging to an area is configured.
OSPF can run on an interface only when the following conditions are met:
– The IP address mask length of the interface is greater than or equal to
the mask length converted from the wildcard mask specified in the
network command.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 261
– The primary IP address of the interface resides in the network segment
specified in the network command.
By default, OSPF advertises the IP address of a loopback interface as a 32-bit
host route, which is independent from the mask length configured on the
loopback interface. To advertise routes to the network segment where the
loopback interface resides, configure the network type as NBMA or broadcast
in the interface view. For details, see Configuring Network Types for OSPF
Interfaces.
● Enable OSPF on a specific interface.
1. Run interface
interface-type interface-number
The interface view is displayed.
2. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
3. Run ospf enable [
process-id ] area
area-id
OSPF is enabled on the interface.
A decimal integer or an IPv4 address in dotted-decimal notation can be
entered as the area ID, but the area ID is displayed always as an IPv4 address
in dotted-decimal notation.
----End
5.8.4 (Optional) Creating OSPF Virtual Links
Context
After OSPF areas are defined, OSPF route updates between non-backbone areas
are transmitted through the backbone area. OSPF requires that all non-backbone
areas maintain connectivity with the backbone area and that the backbone areas
in different OSPF areas also maintain connectivity with each other. However, this is
not true in some cases due to certain restrictions. To resolve this problem, you can
configure OSPF virtual links.
Perform the following steps on a switch running OSPF.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 262
Step 3 Run area
area-id
The OSPF area view is displayed.
Step 4 Run vlink-peer
router-id [ smart-discover | hello
hello-interval | retransmit
retransmit-interval | trans-delay
trans-delay-interval | dead
dead-interval |
[ simple [ plain
plain-text | [ cipher ]
cipher-text ] | { md5 | hmac-md5 | hmac-
sha256 } [
key-id { plain
plain-text | [ cipher ]
cipher-text } ] | authentication-
null | keychain
keychain-name ] ] *
A virtual link is created.
The vlink-peer (OSPF area) command must also be configured on the
neighboring switch.
NOTICE
If plain is selected, the password is stored in plaintext in the configuration file. For
security purposes, you are advised to select cipher so that the password is stored
in ciphertext.
Simple authentication, MD5 authentication and HMAC-MD5 authentication have
potential security risks. Therefore, HMAC-SHA256 authentication is recommended.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support the keychain
keychain-name parameter.
----End
Follow-up Procedure
Devices from different vendors may use different default MTUs. Therefore, after
virtual links are created, the MTU needs to be set to the default value 0 for
interfaces to send DD packets, which ensures the compatibility. For details, see
Configuring an Interface to Fill in the DD Packet with the Actual MTU.
5.8.5 (Optional) Restricting the Flooding of LSA Packets
Context
If there are multiple neighboring switches or a large number of LSA packets are
flooded, a neighboring switch may be inundated with LSA packets and become
overwhelmed processing them. This may cause the neighboring switch to discard
Hello packets that are used to maintain the OSPF neighbor relationships, resulting
in interruptions to the neighbor relationships. More packets need to be exchanged
to reestablish the neighbor relationships, which further increases the possibility of
neighbor relationship interruptions. To resolve this problem, you can restrict the
flooding of LSA packets.
Perform the following steps on a switch running OSPF.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 263
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run flooding-control [ number
transmit-number | timer-interval
transmit-
interval ] *
The flooding of LSA packets is restricted.
By default, 50 LSA packets can be flooded at an interval of 30 ms.
The flooding-control command takes effect immediately after execution.
If the flooding-control command is not run, flooding of LSA packets is
automatically restricted when the number of neighboring switches exceeds 256.
----End
5.8.6 Verifying the Basic OSPF Function Configuration
Prerequisites
All configurations of basic OSPF functions are complete.
Procedure
● Run the display ospf [
process-id ] peer command in any view to check
information about OSPF neighbors.
● Run the display ospf [
process-id ] interface command in any view to check
information about OSPF interfaces.
● Run the display ospf [
process-id ] routing command in any view to check
information about an OSPF routing table.
● Run the display ospf [
process-id ] lsdb command in any view to check
information about an OSPF LSDB.
----End
5.9 Configuring Session Parameters for OSPF Neighbor
or Adjacency Relationships
Pre-configuration Tasks
On an OSPF network, all routing information is transmitted and exchanged
between neighboring or adjacent devices. Configuring proper session parameters
for OSPF neighbor or adjacency relationships helps improve network stability.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 264
Before configuring session parameters for OSPF neighbor or adjacency
relationships, complete the following tasks:
● Configure a link layer protocol.
● Configure IP addresses for interfaces to ensure that neighboring nodes are
reachable at the network layer.
● Configure basic OSPF functions.
Configuration Procedure
Perform one or more of the following configuration tasks (excluding the task of
Verifying the OSPF Session Parameter Configuration) as required.
5.9.1 Setting an OSPF Packet Retransmission Limit
Context
After an OSPF switch sends DD, LSU, or LSR packets but does not receive any
LSAck packet from a neighbor within a specified time, the switch retransmits the
packets. If the number of packet retransmissions reaches a specified limit, the
switch tears down the adjacency relationship with the neighbor.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run retransmission-limit [
max-number ]
An OSPF packet retransmission limit is set.
By default, no OSPF packet retransmission limit is set. If an OSPF packet
retransmission limit is set, the default value of
max-number is 30.
----End
5.9.2 Configuring an Interface to Insert the Actual MTU into
DD Packets
Context
The default maximum transmission unit (MTU) is 0.
To improve compatibility with a non-Huawei device, an OSPF-enabled Huawei
device adds the MTU 0 in DD packets to be sent and does not check the MTUs in
received DD packets, allowing an OSPF neighbor relationship to be set up even if
the two ends have different MTU settings.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 265
However, under the default configuration, the non-Huawei device may discard an
OSPF packet received from the Huawei device if the packet's actual MTU is
greater than the MTU of the non-Huawei device. If the discarded packet is an LSU,
an OSPF neighbor relationship can still be set up, but the route carried in the LSU
fails to be learned, causing service interruptions.
To resolve this issue, run the ospf mtu-enable command to configure an interface
to add the actual MTU in DD packets to be sent and check whether the MTU in a
received DD packet is greater than the local MTU. If the interface MTU settings of
the local and remote ends are different, an OSPF neighbor relationship cannot
enter the Full state. In this manner, MTU inconsistency can then be identified in
time.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The OSPF interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospf mtu-enable
The interface is configured to insert the actual MTU into DD packets and check
whether the MTU in DD packets from the neighbor exceeds the MTU of the local
end.
By default, the MTU in DD packets sent by an interface is 0.
NOTICE
Performing this procedure causes the re-establishment of neighbor relationships.
----End
5.9.3 Verifying the OSPF Session Parameter Configuration
Prerequisites
All configurations about session parameters of OSPF neighbor or adjacency
relationships are complete.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 266
Procedure
● Run the display ospf [
process-id ] peer command to check information
about OSPF neighbors.
● Run the display ospf [
process-id ] brief command to check brief OSPF
information.
● Run the display ospf [
process-id ] retrans-queue [
interface-type interface-
number ] [
neighbor-id ] [ low-level-of-retrans-times-range
min-time ]
[ high-level-of-retrans-times-range
max-time ] command to check the
OSPF retransmission queue.
----End
5.10 Configuring OSPF Attributes on Different Types of
Networks
Applicable Environment
By setting network types for OSPF interfaces and adjusting the OSPF attributes,
you can flexibly build OSPF networks.
In Table 5-20, OSPF classifies networks into four types based on the types of link
layer protocols.
Table 5-20 Network types supported by OSPF
Network Type Characteristic Default Configuration
Broadcast On a broadcast network,
Hello packets, LSU packets,
and LSAck packets are
transmitted using multicast;
DD packets and LSR packets
are transmitted using unicast.
If the link layer protocol is
Ethernet or Fiber Distributed
Data Interface (FDDI), OSPF
regards the network as a
broadcast network by
default.
Non-broadcast
multiple access
(NBMA)
On an NBMA network, Hello
packets, DD packets, LSR
packets, LSU packets, and
LSAck packets are
transmitted using unicast.
An NBMA network must be
fully meshed. That is, any
two switches on an NBMA
network must be directly
reachable.
If the link layer protocol is
ATM, OSPF regards the
network as an NBMA
network by default.
Point-to-point
(P2P)
On a P2P network, Hello
packets, DD packets, LSR
packets, LSU packets, and
LSAck packets are
transmitted using multicast.
If the link layer protocol is
PPP, HDLC, or Link Access
Procedure Balanced (LAPB),
OSPF regards the network as
a P2P network by default.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 267
Network Type Characteristic Default Configuration
Point-to-
multipoint
(P2MP)
On a P2MP network, Hello
packets are transmitted using
multicast; DD packets, LSR
packets, LSU packets, and
LSAck packets are
transmitted using unicast.
OSPF does not regard a
network as a P2MP network
by default regardless of its
link layer protocol. A P2MP
network must be forcibly
changed from another
network type.
As described in Table 5-20, the difference between OSPF configurations on four
types of networks lies in the packet transmission mode.
Pre-configuration Tasks
Before configuring OSPF attributes on different types of networks, complete the
following tasks:
● Configure IP addresses for interfaces to ensure that neighboring nodes are
reachable at the network layer.
● Configure basic OSPF functions.
Configuration Procedure
Configuring network types of OSPF interfaces is the prerequisite for configuring
P2MP or NBMA network attributes.
5.10.1 Configuring a Network Type for an OSPF Interface
Context
Configure one of the following network types for an OSPF interface:
● P2MP: A P2MP network does not have an associated link layer protocol.
Therefore, a P2MP network must be forcibly changed from another network
type.
● NBMA: An NBMA network must be fully meshed. That is, any two switches on
an NBMA network must be directly reachable. However, this is not true in
many cases. In such cases, you need to manually change the network type.
● Broadcast: To speed up the establishment of neighbor relationships, you can
change the network type from broadcast to P2P.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The OSPF interface view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 268
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospf network-type { broadcast | nbma | p2mp | p2p [ peer-ip-ignore ] }
A network type is configured for the interface.
By default, the network type of an interface depends on the type of the physical
interface. The default network type of an Ethernet interface is broadcast.
When you configure a new network type for an interface, the original network
type of the interface is replaced.
A network type can be configured to suit networking requirements:
● If the network type of an interface is broadcast and a switch on the network
does not support multicast addresses, you can change the network type of
the interface to NBMA.
● If the network type of an interface is NBMA and the network is fully meshed
(any two switches are directly connected), you can change the network type
of the interface to broadcast. Configuring neighboring switch information on
the interface is not required then.
● If the network type of an interface is NBMA but the network is not fully
meshed, you must change the network type of the interface to P2MP. This
allows two indirectly connected switches to communicate through one switch
that directly connects to them both. Configuring neighboring switch
information on the interface is not required then.
● If only two switches run OSPF on the same network segment, you are advised
to change the network type of the interface to P2P.
NOTE
OSPF cannot be configured on a null interface.
----End
5.10.2 Configuring P2MP Network Attributes
Procedure
Step 1 Disable OSPF from checking the network mask.
1. Run system-view
The system view is displayed.
2. Run interface
interface-type interface-number
The interface view is displayed.
3. (Optional) On an Ethernet interface, run undo portswitch
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 269
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
4. Run ospf network-type p2mp
A network type is configured for the OSPF interface.
A P2MP network must be forcibly changed from another network type. For
details, see Configuring Network Types for OSPF Interfaces.
5. Run ospf p2mp-mask-ignore
OSPF is disabled from checking the network mask on the P2MP network.
6. Run quit
Exit the interface view.
Step 2 (Optional) Set the cost for the OSPF route to a specified neighbor on a P2MP
network.
By default, on a P2MP network, the cost of an OSPF route to a neighbor equals
the interface cost. If this default cost is not suitable, run the p2mp-peer command
to set a desired cost.
1. Run ospf [
process-id ]
The OSPF process view is displayed.
2. Run p2mp-peer
ip-address cost
cost
A cost is set for an OSPF route to a specified neighbor on a P2MP network.
Step 3 Configure the switch to filter the LSA packets to be sent.
When multiple links exist between two switches, you can configure the local
switch to filter the LSA packets to be sent. This can reduce unnecessary LSA
retransmission attempts and save bandwidth resources.
1. Run ospf [
process-id ]
The OSPF process view is displayed.
2. Run filter-lsa-out peer
ip-address { all | { summary [ acl {
acl-number |
acl-
name } ] | ase [ acl {
acl-number |
acl-name } ] | nssa [ acl {
acl-number |
acl-name } ] } * }
The local switch is configured to filter the LSA packets to be sent on the P2MP
network.
By default, the LSA packets to be sent are not filtered.
----End
5.10.3 Configuring NBMA Network Attributes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 270
Procedure
Step 1 (Optional) Set the network type to NBMA.
An NBMA network must be fully meshed. That is, any two switches on an NBMA
network must be directly reachable. In most cases, however, this is not true. To
resolve this problem, you can run specific commands to forcibly change the
network type to P2MP. For details, see Configuring Network Types for OSPF
Interfaces.
1. Run system-view
The system view is displayed.
2. Run interface
interface-type interface-number
The interface view is displayed.
3. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
4. Run ospf network-type nbma
The network type of the OSPF interface is set to NBMA.
Step 2 (Optional) Set the interval at which Hello packets for polling are sent on the
NBMA network.
On the NBMA network, after the neighbor relationship becomes invalid, the
switch sends Hello packets at an interval defined in the polling mechanism.
1. Run ospf timer poll
interval
The interval at which Hello packets for polling are sent is set on an NBMA
interface.
The default value is 120, in seconds.
Step 3 Configure a neighboring switch on the NBMA network.
If the network type of an interface is NBMA, the interface cannot broadcast Hello
packets to discover neighboring switches. Therefore, the IP address of a
neighboring switch and whether the neighboring switch can participate in DR
election must be configured manually on the interface.
1. Run quit
Exit the interface view.
2. Run ospf [
process-id ]
The OSPF process view is displayed.
3. Run peer
ip-address [ dr-priority
priority ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 271
A neighboring switch is configured on the NBMA network.
----End
5.10.4 Verifying the OSPF Attribute Configuration
Prerequisites
The configurations for OSPF attributes on the NBMA network and P2MP network
are complete.
Procedure
● Run either of the following commands to check LSDB information:
– display ospf [
process-id ] lsdb [ brief ]
– display ospf [
process-id ] lsdb [ { router | network | summary | asbr |
ase | nssa | opaque-link | opaque-area | opaque-as } [
link-state-id ] ]
[ originate-router [
advertising-router-id ] | self-originate ] [ age { min-
value
min-age-value | max-value
max-age-value } * ]
● Run the display ospf [
process-id ] peer [ [
interface-type interface-number ]
neighbor-id | brief | last-nbr-down ] command to view OSPF neighbor
information.
● Run the display ospf [
process-id ] nexthop command to check OSPF next
hop information.
● Run either of the following commands to check OSPF routing table
information:
– display ospf [
process-id ] routing [
ip-address [
mask |
mask-length ] ]
[ interface
interface-type interface-number ] [ nexthop
nexthop-
address ]
– display ospf [
process-id ] routing router-id [
router-id ]
● Run the display ospf [
process-id ] interface [ all |
interface-type interface-
number ] [ verbose ] command to check OSPF interface information.
----End
5.11 Configuring OSPF Stub Areas
Applicable Environment
Partitioning an AS into different areas reduces the number of LSAs. To further
reduce the number of entries in routing tables and the number of LSAs to be
transmitted in a non-backbone area, configure the non-backbone area on the
border of the AS as a stub area.
Configuring a stub area is optional.
Note the following points when configuring a stub area:
● The backbone area (Area 0) cannot be configured as a stub area.
● If an area is to be configured as a stub area, all the switches in this area must
be configured with stub attributes using the stub command.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 272
● An ASBR cannot exist in a stub area to import AS external routes.
● Virtual links cannot exist in stub areas.
Pre-configuration Tasks
Before configuring OSPF stub areas, complete the following tasks:
● Configure IP addresses for interfaces to ensure that neighboring nodes are
reachable at the network layer.
● Configure basic OSPF functions.
Configuration Procedure
Figure 5-66 Flowchart of configuring OSPF stub areas
5.11.1 Configuring an Area as a Stub Area
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run area
area-id
The OSPF area view is displayed.
Step 4 Run stub [ no-summary | default-route-advertise backbone-peer-ignore ] *
The area is configured as a stub area.
The parameter no-summary prevents an ABR from sending Type 3 LSAs to the
stub area.
The parameter default-route-advertise enables an ABR to generate default Type
3 LSAs and advertise them to the stub area.
The parameter backbone-peer-ignore prevents an ABR from checking the
neighbor status when the ABR generates default Type 3 LSAs and advertises them
to the stub area. Specifically, the ABR generates default Type 3 LSAs and
advertises them to the stub area if there is an Up interface in the backbone area.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 273
NOTE
● Stub attributes must be configured on all switches in a stub area using the stub
command.
● Configuring or deleting stub attributes will update routing information in the area. Stub
attributes can be deleted or reconfigured only after the routing update is complete.
Step 5 (Optional) Run default-cost
cost
The cost of the default Type 3 route to the stub area is set.
The default value is 1.
To ensure the reachability of AS external routes to a stub area, the ABR in the stub
area generates a default route and advertises the route to the non-ABR switches
in the stub area.
----End
5.11.2 Verifying the OSPF Stub Area Configuration
Procedure
Run either of the following commands to check LSDB information:
● display ospf [
process-id ] lsdb [ brief ]
● display ospf [
process-id ] lsdb [ { router | network | summary | asbr | ase |
nssa | opaque-link | opaque-area | opaque-as } [
link-state-id ] ]
[ originate-router [
advertising-router-id ] | self-originate ] [ age { min-
value
min-age-value | max-value
max-age-value } * ]
Run either of the following commands to check OSPF routing table information:
● display ospf [
process-id ] routing [
ip-address [
mask |
mask-length ] ]
[ interface
interface-type interface-number ] [ nexthop
nexthop-address ]
● display ospf [
process-id ] routing router-id [
router-id ]
Run the display ospf [
process-id ] abr-asbr [
router-id ] command to check OSPF
ASBR and ABR information.
5.12 Configuring an OSPF NSSA
Applicable Environment
To import external routes and prevent resource consumption caused by external
routes, configure an NSSA.
An NSSA is a special type of OSPF area. Similar to a stub area, an NSSA does not
transmit external routes from other areas. Different from a stub area, an NSSA
imports AS external routes and transmits them in the entire AS using Type 7 LSAs
(a stub area does not import AS external routes).
Type 7 LSAs are generated by ASBRs of NSSAs and flooded only in the NSSAs
where ASBRs reside. An ABR in an NSSA selectively translates received Type 7 LSAs
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 274
into Type 5 LSAs to advertise AS external routes to the other areas over the OSPF
network.
Pre-configuration Tasks
Before configuring an NSSA, complete the following tasks:
● Configure IP addresses for interfaces to ensure that neighboring switches are
reachable at the network layer.
● Configure basic OSPF functions.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run area
area-id
The OSPF area view is displayed.
Step 4 Run nssa [ { default-route-advertise [ backbone-peer-ignore ] | suppress-
default-route } | flush-waiting-timer
interval-value | no-import-route | no-
summary | set-n-bit | suppress-forwarding-address | translator-always |
translator-interval
interval-value | zero-address-forwarding | translator-strict ]*
The area is configured as an NSSA.
NOTE
● NSSA attributes must be configured on all devices in the NSSA using the nssa
command.
● Configuring or deleting NSSA attributes will update the routing information in the area
and interrupt neighbor relationships. NSSA attributes can be reconfigured or deleted
only after the routing update is complete.
The parameters in the nssa command apply to the following scenarios:
● The default-route-advertise parameter is used to configure an ASBR to
advertise a Type 7 LSA carrying a default route to the NSSA.
On an ABR, a Type 7 LSA carrying a default route is generated regardless of
whether the routing table on the ABR contains a default route. On an ASBR, a
Type 7 LSA carrying a default route is generated only when the routing table
contains a default route.
● When the area to which an ASBR belongs is configured as an NSSA, invalid
Type 5 LSAs from other switches in the area can be deleted only when the
aging time reaches 3600s. These invalid LSAs consume numerous memory
resources, degrading the switch performance. To resolve this problem, you can
set the flush-waiting-timer parameter to generate Type 5 LSAs with the
aging time set to the maximum value (3600s). The generated Type 5 LSAs
with the largest aging time can delete the invalid Type 5 LSAs from other
switches in time.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 275
NOTE
– When the value of the LS age field (aging time) in the header of an LSA generated
using the flush-waiting-timer parameter reaches 3600s, the LSA is deleted.
– If an ASBR also functions as an ABR, the flush-waiting-timer parameter does not
take effect. This prevents Type 5 LSAs in non-NSSAs from being deleted.
● If an ASBR also functions as an ABR, you can configure the no-import-route
parameter to prevent external routes imported using the import-route
command from being advertised to the NSSA.
● The no-summary parameter can be configured on an ABR to prevent an ABR
from transmitting Type 3 LSAs to an NSSA so that the number of LSAs
transmitted to the NSSA can be reduced.
NOTE
After the nssa default-route-advertise backbone-peer-ignore no-summary
command is run, the ABR generates Type 7 and Type 3 LSAs both carrying default
routes if there is an Up interface in the backbone area. The Type 3 LSAs preferentially
take effect.
● If the set-n-bit parameter is configured, the N-bit is set in the DD packets
during the synchronization between the switch and neighboring switches.
● If multiple ABRs are deployed in an NSSA, the system automatically selects an
ABR (generally the switch with the largest router ID) as a translator
converting Type 7 LSAs into Type 5 LSAs. To specify one or two ABRs (in load
balancing scenarios) as all-the-time translators, you can configure the
translator-always parameter on the selected ABRs. You can use this
command to pre-configure a fixed translator to prevent LSA flooding caused
by translator role changes.
● The translator-interval parameter is used to ensure uninterrupted services
when translator roles change. The value of
interval-value must be greater
than the flooding period.
Step 5 (Optional) Run default-cost
cost
The cost of the default route carried in Type 3 LSAs that the ABR sends to the
NSSA is set.
To ensure reachability of AS external routes, the ABR in the NSSA generates a
default route and advertises the route to other switches in the NSSA. You can use
this command to set the cost of the default route to an NSSA and adjust the
selection of the default route.
Type 7 LSAs can also be used to carry a default route to guide traffic to other ASs.
Multiple ABRs may exist in an NSSA. To prevent routing loops, an ABR does not
calculate the default routes advertised by the other ABRs.
By default, the cost of the default route that an ABR sends to the NSSA is 1.
----End
Verifying the Configuration
Run either of the following commands to check LSDB information:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 276
● display ospf [
process-id ] lsdb [ brief ]
● display ospf [
process-id ] lsdb [ { router | network | summary | asbr | ase |
nssa | opaque-link | opaque-area | opaque-as } [
link-state-id ] ]
[ originate-router [
advertising-router-id ] | self-originate ] [ age { min-
value
min-age-value | max-value
max-age-value } * ]
Run either of the following commands to check OSPF routing table information:
● display ospf [
process-id ] routing [
ip-address [
mask |
mask-length ] ]
[ interface
interface-type interface-number ] [ nexthop
nexthop-address ]
● display ospf [
process-id ] routing router-id [
router-id ]
Run the display ospf [
process-id ] interface [ all |
interface-type interface-
number ] [ verbose ] command to check OSPF interface information.
5.13 Configuring Local MT
Applicable Environment
When both multicast and an MPLS TE tunnel are configured and the TE tunnel is
configured with IGP Shortcut, the outbound interface of the route calculated by an
IGP may not a physical interface but a TE tunnel interface. The switch uses the TE
tunnel interface to send multicast Join messages through a unicast route to the
multicast source address. The switch through which the TE tunnel passes, however,
cannot detect the multicast Join messages. As a result, multicast forwarding
entries will not be created.
To resolve this problem, you need to enable local MT. After local MT is enabled, if
the outbound interface of the calculated route is a TE tunnel interface of the IGP
Shortcut type, the route management (RM) module creates a separate MIGP
routing table for the multicast protocol, calculates the physical outbound interface
for the route, and adds the physical interface to the MIGP routing table for
multicast forwarding.
You can configure filtering conditions for local MT to control the number of
routing entries in an MIGP routing table and speed up MIGP routing table lookup.
NOTE
Only the S5731-S, S5731-H, S5731S-H, S5732-H, S6730-S, S6730S-H, and S6730-Hsupport
this function.
Pre-configuration Tasks
Before configuring local MT, complete the following tasks:
● Configure IP addresses for interfaces to ensure that neighboring switches are
reachable at the network layer.
● Configure basic OSPF functions.
● Configure a TE tunnel for the OSPF process.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 277
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run local-mt enable
Local MT is enabled.
NOTE
● Local MT is applicable only to the OSPF process of a public network instance.
● Local MT does not support forwarding adjacency (FA).
Step 4 (Optional) Run local-mt filter-policy { acl {
acl-number |
acl-name } | ip-prefix
ip-prefix-name | route-policy
route-policy-name }
A filtering policy is configured for local MT.
After an MIGP routing table is created, OSPF calculates routes. When the
calculation result shows that the outbound interface is an IGP Shortcut-capable TE
tunnel interface, the switch saves the physical interface where the tunnel interface
resides as the outbound interface in the MIGP routing table for multicast packet
forwarding.
To control the number of entries in the MIGP routing table and speed up the
MIGP routing table lookup, you can configure a filtering policy to allow only the
matched routes to the multicast source address to be added to the MIGP routing
table.
Multiple routes to a non-multicast source address may be added to a MIGP
routing table, causing the number of entries to exceed the upper limit. Therefore,
you are advised to configure a routing policy before enabling local MT.
NOTE
If a named ACL is configured using the acl command and a rule is configured using the rule
command for the ACL, the rule takes effect only on the source address range specified by the
parameter source within the time range specified by the parameter time-range.
----End
Verifying the Configuration
● Run the display ospf [
process-id ] migp-routing [
ip-address [
mask |
mask-
length ] ] [ interface
interface-type interface-number ] [ nexthop
nexthop-
address ] command to check the MIGP routing table information.
● Run the display ospf [
process-id ] routing command to check OSPF routing
table information.
● Run the display ospf [
process-id ] brief command to check brief OSPF
information.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 278
5.14 Adjusting OSPF Route Selection
Applicable Environment
To meet various requirements, such as flexible networking or load balancing
optimization on complex networks, you can adjust OSPF parameters.
Pre-configuration Tasks
Before adjusting OSPF route selection, complete the following tasks:
● Configure IP addresses for interfaces to ensure that neighboring nodes are
reachable at the network layer.
● Configure basic OSPF functions.
Configuration Procedure
Perform one or more configuration tasks (excluding the task of Verifying the OSPF
Route Selection Adjustment Configuration) as required.
5.14.1 Setting a Link Cost for an OSPF Interface
Context
You can manually set a link cost for an OSPF interface or allow OSPF to
automatically calculate the cost according to the interface bandwidth. The
calculation formula is as follows:
Cost of an interface = Bandwidth reference value/Interface bandwidth.
The integer of the calculated result is used as the cost of the interface. If the
calculated result is smaller than 1, the cost value is 1. Changing the bandwidth
reference value can change the cost of an interface. To manually set the link cost
or change the bandwidth reference value and interface bandwidth, perform the
following steps.
Procedure
● Set a link cost for an OSPF interface.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The OSPF interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 279
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run ospf cost
cost
A cost is set for the OSPF interface.
By default, OSPF automatically calculates its cost based on its interface
bandwidth. The default cost of a loopback interface is 0.
● Configure bandwidth-based automatic OSPF interface cost calculation.
The calculation formula is as follows: Cost of the interface = Bandwidth
reference value/Interface bandwidth. The integer of the calculation result is
used as the cost of the interface. If the result is less than 1, the cost is 1.
NOTE
● To use the bandwidth reference value to determine the interface cost, run the
bandwidth-reference command.
● To use the interface bandwidth to determine the interface cost, run the bandwidth
command to set configuration bandwidth for an interface, and then run the
bandwidth-config enable command to enable the device to calculate the cost for
the interface based on the configuration bandwidth of the interface.
● To use both the bandwidth reference value and interface bandwidth to determine
the interface cost, select the preceding configuration.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The OSPF interface view is displayed.
c. (Option) Run bandwidth
bandwidth
Configuration bandwidth is set for the interface.
By default, if no configuration bandwidth is set for an interface, the OSPF
interface cost is calculated based on the physical bandwidth of the
interface.
d. Run quit
Exit from the interface view.
e. Run ospf [
process-id ]
The OSPF process view is displayed.
f. (Option) Run bandwidth-reference
value
A bandwidth reference value is set.
The default bandwidth reference value is 100 Mbit/s.
NOTE
Ensure that the bandwidth reference values of switches in an OSPF process are the
same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 280
g. (Option) Run bandwidth-config enable
The device is enabled to use the configuration bandwidth of each OSPF
interface to calculate the cost for the interface.
By default, a device is not enabled to calculate the cost of an OSPF
interface based on the configured interface bandwidth.
----End
5.14.2 Configuring Equal-Cost Routes
Context
If the destinations and costs of multiple routes discovered by one routing protocol
are the same, these routes are equal-cost routes and load balancing can be
implemented among them.
For example, in Figure 5-67, three routes between switchA and switchB that run
OSPF have the same costs. The three routes are equal-cost routes for load
balancing.
Figure 5-67 Networking diagram for configuring equal-cost routes
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run maximum load-balancing
number
The maximum number of equal-cost routes is set.
By default, the maximum number of equal-cost routes on the S5720I-SI, S5735-S,
S5735-S-I, S5735S-H, S6720S-S, and S5736-S is 8, and the maximum number of
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 281
equal-cost routes on the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-
S, S6730-H, S6730S-H, S6730-S, and S6730S-S is 16.
Step 4 (Optional) Run nexthop
ip-address weight
value
The route preferences are configured for load balancing.
When the number of equal-cost routes on the live network exceeds the limit
specified in the maximum load-balancing command, valid routes are randomly
selected for load balancing. To specify valid routes for load balancing, you can run
the nexthop command to set the route preferences of the routes to higher values.
A smaller value of weight indicates a higher route preference. The default value
of weight is 255, which indicates that load balancing is implemented regardless of
the route preferences.
----End
5.14.3 Configuring a Route Selection Rule
Context
RFC 2328 and RFC 1583 define route selection rules differently. After OSPF is
enabled on a switch, you need to specify a route selection rule based on the
switch configuration. By default, a switch complies with the route selection rule
defined in RFC 1583. If the neighboring switch complies with the route selection
rule defined in RFC 2328, you need to configure the local switch to comply with
that defined in RFC 2328. This allows all switches in an OSPF area to comply with
the same route selection rule.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run undo rfc1583 compatible
The switch is configured to comply with the route selection rule defined in RFC
2328, instead of RFC 1583.
By default, the switch complies with the route selection rule defined in RFC 1583.
----End
5.14.4 Verifying the OSPF Route Selection Adjustment
Configuration
Prerequisites
All configurations of adjusting OSPF route selection are complete.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 282
Procedure
● Run the display ospf [
process-id ] interface command to check OSPF
interface information.
● Run the display ospf [
process-id ] routing command to check OSPF routing
table information.
----End
5.15 Controlling OSPF Routing Information
Pre-configuration Tasks
Before controlling OSPF routing information, complete the following tasks:
● Configure IP addresses for interfaces to ensure that neighboring nodes are
reachable at the network layer.
● Configure basic OSPF functions.
Configuration Procedure
Perform one or more of the following configuration tasks (excluding the task of
Verifying the OSPF Route Control Configuration) as required.
5.15.1 Configuring OSPF to Import External Routes
Context
To communicate with a switch running a protocol other than OSPF, an OSPF-
capable switch must import routes of this protocol into the OSPF network.
OSPF can ensure loop-free intra-area and inter-area routes; however, OSPF cannot
prevent external route loops. Therefore, exercise caution to prevent loops caused
by manual configurations when importing external routes to OSPF.
Perform the following steps on the switch functioning as an ASBR running OSPF.
Procedure
● Configure OSPF to import the routes discovered by other protocols.
a. Run system-view
The system view is displayed.
b. Run ospf [
process-id ]
The OSPF process view is displayed.
c. Run import-route { limit
limit-number | { bgp [ permit-ibgp ] | direct |
unr | rip [
process-id-rip ] | static | isis [
process-id-isis ] | ospf [
process-
id-ospf ] } [ cost
cost | type
type | tag
tag | route-policy
route-policy-
name ] * }
The switch is configured to import routes discovered by other protocols.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 283
NOTE
Only the S5720I-SI, S5735-S, S500, S5735-S-I, S5735S-H, S5736-S, S5731-H,
S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support the bgp [ permit-ibgp ] and isis [
process-id-
isis ] parameters.
● Set parameters for OSPF to import routes.
a. Run system-view
The system view is displayed.
b. Run ospf [
process-id ]
The OSPF process view is displayed.
c. Run default { cost {
cost-value | inherit-metric } | limit
limit | tag
tag |
type
type } *
The parameters (route cost, tag, and type) for route import are set to the
default values.
The tag parameter is used to identify protocol-related information. For
example, it can differentiate AS numbers carried in BGP routes imported
by OSPF.
By default, the cost of the external routes imported by OSPF is 1, the type
of the imported external routes is Type 2, and the tag value of the
imported routes is 1.
NOTE
To set a cost for an imported route, run one of the following commands (listed in
descending order of priority).
● apply cost
● import-route
● default (default cost)
----End
5.15.2 Configuring OSPF to Advertise Default Routes to an
OSPF Area
Context
On an OSPF network, multiple switches often reside on the area border and AS
border for next-hop backup or traffic load balancing. To reduce routing entries and
improve resource usage on the OSPF network, you can configure a default route in
the following scenarios:
1. An ABR advertises a Type 3 LSA carrying a default route for instructing
switches to forward inter-area packets.
2. An ASBR advertises a Type 5 or Type 7 LSA carrying a default route for
instructing switches to forward AS external packets.
When no matching route is discovered, the switch can forward packets through a
default route.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 284
The preference of a default route in Type 3 LSAs is higher than that of the route in
Type 5 or Type 7 LSAs.
Advertisement of a default route is determined by the type of the area to which
the default route needs to be imported. Table 5-21 lists the default route
advertisement by area type.
Table 5-21 Default route advertising mode
Area
Type
Generated By Advertise
d By
LSA Type Flood
ing
Area
Common
area
A default route is generated using
the default-route-advertise
command.
ASBR Type 5 LSA Com
mon
area
Stub area A default route is generated
automatically.
ABR Type 3 LSA Stub
area
NSSA A default route is generated using
the nssa [ default-route-
advertise ] command.
ASBR Type 7 LSA NSSA
Totally
NSSA
A default route is generated
automatically.
ABR Type 3 LSA NSSA
Perform the following steps on an ASBR running OSPF.
Procedure
● Configure OSPF to advertise a default route to an OSPF area.
a. Run system-view
The system view is displayed.
b. Run ospf [
process-id ]
The OSPF process view is displayed.
c. Run default-route-advertise [ [ always | permit-calculate-other ] | cost
cost | type
type | route-policy
route-policy-name [ match-any ] ] *
OSPF is configured to advertise a default route to the OSPF area.
▪ The parameter always indicates that an LSA describing a default
route is generated and then advertised regardless of whether there
are active default routes of other OSPF processes in the routing table
of the local device.
▪ The parameter permit-calculate-other indicates that the local
router is allowed to calculate the default routes advertised by other
switches after adverting its own default route.
▪ The parameter route-policy
route-policy-name indicates that the
local device advertises default routes according to the parameters of
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 285
the configured routing policy when there are matched default
routing entries generated by other OSPF processes.
NOTE
● An ASE LSA describing a default route is generated and then advertised only
when there is an active default route of another OSPF process in the routing
table of the local device.
● Before advertising default routes, OSPF compares the preferences of default
routes. Therefore, if a static default route is configured on an OSPF switch,
the default route advertised by OSPF can be added to the current routing
table only when it has a higher preference than the static route.
----End
5.15.3 Configuring OSPF Route Summarization
Context
Route summarization on a large-scale OSPF network reduces the number of
routing entries. This function minimizes system resource consumption while
maintaining system performance. In addition, if a link frequently alternates
between Up and Down, the links not involved in route summarization are not
affected. This prevents route flapping and improves network stability.
OSPF supports two types of route summarization:
● Inter-area route summarization
Inter-area route summarization is performed on ABRs and applies to routes
from within an AS. An ABR generates Network-summary (Type 3) LSAs by
network segment while advertising routing information to other areas. If
network segments are contiguous, the ABR can summarize them into a single
segment. This allows the ABR to send only the summary LSA for all the
specified network segments.
● External route summarization
External route summarization is performed on ASBRs and is specific to
external routes that are imported into OSPF. ASBRs can summarize imported
AS-external (Type 5) LSAs within a summary address range. After an NSSA is
configured, an ASBR must summarize imported NSSA (Type 7) LSAs with the
summary address range.
Devices that are both ABRs and ASBRs summarize the Type 5 LSAs translated
from Type 7 LSAs.
Perform the following steps on a switch running OSPF.
Procedure
● Configure inter-area route summarization on an ABR.
a. Run system-view
The system view is displayed.
b. Run ospf [
process-id ]
The OSPF process view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 286
c. Run area
area-id
The OSPF area view is displayed.
d. Run abr-summary
ip-address mask [ [ cost {
cost | inherit-minimum } |
[ advertise [ generate-null0-route ] | not-advertise | generate-null0-
route [ advertise ] ] ] * ]
ABR route summarization is configured.
● Configure external route summarization on an ASBR.
a. Run system-view
The system view is displayed.
b. Run ospf [
process-id ]
The OSPF process view is displayed.
c. (Optional) Run asbr-summary type nssa-trans-type-reference [ cost
nssa-trans-cost-reference ]
OSPF is configured to consider Type 5 LSAs translated from Type 7 LSAs
when setting types and costs for summarized routes.
By default, OSPF does not consider Type 5 LSAs translated from Type 7
LSAs when setting types and costs for summarized routes.
d. Run asbr-summary
ip-address mask [ not-advertise | tag
tag | cost
cost
| distribute-delay
interval ] *
ASBR route summarization is configured.
NOTE
After route summarization is configured, the routing table on the local OSPF
switch remains unchanged, but the routing table on a neighboring OSPF switch
contains only one summarized route. This summarized route is removed only
when all specific routes involved in the summarization are interrupted.
----End
5.15.4 Configuring OSPF to Filter Received Routes
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run filter-policy {
acl-number | acl-name
acl-name | ip-prefix
ip-prefix-name |
route-policy
route-policy-name [ secondary ] } import
OSPF is configured to filter received routes.
● The parameter
acl-number specifies the number of a basic ACL.
● The parameter acl-name
acl-name specifies the name of an ACL.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 287
● The parameter ip-prefix
ip-prefix-name specifies the name of an IP prefix list.
The filter-policy import command is used to filter the routes calculated by OSPF
but cannot be used to filter advertised or received LSAs. Only the routes that pass
the filtering criteria are added to the routing table. Routes that do not pass the
filtering criteria can still be advertised.
----End
5.15.5 Configuring OSPF to Filter the Routes to Be Advertised
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run filter-policy {
acl-number | acl-name
acl-name | ip-prefix
ip-prefix-name |
route-policy
route-policy-name } export [
protocol [
process-id ] ]
OSPF is configured to filter the routes imported using the import-route
command. Only the routes that pass the filtering criteria are advertised.
● The parameter
acl-number specifies the number of a basic ACL.
● The parameter acl-name
acl-name specifies the name of an ACL.
● The parameter ip-prefix
ip-prefix-name specifies the name of an IP prefix list.
● The parameter route-policy
route-policy-name specifies the name of a
routing policy.
To filter the routes of a specific routing protocol or process, specify the parameter
protocol [
process-id ]. If this parameter is not specified, OSPF filters all the
imported routes.
NOTE
● The import-route command cannot be used to import external default routes.
● Only for the external routes passing the filtering criteria, OSPF generates Type 5 LSAs to
advertise the routes.
----End
5.15.6 Configuring a Switch to Filter LSAs to Be Sent
Context
When multiple links exist between two switches, you can configure the local
switch to filter the LSAs to be sent over certain links. This prevents unnecessary
retransmission of LSAs and saves bandwidth resources.
Perform the following steps on a switch running OSPF.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 288
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospf filter-lsa-out { all | { summary [ acl {
acl-number |
acl-name } ] | ase
[ acl {
acl-number |
acl-name } ] | nssa [ acl {
acl-number |
acl-name } ] } * }
The switch is configured to filter the LSAs to be sent.
By default, a switch does not filter the LSAs to be sent.
----End
5.15.7 Configuring OSPF to Filter ABR Type3 LSAs
Context
After filtering criteria are set for the incoming or outgoing Type 3 LSAs (Summary
LSAs) in an area, only the Type 3 LSAs that pass the filtering criteria can be
received or advertised.
This function applies only to ABRs.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run area
area-id
The OSPF area view is displayed.
Step 4 Configure OSPF to filter incoming or outgoing Type 3 LSAs generated by ABRs as
required.
● Run filter {
acl-number | acl-name
acl-name | ip-prefix
ip-prefix-name |
route-policy
route-policy-name } export
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 289
OSPF is configured to filter Type 3 LSAs leaving the local area.
● Run filter {
acl-number | acl-name
acl-name | ip-prefix
ip-prefix-name |
route-policy
route-policy-name } import
OSPF is configured to filter Type 3 LSAs entering the local area.
----End
5.15.8 (Optional) Enabling the Mesh-Group Function
Context
To reduce the load on concurrent links between two switches, you can enable the
mesh-group function.
A neighboring router ID uniquely identifies a mesh group. A mesh group contains
several concurrent links, and flooding is implemented only once after the group is
created. Interfaces can be added to the same mesh group only when the following
conditions are met:
● The interfaces belong to the same area and OSPF process.
● The status of the interfaces is higher than Exchange.
● The interfaces connect to the same neighboring switch.
Perform the following steps on a switch running OSPF.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run mesh-group enable
The mesh-group function is enabled.
By default, the mesh-group function is disabled.
----End
5.15.9 Setting the Maximum Number of External LSAs in the
LSDB
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 290
Step 3 Run lsdb-overflow-limit
number
The maximum number of external LSAs in the LSDB is set.
----End
5.15.10 Verifying the OSPF Route Control Configuration
Prerequisites
All configurations of controlling OSPF routing information are complete.
Procedure
● Run either of the following commands to check OSPF routing table
information:
– display ospf [
process-id ] routing [
ip-address [
mask |
mask-length ] ]
[ interface
interface-type interface-number ] [ nexthop
nexthop-
address ]
– display ospf [
process-id ] routing router-id [
router-id ]
● Run the display ospf [
process-id ] interface [ all |
interface-type interface-
number ] [ verbose ] command to check OSPF interface information.
● Run the display ospf [
process-id ] asbr-summary [
ip-address mask ]
command to check OSPF ASBR summarization information.
----End
5.16 Configuring BFD for OSPF
Applicable Environment
Fault detection via Hello packets periodically sent to neighboring switches requires
more than 1s. For services such as voice and video, which are sensitive to packet
loss and latency, prolonged fault detection will cause packet loss when traffic is
transmitted at gigabit rates. This detection period cannot meet the high reliability
requirements of carrier-class networks.
BFD for OSPF resolves this problem. After BFD for OSPF is configured in a process
or on an interface, the link status can be rapidly detected. This allows fault
detection to complete in milliseconds, speeding up OSPF convergence.
NOTE
Only the S5720I-SI, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S, S5731S-H,
S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and S6730S-S
support BFD for OSPF.
Pre-configuration Tasks
Before configuring BFD for OSPF, complete the following tasks:
● Configure IP addresses for interfaces to ensure that neighboring nodes are
reachable at the network layer.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 291
● Configure basic OSPF functions.
Configuration Procedure
Figure 5-68 Flowchart of configuring BFD for OSPF
5.16.1 Configuring Global BFD
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bfd
BFD is configured globally, and the global BFD view is displayed.
----End
5.16.2 Configuring BFD for OSPF
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF view is displayed.
Step 3 Run bfd all-interfaces enable
BFD for OSPF is enabled, and BFD sessions are established.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 292
If all the interfaces in a single process are configured with BFD and their neighbor
relationships are in the Full state, OSPF establishes BFD sessions on all the
interfaces in the process.
Step 4 (Optional) run bfd all-interfaces { min-rx-interval
receive-interval | min-tx-
interval
transmit-interval | detect-multiplier
multiplier-value } *
Parameters are set for the BFD sessions.
● The parameter min-rx-interval
receive-interval specifies the expected
minimum interval for receiving BFD packets from the neighbor.
● The parameter min-tx-interval
transmit-interval specifies the minimum
interval for sending BFD packets to the neighbor.
● The parameter detect-multiplier
multiplier-value specifies the local detection
multiplier.
NOTE
Default values of
receive-interval,
transmit-interval, and
multiplier-value are recommended.
Configure parameters based on the network status and network reliability
requirements. A short interval between BFD packet transmissions can be
configured if high network reliability is required.
NOTE
● Actual interval between BFD packet transmissions on the local switch = Max {value of
transmit-interval configured on the local switch, value of
receive-interval configured on the
neighboring switch }
● Actual interval between BFD packet receipts on the local switch = Max {value of
transmit-
interval configured on the neighboring switch, value of
receive-interval configured on the
local switch }
● Actual BFD packet detection period on the local switch = Actual interval between BFD packet
receipts on the local switch x Value of
multiplier-value configured on the neighboring switch
For example, if:
● On the local switch, the configured interval between BFD packet transmissions is 200 ms; the
configured interval between BFD packet receipts is 300 ms; the detection multiplier is 4.
● On the neighboring switch, the configured interval between BFD packet transmissions is 100
ms; the configured interval between BFD packet receipts is 600 ms; the detection multiplier
is 5.
Then:
● On the local switch, the actual interval between BFD packet transmissions is 600 ms
calculated by using the formula: max {200 ms, 600 ms}; the interval between BFD packet
receipts is 300 ms calculated by using the formula: max {100 ms, 300 ms}; the detection
period is 1500 ms calculated by using the formula: 300 ms x 5.
● On the neighboring switch, the actual interval between BFD packet transmissions is 300 ms
calculated by using the formula: max {100 ms, 300 ms}; the actual interval between BFD
packet receipts is 600 ms calculated by using the formula: max {200 ms, 600 ms}; the
detection period is 2400 ms calculated by using the formula: 600 ms x 4.
----End
5.16.3 (Optional) Preventing an Interface from Dynamically
Setting Up a BFD Session
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 293
Context
After the bfd all-interfaces enable command is run in an OSPF process, BFD
sessions are set up on all the OSPF interfaces under the process whose neighbor
relationships are in Full state. You can prevent an interface from dynamically
setting up a BFD session as required.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The view of the interface enabled with BFD for OSPF is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospf bfd block
The interface is prevented from dynamically setting up a BFD session.
----End
5.16.4 (Optional) Configuring BFD on an Interface
Context
To allow a switch to rapidly detect failures occurring on a specific interface, you
can configure BFD for OSPF on the interface. When detecting a failure, the switch
then instructs OSPF to recalculate routes, speeding up OSPF convergence. If the
OSPF neighbor relationship set up on this interface goes Down, the BFD session
between the OSPF neighbors is dynamically deleted.
Before configuring BFD for OSPF on an interface, you need to enable BFD globally.
Perform the following steps on a switch:
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 294
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospf bfd enable
BFD is enabled on the OSPF interface and a BFD session is set up.
If all the interfaces in a single process are configured with BFD and their neighbor
relationships are in Full state, OSPF creates BFD sessions with default parameter
values on the interfaces with OSPF enabled in the process.
NOTE
The priority of BFD for OSPF configured on an interface is higher than that of BFD for OSPF
configured for a process.
If parameters need to be set for BFD sessions, run the ospf bfd { min-rx-interval
receive-interval | min-tx-interval
transmit- interval | detect-multiplier
multiplier-
value } * command.
Default values of
receive-interval,
transmit-interval, and
multiplier-value are
recommended. That is, the preceding command can be skipped.
The parameters need to be configured based on the network status and network
reliability requirements. A short interval between BFD packet transmissions can be
configured if high network reliability is required.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 295
NOTE
● Actual interval between BFD packet transmissions on the local switch = Max {value of
transmit-interval configured on the local switch, value of
receive-interval configured on the
neighboring switch }
● Actual interval between BFD packet receipts on the local switch = Max {value of
transmit-
interval configured on the neighboring switch, value of
receive-interval configured on the
local switch }
● Actual BFD packet detection period on the local switch = Actual interval between BFD packet
receipts on the local switch x Value of
multiplier-value configured on the neighboring switch
For example, if:
● On the local switch, the configured interval between BFD packet transmissions is 200 ms; the
configured interval between BFD packet receipts is 300 ms; the detection multiplier is 4.
● On the neighboring switch, the configured interval between BFD packet transmissions is 100
ms; the configured interval between BFD packet receipts is 600 ms; the detection multiplier
is 5.
Then:
● On the local switch, the actual interval between BFD packet transmissions is 600 ms
calculated by using the formula: max {200 ms, 600 ms}; the interval between BFD packet
receipts is 300 ms calculated by using the formula: max {100 ms, 300 ms}; the detection
period is 1500 ms calculated by using the formula: 300 ms x 5.
● On the neighboring switch, the actual interval between BFD packet transmissions is 300 ms
calculated by using the formula: max {100 ms, 300 ms}; the actual interval between BFD
packet receipts is 600 ms calculated by using the formula: max {200 ms, 600 ms}; the
detection period is 2400 ms calculated by using the formula: 600 ms x 4.
----End
5.16.5 Verifying the BFD for OSPF Configuration
Prerequisites
All configurations of BFD for OSPF are complete.
Procedure
● Run the following commands to check information about a BFD session or
global BFD sessions:
– display ospf [
process-id ] bfd session
interface-type interface-number
[
router-id ]
– display ospf [
process-id ] bfd session {
router-id | all }
----End
5.17 Configuring OSPF IP FRR
Applicable Environment
With the development of networks, Voice over IP (VoIP) and on-line video services
require high-quality real-time transmission. Nevertheless, if an OSPF fault occurs,
traffic can be switched to a new link only after the following processes: fault
detection at the millisecond level, notifying the fault to the routing control plane
at the millisecond level, generating and flooding new topology information at the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 296
tens of milliseconds level, triggering SPF calculation at the tens of milliseconds
level, and notifying and installing a new route at the hundreds-of-milliseconds
level. As a result, it takes much more than 50 ms to recovery the link from the
fault, which cannot meet the requirement for real-time services on the network.
With OSPF IP FRR that calculates a backup link in advance, devices can fast switch
traffic to the backup link without interrupting traffic when the primary link
becomes faulty. This protects traffic and therefore greatly improves the reliability
of OSPF networks.
OSPF IP FRR is applicable to the services that are sensitive to packet delay and
packet loss.
NOTE
Only the S5720I-SI, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S, S5731S-H,
S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and S6730S-S
support this function.
5.17.1 Enabling OSPF IP FRR
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id | router-id
router-id | vpn-instance
vpn-instance-name ] *
An OSPF process is started, and the OSPF view is displayed.
Step 3 Run frr
The OSPF IP FRR view is displayed.
Step 4 Run loop-free-alternate
OSPF IP FRR is enabled to generate a loop-free backup link.
By default, this function is disabled. OSPF can generate a loop-free backup link
only when the OSPF IP FRR traffic protection inequality is met.
NOTE
In the following description, Distance_opt(X, Y) indicates the shortest link from node X to
node Y, S stands for a source node, E for the faulty node, N for a node along a backup link,
and D for a destination node.
● Link protection takes effect when the traffic to be protected flows along a
specified link and the link cost meets the inequality: Distance_opt(N, D) <
Distance_opt(N, S) + Distance_opt(S, D).
● Node-and-link protection takes effect when the traffic to be protected flows
along a specified link and passes through a specified node and the following
conditions are met:
– The link cost meets the inequality: Distance_opt(N, D) < Distance_opt(N,
S) + Distance_opt(S, D).
– The interface cost meets the inequality: Distance_opt(N, D) <
Distance_opt(N, E) + Distance_opt(E, D).
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 297
Step 5 (Optional) Run frr-priority static low
The Loop-Free Alternates (LFA) algorithm is configured for calculating the next
hop and outbound interface for a backup link.
The next hop and outbound interface of an OSPF loop-free backup link can be
obtained using either of the following methods:
● Static backup link: After OSPF IP FRR is enabled using the ip frr command in
the system view or VPN instance view, specify a next hop and an outbound
interface for the static backup link.
● Dynamic backup link: After OSPF IP FRR is enabled using the loop-free-
alternate command, configure the device to use the LFA algorithm to
calculate the next hop and outbound interface for the dynamic backup link.
By default, static backup links take preference over dynamic backup links during
route selection. However, static backup links are less flexible than dynamic backup
links. If a link failure occurs, static backup links cannot update automatically, but
dynamic backup links can. Therefore, run the frr-priority static low command to
specify the LFA algorithm for calculating the next hop and outbound interface so
that the dynamic backup links can take preference over static backup links.
Step 6 (Optional) Run frr-policy route route-policy
route-policy-name
An OSPF IP FRR filtering policy is configured.
After an OSPF IP FRR filtering policy is configured, only the OSPF backup routes
that pass the filtering criteria can be delivered to the forwarding table. To protect
the traffic over a specific OSPF route, you can configure a filtering policy that
matches the OSPF route to ensure that the route can be added to the forwarding
table. If this route fails, OSPF can fast switch the traffic to a backup route.
----End
5.17.2 (Optional) Binding OSPF IP FRR and BFD
Context
If OSPF IP FRR is configured, the lower layer needs to fast respond to link changes
so that traffic can be rapidly switched to backup links in the case of a link failure.
You can bind BFD to the link status so that link faults can be detected rapidly. This
ensures that traffic is rapidly switched to the backup link in the case of link
failures.
Binding OSPF IP FRR and BFD can be configured in a specified process or on a
specified interface. The priority of BFD configured on an interface is higher than
that of BFD configured in an OSPF process. If BFD is enabled on an interface, a
BFD session is established according to the BFD parameters set on the interface.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support this function.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 298
Procedure
● Bind OSPF IP FRR and BFD in a specified process.
a. Run system-view
The system view is displayed.
b. Run bfd
BFD is globally configured.
c. Run quit
Return to the system view.
d. Run ospf [
process-id | router-id
router-id | vpn-instance
vpn-instance-
name ] *
The OSPF process is enabled, and the OSPF view is displayed.
e. Run bfd all-interfaces enable
BFD is enabled in the OSPF process.
f. Run bfd all-interfaces frr-binding
IP FRR is bound to BFD in an OSPF process.
● Bind OSPF IP FRR and BFD on a specified interface.
a. Run system-view
The system view is displayed.
b. Run bfd
BFD is globally configured.
c. Run quit
Return to the system view.
d. Run interface
interface-type interface-number
The interface view is displayed.
e. Run ospf bfd enable
BFD is enabled on the OSPF interface.
f. Run ospf bfd frr-binding
IP FRR is bound to BFD on the OSPF interface.
----End
5.17.3 (Optional) Disabling OSPF IP FRR on an Interface
Context
OSPF IP FRR can be disabled on an interface of a specific device that is running
important services. This prevents the device connected to this interface from
providing a backup link for the local device and therefore being burdened after
FRR switches traffic to the backup link.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 299
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The view of the OSPF IP FRR-enabled interface is displayed.
Step 3 Run ospf frr block
OSPF IP FRR is disabled on the interface.
----End
5.17.4 Verifying the OSPF IP FRR Configuration
Prerequisites
All OSPF IP FRR configurations are complete.
Procedure
● Run the display ospf [
process-id ] routing command to check information
about the primary and backup links after OSPF IP FRR is enabled.
View the routes to the specified OSPF device.
<HUAWEI> display ospf routing 192.168.4.0
OSPF Process 1 with Router ID 192.168.150.11
Destination : 192.168.4.0/24
AdverRouter : 10.4.4.4 Area : 0.0.0.0
Cost : 2 Type : Transit
NextHop : 192.168.2.2 Interface : Vlanif20
Priority : Low Age : 00h00m10s
Backup Nexthop : 192.168.1.2 Backup Interface: Vlanif10
Backup Type : LFA LINK
The preceding information shows that a backup route is generated on the
switch, including information about the backup next hop: Backup NextHop,
Backup Interface, and Backup Type indicating the address, outbound
interface, and type of the backup next hop respectively.
----End
5.18 Configuring OSPF Fast Convergence
Pre-configuration Tasks
Before configuring OSPF fast convergence, complete the following tasks:
● Configure a link layer protocol.
● Configure IP addresses for interfaces to ensure that neighboring nodes are
reachable at the network layer.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 300
● Configure basic OSPF functions.
Configuration Procedure
Perform one or more configuration tasks (excluding the task of Verifying the OSPF
Fast Convergence Configuration) as required.
5.18.1 Setting a Convergence Priority for OSPF Routes
Context
A network may bear many different services, such as data, voice, and video. These
services have different requirements for the network.
To ensure that OSPF routes converge preferentially, you can configure convergency
priorities for these routes. This shortens the interruption of key services and
improves the reliability of the entire network.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF view is displayed.
Step 3 Run prefix-priority { critical | high | medium } ip-prefix
ip-prefix-name
A convergence priority is set for OSPF routes.
OSPF then calculates and floods LSAs and synchronizes LSDBs according to the
priority. This speeds up route convergence. When an LSA meets multiple priorities,
the highest priority takes effect. OSPF calculates routes in the sequence of intra-
area routes, inter-area routes, and AS external routes. This command specifies the
OSPF route convergence priorities. Convergence priorities include critical, high,
medium, and low in descending order. During LSA flooding, LSAs are placed into
the corresponding critical, high, medium, and low queues according to priorities,
which speeds up the processing of high-priority LSAs.
NOTE
This command takes effect only on the public network.
----End
5.18.2 Setting an Interval for Sending Hello Packets
Context
OSPF interfaces periodically send Hello packets to establish and maintain neighbor
relationships. The sending interval must be the same between any two neighbors.
Otherwise, OSPF neighbor relationships cannot be established.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 301
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The OSPF interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospf timer hello
interval [ conservative ]
An interval at which the OSPF interface sends Hello packets is set.
By default, the interval is 10s on a P2P or broadcast interface, and 30s on a P2MP
or NBMA interface. The dead time after which an OSPF neighbor relationship
expires on an interface is four times the interval for sending Hello packets on the
interface.
----End
5.18.3 Setting a Dead Time for a Neighbor Relationship
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The OSPF interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospf timer dead
interval
A dead time after which the neighbor relationship expires between two switches is
set.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 302
By default, the dead time is 40s on a P2P or broadcast interface, and 120s on a
P2MP or NBMA interface. The dead time is four times the interval for sending
Hello packets on the same interface.
NOTE
A dead time longer than 20s is recommended. If the dead time is shorter than 20s, the
OSPF neighbor relationship may be disconnected unexpectedly.
Both the Hello timer (interval for sending Hello packets) and the Dead timer (interval after
which a neighbor relationship expires) are restored to their default values upon a change of
the network type.
----End
5.18.4 Configuring Smart-discover
Context
If the neighbor status of a switch changes or the DR/BDR on a multi-access
network (broadcast or NBMA network) changes before Smart-discover is
configured, the switch does not send Hello packets to its neighbor until the Hello
timer expires. This slows down the establishment of neighbor relationships
between devices. To resolve this problem, you can configure Smart-discover to
allow the switch to send Hello packets to its neighbor immediately without
waiting for the expiration of the Hello timer.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The OSPF interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospf smart-discover
Smart-discover is configured on the interface.
----End
5.18.5 Setting an Interval for Updating LSAs
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 303
Context
OSPF stipulates that LSAs are updated at an interval of 5s to prevent network
connections or frequent route flapping from consuming excessive network
bandwidth or device resources.
On a stable network where routes need to converge fast, you can set the LSA
update interval to 0s so that the topology or route changes can be immediately
advertised over the network through LSAs, thereby speeding up route
convergence.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run lsa-originate-interval { 0 | { intelligent-timer
max-interval start-interval
hold-interval | other-type
interval } * }
An interval for updating LSAs is set.
● The parameter intelligent-timer indicates that an intelligent timer is used to
set the interval for updating Router-LSAs and Network-LSAs.
● The parameter
max-interval specifies the maximum interval for updating
LSAs, in milliseconds.
● The parameter
start-interval specifies the initial interval for updating LSAs, in
milliseconds.
● The parameter
hold-interval specifies the hold interval for updating LSAs, in
milliseconds.
● The parameter other-type
interval indicates an interval for updating LSAs
other than Router-LSAs and Network-LSAs.
By default, an intelligent timer is enabled. After an intelligent timer is enabled, the
default maximum interval for updating LSAs is 5000 ms, the default initial interval
is 500 ms, and the default hold interval is 1000 ms. The mechanism of the
intelligent timer is as follows:
1. The initial interval for updating LSAs is specified by
start-interval.
2. The interval for the
nth (
n ≥ 2) LSA update is equal to
hold-interval x 2(n-2).
3. When the interval specified by
hold-interval x 2(n-2) reaches the maximum
interval specified by
max-interval, the maximum interval is used for the
subsequent three LSA updates. Then, OSPF goes back to step Step 3.1 and
updates LSAs at the initial interval specified by
start-interval.
----End
5.18.6 Setting an Interval for Receiving LSAs
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 304
Context
OSPF stipulates that LSAs are received at an interval of 1s to prevent network
connections or frequent route flapping from consuming excessive network
bandwidth or device resources.
On a stable network where routes need to converge fast, you can set the LSA
receipt interval to 0s so that the topology or route changes can be immediately
advertised over the network through LSAs, thereby speeding up route
convergence.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run lsa-arrival-interval {
interval | intelligent-timer
max-interval start-interval
hold-interval }
The interval for receiving LSAs is set.
● The parameter
interval specifies the interval for receiving LSAs, in
milliseconds.
● The parameter intelligent-timer indicates that an intelligent timer is used to
set the interval for receiving Router-LSAs and Network-LSAs.
● The parameter
max-interval specifies the maximum interval for receiving
LSAs, in milliseconds.
● The parameter
start-interval specifies the initial interval for receiving LSAs, in
milliseconds.
● The parameter
hold-interval specifies the hold interval for receiving LSAs, in
milliseconds.
By default, an intelligent timer is enabled. After an intelligent timer is enabled, the
default maximum interval for receiving LSAs is 1000 ms, the default initial interval
is 500 ms, and the default hold interval is 500 ms. The mechanism of the
intelligent timer is as follows:
1. The initial interval for receiving LSAs is specified by
start-interval.
2. The interval for the
nth (
n ≥ 2) LSA receipt is equal to
hold-interval x 2(n-2).
3. When the interval specified by
hold-interval x 2(n-2) reaches the maximum
interval specified by
max-interval, the maximum interval is used for the
subsequent three LSA receipts. Then, OSPF goes back to step Step 3.1 and
receives LSAs at the initial interval specified by
start-interval.
----End
5.18.7 Setting an Interval for SPF Calculations
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 305
Context
When an OSPF LSDB changes, shortest paths must be recalculated. If a network
changes frequently, shortest paths are recalculated frequently, heavily consuming
system resources and degrading the network performance. To prevent this
problem, you can configure an intelligent timer to set a proper interval for SPF
calculations.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run spf-schedule-interval {
interval1 | intelligent-timer
max-interval start-
interval hold-interval | millisecond
interval2 }
The interval for SPF calculations is set.
● The parameter
interval1 specifies the interval for SPF calculations, in seconds.
● The parameter intelligent-timer indicates that an intelligent timer is used to
set the interval for SPF calculations.
● The parameter
max-interval specifies the maximum interval for SPF
calculations, in milliseconds.
● The parameter
start-interval specifies the initial interval for SPF calculations,
in milliseconds.
● The parameter
hold-interval specifies the hold interval for SPF calculations, in
milliseconds.
● The parameter millisecond
interval2 specifies the interval for SPF
calculations, in milliseconds.
By default, an intelligent timer is enabled. After an intelligent timer is enabled, the
default maximum interval for the SPF calculation is 10000 ms, the initial interval is
500 ms, and the hold interval is 1000 ms. The mechanism of the intelligent timer
is as follows:
1. The initial interval for SPF calculations is specified by
start-interval.
2. The interval for the
nth (
n ≥ 2) SPF calculation is equal to
hold-interval x
2(n-2).
3. When the interval specified by
hold-interval x 2(n-2) reaches the maximum
interval specified by
max-interval, the maximum interval is used for the
subsequent three SPF calculations. Then, OSPF goes back to step Step 3.1 and
performs the SPF calculation at the initial interval specified by
start-interval.
----End
5.18.8 Verifying the OSPF Fast Convergence Configuration
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 306
Prerequisites
All configurations of OSPF fast convergence are complete.
Procedure
● Run the display ospf [
process-id ] brief command to check OSPF brief
information.
----End
5.19 Configuring OSPF GR
Applicable Environment
To avoid traffic interruption and route flapping caused by active/standby
switchovers, you can enable OSPF GR.
After an OSPF process is restarted using GR, the Restarter and the Helper
reestablish a neighbor relationship, exchange routing information, synchronize
their LSDBs, and update their routing tables and forwarding tables. These
operations ensure fast OSPF convergence and network topology stability.
NOTE
Where possible, to prevent service forwarding from being affected by faults on an active
control board, you can configure OSPF GR when dual control boards are deployed.
Pre-configuration Tasks
Before configuring OSPF GR, complete the following tasks:
● Configure IP addresses for interfaces to ensure that neighboring switches are
reachable at the network layer.
● Configure basic OSPF functions.
5.19.1 Enabling the Opaque-LSA Capability of OSPF
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF view is displayed.
Step 3 Run opaque-capability enable
The opaque-LSA capability is enabled.
The opaque-LSA capability must be enabled because OSPF uses Type 9 LSAs to
support GR.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 307
Step 4 Run graceful-restart
The OSPF GR feature is enabled.
----End
5.19.2 (Optional) Configuring GR Session Parameters on the
Restarter
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF view is displayed.
Step 3 Run graceful-restart [ period
period | planned-only | partial ] *
GR session parameters are set on the Restarter.
● The parameter period indicates the GR period on the Restarter. By default,
the GR period is 120 seconds.
● The parameter planned-only indicates that the Restarter supports only
planned GR. By default, the Restarter supports both planned GR and
unplanned GR.
● The parameter partial indicates that the Restarter supports only partial GR.
By default, the Restarter supports totally GR.
----End
5.19.3 (Optional) Configuring GR Session Parameters on the
Helper
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF view is displayed.
Step 3 Run graceful-restart helper-role { [ { ip-prefix
ip-prefix-name | acl-number
acl-
number | acl-name
acl-name } | ignore-external-lsa | planned-only ] * | never }
GR session parameters are set on the Helper.
● The parameters
ip-prefix,
acl-number, and
acl-name are used to configure a
filtering policy. A switch enters the Helper mode only when it passes the
filtering criteria in the policy.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 308
● The parameter ignore-external-lsa indicates that the Helper does not check
AS-external LSAs. By default, the Helper checks AS-external LSAs.
● The parameter planned-only indicates that the Helper supports only planned
GR. By default, the Helper supports both planned GR and unplanned GR.
● The parameter never indicates that the switch never enters the Helper mode.
----End
5.19.4 Verifying the OSPF GR Configuration
Prerequisites
All configurations of OSPF GR are complete.
Procedure
● Run the display ospf [
process-id ] graceful-restart [ verbose ] command to
check information about OSPF GR.
----End
5.20 Improving Stability of an OSPF Network
Applicable Environment
To reduce device load and improve network performance, you can configure OSPF
timers to reduce the number of unnecessary packets on the network.
Pre-configuration Tasks
Before performing operations to improve the stability of an OSPF network,
Configure basic OSPF functions.
Configuration Procedure
Perform one or more of the following configuration tasks (excluding the task of
Verifying the OSPF Network Stability Optimization Configuration) as required.
5.20.1 Setting a Priority for OSPF Routes
Context
A priority can be set for each routing protocol running on a switch. When these
protocols discover the same route, the route discovered by the highest-priority
routing protocol takes effect.
Procedure
Step 1 Run system-view
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 309
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run preference [ ase ] {
preference | route-policy
route-policy-name } *
A priority is set for OSPF routes.
● The parameter ase indicates that a priority is set for AS external routes.
● The parameter
preference specifies the priority of OSPF routes. A smaller
value indicates a higher priority.
● The parameter route-policy
route-policy-name indicates that a routing policy
is used to set a priority for specified routes.
The default priority of OSPF routes is 10. If the parameter ase is specified in the
command, the default priority of AS external routes is 150.
----End
5.20.2 Configuring an LSA Transmission Delay on an Interface
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The OSPF interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospf trans-delay
interval
A delay after which LSAs can be transmitted is set on the interface.
By default, the delay is 1s.
----End
5.20.3 Configuring an Interval for Retransmitting LSAs
Between Adjacent Switches
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 310
Context
After a switch sends an LSA to its neighboring switch, the switch waits for a
response within an interval. If no response is received within the interval, the
switch retransmits the LSA to the neighboring switch.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The OSPF interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospf timer retransmit
interval
An interval at which LSAs are retransmitted between adjacent switches is set.
By default, the interval is 5s.
NOTE
Generally, the interval at which LSAs are retransmitted between adjacent switches must be
greater than the round trip time of a packet transmitted between the two switches.
Otherwise, some LSAs are retransmitted unnecessarily.
----End
5.20.4 Configuring a Stub Router
Context
Configuring a switch to function as a stub router ensures an uninterrupted route
on the switch during upgrades and other maintenance operations. This is because
the route cost is set to the maximum value 65535 and therefore the route is no
longer preferentially selected.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 311
The OSPF process view is displayed.
Step 3 Run stub-router [ on-startup [
interval ] ]
The switch is configured as a stub router.
No device functions as a stub router by default.
If a switch is configured as a stub router, it functions as a stub router for 500s by
default.
NOTE
A stub router configured using this command bears no similarity to a switch in a stub area.
----End
5.20.5 Prohibiting an OSPF Interface from Sending and
Receiving Protocol Packets
Context
To prevent devices on other networks from obtaining local OSPF routing
information and to prevent the local device from receiving the routing update
information advertised by other devices on the same network, you can prohibit an
OSPF interface from sending and receiving protocol packets. Such a configured
interface can continue to advertise its direct routes; however, Hello packets will be
blocked. This ensures that no neighbor relationship can be set up through the
interface, which enhances OSPF networking capabilities and reduces network
resource consumption.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF view is displayed.
Step 3 Run silent-interface { all |
interface-type interface-number }
An OSPF interface is prohibited from sending and receiving protocol packets.
By default, an interface is allowed to send and receive protocol packets.
You can prohibit an interface from sending and receiving OSPF packets in different
OSPF processes, but the silent-interface command is valid only for the OSPF
interface in the current process.
----End
5.20.6 Disabling the Function of Triggering Active/Standby
Board Switchover upon Abnormal OSPF LSA Aging
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 312
Context
If the local device clock is faster than usual and the aging timer expires
abnormally, the local device will clear all Router LSAs from the neighboring device,
causing route flapping and service interruptions. To resolve this issue, a device
automatically triggers active/standby switchover upon abnormal OSPF LSA aging.
Active/standby board switchover is triggered to restore network connections and
service traffic when the following condition is met:
(Number of incorrectly cleared Router LSAs/Total number of Router LSAs) x 100%
≥ 80% (Router LSAs here are those sent by the neighboring device to the local
device.)
To disable the function of triggering active/standby board switchover upon
abnormal OSPF LSA aging, run the ospf maxage-lsa auto-protect disable
command.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf maxage-lsa auto-protect disable
The function of triggering active/standby board switchover upon abnormal OSPF
LSA aging is disabled.
By default, this function is enabled.
----End
5.20.7 Verifying the OSPF Network Stability Optimization
Configuration
Prerequisites
All configurations of improving the stability of an OSPF network are complete.
Procedure
● Run the display ospf [
process-id ] brief command to check OSPF brief
information.
● Run the display ip routing-table command to check IP routing table
information.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 313
5.21 Improving the Security of an OSPF Network
Applicable Environment
On an OSPF network demanding high security, you can configure OSPF
authentication and the Generalized TTL Security Mechanism (GTSM) to improve
the security of the OSPF network.
NOTE
GTSM supports only unicast addresses; therefore, in OSPF, GTSM takes effect on virtual links
and sham links.
Pre-configuration Tasks
Before improving the security of an OSPF network, complete the following tasks:
● Configure IP addresses for interfaces to ensure that neighboring nodes are
reachable at the network layer.
● Configure basic OSPF functions.
Configuration Procedure
Perform one or more of the following configuration tasks (excluding the task of
Verifying the OSPF Network Security Optimization Configuration) as required.
5.21.1 Configuring OSPF GTSM
Context
The Generalized TTL Security Mechanism (GTSM) protects a switch by checking
whether the TTL value in an IP packet header is in a pre-defined range to improve
system security.
To make GTSM take effect, you need to enable GTSM on both ends of an OSPF
connection.
The valid TTL range of packets is [255 -
hops + 1, 255].
GTSM checks the TTL value of only the packets that match the GTSM policy. For
the packets that do not match the GTSM policy, you can configure a default action
to pass or drop them. If the default action is drop, you need to configure GTSM for
all switch connections. If GTSM is not configured for a switch, packets from the
switch are dropped. Therefore, the connection to the switch cannot be established.
This ensures security but reduces the ease of use.
You can enable the log function to record information about dropped packets,
facilitating fault locating.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 314
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf valid-ttl-hops
hops [ nonstandard-multicast ] [ vpn-instance
vpn-
instance-name ]
OSPF GTSM is configured.
NOTE
The ospf valid-ttl-hops command has two functions:
● Enabling OSPF GTSM
● Configuring a valid TTL range of packets
The parameter vpn-instance is valid only for the latter function.
Therefore, if only a private network policy or a public network policy is configured, you are
advised to set the default action to be performed on packets that do not match the GTSM
policy as pass. This prevents the OSPF packets of other instances from being discarded
incorrectly.
Step 3 (Optional) Run gtsm default-action { drop | pass }
The default action to be performed on packets that do not match the GTSM policy
is set.
By default, the action is pass.
NOTE
If the default action is configured but no GTSM policy is configured, GTSM does not take
effect.
Step 4 (Optional) Run gtsm log drop-packet all
The log function is enabled on the device in the system view. The information
about the packets dropped by GTSM will be recorded in the log.
----End
5.21.2 Configuring an Area Authentication Mode
Context
In area authentication, all switches in an area must use the same area
authentication mode and password. For example, all switches in Area 0 are
configured to use the simple authentication mode and a password of abc.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 315
NOTICE
If plain is selected in the area authentication configuration, the password is stored
in plaintext in the configuration file. For security purposes, you are advised to
select cipher to store the password in ciphertext.
Simple authentication, MD5 authentication, and HMAC-MD5 ciphertext
authentication have potential security risks. HMAC-SHA256 ciphertext
authentication is recommended.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run area
area-id
The OSPF area view is displayed.
Step 4 Run any of the following commands to configure an authentication mode for the
OSPF area as required:
● Run authentication-mode simple [ plain
plain-text | [ cipher ]
cipher-text ]
Simple authentication is configured for the OSPF area.
– plain: indicates that the password is stored in plaintext.
– cipher: indicates that the password is stored in ciphertext. For MD5
authentication or HMAC-MD5 authentication, the password is stored in
ciphertext by default.
● Run authentication-mode { md5 | hmac-md5 | hmac-sha256 } [
key-id
{ plain
plain-text | [ cipher ]
cipher-text } ]
An authentication mode is configured for the OSPF area.
– md5: indicates that MD5 ciphertext authentication is used.
– hmac-md5: indicates that HMAC-MD5 ciphertext authentication is used.
– hmac-sha256: indicates that HMAC-SHA256 ciphertext authentication is
used.
–
key-id: specifies the authentication key ID in ciphertext authentication.
● Run authentication-mode keychain
keychain-name
Keychain authentication is configured for the OSPF area.
NOTE
Before using Keychain authentication, you need to configure Keychain information in
the system view. To enable switches to successfully establish an OSPF neighbor
relationship, ensure that key-id, algorithm, and key-string in the local ActiveSendKey
are the same as those in the remote ActiveRecvKey.
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support keychain
keychain-name.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 316
5.21.3 Configuring an Interface Authentication Mode
Context
Interface authentication, using an authentication mode and a password, is
performed among neighboring switches. The priority of interface authentication is
higher than that of area authentication.
NOTICE
If plain is selected in the interface authentication configuration, the password is
stored in plaintext in the configuration file. For security purposes, you are advised
to select cipher to store the password in ciphertext.
Simple authentication, MD5 authentication, and HMAC-MD5 ciphertext
authentication have potential security risks. HMAC-SHA256 ciphertext
authentication is recommended.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The OSPF interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run any of the following commands to configure an authentication mode or null
authentication on an interface as required:
● Run ospf authentication-mode simple [ plain
plain-text | [ cipher ]
cipher-
text ]
Simple authentication is configured for the OSPF interface.
– simple: indicates that simple authentication is used.
– plain: indicates that the password is stored in plaintext.
– cipher: indicates that the password is stored in ciphertext. For MD5
authentication or HMAC-MD5 authentication, the password is stored in
ciphertext by default.
● Run ospf authentication-mode { md5 | hmac-md5 | hmac-sha256 } [
key-id
{ plain
plain-text | [ cipher ]
cipher-text } ]
An authentication mode is configured for the OSPF interface.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 317
– md5: indicates that MD5 ciphertext authentication is used.
– hmac-md5: indicates that HMAC-MD5 ciphertext authentication is used.
– hmac-sha256: indicates that HMAC-SHA256 ciphertext authentication is
used.
● Run ospf authentication-mode null
Null authentication is configured on the OSPF interface.
● Run ospf authentication-mode keychain
keychain-name
Keychain authentication is configured for the OSPF interface.
NOTE
Before using Keychain authentication, configure Keychain information in the system
view. To enable switches to successfully establish an OSPF neighbor relationship,
ensure that key-id, algorithm, and key-string in the local ActiveSendKey are the
same as those in the remote ActiveRecvKey.
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support keychain
keychain-name.
----End
5.21.4 Verifying the OSPF Network Security Optimization
Configuration
Prerequisites
The configurations for improving security of an OSPF network are complete.
Procedure
● Run the display gtsm statistics {
slot-id | all } command to check the GTSM
statistics.
● Run the display ospf [
process-id ] request-queue [
interface-type interface-
number ] [
neighbor-id ] command to check the OSPF request queue.
● Run the display ospf [
process-id ] retrans-queue [
interface-type interface-
number ] [
neighbor-id ] command to check the OSPF retransmission queue.
● Run the display ospf [
process-id ] error [ lsa ] command to check OSPF
error information.
----End
5.22 Configuring OSPF Neighbor Relationship Flapping
Suppression
Applicable Environment
If an interface carrying OSPF services frequently alternates between Up and Down,
the OSPF neighbor relationship flaps on the interface. In this case, OSPF frequently
sends Hello packets to reestablish the neighbor relationship, synchronizes LSDBs,
and recalculates routes. In this process, a large number of packets are exchanged,
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 318
adversely affecting stability of existing neighbor relationships, OSPF services, and
other OSPF-dependent services, such as LDP and BGP. To address this problem,
OSPF implements suppression of neighbor relationship flapping to delay OSPF
neighbor relationship reestablishment or prevent service traffic from passing
through flapping links.
NOTE
The following steps are optional.
Pre-configuration Tasks
Before configuring OSPF neighbor relationship flapping suppression, complete the
following tasks:
● Configure IP addresses for interfaces to ensure that neighboring nodes are
reachable at the network layer.
● 5.8 Configuring Basic OSPF Functions
Procedure
Step 1 Run system-view
The system view is displayed.
By default, suppression of OSPF neighbor relationship flapping is enabled globally.
To disable this function globally, run the suppress-flapping peer disable
command.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
By default, suppression of OSPF neighbor relationship flapping is enabled on all
interfaces in the same OSPF process. To disable this function on an interface, run
the ospf suppress-flapping peer disable command.
Step 3 Run ospf suppress-flapping peer hold-down
interval
The Hold-down mode of flapping suppression is configured, and the suppression
duration is set.
Flapping suppression works in either Hold-down or Hold-max-cost mode.
● Hold-down mode: In the case of frequent flooding and topology changes
during neighbor relationship establishment in an interface, the interface
prevents the reestablishment of the neighbor relationship, which minimizes
LSDB synchronization attempts and packet exchanges.
● Hold-max-cost mode: If the traffic forwarding path changes frequently, the
interface uses the maximum value 65535 as the cost of the flapping link,
which prevents traffic from passing through the flapping link.
Flapping suppression can also work first in Hold-down mode and then in Hold-
max-cost mode after the Hold-down mode exits.
By default, only the Hold-max-cost mode is enabled.
To disable the Hold-max-cost mode, run the ospf suppress-flapping peer hold-
max-cost disable command.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 319
Step 4 Run ospf suppress-flapping peer { detecting-interval
detecting-interval |
threshold
threshold | resume-interval
resume-interval } *
Detection parameters are configured for OSPF neighbor relationship flapping
suppression.
Each OSPF interface with OSPF neighbor relationship flapping suppression
enabled starts a flapping counter. If the interval between two successive status
changes of a neighbor from Full to a non-Full state is shorter than
detecting-
interval, a valid flapping_event is recorded and the flapping_count increments by
1. When the flapping_count reaches or exceeds
threshold, flapping suppression
takes effect. If the interval between two successive status changes of a neighbor
from Full to a non-Full state is longer than
resume-interval, the flapping_count is
reset.
NOTE
The value of
resume-interval must be greater than that of
detecting-interval.
By default, the value of detecting-interval is 60s, the value threshold is 10, and
the value of resume-interval is 120s. Default values of the detection parameters
are recommended.
Step 5 Run quit
The system view is displayed.
Step 6 Run quit
The user view is displayed.
Step 7 Run reset ospf
process-id suppress-flapping peer [
interface-type interface-
number ] [ notify-peer ]
The interface is forced to exit the suppression of OSPF neighbor relationship
flapping.
NOTE
An interface exits flapping suppression in any of the following scenarios:
● The suppression timer expires.
● The corresponding OSPF process is reset.
● Suppression of OSPF neighbor relationship flapping is disabled globally using the
suppress-flapping peer disable command in the OSPF view.
● The reset ospf suppress-flapping peer command is run.
----End
Verifying the Configuration
Run the display ospf [
process-id ] interface
interface-type interface-number
verbose command to check the status of OSPF neighbor relationship flapping
suppression.
<HUAWEI> display ospf interface vlanif 100 verbose
OSPF Process 1 with Router ID 10.1.1.2
Interfaces
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 320
Interface: 10.0.0.2 (VLANIF100)
Cost: 1 State: DR Type: Broadcast MTU: 1500
Priority: 1
Designated Router: 10.0.0.2
Backup Designated Router: 10.0.0.1
Timers: Hello 10 , Dead 40 , Poll 120 , Retransmit 5 , Transmit Delay 1
IO Statistics
Type Input Output
Hello 161367 10436
DB Description 18 18
Link-State Req 5 6
Link-State Update 203780 210
Link-State Ack 90411 276
ALLSPF GROUP
ALLDR GROUP
OpaqueId: 1 PrevState: BDR
Effective cost: 1, enabled by OSPF Protocol.
Suppress flapping peer: enable(flapping-count: 0, threshold: 20)
In the command output, Suppress flapping peer contains the information
indicating that flapping suppression is enabled.
5.23 Suppressing the Advertisement of Interface IP
Addresses
Applicable Environment
This section describes how to suppress the advertisement of interface IP addresses
so that the interface IP addresses can be reused.
Procedure
● Suppress the advertisement of the IP addresses of all interfaces in an OSPF
process.
a. Run system-view
The system view is displayed.
b. Run ospf [
process-id ]
The OSPF process view is displayed.
c. Run suppress-reachability
The advertisement of the IP addresses of all interfaces in the OSPF
process is suppressed.
By default, all interfaces in an OSPF process advertise their IP addresses.
● Suppress the advertisement of the IP addresses of a specified interface.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The OSPF interface view is displayed.
c. Run ospf suppress-reachability
The advertisement of the IP addresses of a specified interface is
suppressed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 321
By default, all OSPF interfaces advertise their IP addresses.
----End
5.24 Configuring Network Management for OSPF
Pre-configuration Tasks
OSPF supports network management. You can bind the OSPF MIB to an OSPF
process and configure the trap and log functions.
Before configuring network management for OSPF, complete the following tasks:
● Configure IP addresses for interfaces to ensure that neighboring nodes are
reachable at the network layer.
● Configure basic OSPF functions.
Configuration Procedure
Perform one or more configuration tasks (excluding the task of Verifying the OSPF
Network Management Configuration) as required.
5.24.1 Configuring OSPF MIB Binding
Context
In scenarios where multiple OSPF processes are enabled, you can bind the OSPF
MIB to a process.
Perform the following steps on an OSPF switch.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf mib-binding
process-id
The OSPF MIB is bound to a process.
----End
5.24.2 Configuring the OSPF Trap Function
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run snmp-agent trap enable feature-name ospf [ trap-name
{ ospfifauthfailure | ospfifconfigerror | ospfifrxbadpacket | ospfifstatechange |
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 322
ospflsdbapproachingoverflow | ospflsdboverflow | ospfmaxagelsa |
ospfnbrrestarthelperstatuschange | ospfnbrstatechange |
ospfnssatranslatorstatuschange | ospforiginatelsa | ospfrestartstatuschange |
ospftxretransmit | ospfvirtifauthfailure | ospfvirtifconfigerror |
ospfvirtifrxbadpacket | ospfvirtifstatechange | ospfvirtiftxretransmit |
ospfvirtnbrrestarthelperstatuschange | ospfvirtnbrstatechange } ]
The OSPF trap function is enabled.
To enable the trap function for one or more events, you can specify type-name.
----End
5.24.3 Configuring the OSPF Log Function
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ]
The OSPF process view is displayed.
Step 3 Run enable log [ config | error | state | snmp-trap ]
The OSPF log function is enabled.
----End
5.24.4 Verifying the OSPF Network Management
Configuration
Prerequisites
The configurations for the network management function of OSPF are complete.
Procedure
● Run the display ospf [
process-id ] brief command to view information about
the binding of OSPF MIBs and OSPF processes.
● Run the display snmp-agent trap feature-name ospf all command to view
all trap messages of the OSPF module.
----End
5.25 Maintaining OSPF
5.25.1 Clearing OSPF Information
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 323
Context
NOTICE
OSPF information cannot be restored after you clear it. Therefore, confirm the
action before you use the commands.
To clear OSPF information, run the following reset commands in the user view.
Procedure
● Run the reset ospf [
process-id ] counters [ neighbor [
interface-type
interface-number ] [
router-id ] ] command to reset OSPF counters.
– counters: indicates OSPF counters.
– neighbor: indicates neighbor information on a specified interface.
● Run the reset ospf [
process-id ] redistribution command in the user view to
re-import routes by OSPF.
● Run the reset gtsm statistics all command to clear the GTSM statistics from
the device.
----End
5.25.2 Resetting OSPF Information
Context
NOTICE
Running the reset ospf command will tear down the OSPF adjacency relationship
between two switches. Therefore, confirm the action before you use the
command.
To reset OSPF connections, run the following command in the user view.
Procedure
● Run the reset ospf [
process-id ] process [ flush-waiting-timer
time |
graceful-restart ] command to restart the OSPF process.
----End
5.26 Configuration Examples for OSPF
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 324
5.26.1 Example for Configuring Basic OSPF Functions
Networking Requirements
As shown in Figure 5-69, three switches on a network need to communicate with
each other, and the entire network needs to be extended based on SwitchA and
SwitchB as the service devices.
Figure 5-69 Networking diagram for configuring basic OSPF functions
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure VLANs for interfaces, VLANIF interfaces for the VLANs, and IP
addresses for each VLANIF interface to implement communication within
network segments.
2. Configure basic OSPF functions on each switch. Configure SwitchA as the ABR
to partition the OSPF network into two areas (Area0 and Area1) so that the
entire OSPF network can be extended using the area where SwitchA and
SwitchB are located as the backbone area.
Procedure
Step 1 Configure VLANs for interfaces.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure an IP address for each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 325
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.0.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.1.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure basic OSPF functions.
# Configure SwitchA.
[SwitchA] ospf 1 router-id 10.1.1.1
[SwitchA-ospf-1] area 0
[SwitchA-ospf-1-area-0.0.0.0] network 192.168.0.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] quit
[SwitchA-ospf-1] area 1
[SwitchA-ospf-1-area-0.0.0.1] network 192.168.1.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.1] return
# Configure SwitchB.
[SwitchB] ospf 1 router-id 10.2.2.2
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 192.168.0.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] return
# Configure SwitchC.
[SwitchC] ospf 1 router-id 10.3.3.3
[SwitchC-ospf-1] area 1
[SwitchC-ospf-1-area-0.0.0.1] network 192.168.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.1] return
Step 4 Verify the configuration.
# Check information about OSPF neighbors on SwitchA.
<SwitchA> display ospf peer
OSPF Process 1 with Router ID 10.1.1.1
Neighbors
Area 0.0.0.0 interface 192.168.0.1(Vlanif10)'s neighbors
Router ID: 10.2.2.2 Address: 192.168.0.2
State: Full Mode:Nbr is Master Priority: 1
DR: 192.168.0.2 BDR: 192.168.0.1 MTU: 0
Dead timer due in 36 sec
Retrans timer interval: 5
Neighbor is up for 00:15:04
Authentication Sequence: [ 0 ]
Neighbors
Area 0.0.0.1 interface 192.168.1.1(Vlanif20)'s neighbors
Router ID: 10.3.3.3 Address: 192.168.1.2
State: Full Mode:Nbr is Master Priority: 1
DR: 192.168.1.2 BDR: 192.168.1.1 MTU: 0
Dead timer due in 39 sec
Retrans timer interval: 5
Neighbor is up for 00:07:32
Authentication Sequence: [ 0 ]
# Check the OSPF routing information on SwitchC.
<SwitchC> display ospf routing
OSPF Process 1 with Router ID 10.3.3.3
Routing Tables
Routing for Network
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 326
Destination Cost Type NextHop AdvRouter Area
192.168.1.0/24 1 Transit 192.168.1.2 10.3.3.3 0.0.0.1
192.168.0.0/24 2 Inter-area 192.168.1.1 10.1.1.1 0.0.0.1
Total Nets: 2
Intra Area: 1 Inter Area: 1 ASE: 0 NSSA: 0
The preceding command output shows that SwitchC has an inter-area route to the
network segment 192.168.0.0/24.
# Check the routing table on SwitchB, and perform the ping operation on SwitchB
to test the connectivity between SwitchB and SwitchC.
<SwitchB> display ospf routing
OSPF Process 1 with Router ID 10.2.2.2
Routing Tables
Routing for Network
Destination Cost Type NextHop AdvRouter Area
192.168.0.0/24 1 Transit 192.168.0.2 10.2.2.2 0.0.0.0
192.168.1.0/24 2 Inter-area 192.168.0.1 10.1.1.1 0.0.0.0
Total Nets: 2
Intra Area: 1 Inter Area: 1 ASE: 0 NSSA: 0
The preceding command output shows that SwitchB has an inter-area route to the
network segment 192.168.1.0/24.
# Perform the ping operation on SwitchB to test the connectivity between SwitchB
and SwitchC.
<SwitchB> ping 192.168.1.2
PING 192.168.1.2: 56 data bytes, press CTRL_C to break
Reply from 192.168.1.2: bytes=56 Sequence=1 ttl=253 time=62 ms
Reply from 192.168.1.2: bytes=56 Sequence=2 ttl=253 time=16 ms
Reply from 192.168.1.2: bytes=56 Sequence=3 ttl=253 time=62 ms
Reply from 192.168.1.2: bytes=56 Sequence=4 ttl=253 time=94 ms
Reply from 192.168.1.2: bytes=56 Sequence=5 ttl=253 time=63 ms
--- 192.168.1.2 ping statistics ---
5 packet(s) transmitted
5 packet(s) received
0.00% packet loss
round-trip min/avg/max = 16/59/94 ms
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 192.168.0.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 327
port link-type trunk
port trunk allow-pass vlan 20
#
ospf 1 router-id 10.1.1.1
area 0.0.0.0
network 192.168.0.0 0.0.0.255
area 0.0.0.1
network 192.168.1.0 0.0.0.255
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10
#
interface Vlanif10
ip address 192.168.0.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
ospf 1 router-id 10.2.2.2
area 0.0.0.0
network 192.168.0.0 0.0.0.255
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20
#
interface Vlanif20
ip address 192.168.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
ospf 1 router-id 10.3.3.3
area 0.0.0.1
network 192.168.1.0 0.0.0.255
#
return
5.26.2 Example for Configuring OSPF DR Election
Networking Requirements
As shown in Figure 5-70, five switches are deployed with the intermediate Layer 2
switch connecting the other four switches running OSPF. The DR elected by default
among the four switches does not meet the network requirements. SwitchA needs
to be elected as the DR to exchange LSA information with other devices on the
OSPF network, and SwitchC needs to be used as the backup of SwitchA. For other
service demands, SwitchB needs to exchange LSA information with other devices
on the OSPF network through the DR.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 328
Figure 5-70 Networking diagram for configuring OSPF DR election
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic OSPF functions on each switch and check the default DR
election result among the four switches.
2. Configure the DR priorities for interfaces on SwitchA, SwitchB, and SwitchC to
100, 0, and 2 respectively. In this way, SwitchA is elected as the DR and
SwitchC as the BDR, SwitchB never becomes the DR or BDR, and SwitchD uses
the default DR priority and remains unchanged.
Procedure
Step 1 Configure VLANs for interfaces.
# Configure SwitchA. The configurations of Switch, SwitchB, SwitchC, and SwitchD
are similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Configure an IP address for each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.1 24
[SwitchA-Vlanif10] quit
Step 3 Configure basic OSPF functions.
# Configure SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 329
[SwitchA] ospf 1 router-id 10.1.1.1
[SwitchA-ospf-1] area 0
[SwitchA-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] quit
[SwitchA-ospf-1] quit
# Configure SwitchB.
[SwitchB] ospf 1 router-id 10.2.2.2
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
# Configure SwitchC.
[SwitchC] ospf 1 router-id 10.3.3.3
[SwitchC-ospf-1] area 0
[SwitchC-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] quit
[SwitchC-ospf-1] quit
# Configure SwitchD.
[SwitchD] ospf 1 router-id 10.4.4.4
[SwitchD-ospf-1] area 0
[SwitchD-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
[SwitchD-ospf-1-area-0.0.0.0] quit
[SwitchD-ospf-1] quit
[SwitchD] quit
# Check information about OSPF neighbors on SwitchA.
[SwitchA] display ospf peer
OSPF Process 1 with Router ID 10.1.1.1
Neighbors
Area 0.0.0.0 interface 192.168.1.1(Vlanif10)'s neighbors
Router ID: 10.2.2.2 Address: 192.168.1.2
State: 2-Way Mode:Nbr is Master Priority: 1
DR: 192.168.1.4 BDR: 192.168.1.3 MTU: 0
Dead timer due in 32 sec
Retrans timer interval: 5
Neighbor is up for 00:04:21
Authentication Sequence: [ 0 ]
Router ID: 10.3.3.3 Address: 192.168.1.3
State: Full Mode:Nbr is Master Priority: 1
DR: 192.168.1.4 BDR: 192.168.1.3 MTU: 0
Dead timer due in 37 sec
Retrans timer interval: 5
Neighbor is up for 00:04:06
Authentication Sequence: [ 0 ]
Router ID: 10.4.4.4 Address: 192.168.1.4
State: Full Mode:Nbr is Master Priority: 1
DR: 192.168.1.4 BDR: 192.168.1.3 MTU: 0
Dead timer due in 37 sec
Retrans timer interval: 5
Neighbor is up for 00:03:53
Authentication Sequence: [ 0 ]
The preceding command output shows the default DR election result that SwitchD
is the DR and SwitchC is the BDR. When the DR priorities are the same, the device
with a greater router ID is elected as the DR.
Step 4 Set a DR priority for each switch interface.
# Configure SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 330
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ospf dr-priority 100
[SwitchA-Vlanif10] quit
[SwitchA] quit
# Configure SwitchB.
[SwitchB] interface vlanif 10
[SwitchB-Vlanif10] ospf dr-priority 0
[SwitchB-Vlanif10] quit
[SwitchB] quit
# Configure SwitchC.
[SwitchC] interface vlanif 10
[SwitchC-Vlanif10] ospf dr-priority 2
[SwitchC-Vlanif10] quit
[SwitchC] quit
# Check information about OSPF neighbors on SwitchD.
<SwitchD> display ospf peer
OSPF Process 1 with Router ID 10.4.4.4
Neighbors
Area 0.0.0.0 interface 192.168.1.4(Vlanif10)'s neighbors
Router ID: 10.1.1.1 Address: 192.168.1.1
State: Full Mode:Nbr is Slave Priority: 100
DR: 192.168.1.4 BDR: 192.168.1.3 MTU: 0
Dead timer due in 31 sec
Retrans timer interval: 5
Neighbor is up for 00:11:17
Authentication Sequence: [ 0 ]
Router ID: 10.2.2.2 Address: 192.168.1.2
State: Full Mode:Nbr is Slave Priority: 0
DR: 192.168.1.4 BDR: 192.168.1.3 MTU: 0
Dead timer due in 35 sec
Retrans timer interval: 5
Neighbor is up for 00:11:19
Authentication Sequence: [ 0 ]
Router ID: 10.3.3.3 Address: 192.168.1.3
State: Full Mode:Nbr is Slave Priority: 2
DR: 192.168.1.4 BDR: 192.168.1.3 MTU: 0
Dead timer due in 33 sec
Retrans timer interval: 5
Neighbor is up for 00:11:15
Authentication Sequence: [ 0 ]
The preceding command output shows that the DR election result among the four
switches remains unchanged. This is because that, even if a newly added device
has the highest DR priority, the device cannot immediately become the DR on the
network segment after the DR and BDR election is complete. DR and BDR election
is performed again only after the OSPF process is restarted.
Step 5 Restart the OSPF process.
# In the user view of each switch, run the reset ospf 1 process command to
restart the OSPF process simultaneously. The simultaneous restart of the OSPF
process enables each switch to participate in elections of the DR and BDR.
# Restart SwitchA.
<SwitchA> reset ospf 1 process
# Restart SwitchB.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 331
<SwitchB> reset ospf 1 process
# Restart SwitchC.
<SwitchC> reset ospf 1 process
# Restart SwitchD.
<SwitchD> reset ospf 1 process
Step 6 Verify the configuration.
# Check information about OSPF neighbors on SwitchD.
<SwitchD> display ospf peer
OSPF Process 1 with Router ID 10.4.4.4
Neighbors
Area 0.0.0.0 interface 192.168.1.4(Vlanif10)'s neighbors
Router ID: 10.1.1.1 Address: 192.168.1.1
State: Full Mode:Nbr is Slave Priority: 100
DR: 192.168.1.1 BDR: 192.168.1.3 MTU: 0
Dead timer due in 35 sec
Retrans timer interval: 5
Neighbor is up for 00:07:19
Authentication Sequence: [ 0 ]
Router ID: 10.2.2.2 Address: 192.168.1.2
State: 2-Way Mode:Nbr is Master Priority: 0
DR: 192.168.1.1 BDR: 192.168.1.3 MTU: 0
Dead timer due in 35 sec
Retrans timer interval: 5
Neighbor is up for 00:07:19
Authentication Sequence: [ 0 ]
Router ID: 10.3.3.3 Address: 192.168.1.3
State: Full Mode:Nbr is Slave Priority: 2
DR: 192.168.1.1 BDR: 192.168.1.3 MTU: 0
Dead timer due in 37 sec
Retrans timer interval: 5
Neighbor is up for 00:07:17
Authentication Sequence: [ 0 ]
The preceding command output shows that SwitchA is elected as the DR and
SwitchC as the BDR. The neighbor status between SwitchD and SwitchB is 2-Way,
indicating that neither of them is the DR or BDR and they do not exchange LSA
information.
----End
Configuration Files
● Switch configuration file
#
sysname Switch
#
vlan batch 10
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 10
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 332
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/4
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
ospf dr-priority 100
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
ospf 1 router-id 10.1.1.1
area 0.0.0.0
network 192.168.1.0 0.0.0.255
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
ospf dr-priority 0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
ospf 1 router-id 10.2.2.2
area 0.0.0.0
network 192.168.1.0 0.0.0.255
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 10
#
interface Vlanif10
ip address 192.168.1.3 255.255.255.0
ospf dr-priority 2
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
ospf 1 router-id 10.3.3.3
area 0.0.0.0
network 192.168.1.0 0.0.0.255
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 333
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 10
#
interface Vlanif10
ip address 192.168.1.4 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
ospf 1 router-id 10.4.4.4
area 0.0.0.0
network 192.168.1.0 0.0.0.255
#
return
5.26.3 Example for Configuring OSPF Stub Areas
Networking Requirements
As shown in Figure 5-71, OSPF is running among three switches, the entire OSPF
network is partitioned into Area0 and Area1, and SwitchB functions as an ASBR to
communicate with external networks. The size of the OSPF routing table on
SwitchC needs to be reduced, which is expected not to affect the communication.
Figure 5-71 Networking diagram for configuring an OSPF stub area
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic OSPF functions on each switch to implement basic
connections on the OSPF network.
2. Configure static routes on SwitchB and import them to the OSPF routing table
so that there are reachable routes between the OSPF network and external
networks.
3. Configure Area1 as a stub area to reduce the size of the OSPF routing table
on SwitchC.
4. Disable the ABR (SwitchA) from advertising Type 3 LSAs to Area1 (this
configuration indicates that Area 1 is configured as a totally stub area) to
further reduce the size of the OSPF routing table on SwitchC.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 334
Procedure
Step 1 Configure VLANs for interfaces.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure an IP address for each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.0.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.1.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure basic OSPF functions.
# Configure SwitchA.
[SwitchA] ospf 1 router-id 10.1.1.1
[SwitchA-ospf-1] area 0
[SwitchA-ospf-1-area-0.0.0.0] network 192.168.0.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] quit
[SwitchA-ospf-1] area 1
[SwitchA-ospf-1-area-0.0.0.1] network 192.168.1.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.1] quit
[SwitchA-ospf-1] quit
# Configure SwitchB.
[SwitchB] ospf 1 router-id 10.2.2.2
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 192.168.0.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
# Configure SwitchC.
[SwitchC] ospf 1 router-id 10.3.3.3
[SwitchC-ospf-1] area 1
[SwitchC-ospf-1-area-0.0.0.1] network 192.168.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.1] quit
[SwitchC-ospf-1] quit
Step 4 # Configure SwitchB to import static routes.
[SwitchB] ip route-static 10.0.0.0 8 null 0
[SwitchB] ospf 1
[SwitchB-ospf-1] import-route static type 1
[SwitchB-ospf-1] quit
# Check the OSPF routing table on SwitchC. AS external routes exist in the table.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 335
[SwitchC] display ospf routing
OSPF Process 1 with Router ID 10.3.3.3
Routing Tables
Routing for Network
Destination Cost Type NextHop AdvRouter Area
192.168.1.0/24 1 Transit 192.168.1.2 10.3.3.3 0.0.0.1
192.168.0.0/24 2 Inter-area 192.168.1.1 10.1.1.1 0.0.0.1
Routing for ASEs
Destination Cost Type Tag NextHop AdvRouter
10.0.0.0/8 3 Type1 1 192.168.1.1 10.2.2.2
Total Nets: 3
Intra Area: 1 Inter Area: 1 ASE: 1 NSSA: 0
Step 5 Configure Area1 as a stub area.
# Configure SwitchA.
[SwitchA] ospf 1
[SwitchA-ospf-1] area 1
[SwitchA-ospf-1-area-0.0.0.1] stub
[SwitchA-ospf-1-area-0.0.0.1] quit
[SwitchA-ospf-1] quit
# Configure SwitchC.
[SwitchC] ospf 1
[SwitchC-ospf-1] area 1
[SwitchC-ospf-1-area-0.0.0.1] stub
[SwitchC-ospf-1-area-0.0.0.1] quit
[SwitchC-ospf-1] quit
# Check the OSPF routing table on SwitchC. AS external routes do not exist in the
table, but a default route to external networks is added to the table.
[SwitchC] display ospf routing
OSPF Process 1 with Router ID 10.3.3.3
Routing Tables
Routing for Network
Destination Cost Type NextHop AdvRouter Area
192.168.1.0/24 1 Transit 192.168.1.2 10.3.3.3 0.0.0.1
0.0.0.0/0 2 Inter-area 192.168.1.1 10.1.1.1 0.0.0.1
192.168.0.0/24 2 Inter-area 192.168.1.1 10.1.1.1 0.0.0.1
Total Nets: 3
Intra Area: 1 Inter Area: 2 ASE: 0 NSSA: 0
Step 6 Configure Area1 as a totally stub area.
[SwitchA] ospf 1
[SwitchA-ospf-1] area 1
[SwitchA-ospf-1-area-0.0.0.1] stub no-summary
[SwitchA-ospf-1-area-0.0.0.1] quit
[SwitchA-ospf-1] quit
Step 7 Verify the configuration.
# Check the OSPF routing table on SwitchC. The route with the destination
address 192.168.0.0/24 does not exist in the table. Only intra-area OSPF routes
and a default route to external networks exist in the table.
[SwitchC] display ospf routing
OSPF Process 1 with Router ID 10.3.3.3
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 336
Routing Tables
Routing for Network
Destination Cost Type NextHop AdvRouter Area
192.168.1.0/24 1 Transit 192.168.1.2 10.3.3.3 0.0.0.1
0.0.0.0/0 2 Inter-area 192.168.1.1 10.1.1.1 0.0.0.1
Total Nets: 2
Intra Area: 1 Inter Area: 1 ASE: 0 NSSA: 0
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 192.168.0.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
ospf 1 router-id 10.1.1.1
area 0.0.0.0
network 192.168.0.0 0.0.0.255
area 0.0.0.1
network 192.168.1.0 0.0.0.255
stub no-summary
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10
#
interface Vlanif10
ip address 192.168.0.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
ospf 1 router-id 10.2.2.2
import-route static type 1
area 0.0.0.0
network 192.168.0.0 0.0.0.255
#
ip route-static 10.0.0.0 255.0.0.0 NULL0
#
return
● SwitchC configuration file
#
sysname SwitchC
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 337
#
vlan batch 20
#
interface Vlanif20
ip address 192.168.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
ospf 1 router-id 10.3.3.3
area 0.0.0.1
network 192.168.1.0 0.0.0.255
stub
#
return
5.26.4 Example for Configuring an OSPF NSSA
Networking Requirements
As shown in Figure 5-72, OSPF is running on four switches, and the entire OSPF
network is partitioned into Area0 and Area1. It is required that devices in Area1 do
not receive external routes imported by other OSPF areas but they import external
routes through the ASBR to communicate with external networks. Because there
are a large number of services configured on SwitchB, SwitchA needs to be
specified as a translator to translate Type7 LSAs to Type5 LSAs and send them to
other OSPF areas.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 5-72 Networking diagram for configuring an OSPF NSSA
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic OSPF functions on each switch to implement basic
connections on the OSPF network.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 338
2. Configure Area1 as an NSSA, configure static routes on SwitchD, and import
the static routes to the OSPF routing table. In this way, switches in Area1 can
communicate with external networks only through SwitchD.
3. Configure SwitchA as a translator so that it can translate Type7 LSAs to Type5
LSAs and then send them to other OSPF areas.
Procedure
Step 1 Configure VLANs for interfaces.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 30
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 30
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure an IP address for each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 30
[SwitchA-Vlanif30] ip address 192.168.3.1 24
[SwitchA-Vlanif30] quit
Step 3 Configure basic OSPF functions.
# Configure SwitchA.
[SwitchA] ospf 1 router-id 10.1.1.1
[SwitchA-ospf-1] area 0
[SwitchA-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] quit
[SwitchA-ospf-1] area 1
[SwitchA-ospf-1-area-0.0.0.1] network 192.168.3.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.1] quit
[SwitchA-ospf-1] quit
# Configure SwitchB.
[SwitchB] ospf 1 router-id 10.2.2.2
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 192.168.2.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] area 1
[SwitchB-ospf-1-area-0.0.0.1] network 192.168.4.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.1] quit
[SwitchB-ospf-1] quit
# Configure SwitchC.
[SwitchC] ospf 1 router-id 10.3.3.3
[SwitchC-ospf-1] area 0
[SwitchC-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 339
[SwitchC-ospf-1-area-0.0.0.0] network 192.168.2.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] quit
[SwitchC-ospf-1] quit
# Configure SwitchD.
[SwitchD] ospf 1 router-id 10.4.4.4
[SwitchD-ospf-1] area 1
[SwitchD-ospf-1-area-0.0.0.1] network 192.168.3.0 0.0.0.255
[SwitchD-ospf-1-area-0.0.0.1] network 192.168.4.0 0.0.0.255
[SwitchD-ospf-1-area-0.0.0.1] quit
[SwitchD-ospf-1] quit
Step 4 Configure Area1 as an NSSA.
# Configure SwitchA.
[SwitchA] ospf 1
[SwitchA-ospf-1] area 1
[SwitchA-ospf-1-area-0.0.0.1] nssa
[SwitchA-ospf-1-area-0.0.0.1] quit
[SwitchA-ospf-1] quit
# Configure SwitchB.
[SwitchB] ospf 1
[SwitchB-ospf-1] area 1
[SwitchB-ospf-1-area-0.0.0.1] nssa
[SwitchB-ospf-1-area-0.0.0.1] quit
[SwitchB-ospf-1] quit
# Configure SwitchD.
[SwitchD] ospf 1
[SwitchD-ospf-1] area 1
[SwitchD-ospf-1-area-0.0.0.1] nssa
[SwitchD-ospf-1-area-0.0.0.1] quit
[SwitchD-ospf-1] quit
Step 5 Configure SwitchD to import static routes.
[SwitchD] ip route-static 172.16.0.0 16 null 0
[SwitchD] ospf 1
[SwitchD-ospf-1] import-route static
[SwitchD-ospf-1] quit
# Check the OSPF routing table on SwitchC.
[SwitchC] display ospf routing
OSPF Process 1 with Router ID 10.3.3.3
Routing Tables
Routing for Network
Destination Cost Type NextHop AdvRouter Area
192.168.1.0/24 1 Transit 192.168.1.2 10.3.3.3 0.0.0.0
192.168.2.0/24 1 Transit 192.168.2.2 10.3.3.3 0.0.0.0
192.168.3.0/24 2 Inter-area 192.168.1.1 10.1.1.1 0.0.0.0
192.168.4.0/24 2 Inter-area 192.168.2.1 10.2.2.2 0.0.0.0
Routing for ASEs
Destination Cost Type Tag NextHop AdvRouter
172.16.0.0/16 1 Type2 1 192.168.1.1 10.2.2.2
Total Nets: 5
Intra Area: 2 Inter Area: 2 ASE: 1 NSSA: 0
The preceding command output shows that AS external routes imported by the
NSSA are advertised to other areas through SwitchB. That is, SwitchB translates
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 340
Type7 LSAs to Type5 LSAs. This is because that OSPF selects the ABR (SwitchB)
with a greater router ID as the translator.
Step 6 Configure SwitchA as a translator.
[SwitchA] ospf 1
[SwitchA-ospf-1] area 1
[SwitchA-ospf-1-area-0.0.0.1] nssa translator-always
[SwitchA-ospf-1-area-0.0.0.1] quit
[SwitchA-ospf-1] quit
Step 7 Verify the configuration.
# Check the OSPF routing table on SwitchC after 40 seconds.
[SwitchC] display ospf routing
OSPF Process 1 with Router ID 10.3.3.3
Routing Tables
Routing for Network
Destination Cost Type NextHop AdvRouter Area
192.168.1.0/24 1 Transit 192.168.1.2 10.3.3.3 0.0.0.0
192.168.2.0/24 1 Transit 192.168.2.2 10.3.3.3 0.0.0.0
192.168.3.0/24 2 Inter-area 192.168.1.1 10.1.1.1 0.0.0.0
192.168.4.0/24 2 Inter-area 192.168.2.1 10.2.2.2 0.0.0.0
Routing for ASEs
Destination Cost Type Tag NextHop AdvRouter
172.16.0.0/16 1 Type2 1 192.168.1.1 10.1.1.1
Total Nets: 5
Intra Area: 2 Inter Area: 2 ASE: 1 NSSA: 0
The preceding command output shows that AS external routes imported by the
NSSA are advertised to other areas through SwitchA. That is, SwitchA functions as
the translator.
NOTE
By default, both the new and original translators function for 40 seconds. After 40 seconds,
translation is performed by only the new translator.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 30
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface Vlanif30
ip address 192.168.3.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 10
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 341
ospf 1 router-id 10.1.1.1
area 0.0.0.0
network 192.168.1.0 0.0.0.255
area 0.0.0.1
network 192.168.3.0 0.0.0.255
nssa translator-always
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 20 40
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface Vlanif40
ip address 192.168.4.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
ospf 1 router-id 10.2.2.2
area 0.0.0.0
network 192.168.2.0 0.0.0.255
area 0.0.0.1
network 192.168.4.0 0.0.0.255
nssa
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 10 20
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
ospf 1 router-id 10.3.3.3
area 0.0.0.0
network 192.168.1.0 0.0.0.255
network 192.168.2.0 0.0.0.255
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30 40
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 342
#
interface Vlanif30
ip address 192.168.3.2 255.255.255.0
#
interface Vlanif40
ip address 192.168.4.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
ospf 1 router-id 10.4.4.4
import-route static
area 0.0.0.1
network 192.168.3.0 0.0.0.255
network 192.168.4.0 0.0.0.255
nssa
#
ip route-static 172.16.0.0 255.255.0.0 NULL0
#
return
5.26.5 Example for Configuring OSPF Load Balancing
Networking Requirements
On an OSPF network, as shown in Figure 5-73, four switches all belong to Area0.
Load balancing needs to be configured so that the traffic from SwitchA can be
sent to SwitchD through SwitchB and SwitchC.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 5-73 Networking diagram for configuring load balancing among OSPF
routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 343
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic OSPF functions on each switch to implement basic
connections on the OSPF network.
2. Configure load balancing on SwitchA.
Procedure
Step 1 Configure VLANs for interfaces.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20 50
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
[SwitchA] interface gigabitethernet 0/0/3
[SwitchA-GigabitEthernet0/0/3] port link-type trunk
[SwitchA-GigabitEthernet0/0/3] port trunk allow-pass vlan 50
[SwitchA-GigabitEthernet0/0/3] quit
Step 2 Configure an IP address for each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 10.1.2.1 24
[SwitchA-Vlanif20] quit
[SwitchA] interface vlanif 50
[SwitchA-Vlanif50] ip address 172.16.1.1 24
[SwitchA-Vlanif50] quit
Step 3 Configure basic OSPF functions.
# Configure SwitchA.
[SwitchA] ospf 1 router-id 10.10.10.1
[SwitchA-ospf-1] area 0
[SwitchA-ospf-1-area-0.0.0.0] network 172.16.1.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] network 10.1.1.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] network 10.1.2.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] quit
[SwitchA-ospf-1] quit
# Configure SwitchB.
[SwitchB] ospf 1 router-id 10.10.10.2
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 10.1.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] network 192.168.0.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 344
# Configure SwitchC.
[SwitchC] ospf 1 router-id 10.10.10.3
[SwitchC-ospf-1] area 0
[SwitchC-ospf-1-area-0.0.0.0] network 10.1.2.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] quit
[SwitchC-ospf-1] quit
# Configure SwitchD.
[SwitchD] ospf 1 router-id 10.10.10.4
[SwitchD-ospf-1] area 0
[SwitchD-ospf-1-area-0.0.0.0] network 192.168.0.0 0.0.0.255
[SwitchD-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
[SwitchD-ospf-1-area-0.0.0.0] network 172.17.1.0 0.0.0.255
[SwitchD-ospf-1-area-0.0.0.0] quit
[SwitchD-ospf-1] quit
# Check the routing table on SwitchA.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 11 Routes : 12
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/24 Direct 0 0 D 10.1.1.1 Vlanif10
10.1.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
10.1.2.0/24 Direct 0 0 D 10.1.2.1 Vlanif20
10.1.2.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.1.0/24 Direct 0 0 D 172.16.1.1 Vlanif50
172.16.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif50
172.17.1.0/24 OSPF 10 3 D 10.1.1.2 Vlanif10
OSPF 10 3 D 10.1.2.2 Vlanif20
192.168.0.0/24 OSPF 10 2 D 10.1.1.2 Vlanif10
192.168.1.0/24 OSPF 10 2 D 10.1.2.2 Vlanif20
The preceding command output shows that both next hops of SwitchA, namely,
10.1.1.2 (SwitchB) and 10.1.2.2 (SwitchC), become valid. This is because that the
default quantity of equal-cost routes allowed for a switch is 8.
Step 4 Configure a weight for an equal-cost route on SwitchA.
If you do not want load balancing between SwitchB and SwitchC, set a weight for
one of the equal-cost routes to specify the next hop.
[SwitchA] ospf 1
[SwitchA-ospf-1] nexthop 10.1.2.2 weight 1
[SwitchA-ospf-1] quit
# Check the routing table on SwitchA.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 11 Routes : 11
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/24 Direct 0 0 D 10.1.1.1 Vlanif10
10.1.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
10.1.2.0/24 Direct 0 0 D 10.1.2.1 Vlanif20
10.1.2.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 345
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.1.0/24 Direct 0 0 D 172.16.1.1 Vlanif50
172.16.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif50
172.17.1.0/24 OSPF 10 3 D 10.1.2.2 Vlanif20
192.168.0.0/24 OSPF 10 2 D 10.1.1.2 Vlanif10
192.168.1.0/24 OSPF 10 2 D 10.1.2.2 Vlanif20
The preceding command output shows that the priority of the next hop 10.1.2.2
(SwitchC) with weight 1 is higher than that of 10.1.1.2 (SwitchB). Therefore, OSPF
selects the route with the next hop 10.1.2.2 as the optimal route.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20 50
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
#
interface Vlanif20
ip address 10.1.2.1 255.255.255.0
#
interface Vlanif50
ip address 172.16.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 50
#
ospf 1 router-id 10.10.10.1
nexthop 10.1.2.2 weight 1
area 0.0.0.0
network 10.1.1.0 0.0.0.255
network 10.1.2.0 0.0.0.255
network 172.16.1.0 0.0.0.255
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 30
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.0.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 346
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
ospf 1 router-id 10.10.10.2
area 0.0.0.0
network 10.1.1.0 0.0.0.255
network 192.168.0.0 0.0.0.255
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 40
#
interface Vlanif20
ip address 10.1.2.2 255.255.255.0
#
interface Vlanif40
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
ospf 1 router-id 10.10.10.3
area 0.0.0.0
network 10.1.2.0 0.0.0.255
network 192.168.1.0 0.0.0.255
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30 40 60
#
interface Vlanif30
ip address 192.168.0.2 255.255.255.0
#
interface Vlanif40
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif60
ip address 172.17.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 60
#
ospf 1 router-id 10.10.10.4
area 0.0.0.0
network 172.17.1.0 0.0.0.255
network 192.168.0.0 0.0.0.255
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 347
network 192.168.1.0 0.0.0.255
#
return
5.26.6 Example for Configuring OSPF-BGP Synchronization
Networking Requirements
As shown in Figure 5-74, an EBGP connection is established between SwitchD and
SwitchE. IBGP connections are established between switches in AS 10, and OSPF is
used as an IGP protocol. OSPF-BGP synchronization needs to be enabled on
SwitchB so that the traffic from SwitchA to AS 20 will not be interrupted when
SwitchB restarts.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 5-74 Networking diagram for configuring OSPF-BGP synchronization
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure VLANs for interfaces, VLANIF interfaces for the VLANs, and IP
addresses for each VLANIF interface to implement communication within
network segments.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 348
2. Configure basic OSPF functions and IBGP connections on SwitchA, SwitchB,
SwitchC, and SwitchD (excluding 10.2.1.1/30) to implement device
connections within AS 10.
3. Configure EBGP connections between SwitchD and SwitchE, and import direct
routes and OSPF routes to implement communication between AS 10 and AS
20.
4. Set the OSPF protocol cost to 2 on SwitchC so that SwitchA selects only
SwitchB as the intermediate router to the network segment 10.2.1.0 and
SwitchC becomes the backup of SwitchB.
5. Enable OSPF-BGP synchronization on SwitchB so that the traffic from SwitchA
to AS 20 will not be interrupted when SwitchB restarts.
Procedure
Step 1 Configure VLANs for interfaces.
# Configure SwitchA. The configurations of SwitchB, SwitchC, SwitchD, and
SwitchE are similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign IP addresses to the VLANIF interfaces and loopback interfaces.
# Configure SwitchA. The configurations of SwitchB, SwitchC, SwitchD, and
SwitchE are similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 30
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 10.1.2.1 30
[SwitchA-Vlanif20] quit
[SwitchA] interface loopback 0
[SwitchA-LoopBack0] ip address 10.10.10.1 32
[SwitchA-LoopBack0] quit
Step 3 Configure basic OSPF functions.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] router id 10.10.10.1
[SwitchA] ospf 1
[SwitchA-ospf-1] area 0
[SwitchA-ospf-1-area-0.0.0.0] network 10.10.10.1 0.0.0.0
[SwitchA-ospf-1-area-0.0.0.0] network 10.1.1.0 0.0.0.3
[SwitchA-ospf-1-area-0.0.0.0] network 10.1.2.0 0.0.0.3
[SwitchA-ospf-1-area-0.0.0.0] quit
[SwitchA-ospf-1] quit
Step 4 Configure IBGP fully meshed connections.
# Configure SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 349
[SwitchA] bgp 10
[SwitchA-bgp] peer 10.10.10.2 as-number 10
[SwitchA-bgp] peer 10.10.10.2 connect-interface LoopBack 0
[SwitchA-bgp] peer 10.10.10.3 as-number 10
[SwitchA-bgp] peer 10.10.10.3 connect-interface LoopBack 0
[SwitchA-bgp] peer 10.10.10.4 as-number 10
[SwitchA-bgp] peer 10.10.10.4 connect-interface LoopBack 0
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 10
[SwitchB-bgp] peer 10.10.10.1 as-number 10
[SwitchB-bgp] peer 10.10.10.1 connect-interface LoopBack 0
[SwitchB-bgp] peer 10.10.10.3 as-number 10
[SwitchB-bgp] peer 10.10.10.3 connect-interface LoopBack 0
[SwitchB-bgp] peer 10.10.10.4 as-number 10
[SwitchB-bgp] peer 10.10.10.4 connect-interface LoopBack 0
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 10
[SwitchC-bgp] peer 10.10.10.1 as-number 10
[SwitchC-bgp] peer 10.10.10.1 connect-interface LoopBack 0
[SwitchC-bgp] peer 10.10.10.2 as-number 10
[SwitchC-bgp] peer 10.10.10.2 connect-interface LoopBack 0
[SwitchC-bgp] peer 10.10.10.4 as-number 10
[SwitchC-bgp] peer 10.10.10.4 connect-interface LoopBack 0
[SwitchC-bgp] quit
# Configure SwitchD.
[SwitchD] bgp 10
[SwitchD-bgp] peer 10.10.10.1 as-number 10
[SwitchD-bgp] peer 10.10.10.1 connect-interface LoopBack 0
[SwitchD-bgp] peer 10.10.10.2 as-number 10
[SwitchD-bgp] peer 10.10.10.2 connect-interface LoopBack 0
[SwitchD-bgp] peer 10.10.10.3 as-number 10
[SwitchD-bgp] peer 10.10.10.3 connect-interface LoopBack 0
[SwitchD-bgp] quit
Step 5 Establish an EBGP connection.
# Configure SwitchD.
[SwitchD] bgp 10
[SwitchD-bgp] peer 10.2.1.2 as-number 20
[SwitchD-bgp] import-route direct
[SwitchD-bgp] import-route ospf 1
[SwitchD-bgp] quit
# Configure SwitchE.
[SwitchE] bgp 20
[SwitchE-bgp] router-id 10.10.10.5
[SwitchE-bgp] peer 10.2.1.1 as-number 10
[SwitchE-bgp] ipv4-family unicast
[SwitchE-bgp-af-ipv4] network 10.3.1.0 30
[SwitchE-bgp-af-ipv4] quit
[SwitchE-bgp] quit
Step 6 Configure a cost for OSPF on SwitchC.
[SwitchC] interface vlanif 20
[SwitchC-Vlanif20] ospf cost 2
[SwitchC-Vlanif20] quit
[SwitchC] interface vlanif 30
[SwitchC-Vlanif30] ospf cost 2
[SwitchC-Vlanif30] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 350
# Check the routing table on SwitchA. The routing table shows that the route to
the destination network segment 10.3.1.0 is learned through BGP and the
outbound interface is Vlanif10.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 14 Routes : 15
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/30 Direct 0 0 D 10.1.1.1 Vlanif10
10.1.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
10.1.2.0/30 Direct 0 0 D 10.1.2.1 Vlanif20
10.1.2.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
10.1.3.0/30 OSPF 10 2 D 10.1.1.2 Vlanif10
10.1.4.0/30 OSPF 10 3 D 10.1.2.2 Vlanif20
OSPF 10 3 D 10.1.1.2 Vlanif10
10.2.1.0/30 IBGP 255 0 RD 10.10.10.4 Vlanif10
10.3.1.0/30 IBGP 255 0 RD 10.2.1.2 Vlanif10
10.10.10.1/32 Direct 0 0 D 127.0.0.1 LoopBack0
10.10.10.2/32 OSPF 10 1 D 10.1.1.2 Vlanif10
10.10.10.3/32 OSPF 10 1 D 10.1.2.2 Vlanif20
10.10.10.4/32 OSPF 10 2 D 10.1.1.2 Vlanif10
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
# Check the routing table on SwitchB.
[SwitchB] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 14 Routes : 15
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/30 Direct 0 0 D 10.1.1.2 Vlanif10
10.1.1.2/32 Direct 0 0 D 127.0.0.1 Vlanif10
10.1.2.0/30 OSPF 10 2 D 10.1.1.1 Vlanif10
10.1.3.0/30 Direct 0 0 D 10.1.3.1 Vlanif40
10.1.3.1/32 Direct 0 0 D 127.0.0.1 Vlanif40
10.1.4.0/30 OSPF 10 2 D 10.1.3.2 Vlanif40
10.2.1.0/30 IBGP 255 0 RD 10.10.10.4 Vlanif40
10.3.1.0/30 IBGP 255 0 RD 10.2.1.2 Vlanif40
10.10.10.1/32 OSPF 10 1 D 10.1.1.1 Vlanif10
10.10.10.2/32 Direct 0 0 D 127.0.0.1 LoopBack0
10.10.10.3/32 OSPF 10 2 D 10.1.1.1 Vlanif10
OSPF 10 2 D 10.1.3.2 Vlanif40
10.10.10.4/32 OSPF 10 1 D 10.1.3.2 Vlanif40
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
The preceding command output shows that the route to the destination network
segment 10.3.1.0 is learned by SwitchB through BGP and the outbound interface is
Vlanif40. The routes to the network segments 10.1.2.0 and 10.1.4.0 are learned
through OSPF, and the costs of the routes are both 2.
Step 7 Configure OSPF-BGP synchronization on SwitchB.
[SwitchB] ospf
[SwitchB-ospf-1] stub-router on-startup
[SwitchB-ospf-1] return
Step 8 Verify the configuration.
# Save the configurations.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 351
<SwitchB> save
The system displays a message asking whether you want to save the
configurations. Enter y.
# Restart SwitchB.
<SwitchB> reboot
The system displays a message asking whether you want to continue with a
system reboot. Enter y.
# Check the routing table on SwitchA. The routing table shows that the route to
the destination network segment 10.3.1.0 is learned through BGP and the
outbound interface is Vlanif20.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 10 Routes : 10
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.2.0/30 Direct 0 0 D 10.1.2.1 Vlanif20
10.1.2.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
10.1.4.0/30 OSPF 10 3 D 10.1.2.2 Vlanif20
10.2.1.0/30 IBGP 255 0 RD 10.10.10.4 Vlanif20
10.3.1.0/30 IBGP 255 0 RD 10.2.1.2 Vlanif20
10.10.10.1/32 Direct 0 0 D 127.0.0.1 LoopBack0
10.10.10.3/32 OSPF 10 1 D 10.1.2.2 Vlanif20
10.10.10.4/32 OSPF 10 3 D 10.1.2.2 Vlanif20
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
# Check the routing table on SwitchB. The routing table shows that only OSPF
routes exist in the routing table and their costs are at least 65535. This is because
that OSPF (IGP) routes converge faster than BGP routes.
<SwitchB> display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 12 Routes : 13
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/30 Direct 0 0 D 10.1.1.2 Vlanif10
10.1.1.2/32 Direct 0 0 D 127.0.0.1 Vlanif10
10.1.2.0/30 OSPF 10 65536 D 10.1.1.1 Vlanif10
10.1.3.0/30 Direct 0 0 D 10.1.3.1 Vlanif40
10.1.3.1/32 Direct 0 0 D 127.0.0.1 Vlanif40
10.1.4.0/30 OSPF 10 65536 D 10.1.3.2 Vlanif40
10.10.10.1/32 OSPF 10 65535 D 10.1.1.1 Vlanif10
10.10.10.2/32 Direct 0 0 D 127.0.0.1 LoopBack0
10.10.10.3/32 OSPF 10 65536 D 10.1.1.1 Vlanif10
OSPF 10 65536 D 10.1.3.2 Vlanif40
10.10.10.4/32 OSPF 10 65535 D 10.1.3.2 Vlanif40
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
# After the network is stable, check the routing table of SwitchB again.
<SwitchB> display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 14 Routes : 15
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 352
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/30 Direct 0 0 D 10.1.1.2 Vlanif10
10.1.1.2/32 Direct 0 0 D 127.0.0.1 Vlanif10
10.1.2.0/30 OSPF 10 2 D 10.1.1.1 Vlanif10
10.1.3.0/30 Direct 0 0 D 10.1.3.1 Vlanif40
10.1.3.1/32 Direct 0 0 D 127.0.0.1 Vlanif40
10.1.4.0/30 OSPF 10 2 D 10.1.3.2 Vlanif40
10.2.1.0/30 IBGP 255 0 RD 10.10.10.4 Vlanif40
10.3.1.0/30 IBGP 255 0 RD 10.2.1.2 Vlanif40
10.10.10.1/32 OSPF 10 1 D 10.1.1.1 Vlanif10
10.10.10.2/32 Direct 0 0 D 127.0.0.1 LoopBack0
10.10.10.3/32 OSPF 10 2 D 10.1.1.1 Vlanif10
OSPF 10 2 D 10.1.3.2 Vlanif40
10.10.10.4/32 OSPF 10 1 D 10.1.3.2 Vlanif40
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
The preceding command output shows that, after BGP routes on SwitchB
converge, the routing information restores.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
router id 10.10.10.1
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.252
#
interface Vlanif20
ip address 10.1.2.1 255.255.255.252
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface LoopBack0
ip address 10.10.10.1 255.255.255.255
#
bgp 10
peer 10.10.10.2 as-number 10
peer 10.10.10.2 connect-interface LoopBack0
peer 10.10.10.3 as-number 10
peer 10.10.10.3 connect-interface LoopBack0
peer 10.10.10.4 as-number 10
peer 10.10.10.4 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
peer 10.10.10.2 enable
peer 10.10.10.3 enable
peer 10.10.10.4 enable
#
ospf 1
area 0.0.0.0
network 10.1.1.0 0.0.0.3
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 353
network 10.1.2.0 0.0.0.3
network 10.10.10.1 0.0.0.0
#
return
● SwitchB configuration file
#
sysname SwitchB
#
router id 10.10.10.2
#
vlan batch 10 40
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.252
#
interface Vlanif40
ip address 10.1.3.1 255.255.255.252
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
interface LoopBack0
ip address 10.10.10.2 255.255.255.255
#
bgp 10
peer 10.10.10.1 as-number 10
peer 10.10.10.1 connect-interface LoopBack0
peer 10.10.10.3 as-number 10
peer 10.10.10.3 connect-interface LoopBack0
peer 10.10.10.4 as-number 10
peer 10.10.10.4 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
peer 10.10.10.1 enable
peer 10.10.10.3 enable
peer 10.10.10.4 enable
#
ospf 1
stub-router on-startup
area 0.0.0.0
network 10.1.1.0 0.0.0.3
network 10.1.3.0 0.0.0.3
network 10.10.10.2 0.0.0.0
#
return
● SwitchC configuration file
#
sysname SwitchC
#
router id 10.10.10.3
#
vlan batch 20 30
#
interface Vlanif20
ip address 10.1.2.2 255.255.255.252
ospf cost 2
#
interface Vlanif30
ip address 10.1.4.1 255.255.255.252
ospf cost 2
#
interface GigabitEthernet0/0/1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 354
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface LoopBack0
ip address 10.10.10.3 255.255.255.255
#
bgp 10
peer 10.10.10.1 as-number 10
peer 10.10.10.1 connect-interface LoopBack0
peer 10.10.10.2 as-number 10
peer 10.10.10.2 connect-interface LoopBack0
peer 10.10.10.4 as-number 10
peer 10.10.10.4 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
peer 10.10.10.1 enable
peer 10.10.10.2 enable
peer 10.10.10.4 enable
#
ospf 1
area 0.0.0.0
network 10.1.2.0 0.0.0.3
network 10.1.4.0 0.0.0.3
network 10.10.10.3 0.0.0.0
#
return
● SwitchD configuration file
#
sysname SwitchD
#
router id 10.10.10.4
#
vlan batch 30 40 50
#
interface Vlanif30
ip address 10.1.4.2 255.255.255.252
#
interface Vlanif40
ip address 10.1.3.2 255.255.255.252
#
interface Vlanif50
ip address 10.2.1.1 255.255.255.252
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 50
#
interface LoopBack0
ip address 10.10.10.4 255.255.255.255
#
bgp 10
peer 10.10.10.1 as-number 10
peer 10.10.10.1 connect-interface LoopBack0
peer 10.10.10.2 as-number 10
peer 10.10.10.2 connect-interface LoopBack0
peer 10.10.10.3 as-number 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 355
peer 10.10.10.3 connect-interface LoopBack0
peer 10.2.1.2 as-number 20
#
ipv4-family unicast
undo synchronization
import-route direct
import-route ospf 1
peer 10.10.10.1 enable
peer 10.10.10.2 enable
peer 10.10.10.3 enable
peer 10.2.1.2 enable
#
ospf 1
area 0.0.0.0
network 10.1.3.0 0.0.0.3
network 10.1.4.0 0.0.0.3
network 10.10.10.4 0.0.0.0
#
return
● SwitchE configuration file
#
sysname SwitchE
#
vlan batch 50 60
#
interface Vlanif50
ip address 10.2.1.2 255.255.255.252
#
interface Vlanif60
ip address 10.3.1.1 255.255.255.252
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 50
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 60
#
interface LoopBack0
ip address 10.10.10.5 255.255.255.255
#
bgp 20
router-id 10.10.10.5
peer 10.2.1.1 as-number 10
#
ipv4-family unicast
undo synchronization
network 10.3.1.0 255.255.255.252
peer 10.2.1.1 enable
#
return
5.26.7 Example for Configuring OSPF GR
Networking Requirements
As shown in Figure 5-75, OSPF is running among three switches, and the entire
OSPF network is partitioned into Area0 and Area1. It is required that restarting the
OSPF process on SwitchC does not affect data forwarding.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 356
Figure 5-75 Networking diagram for configuring OSPF GR
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic OSPF functions on each switch to implement basic
connections on the OSPF network.
2. Enable the Opaque LSA function on SwitchA and SwitchC so that OSPF
supports OSPF GR through Type9 LSA.
3. Configure the GR function on SwitchA and SwitchC so that data is forwarded
properly when OSPF restarts.
Procedure
Step 1 Configure VLANs for interfaces.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure an IP address for each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.0.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.1.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure basic OSPF functions.
# Configure SwitchA.
[SwitchA] ospf 1 router-id 10.1.1.1
[SwitchA-ospf-1] area 0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 357
[SwitchA-ospf-1-area-0.0.0.0] network 192.168.0.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] quit
[SwitchA-ospf-1] area 1
[SwitchA-ospf-1-area-0.0.0.1] network 192.168.1.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.1] quit
[SwitchA-ospf-1] quit
# Configure SwitchB.
[SwitchB] ospf 1 router-id 10.2.2.2
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 192.168.0.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
# Configure SwitchC.
[SwitchC] ospf 1 router-id 10.3.3.3
[SwitchC-ospf-1] area 1
[SwitchC-ospf-1-area-0.0.0.1] network 192.168.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.1] quit
[SwitchC-ospf-1] quit
Step 4 Enable the Opaque LSA function.
# Configure SwitchA.
[SwitchA] ospf 1
[SwitchA-ospf-1] opaque-capability enable
[SwitchA-ospf-1] quit
# Configure SwitchC.
[SwitchC] ospf 1
[SwitchC-ospf-1] opaque-capability enable
[SwitchC-ospf-1] quit
Step 5 Configure the OSPF GR feature.
# Configure SwitchA.
[SwitchA] ospf 1
[SwitchA-ospf-1] graceful-restart
[SwitchA-ospf-1] return
# Configure SwitchC.
[SwitchC] ospf 1
[SwitchC-ospf-1] graceful-restart
[SwitchC-ospf-1] return
Step 6 Verify the configuration.
# Check the GR status of SwitchC.
<SwitchC> display ospf graceful-restart
OSPF Process 1 with Router ID 10.3.3.3
Graceful-restart capability : enabled
Graceful-restart support : planned and un-planned, totally
Helper-policy support : planned and un-planned, strict lsa check
Current GR state : normal
Graceful-restart period : 120 seconds
Number of neighbors under helper:
Normal neighbors : 0
Virtual neighbors : 0
Sham-link neighbors : 0
Total neighbors : 0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 358
Number of restarting neighbors : 0
Last exit reason:
On graceful restart : none
On Helper : none
# Check the neighbor status on SwitchA.
<SwitchA> display ospf peer
OSPF Process 1 with Router ID 10.1.1.1
Neighbors
Area 0.0.0.0 interface 192.168.0.1(Vlanif10)'s neighbors
Router ID: 10.2.2.2 Address: 192.168.0.2 GR State: Normal
State: Full Mode:Nbr is Master Priority: 1
DR: 192.168.0.2 BDR: 192.168.0.1 MTU: 0
Dead timer due in 40 sec
Retrans timer interval: 5
Neighbor is up for 00:04:28
Authentication Sequence: [ 0 ]
Neighbors
Area 0.0.0.1 interface 192.168.1.1(Vlanif20)'s neighbors
Router ID: 10.3.3.3 Address: 192.168.1.2 GR State: Normal
State: Full Mode:Nbr is Master Priority: 1
DR: 192.168.1.1 BDR: 192.168.1.2 MTU: 0
Dead timer due in 36 sec
Retrans timer interval: 5
Neighbor is up for 00:00:00
Authentication Sequence: [ 0 ]
The preceding command output shows that the OSPF neighbor status of SwitchA
is Full and GR status is Normal.
# Restart the OSPF process of SwitchC gracefully.
<SwitchC> reset ospf process graceful-restart
# Check the neighbor status on SwitchA.
<SwitchA> display ospf peer
OSPF Process 1 with Router ID 10.1.1.1
Neighbors
Area 0.0.0.0 interface 192.168.0.1(Vlanif10)'s neighbors
Router ID: 10.2.2.2 Address: 192.168.0.2 GR State: Normal
State: Full Mode:Nbr is Master Priority: 1
DR: 192.168.0.2 BDR: 192.168.0.1 MTU: 0
Dead timer due in 40 sec
Retrans timer interval: 5
Neighbor is up for 00:04:28
Authentication Sequence: [ 0 ]
Neighbors
Area 0.0.0.1 interface 192.168.1.1(Vlanif20)'s neighbors
Router ID: 10.3.3.3 Address: 192.168.1.2 GR State: Normal
State: Full Mode:Nbr is Slave Priority: 1
DR: 192.168.1.1 BDR: 192.168.1.2 MTU: 0
Dead timer due in 36 sec
Retrans timer interval: 5
Neighbor is up for 00:00:00
Authentication Sequence: [ 0 ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 359
The preceding command output shows that the OSPF neighbor status of SwitchA
and SwitchC are still Full without being affected by the graceful restart of the
OSPF process on SwitchC.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 192.168.0.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
ospf 1 router-id 10.1.1.1
opaque-capability enable
graceful-restart
area 0.0.0.0
network 192.168.0.0 0.0.0.255
area 0.0.0.1
network 192.168.1.0 0.0.0.255
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10
#
interface Vlanif10
ip address 192.168.0.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
ospf 1 router-id 10.2.2.2
area 0.0.0.0
network 192.168.0.0 0.0.0.255
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20
#
interface Vlanif20
ip address 192.168.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 360
port link-type trunk
port trunk allow-pass vlan 20
#
ospf 1 router-id 10.3.3.3
opaque-capability enable
graceful-restart
area 0.0.0.1
network 192.168.1.0 0.0.0.255
#
return
5.26.8 Example for Configuring BFD for OSPF
Networking Requirements
As shown in Figure 5-76, OSPF is running among SwitchA, SwitchB, and SwitchC,
and the switch between SwitchA and SwitchB only provides transparent
transmission. It is required that SwitchA and SwitchB quickly detect the status of
the link between them and services be quickly switched to the backup link
SwitchA-SwitchC-SwitchB when the link SwitchA-SwitchB becomes faulty.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 5-76 Networking diagram for configuring BFD for OSPF
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic OSPF functions on each switch to implement basic
connections on the OSPF network.
2. Configure BFD for OSPF on each switch so that services are quickly switched
to the backup link if the link between SwitchA and SwitchB is faulty.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 361
Procedure
Step 1 Configure VLANs for interfaces.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 30
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 30
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure an IP address for each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 30
[SwitchA-Vlanif30] ip address 10.3.3.1 24
[SwitchA-Vlanif30] quit
Step 3 Configure basic OSPF functions.
# Configure SwitchA.
[SwitchA] ospf 1 router-id 10.10.10.1
[SwitchA-ospf-1] area 0
[SwitchA-ospf-1-area-0.0.0.0] network 10.1.1.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] network 10.3.3.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] quit
[SwitchA-ospf-1] quit
# Configure SwitchB.
[SwitchB] ospf 1 router-id 10.10.10.2
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 10.2.2.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] network 10.3.3.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] network 172.16.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
# Configure SwitchC.
[SwitchC] ospf 1 router-id 10.10.10.3
[SwitchC-ospf-1] area 0
[SwitchC-ospf-1-area-0.0.0.0] network 10.1.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] network 10.2.2.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] quit
[SwitchC-ospf-1] quit
# After the preceding configurations, run the display ospf peer command. The
command output shows that adjacencies are established among SwitchA, SwitchB,
and SwitchC. The following provides the command output of SwitchA:
[SwitchA] display ospf peer
OSPF Process 1 with Router ID 10.10.10.1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 362
Neighbors
Area 0.0.0.0 interface 10.1.1.1(Vlanif10)'s neighbors
Router ID: 10.10.10.3 Address: 10.1.1.2
State: Full Mode:Nbr is Master Priority: 1
DR: 10.1.1.2 BDR: 10.1.1.1 MTU: 0
Dead timer due in 38 sec
Retrans timer interval: 5
Neighbor is up for 00:00:15
Authentication Sequence: [ 0 ]
Neighbors
Area 0.0.0.0 interface 10.3.3.1(Vlanif30)'s neighbors
Router ID: 10.10.10.2 Address: 10.3.3.2
State: Full Mode:Nbr is Master Priority: 1
DR: 10.3.3.2 BDR: 10.3.3.1 MTU: 0
Dead timer due in 25 sec
Retrans timer interval: 5
Neighbor is up for 00:00:59
Authentication Sequence: [ 0 ]
# Check the OSPF routing table on SwitchA. The routing table contains the routing
entries to SwitchB and SwitchC. The next-hop address of the route to the
destination network segment 172.16.1.0/24 is 10.3.3.2, indicating that the traffic is
transmitted over the link SwitchA→SwitchB.
[SwitchA] display ospf routing
OSPF Process 1 with Router ID 10.10.10.1
Routing Tables
Routing for Network
Destination Cost Type NextHop AdvRouter Area
10.1.1.0/24 1 Transit 10.1.1.1 10.10.10.1 0.0.0.0
10.2.2.0/24 2 Transit 10.1.1.2 10.10.10.3 0.0.0.0
10.2.2.0/24 2 Transit 10.3.3.2 10.10.10.3 0.0.0.0
10.3.3.0/24 1 Transit 10.3.3.1 10.10.10.1 0.0.0.0
172.16.1.0/24 2 Stub 10.3.3.2 10.10.10.2 0.0.0.0
Total Nets: 5
Intra Area: 5 Inter Area: 0 ASE: 0 NSSA: 0
Step 4 Configure BFD for OSPF.
# Configure BFD for OSPF on SwitchA.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] ospf 1
[SwitchA-ospf-1] bfd all-interfaces enable
[SwitchA-ospf-1] quit
# Configure BFD for OSPF on SwitchB.
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] ospf 1
[SwitchB-ospf-1] bfd all-interfaces enable
[SwitchB-ospf-1] quit
# Configure BFD for OSPF on SwitchC.
[SwitchC] bfd
[SwitchC-bfd] quit
[SwitchC] ospf 1
[SwitchC-ospf-1] bfd all-interfaces enable
[SwitchC-ospf-1] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 363
# After the preceding configurations, run the display ospf bfd session all
command on SwitchA, SwitchB, or SwitchC. Each command output shows that the
BFD session status is Up. The following provides the command output of SwitchA:
[SwitchA] display ospf bfd session all
OSPF Process 1 with Router ID 10.10.10.1
Area 0.0.0.0 interface 10.1.1.1(Vlanif10)'s BFD Sessions
NeighborId:10.10.10.3 AreaId:0.0.0.0 Interface:Vlanif10
BFDState:up rx :1000 tx :1000
Multiplier:3 BFD Local Dis:8195 LocalIpAdd:10.1.1.1
RemoteIpAdd:10.1.1.2 Diagnostic Info:No diagnostic information
Area 0.0.0.0 interface 10.3.3.1(Vlanif30)'s BFD Sessions
NeighborId:10.10.10.2 AreaId:0.0.0.0 Interface:Vlanif30
BFDState:up rx :1000 tx :1000
Multiplier:3 BFD Local Dis:8194 LocalIpAdd:10.3.3.1
RemoteIpAdd:10.3.3.2 Diagnostic Info:No diagnostic information
Step 5 Verify the configuration.
# Run the shutdown command on GE0/0/1 of SwitchB to simulate a link fault.
[SwitchB] interface gigabitethernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] shutdown
# Check the OSPF routing table on SwitchA.
[SwitchA] display ospf routing
OSPF Process 1 with Router ID 10.10.10.1
Routing Tables
Routing for Network
Destination Cost Type NextHop AdvRouter Area
10.1.1.0/24 1 Transit 10.1.1.1 10.10.10.1 0.0.0.0
10.2.2.0/24 2 Transit 10.1.1.2 10.10.10.3 0.0.0.0
10.3.3.0/24 1 Stub 10.3.3.1 10.10.10.1 0.0.0.0
172.16.1.0/24 3 Stub 10.1.1.2 10.10.10.2 0.0.0.0
Total Nets: 4
Intra Area: 4 Inter Area: 0 ASE: 0 NSSA: 0
After the link SwitchA-SwitchB is faulty, the backup link SwitchA-SwitchC-SwitchB
takes effect and the next-hop address of the route to the destination network
segment 172.16.1.0/24 changes to 10.1.1.2.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 30
#
bfd
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
#
interface Vlanif30
ip address 10.3.3.1 255.255.255.0
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 364
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
ospf 1 router-id 10.10.10.1
bfd all-interfaces enable
area 0.0.0.0
network 10.1.1.0 0.0.0.255
network 10.3.3.0 0.0.0.255
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 20 30 40
#
bfd
#
interface Vlanif20
ip address 10.2.2.2 255.255.255.0
#
interface Vlanif30
ip address 10.3.3.2 255.255.255.0
#
interface Vlanif40
ip address 172.16.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 40
#
ospf 1 router-id 10.10.10.2
bfd all-interfaces enable
area 0.0.0.0
network 10.2.2.0 0.0.0.255
network 10.3.3.0 0.0.0.255
network 172.16.1.0 0.0.0.255
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 10 20
#
bfd
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
#
interface Vlanif20
ip address 10.2.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 365
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
ospf 1 router-id 10.10.10.3
bfd all-interfaces enable
area 0.0.0.0
network 10.1.1.0 0.0.0.255
network 10.2.2.0 0.0.0.255
#
return
5.26.9 Example for Configuring OSPF IP FRR
Networking Requirements
As shown in Figure 5-77, four switches belong to the same OSPF area. It is
required that traffic forwarded by SwitchA be protected. The specific requirements
are as follows:
● In normal scenarios, traffic of SwitchA is forwarded over the primary link
SwitchA-SwitchC.
● When the primary link SwitchA-SwitchC fails, traffic is fast switched to the
backup link SwitchA-SwitchB without waiting for route convergence, ensuring
uninterrupted traffic forwarding.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 5-77 Networking diagram for configuring OSPF IP FRR
Configuration Roadmap
The configuration roadmap is as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 366
1. Configure basic OSPF functions on each switch.
2. Configure OSPF IP FRR on SwitchA to ensure uninterrupted forwarding of
traffic from SwitchA.
Procedure
Step 1 Configure VLANs for interfaces.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface GigabitEthernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface GigabitEthernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure an IP address for each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.2.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure basic OSPF functions.
# Configure SwitchA.
[SwitchA] ospf 1 router-id 10.1.1.1
[SwitchA-ospf-1] area 0
[SwitchA-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] network 192.168.2.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] quit
[SwitchA-ospf-1] quit
# Configure SwitchB.
[SwitchB] ospf 1 router-id 10.2.2.2
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] network 192.168.3.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] return
# Configure SwitchC.
[SwitchC] ospf 1 router-id 10.3.3.3
[SwitchC-ospf-1] area 0
[SwitchC-ospf-1-area-0.0.0.0] network 192.168.2.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] network 192.168.3.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] network 192.168.4.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] return
# Configure SwitchD.
[SwitchD] ospf 1 router-id 10.4.4.4
[SwitchD-ospf-1] area 0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 367
[SwitchD-ospf-1-area-0.0.0.0] network 192.168.4.0 0.0.0.255
[SwitchD-ospf-1-area-0.0.0.0] return
Step 4 Enable OSPF IP FRR on SwitchA.
# Enable OSPF IP FRR on SwitchA.
[SwitchA] ospf
[SwitchA-ospf-1] frr
[SwitchA-ospf-1-frr] loop-free-alternate
[SwitchA-ospf-1-frr] return
Step 5 Verify the configuration.
# Check information about routes from SwitchA to SwitchD. Verify that OSPF
generates a backup route after OSPF IP FRR is enabled.
<SwitchA> display ospf routing 192.168.4.0
OSPF Process 1 with Router ID 10.1.1.1
Destination : 192.168.4.0/24
AdverRouter : 10.4.4.4 Area : 0.0.0.0
Cost : 2 Type : Transit
NextHop : 192.168.2.2 Interface : Vlanif20
Priority : Low Age : 00h00m10s
Backup Nexthop : 192.168.1.2 Backup Interface: Vlanif10
Backup Type : LFA LINK
The preceding command output shows that a backup route is generated on
SwitchA.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
ospf 1 router-id 10.1.1.1
frr
loop-free-alternate
area 0.0.0.0
network 192.168.1.0 0.0.0.255
network 192.168.2.0 0.0.0.255
#
return
● SwitchB configuration file
#
sysname SwitchB
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 368
#
vlan batch 10 30
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.3.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
ospf 1 router-id 10.2.2.2
area 0.0.0.0
network 192.168.1.0 0.0.0.255
network 192.168.3.0 0.0.0.255
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 30 40
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.3.2 255.255.255.0
#
interface Vlanif40
ip address 192.168.4.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
ospf 1 router-id 10.3.3.3
area 0.0.0.0
network 192.168.2.0 0.0.0.255
network 192.168.3.0 0.0.0.255
network 192.168.4.0 0.0.0.255
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 40
#
interface Vlanif40
ip address 192.168.4.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 369
port trunk allow-pass vlan 40
#
ospf 1 router-id 10.4.4.4
area 0.0.0.0
network 192.168.4.0 0.0.0.255
#
return
5.26.10 Example for Configuring Local OSPF MT
Networking Requirements
As shown in Figure 5-78, multicast and an IGP Shortcut-enabled MPLS TE tunnel
are configured on a network. The outbound interface of the route calculated by
IGP may be a TE tunnel interface, not a physical interface. The TE tunnel interface
on the switch sends multicast Join packets over a unicast route to the multicast
source address. The multicast Join packets are transparent to SwitchC through
which the TE tunnel passes. As a result, SwitchC cannot generate multicast
forwarding entries. To resolve the problem, you can enable local OSPF MT on
SwitchB. With local MT enabled, if the outbound interface of a route after
calculation is an IGP Shortcut-enabled TE tunnel interface, the routing
management (RM) module creates an independent Multicast IGP (MIGP) routing
table, calculates the physical outbound interface for the route, and adds the route
to the MIGP routing table. Multicast packets are then forwarded along the routes
in the MIGP routing table.
Figure 5-78 Networking diagram for configuring local OSPF MT
Configuration Roadmap
The configuration roadmap is as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 370
1. Configure basic OSPF functions on each switch to implement basic
connections on the OSPF network.
2. Configure multicast PIM-SM on each switch so that the host can receive the
multicast data from the source.
3. Configure the MPLS RSVP-TE tunnel function on SwitchB, SwitchC, and
SwitchD, configure an MPLS TE tunnel interface on SwitchB, and establish a
TE tunnel from SwitchB to SwitchD.
4. Configure the IGP-Shortcut function on SwitchB so that SwitchB uses the TE
tunnel interface as the outbound interface.
5. Configure the local OSPF MT function on SwitchB so that a physical outbound
interface is created in the MIGP routing table as the next-hop of each route
whose original outbound interface is a TE tunnel interface.
Procedure
Step 1 Configure VLANs for interfaces.
# Configure SwitchA. The configurations of SwitchB, SwitchC, SwitchD, and
SwitchE are similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type access
[SwitchA-GigabitEthernet0/0/1] port default vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure an IP address for each VLANIF interface or loopback interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, SwitchD, and
SwitchE are similar to the configuration of SwitchA.
[SwitchA] interface loopback 0
[SwitchA-LoopBack0] ip address 10.1.1.1 32
[SwitchA-LoopBack0] quit
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 172.16.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 10.0.0.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure basic OSPF functions.
# Configure SwitchA.
[SwitchA] router id 10.1.1.1
[SwitchA] ospf 1
[SwitchA-ospf-1] area 0
[SwitchA-ospf-1-area-0.0.0.0] network 10.1.1.1 0.0.0.0
[SwitchA-ospf-1-area-0.0.0.0] network 10.0.0.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] network 172.16.1.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] quit
[SwitchA-ospf-1] quit
# Configure SwitchB.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 371
[SwitchB] router id 10.2.2.2
[SwitchB] ospf 1
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 10.2.2.2 0.0.0.0
[SwitchB-ospf-1-area-0.0.0.0] network 10.0.0.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] network 10.0.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
# Configure SwitchC.
[SwitchC] router id 10.3.3.3
[SwitchC] ospf 1
[SwitchC-ospf-1] area 0
[SwitchC-ospf-1-area-0.0.0.0] network 10.3.3.3 0.0.0.0
[SwitchC-ospf-1-area-0.0.0.0] network 10.0.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] network 10.0.2.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] quit
[SwitchC-ospf-1] quit
# Configure SwitchD.
[SwitchD] router id 10.4.4.4
[SwitchD] ospf 1
[SwitchD-ospf-1] area 0
[SwitchD-ospf-1-area-0.0.0.0] network 10.4.4.4 0.0.0.0
[SwitchD-ospf-1-area-0.0.0.0] network 10.0.2.0 0.0.0.255
[SwitchD-ospf-1-area-0.0.0.0] network 10.0.3.0 0.0.0.255
[SwitchD-ospf-1-area-0.0.0.0] quit
[SwitchD-ospf-1] quit
# Configure SwitchE.
[SwitchE] router id 10.5.5.5
[SwitchE] ospf 1
[SwitchE-ospf-1] area 0
[SwitchE-ospf-1-area-0.0.0.0] network 10.5.5.5 0.0.0.0
[SwitchE-ospf-1-area-0.0.0.0] network 10.0.3.0 0.0.0.255
[SwitchE-ospf-1-area-0.0.0.0] network 192.168.3.0 0.0.0.255
[SwitchE-ospf-1-area-0.0.0.0] quit
[SwitchE-ospf-1] quit
Step 4 Configure PIM-SM.
# Enable multicast on all switches and enable PIM-SM on all interfaces. The
configurations of SwitchB, SwitchC, SwitchD, and SwitchE are similar to the
configuration of SwitchA.
[SwitchA] multicast routing-enable
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] pim sm
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] pim sm
[SwitchA-Vlanif20] quit
# Enable Internet Group Management Protocol (IGMP) on the interface
connecting SwitchA to the host.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] igmp enable
[SwitchA-Vlanif10] igmp version 3
[SwitchA-Vlanif10] quit
# Configure a C-BSR and a C-RP. Set the RP service range and specify the C-BSR
and C-RP locations on SwitchD.
[SwitchD] pim
[SwitchD-pim] c-bsr vlanif 50
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 372
[SwitchD-pim] c-rp vlanif 50
[SwitchD-pim] quit
# Run the display multicast routing-table command to check the switch
multicast routing table. The following provides the multicast routing table of
SwitchC:
[SwitchC] display multicast routing-table
Multicast routing table of VPN-Instance: public net
Total 1 entry
00001. (192.168.3.2, 225.0.0.1)
Uptime: 15:03:04
Upstream Interface: Vlanif40
List of 1 downstream interface
1: Vlanif30
Step 5 Configure an MPLS RSVP-TE tunnel.
# Configure SwitchB.
[SwitchB] mpls lsr-id 10.2.2.2
[SwitchB] mpls
[SwitchB-mpls] mpls te
[SwitchB-mpls] mpls rsvp-te
[SwitchB-mpls] mpls te cspf
[SwitchB-mpls] quit
[SwitchB] interface vlanif 30
[SwitchB-Vlanif30] mpls
[SwitchB-Vlanif30] mpls te
[SwitchB-Vlanif30] mpls rsvp-te
[SwitchB-Vlanif30] quit
[SwitchB] ospf 1
[SwitchB-ospf-1] enable traffic-adjustment
[SwitchB-ospf-1] opaque-capability enable
[SwitchB-ospf-1] area 0.0.0.0
[SwitchB-ospf-1-area-0.0.0.0] mpls-te enable
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
# Configure SwitchC.
[SwitchC] mpls lsr-id 10.3.3.3
[SwitchC] mpls
[SwitchC-mpls] mpls te
[SwitchC-mpls] mpls rsvp-te
[SwitchC-mpls] quit
[SwitchC] interface vlanif 30
[SwitchC-Vlanif30] mpls
[SwitchC-Vlanif30] mpls te
[SwitchC-Vlanif30] mpls rsvp-te
[SwitchC-Vlanif30] quit
[SwitchC] interface vlanif 40
[SwitchC-Vlanif40] mpls
[SwitchC-Vlanif40] mpls te
[SwitchC-Vlanif40] mpls rsvp-te
[SwitchC-Vlanif40] quit
[SwitchC] ospf 1
[SwitchC-ospf-1] opaque-capability enable
[SwitchC-ospf-1] area 0.0.0.0
[SwitchC-ospf-1-area-0.0.0.0] mpls-te enable
[SwitchC-ospf-1-area-0.0.0.0] quit
[SwitchC-ospf-1] quit
# Configure SwitchD.
[SwitchD] mpls lsr-id 10.4.4.4
[SwitchD] mpls
[SwitchD-mpls] mpls te
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 373
[SwitchD-mpls] mpls rsvp-te
[SwitchD-mpls] quit
[SwitchD] interface vlanif 40
[SwitchD-Vlanif40] mpls
[SwitchD-Vlanif40] mpls te
[SwitchD-Vlanif40] mpls rsvp-te
[SwitchD-Vlanif40] quit
[SwitchD] ospf 1
[SwitchD-ospf-1] opaque-capability enable
[SwitchD-ospf-1] area 0.0.0.0
[SwitchD-ospf-1-area-0.0.0.0] mpls-te enable
[SwitchD-ospf-1-area-0.0.0.0] quit
[SwitchD-ospf-1] quit
Configure an MPLS TE tunnel and enable IGP Shortcut.
Configure an MPLS TE tunnel and enable IGP Shortcut on SwitchB.
[SwitchB] interface tunnel 1
[SwitchB-Tunnel1] ip address unnumbered interface loopback 0
[SwitchB-Tunnel1] tunnel-protocol mpls te
[SwitchB-Tunnel1] destination 10.4.4.4
[SwitchB-Tunnel1] mpls te tunnel-id 100
[SwitchB-Tunnel1] mpls te igp shortcut ospf
[SwitchB-Tunnel1] mpls te igp metric relative -10
[SwitchB-Tunnel1] mpls te commit
[SwitchB-Tunnel1] quit
# Check the OSPF routing table on SwitchB. The information shows that an MPLS
TE tunnel is set up.
[SwitchB] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 15 Routes : 15
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.0.0.0/24 Direct 0 0 D 10.0.0.2 Vlanif20
10.0.0.2/32 Direct 0 0 D 127.0.0.1 Vlanif20
10.0.1.0/24 Direct 0 0 D 10.0.1.2 Vlanif30
10.0.1.2/32 Direct 0 0 D 127.0.0.1 Vlanif30
10.0.2.0/24 OSPF 10 2 D 10.0.1.1 Vlanif30
10.0.3.0/24 OSPF 10 2 D 10.2.2.2 Tunnel1
10.1.1.1/32 OSPF 10 1 D 10.0.0.1 Vlanif20
10.2.2.2/32 Direct 0 0 D 127.0.0.1 LoopBack0
10.3.3.3/32 OSPF 10 1 D 10.0.1.1 Vlanif30
10.4.4.4/32 OSPF 10 1 D 10.2.2.2 Tunnel1
10.5.5.5/32 OSPF 10 2 D 10.2.2.2 Tunnel1
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.1.0/24 OSPF 10 2 D 10.0.0.1 Vlanif20
192.168.3.0/24 OSPF 10 3 D 10.2.2.2 Tunnel1
# Check the multicast routing table on switchSwitchC spanned by the TE tunnel.
[SwitchC] display multicast routing-table
No multicast routing entry is displayed in the command output, indicating that
SwitchC has discarded multicast packets.
Step 6 Configure local OSPF MT.
# Enable local OSPF MT on SwitchB.
[SwitchB] ospf 1
[SwitchB-ospf-1] local-mt enable
[SwitchB-ospf-1] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 374
Step 7 Verify the configuration.
# Check the multicast routing table on SwitchC again. Verify that a multicast
route is contained in the routing table.
[SwitchC] display multicast routing-table
Multicast routing table of VPN-Instance: public net
Total 1 entry
00001. (192.168.3.2, 225.0.0.1)
Uptime: 00:00:19
Upstream Interface: Vlanif40
List of 1 downstream interface
1: Vlanif30
# Check the MIGP routing table on SwitchB.
[SwitchB] display migp routing-table
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Tables: MIGP
Destinations : 4 Routes : 4
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.0.3.0/24 OSPF 10 3 10.0.1.1 Vlanif30
10.4.4.4/32 OSPF 10 2 10.0.1.1 Vlanif30
10.5.5.5/32 OSPF 10 3 10.0.1.1 Vlanif30
192.168.3.0/24 OSPF 10 4 10.0.1.1 Vlanif30
The command output shows that a physical outbound interface is created in the
MIGP routing table as the next-hop of each route whose original outbound
interface is a TE tunnel interface.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
router id 10.1.1.1
#
vlan batch 10 20
#
multicast routing-enable
#
interface Vlanif10
ip address 172.16.1.1 255.255.255.0
pim sm
igmp enable
igmp version 3
#
interface Vlanif20
ip address 10.0.0.1 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type access
port default vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface LoopBack0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 375
ip address 10.1.1.1 255.255.255.255
#
ospf 1
area 0.0.0.0
network 10.0.0.0 0.0.0.255
network 10.1.1.1 0.0.0.0
network 172.16.1.0 0.0.0.255
#
return
● SwitchB configuration file
#
sysname SwitchB
#
router id 10.2.2.2
#
vlan batch 20 30
#
multicast routing-enable
#
mpls lsr-id 10.2.2.2
mpls
mpls te
mpls rsvp-te
mpls te cspf
#
interface Vlanif20
ip address 10.0.0.2 255.255.255.0
pim sm
#
interface Vlanif30
ip address 10.0.1.2 255.255.255.0
pim sm
mpls
mpls te
mpls rsvp-te
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
interface LoopBack0
ip address 10.2.2.2 255.255.255.255
#
interface Tunnel1
ip address unnumbered interface LoopBack0
tunnel-protocol mpls te
destination 10.4.4.4
mpls te tunnel-id 100
mpls te igp shortcut ospf
mpls te igp metric relative -10
mpls te commit
#
ospf 1
opaque-capability enable
enable traffic-adjustment
local-mt enable
area 0.0.0.0
network 10.0.0.0 0.0.0.255
network 10.0.1.0 0.0.0.255
network 10.2.2.2 0.0.0.0
mpls-te enable
#
return
● SwitchC configuration file
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 376
#
sysname SwitchC
#
router id 10.3.3.3
#
vlan batch 30 40
#
multicast routing-enable
#
mpls lsr-id 10.3.3.3
mpls
mpls te
mpls rsvp-te
#
interface Vlanif30
ip address 10.0.1.1 255.255.255.0
pim sm
mpls
mpls te
mpls rsvp-te
#
interface Vlanif40
ip address 10.0.2.2 255.255.255.0
pim sm
mpls
mpls te
mpls rsvp-te
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
interface LoopBack0
ip address 10.3.3.3 255.255.255.255
#
ospf 1
opaque-capability enable
area 0.0.0.0
network 10.0.1.0 0.0.0.255
network 10.0.2.0 0.0.0.255
network 10.3.3.3 0.0.0.0
mpls-te enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
router id 10.4.4.4
#
vlan batch 40 50
#
multicast routing-enable
#
mpls lsr-id 10.4.4.4
mpls
mpls te
mpls rsvp-te
#
interface Vlanif40
ip address 10.0.2.1 255.255.255.0
pim sm
mpls
mpls te
mpls rsvp-te
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 377
#
interface Vlanif50
ip address 10.0.3.1 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 50
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
interface LoopBack0
ip address 10.4.4.4 255.255.255.255
#
ospf 1
opaque-capability enable
area 0.0.0.0
network 10.0.2.0 0.0.0.255
network 10.0.3.0 0.0.0.255
network 10.4.4.4 0.0.0.0
mpls-te enable
#
pim
c-bsr Vlanif50
c-rp Vlanif50
#
return
● SwitchE configuration file
#
sysname SwitchE
#
router id 10.5.5.5
#
vlan batch 50 60
#
multicast routing-enable
#
interface Vlanif50
ip address 10.0.3.3 255.255.255.0
pim sm
#
interface Vlanif60
ip address 192.168.3.1 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 50
#
interface GigabitEthernet0/0/2
port link-type access
port default vlan 60
#
interface LoopBack0
ip address 10.5.5.5 255.255.255.255
#
ospf 1
area 0.0.0.0
network 10.0.3.0 0.0.0.255
network 10.5.5.5 0.0.0.0
network 192.168.3.0 0.0.0.255
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 378
5.27 Troubleshooting OSPF
5.27.1 An OSPF Neighbor Relationship Cannot Be Established
Fault Symptom
An OSPF neighbor relationship cannot be established between two devices.
Procedure
Step 1 Check whether the physical status and protocol status of interfaces on both ends
of the link are Up and stable, whether packets are lost on the interfaces, and
whether the two devices can ping each other using packets longer than 1500
bytes.
If the physical status of the interfaces is not Up or unstable (interfaces flap for
example), check whether the link connection is normal and whether the protocol
status of the interfaces is Up. Ensure that no error packet statistics exist on the
interfaces.
If packet loss occurs during the ping test, check whether the MTUs of device
interfaces along which ping packets travel are properly set.
Step 2 Check whether the two devices have the same OSPF process router ID.
Run the display ospf [
process-id ] brief command on the two devices
respectively to check the OSPF process router IDs of them.
Each router ID in an OSPF process must be unique on the entire network.
Otherwise, devices on both ends of the link cannot establish an OSPF neighbor
relationship, and routing information will be incorrect.
If the two devices have the same OSPF process router ID, run the ospf [
process-
id ] router-id
router-id command in the system view to change the OSPF process
router IDs and ensure that the two devices have different OSPF process router IDs.
After changing an OSPF process router ID, run the reset ospf [
process-id ]
process command in the user view to make the new router ID take effect.
Step 3 Check whether the two devices have the same OSPF area ID.
Run the display ospf [
process-id ] brief command on the two devices
respectively to check the OSPF area IDs of them.
If the two devices have different OSPF area IDs, run the area
area-id command in
the OSPF view to change the OSPF area IDs and ensure that the two devices have
the same OSPF area ID.
Step 4 Check whether OSPF interfaces on both ends of the link have the same network
type.
Run the display ospf [
process-id ] interface command on the two devices
respectively to check the OSPF interface network types of them.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 379
The OSPF interfaces on both ends of a link must have the same network type;
otherwise, the two interfaces cannot establish an OSPF neighbor relationship.
If the network types of the two OSPF interfaces are different, run the ospf
network-type { broadcast | nbma | p2mp | p2p } command in the OSPF interface
view to change the OSPF interface network types and ensure the network type
consistency between the two interfaces.
NOTE
If the network types of OSPF interfaces on both ends of the link are NBMA, run the peer
ip-address [ dr-priority
priority ] command in the OSPF view to configure NBMA neighbors.
Step 5 Check whether OSPF interfaces on both ends of the link have the same IP address
mask.
Run the display current-configuration interface
interface-type interface-number
command on the two devices respectively to check the IP addresses of the
specified OSPF interfaces on the devices.
The OSPF interfaces on both ends of a link must have the same IP address mask;
otherwise, the two interfaces cannot establish an OSPF neighbor relationship. On
a P2MP network, to disable devices from checking the network masks so that an
OSPF neighbor relationship can be established, run the ospf p2mp-mask-ignore
command in the OSPF interface view.
If the two OSPF interfaces have different IP address masks, run the ip address
ip-
address {
mask |
mask-length } command in the OSPF interface view to change
the IP address masks and ensure the IP address mask consistency between the
two interfaces.
Step 6 Check whether IP addresses of OSPF interfaces on both ends of the link reside in
the network segment specified in the network command.
Run the display current-configuration interface
interface-type interface-number
command on the two devices respectively to check IP addresses of the OSPF
interfaces on both ends of the link, and run the display current-configuration
configuration ospf command on the two devices respectively to check the OSPF
process configuration.
OSPF can run on an interface only when the following conditions are met:
● The mask length of the interface's IP address is longer than or equal to that
converted from the wildcard mask specified by the network command. OSPF
uses wildcard masks. For example, 0.0.0.255 indicates that the mask length is
24 bits.
● The primary IP address of the interface resides in the network segment
specified in the network command.
If the IP address of an interface does not meet the preceding conditions, run the ip
address
ip-address {
mask |
mask-length } command in the OSPF-enabled
interface view to change the IP address of the interface. Alternatively, in the view
of the area to which the OSPF process belongs, run the network command to
change the configured network segment so that the IP address of the interface
can meet the preceding conditions.
Step 7 Check whether the DR priorities of OSPF interfaces on both ends of the link are 0.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 380
Run the display ospf [
process-id ] interface command on the two devices
respectively to check the DR priorities of the OSPF interfaces.
On a broadcast or NBMA network, at least one OSPF interface needs to have a DR
priority higher than 0 so that the DR can be elected. Otherwise, the neighbor
status of devices on both ends of the link only can reach 2-Way.
If the DR priorities of the two OSPF interfaces are both 0, run the ospf dr-priority
priority command in the OSPF interface view to change the DR priorities. Ensure
that there is at least one OSPF interface has a DR priority higher than 0.
----End
5.27.2 OSPF Cannot Discover Routes of a Non-Local Area
Symptom
There are no problems with a link, but OSPF cannot discover routes of a non-local
area.
Procedure
Step 1 Check whether the area where the device resides is connected to the backbone
area.
Run the display ospf [
process-id ] brief command on the ABR in the area where
the device resides to check the area configuration.
OSPF requires that all non-backbone areas be connected to the backbone area.
If no backbone area information is configured on the ABR, run the area
area-id
command in the OSPF view to modify the OSPF area information. Ensure that at
least one interface on the ABR runs in the backbone area.
NOTE
If non-backbone areas cannot be connected to the backbone area due to networking
restrictions, you can configure OSPF virtual links to resolve this problem.
Step 2 Check whether the area where the device resides is a totally stub area.
Run the display current-configuration configuration ospf [
process-id ]
command on the device to check the OSPF process configuration.
If you specify the parameter no-summary when configuring a non-backbone area
as a stub area on the ABR (that is, running the stub no-summary command in
the OSPF area view), the area is configured as a totally stub area.
A totally stub area allows only intra-area routes to be advertised within the area.
If the area where the device resides is configured as a totally stub area, perform
the following configurations based on service requirements:
● To restore the totally stub area to a common area, run the undo stub
command in the OSPF area view on all devices in the area.
● To restore a totally stub area to a stub area, run the undo stub command in
the OSPF area view on the ABR in the area and then run the stub command.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 381
Step 3 Check whether the area where the device resides is a totally NSSA.
Run the display current-configuration configuration ospf [
process-id ]
command on the device to check the OSPF process configuration.
If you specify the parameter no-summary when configuring a non-backbone area
as an NSSA on the ABR (that is, running the nssa no-summary command in the
OSPF area view), the area is configured as a totally NSSA.
A totally NSSA allows only intra-area routes to be advertised within the area.
If the area where the device resides is configured as a totally NSSA, perform the
following configuration based on service requirements:
● To restore the totally NSSA to a common area, run the undo nssa command
in the OSPF area view on all devices in the area.
● To restore a totally NSSA to a stub area, run the undo nssa command in the
OSPF area view on the ABR in the area and then run the nssa command.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 5 OSPF Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 382
6 OSPFv3 Configuration
6.1 Overview of OSPFv3
6.2 Understanding OSPFv3
6.3 Summary of OSPFv3 Configuration Tasks
6.4 Licensing Requirements and Limitations for OSPFv3
6.5 Default Settings for OSPFv3
6.6 Configuring Basic OSPFv3 Functions
6.7 Establishing and Maintaining an OSPFv3 Neighbor Relationship
6.8 Configuring an OSPFv3 Area
6.9 Configuring an OSPFv3 NSSA
6.10 Configuring OSPFv3 Route Attributes
6.11 Controlling OSPFv3 Routing Information
6.12 Optimizing an OSPFv3 Network
6.13 Configuring BFD for OSPFv3
6.14 Configuring OSPFv3 IP FRR
6.15 Configuring OSPFv3 GR
6.16 Improving OSPFv3 Network Security
6.17 Configuring OSPFv3 Neighbor Relationship Flapping Suppression
6.18 Configuring OSPFv3 IPSec
6.19 Configuring the Network Management Function of OSPFv3
6.20 Resetting OSPFv3
6.21 Configuration Examples for OSPFv3
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 383
6.1 Overview of OSPFv3
Definition
Open Shortest Path First (OSPF) is a link-state Interior Gateway Protocol (IGP)
developed by the Internet Engineering Task Force (IETF).
OSPF Version 3 (OSPFv3), as defined in RFC 2740 and expanded in RFC 5340, is a
modification of OSPFv2 allowing IPv6 support.
Purpose
The primary purpose of OSPFv3 is to develop a routing protocol independent of
any specific network layer. The internal routing information of OSPFv3 has been
redesigned to serve this purpose.
OSPFv3 and OSPFv2 differ as follows:
● OSPFv3 is used in IPv6, while OSPFv2 is used in IPv4.
OSPFv3 does not insert IP-based data in the header of an IP packet or Link
State Advertisement (LSA).
● OSPFv3 uses protocol-independent information to execute crucial tasks that
originally required the use of the data in the IP packet header, for example, to
identify LSAs that advertise routing data.
6.2 Understanding OSPFv3
6.2.1 OSPFv3 Fundamentals
● The working principles of Hello messages, state machines, link-state
databases (LSDBs), flooding, and route calculation are the same in OSPFv3
and OSPFv2.
● OSPFv3 divides an Autonomous System (AS) into one or more logical areas
and advertises routes through LSAs.
● OSPFv3 ensures routing information consistency by exchanging OSPFv3
packets between routers within an OSPFv3 area.
● OSPFv3 packets are encapsulated into IPv6 packets, which can be transmitted
in unicast or multicast mode.
OSPFv3 Packets
Packet Type Description
Hello Sent regularly to discover and maintain OSPFv3
neighbor relationships.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 384
Packet Type Description
Database Description (DD) Contains the summary of the local LSDB. It is
exchanged between two OSPFv3 routers to
update the LSDBs.
Link State Request (LSR) Sent to neighbors to request the required LSAs.
An OSPFv3 router sends LSR packets to its
neighbor only after they exchange DD packets.
Link State Update (LSU) Used to transmit required LSAs to neighbors.
Link State Acknowledgment
(LSAck)
Used to acknowledge the receipt of LSA packets.
LSA Types
LSA Type Description
Router-LSA (Type 1) ● Generated by a router for each area to which an
OSPFv3 interface belongs and advertised in that
area.
● Describes the status and costs of links of the
router.
Network-LSA (Type 2) ● Generated by a designated router (DR) and
broadcast in the area to which the DR belongs.
● Describes the link status.
Inter-Area-Prefix-LSA
(Type 3)
● Generated by an area border router (ABR).
● Describes the route of a network segment within
the local area and is used to inform other areas
of the route.
Inter-Area-Router-LSA
(Type 4)
● Generated by an ABR and advertised to all
related areas, except the area to which the
autonomous system boundary router (ASBR)
belongs.
● Describes the route to the ASBR.
AS-external-LSA (Type 5) ● Generated by an ASBR and advertised to all
areas except the stub area and the not-so-stubby
area (NSSA).
● Describes routes to a destination outside the AS.
NSSA-LSA (Type 7) ● Generated by an ASBR and advertised only in
NSSAs.
● Describes routes to a destination outside the AS.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 385
LSA Type Description
Link-LSA (Type 8) ● Each router generates one for each link.
● Describes the link-local address and IPv6 address
prefix associated with the link, as well as the link
option set in the network LSA. It is transmitted
only on the link.
Intra-Area-Prefix-LSA
(Type 9)
● Each router or DR generates one or more to be
transmitted in the local area.
● An LSA of this type generated on a router
describes the IPv6 address prefix associated with
the router LSA.
● An LSA of this type generated on a DR describes
the IPv6 address prefix associated with the
network LSA.
Router Types
Figure 6-1 Router types
Table 6-1 Router types
Router Type Description
Internal router Routers whose interfaces all belong to the same
OSPFv3 area.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 386
Router Type Description
Area border router (ABR) Belongs to two or more areas, one of which must
be a backbone area.
Used to connect backbone and non-backbone areas.
It can be physically or logically connected to the
backbone area.
Backbone router At least one interface on a backbone router must
belong to the backbone area.
All ABRs and internal routers in Area 0 are
backbone routers.
AS boundary router
(ASBR)
Exchanges routing information with other ASs.
May not locate on the boundary of an AS. It can be
an internal router or an ABR.
OSPFv3 Route Types
AS inter-area and intra-area routes describe routes within an AS. External routes
describe routes to destinations outside an AS. OSPFv3 classifies imported AS
external routes into Type 1 routes and Type 2 routes.
Table 6-2 lists route types in descending order of priority.
Table 6-2 Route types
Route Type Description
Intra-area route Routes that are generated from within an area (the
destination belongs to the area).
Inter-area route Routes that originate from other areas.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 387
Route Type Description
External route Routes that are imported into OSPF from other
routing protocols or different OSPF processes.
External routes fall into two categories: Type 1 and
Type 2 external routes. The difference between the
two types is the way the cost of a route is
calculated.
● Type 1 external route: The cost of a Type 1
external route is the addition of the external cost
(from the local device to an ASBR) and the
internal cost (from the ASBR to the destination)
used to reach that route.
● Type 2 external route: The cost of a Type 2
external route is always the external cost (from
an ASBR to the destination), irrespective of the
internal cost to reach that route.
A Type 1 external route is always preferred over a
Type 2 external route for the same destination.
Area Types
Table 6-3 Area types
Area Type Description
Totally stub area Allows Type 3 default routes advertised by the ABR, but
disallows routes outside the AS and inter-area routes.
Stub area Different from a totally stub area, a stub area allows inter-
area routes.
NSSA Different from a stub area, an NSSA allows routes outside
an AS.
An ASBR advertises Type 7 LSAs in the local area. These
Type 7 LSAs are translated into Type 5 LSAs on an ABR,
and are then flooded in the entire OSPFv3 AS.
Network Types Supported by OSPFv3
OSPFv3 classifies networks into different types according to link layer protocols.
The following table describes these network types.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 388
Table 6-4 Network types
Network Type Description
Broadcast Default network type if the link layer protocol is
Ethernet or Fiber Distributed Data Interface (FDDI).
● Hello messages, LSU packets, and LSAck packets are
transmitted in multicast mode (FF02::5 is the reserved
IPv6 multicast address of the OSPFv3 router; FF02::6
is the reserved IPv6 multicast address of the OSPFv3
DR or BDR).
● DD packets and LSR packets are transmitted in
unicast mode.
Non-broadcast
multiple access
(NBMA)
Default network type if the link layer protocol is frame
relay, ATM, or X.25.
Protocol packets, such as Hello messages and DD, LSR,
LSU, and LSAck packets, are transmitted in unicast
mode.
Point-to-multipoint
(P2MP)
Not a default network type for any link layer protocol. A
P2MP network must be forcibly changed from other
network types. It is a common practice to change an
NBMA that is not fully connected to a P2MP network.
● Hello messages are transmitted in multicast mode to
the multicast address FF02::5.
● Other protocol packets, including DD, LSR, LSU, and
LSAck packets, are transmitted in unicast mode.
Point-to-point (P2P) Default network type if the link layer protocol is PPP,
HDLC, or LAPB.
Protocol packets, including Hello messages, DD, LSR,
LSU, and LSAck packets, are transmitted to the multicast
address FF02::5.
Stub Area
In stub areas, ABRs do not flood the received external routes. This reduces both
the size of routers' routing tables and the amount of routing information in
transmission.
Configuring a stub area is optional. Not all areas can be configured as stub areas.
Typically, a non-backbone area located at the AS boundary with only one ABR is
set to be a stub area.
To ensure the reachability of a destination outside the AS, the ABR in the stub
area generates a default route and advertises it to the non-ABR routers in that
stub area.
Note the following when configuring a stub area:
● The backbone area cannot be configured as a stub area.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 389
● All routers in a stub area must be configured with the stub command.
● ASBRs cannot exist in stub areas, because it is not allowed to flood external
routes in stub areas.
● A virtual link cannot pass through a stub area.
OSPFv3 Route Summarization
Routing summarization decreases the amount of routing information and the size
of routing tables, improving the performance of routers.
The following is a description of OSPFv3 route summarization:
● Inter-area route summarization
Inter-area route summarization is performed on ABRs and applies to routes
from within an AS. An ABR generates Network-summary (Type 3) LSAs by
network segment while advertising routing information to other areas. If
network segments are contiguous, the ABR can summarize them into a single
segment. This allows the ABR to send only the summary LSA for all the
specified network segments.
● External route summarization
External route summarization is performed on ASBRs and is specific to
external routes that are imported into OSPF. ASBRs can summarize imported
AS-external (Type 5) LSAs within a summary address range. After an NSSA is
configured, an ASBR must summarize imported NSSA (Type 7) LSAs with the
summary address range.
Devices that are both ABRs and ASBRs summarize the Type 5 LSAs translated
from Type 7 LSAs.
OSPFv3 Virtual Link
A virtual link is a logical channel set up between two ABRs through a non-
backbone area.
● It must be configured on both ends of the link to take effect.
● The non-backbone area that provides an internal route for both the ends of
the virtual link is a transit area.
Non-backbone areas cannot always physically connect to the backbone area in
real-world situations. Configuring OSPFv3 virtual links resolves this problem.
A virtual link functions as a point-to-point connection between two ABRs. The
interfaces on the virtual link can be configured with parameters such as the hello
interval in the same way they are configured on physical interfaces.
Figure 6-2 OSPFv3 virtual link
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 390
Figure 6-2 shows the transmission of OSPFv3 packets between two ABRs. OSPFv3
devices between the two ABRs only transparently forward the OSPFv3 packets as
common IP packets when they detect that they are not the destinations of the
packets.
OSPFv3 Multi-Process
Multiple OSPFv3 processes can run on the same router because they are
independent of each other. Route interaction between different OSPFv3 processes
is similar to that between different routing protocols.
One interface on a router belongs to only one OSPFv3 process.
6.2.2 OSPFv3 GR
Graceful restart (GR) is a high availability (HA) technology used to ensure normal
traffic forwarding when a routing protocol restarts and guarantee that key services
are not affected in the process.
GR comprises a series of comprehensive technologies including fault-tolerant
redundancy, link protection, faulty node recovery, and traffic engineering. As a
redundancy technology, GR is widely used to ensure uninterrupted forwarding of
key data during active/standby switchovers and system upgrades.
If GR is not enabled, an active/standby switchover leads to intermittent
interruption of data forwarding. As a result, route flapping occurs on the whole
network. This is unacceptable on a large-scale network, especially on a carrier
network.
If GR is enabled, the forwarding plane continues to direct data forwarding when a
restart occurs. Then actions on the control plane, such as reestablishment of
neighbor relationships and route calculation, do not affect the forwarding plane.
Service interruption caused by route flapping is therefore prevented, which
improves network reliability.
Basic Concepts
● Grace-LSA
– OSPFv3 supports GR by flooding Grace-LSAs on the link.
– Grace-LSAs are used when GR starts and ends to inform neighbors of the
GR time, cause, and interface instance ID.
● Router role
– A router can function as a GR restarter, which has the GR capability and
restarts in GR mode.
– A router can function as a GR helper, which also has the GR capability
and helps the GR restarter to complete the GR process.
● GR implementation
– Planned GR: This refers to a graceful restart of OSPFv3 through the reset
ospfv3 graceful-restart command. In this mode, a Grace-LSA is sent to
the neighbor before the restart.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 391
– Unplanned GR: This refers to an active/standby switchover triggered by
router faults, such as loss of power, dead loops, exceptions, or master
resets.
Unlike planned GR, a Grace-LSA is not sent before the active/standby
switchover. Instead, the switchover is performed directly. When the
standby board becomes Up, a Grace-LSA is sent, and the GR process
starts.
GR Process
Figure 6-3 OSPFv3 planned GR process (reset ospfv3 graceful-restart)
Figure 6-4 OSPFv3 unplanned GR process (active/standby switchover)
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 392
● On the GR restarter:
1. In planned GR mode, the GR restarter sends a Grace-LSA to all neighbors to
inform them of the restart of a GR process and the duration and cause of this
process.
In unplanned GR mode, a Grace-LSA is sent to each neighbor immediately
after the standby board is Up. This informs the neighbors of the restart of a
GR process and the duration and cause of this process.
2. The GR restarter sets up new neighbor relationships by negotiating with
neighbors again.
3. When all neighbor relationships between the GR restarter and the original
neighbors enter the Full state:
– The GR restarter exits the GR process and OSPFv3 recalculates routes.
– The GR restarter updates its routing table on the main control board and
the forwarding information bases (FIBs) on interface boards. It also
deletes invalid routing entries.
– The GR restarter sends a Grace-LSA with an aging time of 3600 seconds
to instruct the GR helper to exit the GR process.
The GR process is now complete.
4. If errors occur during a GR process, the GR timer expires, or a neighbor
relationship fails to enter the Full state during the GR process, the GR
restarter exits the process and OSPFv3 is restarted in non-GR mode. This
causes packets loss.
● On the GR helper:
1. A router that is configured to support the GR process on its neighbor enters
the helper mode after receiving a Grace-LSA.
2. The GR helper maintains its neighbor relationship with the GR restarter, and
the status of the neighbor relationship does not change.
3. If the GR helper continues to receive Grace-LSAs whose GR period differs from
its own GR period, the GR helper updates its GR period to match that of the
received Grace-LSAs.
4. After the GR restarter informs the helper of the success of the GR process
through a Grace-LSA with an aging time of 3600 seconds, the GR helper exits
the GR process.
5. If errors occur during the GR process, the GR helper exits the helper state and
deletes invalid routes after route calculation.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 393
Comparison of OSPFv3 GR and Non-GR Modes
Table 6-5 Comparison of OSPFv3 GR and non-GR modes
Active/Standby Switchover in Non-
GR Mode
Active/Standby Switchover in GR
Mode
● OSPFv3 neighbor relationships are
reestablished.
● Routes are recalculated.
● The forwarding table changes.
● Route changes are sensed on the
network and route flapping
occurs over a short period of
time.
● Packets are lost during
forwarding, and services are
interrupted.
● OSPFv3 neighbor relationships are
reestablished.
● Routes are recalculated.
● The forwarding table does not
change.
● Route changes are not sensed, except
on the neighbor of the device where
the active/standby switchover occurs.
● Packets are not lost during
forwarding, and services are not
affected.
6.2.3 OSPFv3-BGP Synchronization
When a router is restarted or a new router is deployed on a network, network
traffic may be lost during Border Gateway Protocol (BGP) convergence. This is
because IGP convergence is faster than BGP convergence. OSPFv3-BGP
synchronization can solve this problem.
When a router on a BGP network recovers from a fault, BGP convergence is
performed again. Packets may be lost during the convergence.
Figure 6-5 shows traffic traversing a BGP network, passing through Router C from
RouterA to RouterD.
Figure 6-5 Traffic traversing a BGP network
If a fault occurs on RouterC, traffic is redirected to RouterB after rerouting. Packets
are lost when RouterC is restored to normal operating status.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 394
This is because OSPFv3 convergence is already complete when RouterC recovers,
and RouterC becomes the next hop on the route from RouterA to RouterD.
However, at this point, BGP convergence on RouterC is not complete, so RouterC
does not yet know the route to RouterD.
For this reason, when packets destined for RouterD are transmitted from RouterA
to RouterC, they are discarded by RouterC because it has no route to RouterD. This
is shown in Figure 6-6.
Figure 6-6 Packet loss upon device restart without OSPFv3-BGP synchronization
Process of OSPFv3-BGP synchronization
When a router enabled with OSPFv3-BGP synchronization restarts, it advertises a
message in the local OSPFv3 area instructing other routers not to use it as a
transit router.
At the same time, the router sets the cost value in its LSAs to 65535, the largest
value. This ensures that it is not used by other routers as a transit router. The BGP
route, however, can still reach the router.
6.2.4 OSPFv3 Neighbor Relationship Flapping Suppression
OSPFv3 neighbor relationship flapping suppression works by delaying OSPFv3
neighbor relationship reestablishment or setting the link cost to the maximum
value (65535).
Background
If the status of an interface carrying OSPFv3 services alternates between Up and
Down, OSPFv3 neighbor relationship flapping occurs on the interface. During the
flapping, OSPFv3 frequently sends Hello packets to reestablish the neighbor
relationship, synchronizes LSDBs, and recalculates routes. In this process, a large
number of packets are exchanged, adversely affecting neighbor relationship
stability, OSPFv3 services, and other OSPFv3-dependent services, such as LDP and
BGP. OSPFv3 neighbor relationship flapping suppression can address this problem
by delaying OSPFv3 neighbor relationship reestablishment or preventing service
traffic from passing through flapping links.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 395
Related Concepts
Flapping_event: reported when the status of a neighbor relationship on an
interface last changes from Full to a non-Full state. The flapping_event triggers
flapping detection.
Flapping_count: number of times flapping has occurred.
Detect-interval: detection interval. The interval is used to determine whether to
trigger a valid flapping_event.
Threshold: flapping suppression threshold. When the flapping_count reaches or
exceeds threshold, flapping suppression takes effect.
Resume-interval: interval for exiting from OSPFv3 neighbor relationship flapping
suppression. If the interval between two successive valid flapping_events is longer
than resume-interval, the flapping_count is reset.
Implementation
Flapping detection
Each OSPFv3 interface on which OSPFv3 neighbor relationship flapping
suppression is enabled starts a flapping counter. If the interval between two
flapping_events is shorter than the detect-interval, a valid flapping_event is
recorded, and the flapping_count is incremented by 1. When the flapping_count
reaches or exceeds threshold, flapping suppression takes effect. If the interval
between two successive neighbor status changes from Full to a non-Full state is
longer than resume-interval, the flapping_count is reset.
The detecting-interval, threshold, and resume-interval are configurable.
NOTE
The value of resume-interval must be greater than that of detecting-interval.
Flapping suppression
Flapping suppression works in either Hold-down or Hold-max-cost mode.
● Hold-down mode: In the case of frequent flooding and topology changes
during neighbor relationship establishment, interfaces prevent neighbor
relationships from being reestablished during the suppression period, which
minimizes LSDB synchronization attempts and packet exchanges.
● Hold-max-cost mode: If the traffic forwarding path changes frequently,
interfaces use 65535 as the cost of the flapping link during Hold-max-cost
suppression, which prevents traffic from passing through the flapping link.
Flapping suppression can also work first in Hold-down mode and then in Hold-
max-cost mode.
By default, the Hold-max-cost mode takes effect. The mode and suppression
duration can be changed manually.
If an attack causes frequent neighbor relationship flapping, Hold-down mode can
minimize the impact of the attack.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 396
NOTE
When an interface enters the flapping suppression state, all neighbor relationships on the
interface enter the state accordingly.
Exiting from flapping suppression
Interfaces exit from flapping suppression in the following scenarios:
● The suppression timer expires.
● The corresponding OSPFv3 process is reset.
● An OSPFv3 neighbor is reset.
● OSPFv3 neighbor relationship flapping suppression is disabled globally.
● A command is run to exit from flapping suppression.
Typical Scenarios
Basic scenario
In Figure 6-7, the traffic forwarding path is SwitchA -> SwitchB -> SwitchC ->
SwitchE before a link failure occurs. After the link between SwitchB and SwitchC
fails, the forwarding path switches to SwitchA -> SwitchB -> SwitchD -> SwitchE. If
the neighbor relationship between SwitchB and SwitchC frequently flaps at the
early stage of the path switchover, the forwarding path will be switched
frequently, causing traffic loss and affecting network stability. If the neighbor
relationship flapping meets suppression conditions, flapping suppression takes
effect.
● If flapping suppression works in Hold-down mode, the neighbor relationship
between SwitchB and SwitchC is prevented from being reestablished during
the suppression period, in which traffic is forwarded along the path SwitchA -
> SwitchB -> SwitchD -> SwitchE.
● If flapping suppression works in Hold-max-cost mode, 65535 is used as the
cost of the link between SwitchB and SwitchC during the suppression period,
and traffic is forwarded along the path SwitchA -> SwitchB -> SwitchD ->
SwitchE.
Figure 6-7 Flapping suppression in a basic scenario
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 397
Single-forwarding path scenario
When only one forwarding path exists on the network, the flapping of the
neighbor relationship between any two switches on the path will interrupt traffic
forwarding. In Figure 6-8, the traffic forwarding path is SwitchA -> SwitchB ->
SwitchC -> SwitchE. If the neighbor relationship between SwitchB and SwitchC
flaps, and the flapping meets suppression conditions, flapping suppression takes
effect. However, if the neighbor relationship between SwitchB and SwitchC is
prevented from being reestablished, the whole network will be divided. Therefore,
Hold-max-cost mode (rather than Hold-down mode) is recommended. If flapping
suppression works in Hold-max-cost mode, 65535 is used as the cost of the link
between SwitchB and SwitchC during the suppression period. After the network
stabilizes and the suppression timer expires, the link is restored.
NOTE
By default, the Hold-max-cost mode takes effect.
Figure 6-8 Flapping suppression in a single-forwarding path scenario
Broadcast scenario
In Figure 6-9, four switches are deployed on the same broadcast network using
switches, and the switches are broadcast network neighbors. If SwitchC flaps due
to a link failure, and SwitchA and SwitchB were deployed at different time
(SwitchA was deployed earlier for example) or the flapping suppression
parameters on SwitchA and SwitchB are different, SwitchA first detects the
flapping and suppresses SwitchC. Consequently, the Hello packets sent by SwitchA
do not carry SwitchC's Switch ID. However, SwitchB has not detected the flapping
yet and still considers SwitchC a valid node. As a result, the DR candidates
identified by SwitchA are SwitchB and SwitchD, whereas the DR candidates
identified by SwitchB are SwitchA, SwitchC, and SwitchD. Different DR candidates
result in a different DR election result, which may lead to route calculation errors.
To prevent this problem in scenarios where an interface has multiple neighbors,
such as on a broadcast, P2MP, or NBMA network, all neighbors on the interface
are suppressed when the status of a neighbor relationship last changes to ExStart
or Down. Specifically, if SwitchC flaps, SwitchA, SwitchB, and SwitchD on the
broadcast network are all suppressed. After the network stabilizes and the
suppression timer expires, SwitchA, SwitchB, and SwitchD are restored to normal
status.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 398
Figure 6-9 Flapping suppression on a broadcast network
Multi-area scenario
In Figure 6-10, SwitchA, SwitchB, SwitchC, SwitchE, and SwitchF are connected in
area 1, and SwitchB, SwitchD, and SwitchE are connected in backbone area 0.
Traffic from SwitchA to SwitchF is preferentially forwarded along an intra-area
route, and the forwarding path is SwitchA -> SwitchB -> SwitchC -> SwitchE ->
SwitchF. When the neighbor relationship between SwitchB and SwitchC flaps and
the flapping meets suppression conditions, flapping suppression takes effect in the
default mode (Hold-max-cost). However, the forwarding path remains unchanged
because intra-area routes take precedence over inter-area routes during route
selection according to OSPFv3 route selection rules. To prevent traffic loss in
multi-area scenarios, configure Hold-down mode to prevent the neighbor
relationship between SwitchB and SwitchC from being reestablished during the
suppression period. During this period, traffic is forwarded along the path SwitchA
-> SwitchB -> SwitchD -> SwitchE -> SwitchF.
NOTE
By default, the Hold-max-cost mode takes effect. The mode can be changed to Hold-down
manually.
Figure 6-10 Flapping suppression in a multi-area scenario
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 399
6.2.5 OSPFv3 and OSPFv2 Comparison
The following aspects of OSPFv3 and OSPFv2 are the same:
● Network type and interface type
● Interface state machine and neighbor state machine
● LSDB
● Flooding mechanism
● Hello, DD, LSR, LSU, and LSAck packets
● Route calculation
The following aspects of OSPFv3 and OSPFv2 are different:
● OSPFv3 runs on IPv6, which is based on links rather than network segments.
This means that there is no need to configure OSPFv3 on interfaces in the
same network segment. It is only necessary that the interfaces enabled with
OSPFv3 are on the same link. Interfaces can also set up OSPFv3 sessions
without IPv6 global addresses.
● OSPFv3 does not depend on IP addresses.
This separates topology calculation from IP addresses. OSPFv3 calculates a
topology without knowing the IPv6 global address, which only applies to
virtual link interfaces for packet forwarding.
● OSPFv3 packets and the LSA format have the following changes:
– OSPFv3 packets do not contain IP addresses.
– OSPFv3 router LSAs and network LSAs do not contain IP addresses, which
are advertised by Type 8 LSAs and Type 9 LSAs.
– In OSPFv3, router IDs, area IDs, and LSA link state IDs no longer indicate
IP addresses, but the IPv4 address format is still reserved.
– In broadcast, NBMA, or P2MP networks, neighbors are identified by
router IDs instead of IP addresses.
● In OSPFv3, information about the flooding scope is added in the LSA Type
field.
This allows OSPFv3 routers to process LSAs of unidentified types, which
makes processing more flexible.
– OSPFv3 stores or floods unidentified packets, whereas OSPFv2 discards.
– OSPFv3 floods packets in an OSPF area or on a link. It sets the U flag bit
of packets (the flooding area is based on the link local) so that
unidentified packets are stored or forwarded to the stub area.
For example, RouterA and RouterB can identify LSA of a certain type. They are
connected through RouterC, which cannot identify this type of LSA. When
RouterA floods an LSA of this type, RouterC still floods it to RouterB even
though it cannot identify the LSA itself. RouterB then processes the LSA
normally.
If this occurred over OSPFv2, RouterC would discard the unidentified LSA, and
it would not reach RouterB.
● OSPFv3 supports multi-process on a link.
Only one OSPFv2 process can be configured on a physical interface, but
multiple OSPFv3 processes can be configured a single physical interface.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 400
These processes are identified by different instance IDs. They establish
neighbor relationships with the other end of the link and transmit packets to
the other end without interfering with each other.
The resources of a link can therefore be shared among OSPFv3 instances that
simulate multiple OSPFv3 routers. This allows more efficient use of limited
router resources.
● OSPFv3 uses IPv6 link-local addresses.
IPv6 implements neighbor discovery and automatic configuration based on
link-local addresses. Routers running IPv6 do not forward IPv6 packets whose
destination address is a link-local address. Those packets can only be
exchanged on the same link. The unicast link-local address starts from
FE80::/10.
As a routing protocol running on IPv6, OSPFv3 uses link-local addresses to
maintain neighbor relationships and update LSDBs. All OSPFv3 interfaces,
except Vlink interfaces, use link-local addresses as the source address and the
next hop address to transmit OSPFv3 packets.
The advantages are as follows:
– The OSPFv3 can calculate the topology without knowing the global IPv6
addresses.
– The packets flooded on a link are not transmitted to other links, which
prevents unnecessary flooding and saves bandwidth.
● OSPFv3 supports the following two new LSAs:
– Type 8 (Link) LSA: A router floods a link LSA on the link where it resides
to advertise its link-local address and the configured global IPv6 address.
– Type 9 (Intra-Area-Prefix) LSA: A router advertises an intra-area-prefix
LSA in the local OSPF area to inform other routers in the area or network
of its IPv6 global address. The network can be a broadcast network or an
NBMA network.
● OSPFv3 identifies neighbors based only on router IDs.
OSPF identifies neighbors based on IPv4 interface addresses in broadcast,
NBMA, P2P, and P2MP networks and identifies neighbors based on router IDs
in Vlink networks.
Since OSPFv3 identifies neighbors based only on router IDs, it can establish
and maintain neighbor relationships even when global IPv6 addresses are not
configured or are configured in different network segments. Topology
calculation is not based on IP addresses.
6.3 Summary of OSPFv3 Configuration Tasks
Table 6-6 describes the OSPFv3 configuration tasks.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 401
Table 6-6 OSPFv3 configuration tasks
Scenario Description Task
Constructing a basic
OSPFv3 network
Enable the OSPFv3
process and specify the
router ID before
configuring OSPFv3.
After this is complete,
other OSPFv3 functions
can be configured or
take effect.
● 6.6 Configuring Basic
OSPFv3 Functions
● 6.7 Establishing and
Maintaining an
OSPFv3 Neighbor
Relationship
Configuring OSPFv3
special area attributes
You can flexibly use
OSPFv3 special area
attributes to deploy the
network according to
actual requirements. The
special areas are as
follows:
● 6.8 Configuring an
OSPFv3 Area
● 6.9 Configuring an
OSPFv3 NSSA
Configuring OSPFv3
route attributes
You can configure the
OSPFv3 route attributes
to change OSPFv3 route
selection policies. This
can help meet the
requirements of complex
network environments.
6.10 Configuring
OSPFv3 Route
Attributes
Controlling OSPFv3
routing information
You can configure route
summarization as well as
the filtering of received
and advertised routes.
Route summarization
lowers the number of
external routes in the
LSDB and provides
accurate control of
OSPFv3 routing
information.
6.11 Controlling
OSPFv3 Routing
Information
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 402
Scenario Description Task
Adjusting and optimizing
OSPFv3 networks
You can change the
OSPFv3 packet timer to
adjust the OSPFv3
network convergence
rate and network load
caused by protocol
packets. On some low-
rate links, the delay of
LSA transmission by
interfaces must be taken
into account. You can
adjust the Shortest Path
First (SPF) calculation
interval to restrict
resource consumption
caused by frequent
network changes.
6.12 Optimizing an
OSPFv3 Network
Configuring OSPFv3 GR You can enable OSPFv3
GR features to prevent
route flapping and
interruption of traffic
forwarding caused by an
OSPFv3 restart.
After OSPFv3 is
restarted, the GR
restarter and the GR
helper reestablish
neighbor relationships,
exchange routing
information, synchronize
the database, and
update the routing and
forwarding tables. This
implements fast OSPFv3
convergence.
6.15 Configuring
OSPFv3 GR
Improving OSPFv3
network security
On networks that require
high security, you can
configure the OSPFv3
Generalized TTL Security
Mechanism (GTSM) and
authentication mode to
improve network
security.
6.16 Improving OSPFv3
Network Security
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 403
Scenario Description Task
Configuring the OSPFv3
network management
function
OSPFv3 supports the
network management
function as well as fault
and log functions. You
can bind the OSPFv3
management
information base (MIB)
to a process to use these
functions.
6.19 Configuring the
Network Management
Function of OSPFv3
6.4 Licensing Requirements and Limitations for OSPFv3
Involved Network Elements
Other network elements are required to support OSPFv3.
Licensing Requirements
OSPFv3 is a basic feature of a switch and is not under license control.
Feature Support in V200R024C00
All models of S300, S500, S2700, S5700, and S6700 series switches (except the
S5751-L, S5731-L and S5731S-L) support OSPFv3.
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
Feature Limitations
None.
6.5 Default Settings for OSPFv3
Table 6-7 describes the default settings for OSPFv3.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 404
Table 6-7 Default settings for OSPFv3
Parameter Default Setting
OSPFv3 Disabled
Interval at which Hello
packets are sent
● 10 seconds for the interfaces on the P2P and
broadcast networks
● 30 seconds for the interfaces on P2MP and
NBMA networks
Dead interval after which
OSPFv3 neighbor
relationships expire
● 40 seconds for the interfaces on the P2P and
broadcast networks
● 120 seconds for the interfaces on P2MP and
NBMA networks
Period during which a
switch acts as a stub router
500 seconds
Bandwidth reference value
used to calculate a link cost
100 Mbit/s
6.6 Configuring Basic OSPFv3 Functions
Applicable Environment
Configure basic OSPFv3 functions before building OSPFv3 networks. Enable
OSPFv3 and specify the interface, area ID, and router ID before configuring other
functions.
Pre-configuration Tasks
Before configuring basic OSPFv3 functions, complete the following tasks:
● Enable IPv6 capabilities.
● Make the network layers of the adjacent nodes accessible.
6.6.1 Enabling OSPFv3
Context
OSPFv3 supports multiple processes on a switch. These processes are
differentiated by process IDs. A process ID is set when OSPFv3 is enabled and is
only locally valid. It does not affect packet exchange with other switches.
A router ID is a 32-bit unsigned integer that uniquely identifies a switch within an
AS. It is expressed in the IPv4 address format. OSPFv3 router IDs must be
manually set. If the router ID is not set, OSPFv3 cannot function normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 405
Ensure that the router IDs of switches in an AS are all different. When multiple
OSPFv3 processes are enabled on a switch, specify a unique router ID for each
process.
Plan router IDs and manually configure them to ensure the stable operation of
OSPFv3.
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ] [ vpn-instance
vpn-instance-name ]
OSPFv3 is enabled, and the OSPFv3 view is displayed.
Step 3 Run router-id
router-id
A router ID is set.
When configuring a router ID, ensure that the router ID is unique in an AS. You
can select the IP address of an interface as the router ID.
NOTE
If router IDs conflict in an OSPFv3 process, routers cannot establish OSPFv3 neighbor
relationships, and the routing information is incorrect.
If a router ID conflict occurs, perform either of the following operations:
● Reconfigure a router ID.
● Run the undo ospfv3 router-id auto-recover disable command to enable the
switch to automatically change the conflicted router ID to its own IP address.
NOTE
– After the undo ospfv3 router-id auto-recover disable command is run, the conflicting
router ID will be changed.
– After the router ID is changed, if the new router ID still conflicts with another one, the
switch is allowed to reconfigure one for a maximum of three times.
----End
6.6.2 Enabling OSPFv3 on an Interface
Context
After enabling OSPFv3 in the system view, enable OSPFv3 on an interface.
Because an interface has multiple instances, specify in which instance OSPFv3 is
enabled. If no instance ID is specified, the value defaults to 0. The same instance
must be enabled on interfaces between which the neighbor relationship is set up.
Perform the following operations on the switch that runs OSPFv3.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 406
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospfv3
process-id area
area-id [ instance
instance-id ]
OSPFv3 is enabled on the interface.
The area ID can be entered as a decimal integer or in the IPv4 address format, but
it is always displayed in the IPv4 address format.
Step 5 (Optional) Run the ospfv3 network-type { broadcast | nbma | p2mp [ non-
broadcast ] | p2p } [ instance
instance-id ] command to configure a network type
for the interface.
NOTE
When an interface supports multi-instances, you must specify the value of
instance-id when
enabling OSPFv3 on the interface. If the value of
instance-id is not specified, the default value 0
is used. In this case, the configured network type of an interface may not match the actual
network type of the interface. This step is mandatory in such a case.
----End
6.6.3 Entering an OSPFv3 Area View
Context
When configuring OSPFv3 switches in the same area, uniformly plan the
configuration data. Otherwise, neighbor switches cannot exchange information
with each other. This causes congestion of routing information or routing loops.
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ] [ vpn-instance
vpn-instance-name ]
The OSPFv3 view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 407
Step 3 Run area
area-id
The OSPFv3 area view is displayed.
The area ID can be entered as a decimal integer or in the IPv4 address format.
However, it is displayed in the IPv4 address format.
An OSPFv3 area cannot be manually deleted. It is automatically deleted only after
all the configurations in the area view are cleared.
----End
6.6.4 (Optional) Configuring a Route Selection Rule
Context
RFC 5340 and RFC 1583 define route selection rules differently. After OSPFv3 is
enabled on a switch, you need to specify a route selection rule based on the
switch configuration. By default, a switch complies with the route selection rule
defined in RFC 5340. If the neighboring switch complies with the route selection
rule defined in RFC 1583, you need to configure the local switch to comply with
that defined in RFC 1583. This allows all switches in an OSPFv3 area to comply
with the same route selection rule.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospf [
process-id ] [ vpn-instance
vpn-instance-name ]
The OSPF process view is displayed.
Step 3 Run rfc1583 compatible
The device is configured to comply with the route selection rules defined in RFC
1583, rather than RFC 5340.
By default, the switch complies with the route selection rules defined in RFC 5340.
----End
6.6.5 Verifying the Basic OSPFv3 Function Configuration
Prerequisites
Configuring basic OSPFv3 functions is complete.
Procedure
● Run the display ospfv3 [
process-id ] command to check the summary
information about the OSPFv3 process.
● Run the display ospfv3 [
process-id ] interface [ area
area-id ] [
interface-
type interface-number ] command to check the OSPFv3 interface information.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 408
● Run the following commands to check OSPFv3 LSDB information:
– display ospfv3 [
process-id ] lsdb [ area
area-id ] [ originate-router
advertising-router-id | self-originate ] [ { router | network | inter-router
[ asbr-router
asbr-router-id ] | { inter-prefix | nssa } [
ipv6-address
prefix-length ] | link | intra-prefix | grace } [
link-state-id ] ]
– display ospfv3 [
process-id ] lsdb [ originate-router
advertising-router-
id | self-originate ] external [
ipv6-address prefix-length ] [
link-state-
id ]
● Run the display ospfv3 [
process-id ] [ area
area-id ] peer [
interface-type
interface-number ] [ verbose ] command or display ospfv3 [
process-id ]
[ area
area-id ] peer
neighbor-id [ verbose ] command to check the
information about the OSPFv3 neighbor.
● Run the display ospfv3 [
process-id ] routing [ abr-routes | asbr-routes |
statistics |
ipv6-address prefix-length | intra-routes | inter-routes | ase-
routes | nssa-routes ] command to check the OSPFv3 routing table:
● Run the display ospfv3 [
process-id ] path command to check the paths to a
destination address.
● Run the display default-parameter ospfv3 command to check the default
OSPFv3 configuration.
----End
6.7 Establishing and Maintaining an OSPFv3 Neighbor
Relationship
Applicable Environment
Establishing and maintaining OSPFv3 neighbor relationships is necessary for the
construction of an OSPFv3 network. The configurations in this section allow you
to:
● Modify OSPFv3 timers to adjust the convergence speed of the OSPFv3
network and the network load caused by protocol packets.
● Configure the OSPFv3 retransmission limitation to prevent non-stop packet
retransmissions if the neighbor does not receive packets.
● Adjust the intervals for updating and receiving LSAs to speed up the
convergence of an OSPFv3 network.
Pre-configuration Tasks
Before establishing or maintaining an OSPFv3 neighbor relationship, configure
basic OSPFv3 functions.
6.7.1 Configuring an Interval at Which Hello Packets are Sent
Context
Hello packets are sent periodically to the neighbor switch to establish and
maintain a neighbor relationship and to elect a designated router (DR) and a
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 409
backup DR (BDR). RFC 2328 requires that the Hello timer values of neighbors be
consistent. The value of the Hello timer is inversely proportional to the route
convergence speed and network load.
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospfv3 timer hello
interval [ conservative ] [ instance
instance-id ]
The interval at which Hello packets are sent is set on the interface.
----End
6.7.2 Configuring a Dead Time for a Neighbor Relationship
Context
A neighbor switch is considered invalid if a switch receives no Hello packets it for a
specified period of time. The period is called the dead time. The dead time on an
interface must be at least four times its Hello interval.
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 410
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospfv3 timer dead
interval [ instance
instance-id ]
A dead time is specified for a neighbor relationship.
----End
6.7.3 Configuring an LSA Retransmission Interval
Context
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospfv3 timer retransmit
interval [ instance
instance-id ]
The interval for retransmitting LSAs to adjacent switches is set.
The value of
interval must be greater than the round trip time of one packet
transmitted between two switches.
NOTE
An excessively small LSA retransmission can cause unnecessary retransmissions.
----End
6.7.4 Configuring an LSA Transmission Delay
Context
LSAs age in the LSDB of a local switch but do not age in the transmission process.
Set a delay for LSA transmission. This is a necessary configuration for low-speed
networks.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 411
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospfv3 trans-delay
interval [ instance
instance-id ]
A delay for LSA transmission is set on the interface.
----End
6.7.5 Verifying the OSPFv3 Neighbor Relationship
Establishment and Maintenance Configuration
Prerequisites
The configurations for establishing and maintaining an OSPFv3 neighbor
relationship have been completed.
Procedure
● Run the display ospfv3 [
process-id ] interface [ area
area-id ] [
interface-
type interface-number ] command to check the OSPFv3 interface information.
----End
6.8 Configuring an OSPFv3 Area
Applicable Environment
Define OSPFv3 areas to reduce the number of LSAs in the network and enhance
OSPFv3 extensibility. To further reduce the size of routing tables and number of
LSAs, specify some non-backbone areas at the edge of ASs as stub areas.
Pre-configuration Tasks
Before configuring OSPFv3 area attributes, configure basic OSPFv3 functions.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 412
6.8.1 Configuring an OSPFv3 Stub Area
Context
Perform the following operations on each switch that runs OSPFv3 in the area
that will be configured as a stub area:
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ]
The OSPFv3 view is displayed.
Step 3 Run area
area-id
The OSPFv3 area view is displayed.
Step 4 Run stub [ no-summary ]
The area is configured as a stub area.
Step 5 (Optional) Run default-cost
cost
The cost of the default route sent to the stub area is set.
By default, this cost is 1.
Perform this step only on the ABR in the stub area.
The parameter no-summary takes effect only when the stub command is
configured on the ABR. If this parameter is configured, the ABR only sends the
summary-LSA of a default route to the stub area. It does not generate other
summary-LSAs, such as AS-external-LSAs or Summary-LSAs. This area is called a
totally stub area.
----End
6.8.2 Configuring OSPFv3 Virtual Links
Context
After an OSPFv3 area is defined, OSPFv3 route updates between non-backbone
areas are implemented through a backbone area. OSPFv3 requires all non-
backbone areas to maintain connectivity with the backbone area and the
backbone area to maintain its own connectivity as well. If this requirement cannot
be met, configure OSPFv3 virtual links.
A virtual link must be configured at both ends of the link, or it will not take effect.
Perform the following operations on the switch that runs OSPFv3.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 413
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ]
The OSPFv3 view is displayed.
Step 3 Run area
area-id
The OSPFv3 area view is displayed.
Step 4 Run vlink-peer
router-id [ hello
hello-interval | retransmit
retransmit-interval |
trans-delay
trans-delay-interval | dead
dead-interval | instance
instance-id |
{ authentication-mode { hmac-sha256 key-id
key-id { plain
plain-text |
[ cipher ]
cipher-text } | keychain
keychain-name } | ipsec sa
sa-name } ] *
A virtual link is created and configured.
NOTICE
If plain is selected, the password is saved in the configuration file in plain text.
This brings security risks. It is recommended that you select cipher to save the
password in cipher text.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support the keychain
keychain-name parameter.
----End
6.8.3 Verifying the OSPFv3 Area Configuration
Prerequisites
The configurations for an OSPFv3 area have been completed.
Procedure
● Run the following commands to check OSPFv3 LSDB information:
– display ospfv3 [
process-id ] lsdb [ area
area-id ] [ originate-router
advertising-router-id | self-originate ] [ { router | network | inter-router
[ asbr-router
asbr-router-id ] | { inter-prefix | nssa } [
ipv6-address
prefix-length ] | link | intra-prefix | grace } [
link-state-id ] ]
– display ospfv3 [
process-id ] lsdb [ originate-router
advertising-router-
id | self-originate ] external [
ipv6-address prefix-length ] [
link-state-
id ]
● Run the following commands to check the OSPFv3 routing table:
– display ospfv3 [
process-id ] routing uninstalled
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 414
– display ospfv3 [
process-id ] routing [
ipv6-address prefix-length | abr-
routes | asbr-routes | intra-routes | inter-routes | ase-routes | nssa-
routes | [ statistics ] [ uninstalled ] ]
● Run the display ospfv3 [
process-id ] vlink command to check information
about OSPFv3 virtual links.
● Run the display ospfv3 [
process-id ] vlink command to check information
about OSPFv3 virtual links.
----End
6.9 Configuring an OSPFv3 NSSA
Applicable Environment
Configure a non-backbone area on the border of an AS as a not-so-stubby area
(NSSA) to reduce entries in routing tables and the amount of routing information
transmitted. An NSSA allows the transmission of Type 7 LSAs, which are generated
by ASBRs in an NSSA. These LSAs are converted into Type 5 LSAs in the NSSA and
advertised to other areas.
Pre-configuration Tasks
Before configuring an OSPFv3 NSSA, configure basic OSPFv3 functions.
6.9.1 Defining an Area as an NSSA
Context
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ]
The OSPFv3 process view is displayed.
Step 3 (Optical) Run lsa-forwarding-address { standard | zero-translate }
The OSPFv3 forwarding address (FA) function is enabled.
Step 4 Run area
area-id
The OSPFv3 area view is displayed.
Step 5 Run nssa [ default-route-advertise [ cost
cost | type
type | tag
tag ] * | no-
import-route | no-summary | translator-always | translator-interval
translator-
interval | set-n-bit | suppress-forwarding-address ] *
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 415
An area is configured as an NSSA.
----End
Follow-up Procedure
If an area is configured as an NSSA, all switches in the area must be configured
with the NSSA attribute.
The area may be updated after NSSA attributes are configured or deleted.
Therefore, the NSSA attributes can be re-configured or deleted only after the last
update to the area is complete.
6.9.2 Verifying the OSPFv3 NSSA Configuration
Prerequisites
The configurations for an OSPFv3 NSSA are complete.
Procedure
● Run the display ospfv3 [
process-id ] area [
area-id ] command to check
information about an OSPFv3 area.
● Run the following commands to check the OSPFv3 routing table:
– display ospfv3 [
process-id ] routing uninstalled
– display ospfv3 [
process-id ] routing [ abr-routes | asbr-routes |
statistics [ uninstalled ] |
ipv6-address prefix-length | intra-routes |
inter-routes | ase-routes | nssa-routes ]
----End
6.10 Configuring OSPFv3 Route Attributes
Applicable Environment
To meet the requirements of complex networks, change OSPFv3 routing policies
by setting OSPFv3 route attributes. You can:
● Set a cost for an OSPFv3 interface.
● Configure load balancing among equal-cost routes.
Pre-configuration Tasks
Before configuring OSPFv3 route attributes, configure basic OSPFv3 functions.
6.10.1 Setting a Cost for an OSPFv3 Interface
Context
You can control route calculation by setting link costs for OSPFv3 interfaces.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 416
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospfv3 cost
cost [ instance
instance-id ]
A cost is set for the OSPFv3 interface.
By default, this cost is 1.
----End
6.10.2 Setting the Maximum Number of Equal-Cost Routes
Context
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ]
The OSPFv3 view is displayed.
Step 3 Run maximum load-balancing
number
The maximum number of equal-cost routes is set.
The default value is 8.
----End
6.10.3 Verifying the OSPFv3 Route Attribute Configuration
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 417
Prerequisites
The configurations for OSPFv3 route attributes are complete.
Procedure
● Run the display ospfv3 [
process-id ] interface [ area
area-id ] [
interface-
type interface-number ] command to check the OSPFv3 interface information.
● Run the following commands to check OSPFv3 LSDB information:
– display ospfv3 [
process-id ] lsdb [ area
area-id ] [ originate-router
advertising-router-id | self-originate ] [ { router | network | inter-router
[ asbr-router
asbr-router-id ] | { inter-prefix | nssa } [
ipv6-address
prefix-length ] | link | intra-prefix | grace } [
link-state-id ] ]
– display ospfv3 [
process-id ] lsdb [ originate-router
advertising-router-
id | self-originate ] external [
ipv6-address prefix-length ] [
link-state-
id ]
● Run the following commands to check the OSPFv3 routing table:
– display ospfv3 [
process-id ] routing uninstalled
– display ospfv3 [
process-id ] routing [
ipv6-address prefix-length | abr-
routes | asbr-routes | intra-routes | inter-routes | ase-routes | nssa-
routes | [ statistics ] [ uninstalled ] ]
----End
6.11 Controlling OSPFv3 Routing Information
Applicable Environment
Control the advertisement and receipt of OSPFv3 routing information and
configure OSPFv3 to import external routes. Detailed operations include
configuring route summarization, filtering the received routes, and importing
external routes.
Pre-configuration Tasks
Before controlling OSPFv3 routing information, configure basic OSPFv3
functions.
6.11.1 Configuring OSPFv3 Route Summarization
Context
Route summarization on a large-scale OSPFv3 network reduces the number of
routing entries. This function minimizes system resource consumption while
maintaining system performance. In addition, if a link in the summarized IPv6
address segment frequently alternates between Up and Down, the devices outside
this address segment will not be affected by the link status transition. Route
summarization therefore prevents route flapping and improves network stability.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 418
Procedure
● Configure inter-area route summarization on an ABR.
Perform the following operations on the ABR that runs OSPFv3.
a. Run system-view
The system view is displayed.
b. Run ospfv3 [
process-id ]
The OSPFv3 view is displayed.
c. Run area
area-id
The OSPFv3 area view is displayed.
d. Run abr-summary
ipv6-address prefix-length [ cost
cost | not-
advertise ] *
Route summarization for inter-area routes is configured.
● Configure external route summarization on an ASBR.
Perform the following operations on the ASBR that runs OSPFv3.
a. Run system-view
The system view is displayed.
b. Run ospfv3 [
process-id ]
The OSPFv3 view is displayed.
c. Run asbr-summary
ipv6-address prefix-length [ cost
cost | tag
tag |
distribute-delay
dist-delay-interval | not-advertise ] *
Route summarization for imported routes is configured.
----End
6.11.2 Configuring OSPFv3 to Filter the Received Routes
Context
Configuring a filtering policy allows OSPFv3 to determine whether to add the
calculated routes to the local routing table when receiving LSAs.
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ]
The OSPFv3 view is displayed.
Step 3 Run filter-policy {
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-prefix-
name | route-policy
route-policy-name } import
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 419
OSPFv3 is configured to filter the imported routes.
Using the filter-policy command, you can only filter the routes calculated by
OSPFv3. Routes that do not pass the filtering criteria are neither added to the
OSPFv3 routing table nor advertised.
----End
6.11.3 Configuring OSPFv3 to Import External Routes
Context
Because OSPFv3 is a link-state routing protocol and cannot filter advertised LSAs
directly, it must filter routes when importing them. After filtering, only the routes
that pass the filtering criteria are advertised.
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ]
The OSPFv3 view is displayed.
Step 3 Run default { cost
cost | tag
tag | type
type }*
Default parameters are set for imported routes.
Step 4 Run import-route { bgp [ permit-ibgp ] | unr | direct | ripng
help-process-id |
static | isis
help-process-id | ospfv3
help-process-id } [ { cost
cost | inherit-cost } |
type
type | tag
tag | route-policy
route-policy-name ]*
External routes are imported.
NOTE
Importing IBGP routes in an OSPFv3 process may lead to routing loops.
After the import-route command is executed on an OSPFv3 switch to import external
routes, the switch becomes an ASBR.
Step 5 (Optional) Run default-route-advertise [ always | cost
cost | type
type | tag
tag |
route-policy
route-policy-name ]*
Default routes are advertised to the OSPFv3 routing area.
Step 6 (Optional) Run filter-policy {
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-prefix-name | route-policy
route-policy-name } export [
protocol [
process-
id ] ]
Imported external routes are filtered.
To filter a certain type of route, you must specify
protocol. Otherwise, OSPFv3
filters all imported routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 420
NOTE
The filter-policy command takes effect only for the routes imported by an ASBR using the
import-route command. The ASBR filters routes when importing the routes. The routes
that are filtered out do not generate LSAs and cannot be advertised by OSPFv3. If the
import-route command is not run to import other external routes (including OSPFv3
routes in different processes), the filter-policy command does not take effect.
----End
6.11.4 (Optional) Configuring OSPFv3 to Filter LSAs in an
Area
Context
After filtering criteria are set for the incoming or outgoing Type 3 LSAs (Inter-
Area-Prefix LSAs) in an area, only the Type 3 LSAs that meet the criteria are
received or advertised. This filters unnecessary LSAs, reduces the LSDB size, and
increases network convergence.
This function is applicable only to the ABR.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ]
The OSPFv3 process view is displayed.
Step 3 Run area
area-id
The OSPFv3 area view is displayed.
Step 4 Filter incoming or outgoing Type 3 LSAs in the area.
● Run the filter {
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-prefix-
name | route-policy
route-policy-name } import command to filter incoming
Type 3 LSAs in the area.
● Run the filter {
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-prefix-
name | route-policy
route-policy-name } export command to filter outgoing
Type 3 LSAs in the area.
----End
6.11.5 Verifying the OSPFv3 Route Control Configuration
Procedure
● Run the following commands to view the OSPFv3 routing table:
– display ospfv3 [
process-id ] routing uninstalled
– display ospfv3 [
process-id ] routing [
ipv6-address prefix-length | abr-
routes | asbr-routes | intra-routes | inter-routes | ase-routes | nssa-
routes | [ statistics ] [ uninstalled ] ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 421
● Run the following commands to view OSPFv3 LSDB information:
– display ospfv3 [
process-id ] lsdb [ area
area-id ] [ originate-router
advertising-router-id | self-originate ] [ { router | network | inter-router
[ asbr-router
asbr-router-id ] | { inter-prefix | nssa } [
ipv6-address
prefix-length ] | link | intra-prefix | grace } [
link-state-id ] ]
– display ospfv3 [
process-id ] lsdb [ originate-router
advertising-router-
id | self-originate ] external [
ipv6-address prefix-length ] [
link-state-
id ]
● Run the following commands to view OSPFv3 route summarization
information:
– display ospfv3 [
process-id ] abr-summary-list [
ipv6-address prefix-
length ]
– display ospfv3 [
process-id ] asbr-summary [
ipv6-address prefix-
length ] [ verbose ]
----End
6.12 Optimizing an OSPFv3 Network
Applicable Environment
Adjust the OSPFv3 timer to change the convergence speed of an OSPFv3 network
and the network overload caused by protocol packets. On low-speed links, take
into account the delay in transmitting LSAs on the interface. Adjust the SPF
calculation interval to mitigate resource consumption caused by frequent network
changes.
Specify the DR priority of an interface to affect DR and BDR election in a
broadcast network.
Pre-configuration Tasks
Before optimizing an OSPFv3 network, configure basic OSPFv3 functions.
6.12.1 Configuring an SPF Timer
Context
When the OSPFv3 LSDB changes, SPF calculation must be performed again. A
shorter SPF calculation interval can increase network convergence speed, but also
occupies more resources. In addition, frequent network changes can cause
excessive bandwidth use. A longer SPF calculation interval occupies fewer
resources, which prevents the bandwidth use due to frequent network changes.
However, this also decreases network convergence speed. Set the interval based
on actual network conditions.
Perform the following operations on the switch that runs OSPFv3.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 422
Procedure
● Configure an SPF normal timer.
a. Run system-view
The system view is displayed.
b. Run ospfv3 [
process-id ]
The OSPFv3 view is displayed.
c. Run spf timers
delay-interval hold-interval
Or run spf-schedule-interval
delay-interval hold-interval
An SPF normal timer is configured.
● Configure an SPF intelligent timer.
a. Run system-view
The system view is displayed.
b. Run ospfv3 [
process-id ]
The OSPFv3 view is displayed.
c. Run spf-schedule-interval intelligent-timer
max-interval start-interval
hold-interval-1
An SPF intelligent timer is configured.
NOTE
The configurations of the spf timers
delay-interval hold-interval, spf-schedule-
interval
delay-interval hold-interval, and spf-schedule-interval intelligent-
timer
max-interval start-interval hold-interval-1 commands will override each
other, and only the configuration of the last executed command takes effect.
----End
6.12.2 Suppressing an Interface from Sending and Receiving
OSPFv3 Packets
Context
To prevent a switch from advertising routes to the switch on a certain network
and from importing the routes of other switches, suppress the interface on which
OSPFv3 is enabled from receiving and sending OSPFv3 packets.
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ]
The OSPFv3 view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 423
Step 3 Run silent-interface { all |
interface-type interface-number }
The interface is suppressed from sending and receiving OSPFv3 packets.
----End
Follow-up Procedure
Different processes can suppress the same interface from sending and receiving
OSPFv3 packets, but the silent-interface command is valid only for the OSPFv3
interface on which the specified process is enabled. It does not take effect on the
interface of other processes.
After an OSPFv3 interface is set to silent, the interface can still advertise its direct
routes using the Intra-Area-Prefix-LSA of the same switch. No OSPFv3 neighbor
relationship can be set up on the interface. This enhances OSPFv3 adaptability.
6.12.3 Configuring a DR Priority for an Interface
Context
The DR priority on a switch interface determines whether the interface is qualified
for the DR election. If the DR priority is 0, the switch cannot be elected as a DR or
BDR.
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospfv3 dr-priority
priority [ instance
instance-id ]
A DR priority is set for the interface.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 424
Follow-up Procedure
After the DR priority is changed, you can re-elect a DR or BDR. However, this will
interrupt OSPFv3 neighbor relationships between switches and is therefore only
used when necessary. The methods to re-elect a DR or BDR are as follows:
● Restart all switches.
● Run the shutdown and undo shutdown commands on the interface on
which the OSPFv3 neighbor relationship is set up.
6.12.4 Configuring a Stub Router
Context
A stub router is used to control traffic and instructs other OSPFv3 routers not to
use it to forward data. Other OSPFv3 routers can have a route to the stub router.
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ]
The OSPFv3 process view is displayed.
Step 3 Run stub-router [ on-startup [
interval ] ]
The switch is configured as a stub router.
NOTE
A stub router configured using this command bears no similarity to a switch in a stub area.
----End
6.12.5 Ignoring MTU Check on DD Packets
Context
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 425
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospfv3 mtu-ignore [ instance
instance-id ]
MTU check on DD packets is ignored.
----End
6.12.6 Verifying the OSPFv3 Network Optimization
Configuration
Prerequisites
The configurations for optimizing an OSPFv3 network are complete.
Procedure
● Run the display ospfv3 [
process-id ] interface [ area
area-id ] [
interface-
type interface-number ] command to check the OSPFv3 interface information.
● Run the following commands to check OSPFv3 LSDB information:
– display ospfv3 [
process-id ] lsdb [ area
area-id ] [ originate-router
advertising-router-id | self-originate ] [ { router | network | inter-router
[ asbr-router
asbr-router-id ] | { inter-prefix | nssa } [
ipv6-address
prefix-length ] | link | intra-prefix | grace } [
link-state-id ] ]
– display ospfv3 [
process-id ] lsdb [ originate-router
advertising-router-
id | self-originate ] external [
ipv6-address prefix-length ] [
link-state-
id ]
● Run the following commands to check the OSPFv3 routing table:
– display ospfv3 [
process-id ] routing uninstalled
– display ospfv3 [
process-id ] routing [
ipv6-address prefix-length | abr-
routes | asbr-routes | intra-routes | inter-routes | ase-routes | nssa-
routes | [ statistics ] [ uninstalled ] ]
----End
6.13 Configuring BFD for OSPFv3
Applicable Environment
To speed up OSPFv3 convergence when link status changes, configure BFD for
OSPFv3 links.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 426
BFD detects links much faster than keepalive protocols do. If OSPFv3 is bound to
BFD sessions, BFD can notify OSPFv3 of link failures immediately. OSPFv3 then
performs route calculation and convergence based on the new network topology.
Pre-configuration Tasks
Before configuring BFD for OSPFv3, configure basic OSPFv3 functions.
Configuration Procedure
Figure 6-11 Flowchart for configuring BFD for OSPFv3
6.13.1 Configuring BFD Globally
Context
On the two devices that need to establish a BFD session, configure BFD for all the
interfaces in a certain OSPFv3 process.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3
process-id
The OSPFv3 view is displayed.
Step 3 Run bfd all-interfaces enable
BFD for OSPFv3 is enabled to establish a BFD session.
By default, BFD is disabled in an OSPFv3 process.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 427
6.13.2 Configuring BFD for OSPFv3
Context
After enabling BFD for OSPFv3, you need to configure BFD parameters in the
OSPFv3 process.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3
process-id
The OSPFv3 view is displayed.
Step 3 Run bfd all-interfaces { min-transmit-interval
min-transmit-value | min-receive-
interval
min-receive-value | detect-multiplier
detect-multiplier-value }*
OSPFv3 BFD parameters are configured.
Using the default
min-transmit-value,
min-receive-value, and detect-multiplier
values is recommended. As such, this step can be skipped.
The parameters are configured based on the network status and network
reliability requirements. A short interval at which BFD packets are transmitted can
be configured for a link that has a higher requirement for reliability. A long
interval at which BFD packets are transmitted can be configured for a link that has
a lower requirement for reliability.
----End
6.13.3 (Optional) Preventing an Interface from Dynamically
Setting Up a BFD Session
Context
After the bfd all-interfaces enable command is run in an OSPFv3 process, the
following situations occur:
● On a P2P network, all OSPFv3 interfaces whose neighbor status is Up set up
dynamic BFD sessions.
● On a broadcast network, all OSPFv3 interfaces whose neighbor status is Up
set up dynamic sessions between DRs and non-DRs.
To prevent certain interfaces from setting up dynamic BFD sessions, perform the
following steps on the interfaces:
Procedure
Step 1 Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 428
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospfv3 bfd block
The interface is prevented from dynamically setting up BFD sessions.
----End
6.13.4 (Optional) Configuring BFD for a Specified Interface
Context
To configure BFD only on a specified interface or enable an interface to detect link
failures faster after BFD for OSPFv3 is enabled globally, perform the following
steps on the interface:
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run ospfv3 bfd enable
BFD is enabled on the interface to establish a BFD session.
When BFD is configured globally and the neighbor status is Full, OSPFv3
establishes BFD sessions on all the neighbors in the process using default BFD
parameters.
You can run the ospfv3 bfd { min-transmit-interval
min-transmit-value | min-
receive-interval
min-receive-value | detect-multiplier
detect-multiplier-value }*
[ instance
instance-id ] } command to set parameters for BFD sessions.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 429
Using the default
min-transmit-value,
min-receive-value, and detect-multiplier
values is recommended. Therefore, the ospfv3 bfd { min-transmit-interval
min-
transmit-value | min-receive-interval
min-receive-value | detect-multiplier
detect-multiplier-value }* [ instance
instance-id ] } command can be skipped.
The parameters are configured based on the network status and network
reliability requirements. A short interval at which BFD packets are transmitted can
be configured for a link that has a higher requirement for reliability. A long
interval at which BFD packets are transmitted can be configured for a link that has
a lower requirement for reliability.
NOTE
● The BFD configured on an interface takes precedence over that configured in a process.
Specifically, if BFD is enabled on an interface, BFD parameters on the interface are used
to establish BFD sessions.
● If the parameters of a BFD session are set but the ospfv3 bfd enable command is not
run, BFD cannot be enabled.
----End
6.13.5 Verifying the BFD for OSPFv3 Configuration
Procedure
● Run the display ospfv3 [
process-id ] bfd session [
interface-type interface-
number ] [
neighbor-id ] [ verbose ] command to check information about
the BFD session.
----End
6.14 Configuring OSPFv3 IP FRR
Usage Scenario
With the development of networks, Voice over IP (VoIP) and on-line video services
require high-quality real-time transmission. Nevertheless, if an OSPFv3 fault
occurs, traffic can be switched to a new link only after the following processes:
fault detection at the millisecond level, notifying the fault to the routing control
plane at the millisecond level, generating and flooding new topology information
at the tens of milliseconds level, triggering SPF calculation at the tens of
milliseconds level, and notifying and installing a new route at the hundreds-of-
milliseconds level. As a result, it takes much more than 50 ms to recovery the link
from the fault, which cannot meet the requirement for real-time services on the
network.
With OSPFv3 IP FRR that calculates a backup link in advance, devices can fast
switch traffic to the backup link without interrupting traffic when the primary link
becomes faulty. This protects traffic and therefore greatly improves the reliability
of OSPFv3 networks.
OSPFv3 IP FRR is applicable to the services that are sensitive to packet delay and
packet loss.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 430
NOTE
Only the S5720I-SI, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S, S5731S-H,
S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and S6730S-S
support this function.
6.14.1 Enabling OSPFv3 IP FRR
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ] [ vpn-instance
vpn-instance-name ]
An OSPFv3 process is started, and the OSPFv3 view is displayed.
Step 3 Run frr
The OSPFv3 IP FRR view is displayed.
Step 4 Run loop-free-alternate
OSPFv3 IP FRR is enabled to generate a loop-free backup link.
By default, this function is disabled. OSPFv3 can generate a loop-free backup link
only when the OSPFv3 IP FRR traffic protection inequality is met.
NOTE
In the following description, Distance_opt(X, Y) indicates the shortest link from node X to
node Y, S stands for a source node, E for the faulty node, N for a node along a backup link,
and D for a destination node.
● Link protection takes effect when the traffic to be protected flows along a
specified link and the link cost meets the inequality: Distance_opt(N, D) <
Distance_opt(N, S) + Distance_opt(S, D).
● Node-and-link protection takes effect when the traffic to be protected flows
along a specified link and passes through a specified node and the following
conditions are met:
– The link cost meets the inequality: Distance_opt(N, D) < Distance_opt(N,
S) + Distance_opt(S, D).
– The interface cost meets the inequality: Distance_opt(N, D) <
Distance_opt(N, E) + Distance_opt(E, D).
Step 5 (Optional) Run frr-policy route route-policy
route-policy-name
An OSPFv3 IP FRR filtering policy is configured.
After an OSPFv3 IP FRR filtering policy is configured, only the OSPFv3 backup
routes that pass the filtering criteria can be delivered to the forwarding table. To
protect the traffic over a specific OSPFv3 route, you can configure a filtering policy
that matches the OSPFv3 route to ensure that the route can be added to the
forwarding table. If this route fails, OSPFv3 can fast switch the traffic to a backup
route.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 431
6.14.2 (Optional) Disabling OSPFv3 IP FRR on an Interface
Context
OSPFv3 IP FRR can be disabled on an interface of a specific device that is running
important services. This prevents the device connected to this interface from
providing a backup link for the local device and therefore being burdened after
FRR switches traffic to the backup link.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The view of the OSPFv3 IP FRR-enabled interface is displayed.
Step 3 Run ospfv3 frr block
OSPFv3 IP FRR is disabled on the interface.
----End
6.14.3 Verifying the OSPFv3 IP FRR Configuration
Prerequisites
All OSPFv3 IP FRR configurations are complete.
Procedure
● Run the display ospfv3 [
process-id ] routing command to check information
about the primary and backup links after OSPFv3 IP FRR is enabled.
View the routes to the specified OSPFv3 device.
<HUAWEI> display ospfv3 routing verbose
Codes : E2 - Type 2 External, E1 - Type 1 External, IA - Inter-Area,
N - NSSA, U - Uninstalled, D - Denied by Import Policy
Destination : CC:: Prefix Length : 64
Metric : 21 Type : INTRA-AREA
Nexthop : FE80::2E0:50FF:FE79:8242 Nexthop Interface: GigabitEthernet0/0/1
Backup Nexthop: FE80::2E0:D0FF:FE02:8142 Backup Interface : GigabitEthernet0/0/2
Backup Type : LINK PROTECT
The preceding information shows that a backup route is generated on the
switch, including information about the backup next hop: Backup NextHop,
Backup Interface, and Backup Type indicating the address, outbound
interface, and type of the backup next hop respectively.
----End
6.15 Configuring OSPFv3 GR
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 432
Applicable Environment
Configure OSPFv3 Graceful Restart (GR) to avoid route flapping and packet loss
after an OSPFv3 switch restarts.
After OSPFv3 restarts, the GR restarter and GR helper maintain the neighbor
relationship, exchange routing information, synchronize the database, and update
the routing table and the forwarding table. This ensures OSPFv3 fast convergence.
Pre-configuration Tasks
Before configuring OSPFv3 GR, configure basic OSPFv3 functions.
6.15.1 Enabling OSPFv3 GR
Context
Perform the following operations on the switch that runs OSPFv3.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ]
The OSPFv3 view is displayed.
Step 3 Run graceful-restart [ period
period | ack-time
time | retransmit-interval
interval | lsa-checking-ignore | planned-only ] *
OSPFv3 GR is enabled.
By default, OSPFv3 GR is disabled.
ack-time is optional. After ack-time is specified, the restarter can discover more
neighbors in the
ack-time period.
----End
6.15.2 Enabling the OSPFv3 GR Helper
Context
Perform the following operations on the switch that runs OSPFv3:
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 [
process-id ]
The OSPFv3 view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 433
Step 3 Run helper-role [ { ip-prefix
ip-prefix-name | acl-number
acl-number | acl-name
acl-name } | max-grace-period
period | planned-only | lsa-checking-ignore ] *
The OSPFv3 GR helper is enabled.
By default, the OSPFv3 GR helper is disabled.
----End
6.15.3 Verifying the OSPFv3 GR Configuration
Prerequisites
The configurations for the OSPFv3 GR are complete.
Procedure
● Run the display ospfv3 [
process-id ] graceful-restart-information
command to check the status of OSPFv3 GR.
----End
6.16 Improving OSPFv3 Network Security
Usage Scenario
If an OSPFv3 network requires high security, you can configure OSPFv3
generalized TTL security mechanism (GTSM) and an authentication mode to
improve network security.
● During network attacks, attackers may simulate OSPFv3 unicast packets and
continuously send them to the switch. If the packets are destined for the
switch, it directly forwards them to the control plane for processing without
validating them. As a result, the increased processing workload on the control
plane leads to high CPU usage. GTSM protects the switch against potential
attacks and improves system security by checking whether Hop Limit value in
each IP packet header is within a pre-defined range.
NOTE
OSPFv3 GTSM takes effect only on unicast packets and therefore applies to virtual
links and sham links.
● In OSPFv3 authentication, an authentication field is added to each OSPFv3
packet for encryption. When a local device receives an OSPFv3 packet from a
remote device, the local device discards the packet if the authentication
password carried in the packet is different from the local one, which protects
the local device against potential attacks. Therefore, OSPFv3 authentication
improves network security.
Pre-configuration Tasks
Before improving OSPFv3 network security, complete the following tasks:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 434
● Configure an IP address for each interface to ensure that neighboring routers
can use the IP addresses to communicate with each other.
● Configure basic OSPFv3 functions.
6.16.1 Configuring OSPFv3 GTSM
Context
GTSM only checks the TTL values of packets that match a GTSM policy. You can
configure a switch to allow mismatched packets to pass through the filter or be
discarded. If you configure the switch to discard mismatched packets, enable
GTSM on the switches with which the switch may communicate. Otherwise,
connections cannot be established, because the switch discards all packets from
non-GTSM switches.
In addition, you can configure the switch to log discarded packets. This facilitates
future fault locating.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 valid-ttl-hops
valid-ttl-hops-value [ vpn-instance
vpn-instance-
name ]
OSPFv3 GTSM is configured.
GTSM must be enabled at both ends of an OSPFv3 connection.
The ospfv3 valid-ttl-hops command both enables OSPFv3 GTSM and sets a TTL
value. If you specify the vpn-instance parameter, the switch sets only the TTL
values of packets in this VPN but does not enable OSPFv3. Therefore, if you want
to apply the configured TTL value only to packets in a VPN instance or a public
network instance, set the default action to pass for packets that does not match
the GTSM policy. This prevents OSPFv3 packets in other instances from being
discarded.
NOTE
The range of valid TTL value is from (255 –
valid-ttl-hops-value + 1) to 255.
Step 3 (Optional) Run gtsm default-action { drop | pass }
An action is configured for the switch to perform on the packets that do not
match the GTSM policy.
By default, pass is executed on these packets.
NOTE
If an action is configured but a GTSM policy is not, GTSM does not take effect.
Step 4 (Optional) Run gtsm log drop-packet all
The switch is configured to log the packets discarded on the switch.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 435
6.16.2 Configuring an Authentication Mode
Context
OSPFv3 supports keychain and HMAC-SHA256 authentication modes. The
following procedure uses keychain authentication as an example.
Before you configure keychain authentication, run the keychain command to
configure a keychain, the key-id command to configure a key ID, the key-string
command to configure a password, and the algorithm command to configure an
algorithm. If these commands are not run, OSPFv3 authentication will fail.
NOTICE
If plain is selected during the authentication mode configuration, the password is
saved in the configuration file in plain text. This is a security risk. It is
recommended that you select cipher to save the password in cipher text.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support the keychain
keychain-name parameter.
Procedure
● Configure OSPFv3 area authentication.
a. Run system-view
The system view is displayed.
b. Run ospfv3 [
process-id ]
The OSPFv3 process view is displayed.
c. Run area
area-id
The OSPFv3 area view is displayed.
d. Run authentication-mode { hmac-sha256 key-id
key-id { plain
plain-
text | [ cipher ]
cipher-text } | keychain
keychain-name }
OSPFv3 area authentication is configured.
NOTE
If you use OSPFv3 area authentication, the authentication and password
configurations on all switch in the same area must be the same.
● Configure OSPFv3 process authentication.
a. Run system-view
The system view is displayed.
b. Run ospfv3 [
process-id ]
The OSPFv3 process view is displayed.
c. Run authentication-mode { hmac-sha256 key-id
key-id { plain
plain-
text | [ cipher ]
cipher-text } | keychain
keychain-name }
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 436
OSPFv3 process authentication is configured.
● Configure OSPFv3 interface authentication.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run ospfv3 authentication-mode { hmac-sha256 key-id
key-id { plain
plain-text | [ cipher ]
cipher-text } | keychain
keychain-name [ instance
instance-id ] }
OSPFv3 interface authentication is configured.
OSPFv3 interface authentication takes precedence over OSPFv3 area
authentication.
If you use HMAC-SHA256 authentication, the authentication and
password configurations on all the interfaces on the same network
segment must be the same.
----End
6.16.3 Verifying the OSPFv3 Network Security Optimization
Configuration
Prerequisites
Improvements on OSPFv3 network security have been made.
Procedure
● Run the display gtsm statistics {
slot-id | all } command to check GTSM
statistics.
----End
6.17 Configuring OSPFv3 Neighbor Relationship
Flapping Suppression
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 437
Usage Scenario
If an interface carrying OSPFv3 services alternates between Up and Down, OSPFv3
neighbor relationship flapping occurs on the interface. During the flapping,
OSPFv3 frequently sends Hello packets to reestablish the neighbor relationship,
synchronizes LSDBs, and recalculates routes. In this process, a large number of
packets are exchanged, adversely affecting neighbor relationship stability, OSPFv3
services, and other OSPFv3-dependent services. OSPFv3 neighbor relationship
flapping suppression can address this problem by delaying OSPFv3 neighbor
relationship reestablishment or preventing service traffic from passing through
flapping links.
NOTE
The following steps are optional, choose them as required.
Pre-configuration Tasks
Before configuring OSPFv3 neighbor relationship flapping suppression, complete
the following tasks:
● Configure an IP address for each interface to ensure that neighboring routers
are reachable at the network layer.
● Configure basic OSPFv3 functions.
Procedure
Step 1 Run system-view
The system view is displayed.
By default, OSPFv3 neighbor relationship flapping suppression is enabled globally.
To disable this function globally, run the suppress-flapping peer disable
command.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
By default, OSPFv3 neighbor relationship flapping suppression is enabled on all
interfaces in the same OSPFv3 process. To disable the function from one of the
interfaces, run the ospfv3 suppress-flapping peer disable command.
Step 3 Run ospfv3 suppress-flapping peer hold-down
interval [ instance
instance-id ]
The Hold-down mode is configured, and its duration is set.
OSPFv3 neighbor flapping suppression works in either Hold-down or Hold-max-
cost mode.
● Hold-down mode: In the case of frequent flooding and topology changes
during neighbor relationship establishment, interfaces prevent neighbor
relationship reestablishment during Hold-down suppression, which minimizes
LSDB synchronization attempts and packet exchanges.
● Hold-max-cost mode: If the traffic forwarding path changes frequently,
interfaces use 65535 as the cost of the flapping link during Hold-max-cost
suppression, which prevents traffic from passing through the flapping link.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 438
Flapping suppression can also work first in Hold-down mode and then in Hold-
max-cost mode.
By default, the Hold-max-cost mode takes effect.
To disable the Hold-max-cost mode, run the ospfv3 suppress-flapping peer hold-
max-cost disable [ instance
instance-id ] command.
Step 4 Run ospfv3 suppress-flapping peer { detecting-interval
detecting-interval |
threshold
threshold | resume-interval
resume-interval } * [ instance
instance-id ]
Detection parameters are configured for OSPFv3 neighbor relationship flapping
suppression.
Each OSPFv3 interface on which OSPFv3 neighbor relationship flapping
suppression is enabled starts a flapping counter. If the interval between two
successive neighbor status changes from Full to a non-Full state is shorter than
detecting-interval, a valid flapping_event is recorded, and the flapping_count is
incremented by 1. When the flapping_count reaches or exceeds
threshold, flapping
suppression takes effect. If the interval between two successive neighbor status
changes from Full to a non-Full state is longer than
resume-interval, the
flapping_count is reset.
NOTE
The value of
resume-interval must be greater than that of
detecting-interval.
By default, the detection interval of OSPFv3 neighbor relationship flapping
suppression is 3s, the suppression threshold is 30, and the interval for exiting from
suppression is 10s. Using the default detection parameters is recommended.
Step 5 Run quit
The system view is displayed.
Step 6 Run quit
The user view is displayed.
Step 7 Run reset ospfv3
process-id suppress-flapping peer [
interface-type interface-
number [ instance
instance-id ] ]
Interfaces are forced to exit from OSPFv3 neighbor relationship flapping
suppression.
NOTE
Interfaces exit from flapping suppression in the following scenarios:
● The suppression timer expires.
● The corresponding OSPFv3 process is reset.
● An OSPFv3 neighbor is reset.
● OSPFv3 neighbor relationship flapping suppression is disabled globally using the
suppress-flapping peer disable command in the OSPFv3 view.
● The reset ospfv3 suppress-flapping peer command is run.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 439
Verifying the Configuration
Run the display ospfv3 [
process-id ] interface [ area
area-id ] [
interface-type
interface-number ] command to check the status of OSPFv3 neighbor relationship
flapping suppression.
<HUAWEI> display ospfv3 interface vlanif 100
VLANIF100 is up, line protocol is up
Interface ID 0x7
Interface MTU 1500
IPv6 Prefixes
FE80::2E0:74FF:FE00:8201 (Link-Local Address)
FC00:3::1/64
OSPFv3 Process (1), Area 0.0.0.0, Instance ID 0
Router ID 1.1.1.1, Network Type BROADCAST, Cost: 1
Transmit Delay is 1 sec, State Backup, Priority 1
Designated Router (ID) 4.4.4.4
Interface Address FE80::2E0:4FF:FE09:8201
Backup Designated Router (ID) 1.1.1.1
Interface Address FE80::2E0:74FF:FE00:8201
Timer interval configured, Hello 10, Dead 40, Wait 40, Retransmit 5
Hello due in 00:00:09
Neighbor Count is 1, Adjacent neighbor count is 1
Interface Event 3, Lsa Count 2, Lsa Checksum 0x15084
Interface Physical BandwidthHigh 0, BandwidthLow 100000000
Suppress flapping peer: enable(start: 2016-01-29 12:09:36-08:00, remain-interval: 500s)
Suppress flapping peer in the command output indicates the current suppression
mode (enable), time when the flapping suppression started, and the remaining
time of the flapping suppression.
6.18 Configuring OSPFv3 IPSec
Pre-configuration Tasks
Before configuring OSPFv3 IPSec, configure basic OSPFv3 functions.
6.18.1 Configuring an IPSec Session for Encryption
Context
Internet Protocol Security (IPSec) can be configured to prevent data theft and
spoofing during data transmission in a network.
A security association (SA) must be established so that IPSec can protect
transmitted data. An SA is a unidirectional logical connection set up for security
purpose and specifies the elements used by two IPSec peers (two parties that use
the IPSec protocol to protect data transmitted between them). The elements of an
SA include the following:
● Security protocol
● Authentication or encryption algorithm supported by the security protocol
● Data encapsulation mode
● Security parameter index (SPI) of the SA
● Authentication key or encryption key of the SA
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 440
The first three elements are specified in an IPSec proposal. To configure IPSec
functions, first configure an IPSec proposal on the IPSec peers, and then configure
an SA.
Procedure
Step 1 Configure an IPSec proposal.
1. Run system-view
The system view is displayed.
2. Run ipsec proposal
proposal-name
An IPSec proposal is created and the IPSec proposal view is displayed.
3. Run transform { ah | esp }
A security protocol is specified for the IPSec proposal.
By default, the security protocol used by an IPSec proposal is the
Encapsulation Security Protocol (ESP).
4. An authentication or encryption algorithm is configured.
– If AH is used, you can only configure the AH-specific authentication
algorithm because AH only authenticates packets.
Run the ah authentication-algorithm { sha1 | sha2-256 } command to
specify the authentication algorithm for the AH protocol.
By default, the AH protocol uses the Secure Hash Algorithm 2-256
(SHA2-256) authentication algorithm.
– When ESP is specified, ESP can encrypt/authenticate, or encrypt and
authenticate packets. Configure the ESP-specific authentication or
encryption algorithm.
▪ Run the esp authentication-algorithm { sha1 | sha2-256 }
command to specify the authentication algorithm for the ESP
protocol.
By default, the authentication algorithm SHA2-256 is used for ESP.
▪ Run the esp encryption-algorithm { 3des | aes [ 128 | 192 | 256 ] }
command to specify the encryption algorithm for the ESP protocol.
By default, the encryption algorithm Advanced Encryption
Standard-256 (AES-256) is used for ESP.
The SHA-1 and 3DES algorithm is not recommended because it cannot meet
your security defense requirements.
5. Run encapsulation-mode { transport | tunnel }
A data encapsulation mode is specified for the security protocol.
By default, the data encapsulation mode is tunnel.
NOTE
In transport mode, the packet encryption device and decryption device must be the
originator and receiver of packets.
6. Run quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 441
Return to the system view.
Step 2 Configure an IPSec SA.
1. Run ipsec sa
sa-name
An IPSec SA is created and the IPSec SA view is displayed.
By default, no IPSec SA exists in the system.
2. Run proposal
proposal-name
The IPSec proposal is bound to the IPSec SA.
By default, an IPSec policy does not reference any IPSec proposal.
NOTE
An IPSec can use only one IPSec proposal. To bind a new IPSec proposal to the IPSec
SA, delete the original IPSec proposal.
3. Run sa spi { inbound | outbound } { ah | esp }
spi-number
An SPI is configured for the SA.
NOTE
– An SPI uniquely identifies an SA. Each SA must be configured with an inbound SPI
and an outbound SPI. The outbound SPI on the local end must be the same as the
inbound SPI on the remote end.
– The security protocol (AH or ESP) you select when configuring the SPI must be the
same as that used in the IPSec proposal bound to the SA.
4. Configure a key according to the security protocol used in the IPSec proposal
bound to the SA.
– If the AH protocol is used, you can configure an authentication key that is
a hexadecimal number or a character string.
▪ Run the sa authentication-hex { inbound | outbound } ah
[ cipher ]
hex-cipher-key command to configure a hexadecimal
authentication key.
▪ Run the sa string-key { inbound | outbound } ah [ cipher ]
string-
cipher-key command to configure a character string as the
authentication key.
– If the ESP protocol is used, you can run one of the following commands
to configure the authentication key or the encryption key. You can also
configure both the authentication key and encryption key. If the two keys
are configured at the same time, they can only be hexadecimal keys.
▪ Run the sa authentication-hex { inbound | outbound } esp
[ cipher ]
hex-cipher-key command to configure a hexadecimal
authentication key.
▪ Run the sa string-key { inbound | outbound } esp [ cipher ]
string-
cipher-key command to configure a character string as the
authentication key.
▪ Run the sa encryption-hex { inbound | outbound } esp [ cipher ]
hex-cipher-key command to configure a hexadecimal encryption key.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 442
NOTE
– The security protocol (AH or ESP) you select when configuring the key must be the
same as that used in the IPSec proposal bound to the SA.
– The outbound key on the local end must be the same as the inbound key on the
remote end.
– The IPSec peers must use the authentication or encryption key in the same format.
For example, if the key on one end is a character string but the key on the other
end is a hexadecimal number, the IPSec tunnel cannot be set up.
– If you configure multiple keys in different formats, the last configured key takes
effect.
Step 3 Verify the configuration.
1. Run the display ipsec sa [ name
sa-name ] [ brief ] command to check
information about the SA.
2. Run the display ipsec proposal [ name
proposal-name ] command to check
information about the security proposal.
3. Run the display ipsec statistics [ sa-name
sa-name slot
slot-number ]
command to check statistics about packets processed by IPSec.
----End
6.18.2 Configuring OSPFv3 IPSec Authentication
Context
Perform the following operations on the switch that runs OSPFv3.
NOTE
To ensure device forwarding, configure OSPFv3 IPSec on all devices running OSPFv3.
Procedure
● Use an SA to authenticate packets in a specified OSPFv3 process.
a. Run system-view
The system view is displayed.
b. Run ospfv3 [
process-id ]
The OSPFv3 process view is displayed.
c. Run ipsec sa
sa-name
An SA is configured in the OSPFv3 process.
By default, no SA is configured in the OSPFv3 process.
An OSPFv3 process can be associated with multiple OSPFv3 areas. An SA
configured in an OSPFv3 process can be used in the associated areas.
● Use an SA to authenticate packets in a specified OSPFv3 area.
a. Run system-view
The system view is displayed.
b. Run ospfv3 [
process-id ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 443
The OSPFv3 process view is displayed.
c. Run area
area-id
The OSPFv3 area view is displayed.
d. Run ipsec sa
sa-name
An SA is configured in the OSPFv3 area.
By default, no SA is configured in the OSPFv3 area.
NOTE
The SA configured on an OSPFv3 area takes precedence over that configured in
an OSPFv3 process.
● Use an SA to authenticate packets sent and received by an interface.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run ospfv3 ipsec sa
sa-name
An SA is configured on the interface.
By default, no SA is configured on the OSPFv3 interface.
NOTE
The SA configured on an OSPFv3 interface takes precedence over that configured
in an OSPFv3 process or an OSPFv3 area.
● Use an SA to authenticate packets sent and received on a virtual link.
a. Run system-view
The system view is displayed.
b. Run ospfv3 [
process-id ]
The OSPFv3 process view is displayed.
c. Run area
area-id
The OSPFv3 area view is displayed.
d. Run vlink-peer
router-id ipsec sa
sa-name
An SA is configured on the virtual link.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 444
NOTE
The SA configured on a virtual link takes precedence over that configured in an
OSPFv3 process or OSPFv3 area 0.
● Use an SA to authenticate packets sent and received on a sham link.
a. Run system-view
The system view is displayed.
b. Run ospfv3 [
process-id ]
The OSPFv3 process view is displayed.
c. Run area
area-id
The OSPFv3 area view is displayed.
d. Run sham-link
source-address destination-address ipsec sa
sa-name
An SA is configured on the sham link.
NOTE
The SA configured on a sham link takes precedence over that configured in an
OSPFv3 process or OSPFv3 area 0.
----End
6.18.3 Verifying the OSPFv3 IPSec Configuration
Procedure
● Run the display ipsec proposal [ name
proposal-name ] command to check
IPSec proposal information.
● Run the display ipsec sa [ name
sa-name ] [ brief ] command to check
information about a Security Association (SA).
● Run the display ipsec statistics [ sa-name
sa-name slot
slot-number ]
command to check statistics about packets processed by IPSec.
● Run the display ospfv3 [
process-id ] command to check the SA applied in a
specified process.
● Run the display ospfv3 [
process-id ] interface command to check the SA
applied on a specified interface.
● Run the display ospfv3 [
process-id ] area [
area-id ] command to check the
SA applied in a specified area.
● Run the display ospfv3 [
process-id ] vlink command to check the SA applied
on the peer end of a virtual link.
● Run the display ospfv3 [
process-id ] sham-link command to check the SA
applied on the peer end of a sham link.
----End
6.19 Configuring the Network Management Function
of OSPFv3
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 445
Applicable Environment
OSPFv3 supports the network management function. You can bind OSPFv3 MIB
and a certain OSPFv3 process. In addition, OSPFv3 also supports the trap function
and the log function.
Pre-configuration Tasks
Before configuring the network management function of OSPFv3, configure basic
OSPFv3 functions.
6.19.1 Configuring OSPFv3 MIB Binding
Context
When multiple OSPFv3 processes are enabled, you can configure OSPFv3 MIB to
select the process to which it is bound.
Perform the following operations on the OSPFv3 switch.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ospfv3 mib-binding
process-id
OSPFv3 MIB binding OSPFv3 process is configured.
----End
6.19.2 Configuring OSPFv3 Trap
Context
Perform the following operations on the OSPFv3 switch.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run snmp-agent trap enable feature-name ospfv3 [ trap-name { ifconfigerror |
ifrxbadpacket | ifstatechange | nbrrestarthelperstatuschange | nbrstatechange
| nssatranslatorstatuschange | restartstatuschange | virtifconfigerror |
virtifrxbadpacket | virtifstatechange | virtnbrrestarthelperstatuschange |
virtnbrstatechange } ]
The trap function for the OSPFv3 module is enabled.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 446
6.19.3 Verifying the OSPFv3 Network Management Function
Configuration
Prerequisites
The configurations of the Network Management Function of OSPFv3 are
complete.
Procedure
● Run the display current-configuration command to check the configuration
currently validated on the switch.
----End
6.20 Resetting OSPFv3
Context
NOTICE
OSPFv3 adjacency relationships are removed when you reset OSPFv3 connections.
Exercise caution when running the reset ospfv3 command.
After modifying an OSPFv3 routing policy or protocol, reset the OSPFv3
connections to validate the modification.
Procedure
● To reset OSPFv3 connections and validate the new configuration, run the
following commands in the user view:
– reset ospfv3 {
process-id | all } [ graceful-restart [ extend-period
period ] ]
– reset ospfv3 {
process-id | all } counters [ neighbor [
interface-type
interface-number ] [
router-id ] ]
----End
6.21 Configuration Examples for OSPFv3
6.21.1 Example for Configuring an OSPFv3 Stub Area
Networking Requirements
In Figure 6-12, OSPFv3 is running among the three switches, and the entire
OSPFv3 network is divided into Area0 and Area1. SwitchA functions as an ABR and
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 447
connects to Area0 and Area1, and SwitchB functions as an ASBR and connects to
an OSPFv3 external network. The OSPFv3 routing table size of SwitchC needs to
be reduced without affecting communication.
Figure 6-12 Networking diagram for configuring an OSPFv3 area
Configuration Roadmap
1. Create VLANs, add interfaces to the VLANs, and assign IPv6 addresses to
VLANIF interfaces so that neighboring devices can communicate with each
other.
2. Configure basic OSPFv3 functions on SwitchA, SwitchB, and SwitchC to ensure
that there are reachable routes between OSPFv3 devices.
3. Configure a static route to the external network on SwitchB and import the
route into the OSPFv3 routing table to ensure that there are reachable routes
from the OSPFv3 network to the external network.
4. Configure Area1 as a stub area to reduce the OSPFv3 routing table size of
SwitchC.
5. Configure Area1 as a totally stub area. That is, prohibit SwitchA (an ABR) in
Area1 from advertising Type3 LSAs within Area1, which minimizing the
OSPFv3 routing table size of SwitchC.
Procedure
Step 1 Create VLANs and add interfaces to the VLANs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA, and are not mentioned here.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure IPv6 addresses for VLANIF interfaces to ensure that neighboring devices
can communicate with each other.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 448
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA, and are not mentioned here.
[SwitchA] ipv6
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ipv6 enable
[SwitchA-Vlanif10] ipv6 address fc00:0:0:1000::1/64
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ipv6 enable
[SwitchA-Vlanif20] ipv6 address fc00:0:0:1001::1/64
[SwitchA-Vlanif20] quit
Step 3 Configure basic OSPFv3 functions to ensure that there are reachable routes
between OSPFv3 devices.
# Configure SwitchA.
[SwitchA] ospfv3
[SwitchA-ospfv3-1] router-id 10.1.1.1
[SwitchA-ospfv3-1] quit
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ospfv3 1 area 0
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ospfv3 1 area 1
[SwitchA-Vlanif20] quit
# Configure SwitchB.
[SwitchB] ospfv3
[SwitchB-ospfv3-1] router-id 10.2.2.2
[SwitchB-ospfv3-1] quit
[SwitchB] interface vlanif 10
[SwitchB-Vlanif10] ospfv3 1 area 0
[SwitchB-Vlanif10] quit
# Configure SwitchC.
[SwitchC] ospfv3
[SwitchC-ospfv3-1] router-id 10.3.3.3
[SwitchC-ospfv3-1] quit
[SwitchC] interface vlanif 20
[SwitchC-Vlanif20] ospfv3 1 area 1
[SwitchC-Vlanif20] quit
# Check the OSPFv3 neighbor status of SwitchA. The following command output
shows that SwitchA has established an OSPFv3 neighbor relationship with SwitchB
and SwitchC.
[SwitchA] display ospfv3 peer
OSPFv3 Process (1)
OSPFv3 Area (0.0.0.0)
Neighbor ID Pri State Dead Time Interface Instance ID
10.2.2.2 1 Full/Backup 00:00:35 Vlanif10 0
OSPFv3 Area (0.0.0.1)
Neighbor ID Pri State Dead Time Interface Instance ID
10.3.3.3 1 Full/DR 00:00:31 Vlanif20 0
Step 4 Configure a static route to the external network on SwitchB and import the route
into the OSPFv3 routing table to ensure that there are reachable routes from the
OSPFv3 network to the external network.
[SwitchB] ipv6 route-static fc01::1 64 null 0
[SwitchB] ospfv3
[SwitchB-ospfv3-1] import-route static type 1
[SwitchB-ospfv3-1] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 449
#Check the OSPFv3 routing table of SwitchC. The following command output
shows that the OSPFv3 routing table contains an AS external route.
[SwitchC] display ospfv3 routing
Codes : E2 - Type 2 External, E1 - Type 1 External, IA - Inter-Area,
N - NSSA, U - Uninstalled, D - Denied by Import Policy
OSPFv3 Process (1)
Destination Metric
Next-hop
IA FC00:0:0:1000::/64 2
via FE80::4E1F:CCFF:FE43:5A9E, Vlanif20
FC00:0:0:1001::/64 1
directly connected, Vlanif20
E1 FC01::/64 3
via FE80::4E1F:CCFF:FE43:5A9E, Vlanif20
Step 5 Configure Area1 as a stub area to reduce the OSPFv3 routing table size of
SwitchC.
# Configure the stub area of SwitchA, and set the cost of the default route
advertised to the stub area to 10.
[SwitchA] ospfv3
[SwitchA-ospfv3-1] area 1
[SwitchA-ospfv3-1-area-0.0.0.1] stub
[SwitchA-ospfv3-1-area-0.0.0.1] default-cost 10
# Configure the stub area of SwitchC.
[SwitchC] ospfv3
[SwitchC-ospfv3-1] area 1
[SwitchC-ospfv3-1-area-0.0.0.1] stub
[SwitchC-ospfv3-1-area-0.0.0.1] quit
[SwitchC-ospfv3-1] quit
Step 6 Verify the configuration.
# View the OSPFv3 routing table of SwitchC. The following command output
shows that the AS external route on SwitchC is suppressed and there is a new
default route in the routing table. The cost of the default route is the sum of the
direct route cost and the configured cost.
[SwitchC] display ospfv3 routing
Codes : E2 - Type 2 External, E1 - Type 1 External, IA - Inter-Area,
N - NSSA, U - Uninstalled, D - Denied by Import Policy
OSPFv3 Process (1)
Destination Metric
Next-hop
IA ::/0 11
via FE80::4E1F:CCFF:FE43:5A9E, Vlanif20
IA FC00:0:0:1000::/64 2
via FE80::4E1F:CCFF:FE43:5A9E, Vlanif20
FC00:0:0:1001::/64 1
directly connected, Vlanif20
Step 7 Configure Area1 as a totally stub area. That is, prohibit SwitchA (an ABR) in Area1
from advertising Type3 LSAs within Area1, which minimizing the OSPFv3 routing
table size of SwitchC.
# On SwitchA, configure Area1 as a totally stub area.
[SwitchA-ospfv3-1-area-0.0.0.1] stub no-summary
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 450
Step 8 Verify the configuration.
# View the OSPFv3 routing table of SwitchC. The following command output
shows that the OSPFv3 routing table size of SwitchC is further reduced because
both the AS external route and inter-area route are suppressed.
[SwitchC] display ospfv3 routing
Codes : E2 - Type 2 External, E1 - Type 1 External, IA - Inter-Area,
N - NSSA, U - Uninstalled, D - Denied by Import Policy
OSPFv3 Process (1)
Destination Metric
Next-hop
IA ::/0 11
via FE80::4E1F:CCFF:FE43:5A9E, Vlanif20
FC00:0:0:1001::/64 1
directly connected, Vlanif20
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
vlan batch 10 20
#
ospfv3 1
router-id 10.1.1.1
area 0.0.0.1
stub no-summary
default-cost 10
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:1000::1/64
ospfv3 1 area 0.0.0.0
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:1001::1/64
ospfv3 1 area 0.0.0.1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
return
● SwitchB configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 10
#
ospfv3 1
router-id 10.2.2.2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 451
import-route static type 1
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:1000::2/64
ospfv3 1 area 0.0.0.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 20
#
ospfv3 1
router-id 10.3.3.3
area 0.0.0.1
stub
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:1001::2/64
ospfv3 1 area 0.0.0.1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
return
6.21.2 Example for Configuring DR Election Through OSPFv3
Networking Requirements
On the network shown in Figure 6-13, SwitchA has the highest priority (100) on
the network and is elected as the DR. SwitchC has the second highest priority and
is elected as the BDR. SwitchB has the priority of 0 and cannot be elected as a DR.
SwitchD uses the default priority (1).
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 452
Figure 6-13 Networking diagram for configuring DR election through OSPFv3
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IPv6 addresses for interfaces.
2. Configure a router ID for each switch, enable OSPFv3, and specify the
network segments.
3. Check the DR and BDR status of each switch when the default priority is used.
4. Set a DR priority for the interface on each switch and check whether the
switch has become the DR or BDR.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. Ensure that the configurations of Switch, SwitchB, SwitchC,
and SwitchD are the same as that of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan 10
[SwitchA-vlan10] quit
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign IPv6 addresses to the VLANIF interfaces.
# Configure SwitchA. Ensure that the configurations of SwitchB, SwitchC, and
SwitchD are the same as that of SwitchA.
[SwitchA] ipv6
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ipv6 enable
[SwitchA-Vlanif10] ipv6 address fc00:0:0:1001::1/64
[SwitchA-Vlanif10] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 453
Step 3 Configure the basic OSPFv3 functions.
# On SwitchA, enable OSPFv3 and set the router ID to 10.1.1.1.
[SwitchA] ospfv3
[SwitchA-ospfv3-1] router-id 10.1.1.1
[SwitchA-ospfv3-1] quit
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ospfv3 1 area 0
[SwitchA-Vlanif10] quit
# On SwitchB, enable OSPFv3 and set the router ID to 10.2.2.2.
[SwitchB] ospfv3
[SwitchB-ospfv3-1] router-id 10.2.2.2
[SwitchB-ospfv3-1] quit
[SwitchB] interface vlanif 10
[SwitchB-Vlanif10] ospfv3 1 area 0
[SwitchB-Vlanif10] quit
# On SwitchC, enable OSPFv3 and set the router ID to 10.3.3.3.
[SwitchC] ospfv3
[SwitchC-ospfv3-1] router-id 10.3.3.3
[SwitchC-ospfv3-1] quit
[SwitchC] interface vlanif 10
[SwitchC-Vlanif10] ospfv3 1 area 0
[SwitchC-Vlanif10] quit
# On SwitchD, enable OSPFv3 and set the router ID to 10.4.4.4.
[SwitchD] ospfv3
[SwitchD-ospfv3-1] router-id 10.4.4.4
[SwitchD-ospfv3-1] quit
[SwitchD] interface vlanif 10
[SwitchD-Vlanif10] ospfv3 1 area 0
[SwitchD-Vlanif10] quit
Check the neighbor information of SwitchA. The command output shows that all
the neighbors have the same default priority 1 and that SwitchD functions as the
DR and SwitchC as the BDR.
NOTE
When two Switches have the same priority, the Switch that has a larger router ID is elected
as the DR. If the VLANIF interface of a Switch becomes the DR, the other broadcast
interfaces of this Switch have a high priority in the future DR election. This means that the
Switch still functions as the DR, and the DR cannot be preempted.
[SwitchA] display ospfv3 peer
OSPFv3 Process (1)
OSPFv3 Area (0.0.0.0)
Neighbor ID Pri State Dead Time Interface Instance ID
10.2.2.2 1 Full/DROther 00:00:32 Vlanif10 0
10.3.3.3 1 Full/Backup 00:00:36 Vlanif10 0
10.4.4.4 1 Full/DR 00:00:38 Vlanif10 0
# Check the neighbor information of SwitchD. The command output shows that
the status of the neighbor relationship between SwitchD and other devices is Full.
[SwitchD] display ospfv3 peer
OSPFv3 Process (1)
OSPFv3 Area (0.0.0.0)
Neighbor ID Pri State Dead Time Interface Instance ID
10.1.1.1 1 Full/DROther 00:00:32 Vlanif10 0
10.2.2.2 1 Full/DROther 00:00:35 Vlanif10 0
10.3.3.3 1 Full/Backup 00:00:30 Vlanif10 0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 454
Step 4 Set DR priorities for interfaces.
# Set the DR priority of SwitchA to 100.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ospfv3 dr-priority 100
[SwitchA-Vlanif10] quit
# Set the DR priority of SwitchB to 0.
[SwitchB] interface vlanif 10
[SwitchB-Vlanif10] ospfv3 dr-priority 0
[SwitchB-Vlanif10] quit
# Set the DR priority of SwitchC to 2.
[SwitchC] interface vlanif 10
[SwitchC-Vlanif10] ospfv3 dr-priority 2
[SwitchC-Vlanif10] quit
# Check the neighbor information of SwitchA. The command output shows that
the DR priorities of SwitchA's neighbors have been updated but the DR and BDR
are unchanged.
[SwitchA] display ospfv3 peer
OSPFv3 Process (1)
OSPFv3 Area (0.0.0.0)
Neighbor ID Pri State Dead Time Interface Instance ID
10.2.2.2 0 Full/DROther 00:00:34 Vlanif10 0
10.3.3.3 2 Full/Backup 00:00:38 Vlanif10 0
10.4.4.4 1 Full/DR 00:00:31 Vlanif10 0
# Check the neighbor information of SwitchD. The command output shows that
the DR priorities of SwitchD's neighbors have been updated.
[SwitchD] display ospfv3 peer
OSPFv3 Process (1)
OSPFv3 Area (0.0.0.0)
Neighbor ID Pri State Dead Time Interface Instance ID
10.1.1.1 100 Full/DROther 00:00:36 Vlanif10 0
10.2.2.2 0 Full/DROther 00:00:30 Vlanif10 0
10.3.3.3 2 Full/Backup 00:00:36 Vlanif10 0
Step 5 Perform DR and BDR election again.
# Run the shutdown and undo shutdown commands on the VLANIF interface
that establishes the OSPFv3 neighbor relationship.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] shutdown
[SwitchA-Vlanif10] undo shutdown
[SwitchA-Vlanif10] quit
[SwitchB] interface vlanif 10
[SwitchB-Vlanif10] shutdown
[SwitchB-Vlanif10] undo shutdown
[SwitchB-Vlanif10] quit
[SwitchC] interface vlanif 10
[SwitchC-Vlanif10] shutdown
[SwitchC-Vlanif10] undo shutdown
[SwitchC-Vlanif10] quit
[SwitchD] interface vlanif 10
[SwitchD-Vlanif10] shutdown
[SwitchD-Vlanif10] undo shutdown
[SwitchD-Vlanif10] quit
Step 6 Verify the configuration.
# Check the neighbors of SwitchA. The command output shows that SwitchC is
now the BDR.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 455
[SwitchA] display ospfv3 peer
OSPFv3 Process (1)
OSPFv3 Area (0.0.0.0)
Neighbor ID Pri State Dead Time Interface Instance ID
10.2.2.2 0 Full/DROther 00:00:31 Vlanif10 0
10.3.3.3 2 Full/Backup 00:00:36 Vlanif10 0
10.4.4.4 1 Full/DROther 00:00:39 Vlanif10 0
# Check the neighbors of SwitchD. The command output shows that SwitchA is
now the DR.
[SwitchD] display ospfv3 peer
OSPFv3 Process (1)
OSPFv3 Area (0.0.0.0)
Neighbor ID Pri State Dead Time Interface Instance ID
10.1.1.1 100 Full/DR 00:00:39 Vlanif10 0
10.2.2.2 0 2-Way/DROther 00:00:35 Vlanif10 0
10.3.3.3 2 Full/Backup 00:00:39 Vlanif10 0
----End
Configuration Files
● Switch configuration file
#
sysname Switch
#
vlan batch 10
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/4
port link-type trunk
port trunk allow-pass vlan 10
#
return
● Switch configuration file
#
sysname SwitchA
#
ipv6
#
vlan batch 10
#
ospfv3 1
router-id 10.1.1.1
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:1001::1/64
ospfv3 1 area 0.0.0.0
ospfv3 dr-priority 100
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 456
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
vlan batch 10
#
ospfv3 1
router-id 10.2.2.2
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:1001::2/64
ospfv3 1 area 0.0.0.0
ospfv3 dr-priority 0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 10
#
ospfv3 1
router-id 10.3.3.3
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:1001::3/64
ospfv3 1 area 0.0.0.0
ospfv3 dr-priority 2
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchD configuration file
#
sysname SwitchD
#
ipv6
#
vlan batch 10
#
ospfv3 1
router-id 10.4.4.4
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:1001::4/64
ospfv3 1 area 0.0.0.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 457
6.21.3 Example for Configuring an OSPFv3 Virtual Link
Networking Requirements
In Figure 6-14, OSPFv3 is enabled on all Switches, and the AS is divided into three
areas. SwitchB and SwitchC serve as ABRs to forward inter-area routes. Area 2 is
not directly connected to the Area 0, the backbone area. Area 1 is the area
between Area 0 and Area 2.
Configure a virtual link in Area 1 where SwitchB and SwitchC are located so that
SwitchA and SwitchD can communicate with each other.
Figure 6-14 Networking diagram for configuring an OSPFv3 virtual link
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IPv6 addresses for interfaces.
2. Enable basic OSPFv3 functions on each switch.
3. Configure a virtual link between SwitchB and SwitchC to connect the non-
backbone areas to the backbone area.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. Ensure that the configurations of SwitchB, SwitchC, and
SwitchD are the same as that of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign IPv6 addresses to the VLANIF interfaces.
# Configure SwitchA. Ensure that the configurations of SwitchB, SwitchC, and
SwitchD are the same as that of SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 458
[SwitchA] ipv6
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ipv6 enable
[SwitchA-Vlanif10] ipv6 address fc00:0:0:1001::2/64
[SwitchA-Vlanif10] quit
Step 3 Configure basic OSPFv3 functions.
# On SwitchA, enable OSPFv3 and set the router ID to 10.1.1.1.
[SwitchA] ospfv3
[SwitchA-ospfv3-1] router-id 10.1.1.1
[SwitchA-ospfv3-1] quit
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ospfv3 1 area 2
[SwitchA-Vlanif10] quit
# On SwitchB, enable OSPFv3 and set the router ID to 10.2.2.2.
[SwitchB] ospfv3
[SwitchB-ospfv3-1] router-id 10.2.2.2
[SwitchB-ospfv3-1] quit
[SwitchB] interface vlanif 10
[SwitchB-Vlanif10] ospfv3 1 area 2
[SwitchB-Vlanif10] quit
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] ospfv3 1 area 1
[SwitchB-Vlanif20] quit
# On SwitchC, enable OSPFv3 and set the router ID to 10.3.3.3.
[SwitchC] ospfv3
[SwitchC-ospfv3-1] router-id 10.3.3.3
[SwitchC-ospfv3-1] quit
[SwitchC] interface vlanif 20
[SwitchC-Vlanif20] ospfv3 1 area 1
[SwitchC-Vlanif20] quit
[SwitchC] interface vlanif 30
[SwitchC-Vlanif30] ospfv3 1 area 0
[SwitchC-Vlanif30] quit
# On SwitchD, enable OSPFv3 and set the router ID to 10.4.4.4.
[SwitchD] ospfv3
[SwitchD-ospfv3-1] router-id 10.4.4.4
[SwitchD-ospfv3-1] quit
[SwitchD] interface vlanif 30
[SwitchD-Vlanif30] ospfv3 1 area 0
[SwitchD-Vlanif30] quit
# Check the OSPFv3 routing table of SwitchC. The command output shows that
the routing table of SwitchC does not contain the routes of Area 2. This is because
Area 2 is not directly connected to Area 0.
[SwitchC] display ospfv3 routing
Codes : E2 - Type 2 External, E1 - Type 1 External, IA - Inter-Area,
N - NSSA, U - Uninstalled, D - Denied by Import Policy
OSPFv3 Process (1)
Destination Metric
Next-hop
FC00:0:0:1000::/64 1
directly connected, Vlanif20
FC00:0:0:1002::/64 1
directly connected, Vlanif30
Step 4 Configure a virtual link in Area 1 where SwitchB and SwitchC are located.
# Configure SwitchB.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 459
[SwitchB] ospfv3
[SwitchB-ospfv3-1] area 1
[SwitchB-ospfv3-1-area-0.0.0.1] vlink-peer 10.3.3.3
[SwitchB-ospfv3-1-area-0.0.0.1] return
# Configure SwitchC.
[SwitchC] ospfv3
[SwitchC-ospfv3-1] area 1
[SwitchC-ospfv3-1-area-0.0.0.1] vlink-peer 10.2.2.2
[SwitchC-ospfv3-1-area-0.0.0.1] return
Step 5 Verify the configuration.
# Check the OSPFv3 routing table of SwitchC.
<SwitchC> display ospfv3 routing
Codes : E2 - Type 2 External, E1 - Type 1 External, IA - Inter-Area,
N - NSSA, U - Uninstalled, D - Denied by Import Policy
OSPFv3 Process (1)
Destination Metric
Next-hop
FC00:0:0:1000::/64 1
directly connected, Vlanif20
FC00:0:0:1000::1/128 1
via FE80::4D67:0:EB7D:2, Vlanif20
FC00:0:0:1000::2/128 0
directly connected, Vlanif20
IA FC00:0:0:1001::/64 2
via FE80::4D67:0:EB7D:2, Vlanif20
FC00:0:0:1002::/64 1
directly connected, Vlanif30
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
vlan batch 10
#
ospfv3 1
router-id 10.1.1.1
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:1001::2/64
ospfv3 1 area 0.0.0.2
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
vlan batch 10 20
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 460
#
ospfv3 1
router-id 10.2.2.2
area 0.0.0.1
vlink-peer 10.3.3.3
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:1001::1/64
ospfv3 1 area 0.0.0.2
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:1000::1/64
ospfv3 1 area 0.0.0.1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 20 30
#
ospfv3 1
router-id 10.3.3.3
area 0.0.0.1
vlink-peer 10.2.2.2
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:1000::2/64
ospfv3 1 area 0.0.0.1
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:1002::1/64
ospfv3 1 area 0.0.0.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
return
● SwitchD configuration file
#
sysname SwitchD
#
ipv6
#
vlan batch 30
#
ospfv3 1
router-id 10.4.4.4
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 461
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:1002::2/64
ospfv3 1 area 0.0.0.0
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
return
6.21.4 Example for Configuring OSPFv3 GR
Networking Requirements
In Figure 6-15, SwitchA, SwitchB, and SwitchC belong to the same OSPFv3 area.
They communicate with each other through the OSPFv3 protocol and are enabled
with GR.
When OSPFv3 adjacencies are set up between SwitchA, SwitchC, and SwitchB, the
three switches exchange routing information. If the OSPFv3 protocol restarts on
SwitchA, SwitchA synchronizes data with neighboring switches through GR.
Figure 6-15 Networking diagram for configuring OSPFv3 GR
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IPv6 addresses for interfaces.
2. Enable basic OSPFv3 functions on each switch.
3. Enable the OSPFv3 GR helper in the OSPFv3 view of SwitchB.
4. Enable the OSPFv3 GR in the OSPFv3 view of SwitchA.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. Ensure that the configurations of SwitchB and SwitchC are
the same as that of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan 10
[SwitchA-vlan10] quit
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 462
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign IPv6 addresses to the VLANIF interfaces.
# Configure SwitchA. Ensure that the configurations of SwitchB and SwitchC are
the same as that of SwitchA.
[SwitchA] ipv6
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ipv6 enable
[SwitchA-Vlanif10] ipv6 address fc00:0:0:1000::1/64
[SwitchA-Vlanif10] quit
Step 3 Configure basic OSPFv3 functions.
# On SwitchA, enable OSPFv3 and set the router ID to 10.1.1.1.
[SwitchA] ospfv3 100
[SwitchA-ospfv3-100] router-id 10.1.1.1
[SwitchA-ospfv3-100] quit
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ospfv3 100 area 0
[SwitchA-Vlanif10] quit
# On SwitchB, enable OSPFv3 and set the router ID to 10.2.2.2.
[SwitchB] ospfv3 100
[SwitchB-ospfv3-100] router-id 10.2.2.2
[SwitchB-ospfv3-100] quit
[SwitchB] interface vlanif 10
[SwitchB-Vlanif10] ospfv3 100 area 0
[SwitchB-Vlanif10] quit
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] ospfv3 100 area 0
[SwitchB-Vlanif20] quit
# On SwitchC, enable OSPFv3 and set the router ID to 10.3.3.3.
[SwitchC] ospfv3 100
[SwitchC-ospfv3-100] router-id 10.3.3.3
[SwitchC-ospfv3-100] quit
[SwitchC] interface vlanif 20
[SwitchC-Vlanif20] ospfv3 100 area 0
[SwitchC-Vlanif20] quit
Step 4 Enable OSPFv3 GR on SwitchA.
[SwitchA] ospfv3 100
[SwitchA-ospfv3-100] graceful-restart
[SwitchA-ospfv3-100] return
Step 5 Enable OSPFv3 helper on SwitchB.
[SwitchB] ospfv3 100
[SwitchB-ospfv3-100] helper-role
[SwitchB-ospfv3-100] return
Step 6 Verify the configuration.
# Run the display ipv6 fib command on SwitchA to view the FIB information.
<SwitchA> display ipv6 fib
IPv6 FIB Table:
Total number of Routes : 5
Destination: ::1 PrefixLength: 128
Nexthop : ::1 Flag : HU
Interface : InLoopBack0 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 463
Destination: FE80:: PrefixLength: 10
Nexthop : :: Flag : BU
Interface : NULL0 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
Destination: FC00:0:0:1000::1 PrefixLength: 128
Nexthop : ::1 Flag : HU
Interface : InLoopBack0 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
Destination: FC00:0:0:1000:: PrefixLength: 64
Nexthop : FC00:0:0:1000::1 Flag : U
Interface : Vlanif10 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
Destination: FC00:0:0:2000:: PrefixLength: 64
Nexthop : FE80::200:1FF:FE00:200 Flag : DGU
Interface : Vlanif10 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
# Restart OSPFv3 process 100 on SwitchA without using the GR mechanism.
<SwitchA> reset ospfv3 100
# Immediately run the display ipv6 fib command on SwitchA to view the FIB
information.
<SwitchA> display ipv6 fib
IPv6 FIB Table:
Total number of Routes : 4
Destination: ::1 PrefixLength: 128
Nexthop : ::1 Flag : HU
Interface : InLoopBack0 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
Destination: FE80:: PrefixLength: 10
Nexthop : :: Flag : BU
Interface : NULL0 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
Destination: FC00:0:0:1000::1 PrefixLength: 128
Nexthop : ::1 Flag : HU
Interface : InLoopBack0 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
Destination: FC00:0:0:1000:: PrefixLength: 64
Nexthop : FC00:0:0:1000::1 Flag : U
Interface : Vlanif10 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
This information shows that the FIB information on SwitchA has been modified
and the forwarding service is affected.
# Restart OSPFv3 process 100 on SwitchA using the GR mechanism.
<SwitchA> reset ospfv3 100 graceful-restart
# Immediately run the display ipv6 fib command on SwitchA to view the FIB
information. Check whether GR is functioning normally. If so, the FIB information
is not modified and the forwarding is not affected when you restart the OSPFv3
process using GR on SwitchA.
<SwitchA> display ipv6 fib
IPv6 FIB Table:
Total number of Routes : 5
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 464
Destination: ::1 PrefixLength: 128
Nexthop : ::1 Flag : HU
Interface : InLoopBack0 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
Destination: FE80:: PrefixLength: 10
Nexthop : :: Flag : BU
Interface : NULL0 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
Destination: FC00:0:0:1000::1 PrefixLength: 128
Nexthop : ::1 Flag : HU
Interface : InLoopBack0 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
Destination: FC00:0:0:1000:: PrefixLength: 64
Nexthop : FC00:0:0:1000::1 Flag : U
Interface : Vlanif10 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
Destination: FC00:0:0:2000:: PrefixLength: 64
Nexthop : FE80::200:1FF:FE00:200 Flag : DGU
Interface : Vlanif10 Tunnel ID : 0x0
TimeStamp : 2007-06-25 17:31:46
This information shows that the FIB information on SwitchA has not been
modified and the forwarding is not affected.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
vlan batch 10
#
ospfv3 100
router-id 10.1.1.1
graceful-restart
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:1000::1/64
ospfv3 100 area 0.0.0.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
vlan batch 10 20
#
ospfv3 100
router-id 10.2.2.2
helper-role
#
interface Vlanif10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 465
ipv6 enable
ipv6 address FC00:0:0:1000::2/64
ospfv3 100 area 0.0.0.0
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:2000::1/64
ospfv3 100 area 0.0.0.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 20
#
ospfv3 100
router-id 10.3.3.3
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:2000::2/64
ospfv3 100 area 0.0.0.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
return
6.21.5 Example for Configuring BFD for OSPFv3
Networking Requirements
In Figure 6-16, OSPFv3 is run among SwitchA, SwitchB, and SwitchC. Service
traffic is forwarded along the primary link SwitchA→SwitchB. The link
SwitchA→SwitchC→SwitchB is used as a backup. Customers require that service
traffic be fast switched to the backup link if the primary link fails.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 466
Figure 6-16 Networking diagram for configuring BFD for OSPFv3
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic OSPFv3 functions on each switch to make the primary link
transmit service traffic properly.
2. Configure OSPFv3 BFD so that traffic can be fast switched to the backup link
if the primary link fails.
Procedure
Step 1 Configure IPv6 addresses for interfaces of all switches.
# Configure SwitchA. Ensure that the configurations of SwitchB and SwitchC are
the same as that of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] ipv6
[SwitchA] interface GigabitEthernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] undo portswitch
[SwitchA-GigabitEthernet0/0/1] ipv6 enable
[SwitchA-GigabitEthernet0/0/1] ipv6 address FC00:3::1 64
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface GigabitEthernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] undo portswitch
[SwitchA-GigabitEthernet0/0/2] ipv6 enable
[SwitchA-GigabitEthernet0/0/2] ipv6 address FC00:1::1 64
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure basic OSPFv3 functions.
# Configure SwitchA.
[SwitchA] ospfv3
[SwitchA-ospfv3-1] router-id 10.1.1.1
[SwitchA-ospfv3-1] quit
[SwitchA] interface GigabitEthernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] ospfv3 1 area 0.0.0.0
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface GigabitEthernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] ospfv3 1 area 0.0.0.0
[SwitchA-GigabitEthernet0/0/2] quit
# Configure SwitchB.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 467
[SwitchB] ospfv3
[SwitchB-ospfv3-1] router-id 10.2.2.2
[SwitchB-ospfv3-1] quit
[SwitchB] interface GigabitEthernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] ospfv3 1 area 0.0.0.0
[SwitchB-GigabitEthernet0/0/1] quit
[SwitchB] interface GigabitEthernet 0/0/2
[SwitchB-GigabitEthernet0/0/2] ospfv3 1 area 0.0.0.0
[SwitchB-GigabitEthernet0/0/2] quit
[SwitchB] interface GigabitEthernet 0/0/3
[SwitchB-GigabitEthernet0/0/3] ospfv3 1 area 0.0.0.0
[SwitchB-GigabitEthernet0/0/3] quit
# Configure SwitchC.
[SwitchC] ospfv3
[SwitchC-ospfv3-1] router-id 10.3.3.3
[SwitchC-ospfv3-1] quit
[SwitchC] interface GigabitEthernet 0/0/1
[SwitchC-GigabitEthernet0/0/1] ospfv3 1 area 0.0.0.0
[SwitchC-GigabitEthernet0/0/1] quit
[SwitchC] interface GigabitEthernet 0/0/2
[SwitchC-GigabitEthernet0/0/2] ospfv3 1 area 0.0.0.0
[SwitchC-GigabitEthernet0/0/2] quit
# After the preceding configurations are complete, run the display ospfv3 peer
command. The following example uses the command output on SwitchA. The
command output shows that neighbor relationships are established between
SwitchA and SwitchB, and between SwitchB and SwitchC.
[SwitchA] display ospfv3 peer verbose
OSPFv3 Process (1)
Neighbor 10.3.3.3 is Full, interface address FE80::225:9EFF:FEFB:BFF1
In the area 0.0.0.0 via interface GE0/0/2
DR Priority is 1 DR is 10.1.1.1 BDR is 10.3.3.3
Options is 0x000013 (-|-|-|-|-|-|R|-|-|E|V6)
Dead timer due in 00:00:31
Neighbour is up for 00:13:24
Database Summary Packets List 0
Link State Request List 0
Link State Retransmission List 0
Neighbour Event: 5
Neighbour If Id : 0xd0
Neighbor 10.2.2.2 is Full, interface address FE80::201:FF:FE01:1
In the area 0.0.0.0 via interface GE0/0/1
DR Priority is 1 DR is 10.1.1.1 BDR is 10.2.2.2
Options is 0x000013 (-|-|-|-|-|-|R|-|-|E|V6)
Dead timer due in 00:00:38
Neighbour is up for 00:13:38
Database Summary Packets List 0
Link State Request List 0
Link State Retransmission List 0
Neighbour Event: 5
Neighbour If Id : 0x28
# Check information about the OSPFv3 routing table on SwitchA. The command
output shows the routing entries to SwitchB and SwitchC.
[SwitchA] display ospfv3 routing
Codes : E2 - Type 2 External, E1 - Type 1 External, IA - Inter-Area,
N - NSSA, U - Uninstalled, D - Denied by Import Policy
OSPFv3 Process (1)
Destination Metric
Next-hop
FC00:1::/64 1
directly connected, GigabitEthernet0/0/2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 468
FC00:2::/64 2
via FE80::225:9EFF:FEFB:BFF1, GigabitEthernet0/0/2
via FE80::201:FF:FE01:1, GigabitEthernet0/0/1
FC00:3::/64 1
directly connected, GigabitEthernet0/0/1
FC00:4::/64 2
via FE80::201:FF:FE01:1, GigabitEthernet0/0/1
In the OSPFv3 routing table, the next hop of the route to FC00:4::1/64 is GE0/0/1,
and traffic is transmitted along the primary link SwitchA→SwitchB.
Step 3 Configure OSPFv3 BFD.
# Configure BFD for OSPFv3 on SwitchA.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] ospfv3
[SwitchA-ospfv3-1] bfd all-interfaces enable
[SwitchA-ospfv3-1] bfd all-interfaces min-transmit-interval 100 min-receive-interval 100 detect-
multiplier 4
[SwitchA-ospfv3-1] quit
# Configure BFD for OSPFv3 on SwitchB.
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] ospfv3
[SwitchB-ospfv3-1] bfd all-interfaces enable
[SwitchB-ospfv3-1] bfd all-interfaces min-transmit-interval 100 min-receive-interval 100 detect-
multiplier 4
[SwitchB-ospfv3-1] quit
# Configure BFD for OSPFv3 on SwitchC.
[SwitchC] bfd
[SwitchC-bfd] quit
[SwitchC] ospfv3
[SwitchC-ospfv3-1] bfd all-interfaces enable
[SwitchC-ospfv3-1] bfd all-interfaces min-transmit-interval 100 min-receive-interval 100 detect-
multiplier 4
[SwitchC-ospfv3-1] quit
After the preceding configurations are complete, run the display ospfv3 bfd
session command on SwitchA or SwitchB.
The following example uses the command output on SwitchB as an example. The
command output shows that the status of the BFD session is Up.
[SwitchB] display ospfv3 bfd session verbose
* - STALE
OSPFv3 Process (1)
Neighbor-Id: 10.3.3.3
BFD Status: Up
Interface: GE0/0/2
IPv6-Local-Address: FE80::201:FF:FE01:1
IPv6-Remote-Address: FE80::225:9EFF:FEFB:BFF1
BFD Module preferred timer values
Transmit-Interval(ms): 100
Receive-Interval(ms): 100
Detect-Multiplier: 4
OSPFv3 Module preferred timer values
Transmit-Interval(ms): 100
Receive-Interval(ms): 100
Detect-Multiplier: 4
Configured timer values
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 469
Transmit-Interval(ms): 100
Receive-Interval(ms): 100
Detect-Multiplier: 4
Neighbor-Id: 10.1.1.1
BFD Status: Up
Interface: GE0/0/1
IPv6-Local-Address: FE80::201:FF:FE01:1
IPv6-Remote-Address: FE80::200:13FF:FE82:4569
BFD Module preferred timer values
Transmit-Interval(ms): 100
Receive-Interval(ms): 100
Detect-Multiplier: 4
OSPFv3 Module preferred timer values
Transmit-Interval(ms): 100
Receive-Interval(ms): 100
Detect-Multiplier: 4
Configured timer values
Transmit-Interval(ms): 100
Receive-Interval(ms): 100
Detect-Multiplier: 4
Step 4 Verify the configuration.
# Run the shutdown command on GE0/0/1 of SwitchB to simulate a primary link
fault.
[SwitchB] interface GigabitEthernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] shutdown
# Check the routing table on SwitchA. In the routing table, the backup link
SwitchA-SwitchC-SwitchB transmits traffic after the primary link fails, and the next
hop of the route to FC00:4::1/64 becomes GE0/0/2.
[SwitchA] display ospfv3 routing
Codes : E2 - Type 2 External, E1 - Type 1 External, IA - Inter-Area,
N - NSSA, U - Uninstalled, D - Denied by Import Policy
OSPFv3 Process (1)
Destination Metric
Next-hop
FC00:1::/64 1
directly connected, GigabitEthernet0/0/2
FC00:2::/64 2
via FE80::225:9EFF:FEFB:BFF1, GigabitEthernet0/0/2
FC00:4::/64 3
via FE80::225:9EFF:FEFB:BFF1, GigabitEthernet0/0/2
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
bfd
#
ospfv3 1
router-id 10.1.1.1
bfd all-interfaces enable
bfd all-interfaces min-transmit-interval 100 min-receive-interval 100 detect-multiplier 4
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 470
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:3::1/64
ospfv3 1 area 0.0.0.0
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:1::1/64
ospfv3 1 area 0.0.0.0
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
bfd
#
ospfv3 1
router-id 10.2.2.2
bfd all-interfaces enable
bfd all-interfaces min-transmit-interval 100 min-receive-interval 100 detect-multiplier 4
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:3::2/64
ospfv3 1 area 0.0.0.0
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:2::2/64
ospfv3 1 area 0.0.0.0
#
interface GigabitEthernet0/0/3
undo portswitch
ipv6 enable
ipv6 address FC00:4::1/64
ospfv3 1 area 0.0.0.0
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
bfd
#
ospfv3 1
router-id 10.3.3.3
bfd all-interfaces enable
bfd all-interfaces min-transmit-interval 100 min-receive-interval 100 detect-multiplier 4
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:2::1/64
ospfv3 1 area 0.0.0.0
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:1::2/64
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 471
ospfv3 1 area 0.0.0.0
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 6 OSPFv3 Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 472
7 IPv4 IS-IS Configuration
7.1 Overview of IS-IS
7.2 Understanding IS-IS
7.3 Default Settings for IPv4 IS-IS
7.4 Summary of IPv4 IS-IS Configuration Tasks
7.5 Licensing Requirements and Limitations for IPv4 IS-IS
7.6 Configure Basic IS-IS Functions
7.7 Improving IS-IS Network Security
7.8 Controlling IS-IS Route Selection
7.9 Controlling IS-IS Route Exchange
7.10 Configuring IS-IS Route Summarization
7.11 Controlling IS-IS Route Convergence
7.12 Configuring LSP Fragment Extension
7.13 Configuring a Mesh Group on an NBMA Network
7.14 Configuring IS-IS Reliability
7.15 Configuring IPv4 IS-IS Auto FRR
7.16 Configuring the Overload Bit for an IS-IS Device
7.17 Configuring IS-IS Neighbor Relationship Flapping Suppression
7.18 Maintaining IS-IS
7.19 Configuration Examples for IPv4 IS-IS
7.20 Troubleshooting IPv4 IS-IS
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 473
7.1 Overview of IS-IS
Definition
Intermediate System-to-Intermediate System (IS-IS) is an Interior Gateway
Protocol (IGP) that runs within an autonomous system (AS). IS-IS is also a link-
state routing protocol, using the shortest path first (SPF) algorithm to calculate
routes.
Purpose
IS-IS is a dynamic routing protocol initially designed by the International
Organization for Standardization (ISO) for its Connectionless Network Protocol
(CLNP).
To support IP routing, the Internet Engineering Task Force (IETF) extended and
modified IS-IS in RFC 1195. This modification enables IS-IS to apply to TCP/IP and
OSI environments. This type of IS-IS is called Integrated IS-IS or Dual IS-IS.
NOTE
IS-IS stated in this document refers to Integrated IS-IS, unless otherwise stated.
In addition to IPv4 networks, IS-IS also applies to IPv6 networks to provide
accurate routing information for IPv6 packets. IS-IS has good scalability, supports
IPv6 network layer protocols, and is capable of discovering, generating, and
forwarding IPv6 routes.
7.2 Understanding IS-IS
7.2.1 Basic Concepts of IS-IS
IS-IS Topology Structure
Overall IS-IS Topology
IS-IS uses a two-level hierarchy (backbone area and non-backbone area) to
support large-scale routing networks. Generally, Level-1 routers are deployed in
non-backbone areas, whereas Level-2 and Level-1-2 routers are deployed in
backbone areas. Each non-backbone area connects to the backbone area through
a Level-1-2 router.
Figure 7-1 shows a network that runs IS-IS. The network is similar to an OSPF
network topology with multiple areas. The backbone area contains all the routers
in Area 1 and Level-1-2 routers in other areas.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 474
Figure 7-1 IS-IS topology I
Figure 7-2 shows another type of IS-IS topology. In this topology, Level-2 routers
belong to different areas. All the physically contiguous Level-1-2 and Level-2
routers form the backbone area of IS-IS.
Figure 7-2 IS-IS topology II
The two types of topologies show the differences between IS-IS and OSPF:
● In IS-IS, each router belongs to only one area. In OSPF, different interfaces of
a router may belong to different areas.
● In IS-IS, no area is defined as the backbone area. In OSPF, Area 0 is defined as
the backbone area.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 475
● In IS-IS, Level-1 and Level-2 routes are calculated using the SPF algorithm to
generate the shortest path tree (SPT). In OSPF, the SPF algorithm is used only
in the same area, and inter-area routes are forwarded by the backbone area.
IS-IS Router Types
● Level-1 router
A Level-1 router manages intra-area routing. It establishes neighbor
relationships with only the Level-1 and Level-1-2 routers in the same area and
maintains a Level-1 link state database (LSDB). The LSDB contains intra-area
routing information. A packet to a destination outside this area is forwarded
to the nearest Level-1-2 router.
● Level-2 router
A Level-2 router manages inter-area routing. It can establish neighbor
relationships with Level-2 or Level-1-2 routers in different areas and
maintains a Level-2 LSDB. The LSDB contains inter-area routing information.
All Level-2 routers form the backbone network of the routing domain. They
establish Level-2 neighbor relationships and are responsible for inter-area
communication. Level-2 routers in the routing domain must be physically
contiguous to ensure the continuity of the backbone network. Only Level-2
routers can exchange data packets or routing information with routers outside
the routing domain.
● Level-1-2 router
A router that belongs to both a Level-1 area and a Level-2 area is called a
Level-1-2 router. It can establish Level-1 neighbor relationships with Level-1
and Level-1-2 routers in the same area. It can also establish Level-2 neighbor
relationships with Level-2 and Level-1-2 routers in different areas. A Level-1
router must be connected to other areas through a Level-1-2 router.
A Level-1-2 router maintains two LSDBs: a Level-1 LSDB and a Level-2 LSDB.
The Level-1 LSDB saves for intra-area routing and the Level-2 LSDB saves for
inter-area routing.
IS-IS Network Types
IS-IS supports only two types of networks. In terms of physical links, IS-IS
networks can be classified into the following link types:
● Broadcast: such as Ethernet and Token-Ring
● Point-to-point: such as PPP and HDLC
NOTE
IS-IS cannot run on Point to MultiPoint (P2MP) networks.
DIS and Pseudonode
In a broadcast network, IS-IS needs to elect a Designated Intermediate System
(DIS) from all the routers. DISs are used to create and update pseudonodes and
generate link state protocol data units (LSPs) of pseudonodes to describe available
network devices.
The pseudonode is used to simulate a virtual node in the broadcast network and is
not an actual router. In IS-IS, a pseudonode is identified by the system ID of the
DIS and the 1-byte Circuit ID (its value is not 0).
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 476
Figure 7-3 Pseudonode
As shown in Figure 7-3, the use of pseudonodes simplifies the network topology
and shortens LSPs. When the network changes, the number of generated LSPs is
reduced, and the SPF consumes fewer resources.
Level-1 and Level-2 DISs are elected separately. You can configure different
priorities for DISs of different levels. The router with the highest priority is elected
as the DIS. If there are multiple routers with the same highest priority on a
broadcast network, the one with the highest MAC address is chosen. The DISs of
different levels can be the same router or different routers.
DIS election in IS-IS differs from designated router (DR) election in OSPF:
● On an IS-IS broadcast network, the router with priority 0 also takes part in
DIS election. In OSPF, the router with priority 0 does not take part in DR
election.
● In IS-IS, when a new router that meets the requirements of being a DIS
connects to a broadcast network, the router is elected as the new DIS, and
the previous pseudonode is deleted. This causes a new flooding of LSPs. In
OSPF, when a new router connects to a network, it is not immediately elected
as the DR even if it has the highest DR priority.
● On an IS-IS broadcast network, routers (including non-DIS routers) of the
same level on a network segment set up adjacencies. In OSPF, routers set up
adjacencies with only the DR and backup designated router (BDR).
NOTE
On an IS-IS broadcast network, although all the routers set up adjacencies with each other,
the LSDBs are synchronized by the DISs.
IS-IS Address Structure
The network service access point (NSAP) is an address defined by the OSI to
locate resources. Figure 7-4 shows the NSAP address structure. The NSAP is
composed of the initial domain part (IDP) and the domain specific part (DSP). The
lengths of the IDP and the DSP are variable. The maximum length of the NSAP is
20 bytes and its minimum length is 8 bytes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 477
● The IDP is similar to the network ID in an IP address. It is defined by the ISO
and consists of the authority and format identifier (AFI) and the initial
domain identifier (IDI). The AFI indicates the address allocation authority and
address format, and the IDI identifies a domain.
● The DSP is similar to the subnet ID and host address in an IP address. The
DSP consists of the High Order DSP (HODSP), system ID, and NSAP Selector
(SEL). The HODSP is used to divide areas, the system ID identifies a host, and
the SEL indicates the service type.
Figure 7-4 IS-IS address structure
● Area Address
The IDP and the HODSP of the DSP identify a routing domain and the areas
in a routing domain. Therefore, the combination of the IDP and HODSP is
called an area address, which is similar to an area number in OSPF. The area
addresses of routers in the same Level-1 area must be the same, while the
area addresses of routers in the Level-2 area can be different.
In general, a router can be configured with only one area address. The area
address of all nodes in an area must be the same. In the implementation of a
device, an IS-IS process can be configured with a maximum of three area
addresses to support seamless combination, division, and transformation of
areas.
● System ID
A system ID uniquely identifies a host or a router in an area. In the device, the
fixed length of the system ID is 48 bits (6 bytes).
In actual applications, a router ID corresponds to a system ID. If a router takes
the IP address 192.168.1.1 of Loopback 0 as its router ID, its system ID used in
IS-IS can be obtained in the following way:
– Extend each part of IP address 192.168.1.1 to 3 bits and add 0 to the
front of any part that is shorter than 3 bits. Then the IP address is
extended as 192.168.001.001.
– Divide the extended address 192.168.001.001 into three parts, each of
which consists of four decimal digits. Then system ID 1921.6800.1001 is
obtained.
You can specify a system ID in many ways. You need to ensure that the
system ID uniquely identifies a host or a router.
● SEL
The role of an SEL is similar to that of the "protocol identifier" of IP. A
transport protocol matches an SEL. The SEL is always "00" in IP.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 478
A Network Entity Title (NET) indicates the network layer information of an IS
itself and consists of an area ID and a system ID. It does not contain the transport
layer information (SEL = 0). A NET can be regarded as a special NSAP. The length
of the NET field is the same as that of an NSAP. Its maximum length is 20 bytes
and its minimum length is 8 bytes. When configuring IS-IS on a router, you can
configure only a NET instead of an NSAP.
Assume that there is a NET: ab.cdef.1234.5678.9abc.00. In the NET, the area
address is ab.cdef, the system ID is 1234.5678.9abc, and the SEL is 00.
IS-IS PDU Types
IS-IS PDUs include Hello PDUs, link state PDUs (LSPs), and sequence number
PDUs (SNPs).
● Hello PDU
Hello packets, also called IS-IS Hello PDUs (IIH), are used to set up and
maintain neighbor relationships. Among them, Level-1 LAN IIHs apply to the
Level-1 routers on broadcast LANs; Level-2 LAN IIHs apply to the Level-2
routers on broadcast LANs; and P2P IIHs apply to non-broadcast networks.
Hello packets on different networks have different formats. Compared to a
LAN IIH, a P2P IIH does not have the Priority and LAN ID fields, but has a
Local Circuit ID field. The Priority field indicates the DIS priority on a
broadcast network, the LAN ID field indicates the system ID of the DIS and
pseudonode, and the Local Circuit ID indicates the local link ID.
● LSP
LSPs are used to exchange link-state information. There are two types of LSPs:
Level-1 and Level-2. Level-1 IS-IS transmits Level-1 LSPs; Level-2 IS-IS
transmits Level-2 LSPs; and Level-1-2 IS-IS can transmit both Level-1 and
Level-2 LSPs.
The meanings of major fields in an LSP are as follows:
– ATT field: When a Level-1-2 IS-IS transmits Level-1 LSPs in a Level-1 area,
Level-1 IS-IS in the area can communicate with devices in other areas
through the Level-1-2 IS-IS if the ATT bit is set in the Level-1 LSPs.
– OL field: indicates the LSDB overload.
LSPs with the overload bit are still flooded on the network, but these
LSPs are ignored during the calculation of the routes that pass through a
router in overload state. After the overload bit is set on a router, other
routers ignore the router when performing SPF calculation and consider
only the direct routes of the router.
– IS Type field: indicates the type of IS-IS that generates the LSP. The value
01 indicates Level-1, and the value 11 indicates Level-2.
● SNP
SNPs describe the LSPs in all or some databases to help synchronize and
maintain all LSDBs.
SNPs include complete SNPs (CSNPs) and partial SNPs (PSNPs). They are
further classified into Level-1 CSNPs, Level-2 CSNPs, Level-1 PSNPs, and
Level-2 PSNPs.
A CSNP contains the summary of all LSPs in an LSDB. This maintains LSDB
synchronization between neighboring routers. On a broadcast network, the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 479
DIS periodically sends CSNPs. The default interval for sending CSNPs is 10
seconds. On a point-to-point link, CSNPs are sent only when the neighbor
relationship is established for the first time.
A PSNP lists only the sequence number of recently received LSPs. A PSNP can
acknowledge multiple LSPs at one time. If an LSDB is not updated, the PSNP
is also used to request a neighbor to send a new LSP.
The variable length fields in an IS-IS PDU are multiple type-length-values (TLVs).
Figure 7-5 shows the TLV format. A TLV is also called a code-length-value (CLV).
Figure 7-5 TLV format
TLVs vary according to PDU types, as shown in Table 7-1.
Table 7-1 PDU types and TLV names
TLV Type Name Applied PDU Type
1 Area Addresses IIH, LSP
2 IS Neighbors (LSP) LSP
4 Partition Designated Level2 IS L2 LSP
6 IS Neighbors (MAC Address) LAN IIH
7 IS Neighbors (SNPA Address) LAN IIH
8 Padding IIH
9 LSP Entries SNP
10 Authentication Information IIH, LSP, SNP
128 IP Internal Reachability Information LSP
129 Protocols Supported IIH, LSP
130 IP External Reachability Information LSP
131 Inter-Domain Routing Protocol
Information
L2 LSP
132 IP Interface Address IIH, LSP
TLVs with the type value ranging from 1 to 10 are defined in ISO 10589, and the
other TLVs are defined in RFC 1195.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 480
7.2.2 IS-IS Fundamentals
IS-IS is a link-state routing protocol. Each router generates an LSP that contains
link state information about all the IS-IS interfaces on the router. The router can
establish IS-IS neighbor relationships with neighboring devices and update its
LSDB to synchronize the local LSDB with the LSDBs of all the other devices on the
IS-IS network. Based on the local LSDB, the router uses the SPF algorithm to
calculate IS-IS routes. If the router finds that an IS-IS route is the optimal route to
a destination, the router adds the route to the local IP routing table to guide
packet forwarding.
Establishment of IS-IS Neighbor Relationship
Two IS-IS routers need to establish a neighbor relationship before exchanging
packets to implement routing. On different networks, the modes for establishing
IS-IS neighbors are different.
● Establishment of a neighbor relationship on a broadcast link
Figure 7-6 uses Level-2 routers as an example to describe the process of
establishing a neighbor relationship on a broadcast link. The process of
establishing a neighbor relationship between Level-1 routers is the same as
the process of establishing a neighbor relationship between Level-2 routers.
Figure 7-6 Process of establishing a neighbor relationship on a broadcast link
a. RouterA broadcasts a Level-2 LAN IS-IS Hello PDU (IIH) with no neighbor
ID specified.
b. RouterB receives this packet and sets the status of the neighbor
relationship with RouterA to Initial. RouterB then responds to RouterA
with a Level-2 LAN IIH, indicating that RouterA is a neighbor of RouterB.
c. RouterA receives this packet and sets the status of the neighbor
relationship with RouterB to Up. RouterA then sends RouterB a Level-2
LAN IIH indicating that RouterB is a neighbor of RouterA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 481
d. RouterB receives this packet and sets the status of the neighbor
relationship with RouterA to Up. RouterA and RouterB establish a
neighbor relationship successfully.
The network is a broadcast network, so a DIS needs to be elected. After the
neighbor relationship is established, routers wait for two intervals before
sending Hello packets to elect the DIS. The IIH packets exchanged by the
routers contain the Priority field. The router with the highest priority is elected
as the DIS. If the routers have the same priority, the router with the largest
interface MAC address is elected as the DIS.
● Establishment of a neighbor relationship on a P2P link
Unlike the establishment of a neighbor relationship on a broadcast link, the
establishment of a neighbor relationship on a P2P link is classified into two
modes: two-way mode and three-way mode.
– Two-way mode
Upon receiving a P2P IIH from a neighbor, a router considers the
neighbor Up and establishes a neighbor relationship with the neighbor.
– Three-way mode
A neighbor relationship is established after P2P IIHs are sent three times.
The establishment of a neighbor relationship on a P2P link is similar to
that on a broadcast link.
The two-way mode has distinct disadvantages. For example, when two or
more links exist between two routers, the two routers can still establish a
neighbor relationship if one link is Down and the other is Up in the same
direction. The parameters of the link in Up state are used in SPF calculation.
As a result, the router that does not detect the fault of the link in Down state
still tries to forward packets over this link. The three-way mode addresses
such problems on unreliable P2P links. In three-way mode, a router considers
the neighbor Up only after confirming that the neighbor receives the packet
sent by it, and then establishes a neighbor relationship with the neighbor.
Basic rules for establishing an IS-IS neighbor relationship are as follows:
● Only neighboring routers of the same level can set up the neighbor
relationship with each other.
● Level-1 routers must have the same area IDs.
● Network types of IS-IS interfaces on both ends of a link must be consistent.
NOTE
Ethernet interfaces can be simulated as P2P interfaces to establish a neighbor
relationship on a P2P link.
● IP addresses of IS-IS interfaces on both ends of a link must be on the same
network segment.
IS-IS runs on the data-link layer and was initially designed for CLNP.
Therefore, the establishment of IS-IS neighbor relationships is not related to
IP addresses. In the implementation of a device, IS-IS runs only over IP.
Therefore, IS-IS needs to check the IP address of its neighbor. If secondary IP
addresses are assigned to the interfaces, the routers can still set up the IS-IS
neighbor relationship, but only when either the primary IP addresses or
secondary IP addresses are on the same network segment.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 482
NOTE
When IP addresses of IS-IS interfaces on both ends of a link are on different network
segments, a neighbor relationship can still be established on the two interfaces if the
interfaces are configured not to check the IP addresses in received Hello packets. You
can configure P2P interfaces not to check the IP addresses in received Hello packets.
Before configuring Ethernet interfaces not to check the IP addresses, simulate Ethernet
interfaces as P2P interfaces.
Process of Exchanging IS-IS LSPs
Causes of LSP generation
All routers in the IS-IS routing domain can generate LSPs. The following events
trigger the generation of a new LSP:
● Neighbor is Up or Down.
● Related interface goes Up or Down.
● Imported IP routes change.
● Inter-area IP routes change.
● Interface is assigned a new metric value.
● Periodic updates occur.
Processing of a new LSP received from a neighbor
1. The router installs the LSP to its LSDB and marks it for flooding.
2. The router sends the LSP to all interfaces except the interface that initially
received the LSP.
3. The neighbors flood the LSP to their neighbors.
LSP flooding
In LSP flooding, a router sends an LSP to its neighbors and then the neighbors
send the received LSP to their respective neighbors except the router that first
sends the LSP. In this manner, the LSP is flooded among the routers of the same
level. LSP flooding allows each router of the same level to have the same LSP
information and synchronize its LSDB with each other.
Each LSP has a 4-byte sequence number. When a router is started, the sequence
number of the first LSP sent by the router is 1. When a new LSP is generated, the
sequence number of the LSP is equal to the sequence number of the previous LSP
plus 1. Therefore, newer LSPs have larger sequence numbers.
Process of synchronizing LSDBs between a newly added router and DIS on a
broadcast link
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 483
Figure 7-7 Process of updating LSDBs on a broadcast link
In Figure 7-7
1. A new router (RouterC) sends a Hello packet to establish neighbor
relationships with the other routers in the broadcast domain.
2. RouterC establishes neighbor relationships with RouterA and RouterB, waits
for the timeout of the LSP refresh timer, and then sends its LSP to a multicast
address (01-80-C2-00-00-14 in a Level-1 area and 01-80-C2-00-00-15 in a
Level-2 area). All neighbors on the network can receive the LSP.
3. The DIS on the network segment adds the received LSP to its LSDB. After the
CSNP timer expires, the DIS sends CSNPs to synchronize the LSDBs on the
network.
4. RouterC receives the CSNPs from the DIS, checks its LSDB, and sends a PSNP
to request the LSPs it does not have.
5. The DIS receives the PSNP and sends RouterC the required LSPs for LSDB
synchronization.
The process of updating the LSDB of the DIS is as follows:
1. When the DIS receives an LSP, it searches the LSDB to check whether the
same LSP exists. If the DIS does not find the same LSP in its LSDB, the DIS
adds the LSP to its LSDB and broadcasts the content of the new LSDB.
2. If the sequence number of the received LSP is greater than that of the
corresponding LSP in the LSDB, the DIS replaces the existing LSP with the
received LSP and broadcasts the contents of the new LSDB. If the sequence
number of the received LSP is smaller than that of the corresponding LSP in
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 484
the LSDB, the DIS sends its LSP in the LSDB through the inbound interface of
the received LSP.
3. If the sequence number of the received LSP is the same as that of the
corresponding LSP in the LSDB, the DIS compares the remaining lifetime of
the two LSPs. If the remaining lifetime of the received LSP is smaller than that
of the corresponding LSP in the LSDB, the DIS replaces the existing LSP with
the received LSP and broadcasts the contents of the new LSDB. If the
remaining lifetime of the received LSP is greater than that of the
corresponding LSP, the DIS sends its LSP in the LSDB through the inbound
interface of the received LSP.
4. If the sequence number and remaining lifetime of the received LSP are the
same as those of the corresponding LSP in the LSDB, the DIS compares the
checksum of the two LSPs. If the checksum of the received LSP is greater than
that of the corresponding LSP in the LSDB, the DIS replaces the existing LSP
with the received LSP and broadcasts the content of the new LSDB. If the
checksum of the received LSP is smaller than that of the corresponding LSP,
the DIS sends its LSP in the LSDB through the inbound interface of the
received LSP.
5. If the sequence number, remaining lifetime, and checksum of the received LSP
are the same as those of the corresponding LSP in the LSDB, the DIS does not
forward the received LSP.
Process of synchronizing the LSDB on a P2P link
Figure 7-8 Process of updating LSDBs on a P2P link
1. RouterA establishes a neighbor relationship with RouterB.
2. RouterA and RouterB send a CSNP to each other. If the LSDB of the neighbor
and the received CSNP are not synchronized, the neighbor sends a PSNP to
request the required LSP.
3. Figure 7-8 assumes that RouterB requests the required LSP from RouterA.
RouterA sends the required LSP to RouterB, starts the LSP retransmission
timer, and waits for a PSNP from RouterB as an acknowledgement for the
received LSP.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 485
4. If RouterA does not receive a PSNP from RouterB after the LSP retransmission
timer expires, RouterA resends the LSP until it receives a PSNP from RouterB.
NOTE
A PSNP on a P2P link is used as:
● A request packet to acquire LSPs
● An ACK packet to acknowledge the received LSP
The process of updating LSDBs on a P2P link is as follows:
1. If the sequence number of the received LSP is greater than the sequence
number of the corresponding LSP in the LSDB, the router adds the LSP to its
LSDB. The router then sends a PSNP packet to acknowledge the received LSP.
At last, the router sends the LSP to all its neighbors except the neighbor that
sends the LSP.
2. If the sequence number of the received LSP is smaller than the sequence
number of the corresponding LSP, the router directly sends its LSP to the
neighbor and waits for a PSNP from the neighbor as the acknowledgement.
3. If the sequence number of the received LSP is the same as the sequence
number of the corresponding LSP in the LSDB, the router compares the
Remaining Lifetime of the two LSPs. If the Remaining Lifetime of the received
LSP is 0, the router adds the LSP to its LSDB. The router then sends a PSNP to
acknowledge the received LSP, and sends the LSP to all its neighbors except
the neighbor that sends the LSP. If the Remaining Lifetime of the received LSP
is not 0 but the corresponding LSP in the LSDB is 0, the router directly sends
its local LSP to the neighbor and waits for a PSNP from the neighbor.
4. If the sequence number of the received LSP and the corresponding LSP in the
LSDB are the same, and neither Remaining Lifetime is 0, router compares the
checksum of the two LSPs. If the received LSP has a greater checksum than
that of the corresponding LSP, the router adds the LSP to its LSDB. The router
then sends a PSNP to acknowledge the received LSP, and sends the LSP to all
its neighbors except the neighbor that sends the LSP. If the received LSP has a
smaller checksum than that of the corresponding LSP, the router directly
sends its local LSP to the neighbor and waits for a PSNP from the neighbor.
5. If the checksum of the received LSP and that of the corresponding LSP are the
same, the LSP is not forwarded.
7.2.3 IS-IS Authentication
To ensure network security, IS-IS authentication encrypts IS-IS packets by adding
an authentication field to packets. When a local router receives IS-IS packets from
a remote router, the local router discards the packets if the authentication
passwords do not match. This protects the local router.
Authentication Types
Based on the types of packets, authentication is classified as follows:
● Interface authentication: authenticates Level-1 and Level-2 Hello packets sent
and received on IS-IS interfaces using the specified authentication mode and
password.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 486
NOTE
You can configure a router to perform interface authentication in the following ways:
● A router sends authentication packets carrying the authentication TLV and verifies
the authentication information about the received packets.
● A router sends authentication packets carrying the authentication TLV but does not
verify the authentication information about the received packets.
● Area authentication: authenticates Level-1 LSPs and Level-1 SNPs transmitted
in an IS-IS area using the specified authentication mode and password.
● Routing domain authentication: authenticates Level-2 LSPs and Level-2 SNPs
transmitted in an IS-IS routing domain using the specified authentication
mode and password.
NOTE
In area authentication and routing domain authentication, you can configure a router
to authenticate LSPs and SNPs separately in the following ways:
● A router sends LSPs and SNPs carrying the authentication TLV and verifies the
authentication information about the received LSPs and SNPs.
● A router sends LSPs carrying the authentication TLV and verifies the authentication
information about the received LSPs. The router sends SNPs carrying the
authentication TLV but does not verify the authentication information about the
received SNPs.
● A router sends LSPs carrying the authentication TLV and verifies the authentication
information about the received LSPs. The router sends SNPs without the
authentication TLV and does not verify the authentication information about the
received SNPs.
● A router sends LSPs and SNPs carrying the authentication TLV but does not verify
the authentication information about the received LSPs and SNPs.
Based on the authentication modes of packets, authentication is classified into the
following types:
● Plain text authentication: is a simple authentication mode in which passwords
are directly added to packets. This authentication is insecure.
● MD5 authentication: uses the MD5 algorithm to encrypt passwords before
they are added to packets, which improves password security.
● Keychain authentication: further improves network security with configurable
key chain that changes with time.
● HMAC-SHA256 authentication: uses the HMAC-SHA256 algorithm to encrypt
a password before adding the password to a packet, which ensures high
password security.
NOTE
Simple authentication and MD5 authentication have potential security risks. HMAC-SHA256
or Keychain authentication mode is recommended.
Mode in Which Authentication Information Is Carried
IS-IS provides a TLV to carry authentication information, with the type of the TLV
specified as 10.
● Type: is defined by the ISO as 10, with a length of 1 byte.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 487
● Length: indicates the length of the authentication TLV, which is 1 byte.
● Value: indicates the authentication contents of 1 to 254 bytes, including the
authentication type and password.
The authentication type is 1 byte:
– Type 0 is reserved.
– Type 1 indicates plain text authentication.
– Type 54 indicates MD5 authentication.
– Type 255 indicates routing domain private authentication methods.
7.2.4 IS-IS Route Leaking
Normally, Level-1 routers manage routes in Level-1 areas. All Level-2 and
Level-1-2 routers form a contiguous backbone area. Level-1 areas can only
connect to the backbone area and cannot connect to each other.
A Level-1-2 router encapsulates learned Level-1 routing information into a Level-2
LSP and floods the Level-2 LSP to other Level-2 and Level-1-2 routers. Then
Level-1-2 and Level-2 routers know routing information about the entire IS-IS
routing domain. To reduce the size of routing tables, a Level-1-2 router, by default,
does not advertise the learned routing information of other Level-1 areas and the
backbone area to its Level-1 area. In this case, Level-1 routers do not know
routing information outside the local area. As a result, Level-1 routers cannot
select the optimal route to a destination outside the local area.
IS-IS route leaking can solve this problem. You can configure access control lists
(ACLs) and routing policies and mark routes with tags on Level-1-2 routers to
select eligible routes. Then a Level-1-2 router can advertise routing information of
other Level-1 areas and backbone area to its Level-1 area.
Figure 7-9 IS-IS route leaking
In Figure 7-9, RouterA sends a packet to RouterF. The selected optimal route
should be RouterA->RouterB->RouterD->RouterE->RouterF. This is because the
cost of this route is 50, which is smaller than the cost (70) of the other route
(RouterA->RouterC->RouterE->RouterF). However, when you check the route on
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 488
RouterA to view the path of the packets sent to RouterF, the selected route is
RouterA->RouterC->RouterE->RouterF but not the optimal route from RouterA to
RouterF.
RouterA (Level-1 router) does not know routes outside its area, so it sends packets
outside its area through the default route generated by the nearest Level-1-2
router. Therefore, the optimal route is not used to forward the packets.
If route leaking is enabled on Level-1-2 routers (RouterC and RouterD), Level-1
routers in Area 10 can know routes outside Area 10 and passing through the two
Level-1-2 routers. After route calculation, the forwarding path becomes RouterA-
>RouterB->RouterD->RouterE->RouterF, which is the optimal route from RouterA
to RouterF.
7.2.5 IS-IS Overload
IS-IS Overload allows a device to use the IS-IS overload bit to identify the overload
state. The IS-IS overload bit is the OL field in an IS-IS LSP. After the overload bit is
set on a device, other devices ignore this device when performing SPF calculation
and consider only the direct routes of the device.
Figure 7-10 IS-IS Overload
As shown in Figure 7-10, RouterB forwards the packets sent from RouterA to
network segment 10.1.1.0/24. If the overload bit in the LSP sent from RouterB is
set to 1, RouterA considers the LSDB of RouterB incomplete and sends packets to
10.1.1.0/24 through RouterD and RouterE. This process does not affect the packets
sent to the directly connected network segment of RouterB.
If a device cannot store new LSPs and fails to synchronize the LSDB, the routes
calculated by this device are incorrect. In this situation, the device enters the
overload state and does not calculate the routes passing through this device;
however, the direct routes of the device are still valid.
A device may enter the overload state because of device abnormalities or is
manually configured to enter the overload state. When an IS-IS device on the
network needs to be upgraded or maintained, isolate this device from the network
temporarily and set the overload bit on the device to prevent other devices from
using this device to forward traffic.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 489
NOTE
● If the system enters the overload state because of an abnormality, the system deletes all
the imported or leaked routes.
● If the system is configured to enter the overload state, the system determines whether
to delete all the imported or leaked routes based on the configuration.
7.2.6 IS-IS Network Convergence
Fast convergence and priority-based convergence can improve IS-IS network
convergence. Fast convergence speeds up network convergence by fast calculating
routes, while priority-based convergence sets different convergence priorities for
routes to improve network convergence.
Fast Convergence
IS-IS fast convergence is an extended feature of IS-IS that is implemented to speed
up the convergence of routes. Fast convergence includes the following:
● Incremental SPF (I-SPF): recalculates only the routes of the changed nodes
rather than all the nodes when the network topology changes. This speeds up
the calculation of routes.
In ISO 10589, the SPF algorithm is used to calculate routes. When a node
changes on the network, this algorithm is used to recalculate all routes. The
calculation takes a long time and consumes too many CPU resources,
affecting the convergence speed.
I-SPF improves this algorithm. Except for the first time, only changed nodes
instead of all nodes are involved in calculation. The shortest path tree (SPT)
generated is the same as that generated by the previous algorithm. This
decreases CPU usage and speeds up network convergence.
● Partial Route Calculation (PRC): calculates only the changed routes when the
routes on the network change.
Similar to I-SPF, PRC calculates only the changed routes, but it does not
calculate the shortest path. It updates routes based on the SPT calculated by
I-SPF.
In route calculation, a leaf represents a route, and a node represents a router.
If the SPT changes after I-SPF calculation, PRC processes all the leaves only on
the changed node. If the SPT remains unchanged, PRC processes only the
changed leaves. For example, if IS-IS is enabled on an interface of a node, the
SPT calculated by I-SPF remains unchanged. PRC updates only the routes of
this interface, consuming less CPU resources.
PRC working with I-SPF further improves the convergence performance of the
network. It is an improvement of the original SPF algorithm.
● Intelligent timer: applies to LSP generation and SPF calculation. The first
timeout period of the intelligent timer is fixed. Before the intelligent timer
expires, if an event that triggers the timer occurs, the next timeout period of
the intelligent timer increases.
Although the route calculation algorithm is improved, the long interval for
triggering route calculation affects the convergence speed. Frequent network
changes also consume too many CPU resources. The SPF intelligent timer
addresses both of these problems. In general, an IS-IS network is stable under
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 490
normal conditions. The probability of the occurrence of many network
changes is very minimal, and IS-IS does not calculate routes frequently. The
period for triggering the route calculation is very short (milliseconds). If the
topology of the network changes often, the intelligent timer increases the
route calculation interval to avoid too much CPU consumption. The original
mechanism uses a timer with uniform intervals, which makes fast
convergence and low CPU consumption impossible to achieve.
The LSP generation intelligent timer is similar to the SPF intelligent timer.
When the LSP generation intelligent timer expires, the system generates a
new LSP based on the current topology. The LSP generation timer is designed
as an intelligent timer to respond to emergencies (such as the interface is Up
or Down) quickly and speed up the network convergence.
● LSP fast flooding: speeds up the flooding of LSPs.
In most cases, when an IS-IS router receives new LSPs from other routers, it
updates the LSPs in its LSDB and periodically floods the updated LSPs
according to a timer.
LSP fast flooding speeds up LSDB synchronization because it allows a device
to flood fewer LSPs than the specified number before route calculation when
the device receives one or more new LSPs. This mechanism also speeds up
network convergence.
Priority-based Convergence
Priority-based IS-IS convergence ensures that specific routes are converged first
when a great number of routes need to be converged. You can assign a high
convergence priority to routes for key services so that these routes are converged
quickly. This reduces the impact of route convergence on key services. Different
routes can be set with different convergence priorities so that important routes
can be converged first. This improves network reliability.
7.2.7 IS-IS Neighbor Relationship Flapping Suppression
IS-IS neighbor relationship flapping suppression works by delaying IS-IS neighbor
relationship reestablishment or setting the link cost to the maximum value
(16777214 in IS-IS wide mode and 63 in IS-IS narrow mode).
Background
If the status of an interface carrying IS-IS services alternates between Up and
Down, IS-IS neighbor relationship flapping occurs on the interface. During the
flapping, IS-IS frequently sends Hello packets to reestablish the neighbor
relationship, synchronizes LSDBs, and recalculates routes. In this process, a large
number of packets are exchanged, adversely affecting neighbor relationship
stability, IS-IS services, and other IS-IS-dependent services, such as LDP and BGP.
IS-IS neighbor relationship flapping suppression can address this problem by
delaying IS-IS neighbor relationship reestablishment or preventing service traffic
from passing through flapping links.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 491
Related Concepts
Flapping_event: reported when the status of a neighbor relationship on an
interface last changes from Up to Init or Down. The flapping_event triggers
flapping detection.
Flapping_count: number of times flapping has occurred.
Detect-interval: interval at which flapping is detected. The interval is used to
determine whether to trigger a valid flapping_event.
Threshold: flapping suppression threshold. When the flapping_count reaches or
exceeds threshold, flapping suppression takes effect.
Resume-interval: interval used to determine whether flapping suppression exits. If
the interval between two valid flapping_events is longer than the resume-interval,
flapping suppression exits.
Implementation
Flapping detection
IS-IS interfaces start a flapping counter. If the interval between two
flapping_events is shorter than the detect-interval, a valid flapping_event is
recorded, and the flapping_count is incremented by 1. When the flapping_count
exceeds the threshold, the system determines that flapping occurs, and therefore
triggers flapping suppression, and sets the flapping_count to 0. If the interval
between two valid flapping_events is longer than the resume-interval before the
flapping_count reaches the threshold again, the system sets the flapping_count to
0 again. Interfaces start the suppression timer when the status of a neighbor
relationship last changes to Init or Down.
The detect-interval, threshold, and resume-interval are configurable.
Flapping suppression
Flapping suppression works in either Hold-down or Hold-max-cost mode.
● Hold-down mode: In the case of frequent flooding and topology changes
during neighbor relationship establishment, interfaces prevent neighbor
relationships from being reestablished during the suppression period, which
minimizes LSDB synchronization attempts and packet exchanges.
● Hold-max-cost mode: If the traffic forwarding path changes frequently,
interfaces use the maximum cost of the flapping link during the suppression
period, which prevents traffic from passing through the flapping link.
Flapping suppression can also work first in Hold-down mode and then in Hold-
max-cost mode.
By default, the Hold-max-cost mode takes effect. The mode and suppression
period can be changed manually.
NOTE
When an interface enters the flapping suppression state, all neighbor relationships on the
interface enter the state accordingly.
Exiting from flapping suppression
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 492
Interfaces exit from flapping suppression in the following scenarios:
● The suppression timer expires.
● The corresponding IS-IS process is reset.
● A command is run to exit from flapping suppression.
● Three Hello packets in which the padding TLV carries a sub-TLV with the value
being 251 are sent consecutively to notify the peer device to forcibly exit
flapping suppression.
Typical Scenarios
Basic scenario
In Figure 7-11, the traffic forwarding path is Device A -> Device B -> Device C ->
Device E before a link failure occurs. After the link between Device B and Device C
fails, the forwarding path switches to Device A -> Device B -> Device D -> Device
E. If the neighbor relationship between Device B and Device C frequently flaps at
the early stage of the path switchover, the forwarding path will be switched
frequently, causing traffic loss and affecting network stability. If the neighbor
relationship flapping meets suppression conditions, flapping suppression takes
effect.
● If flapping suppression works in Hold-down mode, the neighbor relationship
between Device B and Device C is prevented from being reestablished during
the suppression period, in which traffic is forwarded along the path Device A -
> Device B -> Device D -> Device E.
● If flapping suppression works in Hold-max-cost mode, the maximum cost is
used as the cost of the link between Device B and Device C during the
suppression period, and traffic is forwarded along the path Device A -> Device
B -> Device D -> Device E.
Figure 7-11 Flapping suppression in a basic scenario
Single-forwarding path scenario
When only one forwarding path exists on the network, the flapping of the
neighbor relationship between any two devices on the path will interrupt traffic
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 493
forwarding. In Figure 7-12, the traffic forwarding path is Device A -> Device B ->
Device C -> Device E. If the neighbor relationship between Device B and Device C
flaps, and the flapping meets suppression conditions, flapping suppression takes
effect. However, if the neighbor relationship between Device B and Device C is
prevented from being reestablished, the whole network will be divided. Therefore,
Hold-max-cost mode (rather than Hold-down mode) is recommended. If flapping
suppression works in Hold-max-cost mode, the maximum cost is used as the cost
of the link between Device B and Device C during the suppression period. After the
network stabilizes and the suppression timer expires, the link is restored.
NOTE
By default, the Hold-max-cost mode takes effect.
Figure 7-12 Flapping suppression in a single-forwarding path scenario
Broadcast scenario
In Figure 7-13, four devices are deployed on the same broadcast network using
switches, and the devices are broadcast network neighbors. If Device C flaps due
to a link failure, and Device A and Device B were deployed at different time
(Device A was deployed earlier for example) or the flapping suppression
parameters on Device A and Device B are different, Device A first detects the
flapping and suppresses Device C. Consequently, the Hello packets sent by Device
A do not carry Device C's router ID. However, Device B has not detected the
flapping yet and still considers Device C a valid node. As a result, the DIS
candidates identified by Device A are Device B and Device D, whereas the DIS
candidates identified by Device B are Device A, Device C, and Device D. Different
DIS candidates result in a different DIS election result, which may lead to route
calculation errors. To prevent this problem in scenarios where an interface has
multiple neighbors, such as on a broadcast, P2MP, or NBMA network, all
neighbors on the interface are suppressed when the status of a neighbor
relationship last changes to Init or Down. Specifically, if Device C flaps, Device A,
Device B, and Device D on the broadcast network are all suppressed. After the
network stabilizes and the suppression timer expires, Device A, Device B, and
Device D are restored to normal status.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 494
Figure 7-13 Flapping suppression on a broadcast network
Scenario of multi-level networking
In Figure 7-14, Device A, Device B, Device C, Device E, and Device F are connected
on Level 1 (Area 1), and Device B, Device D, and Device E are connected on Level
2 (Area 0). Traffic from Device A to Device F is preferentially forwarded along an
intra-area route, and the forwarding path is Device A -> Device B -> Device C ->
Device E -> Device F. When the neighbor relationship between Device B and
Device C flaps and the flapping meets suppression conditions, flapping suppression
takes effect in the default mode (Hold-max-cost). Consequently, the maximum
cost is used as the cost of the link between Device B and Device C. However, the
forwarding path remains unchanged because intra-area routes take precedence
over inter-area routes during route selection according to IS-IS route selection
rules. To prevent traffic loss in multi-area scenarios, configure Hold-down mode to
prevent the neighbor relationship between Device B and Device C from being
reestablished during the suppression period. During this period, traffic is forwarded
along the path Device A -> Device B -> Device D -> Device E -> Device F.
NOTE
By default, the Hold-max-cost mode takes effect. The mode can be changed to Hold-down
manually.
Figure 7-14 Flapping suppression in a multi-area scenario
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 495
Scenario with both LDP-IGP synchronization and IS-IS neighbor relationship
flapping suppression configured
In Figure 7-15, if the link between PE1 and P1 fails, an LDP LSP switchover is
implemented immediately, causing the original LDP LSP to be deleted before a
new LDP LSP is established. To prevent traffic loss, LDP-IGP synchronization needs
to be configured. With LDP-IGP synchronization, the maximum cost is used as the
cost of the new LSP to be established. After the new LSP is established, the
original cost takes effect. Consequently, the original LSP is deleted, and LDP traffic
is forwarded along the new LSP.
LDP-IGP synchronization and IS-IS neighbor relationship flapping suppression work
in either Hold-down or Hold-max-cost mode. If both functions are configured,
Hold-down mode takes precedence over Hold-max-cost mode, followed by the
configured link cost. Table 7-2 lists the suppression modes that take effect in
different situations.
Table 7-2 Principles for selecting the suppression modes that take effect in
different situations
LDP-IGP
Synchronization/
IS-IS Neighbor
Relationship
Flapping
Suppression
Mode
LDP-IGP
Synchronization
Hold-down Mode
LDP-IGP
Synchronization
Hold-max-cost
Mode
Exited from LDP-
IGP
Synchronization
Suppression
IS-IS Neighbor
Relationship
Flapping
Suppression Hold-
down Mode
Hold-down Hold-down Hold-down
IS-IS Neighbor
Relationship
Flapping
Suppression Hold-
max-cost Mode
Hold-down Hold-max-cost Hold-max-cost
Exited from IS-IS
Neighbor
Relationship
Flapping
Suppression
Hold-down Hold-max-cost Exited from LDP-
IGP
synchronization
and IS-IS neighbor
relationship
flapping
suppression
For example, the link between PE1 and P1 frequently flaps in Figure 7-15, and
both LDP-IGP synchronization and IS-IS neighbor relationship flapping suppression
are configured. In this case, the suppression mode is selected based on the
preceding principles. No matter which mode (Hold-down or Hold-max-cost) is
selected, the forwarding path is PE1 -> P4 -> P3 -> PE2.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 496
Figure 7-15 Scenario with both LDP-IGP synchronization and IS-IS neighbor
relationship flapping suppression configured
Scenario with both bit-error-triggered protection switching and IS-IS neighbor
relationship flapping suppression configured
If a link has poor link quality, services transmitted along it may be adversely
affected. If bit-error-triggered protection switching is configured and the bit error
rate (BER) along a link exceeds a specified value, a bit error event is reported, and
the maximum cost is used as the cost of the link, triggering route reselection.
Consequently, service traffic is switched to the backup link. If both bit-error-
triggered protection switching and IS-IS neighbor relationship flapping suppression
are configured, they both take effect. Hold-down mode takes precedence over
Hold-max-cost mode, followed by the configured link cost.
Scenario with both Link-bundle and IS-IS neighbor relationship flapping
suppression configured
When the service traffic rate exceeds the capacity of the link, multiple links must
be used. If one of the links between two devices is faulty, traffic is switched to
another link. Because of limited forwarding capacity on the new link, excessive
traffic is discarded. If the number of faulty links reaches the upper threshold, the
maximum cost is used as the cost of all links in the link bundle to switch all
service traffic to the backup nodes. When both link-bundle and neighbor
relationship flapping suppression are configured, if the number of flapping links
reaches the upper threshold, the maximum cost must be configured as the cost of
all other links in the link bundle to prevent service loss caused by user traffic
congestion. As shown in Figure 7-16, two parallel links exist between Device A
and Device C. If Link 1 is faulty and Link 2 bears all service traffic, traffic loss
occurs. If both link-bundle and neighbor relationship flapping suppression are
configured and Link 1 flaps, the maximum cost must be configured for Link 2 to
avoid service traffic congestion. Only the Hold-max-cost mode therefore can be
configured for neighbor relationship flapping suppression to switch the traffic
forwarding path to Device A->Device B->Device C.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 497
Figure 7-16 Scenario with both Link-bundle and IS-IS neighbor relationship
flapping suppression configured
7.2.8 IS-IS Administrative Tag
Administrative tags control the advertisement of IP prefixes in an IS-IS routing
domain to simplify route management. You can use administrative tags to control
the import of routes of different levels and different areas and control IS-IS multi-
instances running on the same router.
Figure 7-17 IS-IS networking
In Figure 7-17, RouterA in Area 4 needs to communicate with devices in other
Level-1 areas, including RouterB in Area 5, RouterC in Area 3, and RouterD in Area
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 498
2. To ensure information security, it is required that other routers in Level-1 areas
(Areas 2, 3, and 5) should not receive the packets sent from RouterA. To meet this
requirement, configure the same administrative tag for IS-IS interfaces on RouterB,
RouterC, and RouterD and configure the Level-1-2 router in Area 4 to leak only
the routes matching the configured administrative tag from Level-2 to Level-1
areas. This allows RouterA to communicate with only RouterB, RouterC, and
RouterD when communicating with devices in Level-1 areas. Figure 7-18 shows
the topology formed on RouterA.
Figure 7-18 IS-IS administrative tag application
The value of an administrative tag is associated with certain attributes. If the cost-
style is wide, wide-compatible or compatible, when IS-IS advertises an IP address
prefix with these attributes, IS-IS adds the administrative tag to the TLV in the
prefix. The tag is flooded along with the prefix throughout the routing domain.
7.2.9 IS-IS Wide Metric
In ISO 10589, the maximum IS-IS interface metric value can only be 63 and the IS-
IS cost style is narrow. A small range of metrics cannot meet the requirements on
large-scale networks. Therefore, in RFC 3784, the maximum IS-IS interface metric
value can reach 16777215, and the maximum IS-IS route metric value can reach
4261412864; in this case, the IS-IS cost style is wide.
● The following lists the TLVs used in narrow mode:
– TLV 128 (IP Internal Reachability TLV): carries IS-IS routes in a routing
domain.
– TLV 130 (IP External Reachability TLV): carries IS-IS routes outside a
routing domain.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 499
– TLV 2 (IS Neighbors TLV): carries neighbor information.
● The following lists the TLVs used in wide mode:
– TLV 135 (Extended IP Reachability TLV): replaces the earlier IP
reachability TLV and carries IS-IS routing information. This TLV expands
the route metric and carries sub-TLVs.
– TLV 22 (IS Extended Neighbors TLV): carries neighbor information.
Table 7-3 lists the cost styles of received and sent IS-IS routing information. The
cost styles of received and sent IS-IS routing information vary according to the
cost style configured on a device.
Table 7-3 Cost styles of received and sent IS-IS routing information
Cost Style Configured
on a Device
Cost Style for
Received IS-IS Routing
Information
Cost Style for Sent IS-IS
Routing Information
narrow narrow narrow
narrow-compatible narrow&wide narrow
compatible narrow&wide narrow&wide
wide-compatible narrow&wide wide
wide wide wide
NOTE
When the cost-style is set to compatible, IS-IS sends the information in narrow mode and in
wide mode respectively.
IS-IS in wide mode and IS-IS in narrow mode cannot communicate. If IS-IS in wide mode
and IS-IS in narrow mode need to communicate, you must change the mode to enable all
routers on the network to receive packets sent by other routers.
7.2.10 IS-IS LSP Fragment Extension
When an IS-IS router needs to advertise the LSPs that contain much information,
the IS-IS router generates multiple LSP fragments to carry more IS-IS information.
IS-IS LSP fragments are identified by the LSP Number field in their LSP IDs. This
field is of 1 byte. An IS-IS process can generate a maximum of 256 LSP fragments;
therefore, only a limited number of routes can be carried.
As defined in RFC 3786, virtual system IDs can be configured and virtual LSPs that
carry routing information can be generated for IS-IS.
Concepts
● Originating system: is a router that runs the IS-IS protocol. A single IS-IS
process can function as multiple virtual routers to advertise LSPs, and the
originating system refers to the IS-IS process.
● Normal System-ID: is the system ID of the originating system.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 500
● Virtual System: is the system identified by the additional system ID to
generate extended LSP fragments. These fragments carry additional system
IDs in their LSP IDs.
● Additional System-ID: is assigned by network administrators to identify a
virtual system. A maximum of 256 extended LSP fragments can be generated
for each additional system ID.
NOTE
Like a normal system ID, an additional system ID must be unique in a routing domain.
● TLV 24 (IS Alias ID TLV): describes the relationship between the originating
system and virtual system.
Principles
In IS-IS, each system ID identifies a system, which can generate a maximum of
256 LSP fragments. With more additional system IDs (up to 50 virtual systems can
be configured), an IS-IS process can generate a maximum of 13,056 LSP
fragments.
After LSP fragment extension is configured, the system prompts you to restart the
IS-IS process if information is lost because LSPs overflow. After being restarted, the
originating system loads as much routing information to LSPs, adds the
overloaded information to the LSPs of the virtual system for transmission, and
uses TLV 24 to notify other routers of its relationship with the virtual system.
Operating Modes
An IS-IS router can run the LSP fragment extension feature in two modes.
Figure 7-19 IS-IS LSP fragment extension
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 501
O
pe
rat
in
g
M
od
e
Usag
e
Scen
ario
Principles Example Precautions
M
od
e-
1
Some
route
rs on
the
netw
ork
do
not
suppo
rt LSP
fragm
ent
exten
sion.
Virtual systems
participate in SPF
calculation. The
originating system
advertises LSPs
containing
information about
links to each virtual
system. Similarly,
each virtual system
advertises LSPs
containing
information about
links to the
originating system.
Virtual systems look
like the physical
routers that connect
to the originating
system.
Mode-1 is a
transitional mode
for the earlier
versions that do not
support LSP
fragment extension.
In earlier versions,
IS-IS cannot identify
the IS Alias ID TLV
and processes the
received LSP that is
advertised by a
virtual system as an
LSP advertised by an
IS-IS process.
In Figure 7-19,
RouterB does not
support LSP
fragment extension,
and RouterA is
configured to
support LSP
fragment extension
in mode-1. RouterA1
and RouterA2 are
virtual systems of
RouterA and send
LSPs carrying some
routing information
of RouterA. After
receiving LSPs from
RouterA, RouterA1,
and RouterA2,
RouterB considers
that there are three
individual routers at
the remote end and
calculates routes.
Because the cost of
the route from
RouterA to RouterA1
and the cost of the
route from RouterA
to RouterA2 are
both 0, the cost of
the route from
RouterB to RouterA
is the same as the
cost of the route
from RouterB to
RouterA1.
The LSP sent by a
virtual system
contains the same
area address and
overload bit as
those in a common
LSP. If the LSPs sent
by a virtual system
contain TLVs
specified in other
features, these TLVs
must be the same as
those in common
LSPs.
The virtual system
carries neighbor
information
indicating that the
neighbor is the
originating system,
with the metric
equal to the
maximum value
minus 1. The
originating system
carries neighbor
information
indicating that the
neighbor is the
virtual system, with
the metric 0. This
ensures that the
virtual system is the
downstream node of
the originating
system when other
routers calculate
routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 502
O
pe
rat
in
g
M
od
e
Usag
e
Scen
ario
Principles Example Precautions
M
od
e-
2
All
the
route
rs on
the
netw
ork
suppo
rt LSP
fragm
ent
exten
sion.
Virtual systems do
not participate in
SPF calculation. All
the routers on the
network know that
the LSPs generated
by virtual systems
actually belong to
the originating
system.
An IS-IS router
working in mode-2
can identify the IS
Alias ID TLV, which
is used as a
reference for
calculating the SPT
and routes.
In Figure 7-19,
RouterB supports
LSP fragment
extension, and
RouterA is
configured to
support LSP
fragment extension
in mode-2. RouterA1
and RouterA2 are
virtual systems of
RouterA and send
LSPs carrying some
routing information
of RouterA. When
receiving LSPs from
RouterA1 and
RouterA2, RouterB
obtains the IS Alias
ID TLV and knows
that the originating
system of RouterA1
and RouterA2 is
RouterA. RouterB
then considers that
information
advertised by
RouterA1 and
RouterA2 belongs to
RouterA.
-
NOTE
When the originating system and virtual system send the LSPs with fragment number 0, the
LSPs must carry the IS Alias ID TLV to indicate the originating system regardless of the
operation mode (mode-1 or mode-2).
7.2.11 IS-IS Host Name Mapping
The IS-IS host name mapping mechanism maps host names to system IDs for IS-IS
devices, including dynamic host name mapping and static host name mapping.
Dynamic host name mapping takes precedence over static host name mapping.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 503
When both a dynamic host name and a static host name are configured, the
dynamic host name takes effect.
On an IS-IS router where host name exchange is disabled, information about IS-IS
neighbors and LSDBs shows that each device in an IS-IS routing domain is
identified by a system ID with 12-digit hexadecimal number, for example,
aaaa.eeee.1234. This device identification method is complex and not easy to use.
The host name exchange mechanism facilitates IS-IS network management and
maintenance.
The system ID is replaced by a host name in the following situations:
● When an IS-IS neighbor is displayed, the system ID of the IS-IS neighbor is
replaced by its host name. When the neighbor is the DIS, the system ID of the
DIS is also replaced by its host name.
● When an LSP in the IS-IS LSDB is displayed, the system ID in the LSP ID is
replaced by the host name of the IS-IS device that advertises the LSP.
● When details about the IS-IS LSDB are displayed, the Host Name field is
added to the LSP generated by the device where dynamic host name
exchange is enabled, and the system ID in the Host Name field is replaced by
the dynamic host name of the device that generates the LSP.
Dynamic Host Name Mapping
On a device where dynamic host name mapping is enabled, dynamic host name
information is advertised as TLV 137 (Dynamic Hostname TLV) in LSPs. When you
run IS-IS commands on other devices to view IS-IS information, the system ID of
the local device is replaced by the configured host name. The host name is easier
to identify and memorize than the system ID.
The Dynamic Hostname TLV is optional and can be inserted anywhere in an LSP.
The value of this TLV cannot be empty. A device can determine whether to send
LSPs carrying TLV 137, while the device that receives LSPs can determine whether
to ignore TLV 137 or whether to obtain TLV 137 for its mapping table.
Static Host Name Mapping
Static host name mapping allows you to configure the mapping between host
names and system IDs of other IS-IS devices on a device. Static host name
mapping takes effect only on the local device and is not advertised using LSPs.
7.2.12 IS-IS GR
IS-IS graceful restart (GR) is a high availability technology that implements non-
stop data forwarding.
After the master/slave switchover, no neighbor information is stored on the
restarted router. The first Hello packets sent by the router after restart do not
contain the neighbor list. After receiving the Hello packets, the neighbor checks
the two-way neighbor relationship and detects that it is not in the neighbor list of
the Hello packets sent by the router. The neighbor relationship is interrupted. The
neighbor then generates new LSPs and floods the topology changes to all other
routers in the area. Routers in the area calculate routes based on the new LSDBs,
which leads to route interruption or routing loops.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 504
The IETF defined the GR standard, RFC 3847, for IS-IS. The restart of the protocol
is processed for both the reserved FIB tables and unreserved FIB tables. Therefore,
the route flapping and interruption of the traffic forwarding caused by the restart
can be avoided.
Concepts
IS-IS GR involves two roles, namely, GR restarter and GR helper.
● GR restarter: is a device that has the GR capability and restarts in GR mode.
● GR helper: is a device that has the GR capability and helps the GR restarter
complete the GR process. The GR restarter must have the GR helper
capability.
To implement GR, IS-IS uses TLV 211 (restart TLV) and three timers, T1, T2, and
T3.
Restart TLV
The restart TLV is an extended part of an IS-to-IS Hello (IIH) PDU. All IIH packets
of the router that supports IS-IS GR contain the restart TLV. The restart TLV carries
the parameters for the protocol restart. Figure 7-20 shows the format of the
restart TLV.
Figure 7-20 Restart TLV
Table 7-4 describes the fields of the restart TLV.
Table 7-4 Restart TLV fields
Field Length Description
Type 1 byte TLV type. Type value 211 indicates the restart TLV.
Length 1 byte Length of value in the TLV.
RR 1 bit Restart request bit. A router sends an RR packet to
notify the neighbors of its restarting or starting and
to require the neighbors to retain the current IS-IS
adjacency and return CSNPs.
RA 1 bit Restart acknowledgement bit. A router sends an RA
packet to respond to the RR packet.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 505
Field Length Description
SA 1 bit Suppress adjacency advertisement bit. The starting
router uses an SA packet to require its neighbors to
suppress the broadcast of their neighbor relationships
to prevent routing loops.
Remaining
Time
2 bytes Time during which the neighbor does not reset the
adjacency. The length of the field is 2 bytes. The time
is measured in seconds. When RA is reset, the value is
mandatory.
Timers
Three timers are introduced to enhance IS-IS GR: T1, T2, and T3.
● T1: If the GR restarter has already sent an IIH packet with RR being set but
does not receive any IIH packet that carries the restart TLV and the RA set
from the GR helper even after the T1 timer expires, the GR restarter resets the
T1 timer and continues to send the restart TLV. If the ACK packet is received
or the T1 timer expires three times, the T1 timer is deleted. The default value
of a T1 timer is 3 seconds.
Any interface enabled with IS-IS GR maintains a T1 timer. On a Level-1-2
router, broadcast interfaces maintain a T1 timer for Level-1 and Level-2
neighbor relationships.
● T2: is the time from when the GR restarter restarts until the LSDBs of all
devices of the same level are synchronized. T2 is the maximum time that the
system waits for synchronization of all LSDBs. T2 is generally 60 seconds.
Level-1 and Level-2 LSDBs maintain their respective T2 timers.
● T3: is the maximum time during which the GR restarter performs GR. The T3
initial value is 65535 seconds. After the IIH packets that carry the RA are
received from neighbors, the T3 value becomes the smallest value among the
Remaining Time fields of the IIH packets. If the T3 timer expires, GR fails.
The entire system maintains a T3 timer.
Session Mechanism
For differentiation, GR triggered by the master/slave switchover or the restart of
an IS-IS process is referred to as restarting. In restarting, the FIB table remains
unchanged. GR triggered by router restart is referred to as starting. In starting, the
FIB table is updated.
The following describes the process of IS-IS GR in restarting and starting modes:
● Figure 7-21 shows the process of IS-IS restarting.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 506
Figure 7-21 IS-IS restarting
a. After performing the protocol restart, the GR restarter performs the
following actions:
▪ Starts T1, T2, and T3 timers.
▪ Sends IIH packets that contain the restart TLV from all interfaces. In
such a packet, RR is set to 1, and RA and SA are set to 0.
b. After receiving an IIH packet, the GR helper performs the following
actions:
▪ Maintains the neighbor relationship and refreshes the current
Holdtime.
▪ Replies with an IIH packet containing the restart TLV. In the packet,
RR is set to 0; RA is set to 1, and the value of the Remaining Time
field indicates the period from the current moment to the timeout of
the Holdtime.
▪ Sends CSNPs and all LSPs to the GR restarter.
NOTE
On a P2P link, a neighbor must send CSNPs.
On a multicast link, only the neighbor of the DIS sends CSNPs. If the DIS is
restarted, a temporary DIS is elected from the other routers on the LAN.
If the neighbor does not have the GR helper capability, it ignores the
restart TLV and resets the adjacency with the GR restarter according to
normal IS-IS processing.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 507
c. After the GR restarter receives the IIH response packet, in which RR is set
to 0 and RA is set to 1, from the neighbor, it performs the following
actions:
▪ Compares the current value of the T3 timer with the value of the
Remaining Time field in the packet. The smaller value is taken as the
value of the T3 timer.
▪ Deletes the T1 timer maintained by the interface that receives the
ACK packet and CSNPs.
▪ If the interface does not receive the ACK packet or CSNPs, the GR
restarter constantly resets the T1 timer and resends the IIH packet
that contains the restart TLV. If the number of timeouts of the T1
timer exceeds the threshold value, the GR restarter forcibly deletes
the T1 timer and turns to the normal IS-IS processing to complete
LSDB synchronization.
d. After the GR restarter deletes the T1 timers on all interfaces, the
synchronization with all neighbors is complete when the CSNP list is
cleared and all LSPs are collected. The T2 timer is then deleted.
e. After the T2 timer is deleted, the LSDB of the level is synchronized.
▪ In the case of a Level-1 or Level-2 router, SPF calculation is triggered.
▪ In the case of a Level-1-2 router, determine whether the T2 timer on
the router of the other level is also deleted. If both T2 timers are
deleted, SPF calculation is triggered. Otherwise, the router waits for
the T2 timer of the other level to expire.
f. After all T2 timers are deleted, the GR restarter deletes the T3 timer and
updates the FIB table. The GR restarter re-generates the LSPs of each
level and floods them. During LSDB synchronization, the GR restarter
deletes the LSPs generated before restarting.
g. At this point, the IS-IS restarting of the GR restarter is complete.
● The starting device does not retain the FIB table. The starting device depends
on the neighbors, whose adjacency with itself is Up before it starts, to reset
their adjacency and suppress the neighbors from advertising their adjacency.
The IS-IS starting process is different from the IS-IS restarting process, as
shown in Figure 7-22.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 508
Figure 7-22 IS-IS starting
a. After the GR restarter is started, it performs the following actions:
▪ Starts the T2 timer for the synchronization of LSDBs of each level.
▪ Sends IIH packets that contain the restart TLV from all interfaces.
If RR in the packet is set to 0, a router is started.
If SA in the packet is set to 1, the router requests its neighbor to
suppress the advertisement of their adjacency before the neighbor
receives the IIH packet in which SA is set to 0.
b. After the neighbor receives the IIH packet that carries the restart TLV, it
performs the following actions depending on whether GR is supported:
▪ GR is supported.
Re-initiates the adjacency.
Deletes the description of the adjacency with the GR restarter from
the sent LSP. The neighbor also ignores the link connected to the GR
restarter when performing SPF calculation until it receives an IIH
packet in which SA is set to 0.
▪ GR is not supported.
Ignores the restart TLV and resets the adjacency with the GR
restarter.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 509
Replies with an IIH packet that does not contain the restart TLV. The
neighbor then returns to normal IS-IS processing. In this case, the
neighbor does not suppress the advertisement of the adjacency with
the GR restarter. On a P2P link, the neighbor also sends a CSNP.
c. After the adjacency is re-initiated, the GR restarter re-establishes the
adjacency with the neighbors on each interface. When an adjacency set
on an interface is in the Up state, the GR restarter starts the T1 timer for
the interface.
d. After the T1 timer expires, the GR restarter sends an IIH packet in which
both RR and SA are set to 1.
e. After the neighbor receives the IIH packet, it replies with an IIH packet, in
which RR is set to 0 and RA is set to 1, and sends a CSNP.
f. After the GR restarter receives the IIH ACK packet and CSNP from the
neighbor, it deletes the T1 timer.
If the GR restarter does not receive the IIH packet or CSNP, it constantly
resets the T1 timer and resends the IIH packet in which RR and SA are set
to 1. If the number of the timeouts of the T1 timer exceeds the threshold
value, the GR restarter forcibly deletes the T1 timer and turns to the
normal IS-IS processing to complete LSDB synchronization.
g. After receiving the CSNP from the helper, the GR restarter synchronizes
the LSDB.
h. After the LSDB of this level is synchronized, the T2 timer is deleted.
i. After all T2 timers are deleted, the SPF calculation is started and LSPs are
regenerated and flooded.
j. At this point, the IS-IS starting of the GR restarter is complete.
7.2.13 BFD for IS-IS
In IS-IS, the interval for sending Hello packets is 10s, and the holddown time for
keeping the neighbor relationship is three times the interval for sending Hello
packets. If a router does not receive a Hello packet from its neighbor within the
holddown time, the router deletes the corresponding neighbor relationship. This
indicates that the router detects neighbor faults in seconds. Second-level fault
detection, however, may result in heavy packet loss on high-speed networks.
Bidirectional forwarding detection (BFD) provides light-load and millisecond-level
link fault detection to prevent heavy packet loss. BFD is not used to substitute the
Hello mechanism of IS-IS but helps IS-IS rapidly detect the faults on neighbors or
links and instructs IS-IS to recalculate routes for packet forwarding.
In Figure 7-23, basic IS-IS functions are configured on every router, and BFD for
IS-IS is enabled on RouterA and RouterB.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 510
Figure 7-23 BFD for IS-IS
When a fault occurs on the primary link, BFD fast detects the fault and reports it
to IS-IS. IS-IS sets the neighbors of the interface on the faulty link to Down, which
triggers topology calculation, and updates LSPs so that neighbors such as RouterC
can receive the updated LSPs from RouterB. This process implements fast network
convergence.
Classification of BFD for IS-IS
BFD for IS-IS includes static BFD for IS-IS and dynamic BFD for IS-IS.
Table 7-5 Two implementation modes for BFD for IS-IS
Impleme
ntation
Mode
Principles Differences
Static
BFD for
IS-IS
BFD session parameters,
including local and remote
discriminators, are manually
configured using commands,
and the requests for
establishing BFD sessions are
manually delivered.
● Static BFD can be manually
controlled and is easy to deploy.
To save memory and ensure
reliability of key links, deploy
BFD on specified links.
● Establishing and deleting BFD
sessions need to be manually
triggered and lack flexibility.
Configuration errors may occur.
For example, if an incorrect local
or remote discriminator is
configured, a BFD session
cannot work properly.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 511
Impleme
ntation
Mode
Principles Differences
Dynamic
BFD for
IS-IS
BFD sessions are dynamically
created but not manually
configured. When detecting
faults, BFD informs IS-IS of
the faults through the routing
management (RM) module.
IS-IS then turns the neighbors
Down, rapidly advertises the
changed LSPs, and performs
incremental SPF. This
implements fast route
convergence.
Dynamic BFD is more flexible than
static BFD. In dynamic BFD, routing
protocols trigger the setup of BFD
sessions, preventing the
configuration errors caused by
manual configuration. Dynamic
BFD is easy to configure and
applies to the scenarios where BFD
needs to be configured on the
entire network.
NOTE
BFD uses local and remote discriminators to differentiate multiple BFD sessions between
the same pair of systems.
Because IS-IS establishes only single-hop neighbors, BFD for IS-IS detects only single-hop
links between IS-IS neighbors.
Establishment and Deletion of BFD Sessions
The RM module provides related services for association with the BFD module for
IS-IS. Through RM, IS-IS prompts BFD to set up or tear down BFD sessions by
sending notification messages. In addition, BFD events are transmitted to IS-IS
through RM.
Conditions for setting up a BFD session
● Basic IS-IS functions are configured on each router and IS-IS is enabled on the
interfaces of the routers.
● BFD is globally enabled on each router, and BFD is enabled on a specified
interface or process.
● BFD is enabled on interfaces or processes, and the neighbors are Up. A DIS
needs to be elected on a broadcast network.
Process of setting up a BFD session
● P2P network
After the conditions for setting up a BFD session are satisfied, IS-IS instructs
BFD through RM to directly set up a BFD session between neighbors.
● Broadcast network
After the conditions for establishing BFD sessions are met, and the DIS is
elected, IS-IS instructs BFD through RM to establish a BFD session between
the DIS and each router. No BFD session is established between non-DISs.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 512
NOTE
On a broadcast network, routers (including non-DIS routers) of the same level on a
network segment can establish neighbor relationships. In the implementation of BFD
for IS-IS, however, BFD sessions are established only between a DIS and a non-DIS. On
a P2P network, BFD sessions are directly established between neighbors.
If a Level-1-2 neighbor relationship is set up between two routers on a link, IS-IS sets
up two BFD sessions for the Level-1 and Level-2 neighbors on a broadcast network,
but sets up only one BFD session on a P2P network.
Conditions for tearing down a BFD session
● P2P network
When a neighbor relationship that was set up on P2P interfaces by IS-IS is
down (that is, the neighbor relationship is not in the Up state) or when the IP
protocol type of a neighbor is deleted, IS-IS tears down the BFD session.
● Broadcast network
When a neighbor relationship that was set up on P2P interfaces by IS-IS is
torn down (that is, the neighbor relationship is not in the Up state), when the
IP protocol type of a neighbor is deleted, or when the DIS is re-elected, IS-IS
tears down the BFD session.
NOTE
After dynamic BFD is globally disabled in an IS-IS process, the BFD sessions on all the
interfaces in this IS-IS process are deleted.
IS-IS Responding to BFD Session Down Event
When detecting a link failure, BFD generates a Down event, and then notifies RM
of the event. RM then instructs IS-IS to delete the neighbor relationship. IS-IS
recalculates routes to speed up route convergence on the entire network.
When both the local router and its neighbor are Level-1-2 routers, they establish
two neighbors of different levels. Then IS-IS establishes two BFD sessions for the
Level-1 neighbor and Level-2 neighbor respectively. When BFD detects a link
failure, it generates a Down event and informs the RM module of the event. The
RM module then instructs IS-IS to delete the neighbor relationship of a specific
level.
7.2.14 IS-IS Auto FRR
With the development of networks, the Voice over IP (VoIP) and on-line video
services require high-quality real-time transmission. Nevertheless, if an IS-IS fault
occurs, multiple processes, including fault detection, LSP update, LSP flooding,
route calculation, and FIB entry delivery, must be performed to switch traffic to a
new link. This results in a lengthy traffic interruption, which cannot meet the
requirement for real-time services.
Complying with RFC 5286 (Basic Specification for IP Fast Reroute Loop-Free
Alternates), IS-IS Auto FRR protects traffic when links or nodes become faulty. IS-
IS Auto FRR allows the forwarding system to rapidly detect such faults and take
measures to restore services as soon as possible.
In most cases, you can bind BFD to IS-IS Auto FRR to ensure millisecond-level fault
recovery. When BFD detects a link fault on an interface, the BFD session goes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 513
Down, triggering FRR on the interface. Subsequently, traffic is switched from the
faulty link to the backup link, which protects services.
Principles
IS-IS Auto FRR pre-computes a backup link by using the Loop-Free Alternate (LFA)
algorithm, and then adds the backup link and the primary link to the forwarding
table. In the case of an IS-IS network failure, IS-IS Auto FRR can fast switch traffic
to the backup link before routes on the control plane converge. This ensures
normal transmission of traffic and improves the reliability of the IS-IS network.
The backup link is calculated through the LFA algorithm. With the neighbor that
can provide the backup link being the root, the shortest path to the destination
node is calculated by a device through the SPF algorithm. Then, the loop-free
backup link is calculated according to the inequality defined in RFC 5286.
IS-IS Auto FRR can filter backup routes that need to be added to the IP routing
table. Only the backup routes matching the filtering policy are added to the IP
routing table. In this manner, users can flexibly control the addition of IS-IS
backup routes to the IP routing table.
Applications
IS-IS Auto FRR support traffic engineering (TE) links, including the following types:
● IP protecting TE
As shown in Figure 7-24, the TE tunnel has the smallest IS-IS cost among the
paths from RouterS to RouterD. Therefore, RouterS selects the TE tunnel as
the primary path to RouterD. The path RouterS->RouterN->RouterD has the
second smallest cost. According to the LFA algorithm, RouterS selects the path
RouterS->RouterN->RouterD as the backup path. The outbound interface of
the backup path is the interface that connects RouterS to RouterN.
NOTE
If the outbound interface of the backup link is the actual outbound interface of the TE
tunnel, IP protecting TE fails.
Figure 7-24 IP protecting TE
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 514
● TE protecting IP
As shown in Figure 7-25, the physical path RouterS-->RouterN-->RouterD has
the smallest IS-IS metric among the paths from RouterS to RouterD.
Therefore, RouterS prefers the path RouterS-->RouterN-->RouterD as the
primary path from RouterS to RouterD. The IS-IS cost of the TE tunnel is 12,
and the explicit path of the TE tunnel is the direct link from RouterS to
RouterD. The IS-IS metric of the direct link from RouterS to RouterD is 13,
which is greater than the IS-IS metric of the TE tunnel. Therefore, IS-IS selects
the TE tunnel as the backup path. TE protecting IP is implemented.
Figure 7-25 TE protecting IP
IS-IS Auto FRR traffic protection is classified into link protection and link-node dual
protection.
Figure 7-26 IS-IS Auto FRR link protection
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 515
Figure 7-27 IS-IS Auto FRR link-node dual protection
Table 7-6 IS-IS Auto FRR traffic protection
Traff
ic
Pro
tec
tio
n
Ty
pe
Object
Protect
ed
Condition Application Example
Lin
k
pro
tec
tio
n
Traffic
passing
through
a
specific
link
The link cost must satisfy the
following inequality:
Distance_opt(N,D) <
Distance_opt(N,S) +
Distance_opt(S,D)
In Figure 7-26, traffic is
transmitted from RouterS
to RouterD. The link cost
satisfies the link
protection inequality.
When the primary link
fails, RouterS switches
the traffic to the backup
link RouterS->RouterN so
that the traffic can be
further transmitted along
downstream paths. This
ensures that the traffic
interruption time is
within 50 ms.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 516
Traff
ic
Pro
tec
tio
n
Ty
pe
Object
Protect
ed
Condition Application Example
Lin
k-
no
de
du
al
pro
tec
tio
n
Next-
hop
node or
link
from
the local
node to
the
next-
hop
node.
Node
protecti
on takes
precede
nce over
link
protecti
on.
Link-node dual protection must
satisfy the following conditions:
● The link cost must satisfy the
following inequality:
Distance_opt(N,D) <
Distance_opt(N,S) +
Distance_opt(S,D)
● The interface cost of the router
must satisfy the following
inequality:
Distance_opt(N,D) <
Distance_opt(N,E) +
Distance_opt(E,D)
In Figure 7-27, traffic is
transmitted along the
path RouterS->RouterE-
>RouterD. The link cost
satisfies the link
protection inequality.
When RouterE or the link
between RouterS and
RouterE fails, RouterS
switches the traffic to the
backup link RouterS-
>RouterN so that the
traffic can be further
transmitted along
downstream paths. This
ensures that the traffic
interruption time is
within 50 ms.
NOTE
In Table 7-6, Distance_opt(X,Y) indicates the cost of the optimal path between node X and
node Y. S indicates the source node of traffic; E indicates the faulty node; N indicates the
node on the backup link; D indicates the destination node of traffic.
7.2.15 IS-IS TE
Conventional routers select the shortest path as the primary route regardless of
other factors, such as bandwidth. In this manner, traffic is not switched to other
paths even if a path is congested. MPLS traffic engineering (TE) has advantages in
solving the problem of network congestion. With MPLS TE, you can precisely
control the traffic path and prevent traffic from passing through congested nodes.
MPLS TE can reserve resources to ensure the quality of services during the
establishment of LSPs.
To ensure service continuity, MPLS TE introduces the route backup and fast reroute
(FRR) mechanisms to switch traffic in time when a link is faulty. MPLS TE allows
service providers (SPs) to fully utilize existing network resources to provide
diversified services. In addition, network resources can be optimized for scientific
network management.
To accomplish the preceding tasks, MPLS TE needs to learn TE information about
all devices on the network. However, MPLS TE lacks a mechanism in which each
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 517
device floods its TE information throughout the entire network for TE information
synchronization. However, IS-IS does provide such a mechanism. Therefore, MPLS
TE can advertise and synchronize TE information with the help of IS-IS.
IS-IS TE is an extension of IS-IS to support MPLS TE and complies with RFC 5305.
IS-IS TE defines new TLVs in IS-IS LSPs to carry TE information and floods LSPs to
flood and synchronize TE information. It extracts TE information from all LSPs and
then transmits the TE information to the Constraint Shortest Path First (CSPF)
module of MPLS for tunnel path calculation. IS-IS TE plays the role of a porter in
MPLS TE. Figure 7-28 shows the relationships between IS-IS TE, MPLS TE, and
CSPF.
Figure 7-28 Relationships between MPLS TE, CSPF, and IS-IS TE
New TLVs in IS-IS TE
To carry TE information in LSPs, IS-IS TE defines the following TLVs in RFC 5305:
● Extended IS reachability TLV
This TLV takes the place of IS reachability TLV and extends the TLV formats
with sub-TLVs. Sub-TLVs are implemented in TLVs in the same manner as TLVs
are implemented in LSPs. Sub-TLVs are used to carry TE information
configured on physical interfaces.
NOTE
Currently, all sub-TLVs defined in RFC 5305 are supported.
Table 7-7 Sub-TLVs defined in Extended IS reachability TLV
Name Type Length (Byte) Value
Administrative Group 3 4 Indicates the
administrative group.
IPv4 Interface Address 6 4 Indicates the IPv4
address of a local
interface.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 518
Name Type Length (Byte) Value
IPv4 Neighbour Address 8 4 Indicates the IPv4
address of a neighbor
interface.
Maximum Link
Bandwidth
9 4 Indicates the maximum
bandwidth of a link.
Maximum Reserved
Link Bandwidth
10 4 Indicates the maximum
reserved bandwidth of a
link.
Unreserved Bandwidth 11 32 Indicates the unreserved
bandwidth.
Traffic Engineering
Default Metric
18 3 Indicates the default
metric of TE.
Bandwidth Constraints
sub-TLV
22 36 Indicates the TLV of the
bandwidth constraint.
● Traffic Engineering router ID TLV
It is of TLV type 134, with a 4-byte Router ID. It is used as the MPLS LSR ID. In
MPLS TE, a Router ID uniquely identifies a router. Each router has a Router ID.
● Extended IP reachability TLV
This TLV takes the place of IP reachability TLV and carries routing information.
It extends the length of the route cost field and carries sub-TLVs.
● Shared Risk Link Group TLV
It is of TLV type 138 and used to carry information about the shared risk link
group. This TLV can carry information about multiple shared links, each of
which is a 4-byte positive integer.
IS-IS TE Implementation
IS-IS TE is implemented in two stages:
● Respond to MPLS TE configurations.
IS-IS TE functions only after MPLS TE is enabled.
IS-IS TE updates the TE information in IS-IS LSPs based on MPLS TE
configurations.
IS-IS TE transmits MPLS TE configurations to the CSPF module.
● Handle TE information in LSPs.
IS-IS TE extracts TE information from IS-IS LSPs and transmits the TE
information to the CSPF module.
In typical applications, IS-IS TE helps MPLS TE set up TE tunnels. As shown in
Figure 7-29, a TE tunnel is set up between RouterA and RouterD.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 519
Figure 7-29 IS-IS TE networking
The networking configuration is as follows:
● Enable MPLS TE on RouterA, RouterB, RouterC, and RouterD and enable
MPLS TE CSPF on RouterA to calculate the tunnel path.
● Run IS-IS and enable IS-IS TE on RouterA, RouterB, RouterC, and RouterD to
implement communication between the four routers.
After the preceding configuration is complete, IS-IS on RouterA, RouterB, RouterC,
and RouterD sends LSPs carrying TE information configured on each router.
RouterA then obtains the TE information of RouterB, RouterC, and RouterD from
the received LSPs. The CSPF module can calculate the path required by the TE
tunnel based on the TE information on the entire network.
Route Calculation on TE Tunnel Interfaces
IS-IS Shortcut (AA) and IS-IS Advertise (FA) calculate routes through TE tunnel
interfaces. For traffic transmitted through a specific route, MPLS guarantees
reliable forwarding whereas IP is less reliable. MPLS forwarding is achieved when
IS-IS Shortcut (AA) and IS-IS Advertise (FA) are configured, with TE tunnel
interfaces involved in route calculation and defined as the outbound interfaces of
specific routes.
Figure 7-30 Principle of IS-IS Shortcut (AA) and Advertise (FA)
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 520
IS-IS Shortcut (AA) and IS-IS Advertise (FA) have the following differences:
● IS-IS Advertise (FA) advertises TE tunnel information to other ISs, whereas IS-
IS Shortcut (AA) does not.
As shown in Figure 7-30, if the TE tunnel is enabled with IS-IS Advertise (FA),
RouterA advertises information indicating that RouterC is its neighbor. The
neighbor information is carried in TLV type 22 with no sub-TLVs. That is, no TE
information is carried. If the TE tunnel is enabled with IS-IS Shortcut (AA),
RouterA does not advertise such information.
● IS-IS Advertise (FA) affects the SPF tree of other routers, whereas IS-IS
Shortcut (AA) does not.
IS-IS Shortcut (AA) does not affect the original structure of the IS-IS SPF tree,
irrespective of whether a TE tunnel exists or not. Apart from the link from
RouterA to RouterB, and that from RouterB to RouterC, a link marked with
Shortcut from RouterA to RouterC is added. The link marked with Shortcut
participates in route calculation.
If the TE tunnel is enabled with IS-IS Advertise (FA), RouterA advertises the
message that "RouterC is a neighbor of RouterA" to other routers on the
network. Other routers then consider RouterC a neighbor of RouterA and add
RouterC to the SPF tree without marking it with Shortcut.
● IS-IS Advertise (FA) does not support a relative metric, whereas IS-IS Shortcut
(AA) does.
IS-IS Shortcut (AA) supports an absolute metric and a relative metric.
If you use an absolute metric, the metric value of TE tunnels in IS-IS is fixed. If
you use a relative metric, the metric value of TE tunnels in IS-IS is the sum of
the physical link cost and relative metric. As shown in Figure 7-30, if the
relative metric is set to 1, the cost of the path from RouterA to RouterC
through the TE tunnel is 21 (10+10+1). If the relative metric is set to 0, the TE
tunnel and physical link are of equal-cost on the outbound interface. If the
relative metric is less than 0, the TE tunnel interface is preferred as the
outbound interface.
● IS-IS Advertise (FA) requires bidirectional TE tunnels, whereas IS-IS Shortcut
(AA) requires only unidirectional tunnels.
7.2.16 IS-IS Local MT
IS-IS local multicast-topology (MT) creates a separate multicast topology on the
local device, without affecting the protocol packets exchanged between devices, to
allow both TE tunnels and multicast to be configured on the backbone network.
NOTE
The mentioned TE tunnel specifies the TE tunnel enabled with IGP Shortcut (AA).
Background
When multicast and an MPLS TE tunnel are deployed in a network simultaneously,
the multicast function may be affected by the TE tunnel.
This is because after the TE tunnel is enabled with IS-IS Shortcut (AA), the
outbound interface of a route calculated by an IS-IS is not the actual physical
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 521
interface but a TE tunnel interface. According to the unicast route to the multicast
source address, a router sends a Report message through a TE tunnel interface.
Routers spanned by the TE tunnel cannot sense the Report message, so multicast
forwarding entries cannot be created. The TE tunnel is unidirectional, so multicast
data packets sent by the multicast source are sent to the routers spanned by the
tunnel through the related physical interfaces. The routers do not have any
multicast forwarding entry. Therefore, the multicast data packets are discarded.
Figure 7-31 TE tunnel scenario
As shown in Figure 7-31, RouterA, RouterB, RouterC, RouterD, and RouterE are
Level-2 routers. The routers run IS-IS to implement interconnection. The multicast
services are normal. A unidirectional MPLS TE tunnel is set up between RouterB
and RouterD. The MPLS TE tunnel is enabled with IS-IS Shortcut (AA). When you
view the multicast routing table on RouterC spanned by the TE tunnel, you cannot
find any multicast forwarding entry. Therefore, the multicast services are
interrupted.
The process of transmitting multicast packets between the client and the multicast
server is as follows:
1. To join a multicast group, the client sends a Report message to RouterA.
RouterA then sends a Join message to RouterB.
2. When the Join message reaches RouterB, RouterB uses Tunnel 1/0/0 as the
Reverse Path Forwarding (RPF) interface and forwards the message to
RouterC through GE 2/0/0 by using the MPLS label.
3. The Join message is forwarded with the MPLS label, so RouterC just forwards
the message and does not create a multicast routing entry. In the topology
shown in Figure 7-31, RouterC is the penultimate hop of the MPLS
forwarding. RouterC pops out the MPLS label, and then forwards the Join
message to RouterD through GE 2/0/0.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 522
4. After receiving the Join message, RouterD creates a multicast forwarding
entry. The inbound interface is GE 2/0/0 and the outbound interface is GE
1/0/0. RouterD then forwards the message to RouterE. The SPT is set up.
5. When the multicast source sends the traffic to RouterD, RouterD forwards the
traffic to RouterC. RouterC does not create any forwarding entry in advance.
Therefore, the traffic is discarded and the multicast service is interrupted.
As described in the preceding process of transmitting multicast packets, the
forwarding of multicast packets relies on the unicast routing table, and the TE
tunnel is unidirectional. Therefore, the multicast packets are discarded. This
problem can be avoided by using the following methods:
● Manually configuring static multicast routes to guide the forwarding of
multicast packets.
● Configuring a bidirectional TE tunnel. In this case, the returned multicast
packets can be sent by using the same tunnel. Routers spanned by the TE
tunnel use the tunnel to transmit multicast packets.
● Configuring the Multicast Border Gateway Protocol (MBGP) to separate the
unicast topology from the multicast topology. MBGP provides the topology
that does not contain the TE tunnel for multicast separately. Multicast is used
to perform RPF check on MBGP routes.
● Configuring local MT
The preceding methods are used to prevent the interruption of multicast services.
The disadvantage of the first three methods is that a lot of manual configurations
need to be done. As a result, if the network is complex, the planning,
configuration, and maintenance tasks become heavier. Therefore, in the preceding
network environment, local MT needs to be configured.
Principles
Local MT creates a separate multicast topology on the local device, without
affecting the protocol packets exchanged between devices. This ensures that
multicast services are still available when both multicast and the MPLS TE tunnel
enabled with IGP Shortcut are deployed.
After local MT is enabled, the router at the ingress of a TE tunnel creates a
separate multicast IGP (MIGP) routing table to store the physical interfaces
corresponding to the TE tunnel. This ensures that multicast protocol packets are
correctly forwarded. The correct routing entries are created in the multicast
routing table (MRT). The implementation of local MT can be divided into two
stages:
● Create an MIGP routing table.
Multicast protocol packets are forwarded according to the unicast routing
table. After local MT is enabled on RouterB, RM creates separate MIGP
routing tables for multicast protocols. When the outbound interface of a route
is a TE tunnel interface, an IGP calculates the actual physical outbound
interface for the route and adds the outbound interface to the MIGP routing
table.
● Guide the forwarding of multicast protocol packets.
Before forwarding a multicast protocol packet, a router needs to search the
unicast routing table. If the router finds that the next hop is the TE tunnel, the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 523
router continues to search the MIGP routing table for the related physical
outbound interface to guide the forwarding of the multicast protocol packet.
Figure 7-32 Local MT Topology
As shown in Figure 7-32, if the outbound interface of multicast source
192.168.3.2/24 is TE tunnel 1/0/0, the physical outbound interface of the route
calculated by IS-IS is GE 2/0/0. IS-IS installs the route to the MIGP routing table.
The multicast services are not affected by the TE tunnel. Multicast packets are
forwarded through the physical outbound interfaces according to the MIGP
routing table for the general IP forwarding. The related routing entries are created
in the MRT. Multicast data packets are then correctly forwarded.
7.2.17 IS-IS Multi-Instance and Multi-Process
On a VPN-supporting device, you can associate multiple VPN instances with
multiple IS-IS processes to implement IS-IS multi-instance. IS-IS multi-process
allows you to create multiple IS-IS processes in the same VPN (or on the public
network). These IS-IS processes are independent of each other. Route exchange
between IS-IS processes is similar to route exchange between routing protocols.
Each IS-IS process can be bound to a specified VPN instance. A typical application
is as follows: In a VPN, IS-IS runs between PEs and CEs and also runs on the VPN
backbone network. On the PEs, the two IS-IS processes are independent of each
other.
IS-IS multi-instance and multi-process have the following characteristics:
● IS-IS multi-processes share an RM routing table. IS-IS multi-instances use the
RM routing tables in VPNs, and each VPN has its own RM routing table.
● IS-IS multi-process allows a set of interfaces to be associated with a specified
IS-IS process. This ensures that the specified IS-IS process performs all the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 524
protocol operations only on this set of interfaces. In this manner, multiple IS-
IS processes can work on a single router and each process is responsible for
managing a unique set of interfaces.
● When creating an IS-IS process, you can bind it to a VPN instance to associate
the IS-IS process with the VPN instance. The IS-IS process accepts and
processes only the events related to the VPN instance. When the bound VPN
instance is deleted, the IS-IS process is also deleted.
7.3 Default Settings for IPv4 IS-IS
Table 7-8 describes the default settings for IPv4 IS-IS.
Table 7-8 Default settings for IPv4 IS-IS
Parameter Default Setting
IS-IS Disabled
DIS priority 64
Device level Level-1-2
Interval for sending Hello packets 10s
Minimum interval for sending LSPs 50 ms
Maximum number of LSPs to be sent 10
Interval for updating LSPs 900s
Maximum lifetime of LSPs 1200s
Bandwidth reference value 100 Mbit/s
7.4 Summary of IPv4 IS-IS Configuration Tasks
Table 7-9 describes the IS-IS configuration tasks.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 525
Table 7-9 IS-IS configuration tasks
Scenario Description Task
Configuring basic IS-IS
functions
To deploy the IS-IS
protocol on IPv4
networks, configure basic
IS-IS functions to enable
communication between
different nodes on the
network. Other IS-IS
features can only be
configured after the
basic functions are
configured.
7.6 Configure Basic IS-
IS Functions
Configuring IS-IS
network security
On IS-IS networks,
unauthorized users can
attack the IS-IS network
by modifying data
packets or forging
authorized users. To
ensure security of
services carried on IS-IS
networks, configure area
or domain
authentication and
interface authentication.
7.7 Improving IS-IS
Network Security
Configuring IS-IS route
selection
If multiple redundant
links are available in the
network using the IS-IS
protocol, the route in the
IS-IS routing table may
not be the expected
optimal route. This does
not meet the network
planning and traffic
management
requirements. To
optimize the IS-IS
network and facilitate
traffic management,
more accurate control of
the routes on the
network is required.
7.8 Controlling IS-IS
Route Selection
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 526
Scenario Description Task
Configuring IS-IS routing
information exchange
In practical applications,
to meet network
requirements, configure
route policies to
accurately control
advertising and receiving
of IS-IS routing
information.
7.9 Controlling IS-IS
Route Exchange
Configuring IS-IS route
aggregation
Route aggregation
allows multiple routes
with the same IP prefix
to be aggregated into
one route.
Route aggregation on a
large IS-IS network can
effectively reduce entries
in the routing table. This
minimizes system
resource consumption
and facilitates
management. In
addition, if a link in the
aggregated IP address
segment frequently
alternates between Up
and Down, devices
outside this segment will
not be affected by the
change. This prevents
route flapping and
improves network
stability.
7.10 Configuring IS-IS
Route Summarization
Configuring IS-IS route
convergence
To enable IS-IS to rapidly
detect the network
changes, speed up the
IS-IS network
convergence. To
minimize the effect on
networks from route
flapping and reduce load
on the device, slow down
the IS-IS network
convergence.
7.11 Controlling IS-IS
Route Convergence
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 527
Scenario Description Task
Configuring LSP
fragment extension
When information
contained in the LSP
data packet Protocol
Data Unit (PDU) to be
advertised by IS-IS
increases greatly, the IS-
IS device will generate
multiple LSP fragments
to carry and advertise
more information.
7.12 Configuring LSP
Fragment Extension
Configuring mesh groups On the NBMA network,
when an interface of the
switch receives a new
LSP, the LSP is flooded to
other interfaces of the
switch. On highly-
connected networks that
have multiple P2P links,
this processing method
results in repeated LSP
flooding and wastes
bandwidth resources.
To solve this problem,
create a mesh group and
add some interfaces to
the group. The switch
never floods the LSPs
received at interfaces in
the mesh group to other
interfaces from the same
group, and only floods
the LSPs to interfaces
from other groups or
interfaces that are not
configured to any mesh
groups.
7.13 Configuring a
Mesh Group on an
NBMA Network
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 528
Scenario Description Task
Improving IS-IS reliability To ensure rapid recovery
from failures on
networks using the IS-IS
protocol, adopt the
solution of fast fault
detection and standby
link switchover. However,
the IS-IS fault detection
mechanism and link
switchover require a long
period of time, which
fails to meet the
requirements of services
that are highly sensitive
to packet loss and
packet delay.
To meet requirements of
these services, use BFD
for IS-IS to implement
fast fault detection and
use IS-IS GR helper to
implement fast
switchover. This improves
IS-IS reliability.
7.14 Configuring IS-IS
Reliability
Configuring IS-IS
overload
If the system cannot
store new LSPs or
synchronize the LSDB
normally, the calculated
routing information will
be incorrect. In this case,
the system can enter the
overload state. Routes
reached through the
device will not be
calculated, but routes
directly connected to the
device will not be
ignored.
When an IS-IS device on
the network requires
upgrade or maintenance,
the device needs to be
temporarily isolated
from the network. To
prevent other devices
from forwarding traffic
through this node, set
the overload bit for the
device in question.
7.16 Configuring the
Overload Bit for an IS-
IS Device
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 529
7.5 Licensing Requirements and Limitations for IPv4 IS-
IS
Involved Network Elements
Other network elements are required to support IPv4 IS-IS.
Licensing Requirements
IPv4 IS-IS is a basic feature of a switch and is not under license control.
Feature Support in V200R024C00
Only the following switch models support IPv4 IS-IS:
S5720I-SI, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S, S5731S-H,
S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and S6730S-
S
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
Feature Limitations
None.
7.6 Configure Basic IS-IS Functions
Pre-configuration Tasks
Before configuring basic IS-IS functions, configure IP addresses for interfaces to
ensure that neighboring nodes are reachable at the network layer.
Configuration Procedure
Creating an IS-IS process is the prerequisite for configuring a network entity title
(NET), configuring the device level, and establishing an IS-IS neighbor relationship.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 530
7.6.1 Creating IS-IS Processes
Context
Creating IS-IS processes is the prerequisite for performing IS-IS configurations.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ] [ vpn-instance
vpn-instance-name ]
An IS-IS process is created, and the IS-IS process view is displayed.
The
process-id parameter specifies the ID of an IS-IS process. If the
process-id is
not specified, the value of
process-id is 1 by default. To associate the IS-IS process
with a VPN instance, specify the VPN instance name.
Step 3 (Optional) Run description
description
A description is configured for the IS-IS process.
Step 4 (Optional) Enable IS-IS to add the POI and hostname TLV to Purge LSPs.
Run purge-originator-identification enable [ always ]
IS-IS is enabled to determine whether to add the POI TLV and hostname TLV to
Purge LSPs based on the authentication configuration.
● If the purge-originator-identification enable command is run and the send-
only parameter is specified when configuring authentication, generated Purge
LSPs do not carry the POI TLV or hostname TLV.
● If the purge-originator-identification enable command is run and MD5 or
HMAC-MD5 authentication is configured, generated Purge LSPs do not carry
the POI TLV or hostname TLV. If the purge-originator-identification enable
command is run and authentication of another type is configured or no
authentication is configured, generated Purge LSPs carry the POI TLV and
hostname TLV.
● If the purge-originator-identification enable always command is run,
generated Purge LSPs carry the POI TLV and hostname TLV, regardless of
whether authentication is configured or whether the send-only parameter is
specified when configuring authentication.
----End
7.6.2 Configuring a NET
Context
NET is the special form of the network service access point (NSAP). After the IS-IS
view is displayed, IS-IS can start only when a NET is configured for an IS-IS
process.
Generally, you only need to configure one NET for an IS-IS process. When an area
needs to be redefined, for example, the area needs to be merged with other areas
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 531
or divided into sub-areas, configure multiple NETs to ensure route correctness. A
maximum of three area addresses can be configured for an IS-IS process.
Therefore, a maximum of three NETs can be configured for an IS-IS process. When
configuring multiple NETs, ensure that their system IDs are the same.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS process view is displayed.
Step 3 Run network-entity
net
A NET is configured.
NOTE
Configuring loopback interface addresses based on NETs is recommended to ensure that a
NET is unique on the network. If NETs are not unique, route flapping will easily occur.
An area ID uniquely identifies an area in the same IS-IS domain. All routers in the same
Level-1 area must share the same area ID, while routers in the same Level-2 area can have
different area IDs.
----End
7.6.3 Configuring the Device Level
Context
Configure the device level according to network planning requirements:
● When the level of a device is Level-1, the device establishes neighbor
relationships with only Level-1 and Level-1-2 routers in the same area and
maintains only Level-1 LSDBs.
● When the level of a device is Level-2, the device can establish neighbor
relationship with Level-2 routers in the same area or different areas and with
Level-1-2 routers in different areas and maintain only Level-2 LSDB.
● When the level of a device is Level-1-2, the device can establish neighbor
relationships with Level-1 and Level-2 routers and maintain Level-1 and
Level-2 LSDBs.
NOTICE
If the levels of IS-IS devices are changed during network operation, the IS-IS
process will be restarted and IS-IS neighbor relationships will be disconnected.
Setting the levels of devices when configuring IS-IS is recommended.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 532
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS process view is displayed.
Step 3 Run is-level { level-1 | level-1-2 | level-2 }
The level of the switch is configured.
By default, the level of the switch is Level-1-2.
----End
7.6.4 Establishing IS-IS Neighbor Relationships
Context
The methods to establish IS-IS neighbor relationships on a broadcast network and
a P2P network are different. Therefore, you need to set different IS-IS attributes
for different types of interfaces:
● On a broadcast network, IS-IS needs to select the designated intermediate
system (DIS). You can set the DIS priority for IS-IS interfaces to enable the
device with the highest DIS priority to be elected as the DIS.
● On a P2P network, IS-IS does not need to select the DIS. Therefore, the DIS
priority does not need to be configured for interfaces. To ensure P2P link
reliability, configure IS-IS to establish a neighbor relationship on two P2P
interfaces in 3-way mode for unidirectional link fault detection.
Generally, IS-IS checks the IP addresses of received Hello packets. A neighbor
relationship can be established only when the source IP address carried in a
received Hello packet and the address of the interface that receives the Hello
packet are on the same network segment. If the IP addresses of the two P2P
interfaces are on different network segments, and the isis peer-ip-ignore
command is run on the two interfaces, IS-IS does not check the peer IP
address. The neighbor relationship can be correctly established on the two
P2P interfaces.
Procedure
● Establish an IS-IS neighbor relationship on a broadcast link.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 533
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run isis enable [
process-id ]
IS-IS is enabled on the interface.
After this command is run, IS-IS establishes neighbor relationships and
floods LSPs through this interface.
NOTE
Loopback interfaces are not used to establish neighbor relationships. If IS-IS is
enabled on a loopback interface, IS-IS advertises the routes of the network
segment where the interface resides through other IS-IS interfaces.
e. Run isis circuit-level [ level-1 | level-1-2 | level-2 ]
The level of the interface is configured.
By default, the level of an interface is level-1-2.
When two Level-1-2 devices establish an IS-IS neighbor relationship, they
establish both Level-1 and Level-2 neighbor relationships. To allow the
two Level-1-2 devices to establish only Level-1 or Level-2 neighbor
relationship, change the level of interfaces.
NOTE
Changing the level of an IS-IS interface is valid only when the level of the IS-IS
device is Level-1-2. If the level of the device is not Level-1-2, the level of the
device determines the level of the established neighbor relationship.
f. (Optional) Run isis dis-priority
priority [ level-1 | level-2 ]
The DIS priority is set for the interface. A larger value indicates a higher
priority.
By default, the DIS priority of Level-1 and Level-2 broadcast interfaces is
64.
Level-1-2 broadcast interfaces select the DIS using Level-1 and Level-2
separately. To select the DIS only for Level-1 or Level-2 interfaces, specify
the level.
g. (Optional) Run isis silent [ advertise-zero-cost ]
The interface is suppressed.
By default, an IS-IS interface is not suppressed.
When an IS-IS interface is suppressed, the interface no longer sends or
receives IS-IS packets. The routes of the network segment where the
interface resides, however, can still be advertised to other IS-IS devices
within the same AS.
h. (Optional) Configure a delay for the IS-IS neighbor relationship
establishment.
Run isis delay-peer track last-peer-expired [ delay-time
delay-
interval ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 534
A delay is configured for the IS-IS neighbor relationship establishment.
On an IS-IS network, if the IS-IS link has the network transmission delay
or transmission error, a few Hello packets may be lost or incorrectly
transmitted. In this case, the neighbor relationship frequently changes
between the Up and Down states, leading to route flapping.
By default,
delay-interval is 60s.
If a new
delay-interval is configured and it is less than the remaining
time of the ongoing delay, the new
delay-interval takes effect
immediately; if the new
delay-interval is greater than the remaining time
of the ongoing delay, the ongoing delay continues until the new
delay-
interval takes effect at the next delay.
● Establish an IS-IS neighbor relationship on a P2P link.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run isis enable [
process-id ]
IS-IS is enabled on the interface.
e. Run isis circuit-level [ level-1 | level-1-2 | level-2 ]
The level of the interface is configured.
By default, the level of an interface is level-1-2.
f. Run isis circuit-type p2p [ strict-snpa-check ]
The network type of the interface is set to P2P.
By default, the network type of an interface is determined by the physical
type of the interface.
When the network type of an IS-IS interface changes, the interface
configuration changes accordingly:
▪ After a broadcast interface is simulated as a P2P interface using the
isis circuit-type p2p [ strict-snpa-check ] command, the interval for
sending Hello packets, the number of Hello packets that IS-IS does
not receive from a neighbor before the neighbor is declared Down,
interval for resending LSPs on a P2P link, and various IS-IS
authentication modes are restored to the default settings; other
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 535
configurations such as the DIS priority, DIS name, and interval for
sending CSNPs on a broadcast network become invalid.
▪ After the undo isis circuit-type command is run to restore the
default network type of an IS-IS interface, the interval for sending
Hello packets, number of Hello packets that IS-IS does not receive
from a neighbor before the neighbor is declared Down, interval for
retransmitting LSPs on a P2P link, various IS-IS authentication
modes, DIS priority, and interval for sending CSNPs on a broadcast
network are restored to the default settings.
g. Run isis ppp-negotiation { 2-way | 3-way [ only ] }
The negotiation mode is specified for the interface.
By default, the negotiation mode is 3-way.
h. Run isis peer-ip-ignore
IS-IS is configured to not check the IP addresses of received Hello packets.
By default, IS-IS checks the IP addresses of received Hello packets.
i. Run isis ppp-osicp-check
OSICP negotiation status check is configured on the interface.
By default, the OSICP negotiation status of a PPP interface does not
affect the status of an IS-IS interface.
NOTE
This command applies only to PPP interfaces and is invalid for other P2P
interfaces.
After this command is run, the OSICP negotiation status of a PPP interface
affects the status of an IS-IS interface. When PPP detects that the OSI network
fails, the link status of the IS-IS interface goes Down and the routes of the
network segment where the interface resides are not advertised through LSPs.
j. (Optional) Configure a delay for the IS-IS neighbor relationship
establishment.
Run isis delay-peer track last-peer-expired [ delay-time
delay-
interval ]
A delay is configured for the IS-IS neighbor relationship establishment.
On an IS-IS network, if the IS-IS link has the network transmission delay
or transmission error, a few Hello packets may be lost or incorrectly
transmitted. In this case, the neighbor relationship frequently changes
between the Up and Down states, leading to route flapping.
By default,
delay-interval is 60s.
If a new
delay-interval is configured and it is less than the remaining
time of the ongoing delay, the new
delay-interval takes effect
immediately; if the new
delay-interval is greater than the remaining time
of the ongoing delay, the ongoing delay continues until the new
delay-
interval takes effect at the next delay.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 536
7.6.5 Verifying the Basic IS-IS Function Configuration
Procedure
● Run the display isis peer [ verbose ] [
process-id | vpn-instance
vpn-
instance-name ] command to check information about IS-IS neighbors.
● Run the display isis interface [ verbose ] [
process-id | vpn-instance
vpn-
instance-name ] command to check information about IS-IS interfaces.
● Run the display isis route [
process-id | vpn-instance
vpn-instance-name ]
[ ipv4 ] [ verbose | [ level-1 | level-2 ] |
ip-address [
mask |
mask-length ] ] *
command to check information about IS-IS routes.
----End
7.7 Improving IS-IS Network Security
Pre-configuration Tasks
Before improving IS-IS network security, configure basic IS-IS functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the IS-IS Network Security Optimization Configuration) in any sequence.
7.7.1 Configuring Interface Authentication
Context
Generally, IS-IS packets are sent without authentication information encapsulation,
and the received packets are not authenticated. If a user sends malicious packets
to attack a network, information on the entire network may be stolen. Therefore,
you can configure IS-IS authentication to improve network security.
After IS-IS interface authentication is configured, authentication information can
be encapsulated into Hello packets to confirm the validity and correctness of
neighbor.
NOTICE
If plain is selected during the configuration of the authentication mode for the IS-
IS interface, the password is saved in the configuration file in plain text. This
brings security risks. It is recommended that you select cipher to save the
password in cipher text.
Simple authentication and MD5 authentication have potential security risks.
HMAC-SHA256 or Keychain authentication mode is recommended.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 537
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run any of the following commands to configure the authentication mode of the
IS-IS interface as required:
● Run isis authentication-mode simple { plain
plain-text | [ cipher ]
plain-
cipher-text } [ level-1 | level-2 ] [ ip | osi ] [ send-only ]
Simple authentication is configured for the IS-IS interface.
● Run isis authentication-mode md5 { plain
plain-text | [ cipher ]
plain-
cipher-text } [ level-1 | level-2 ] [ ip | osi ] [ send-only ]
MD5 authentication is configured for the IS-IS interface.
● Run isis authentication-mode hmac-sha256 key-id
key-id { plain
plain-text |
[ cipher ]
plain-cipher-text } [ level-1 | level-2 ] [ send-only ]
HMAC-SHA256 authentication is configured for the IS-IS interface.
● Run isis authentication-mode keychain
keychain-name [ level-1 | level-2 ]
[ send-only ]
Keychain authentication is configured for the IS-IS interface.
By default, an IS-IS interface does not authenticate received Hello packets and no
authentication password is configured on the interface.
NOTE
Use the send-only parameter according to network requirements:
● If the send-only parameter is specified, the device only encapsulates the Hello packets
to be sent with authentication information rather than checks whether the received
Hello packets pass the authentication. When the Hello packets do not need to be
authenticated on the local device and pass the authentication on the remote device,
the two devices can establish the neighbor relationship.
● If the send-only parameter is not specified, ensure that passwords of all interfaces
with the same level on the same network are the same.
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support keychain
keychain-name.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 538
7.7.2 Configuring Area or Domain Authentication
Context
Generally, the IS-IS packets to be sent are not encapsulated with authentication
information, and the received packets are not authenticated. If a user sends
malicious packets to attack a network, information on the entire network may be
stolen. Therefore, you can configure IS-IS authentication to improve network
security.
The area authentication password is encapsulated into Level-1 IS-IS packets. Only
the packets that pass the area authentication can be accepted. Therefore, you
must configure IS-IS area authentication on all the IS-IS devices in the specified
Level-1 area to authenticate the Level-1 area.
The domain authentication password is encapsulated into Level-2 IS-IS packets.
Only the packets that pass the domain authentication can be accepted. Therefore,
you must configure IS-IS domain authentication on all the IS-IS devices in the
Level-2 area to authenticate Level-2 area.
NOTICE
If plain is selected during the configuration of the area authentication mode or
domain authentication mode, the password is saved in the configuration file in
plain text. This brings security risks. It is recommended that you select cipher to
save the password in cipher text.
Simple authentication and MD5 authentication have potential security risks.
HMAC-SHA256 or Keychain authentication mode is recommended.
Characters %^%# are used as the prefix and suffix of existing passwords with
variable lengths. Therefore, characters %^%# cannot be configured together at
the beginning or end of a cipher text password.
NOTE
When configuring IS-IS authentication, the area or domain authentication modes and
passwords of the routers in the same area must be consistent so that IS-IS packets can be
flooded normally.
Whether IS-IS packets can pass area or domain authentication does not affect the
establishment of Level-1 or Level-2 neighbor relationships.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS process view is displayed.
Step 3 Perform the following operations in any sequence as required.
● Run area-authentication-mode { { simple | md5 } { plain
plain-text |
[ cipher ]
plain-cipher-text } [ ip | osi ] | keychain
keychain-name | hmac-
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 539
sha256 key-id
key-id } [ snp-packet { authentication-avoid | send-only } |
all-send-only ]
The area authentication mode is configured.
By default, the system neither encapsulates generated Level-1 packets with
authentication information nor authenticates received Level-1 packets.
● Run domain-authentication-mode { { simple | md5 } { plain
plain-text |
[ cipher ]
plain-cipher-text } [ ip | osi ] | keychain
keychain-name | hmac-
sha256 key-id
key-id } [ snp-packet { authentication-avoid | send-only } |
all-send-only ]
The domain authentication mode is configured.
By default, the system neither encapsulates generated Level-2 packets with
authentication information nor authenticates received Level-2 packets.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support the keychain
keychain-name parameter.
The authentication involves the following situations:
● The device encapsulates the authentication mode into LSPs and SNPs to be sent and
checks whether the received packets pass authentication. Then, the device discards the
packets that do not pass the authentication. In this case, the parameter snp-packet or
all-send-only is not specified.
● The device encapsulates authentication information into LSPs to be sent and checks
whether the received LSPs pass the authentication; the device neither encapsulates the
SNPs to be sent with authentication information nor checks whether the received SNPs
pass the authentication. In this case, the parameter snp-packet authentication-avoid
needs to be specified.
● The device encapsulates the LSPs and SNPs to be sent with authentication information;
the device, however, checks the authentication mode of only the received LSPs rather
than the received SNPs. In this case, the parameter snp-packet send-only needs to be
specified.
● The device encapsulates the LSPs and SNPs to be sent with authentication information,
but does not check whether the received LSPs or SNPs pass the authentication. In this
case, the parameter all-send-only needs to be specified.
----End
7.7.3 Configuring the Optional Checksum
Context
When a network is running, Intermediate System to Intermediate System (IS-IS)
routers may be attacked or IS-IS packets may be modified. As a result, important
network information may be intercepted, causing serious loss to the network. The
optional checksum encapsulates optional checksum TLVs into the Complete
Sequence Numbers Protocol Data Units (CSNPs), Partial Sequence Number
Protocol Data Units (PSNPs), and Hello packets sent by IS-IS routers. When the
peer device receives the encapsulated packets, it checks whether TLVs carried in
the packets are correct. If TLVs are not correct, the peer device discards the
packets for network security.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 540
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis
An IS-IS process is created and the IS-IS view is displayed.
Step 3 Run optional-checksum enable
IS-IS optional checksum is enabled.
NOTE
If MD5 authentication or Keychain authentication with valid MD5 authentication is
configured on an IS-IS interface or area, IS-IS routers send Hello packets and SNP packets
carrying no checksum TLVs and verify the checksum of the received packets.
----End
7.7.4 Verifying the IS-IS Network Security Optimization
Configuration
Procedure
● Run the display isis lsdb verbose command to check the detailed information
in the IS-IS LSDB.
----End
7.8 Controlling IS-IS Route Selection
Pre-configuration Tasks
Before configuring IS-IS route selection, configure basic IS-IS functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the IS-IS Route Selection Control Configuration) in any sequence.
7.8.1 Configuring a Preference Value for IS-IS
Context
If multiple routes to the same destination are discovered by different routing
protocols running on the same device, the route discovered by the protocol with
the highest preference is selected.
To prefer a route discovered by IS-IS, configure a higher preference value for IS-IS.
In addition, a routing policy can be configured to increase the preferences of
specified IS-IS routes, without affecting route selection.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 541
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run preference {
preference | route-policy
route-policy-name } *
The IS-IS preference value is configured.
The default IS-IS preference value is 15. A smaller
preference value indicates a
higher preference.
----End
7.8.2 Configuring the Cost of an IS-IS Interface
Context
The costs of IS-IS interfaces can be determined in the following modes in
descending order of priority:
● Interface cost: is configured for a specified interface.
● Global cost: is configured for all interfaces.
● Automatically calculated cost: is automatically calculated based on the
interface bandwidth.
If no cost is configured for an IS-IS interface, the IS-IS interface uses the default
cost 10 and cost style narrow.
NOTICE
If you want to change the cost style of IS-IS devices, running the command while
configuring basic IS-IS functions is recommended. If the cost style of IS-IS devices
is changed during network operation, the IS-IS process is restarted and the
neighbor relationship is re-established.
Procedure
Step 1 Configure the IS-IS cost style.
1. Run system-view
The system view is displayed.
2. Run isis [
process-id ]
The IS-IS view is displayed.
3. Run cost-style { narrow | wide | wide-compatible | { narrow-compatible |
compatible } [ relax-spf-limit ] }
The IS-IS cost style is configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 542
By default, the cost style of routes received and sent by an IS-IS device is
narrow.
The cost range of an interface and a route received by the interface vary with the
cost type.
● If the cost style is narrow, the cost of an interface ranges from 1 to 63. The
maximum cost of a route received by the interface is 1023.
● If the cost style is narrow-compatible or compatible, the cost of an interface
ranges from 1 to 63. The cost of a received route is related to relax-spf-limit.
● If the cost style is wide-compatible or wide, the cost of the interface ranges
from 1 to 16777215. When the cost is 16777215, the neighbor TLV generated
on the link cannot be used for route calculation but for the transmission of TE
information. The maximum cost of a received route is 0xFFFFFFFF.
Step 2 Configure the cost of an IS-IS interface.
Perform any of the following operations to configure the cost of an IS-IS interface.
Configure the cost of a specified IS-IS interface.
1. Run system-view
The system view is displayed.
2. Run interface
interface-type interface-number
The interface view is displayed.
3. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
4. Run isis cost {
cost | maximum } [ level-1 | level-2 ]
The cost of the IS-IS interface is configured.
By default, the link cost of an IS-IS interface is 10.
NOTE
You can configure the parameter maximum only when the IS-IS cost style is wide or
wide-compatible.
To change the cost of a loopback interface, run the isis cost command only in the
loopback interface view.
Configure the global IS-IS cost.
1. Run system-view
The system view is displayed.
2. Run isis [
process-id ]
The IS-IS view is displayed.
3. Run circuit-cost {
cost | maximum } [ level-1 | level-2 ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 543
The global IS-IS cost is configured.
By default, no global cost is configured.
Enable IS-IS to automatically calculate the interface cost.
1. Run system-view
The system view is displayed.
2. Run isis [
process-id ]
The IS-IS view is displayed.
3. Run bandwidth-reference
value
The reference value of the bandwidth is configured. By default, the bandwidth
reference value is 100 Mbit/s.
4. Run auto-cost enable [ compatible ]
The interface is configured to automatically calculate its cost.
The bandwidth reference value set using the bandwidth-reference command
takes effect only when the cost style is wide or wide-compatible. In this case, the
interface cost is calculated using the following formula:
Cost of each interface = (Bandwidth-reference/Interface bandwidth) × 10
If the cost-style is narrow, narrow-compatible, or compatible, the cost of each
interface is calculated based on costs listed in Table 7-10.
Table 7-10 Mapping between IS-IS interface costs and interface bandwidth
Cost Bandwidth Range
60 Interface bandwidth ≤ 10 Mbit/s
50 10 Mbit/s < Interface bandwidth ≤ 100
Mbit/s
40 100 Mbit/s < Interface bandwidth ≤ 155
Mbit/s
30 155 Mbit/s < Interface bandwidth ≤ 622
Mbit/s
20 622 Mbit/s < Interface bandwidth ≤ 2.5
Gbit/s
10 2.5 Gbit/s < Interface bandwidth
----End
7.8.3 Configuring Equal-Cost IS-IS Routes
Context
If there are redundant IS-IS links, multiple routes may have an equal cost. Choose
either of the following methods to use these equal-cost IS-IS routes:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 544
● Configure load balancing for equal-cost IS-IS routes so that traffic will be
evenly balanced among these links.
This mechanism increases the link bandwidth usage and prevents network
congestion caused by link overload. However, this mechanism may make
traffic management more difficult because traffic will be randomly forwarded.
● Configure preference values for equal-cost IS-IS routes so that only the route
with the highest preference will be used and the others function as backups.
This configuration facilitates traffic management and improves the network
reliability, without the need to change original configurations.
Procedure
● Configure equal-cost IS-IS routes to work in load-balancing mode.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run maximum load-balancing
number
The maximum number of load-balancing equal-cost IS-IS routes is set.
By default, the maximum number of equal-cost routes on the S5720I-SI,
S5735-S, S5735-S-I, S5735S-H, S6720S-S, and S5736-S is 8, and the
maximum number of equal-cost routes on the S5731-H, S5731-S,
S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H, S6730-S,
and S6730S-S is 16.
NOTE
When the number of equal-cost routes is larger than the value specified in the
maximum load-balancing command, valid routes are selected for load
balancing based on the following criteria:
1. Route preference: Routes with lower preference values (higher preferences)
are selected for load balancing.
2. Next hop system ID: If routes have the same preference, routes with smaller
system IDs are selected for load balancing.
3. Interface index: If routes have the same preference and system ID, routes with
lower interface index values are selected for load balancing.
● Configure preference values for equal-cost IS-IS routes.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run nexthop
ip-address weight
value
A preference value is configured for an equal-cost IS-IS route.
By default, the preference value configured for equal-cost IS-IS routes is
255. A smaller value indicates a higher priority.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 545
7.8.4 Configuring IS-IS Route Leaking
Context
If multiple Level-1-2 devices in a Level-1 area are connected to devices in the
Level-2 area, a Level-1 LSP sent by each Level-1-2 device carries an ATT flag bit of
1. This Level-1 area will have multiple routes to the Level-2 area and to other
Level-1 areas.
By default, routes in a Level-1 area can be leaked into the Level-2 area so that
Level-1-2 and Level-2 devices can determine the topology of the entire network.
Devices in a Level-1 area are unaware of the entire network topology because
they only maintain LSDBs in the local Level-1 area. Therefore, a device in a Level-1
area can forward traffic to a Level-2 device only through the nearest Level-1-2
device. The route used may not be the optimal route to the destination.
To enable a device in a Level-1 area to select the optimal route, configure IPv4 IS-
IS route leaking so that specified routes in the Level-2 area can be leaked into the
local Level-1 area.
Routes of services deployed only in the local Level-1 area do not need to be
leaked into the Level-2 area. A policy can be configured to leak only desired routes
into the Level-2 area.
Procedure
● Specify routes in the Level-2 area and other Level-1 areas that can be leaked
into the local Level-1 area.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run import-route isis level-2 into level-1 [ tag
tag | filter-policy {
acl-
number | acl-name
acl-name | ip-prefix
ip-prefix-name | route-policy
route-policy-name } | direct { allow-filter-policy | allow-up-down-bit }
* ] *
Routes that meet the specified conditions in the Level-2 areas are leaked
into the local Level-1 area.
By default, routes in the Level-2 area are not leaked into Level-1 areas.
NOTE
The command is run on the Level-1-2 device that is connected to an external
area.
● Configure routes in Level-1 areas to leak into the Level-2 area.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 546
c. Run import-route isis level-1 into level-2 [ tag
tag | filter-policy {
acl-
number | acl-name
acl-name | ip-prefix
ip-prefix-name | route-policy
route-policy-name } | direct allow-filter-policy ] *
Routes that meet the specified conditions in Level-1 areas are leaked into
the Level-2 area.
By default, all routes in a Level-1 area are leaked into the Level-2 area.
NOTE
The command is run on the Level-1-2 device that is connected to an external
area.
----End
7.8.5 Controlling Whether a Level-1 Device Generates a IPv4
Default Route
Context
As defined in the IS-IS protocol, if a Level-1-2 device reaches more areas through a
Level-2 area than through a Level-1 area based on the link state database (LSDB),
the Level-1-2 device sets the ATT bit to 1 in the LSPs and sends the LSPs with the
ATT bit 1 to the Level-1 device. Upon receipt, the Level-1 device generates a
default route destined for the Level-1-2 device.
The preceding rules are used by default. You can set the ATT bit as required on a
live network.
Perform the following steps:
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run the following command as required:
● To set the ATT bit in the LSPs sent by the Level-1-2 device, run the attached-
bit advertise { always | never } command.
– If the always parameter is specified, the ATT bit is set to 1. After
receiving the LSPs carrying the ATT bit 1, the Level-1 device generates a
default route.
– If the never parameter is specified, the ATT bit is set to 0. After receiving
the LSPs carrying the ATT bit 0, the Level-1 device does not generate a
default route, which reduces the size of a routing table.
● To disable the Level-1 device from generating default routes even though it
receives the LSPs carrying the ATT bit 1, run the attached-bit avoid-learning
command.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 547
7.8.6 Verifying the IS-IS Route Selection Control Configuration
Procedure
● Run the display isis route [
process-id | vpn-instance
vpn-instance-name ]
[ ipv4 ] [ verbose | [ level-1 | level-2 ] |
ip-address [
mask |
mask-length ] ] *
command to check IS-IS routing information.
● Run the display isis lsdb [ { level-1 | level-2 } | verbose | { local |
lsp-id | is-
name
symbolic-name } ] * [
process-id | vpn-instance
vpn-instance-name ]
command to check information in the IS-IS LSDB.
----End
7.9 Controlling IS-IS Route Exchange
Pre-configuration Tasks
Before controlling IS-IS route exchange, configure basic IS-IS functions.
Configuration Flowchart
You can perform the following configuration tasks (excluding the task of Verifying
the IS-IS Route Exchange Control Configuration) in any sequence.
7.9.1 Configuring IS-IS to Advertise a Default Route
Context
If IS-IS is configured to advertise a default route on a border device that has
external routes, the device advertises a default route 0.0.0.0/0 in the IS-IS routing
domain. All traffic destined for other routing domains is first forwarded to the
border device.
Configuring a static default route can also allow all the traffic to be first
forwarded to a border device, which then forwards the traffic outside an IS-IS
routing domain. However, this method leads to heavy workload in configuration
and management when a large number of devices are deployed on the network.
In addition, advertising default routes using IS-IS is flexible. If multiple border
devices are deployed, a routing policy can be configured to allow only the border
device that meets the specified conditions to advertise a default route, preventing
routing blackholes.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 548
Step 3 Run default-route-advertise [ always | match default | route-policy
route-
policy-name ] [ cost
cost | tag
tag | [ level-1 | level-1-2 | level-2 ] ] * [ avoid-
learning ]
IS-IS is configured to advertise a default route.
By default, IS-IS does not advertise a default route.
----End
7.9.2 Configuring IS-IS to Import External Routes
Context
After IS-IS is configured to advertise a default route on a border device in an IS-IS
routing domain, all the traffic destined outside the IS-IS routing domain is
forwarded through the border device. This burdens the border device because
other devices in the IS-IS routing domain do not have the routes destined outside
the domain. If multiple border devices are deployed in the IS-IS routing domain,
optimal routes to other routing domains need to be selected.
To ensure optimal routes are selected, all the other devices in the IS-IS routing
domain must learn all or some external routes.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Configure IS-IS to import external routes.
● When you need to set the cost of imported routes, run the import-route
{ { rip | isis | ospf } [
process-id ] | static | direct | unr | bgp [ permit-ibgp ] }
[ cost-type { external | internal } | cost
cost | tag
tag | route-policy
route-
policy-name | [ level-1 | level-2 | level-1-2 ] ] * command to configure IS-IS
to import external routes.
● When you need to retain the original cost of imported routes, run the import-
route { { rip | isis | ospf } [
process-id ] | direct | unr | bgp } inherit-cost
[ tag
tag | route-policy
route-policy-name | [ level-1 | level-2 | level-1-2 ] ] *
command to configure IS-IS to import external routes. In this case, the source
routing protocol of imported routes cannot be static.
NOTE
IS-IS will advertise all imported external routes to the IS-IS routing domain by default.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 549
7.9.3 Configuring IS-IS to Advertise Specified External Routes
to an IS-IS Routing Domain
Context
When the local IS-IS device advertises imported external routes to other IS-IS
devices, routing policies can be configured to advertise only the external routes
that meet specified conditions if these devices do not require all the imported
external routes.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run filter-policy {
acl-number | acl-name
acl-name | ip-prefix
ip-prefix-name |
route-policy
route-policy-name } export [
protocol [
process-id ] ]
IS-IS is configured to advertise the external routes that meet specified conditions
to the IS-IS routing domain.
----End
7.9.4 Adding Specified IS-IS Routes to the IP Routing Table
Context
Only routes in an IP routing table can be used to forward IP packets. An IS-IS
route can take effect only after this IS-IS route has been successfully added to an
IP routing table.
If an IS-IS route does not need to be added to a routing table, specify conditions,
such as a basic ACL, IP prefix, and routing policy, to filter routes so that only IS-IS
routes that meet the specified conditions can be added to an IP routing table. IS-IS
routes that do not meet the specified conditions cannot be added to the IP routing
table and cannot be selected to forward IP packets.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run filter-policy {
acl-number | acl-name
acl-name | ip-prefix
ip-prefix-name |
route-policy
route-policy-name } import
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 550
Conditions for filtering IS-IS routes are configured.
----End
7.9.5 Verifying the IS-IS Route Exchange Control Configuration
Procedure
● Run the display isis lsdb [ { level-1 | level-2 } | verbose | { local |
lsp-id | is-
name
symbolic-name } ] * [
process-id | vpn-instance
vpn-instance-name ]
command to check IS-IS LSDB information.
● Run the display isis route [
process-id | vpn-instance
vpn-instance-name ]
[ ipv4 ] [ verbose | [ level-1 | level-2 ] |
ip-address [
mask |
mask-length ] ] *
command to check IS-IS routing information.
● Run the display ip routing-table [ verbose ] command to check the IP
routing table.
----End
7.10 Configuring IS-IS Route Summarization
Pre-configuration Tasks
Before configuring IS-IS route summarization, configure basic IS-IS functions.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run summary
ip-address mask [ avoid-feedback | generate_null0_route | tag
tag | [ level-1 | level-1-2 | level-2 ] ] *
The specified IS-IS routes are summarized into one IS-IS route.
NOTE
After route summarization is configured on a device, the local routing table still contains all
specific routes before the summarization. The routing tables on other devices contain only
the summary route, and the summary route is deleted only after all its specific routes are
deleted.
----End
Verifying the Configuration
● Run the display isis route command to check summary routes in the IS-IS
routing table.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 551
● Run the display ip routing-table [ verbose ] command to check summary
routes in the IP routing table.
7.11 Controlling IS-IS Route Convergence
Pre-configuration Tasks
Before configuring IS-IS route convergence, configure basic IS-IS functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the IS-IS Route Convergence Control Configuration) in any sequence.
7.11.1 Configuring Attributes for Hello Packets
Context
IS-IS maintains neighbor relationships between neighbors by sending and
receiving Hello packets. If the local device does not receive Hello packets from its
neighbor within a specified period, the device considers the neighbor Down.
In IS-IS, you can set the interval for sending Hello packets and the holding
multiplier of neighboring devices to control the holdtime of neighbor relationships
between the local device and neighbors.
● If the interval for sending Hello packets is too short, more system resources
are consumed to send Hello packets, causing a heavy CPU load.
● If the holdtime of neighboring devices is too long, the local device needs to
spend much time detecting the failure of neighbors, slowing down IS-IS route
convergence. If the holdtime of neighboring devices is too short, some Hello
packets may be lost or become incorrect because of network transmission
delay and errors. This will cause neighbor relationships to frequently alternate
between Up and Down and lead to route flapping on the IS-IS network.
NOTE
You are advised to set the same interval for sending Hello packets and same holding
multiplier of neighboring devices on all the devices on the IS-IS network. This method
prevents IS-IS route convergence from being slowed down when some devices detect
link failures at a lower speed than other devices.
Procedure
● Configure the interval for sending Hello packets.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 552
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run isis timer hello
hello-interval [ level-1 | level-2 ] [ conservative ]
The interval for sending Hello packets is set on an interface.
By default, the interval for sending Hello packets 10 seconds.
NOTE
Parameters level-1 and level-2 are configured only on broadcast interfaces.
On a broadcast link, there are Level-1 and Level-2 Hello packets. For different
types of packets, you can set different intervals. If no level is specified, both the
Level-1 timer and Level-2 timer are configured. On a P2P link, there is only one
type of Hello packets. Therefore, neither level-1 nor level-2 is required.
● Set the holding multiplier for neighboring devices.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run isis timer holding-multiplier
number [ level-1 | level-2 ]
The holding multiplier of neighboring devices is set.
The default holding multiplier is 3. The holdtime of neighbor
relationships is three times the interval for sending Hello packets.
NOTE
Parameters level-1 and level-2 are configured only on broadcast interfaces.
----End
7.11.2 Configuring Attributes for LSPs
Context
LSPs are used to exchange link state information. You can configure attributes for
LSPs to control the length and maximum lifetime of LSPs. To accelerate network
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 553
convergence, you can enable LSP fast flooding or reduce the minimum interval for
sending LSPs and the interval for updating LSPs to speed up LSP flooding.
However, too many CPU resources will be consumed if the network topology
changes frequently. In this situation, configure the intelligent timer for generating
LSPs. This timer can quickly respond to emergencies, speed up network
convergence, and improve CPU resource efficiency because its interval becomes
longer when the network changes frequently. The function and implementation of
different parameter configurations are shown in the following table.
Parameter
Configuratio
n
Function Implementation
Set the
maximum
length for
LSPs
Set the
size for
LSPs to be
generated
and LSPs
to be
received.
When the volume of link status information
increases, the length of LSPs to be generated can
be increased to carry more information in each LSP.
Set the
maximum
lifetime for
LSPs
Set the
maximum
lifetime
for LSPs to
ensure the
validity of
an LSP
before its
updated
LSP is
received.
When a switch generates the system LSP, it fills in
the maximum lifetime for this LSP. After this LSP is
received by other switches, the lifetime of the LSP
is reduced gradually. If the switch does not receive
any more update LSPs and the lifetime of the LSP is
reduced to 0, the LSP will be deleted from the LSDB
60s later if no more updated LSPs are received.
Set the
refresh
interval for
LSPs
Set the
refresh
interval
for LSPs to
synchroniz
e LSDBs.
On an IS-IS network, LSDB synchronization is
implemented through LSP flooding. During LSP
flooding, a switch sends an LSP to its neighbors
and then the neighbors send the received LSP to
their respective neighbors except the switch that
first sends the LSP. In this manner, the LSP is
flooded among the switches of the same level. LSP
flooding allows each switch of the same level to
have the same LSP information and synchronize its
LSDB with each other.
Set the
minimum
interval at
which LSPs
are sent
Set the
interval
for
sending
an LSP
during LSP
update.
Reducing the minimum interval for sending LSPs
speeds up LSP flooding.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 554
Parameter
Configuratio
n
Function Implementation
Configure
the
intelligent
timer used to
generate
LSPs
Control
the
interval
for
generating
LSPs
intelligentl
y to speed
up route
convergen
ce and
reduce
system
load.
On an IS-IS network, if the local routing
information changes, a switch needs to generate a
new LSP to notify this change. If the local routing
information changes frequently, a large number of
new LSPs are generated. This occupies a lot of
system resources and decreases system
performance. To speed up network convergence
and prevent system performance from being
affected, configure an intelligent timer for
generating LSPs. This timer can adjust the delay in
generating LSPs based on the routing information
change frequency.
Enable LSP
fast flooding
Control
the
number of
LSPs
flooded
each time
on an
interface
to speed
up IS-IS
network
convergen
ce.
When an IS-IS switch receives new LSPs from other
switches, it updates the LSPs in the local LSDB and
periodically floods out the updated LSPs according
to a timer. LSP fast flooding updates the preceding
method. When a device configured with LSP fast
flooding receives one or more new LSPs, it floods
out the LSPs with a number smaller than the
specified number before calculating routes. This
speeds up LSDB synchronization.
Set an
interval at
which LSPs
are
retransmitted
over a P2P
link
Control
the
interval
for
retransmit
ting LSPs
to ensure
LSDB
synchroniz
ation on a
P2P
network.
On a point-to-point network, devices at both ends
of a link synchronize LSDBs with each other by
flooding LSPs. The device at one end of the link
sends an LSP. If the device at the other end receives
this LSP, it replies with a PSNP. If the device that
has sent an LSP does not receive a PSNP from the
other end in a period of time, the device will
retransmit the LSP.
Procedure
● Set the maximum length for LSPs.
a. Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 555
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Set the maximum length for LSPs.
▪ Run lsp-length originate
max-size
The maximum length is set for each generated LSP.
▪ Run lsp-length receive
max-size
The maximum length is set for each received LSP.
By default, the IS-IS system generates and receives 1497-byte LSPs.
NOTE
Ensure that the value of
max-size for LSPs to be generated is less than or equal
to the value of
max-size for LSPs to be received.
The value of
max-size set through the lsp-length command must meet the
following requirements; otherwise, the MTU status on the interface is considered
Down.
● The MTU of an Ethernet interface must be greater than or equal to the sum
of the value of
max-size and 3.
● The MTU of a P2P interface must be greater than or equal to the value of
max-size.
● Set the maximum lifetime for LSPs.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run timer lsp-max-age
age-time
The maximum lifetime is set for LSPs.
By default, the maximum lifetime of LSPs is 1200 seconds.
● Set the refresh interval for LSPs.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run timer lsp-refresh
refresh-time
A refresh interval is set for LSPs.
By default, the LSP refresh interval is 900s.
NOTE
Ensure that the LSP refresh interval is at least 300s less than the maximum LSP
lifetime. This allows new LSPs to reach all devices in an area before existing LSPs
expire.
The larger a network, the greater the deviation between the LSP refresh interval
and the maximum LSP lifetime.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 556
● Set the minimum interval at which LSPs are sent.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run isis timer lsp-throttle
throttle-interval [ count
count ]
The minimum interval for sending LSPs on an IS-IS interface and the
maximum number of LSPs sent within the interval are set.
By default, the minimum interval for sending LSPs is 50 ms, and the
maximum number of LSPs sent each time is 10.
● Configure the intelligent timer used to generate LSPs.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run timer lsp-generation
max-interval [
init-interval [
incr-interval ] ]
[ level-1 | level-2 ]
The intelligent timer used to generate LSPs is set.
If no level is configured, both Level-1 and Level-2 are configured.
The initial delay for generating the same LSPs (or LSP fragments) is
init-
interval. The delay for generating the same LSPs (or LSP fragments) in
the next iteration is
incr-interval. When the routes change each time, the
delay for generating the same LSPs (or LSP fragments) is twice as the
previous value until the delay is up to
max-interval. After the delay
reaches
max-interval for three times or the IS-IS process is reset, the
interval is reduced to
init-interval.
When
incr-interval is not used and the same LSPs (or LSP fragments) are
generated for the first time,
init-interval is used as the initial delay. Then,
the delay for generating the same LSPs (or LSP fragments) is
max-
interval. After the delay reaches
max-interval for three times or the IS-IS
process is reset, the interval is reduced to
init-interval.
When only
max-interval is used, the intelligent timer changes into a
normal one-short timer.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 557
● Enable LSP fast flooding.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run flash-flood [
lsp-count | max-timer-interval
interval | [ level-1 |
level-2 ] ]*
The LSP fast flooding is enabled.
The
lsp-count parameter specifies the number of LSPs flooded each time,
which is applicable to all interfaces. If the number of LSPs to be sent is
greater than the value of
lsp-count,
lsp-count takes effect. If the number
of LSPs to be sent is less than the value of
lsp-count, all the LSPs are
sent. If a timer is configured and the configured timer does not expire
before the route calculation, the LSPs are flooded immediately when
being received; otherwise, the LSPs are sent when the timer expires.
When LSP fast flooding is enabled, Level-1 LSPs and Level-2 LSPs are fast
flooded by default if no level is specified.
● Set an interval at which LSPs are retransmitted over a P2P link.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. (Optional) Run isis circuit-type p2p [ strict-snpa-check ]
A broadcast interface is simulated as a P2P interface.
NOTE
If the interface type is P2P, this step is not required.
e. Run isis timer lsp-retransmit
retransmit-interval
The interval at which LSPs are retransmitted over a P2P link is set.
By default, the interval for retransmitting LSPs over a P2P link is 5
seconds.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 558
7.11.3 Configuring Attributes for CSNPs
Context
Complete sequence number PDUs (CSNPs) contain summaries of all the LSPs in
an LSDB to ensure LSDB synchronization between neighbors. CSNPs are processed
differently on broadcast and P2P links.
● On a broadcast link, CSNPs are periodically sent by a DIS device. If a device
detects that its LSDB is not synchronized with that on its neighboring device,
the device will send PSNPs to apply for missing LSPs.
● On a P2P link, CSNPs are sent only during initial establishment of neighboring
relationships.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run isis timer csnp
csnp-interval [ level-1 | level-2 ]
The interval at which CSNPs are sent is set on the specified interface.
By default, the interval at which CSNPs are sent on a broadcast network is 10
seconds.
NOTE
Configure Level-1 and Level-2 only when a broadcast interface is specified.
----End
7.11.4 Setting the SPF Calculation Interval
Context
A network change always triggers IS-IS to perform SPF calculation. Frequent SPF
calculation will consume excessive CPU resources, affecting services.
To solve this problem, configure an intelligent timer to control the interval for SPF
calculation. For example, to speed up IS-IS route convergence, set the interval for
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 559
SPF calculation to a small value and set the interval to a large value after the IS-IS
network becomes stable.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run timer spf
max-interval [
init-interval [
incr-interval ] ]
The SPF intelligent timer is configured.
By default, no SPF intelligent timer is configured and the maximum delay in SPF
calculation is 5 seconds.
The intelligent timer changes as follows:
● The delay in the first SPF calculation is determined by
init-interval; the delay
in the second SPF calculation is determined by
incr-interval. From the third
time on, the delay in SPF calculation increases twice every time until the delay
reaches the value specified by
max-interval. After the delay remains at the
value specified by
max-interval for three times or the IS-IS process is
restarted, the delay decreases to the value specified by
init-interval.
● If
incr-interval is not specified, the delay in SPF calculation for the first time is
determined by
init-interval. From the second time on, the delay in SPF
calculation is determined by
max-interval. After the delay remains at the
value specified by
max-interval for three times or the IS-IS process is
restarted, the delay decreases to the value specified by
init-interval.
● When only
max-interval is specified, the intelligent timer functions as an
ordinary one-time triggering timer.
Step 4 (Optional) Run spf-slice-size
duration-time
The maximum duration for SPF calculation is configured.
By default, IS-IS route calculation lasts for a maximum of 2 ms at a time.
----End
7.11.5 Configuring Convergence Priorities for IS-IS Routes
Context
Devices allow you to configure the highest convergence priority for specific IS-IS
routes so that these IS-IS routes will be converged first when a network topology
changes.
The rules of applying convergence priorities for IS-IS routes are as follows:
● Existing IS-IS routes are converged based on the priorities configured in the
prefix-priority command.
● New IS-IS routes are converged based on the priorities configured in the
prefix-priority command.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 560
● If an IS-IS route conforms to the matching rules of multiple convergence
priorities, the highest convergence priority is used.
● The convergence priority of a Level-1 IS-IS route is higher than that of a
Level-2 IS-IS route.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run prefix-priority [ level-1 | level-2 ] { critical | high | medium } { ip-prefix
prefix-name | tag
tag-value }
Convergence priorities are set for IS-IS routes.
By default, the convergence priority of 32-bit host routes is medium, and the
convergence priority of the other IS-IS routes is low.
NOTE
The prefix-priority command is only applicable to the public network.
After the prefix-priority command is run, the convergence priority of 32-bit host routes is
low, and the convergence priorities of the other routes are determined as specified in the
prefix-priority command.
----End
7.11.6 Verifying the IS-IS Route Convergence Control
Configuration
Procedure
● Run the display isis interface [ verbose ] [
process-id | vpn-instance
vpn-
instance-name ] command to check IS-IS packet information.
● Run the display isis route [
process-id | vpn-instance
vpn-instance-name ]
[ ipv4 ] [ verbose | [ level-1 | level-2 ] |
ip-address [
mask |
mask-length ] ] *
[ | count ] command to check IS-IS route information.
----End
7.12 Configuring LSP Fragment Extension
Pre-configuration Tasks
Before configuring LSP fragment extension, create IS-IS processes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 561
NOTE
When a new device connects to an IS-IS network, you are advised to configure LSP
fragment extension and virtual systems before establishing IS-IS neighbors or importing
routes. If you establish IS-IS neighbors or import routes without configuring LSP fragment
extension and virtual systems, IS-IS needs to carry much information, which cannot be
loaded through 256 fragments. You must then configure LSP fragment extension and virtual
systems, which will take effect only after you restart the IS-IS process.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run lsp-fragments-extend [ [ level-1 | level-2 | level-1-2 ] | [ mode-1 |
mode-2 ] ] *
LSP fragment extension is enabled in an IS-IS process.
By default, LSP fragment extension is disabled in an IS-IS process.
If the mode or level is not specified during the configuration of LSP fragment
extension, mode-1 and level-1-2 are used by default.
NOTE
If there are devices of other manufacturers on the network, LSP fragment extension must
be set to mode-1. Otherwise, devices of other manufacturers cannot identify LSPs.
Step 4 Run virtual-system
virtual-system-id
A virtual system is configured.
By default, no virtual system is configured.
To configure a switch to generate extended LSP fragments, you must configure at
least one virtual system. The ID of the virtual system must be unique in the
domain.
An IS-IS process can be configured with up to 50 virtual system IDs.
----End
Verifying the Configuration
Run the following commands to check IS-IS process statistics.
● display isis statistics [ updated-lsp [ history ] ] [ level-1 | level-2 |
level-1-2 ] [
process-id | vpn-instance
vpn-instance-name ]
● display isis
process-id statistics [ [ [ updated-lsp [ history ] ] [ level-1 |
level-2 | level-1-2 ] ] | [ packet ] ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 562
7.13 Configuring a Mesh Group on an NBMA Network
Pre-configuration Tasks
Before configuring a mesh group, configure basic IS-IS functions.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run isis mesh-group {
mesh-group-number | mesh-blocked }
The interface is added to a mesh group.
When mesh-blocked is configured on an interface, the interface is blocked and
cannot flood LSPs outside. All the interfaces added to a mesh group implement
global LSDB synchronization through CSNP and PSNP mechanisms.
----End
Verifying the Configuration
Run the following commands to check IS-IS process statistics.
● display isis statistics [ updated-lsp [ history ] ] [ level-1 | level-2 |
level-1-2 ] [
process-id | vpn-instance
vpn-instance-name ]
● display isis
process-id statistics [ [ [ updated-lsp [ history ] ] [ level-1 |
level-2 | level-1-2 ] ] | [ packet ] ]
7.14 Configuring IS-IS Reliability
Pre-configuration Tasks
Before configuring IS-IS reliability, configure basic IS-IS functions.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 563
Configuration Flowchart
You can perform the following configuration tasks (excluding the task of Verifying
the IS-IS Reliability Configuration) in any sequence.
7.14.1 Configuring Static BFD for IS-IS
Context
On an IS-IS network, a device periodically sends Hello packets to detect the
neighbor status change. By default, the device considers a neighbor Down when it
does not receive a Hello packet from the neighbor after sending three Hello
packets (30 seconds). This IS-IS fault detection mechanism, however, cannot
provide high reliability for the network that requires fast network convergence and
no packet loss. BFD for IS-IS can solve this problem. BFD is a millisecond-level
fault detection mechanism. It can fast detect faults on the link between IS-IS
neighbors. Therefore, BFD can speed up IS-IS route convergence, ensures fast link
switchover, and reduces traffic loss.
Compared to dynamic BFD, static BFD has the following characteristics:
● Static BFD can be manually controlled and is easy to deploy. To save memory
and ensure reliability of key links, BFD can be deployed on specified links.
● Establishing and deleting BFD sessions need to be manually triggered and
lack flexibility. Configuration errors may occur. For example, if an incorrect
local or remote discriminator is configured, a BFD session cannot work
properly.
NOTE
A BFD session currently does not detect route switching. If the change of bound peer IP
address causes a route to switch to another link, the BFD session is negotiated again only
when the original link fails.
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support BFD for IS-IS.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bfd
BFD is enabled globally.
Step 3 Run quit
The system view is displayed.
Step 4 Run bfd
cfg-name bind peer-ip
ip-address [ interface
interface-type interface-
number ]
BFD is enabled between the specified interface and peer router.
If a peer IP address and a local interface are specified in the bfd command, BFD
monitors only a single-hop link with the interface specified in the bfd command
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 564
as the outbound interface and with the peer IP address specified in the peer-ip
command as the next-hop address.
Step 5 Set discriminators.
● Run discriminator local
discr-value
A local discriminator is set.
● Run discriminator remote
discr-value
A remote discriminator is set.
The local discriminator of a device must be the remote discriminator of the device
on the other end; otherwise, a BFD session cannot be established. In addition, the
local and remote discriminators cannot be modified after being configured.
NOTE
The local discriminator of the local device must be the same as the remote discriminator of
the remote device, and the remote discriminator of the local device must be the same as
the local discriminator of the remote device.
Step 6 Run commit
Configurations are committed.
Step 7 Run quit
The system view is displayed.
Step 8 Run interface
interface-type interface-number
The view of the specified interface is displayed.
Step 9 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 10 Run isis bfd static
Static IPv4 BFD is enabled on the specified interface.
----End
Verifying the Configuration
You can check information about a BFD session only after parameters of the BFD
session are configured and the BFD session is established.
● Run the display isis [
process-id | vpn-instance
vpn-instance-name ] bfd
session { peer
ip-address | all } command to check information about the
BFD session.
● Run the display isis interface verbose command. The command output
shows that the status of static BFD for IS-IS process is Yes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 565
7.14.2 Configuring Dynamic BFD for IS-IS
Context
On an IS-IS network, a device periodically sends Hello packets to detect the
neighbor status change. By default, the device considers a neighbor Down when it
does not receive a Hello packet from the neighbor after sending three Hello
packets (30 seconds). This IS-IS fault detection mechanism, however, cannot
provide high reliability for the network that requires fast network convergence and
no packet loss. BFD for IS-IS can solve this problem. BFD is a millisecond-level
fault detection mechanism. It can fast detect faults on the link between IS-IS
neighbors. Therefore, BFD can speed up IS-IS route convergence, ensure fast link
switchover, and reduce traffic loss.
Dynamic BFD for IS-IS implements dynamic setup of BFD sessions. When a new
IS-IS neighbor relationship is set up, BFD is notified of the neighbor parameters
and the detection parameters (including source and destination IP addresses).
Then a BFD session will be established based on the received neighbor
parameters.
Dynamic BFD is more flexible than static BFD. In dynamic BFD, routing protocols
trigger the setup of BFD sessions, preventing the configuration errors caused by
manual configuration. Dynamic BFD is easy to configure and applies to the
scenarios where BFD needs to be configured on the entire network. Dynamic BFD
for IS-IS can fast detect neighbor status changes and implement fast network
convergence.
NOTE
A BFD session currently does not detect route switching. If the change of bound peer IP
address causes a route to switch to another link, the BFD session is negotiated again only
when the original link fails.
The priority of BFD configured on an interface is higher than that of BFD configured for a
process. If BFD session parameters are configured for both a process and an interface, the
parameters on the interface will be used to establish a dynamic BFD session.
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support BFD for IS-IS.
Procedure
● Configure dynamic BFD for IS-IS in a specified IS-IS process.
a. Run system-view
The system view is displayed.
b. Run bfd
BFD is enabled globally.
c. Run quit
The system view is displayed.
d. Run isis
process-id
The IS-IS view is displayed.
e. Run bfd all-interfaces enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 566
BFD for IS-IS is enabled to establish a BFD session.
This command enables an IS-IS process to use default BFD parameters to
create BFD sessions on all the interfaces in the IS-IS process.
f. (Optional) Run bfd all-interfaces { min-rx-interval
receive-interval |
min-tx-interval
transmit-interval | detect-multiplier
multiplier-value } *
The parameters for establishing BFD sessions are set for all interfaces.
The command execution result is applicable to BFD session parameters
on all IS-IS interfaces.
g. (Optional) Run the isis bfd block command in the interface view:
The interface is prohibited from dynamically establishing a BFD session.
By default, an interface can dynamically establish BFD sessions.
● Configure dynamic BFD for IS-IS on a specified interface.
a. Run system-view
The system view is displayed.
b. Run bfd
BFD is enabled globally.
c. Run quit
The system view is displayed.
d. Run interface
interface-type interface-number
The interface view is displayed.
e. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
f. Run isis bfd enable
BFD is enabled on the interface to establish a BFD session.
After BFD is configured globally and the neighbor status is Up (on a
broadcast network, DIS is in the Up state), default BFD parameters will
be used to establish BFD sessions on the specified interface.
g. (Optional) Run isis bfd { min-rx-interval
receive-interval | min-tx-
interval
transmit-interval | detect-multiplier
multiplier-value } *
Run this command when BFD session parameters need to be configured
for a specified interface.
h. (Optional) Run isis bfd block
The interface is prohibited from dynamically establishing a BFD session.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 567
Verifying the Configuration
After BFD is enabled on both ends of a link, run the display isis [
process-id | vpn-
instance
vpn-instance-name ] bfd session { all | peer
ip-address | interface
interface-type interface-number } command. The command output shows that
BFD status is up.
7.14.3 Enabling IS-IS GR
Context
The restart of an IS-IS switch causes the temporary interruption of the network,
because the adjacency relationship between the switch and its neighbor is torn
down. The LSPs of the switch are deleted, which makes route calculation
inaccurate. Packets are thus lost.
You can configure IS-IS GR to solve this problem. After IS-IS GR is enabled, the
switch notifies the neighbor of the restart status, and reestablishes the adjacency
relationship with its neighbor without interrupting the forwarding.
The GR interval is set as the Holdtime in an IS-IS Hello PDU. Therefore, the
adjacency relationship is not torn down when the switch restarts.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run graceful-restart
IS-IS GR is enabled.
By default, IS-IS GR is disabled.
Step 4 Run graceful-restart no-impact-holdtime
The holdtime of an IS-IS neighbor is configured to remain unchanged in IS-IS GR
mode.
Step 5 (Optional) Run graceful-restart interval
interval-value
A value is configured for the T3 timer during the IS-IS GR.
The value of the T3 timer indicates the longest time that a GR lasts. A router
disables the T3 timer after the LSDB synchronization ends in all areas. If LSDBs are
not synchronized yet when the T3 timer expires, the GR fails.
By default, the value of the T3 timer is 300 seconds. Keeping the default value is
recommended.
During a GR, an IS-IS neighbor of the restarter sets the value of the T3 timer to
the holdtime of the neighbor relationship between them, which prevents routes
from being recalculated on the whole network due to a neighbor disconnection
during the GR.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 568
Step 6 (Optional) Run graceful-restart suppress-sa
The GR restarter is configured to suppress the Suppress-Advertisement (SA) bit of
the restart TLV.
By default, the SA bit is not suppressed.
----End
Verifying the Configuration
Run display isis graceful-restart status [ level-1 | level-2 ] [
process-id | vpn-
instance
vpn-instance-name ] command to check the status of IS-IS GR.
7.15 Configuring IPv4 IS-IS Auto FRR
IS-IS Auto FRR can fast switch traffic to a backup link, ensuring millisecond-level
traffic interruption. This protects traffic and improves IS-IS network reliability.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support IS-IS Auto FRR.
7.15.1 Enabling IPv4 IS-IS Auto FRR
Context
Perform the following steps on the switch that needs the protection for the
forwarded traffic:
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS process is enabled and the IS-IS view is displayed.
Step 3 Run frr
The IS-IS Auto FRR view is displayed.
Step 4 (Optional) Run frr-policy route route-policy
route-policy-name
Backup routes are filtered using a filtering policy. Only backup routes that have
passed the filtering policy are added to the routing table.
Step 5 Run loop-free-alternate [ level-1 | level-2 | level-1-2 ]
IS-IS Auto FRR is enabled and the loop-free backup route is created.
If the IS-IS level is not specified, IS-IS Auto FRR is enabled on Level-1 and Level-2
to create the backup route.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 569
NOTE
IS-IS can create the loop-free backup route only if the interface cost is in compliance with
the traffic protection inequality of IS-IS Auto FRR.
----End
7.15.2 (Optional) Disabling an Interface from Being Involved
in IPv4 LFA Calculation
Context
IS-IS Auto FRR can fast switch traffic to a backup link, ensuring millisecond-level
traffic interruption. This protects traffic and improves IS-IS network reliability.
Perform the following steps on the IS-IS interface to be disabled from participating
in the Loop-Free Alternate (LFA) calculation:
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 Run undo isis lfa-backup [ level-1 | level-2 | level-1-2 ]
The interface is disabled from participating in the LFA calculation.
----End
7.15.3 Verifying the IPv4 IS-IS Auto FRR Configuration
Prerequisites
All IS-IS Auto FRR configurations are complete.
Procedure
● Run the display isis route [
process-id | vpn-instance
vpn-instance-name ]
[ ipv4 ] [ verbose | [ level-1 | level-2 ] |
ip-address [
mask |
mask-length ] ] *
command to check information about the primary link and backup link after
IS-IS Auto FRR is enabled.
● Run the display isis spf-tree [ systemid
systemid | dname
dname ]
[ [ level-1 | level-2 ] | ipv6 | verbose ] * [
process-id | vpn-instance
vpn-
instance-name ] command to check the traffic protection type of IS-IS Auto
FRR.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 570
7.16 Configuring the Overload Bit for an IS-IS Device
Pre-configuration Tasks
Before configuring the overload bit for an IS-IS device, configure basic IS-IS
functions.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run set-overload [ on-startup [
timeout1 | start-from-nbr
system-id [
timeout1
[
timeout2 ] ] | wait-for-bgp [
timeout1 ] ] [ send-sa-bit [
timeout3 ] ] ] [ allow
{ interlevel | external }* ]
The overload bit for non-pseudonode LSPs is configured.
----End
Verifying the Configuration
● Run the display isis lsdb [ [ level-1 | level-2 ] | verbose | [ local |
lsp-id | is-
name
symbolic-name ] ] * [
process-id | vpn-instance
vpn-instance-name ]
command to check information in the IS-IS LSDB.
7.17 Configuring IS-IS Neighbor Relationship Flapping
Suppression
Usage Scenario
If an interface carrying IS-IS services alternates between Up and Down, IS-IS
neighbor relationship flapping occurs on the interface. During the flapping, IS-IS
reestablishes the neighbor relationship and recalculates routes. In this process, a
large number of packets are exchanged, adversely affecting neighbor relationship
stability, IS-IS services, and other IS-IS-dependent services, such as LDP and BGP.
IS-IS neighbor relationship flapping suppression can address this problem by
delaying IS-IS neighbor relationship reestablishment or preventing service traffic
from passing through flapping links.
NOTE
The following steps are optional, choose them as required.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 571
Pre-configuration Tasks
Before configuring IS-IS neighbor relationship flapping suppression, complete the
following tasks:
● Configure an IP address for each interface to ensure that neighboring routers
are reachable at the network layer.
● Configure basic IPv4 IS-IS functions.
Procedure
Step 1 Run system-view
The system view is displayed.
By default, IS-IS neighbor relationship flapping suppression is enabled globally. To
disable this function globally, run the suppress-flapping peer disable command
in the IS-IS view.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
By default, IS-IS neighbor relationship flapping suppression is enabled on all
interfaces in the same IS-IS process. To disable the function from one of the
interfaces, run the isis suppress-flapping peer disable command.
Step 3 Run isis suppress-flapping peer hold-down
interval
The Hold-down mode is configured, and its duration is set.
Flapping suppression works in either Hold-down or Hold-max-cost mode.
● Hold-down mode: In the case of frequent flooding and topology changes
during neighbor relationship establishment, interfaces prevent neighbor
relationship reestablishment during Hold-down suppression, which minimizes
synchronization attempts and packet exchanges.
● Hold-max-cost mode: If the traffic forwarding path changes frequently,
interfaces use the maximum value (16777214 for the wide mode and 63 for
the narrow mode) as the cost of the flapping link during Hold-max-cost
suppression, which prevents traffic from passing through the flapping link.
Flapping suppression can also work first in Hold-down mode and then in Hold-
max-cost mode.
By default, the Hold-down mode is disabled, but the Hold-max-cost mode is
enabled.
To disable this mode, run the isis suppress-flapping peer hold-max-cost disable
command.
Step 4 Run isis suppress-flapping peer { detecting-interval
detecting-interval |
threshold
threshold | resume-interval
resume-interval } *
Detection parameters are configured for IS-IS neighbor relationship flapping
suppression.
Each IS-IS interface that has IS-IS neighbor relationship flapping suppression
enabled starts a flapping counter. If the interval between two successive neighbor
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 572
status changes from Full to a non-Full state is shorter than
detecting-interval, a
valid flapping_event is recorded, and the flapping_count is incremented by 1.
When the flapping_count reaches or exceeds
threshold, flapping suppression takes
effect. If the interval between two successive neighbor status changes from Full to
a non-Full state is longer than
resume-interval, the flapping_count is reset.
NOTE
The value of
resume-interval must be greater than that of
detecting-interval.
By default, the detection interval of IS-IS neighbor relationship flapping
suppression is 60s, the suppression threshold is 10, and the interval for exiting
from suppression is 120s. Using the default detection parameters is recommended.
Step 5 Run quit
The system view is displayed.
Step 6 Run quit
The user view is displayed.
Step 7 Run reset isis
process-id suppress-flapping peer [ interface
interface-type
interface-number ] [ notify-peer ]
Interfaces are forced to exit from IS-IS neighbor relationship flapping suppression.
Interfaces exit from flapping suppression in the following scenarios:
● The suppression timer expires.
● The corresponding IS-IS process is reset.
● An IS-IS neighbor is reset using the reset isis peer command.
● IS-IS neighbor relationship flapping suppression is disabled globally using the
suppress-flapping peer disable (IS-IS) command in the IS-IS view.
● The reset isis suppress-flapping peer command is run.
● Suppression is aborted forcibly using the reset isis
process-id suppress-
flapping peer [ interface
interface-type interface-number ] notify-peer
command on the remote device.
----End
Verifying the Configurations
Run the display isis [
process-id ] interface
interface-type interface-number
verbose command to check the status of IS-IS neighbor relationship flapping
suppression.
<HUAWEI> display isis interface verbose
Interface information for ISIS(1)
---------------------------------
Interface Id IPV4.State IPV6.State MTU Type DIS
Vlanif100 001 Up Down 1497 L1/L2 No/No
Circuit MT State : Standard
Description :
SNPA Address : xxxx-xxxx-xxxx
IP Address : 10.1.1.5
IPV6 Link Local Address :
IPV6 Global Address (es) :
Csnp Timer Value : L1 10 L2 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 573
Hello Timer Value : L1 10 L2 10
DIS Hello Timer Value : L1 3 L2 3
Hello Multiplier Value : L1 3 L2 3
LSP-Throttle Timer : L12 50
Cost : L1 10 L2 10
Ipv6 Cost : L1 10 L2 10
Priority : L1 64 L2 64
Retransmit Timer Value : L12 5
Bandwidth-Value : Low 1000000000 High 0
Static Bfd : NO
Dynamic Bfd : NO
Dynamic IPv6 Bfd : NO
Fast-Sense Rpr : NO
Suppress flapping peer : enable (flapping-count: 0, threshold: 10)
Suppress flapping peer in the command output indicates the current suppression
mode (enable), time when the flapping suppression started, and the remaining
time of the flapping suppression.
7.18 Maintaining IS-IS
7.18.1 Resetting IS-IS
Context
To reset IS-IS, reset IS-IS data structure, neighbor relationship and packets
NOTICE
The IS-IS data structure cannot be restored after you reset it. All the previous
structure information and the neighbor relationship are reset. Exercise caution
when running this command.
The specified IS-IS neighbor relationship is deleted after you reset a specified IS-IS
neighbor. Exercise caution when running this command.
Procedure
● Reset IS-IS data structure.
Run the reset isis all[
process-id | vpn-instance
vpn-instance-name ]
command to reset IS-IS data structure.
● Reset IS-IS neighbor relationship.
Run the reset isis peer
system-id [
process-id | vpn-instance
vpn-instance-
name ] command to reset a specific IS-IS neighbor.
After the IS-IS routing policy or the protocol changes, you can reset a specific
IS-IS neighbor to validate the new configuration.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 574
7.18.2 Improving the Maintainability of IS-IS
Context
The administrator can improve the maintainability of IS-IS using either of the
following methods:
● Configuring IS-IS host name mapping: Through this function, the
administrator can use a simple name to replace the system ID. After IS-IS host
name mapping is configured, the dynamic name is displayed in the IS-IS
information to replace the system ID when the display command is executed.
This improves the maintainability of IS-IS networks.
● Configuring IS-IS to add the POI TLV to a PURGE packet: When the value of
the Remaining Lifetime field in an LSP packet is 0, this packet is invalid and
called a PURGE packet. PURGE packets do not record information about the
devices generating these packets. Therefore, when a network is faulty, the
packet source cannot be located. To solve this problem, IS-IS can be
configured to add the POI TLV to a PURGE packet so that the PURGE packet
contains information about its generating device. If the dynamic host name
function is configured locally, the host name TLV is also added to the PURGE
packet to facilitate fault location.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Configure IS-IS host name mapping.
● Run is-name
symbolic-name
IS-IS dynamic host name mapping is configured and a host name is
configured for the local device.
This configuration is dynamic configuration. Therefore, the configured host
name
symbolic-name is advertised through an LSP to other IS-IS devices in
the same area. When you use IS-IS display commands to view IS-IS
information on other IS-IS devices, the system ID of the local device is
replaced by the configured host name.
● Run is-name map
system-id symbolic-name
IS-IS static host name mapping is configured and a host name is configured
for the remote device.
This configuration is static configuration and takes effect only on the local
device. Therefore, the configured host name
symbolic-name is not advertised
through an LSP.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 575
7.18.3 Configuring the Output of IS-IS Adjacency Status
Context
On an IS-IS network, neighbor flapping will result in network instability and
frequent network convergence. This will consume lots of memory and may even
cause user traffic loss. Therefore, neighbor flapping needs to be rapidly located
and solved.
To rapidly locate problems in the case of neighbor flapping, enable the output of
IS-IS adjacency changes to log these changes.
If the local terminal monitor is enabled and the output of the IS-IS adjacency
status is enabled, IS-IS adjacency changes will be output to the router until the
output of the adjacency status is disabled.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run log-peer-change [ topology ]
The output of the adjacency status is enabled.
By default, the output of IS-IS adjacency changes is disabled.
----End
7.19 Configuration Examples for IPv4 IS-IS
7.19.1 Example for Configuring Basic IS-IS Functions
Networking Requirements
As shown in Figure 7-33, there are four switches (SwitchA, SwitchB, SwitchC, and
SwitchD) on the network. The four switches need to communicate with each
other. SwitchA and SwitchB can only process a small amount of data because they
have lower performance than the other two switches.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 576
Figure 7-33 Networking diagram of configuring basic IS-IS functions
Configuration Roadmap
The configuration roadmap is as follows:
1. Enable IS-IS on each switch so that the switches can be interconnected.
Configure SwitchA and SwitchB as Level-1 devices to enable them to maintain
less data.
Procedure
Step 1 Create VLANs and add corresponding interfaces to the VLANs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.2 24
[SwitchA-Vlanif10] quit
Step 3 Run the IS-IS progress on each Switch, specify the network entity title, and
configure the level.
# Configure SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 577
[SwitchA] isis 1
[SwitchA-isis-1] is-level level-1
[SwitchA-isis-1] network-entity 10.0000.0000.0001.00
[SwitchA-isis-1] quit
# Configure SwitchB.
[SwitchB] isis 1
[SwitchB-isis-1] is-level level-1
[SwitchB-isis-1] network-entity 10.0000.0000.0002.00
[SwitchB-isis-1] quit
# Configure SwitchC.
[SwitchC] isis 1
[SwitchC-isis-1] network-entity 10.0000.0000.0003.00
[SwitchC-isis-1] quit
# Configure SwitchD.
[SwitchD] isis 1
[SwitchD-isis-1] is-level level-2
[SwitchD-isis-1] network-entity 20.0000.0000.0004.00
[SwitchD-isis-1] quit
Step 4 Enable the IS-IS progress on each interface.
# Configure SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] isis enable 1
[SwitchA-Vlanif10] quit
# Configure SwitchB.
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] isis enable 1
[SwitchB-Vlanif20] quit
# Configure SwitchC.
[SwitchC] interface vlanif 10
[SwitchC-Vlanif10] isis enable 1
[SwitchC-Vlanif10] quit
[SwitchC] interface vlanif 20
[SwitchC-Vlanif20] isis enable 1
[SwitchC-Vlanif20] quit
[SwitchC] interface vlanif 30
[SwitchC-Vlanif30] isis enable 1
[SwitchC-Vlanif30] quit
# Configure SwitchD.
[SwitchD] interface vlanif 30
[SwitchD-Vlanif30] isis enable 1
[SwitchD-Vlanif30] quit
[SwitchD] interface vlanif 40
[SwitchD-Vlanif40] isis enable 1
[SwitchD-Vlanif40] quit
Step 5 Verify the configuration.
# View the IS-IS LSDB of each Switch.
[SwitchA] display isis lsdb
Database information for ISIS(1)
--------------------------------
Level-1 Link State Database
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 578
LSPID Seq Num Checksum Holdtime Length ATT/P/OL
-------------------------------------------------------------------------------
0000.0000.0001.00-00* 0x0000006e 0x953e 862 68 0/0/0
0000.0000.0002.00-00 0x0000006a 0xc015 766 68 0/0/0
0000.0000.0002.01-00 0x00000008 0xccb6 766 55 0/0/0
0000.0000.0003.00-00 0x00000086 0x529e 1155 111 1/0/0
0000.0000.0003.01-00 0x0000005e 0xf238 1155 55 0/0/0
Total LSP(s): 5
*(In TLV)-Leaking Route, *(By LSPID)-Self LSP, +-Self LSP(Extended),
ATT-Attached, P-Partition, OL-Overload
[SwitchB] display isis lsdb
Database information for ISIS(1)
--------------------------------
Level-1 Link State Database
LSPID Seq Num Checksum Holdtime Length ATT/P/OL
-------------------------------------------------------------------------------
0000.0000.0001.00-00 0x0000006e 0x953e 899 68 0/0/0
0000.0000.0002.00-00* 0x0000006a 0xc015 808 68 0/0/0
0000.0000.0002.01-00* 0x00000008 0xccb6 808 55 0/0/0
0000.0000.0003.00-00 0x00000086 0x529e 1195 111 1/0/0
0000.0000.0003.01-00 0x0000005e 0xf238 1195 55 0/0/0
Total LSP(s): 5
*(In TLV)-Leaking Route, *(By LSPID)-Self LSP, +-Self LSP(Extended),
ATT-Attached, P-Partition, OL-Overload
[SwitchC] display isis lsdb
Database information for ISIS(1)
--------------------------------
Level-1 Link State Database
LSPID Seq Num Checksum Holdtime Length ATT/P/OL
-------------------------------------------------------------------------------
0000.0000.0001.00-00 0x0000006e 0x953e 953 68 0/0/0
0000.0000.0002.00-00 0x0000006a 0xc015 859 68 0/0/0
0000.0000.0002.01-00 0x00000008 0xccb6 859 55 0/0/0
0000.0000.0003.00-00* 0x00000085 0x549d 937 111 1/0/0
0000.0000.0003.01-00* 0x0000005d 0xf437 937 55 0/0/0
Total LSP(s): 5
*(In TLV)-Leaking Route, *(By LSPID)-Self LSP, +-Self LSP(Extended),
ATT-Attached, P-Partition, OL-Overload
Level-2 Link State Database
LSPID Seq Num Checksum Holdtime Length ATT/P/OL
-------------------------------------------------------------------------------
0000.0000.0003.00-00* 0x0000008a 0x513c 876 100 0/0/0
0000.0000.0004.00-00 0x00000063 0x48ad 761 84 0/0/0
0000.0000.0004.01-00 0x0000005b 0x3aef 761 55 0/0/0
Total LSP(s): 3
*(In TLV)-Leaking Route, *(By LSPID)-Self LSP, +-Self LSP(Extended),
ATT-Attached, P-Partition, OL-Overload
[SwitchD] display isis lsdb
Database information for ISIS(1)
--------------------------------
Level-2 Link State Database
LSPID Seq Num Checksum Holdtime Length ATT/P/OL
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 579
-------------------------------------------------------------------------------
0000.0000.0003.00-00 0x0000008a 0x513c 901 100 0/0/0
0000.0000.0004.00-00* 0x00000063 0x48ad 789 84 0/0/0
0000.0000.0004.01-00* 0x0000005b 0x3aef 789 55 0/0/0
Total LSP(s): 3
*(In TLV)-Leaking Route, *(By LSPID)-Self LSP, +-Self LSP(Extended),
ATT-Attached, P-Partition, OL-Overload
# View the IS-IS routing table of each Switch. A default route is available in the
routing table of the Level-1 devices and the next hop is a Level-1-2 device. The
routing table of the Level-2 device contains all Level-1 and Level-2 routes.
[SwitchA] display isis route
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-1 Forwarding Table
--------------------------------
IPV4 Destination IntCost ExtCost ExitInterface NextHop Flags
-------------------------------------------------------------------------------
0.0.0.0/0 10 NULL Vlanif10 10.1.1.1 A/-/-/-
192.168.0.0/24 20 NULL Vlanif10 10.1.1.1 A/-/-/-
10.1.1.0/24 10 NULL Vlanif10 Direct D/-/L/-
10.1.2.0/24 20 NULL Vlanif10 10.1.1.1 A/-/-/-
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut,
U-Up/Down Bit Set
[SwitchB] display isis route
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-1 Forwarding Table
--------------------------------
IPV4 Destination IntCost ExtCost ExitInterface NextHop Flags
-------------------------------------------------------------------------------
0.0.0.0/0 10 NULL Vlanif20 10.1.2.1 A/-/-/-
192.168.0.0/24 20 NULL Vlanif20 10.1.2.1 A/-/-/-
10.1.1.0/24 20 NULL Vlanif20 10.1.2.1 A/-/-/-
10.1.2.0/24 10 NULL Vlanif20 Direct D/-/L/-
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut,
U-Up/Down Bit Set
[SwitchC] display isis route
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-1 Forwarding Table
--------------------------------
IPV4 Destination IntCost ExtCost ExitInterface NextHop Flags
-------------------------------------------------------------------------------
192.168.0.0/24 10 NULL Vlanif30 Direct D/-/L/-
10.1.1.0/24 10 NULL Vlanif10 Direct D/-/L/-
10.1.2.0/24 10 NULL Vlanif20 Direct D/-/L/-
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut,
U-Up/Down Bit Set
ISIS(1) Level-2 Forwarding Table
--------------------------------
IPV4 Destination IntCost ExtCost ExitInterface NextHop Flags
-------------------------------------------------------------------------------
172.16.1.0/24 20 NULL Vlanif30 192.168.0.2 A/-/-/-
192.168.0.0/24 10 NULL Vlanif30 Direct D/-/L/-
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 580
10.1.1.0/24 10 NULL Vlanif10 Direct D/-/L/-
10.1.2.0/24 10 NULL Vlanif20 Direct D/-/L/-
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut,
U-Up/Down Bit Set
[SwitchD] display isis route
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-2 Forwarding Table
--------------------------------
IPV4 Destination IntCost ExtCost ExitInterface NextHop Flags
-------------------------------------------------------------------------------
172.16.1.0/24 10 NULL Vlanif40 Direct D/-/L/-
192.168.0.0/24 10 NULL Vlanif30 Direct D/-/L/-
10.1.1.0/24 20 NULL Vlanif30 192.168.0.1 A/-/-/-
10.1.2.0/24 20 NULL Vlanif30 192.168.0.1 A/-/-/-
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut,
U-Up/Down Bit Set
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10
#
isis 1
is-level level-1
network-entity 10.0000.0000.0001.00
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 20
#
isis 1
is-level level-1
network-entity 10.0000.0000.0002.00
#
interface Vlanif20
ip address 10.1.2.2 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
return
● SwitchC configuration file
#
sysname SwitchC
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 581
#
vlan batch 10 20 30
#
isis 1
network-entity 10.0000.0000.0003.00
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
isis enable 1
#
interface Vlanif20
ip address 10.1.2.1 255.255.255.0
isis enable 1
#
interface Vlanif30
ip address 192.168.0.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30 40
#
isis 1
is-level level-2
network-entity 20.0000.0000.0004.00
#
interface Vlanif30
ip address 192.168.0.2 255.255.255.0
isis enable 1
#
interface Vlanif40
ip address 172.16.1.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
return
7.19.2 Example for Configuring IS-IS Route Summarization
Networking Requirements
As shown in Figure 7-34, three switches run IS-IS to communicate with each
other. SwitchA is a Level-2 device, SwitchB is a Level-1-2 device, and SwitchC is a
Level-1 device. SwitchA is heavily loaded because there are too many routing
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 582
entries on the IS-IS network. Therefore, system resource consumption of SwitchA
needs to be reduced.
Figure 7-34 Networking diagram for configuring IS-IS route summarization
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IP addresses for interfaces and enable IS-IS on each switch so that
the switches can be interconnected.
2. Configure route summarization on SwitchB to reduce the routing table size of
SwitchA without affecting data forwarding so that the system resource
consumption of SwitchA can be reduced.
Procedure
Step 1 Create VLANs and add corresponding interfaces to the VLANs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 50
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 50
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 50
[SwitchA-Vlanif50] ip address 172.17.1.1 24
[SwitchA-Vlanif50] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 583
Step 3 Configure basic IS-IS functions.
# Configure SwitchA.
[SwitchA] isis 1
[SwitchA-isis-1] is-level level-2
[SwitchA-isis-1] network-entity 20.0000.0000.0001.00
[SwitchA-isis-1] quit
[SwitchA] interface vlanif 50
[SwitchA-Vlanif50] isis enable 1
[SwitchA-Vlanif50] quit
# Configure SwitchB.
[SwitchB] isis 1
[SwitchB-isis-1] network-entity 10.0000.0000.0002.00
[SwitchB-isis-1] quit
[SwitchB] interface vlanif 10
[SwitchB-Vlanif10] isis enable 1
[SwitchB-Vlanif10] quit
[SwitchB] interface vlanif 50
[SwitchB-Vlanif50] isis enable 1
[SwitchB-Vlanif50] quit
# Configure SwitchC.
[SwitchC] isis 1
[SwitchC-isis-1] is-level level-1
[SwitchC-isis-1] network-entity 10.0000.0000.0003.00
[SwitchC-isis-1] quit
[SwitchC] interface vlanif 10
[SwitchC-Vlanif10] isis enable 1
[SwitchC-Vlanif10] quit
[SwitchC] interface vlanif 20
[SwitchC-Vlanif20] isis enable 1
[SwitchC-Vlanif20] quit
[SwitchC] interface vlanif 30
[SwitchC-Vlanif30] isis enable 1
[SwitchC-Vlanif30] quit
[SwitchC] interface vlanif 40
[SwitchC-Vlanif40] isis enable 1
[SwitchC-Vlanif40] quit
Step 4 Check the IS-IS routing table of SwitchA.
[SwitchA]display isis route
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-2 Forwarding Table
--------------------------------
IPV4 Destination IntCost ExtCost ExitInterface NextHop Flags
-------------------------------------------------------------------------------
172.17.1.0/24 10 NULL Vlanif50 Direct D/-/L/-
172.16.1.0/24 30 NULL Vlanif50 172.17.1.2 A/-/-/-
172.16.2.0/24 30 NULL Vlanif50 172.17.1.2 A/-/-/-
172.16.3.0/24 30 NULL Vlanif50 172.17.1.2 A/-/-/-
172.16.4.0/24 20 NULL Vlanif50 172.17.1.2 A/-/-/-
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut,
U-Up/Down Bit Set
Step 5 Configure route summarization on SwitchB.
# Summarize 172.16.1.0/24, 172.16.2.0/24, 172.16.3.0/24, and 172.16.4.0/24 as
172.16.0.0/16 on SwitchB.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 584
[SwitchB] isis 1
[SwitchB-isis-1] summary 172.16.0.0 255.255.0.0 level-1-2
[SwitchB-isis-1] quit
Step 6 Verify the configuration.
# Check the IS-IS routing table of SwitchA. The routing table contains the route
172.16.0.0/16 summarized from 172.16.1.0/24, 172.16.2.0/24, 172.16.3.0/24, and
172.16.4.0/24.
[SwitchA] display isis route
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-2 Forwarding Table
--------------------------------
IPV4 Destination IntCost ExtCost ExitInterface NextHop Flags
-------------------------------------------------------------------------------
172.17.1.0/24 10 NULL Vlanif50 Direct D/-/L/-
172.16.0.0/16 20 NULL Vlanif50 172.17.1.2 A/-/-/-
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut,
U-Up/Down Bit Set
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 50
#
isis 1
is-level level-2
network-entity 20.0000.0000.0001.00
#
interface Vlanif50
ip address 172.17.1.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 50
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 50
#
isis 1
network-entity 10.0000.0000.0002.00
summary 172.16.0.0 255.255.0.0 level-1-2
#
interface Vlanif10
ip address 172.16.4.2 255.255.255.0
isis enable 1
#
interface Vlanif50
ip address 172.17.1.2 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 585
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 10 20 30 40
#
isis 1
is-level level-1
network-entity 10.0000.0000.0003.00
#
interface Vlanif10
ip address 172.16.4.1 255.255.255.0
isis enable 1
#
interface Vlanif20
ip address 172.16.1.1 255.255.255.0
isis enable 1
#
interface Vlanif30
ip address 172.16.2.1 255.255.255.0
isis enable 1
#
interface Vlanif40
ip address 172.16.3.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/4
port link-type trunk
port trunk allow-pass vlan 40
#
return
7.19.3 Example for Configuring DIS Election
Networking Requirements
As shown in Figure 7-35, four switches on the broadcast network communicate
using IS-IS. SwitchA and SwitchB are Level-1-2 devices, SwitchC is a Level-1 device,
and SwitchD is a Level-2 device. SwitchA with high performance needs to be
configured as a Level-2 DIS.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 586
Figure 7-35 Networking diagram for configuring DIS election
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IS-IS to enable network interconnectivity.
2. Configure the DIS priority of Switch A to 100 so that SwitchA can be elected
as a Level-2 DIS.
Procedure
Step 1 Create VLANs and add corresponding interfaces to the VLANs.
# Configure SwitchA. The configurations of Switch, SwitchB, SwitchC, and SwitchD
are similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
Step 3 View the MAC address of the VLANIF 10 interface on each Switch.
# View the MAC address of the VLANIF 10 interface on SwitchA.
[SwitchA] display interface Vlanif 10
Vlanif10 current state : UP
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 587
Line protocol current state : UP
Last line protocol up time : 2014-12-02 18:02:15 UTC+08:00
Description:
Route Port,The Maximum Transmit Unit is 1500
Internet Address is 10.1.1.1/24
IP Sending Frames' Format is PKTFMT_ETHNT_2, Hardware address is 00e0-fc10-afec
Current system time: 2014-12-02 18:03:12+08:00
Input bandwidth utilization : --
Output bandwidth utilization : --
# View the MAC address of the VLANIF 10 interface on SwitchB.
[SwitchB] display interface Vlanif 10
Vlanif10 current state : UP
Line protocol current state : UP
Last line protocol up time : 2014-12-02 18:01:15 UTC+08:00
Description:
Route Port,The Maximum Transmit Unit is 1500
Internet Address is 10.1.1.2/24
IP Sending Frames' Format is PKTFMT_ETHNT_2, Hardware address is 00e0-fccd-acdf
Current system time: 2014-12-02 18:02:12+08:00
Input bandwidth utilization : --
Output bandwidth utilization : --
# View the MAC address of the VLANIF 10 interface on SwitchC.
[SwitchC] display interface Vlanif 10
Vlanif10 current state : UP
Line protocol current state : UP
Last line protocol up time : 2014-12-02 18:03:15 UTC+08:00
Description:
Route Port,The Maximum Transmit Unit is 1500
Internet Address is 10.1.1.3/24
IP Sending Frames' Format is PKTFMT_ETHNT_2, Hardware address is 00e0-fc50-25fe
Current system time: 2014-12-02 18:04:12+08:00
Input bandwidth utilization : --
Output bandwidth utilization : --
# View the MAC address of the VLANIF 10 interface on SwitchD.
[SwitchD] display interface Vlanif 10
Vlanif10 current state : UP
Line protocol current state : UP
Last line protocol up time : 2014-12-02 18:07:15 UTC+08:00
Description:
Route Port,The Maximum Transmit Unit is 1500
Internet Address is 10.1.1.4/24
IP Sending Frames' Format is PKTFMT_ETHNT_2, Hardware address is 00e0-fcfd-305c
Current system time: 2014-12-02 18:08:12+08:00
Input bandwidth utilization : --
Output bandwidth utilization : --
Step 4 Configure basic IS-IS functions.
# Configure SwitchA.
[SwitchA] isis 1
[SwitchA-isis-1] network-entity 10.0000.0000.0001.00
[SwitchA-isis-1] quit
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] isis enable 1
[SwitchA-Vlanif10] quit
# Configure SwitchB.
[SwitchB] isis 1
[SwitchB-isis-1] network-entity 10.0000.0000.0002.00
[SwitchB-isis-1] quit
[SwitchB] interface vlanif 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 588
[SwitchB-Vlanif10] isis enable 1
[SwitchB-Vlanif10] quit
# Configure SwitchC.
[SwitchC] isis 1
[SwitchC-isis-1] network-entity 10.0000.0000.0003.00
[SwitchC-isis-1] is-level level-1
[SwitchC-isis-1] quit
[SwitchC] interface vlanif 10
[SwitchC-Vlanif10] isis enable 1
[SwitchC-Vlanif10] quit
# Configure SwitchD.
[SwitchD] isis 1
[SwitchD-isis-1] network-entity 10.0000.0000.0004.00
[SwitchD-isis-1] is-level level-2
[SwitchD-isis-1] quit
[SwitchD] interface vlanif 10
[SwitchD-Vlanif10] isis enable 1
[SwitchD-Vlanif10] quit
# View information about the IS-IS neighbors of SwitchA.
[SwitchA] display isis peer
Peer information for ISIS(1)
System Id Interface Circuit Id State HoldTime Type PRI
-------------------------------------------------------------------------------
0000.0000.0002 Vlanif10 0000.0000.0002.01 Up 9s L1(L1L2) 64
0000.0000.0003 Vlanif10 0000.0000.0002.01 Up 27s L1 64
0000.0000.0002 Vlanif10 0000.0000.0004.01 Up 28s L2(L1L2) 64
0000.0000.0004 Vlanif10 0000.0000.0004.01 Up 8s L2 64
Total Peer(s): 4
# View information about the IS-IS interface of SwitchA.
[SwitchA] display isis interface
Interface information for ISIS(1)
---------------------------------
Interface Id IPV4.State IPV6.State MTU Type DIS
Vlanif10 001 Up Down 1497 L1/L2 No/No
# View information about the IS-IS interface of SwitchB.
[SwitchB] display isis interface
Interface information for ISIS(1)
---------------------------------
Interface Id IPV4.State IPV6.State MTU Type DIS
Vlanif10 001 Up Down 1497 L1/L2 Yes/No
# View information about the IS-IS interface of SwitchD.
[SwitchD] display isis interface
Interface information for ISIS(1)
---------------------------------
Interface Id IPV4.State IPV6.State MTU Type DIS
Vlanif10 001 Up Down 1497 L1/L2 No/Yes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 589
NOTE
When the default DIS priority is used, the interface on SwitchB has the greatest MAC
address among all the interfaces on the Level-1 Switches. Therefore, SwitchB is elected as
the Level-1 DIS. The interface on SwitchD has the greatest MAC address among all the
interfaces on the Level-2 Switches. Therefore, SwitchD is elected as the Level-2 DIS. The
Level-1 pseudonode is 0000.0000.0002.01. The Level-2 pseudonode is 0000.0000.0004.01.
Step 5 Set the DIS priority of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] isis dis-priority 100
[SwitchA-Vlanif10] quit
# View information about the IS-IS neighbors of SwitchA.
[SwitchA] display isis peer
Peer information for ISIS(1)
System Id Interface Circuit Id State HoldTime Type PRI
-------------------------------------------------------------------------------
0000.0000.0002 Vlanif10 0000.0000.0001.01 Up 21s L1(L1L2) 64
0000.0000.0003 Vlanif10 0000.0000.0001.01 Up 27s L1 64
0000.0000.0002 Vlanif10 0000.0000.0001.01 Up 28s L2(L1L2) 64
0000.0000.0004 Vlanif10 0000.0000.0001.01 Up 30s L2 64
Total Peer(s): 4
Step 6 Verify the configuration.
# View information about the IS-IS interface of SwitchA.
[SwitchA] display isis interface
Interface information for ISIS(1)
---------------------------------
Interface Id IPV4.State IPV6.State MTU Type DIS
Vlanif10 001 Up Down 1497 L1/L2 Yes/Yes
As shown in the output information, after the DIS priority of the IS-IS interface is
changed, SwitchA immediately becomes a Level-1 and Level-2 DIS and its
pseudonode is 0000.0000.0001.01.
# View information about the IS-IS neighbors and IS-IS interfaces on SwitchB.
[SwitchB] display isis peer
Peer information for ISIS(1)
System Id Interface Circuit Id State HoldTime Type PRI
-------------------------------------------------------------------------------
0000.0000.0001 Vlanif10 0000.0000.0001.01 Up 7s L1(L1L2) 100
0000.0000.0003 Vlanif10 0000.0000.0001.01 Up 25s L1 64
0000.0000.0001 Vlanif10 0000.0000.0001.01 Up 7s L2(L1L2) 100
0000.0000.0004 Vlanif10 0000.0000.0001.01 Up 25s L2 64
Total Peer(s): 4
[SwitchB] display isis interface
Interface information for ISIS(1)
---------------------------------
Interface Id IPV4.State IPV6.State MTU Type DIS
Vlanif10 001 Up Down 1497 L1/L2 No/No
# View information about the IS-IS neighbors and IS-IS interfaces on SwitchD.
[SwitchD] display isis peer
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 590
Peer information for ISIS(1)
System Id Interface Circuit Id State HoldTime Type PRI
-------------------------------------------------------------------------------
0000.0000.0002 Vlanif10 0000.0000.0001.01 Up 28s L2 64
0000.0000.0001 Vlanif10 0000.0000.0001.01 Up 9s L2 100
Total Peer(s): 2
[SwitchD] display isis interface
Interface information for ISIS(1)
---------------------------------
Interface Id IPV4.State IPV6.State MTU Type DIS
Vlanif10 001 Up Down 1497 L1/L2 No/No
----End
Configuration Files
● Switch configuration file
#
sysname Switch
#
vlan batch 10
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/4
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10
#
isis 1
network-entity 10.0000.0000.0001.00
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
isis enable 1
isis dis-priority 100
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 591
#
isis 1
network-entity 10.0000.0000.0002.00
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 10
#
isis 1
is-level level-1
network-entity 10.0000.0000.0003.00
#
interface Vlanif10
ip address 10.1.1.3 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 10
#
isis 1
is-level level-2
network-entity 10.0000.0000.0004.00
#
interface Vlanif10
ip address 10.1.1.4 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
7.19.4 Example for Configuring IS-IS Load Balancing
Networking Requirements
As shown in Figure 7-36, switches run IS-IS to implement IP interworking.
Congestion of the network from SwitchA to destination address 172.17.1.0/24
needs to be relieved to improve network resource efficiency.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 592
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 7-36 Networking diagram for configuring IS-IS load balancing
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic IS-IS functions on each switch to implement IP interworking.
2. Configure load balancing to balance traffic from SwitchA to SwitchD between
SwitchB and SwitchC.
Procedure
Step 1 Configure VLANs that the related interfaces belong to.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20 50
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
[SwitchA] interface gigabitethernet 0/0/3
[SwitchA-GigabitEthernet0/0/3] port link-type trunk
[SwitchA-GigabitEthernet0/0/3] port trunk allow-pass vlan 50
[SwitchA-GigabitEthernet0/0/3] quit
Step 2 Assign an IP address to each VLANIF interface.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 593
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 10.1.2.1 24
[SwitchA-Vlanif20] quit
[SwitchA] interface vlanif 50
[SwitchA-Vlanif50] ip address 172.16.1.1 24
[SwitchA-Vlanif50] quit
Step 3 Configure basic IS-IS functions.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] isis 1
[SwitchA-isis-1] is-level level-2
[SwitchA-isis-1] network-entity 10.0000.0000.0001.00
[SwitchA-isis-1] quit
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] isis enable 1
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] isis enable 1
[SwitchA-Vlanif20] quit
[SwitchA] interface vlanif 50
[SwitchA-Vlanif50] isis enable 1
[SwitchA-Vlanif50] quit
Step 4 Set the number of equal-cost routes for load balancing to 1 on SwitchA.
[SwitchA] isis 1
[SwitchA-isis-1] maximum load-balancing 1
[SwitchA-isis-1] quit
# View the routing table of SwitchA.
[SwitchA] display isis route
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-2 Forwarding Table
--------------------------------
IPV4 Destination IntCost ExtCost ExitInterface NextHop Flags
-------------------------------------------------------------------------------
172.17.1.0/24 30 NULL Vlanif10 10.1.1.2 A/-/-/-
172.16.1.0/24 10 NULL Vlanif50 Direct D/-/L/-
192.168.0.0/24 20 NULL Vlanif10 10.1.1.2 A/-/-/-
192.168.1.0/24 20 NULL Vlanif20 10.1.2.2 A/-/-/-
10.1.1.0/24 10 NULL Vlanif10 Direct D/-/L/-
10.1.2.0/24 10 NULL Vlanif20 Direct D/-/L/-
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut, U-Up/
Down Bit Set
As shown in the routing table, when the maximum number of equal-cost routes
for load balancing is set to 1, IS-IS selects 10.1.1.2 as the next hop to the
destination network 172.17.1.0. This is because IS-IS selects the route with next
hop 10.1.1.2 as the optimal route because SwitchB has a smaller system ID.
Step 5 Restore the default number of equal-cost routes for load balancing on SwitchA.
[SwitchA] isis 1
[SwitchA-isis-1] undo maximum load-balancing
[SwitchA-isis-1] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 594
# View the routing table of SwitchA.
[SwitchA] display isis route
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-2 Forwarding Table
--------------------------------
IPV4 Destination IntCost ExtCost ExitInterface NextHop Flags
-------------------------------------------------------------------------------
172.17.1.0/24 30 NULL Vlanif10 10.1.1.2 A/-/-/-
Vlanif20 10.1.2.2
172.16.1.0/24 10 NULL Vlanif50 Direct D/-/L/-
192.168.0.0/24 20 NULL Vlanif10 10.1.1.2 A/-/-/-
192.168.1.0/24 20 NULL Vlanif20 10.1.2.2 A/-/-/-
10.1.1.0/24 10 NULL Vlanif10 Direct D/-/L/-
10.1.2.0/24 10 NULL Vlanif20 Direct D/-/L/-
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut, U-Up/
Down Bit Set
As shown in the routing table, the number of equal-cost routes for load balancing
is restored to the default value. Both the next hops of SwitchA, 10.1.1.2 (SwitchB)
and 10.1.2.2 (SwitchC) now become valid.
Step 6 (Optional) Set the preference for equal-cost routes on SwitchA.
[SwitchA] isis
[SwitchA-isis-1] nexthop 10.1.2.2 weight 1
[SwitchA-isis-1] quit
Step 7 Verify the configuration.
# View the routing table of SwitchA.
[SwitchA] display isis route
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-2 Forwarding Table
--------------------------------
IPV4 Destination IntCost ExtCost ExitInterface NextHop Flags
-------------------------------------------------------------------------------
172.17.1.0/24 30 NULL Vlanif20 10.1.2.2 A/-/-/-
172.16.1.0/24 10 NULL Vlanif50 Direct D/-/L/-
192.168.0.0/24 20 NULL Vlanif10 10.1.1.2 A/-/-/-
192.168.1.0/24 20 NULL Vlanif20 10.1.2.2 A/-/-/-
10.1.1.0/24 10 NULL Vlanif10 Direct D/-/L/-
10.1.2.0/24 10 NULL Vlanif20 Direct D/-/L/-
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut, U-Up/
Down Bit Set
As shown in the routing table, the preference of the next hop 10.1.2.2 (SwitchC)
with the weight as 1, is higher than that of 10.1.1.2 (SwitchB), after the weight is
set for equal-cost routes. Therefore, IS-IS selects route with the next hop 10.1.2.2
as the optimal route.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 595
#
vlan batch 10 20 50
#
isis 1
is-level level-2
network-entity 10.0000.0000.0001.00
nexthop 10.1.2.2 weight 1
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
isis enable 1
#
interface Vlanif20
ip address 10.1.2.1 255.255.255.0
isis enable 1
#
interface Vlanif50
ip address 172.16.1.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 50
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 30
#
isis 1
is-level level-2
network-entity 10.0000.0000.0002.00
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
isis enable 1
#
interface Vlanif30
ip address 192.168.0.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 40
#
isis 1
is-level level-2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 596
network-entity 10.0000.0000.0003.00
#
interface Vlanif20
ip address 10.1.2.2 255.255.255.0
isis enable 1
#
interface Vlanif40
ip address 192.168.1.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30 40 60
#
isis 1
is-level level-2
network-entity 10.0000.0000.0004.00
#
interface Vlanif30
ip address 192.168.0.2 255.255.255.0
isis enable 1
#
interface Vlanif40
ip address 192.168.1.2 255.255.255.0
isis enable 1
#
interface Vlanif60
ip address 172.17.1.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 60
#
return
7.19.5 Example for Configuring IS-IS Auto FRR (IP Protecting
IP)
Networking Requirements
As shown in Figure 7-37, four switches (SwitchA, SwitchB, SwitchC, and SwitchD)
communicate using IS-IS. Reliability of data forwarding from SwitchA to SwitchD
needs to be improved so that uninterrupted traffic transmission is ensured when a
fault occurs on the network.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 597
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 7-37 Networking diagram of configuring IS-IS Auto FRR
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IP addresses for interfaces and enable IS-IS on each switch to
ensure reachable routes between the switches.
2. Set a larger link cost (in compliance with the traffic protection inequality of
IS-IS Auto FRR) on GigabitEthernet0/0/2 of SwitchA to ensure that Link T
functions as the primary link to forward data from SwitchA to SwitchD.
3. Configure IS-IS Auto FRR on SwitchA to allow traffic to be fast switched to the
backup link without waiting for route convergence when a fault occurs on
Link T. This ensures uninterrupted traffic transmission.
Procedure
Step 1 Configure VLANs that interfaces belong to.
# Configure SwitchA. The configurations of SwitchB, SwitchC and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 598
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.0.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 10.2.0.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure basic IS-IS functions.
# Configure SwitchA.
[SwitchA] isis 1
[SwitchA-isis-1] is-level level-1-2
[SwitchA-isis-1] network-entity 10.0000.0000.0001.00
[SwitchA-isis-1] quit
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] isis enable 1
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] isis enable 1
[SwitchA-Vlanif20] quit
# Configure SwitchB.
[SwitchB] isis 1
[SwitchB-isis-1] is-level level-1-2
[SwitchB-isis-1] network-entity 10.0000.0000.0002.00
[SwitchB-isis-1] quit
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] isis enable 1
[SwitchB-Vlanif20] quit
[SwitchB] interface vlanif 30
[SwitchB-Vlanif30] isis enable 1
[SwitchB-Vlanif30] quit
# Configure SwitchC.
[SwitchC] isis 1
[SwitchC-isis-1] is-level level-1-2
[SwitchC-isis-1] network-entity 10.0000.0000.0003.00
[SwitchC-isis-1] quit
[SwitchC] interface vlanif 10
[SwitchC-Vlanif10] isis enable 1
[SwitchC-Vlanif10] quit
[SwitchC] interface vlanif 50
[SwitchC-Vlanif50] isis enable 1
[SwitchC-Vlanif50] quit
# Configure SwitchD.
[SwitchD] isis 1
[SwitchD-isis-1] is-level level-1-2
[SwitchD-isis-1] network-entity 10.0000.0000.0004.00
[SwitchD-isis-1] quit
[SwitchD] interface vlanif 50
[SwitchD-Vlanif50] isis enable 1
[SwitchD-Vlanif50] quit
[SwitchD] interface vlanif 30
[SwitchD-Vlanif30] isis enable 1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 599
[SwitchD-Vlanif30] quit
[SwitchD] interface vlanif 40
[SwitchD-Vlanif40] isis enable 1
[SwitchD-Vlanif40] quit
Step 4 Set the cost of Vlanif20 on SwitchA to 30, and then check routing information.
# Configure the cost of Vlanif20 on SwitchA to 30.
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] isis cost 30
[SwitchA-Vlanif20] quit
# Check information about the link from SwitchA to SwitchD. Link T has a lower
cost, and thereby IS-IS optimally selects Link T to send traffic that is forwarded by
SwitchA.
[SwitchA] display isis route 192.168.1.1 verbose
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-1 Forwarding Table
--------------------------------
IPV4 Dest : 192.168.1.0/24 Int. Cost : 30 Ext. Cost : NULL
Admin Tag : - Src Count : 1 Flags : A/-/L/-
Priority : Low
NextHop : Interface : ExitIndex :
10.1.0.2 Vlanif10 0x00000003
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut,
U-Up/Down Bit Set
ISIS(1) Level-2 Forwarding Table
--------------------------------
IPV4 Dest : 192.168.1.0/24 Int. Cost : 30 Ext. Cost : NULL
Admin Tag : - Src Count : 3 Flags : -/-/-/-
Priority : Low
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut,
U-Up/Down Bit Set
# Run the display fib 192.168.1.1 verbose command on SwitchA to check the
forwarding entry from SwitchA to SwitchD.
[SwitchA] display fib 192.168.1.1 verbose
Route Entry Count: 1
Destination: 192.168.1.0 Mask : 255.255.255.0
Nexthop : 10.1.0.2 OutIf : Vlanif10
LocalAddr : 10.1.0.1 LocalMask: 0.0.0.0
Flags : DGU Age : 26sec
ATIndex : 0 Slot : 0
LspFwdFlag : 0 LspToken : 0x0
InLabel : NULL OriginAs : 0
BGPNextHop : 0.0.0.0 PeerAs : 0
QosInfo : 0x0 OriginQos: 0x0
NexthopBak : 0.0.0.0 OutIfBak : [No Intf]
LspTokenBak: 0x0 InLabelBak : NULL
LspToken_ForInLabelBak : 0x0
EntryRefCount : 0
VlanId : 0x0
BgpKey : 0
BgpKeyBak : 0
LspType : 0 Label_ForLspTokenBak : 0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 600
MplsMtu : 0 Gateway_ForLspTokenBak : 0.0.0.0
NextToken : 0x0 IfIndex_ForLspTokenBak : 0
Label_NextToken : 0 Label : 0
LspBfdState : 0
As shown in the command output, the traffic from SwitchA to SwitchD is only
forwarded through Link T.
Step 5 Enable IS-IS Auto FRR on SwitchA, and then check the routing information.
# Enable IS-IS Auto FRR on SwitchA.
[SwitchA] isis
[SwitchA-isis-1] frr
[SwitchA-isis-1-frr] loop-free-alternate
# Check information about the link from SwitchA to SwitchD. You can find that IS-
IS creates a backup link because IS-IS Auto FRR is enabled.
[SwitchA] display isis route 192.168.1.1 verbose
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-1 Forwarding Table
--------------------------------
IPV4 Dest : 192.168.1.0/24 Int. Cost : 30 Ext. Cost : NULL
Admin Tag : - Src Count : 1 Flags : A/-/L/-
Priority : Low
NextHop : Interface : ExitIndex :
10.1.0.2 Vlanif10 0x00000003
(B)10.2.0.2 Vlanif20 0x00000004
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut,
U-Up/Down Bit Set
ISIS(1) Level-2 Forwarding Table
--------------------------------
IPV4 Dest : 192.168.1.0/24 Int. Cost : 30 Ext. Cost : NULL
Admin Tag : - Src Count : 3 Flags : -/-/-/-
Priority : Low
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut,
U-Up/Down Bit Set
# Check the protection type for the traffic from SwitchA to SwitchD.
[SwitchA] display isis spf-tree systemid 0000.0000.0004 verbose
Shortest Path Tree for ISIS(1)
------------------------------
ISIS(1) Level-1 Shortest Path Tree
----------------------------------
0000.0000.0004.00
Distance : 20
Distance-URT : 20
Flags : SPT/V6_Islt
IPv4 Nexthops-URT : 1
(1) 10.1.0.2 IF:Vlanif10 NBR:0000.0000.0003.00
(B) 10.2.0.2 IF:Vlanif20 NBR:0000.0000.0002.00
TYPE:LOOP-FREE PROTECT:LINK-NODE
IPv4 Nexthops-MIGP : 0
IPv6 Nexthops : 0
Neighbors: 2 (Children:1 Parents:1 Others:0)
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 601
(1) 0000.0000.0003.02
Cost : 10
Flags : Parent
(2) 0000.0000.0004.03
Cost : 10
Flags : Child
ISIS(1) Level-2 Shortest Path Tree
----------------------------------
0000.0000.0004.00
Distance : 20
Distance-URT : 20
Flags : SPT/V6_Islt
IPv4 Nexthops-URT : 1
(1) 10.1.0.2 IF:Vlanif10 NBR:0000.0000.0003.00
(B) 10.2.0.2 IF:Vlanif20 NBR:0000.0000.0002.00
TYPE:LOOP-FREE PROTECT:LINK-NODE
IPv4 Nexthops-MIGP : 0
IPv6 Nexthops : 0
Neighbors: 2 (Children:1 Parents:1 Others:0)
(1) 0000.0000.0003.02
Cost : 10
Flags : Parent
(2) 0000.0000.0004.03
Cost : 10
Flags : Child
As shown in the preceding command output, link-node dual protection is enabled
from SwitchA to SwitchD.
# Run the display fib 192.168.1.1 verbose command on SwitchA to check the
backup forwarding entry from SwitchA to SwitchD.
[SwitchA] display fib 192.168.1.1 verbose
Route Entry Count: 1
Destination: 192.168.1.0 Mask : 255.255.255.0
Nexthop : 10.1.0.2 OutIf : Vlanif10 LocalAddr : 10.1.0.1 LocalMask: 0.0.0.0
Flags : DGU Age : 6sec
ATIndex : 0 Slot : 0
LspFwdFlag : 0 LspToken : 0x0
InLabel : NULL OriginAs : 0
BGPNextHop : 0.0.0.0 PeerAs : 0
QosInfo : 0x0 OriginQos: 0x0
NexthopBak : 10.2.0.2 OutIfBak : Vlanif20
LspTokenBak: 0x0 InLabelBak : NULL
LspToken_ForInLabelBak : 0x0
EntryRefCount : 0
VlanId : 0x0
BgpKey : 0
BgpKeyBak : 0
LspType : 0 Label_ForLspTokenBak : 0
MplsMtu : 0 Gateway_ForLspTokenBak : 0.0.0.0
NextToken : 0x0 IfIndex_ForLspTokenBak : 0
Label_NextToken : 0 Label : 0
LspBfdState : 0
As shown in the command output, the master link from SwitchA to SwitchD is
Link T, the relevant backup link follows the route with Vlanif20 as the outbound
interface and 10.2.0.2 as the next hop.
Step 6 Verify the configuration.
# Run the shutdown command on Vlanif50 of SwitchC to make the link down.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 602
[SwitchC] interface vlanif 50
[SwitchC-Vlanif50] shutdown
# Run the display fib 192.168.1.1 verbose command immediately on SwitchA to
check information about the route from SwitchA to SwitchD.
[SwitchA] display fib 192.168.1.1 verbose
Route Entry Count: 1
Destination: 192.168.1.0 Mask : 255.255.255.0
Nexthop : 10.2.0.2 OutIf : Vlanif20
LocalAddr : 10.2.0.1 LocalMask: 0.0.0.0
Flags : DGU Age : 124sec
ATIndex : 0 Slot : 0
LspFwdFlag : 0 LspToken : 0x0
InLabel : NULL OriginAs : 0
BGPNextHop : 0.0.0.0 PeerAs : 0
QosInfo : 0x0 OriginQos: 0x0
NexthopBak : 0.0.0.0 OutIfBak : [No Intf]
LspTokenBak: 0x0 InLabelBak : NULL
LspToken_ForInLabelBak : 0x0
EntryRefCount : 0
VlanId : 0x0
BgpKey : 0
BgpKeyBak : 0
LspType : 0 Label_ForLspTokenBak : 0
MplsMtu : 0 Gateway_ForLspTokenBak : 0.0.0.0
NextToken : 0x0 IfIndex_ForLspTokenBak : 0
Label_NextToken : 0 Label : 0
LspBfdState : 0
As shown in the command output, the traffic forwarded by the SwitchA is
switched to the backup link, with Vlanif20 as the outbound interface and 10.2.0.2
as the next hop.
NOTE
If a fault occurs on the network, IS-IS Auto FRR ensures the fast switchover of the traffic to
the backup link before the network convergence, and consequently protects traffic.
----End
Configuration Files
● Configuration file of SwitchA
#
sysname SwitchA
#
vlan batch 10 20
#
isis 1
network-entity 10.0000.0000.0001.00
frr
loop-free-alternate level-1
loop-free-alternate level-2
#
interface Vlanif10
ip address 10.1.0.1 255.255.255.0
isis enable 1
#
interface Vlanif20
ip address 10.2.0.1 255.255.255.0
isis enable 1
isis cost 30
#
interface GigabitEthernet0/0/1
port link-type trunk
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 603
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
return
● Configuration file of SwitchB
#
sysname SwitchB
#
vlan batch 20 30
#
isis 1
network-entity 10.0000.0000.0002.00
#
interface Vlanif20
ip address 10.2.0.2 255.255.255.0
isis enable 1
#
interface Vlanif30
ip address 10.3.0.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
return
● Configuration file of SwitchC
#
sysname SwitchC
#
vlan batch 10 50
#
isis 1
network-entity 10.0000.0000.0003.00
#
interface Vlanif10
ip address 10.1.0.2 255.255.255.0
isis enable 1
#
interface Vlanif50
ip address 10.4.0.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
return
● Configuration file of SwitchD
#
sysname SwitchD
#
vlan batch 30 40 50
#
isis 1
network-entity 10.0000.0000.0004.00
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 604
#
interface Vlanif50
ip address 10.4.0.2 255.255.255.0
isis enable 1
#
interface Vlanif30
ip address 10.3.0.2 255.255.255.0
isis enable 1
#
interface Vlanif40
ip address 192.168.1.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 50
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 40
#
return
7.19.6 Example for Configuring Static BFD for IS-IS
Networking Requirements
As shown in Figure 7-38, three routers are interconnected using IS-IS, and SwitchA
and SwitchB communicate with each other through a Layer 2 switch. When the
link between SwitchA and SwitchB is faulty, the two routers need to rapidly
respond to the fault and reestablish a neighbor relationship.
Figure 7-38 Networking diagram of configuring static BFD for IS-IS
NOTE
BFD for IS-IS cannot be used to detect the multi-hop link between SwitchA and SwitchC,
because the IS-IS neighbor relationship cannot be established between SwitchA and
SwitchC.
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IP addresses for interfaces and enable IS-IS on each router to
ensure reachable routes between the routers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 605
2. Enable static BFD for IS-IS on SwitchA and SwitchB so that routers can rapidly
detect link faults.
Procedure
Step 1 Configure VLANs that each interface belongs to.
# Configure SwitchA. The configurations of Switch, SwitchB and SwitchC are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign the IP addresses for VLANIF interfaces.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
Step 3 Configure basic IS-IS functions.
# Configure SwitchA.
[SwitchA] isis 1
[SwitchA-isis-1] is-level level-2
[SwitchA-isis-1] network-entity aa.1111.1111.1111.00
[SwitchA-isis-1] quit
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] isis enable 1
[SwitchA-Vlanif10] quit
# Configure SwitchB.
[SwitchB] isis 1
[SwitchB-isis-1] is-level level-2
[SwitchB-isis-1] network-entity aa.2222.2222.2222.00
[SwitchB-isis-1] quit
[SwitchB] interface vlanif 10
[SwitchB-Vlanif10] isis enable 1
[SwitchB-Vlanif10] quit
[SwitchB] interface vlanif 30
[SwitchB-Vlanif30] isis enable 1
[SwitchB-Vlanif30] quit
# Configure SwitchC.
[SwitchC] isis 1
[SwitchC-isis-1] is-level level-2
[SwitchC-isis-1] network-entity aa.3333.3333.3333.00
[SwitchC-isis-1] quit
[SwitchC] interface vlanif 30
[SwitchC-Vlanif30] isis enable 1
[SwitchC-Vlanif30] quit
# After the preceding configurations, you can see that the neighbor relationship is
established between SwitchA and SwitchB.
[SwitchA] display isis peer
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 606
Peer information for ISIS(1)
System Id Interface Circuit Id State HoldTime Type PRI
-------------------------------------------------------------------------------
2222.2222.2222 Vlanif10 1111.1111.1111.01 Up 23s L2 64
Total Peer(s): 1
The IS-IS routing table of SwitchA contains the routes to SwitchB and SwitchC.
[SwitchA] display isis route
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-2 Forwarding Table
--------------------------------
IPV4 Destination IntCost ExtCost ExitInterface NextHop Flags
-------------------------------------------------------------------------------
10.2.1.0/24 20 NULL Vlanif10 10.1.1.2 A/-/L/-
10.1.1.0/24 10 NULL Vlanif10 Direct D/-/L/-
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut, U-Up/
Down Bit Set
Step 4 Configure BFD.
# Enable BFD on SwitchA and configure a BFD session.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] bfd atob bind peer-ip 10.1.1.2 interface vlanif 10
[SwitchA-bfd-session-atob] discriminator local 1
[SwitchA-bfd-session-atob] discriminator remote 2
[SwitchA-bfd-session-atob] commit
[SwitchA-bfd-session-atob] quit
# Enable BFD on SwitchB and configure a BFD session.
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] bfd btoa bind peer-ip 10.1.1.1 interface vlanif 10
[SwitchB-bfd-session-btoa] discriminator local 2
[SwitchB-bfd-session-btoa] discriminator remote 1
[SwitchB-bfd-session-btoa] commit
[SwitchB-bfd-session-btoa] quit
After the preceding configurations are complete, run the display bfd session all
command on SwitchA or SwitchB, and you can see that the status of the BFD
session is Up.
The following uses the display on SwitchA as an example.
[SwitchA] display bfd session all
--------------------------------------------------------------------------------
Local Remote PeerIpAddr State Type InterfaceName
--------------------------------------------------------------------------------
1 2 10.1.1.2 Up S_IP_IF Vlanif10
--------------------------------------------------------------------------------
Total UP/DOWN Session Number : 1/0
Step 5 Enable IS-IS fast detection.
# Configure SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] isis bfd static
[SwitchA-Vlanif10] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 607
# Configure SwitchB.
[SwitchB] interface vlanif 10
[SwitchB-Vlanif10] isis bfd static
[SwitchB-Vlanif10] quit
Step 6 Verify the configuration.
# Enable debugging on SwitchA and export information to the VTY tunnel.
[SwitchA] info-center source bfd channel 1 log level debugging state on
[SwitchA] quit
<SwitchA> debugging isis circuit-information
<SwitchA> terminal debugging
<SwitchA> terminal logging
<SwitchA> terminal monitor
# Run the shutdown command on GigabitEthernet0/0/1 on SwitchB to simulate a
link fault.
[SwitchB]interface gigabitethernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] shutdown
# On SwitchA, you can view the following log and debugging information, which
indicates that IS-IS deletes the neighbor relationship with SwitchB after being
notified by BFD of the fault.
May 19 2013 09:34:49+08:00 SwitchB %%01ISIS/4/PEER_DOWN_BFDDOWN(l)[2]:ISIS 1 ne
ighbor 2222.2222.2222 was Down on interface Vlanif2710 because the BFD node was d
own.
The Hello packet was received at 09:29:39 last time; the maximum interval for se
nding Hello packets was 8944; the local router sent 392 Hello packets and receiv
ed 2 packets; the type of the Hello packet was Lan Level-2.
Run the display isis route command or the display isis peer command on
SwitchA, and you can see that no information is displayed. This indicates that the
IS-IS neighbor relationship between SwitchA and SwitchB is deleted.
# After the configuration is checked, disable debugging on SwitchA.
<SwitchA> undo debugging isis circuit-information
<SwitchA> undo terminal debugging
<SwitchA> undo terminal logging
<SwitchA> undo terminal monitor
----End
Configuration Files
● Switch configuration file
#
sysname Switch
#
vlan batch 10
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchA configuration file
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 608
#
sysname SwitchA
#
info-center source BFD channel 1 log level debugging
#
vlan batch 10
#
bfd
#
isis 1
is-level level-2
network-entity aa.1111.1111.1111.00
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
isis enable 1
isis bfd static
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
bfd atob bind peer-ip 10.1.1.2 interface Vlanif10
discriminator local 1
discriminator remote 2
commit
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 30
#
bfd
#
isis 1
is-level level-2
network-entity aa.2222.2222.2222.00
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
isis enable 1
isis bfd static
#
interface Vlanif30
ip address 10.2.1.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bfd btoa bind peer-ip 10.1.1.1 interface Vlanif10
discriminator local 2
discriminator remote 1
commit
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 30
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 609
#
isis 1
is-level level-2
network-entity aa.3333.3333.3333.00
#
interface Vlanif30
ip address 10.2.1.2 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
return
7.19.7 Example for Configuring Dynamic BFD for IS-IS
Networking Requirements
As shown in Figure 7-39, three routers are interconnected using IS-IS, and SwitchA
and SwitchB communicate with each other through a Layer 2 switch. When the
link that passes through the switch between SwitchA and SwitchB fails, the two
routers need to rapidly respond to the fault, and traffic can be switched to the link
that passes through SwitchC for forwarding.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 7-39 Networking diagram of configuring dynamic BFD for IS-IS
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IP addresses for interfaces and enable IS-IS on each router to
ensure reachable routes between the routers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 610
2. Set the IS-IS interface cost to control route selection of the routers to make
the link that passes through the switch from SwitchA to SwitchB as the
primary link and the link that passes through SwitchC as the backup link.
3. Configure dynamic BFD for IS-IS on SwitchA, SwitchB, and SwitchC so that
link faults can be detected rapidly and traffic can be switched to the backup
link for forwarding.
Procedure
Step 1 Configure VLANs that each interface belongs to.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign the IP addresses for VLANIF interfaces.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 10.3.3.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure basic IS-IS functions.
# Configure SwitchA.
[SwitchA] isis
[SwitchA-isis-1] is-level level-2
[SwitchA-isis-1] network-entity 10.0000.0000.0001.00
[SwitchA-isis-1] quit
[SwitchA] interface vlanif10
[SwitchA-Vlanif10] isis enable 1
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] isis enable 1
[SwitchA-Vlanif20] quit
# Configure SwitchB.
[SwitchB] isis
[SwitchB-isis-1] is-level level-2
[SwitchB-isis-1] network-entity 10.0000.0000.0002.00
[SwitchB-isis-1] quit
[SwitchB] interface vlanif 50
[SwitchB-Vlanif50] isis enable 1
[SwitchB-Vlanif50] quit
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] isis enable 1
[SwitchB-Vlanif20] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 611
[SwitchB] interface vlanif 40
[SwitchB-Vlanif40] isis enable 1
[SwitchB-Vlanif40] quit
# Configure SwitchC.
[SwitchC] isis
[SwitchC-isis-1] is-level level-2
[SwitchC-isis-1] network-entity 10.0000.0000.0003.00
[SwitchC-isis-1] quit
[SwitchC] interface vlanif 10
[SwitchC-Vlanif10] isis enable 1
[SwitchC-Vlanif10] quit
[SwitchC] interface vlanif 50
[SwitchC-Vlanif50] isis enable 1
[SwitchC-Vlanif50] quit
# After the preceding configurations, run the display isis peer command. You can
see that the neighbor relationships are established between SwitchA and SwitchB,
and between SwitchA and SwitchC. The following uses the configuration of
SwitchA as an example.
[SwitchA] display isis peer
Peer information for ISIS(1)
System Id Interface Circuit Id State HoldTime Type PRI
-------------------------------------------------------------------------------
0000.0000.0003 Vlanif10 0000.0000.0001.02 Up 21s L2 64
0000.0000.0002 Vlanif20 0000.0000.0002.01 Up 9s L2 64
Total Peer(s): 2
# Switches have learned routes from each other. The following uses the routing
table of SwitchA as an example.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 8 Routes : 9
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/24 Direct 0 0 D 10.1.1.1 Vlanif10
10.1.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
10.2.2.0/24 ISIS-L2 15 20 D 10.3.3.2 Vlanif20
ISIS-L2 15 20 D 10.1.1.2 Vlanif10
10.3.3.0/24 Direct 0 0 D 10.3.3.1 Vlanif20
10.3.3.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.1.0/24 ISIS-L2 15 20 D 10.3.3.2 Vlanif20
As shown in the routing table, the next-hop address of the route to 172.16.1.0/24
is 10.3.3.2, and traffic is transmitted on the primary link SwitchA→SwitchB.
Step 4 Set the interface cost.
# Configure SwitchA.
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] isis cost 5
[SwitchA-Vlanif20] quit
# Configure SwitchB.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 612
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] isis cost 5
[SwitchB-Vlanif20] quit
Step 5 Configure BFD for IS-IS processes.
# Enable BFD for IS-IS on SwitchA.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] isis
[SwitchA-isis-1] bfd all-interfaces enable
[SwitchA-isis-1] quit
# Enable BFD for IS-IS on SwitchB.
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] isis
[SwitchB-isis-1] bfd all-interfaces enable
[SwitchB-isis-1] quit
# Enable BFD for IS-IS on SwitchC.
[SwitchC] bfd
[SwitchC-bfd] quit
[SwitchC] isis
[SwitchC-isis-1] bfd all-interfaces enable
[SwitchC-isis-1] quit
# After the preceding configurations, run the display isis bfd session all
command on SwitchA, SwitchB, and SwitchC. You can see that the BFD session
status is Up.
The following uses the display on SwitchA as an example.
[SwitchA] display isis bfd session all
BFD session information for ISIS(1)
-----------------------------------
Peer System ID : 0000.0000.0003 Interface : Vlanif10
TX : 1000 BFD State : up Peer IP Address : 10.1.1.2
RX : 1000 LocDis : 8193 Local IP Address: 10.1.1.1
Multiplier : 3 RemDis : 8193 Type : L2
Diag : No diagnostic information
Peer System ID : 0000.0000.0002 Interface : Vlanif20
TX : 1000 BFD State : up Peer IP Address : 10.3.3.2
RX : 1000 LocDis : 8192 Local IP Address: 10.3.3.1
Multiplier : 3 RemDis : 8192 Type : L2
Diag : No diagnostic information
Total BFD session(s): 2
As shown in the preceding display, the status of the BFD session between SwitchA
and SwitchB and that between SwitchA and SwitchC is Up.
Step 6 Configure BFD for IS-IS interfaces.
# Configure BFD on VLANIF20 of SwitchA, set the minimum interval for sending
packets to 100 ms, the minimum interval for receiving packets to 100 ms, and the
local detection multiplier to 4.
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] isis bfd enable
[SwitchA-Vlanif20] isis bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchA-Vlanif20] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 613
# Configure BFD on VLANIF20 of SwitchB, set the minimum interval for sending
packets to 100 ms, the minimum interval for receiving packets to 100 ms, and the
local detection multiplier to 4.
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] isis bfd enable
[SwitchB-Vlanif20] isis bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchB-Vlanif20] quit
# After the preceding configurations, run the display isis bfd session all
command on SwitchA or SwitchB. You can see that the BFD parameters have
taken effect. The following uses the display on SwitchB as an example.
[SwitchB] display isis bfd session all
BFD session information for ISIS(1)
-----------------------------------
Peer System ID : 0000.0000.0003 Interface : Vlanif50
TX : 1000 BFD State : up Peer IP Address : 10.2.2.1
RX : 1000 LocDis : 8192 Local IP Address: 10.2.2.2
Multiplier : 3 RemDis : 8193 Type : L2
Diag : No diagnostic information
Peer System ID : 0000.0000.0001 Interface : Vlanif20
TX : 100 BFD State : up Peer IP Address : 10.3.3.1
RX : 100 LocDis : 8192 Local IP Address: 10.3.3.2
Multiplier : 4 RemDis : 8192 Type : L2
Diag : No diagnostic information
Total BFD session(s): 2
Step 7 Verify the configuration.
# Run the shutdown command on GigabitEthernet0/0/2 of SwitchB to simulate a
primary link failure.
[SwitchB] interface gigabitethernet 0/0/2
[SwitchB-GigabitEthernet0/0/2] shutdown
Step 8 # View the routing table of SwitchA.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 8 Routes : 8
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/24 Direct 0 0 D 10.1.1.1 Vlanif10
10.1.1.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
10.2.2.0/24 ISIS-L2 15 20 D 10.1.1.2 Vlanif10
10.3.3.0/24 Direct 0 0 D 10.3.3.1 Vlanif20
10.3.3.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.1.0/24 ISIS-L2 15 30 D 10.1.1.2 Vlanif10
As shown in the routing table, the backup link SwitchA→SwitchC→SwitchB takes
effect after the primary link fails, and the next-hop address of the route to
172.16.1.0/24 becomes 10.1.1.2.
# Run the display isis bfd session all command on SwitchA. You can see that the
status of the BFD session between SwitchA and SwitchC is Up.
[SwitchA] display isis bfd session all
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 614
BFD session information for ISIS(1)
-----------------------------------
Peer System ID : 0000.0000.0003 Interface : Vlanif10
TX : 1000 BFD State : up Peer IP Address : 10.1.1.2
RX : 1000 LocDis : 8193 Local IP Address: 10.1.1.1
Multiplier : 3 RemDis : 8193 Type : L2
Diag : No diagnostic information
Total BFD session(s): 1
----End
Configuration Files
● Switch configuration file
#
sysname Switch
#
vlan batch 20
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
return
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
bfd
#
isis 1
is-level level-2
bfd all-interfaces enable
network-entity 10.0000.0000.0001.00
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
isis enable 1
#
interface Vlanif20
ip address 10.3.3.1 255.255.255.0
isis enable 1
isis cost 5
isis bfd enable
isis bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
return
● SwitchB configuration file
#
sysname SwitchB
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 615
#
vlan batch 20 40 50
#
bfd
#
isis 1
is-level level-2
bfd all-interfaces enable
network-entity 10.0000.0000.0002.00
#
interface Vlanif20
ip address 10.3.3.2 255.255.255.0
isis enable 1
isis cost 5
isis bfd enable
isis bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
#
interface Vlanif40
ip address 172.16.1.1 255.255.255.0
isis enable 1
#
interface Vlanif50
ip address 10.2.2.2 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 50
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 40
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 10 50
#
bfd
#
isis 1
is-level level-2
bfd all-interfaces enable
network-entity 10.0000.0000.0003.00
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
isis enable 1
#
interface Vlanif50
ip address 10.2.2.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 616
7.19.8 Example for Configuring IS-IS GR
Networking Requirements
As shown in Figure 7-40, SwitchA, SwitchB, and SwitchC belong to the same
autonomous system. They run IS-IS to implement interworking and provide the GR
mechanism. When IS-IS is restarted on SwitchA, SwitchA resends connection
requests to neighbors to synchronize the LSDB.
Figure 7-40 Networking diagram of IS-IS GR configuration
Configuration Roadmap
The configuration roadmap is as follows:
1. Enable IS-IS on each Switch so that the Switches can be interconnected.
2. Configure GR in the IS-IS view on each Switch and configure the same interval
for the restart.
Procedure
Step 1 Configure VLANs that the related interfaces belong to.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan 10
[SwitchA-vlan10] quit
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
Step 3 Configure basic IS-IS functions.
# Configure SwitchA.
[SwitchA] isis 1
[SwitchA-isis-1] is-level level-1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 617
[SwitchA-isis-1] network-entity 10.0000.0000.0001.00
[SwitchA-isis-1] quit
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] isis enable 1
[SwitchA-Vlanif10] quit
# Configure SwitchB.
[SwitchB] isis 1
[SwitchB-isis-1] is-level level-2
[SwitchB-isis-1] network-entity 10.0000.0000.0002.00
[SwitchB-isis-1] quit
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] isis enable 1
[SwitchB-Vlanif20] quit
# Configure SwitchC.
[SwitchC] isis 1
[SwitchC-isis-1] network-entity 10.0000.0000.0003.00
[SwitchC-isis-1] quit
[SwitchC] interface vlanif 10
[SwitchC-Vlanif10] isis enable 1
[SwitchC-Vlanif10] quit
[SwitchC] interface vlanif 20
[SwitchC-Vlanif20] isis enable 1
[SwitchC-Vlanif20] quit
Step 4 Configure IS-IS GR and set the restart interval.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] isis 1
[SwitchA-isis-1] graceful-restart
[SwitchA-isis-1] graceful-restart interval 150
[SwitchA-isis-1] quit
[SwitchA] quit
Step 5 Verify the configuration.
# Run the display fib command on SwitchA to view the Forwarding Information
Base (FIB) table.
<SwitchA> display fib
Route Flags: G - Gateway Route, H - Host Route, U - Up Route
S - Static Route, D - Dynamic Route, B - Black Hole Route
L - Vlink Route
--------------------------------------------------------------------------------
FIB Table:
Total number of Routes : 5
Destination/Mask Nexthop Flag TimeStamp Interface TunnelID
127.0.0.1/32 127.0.0.1 HU t[21] InLoop0 0x0
127.0.0.0/8 127.0.0.1 U t[21] InLoop0 0x0
10.1.1.1/32 127.0.0.1 HU t[20678] InLoop0 0x0
10.1.1.0/24 10.1.1.1 U t[20678] Vlanif10 0x0
10.2.1.0/24 10.1.1.2 DGU t[79388] Vlanif10 0x0
# Reset the IS-IS process by using the GR method on SwitchA.
<SwitchA> reset isis all graceful-restart
NOTE
The Switch restarts an IS-IS process in GR mode only when GR is enabled for the IS-IS
process.
# Run the display fib command on SwitchA and view the FIB table to check
whether GR works normally. If GR works normally, the FIB table does not change
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 618
and the forwarding service is not affected when SwitchA restarts the IS-IS process
in GR mode.
<SwitchA> display fib
Route Flags: G - Gateway Route, H - Host Route, U - Up Route
S - Static Route, D - Dynamic Route, B - Black Hole Route
L - Vlink Route
--------------------------------------------------------------------------------
FIB Table:
Total number of Routes : 5
Destination/Mask Nexthop Flag TimeStamp Interface TunnelID
127.0.0.1/32 127.0.0.1 HU t[21] InLoop0 0x0
127.0.0.0/8 127.0.0.1 U t[21] InLoop0 0x0
10.1.1.1/32 127.0.0.1 HU t[20678] InLoop0 0x0
10.1.1.0/24 10.1.1.1 U t[20678] Vlanif10 0x0
10.2.1.0/24 10.1.1.2 DGU t[79388] Vlanif10 0x0
As shown in the display, the FIB table on SwitchA does not change and the
forwarding service is not affected.
# Disable IS-IS GR on SwitchA.
<SwitchA> system-view
[SwitchA] isis 1
[SwitchA-isis-1] undo graceful-restart
[SwitchA-isis-1] quit
[SwitchA] quit
# Reset the IS-IS process on SwitchA (not in GR mode).
<SwitchA> reset isis all
# Run the display fib command on SwitchA to view the FIB table.
<SwitchA> display fib
Route Flags: G - Gateway Route, H - Host Route, U - Up Route
S - Static Route, D - Dynamic Route, B - Black Hole Route
L - Vlink Route
--------------------------------------------------------------------------------
FIB Table:
Total number of Routes : 4
Destination/Mask Nexthop Flag TimeStamp Interface TunnelID
127.0.0.1/32 127.0.0.1 HU t[21] InLoop0 0x0
127.0.0.0/8 127.0.0.1 U t[21] InLoop0 0x0
10.1.1.1/32 127.0.0.1 HU t[20678] InLoop0 0x0
10.1.1.0/24 10.1.1.1 U t[20678] Vlanif10 0x0
As shown in the display, the FIB table on SwitchA changes and the forwarding
service is affected.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10
#
isis 1
graceful-restart
graceful-restart interval 150
is-level level-1
network-entity 10.0000.0000.0001.00
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 619
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 20
#
isis 1
graceful-restart
graceful-restart interval 150
is-level level-2
network-entity 10.0000.0000.0002.00
#
interface Vlanif20
ip address 10.2.1.2 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 10 20
#
isis 1
graceful-restart
graceful-restart interval 150
network-entity 10.0000.0000.0003.00
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
isis enable 1
#
interface Vlanif20
ip address 10.2.1.1 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
return
7.20 Troubleshooting IPv4 IS-IS
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 620
7.20.1 Failed to Establish IS-IS Neighbor Relationships
Fault Symptom
IS-IS neighbor relationship fails to be established when the link is working
properly.
Procedure
Step 1 Check whether devices on both ends of the link have the matching IS-IS levels.
● Run the display current-configuration configuration isis | include is-level
command to check the level configurations of IS-IS processes on both ends.
● Run the display current-configuration interface
interface-type interface-
number | include isis circuit-level command to check the IS-IS level
configuration of the specified interface.
IS-IS neighbor relationship can be established when IS-IS interfaces on both ends
of the link have the matching IS-IS levels.
NOTE
If you cannot view the IS-IS level of an interface using the display current-configuration
interface
interface-type interface-number | include isis circuit-level command, the
interface uses the default IS-IS level. To view the default IS-IS level, run the display
default-parameter isis command to check the Circuit-Level field.
Requirements on the IS-IS levels of interfaces on both ends of a link are as follows:
● If the IS-IS level of the local interface is Level-1, the IS-IS level of the remote interface
must be Level-1 or Level-1-2.
● If the IS-IS level of the local interface is Level-2, the IS-IS level of the remote interface
must be Level-2 or Level-1-2.
● If the IS-IS level of the local interface is Level-1-2, the IS-IS level of the remote
interface can be Level-1, Level-2, or Level-1-2.
If the IS-IS levels of interfaces on both ends of a link do not match, perform either
of the following operations to change the IS-IS level:
● Run the is-level command in the IS-IS view to change the global IS-IS level.
● Run the isis circuit-level command in the interface view to change the
interface IS-IS level.
Step 2 Check whether devices on both ends of the link have the matching area addresses.
Run the display current-configuration configuration isis command to check
area address information.
NOTE
If IS-IS Level-1 neighbor relationship needs to be established between devices on both ends,
ensure that the two devices reside in the same area.
A maximum of three area addresses can be configured for an IS-IS process. Devices on both
ends can establish IS-IS Level-1 neighbor relationship when the two devices have a same
area address.
When IS-IS Level-2 neighbor relationship needs to be established between the two devices,
the two devices can have the same or different area addresses.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 621
If the area addresses of the two devices are different, run the network-entity
command in the IS-IS view to set the same area address for the two devices.
Step 3 Check whether devices on both ends of the link have the authentication mode.
Run the display current-configuration interface
interface-type interface-number
| include isis authentication-mode command to check the IS-IS authentication
modes of the interfaces on both ends of the link.
If the two interfaces use different authentication modes, run the isis
authentication-mode command in the view of one interface to ensure that this
interface has the same authentication mode and password as the other interface.
----End
7.20.2 A Device Cannot Learn IS-IS Routes from Its Neighbor
Fault Symptom
A device cannot learn IS-IS routes from its neighbor when its link is working
properly.
Procedure
Step 1 Check whether IS-IS neighbor relationship has been established between the
device and its neighbor.
Run the display isis peer command on each device on the link to check whether
IS-IS neighbor relationship has been established.
If IS-IS neighbor relationship is not established, rectify the fault according to
7.20.1 Failed to Establish IS-IS Neighbor Relationships.
Step 2 Check whether the IS-IS routing table of the device is correct.
Run the display isis route command on the device to check the IS-IS routing
table.
1. If the IS-IS routing table contains specified routes, run the display ip routing-
table
ip-address [
mask |
mask-length ] verbose command to check whether
the IP routing table contains routes with higher protocol preference than IS-IS
routes.
NOTE
If the State field of a route displays Active Adv, the route is active. If there are routes
that have the same prefix but are discovered by different routing protocols, routes
with higher protocol preference are preferred as active routes.
2. If the IP routing table contains routes with higher protocol preference than IS-
IS routes, modify the configuration based on network planning.
Step 3 Check whether the device and its neighbor have the matching IS-IS cost style.
Run the display current-configuration configuration isis command on the
device and its neighbor to check the IS-IS cost style.
The device can learn IS-IS routes from its neighbor when it has the same IS-IS cost
style as its neighbor.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 622
The IS-IS cost style of a device can be set as follows:
● narrow: indicates that the device can receive and send packets with cost style
narrow.
● narrow-compatible: indicates that the device can receive packets with cost
style narrow or wide but sends only packets with cost style narrow.
● compatible: indicates that the device can receive and send packets with cost
style narrow or wide.
● wide-compatible: indicates that the device can receive packets with cost style
narrow or wide but sends only packets with cost style wide.
● wide: indicates that the device can receive and send packets with cost style
wide.
If the IS-IS cost styles of both ends are set to narrow and wide (or wide-
compatible) respectively, the two ends cannot communicate.
If the IS-IS cost styles of both ends are set to narrow-compatible and wide
respectively, the two ends cannot communicate either.
If the device and its neighbor have mismatching IS-IS cost styles, run the cost-
style command on the device to modify the configuration.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 7 IPv4 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 623
8 IPv6 IS-IS Configuration
8.1 Overview of IS-IS
8.2 Understanding IPv6 IS-IS
8.3 Summary of IPv6 IS-IS Configuration Tasks
8.4 Licensing Requirements and Limitations for IPv6 IS-IS
8.5 Default Settings for IPv6 IS-IS
8.6 Configuring Basic IPv6 IS-IS Functions
8.7 Improving IPv6 IS-IS Network Security
8.8 Controlling IPv6 IS-IS Route Selection
8.9 Controlling IPv6 IS-IS Route Exchange
8.10 Configuring IPv6 IS-IS Route Summarization
8.11 Controlling IPv6 IS-IS Route Convergence
8.12 Configuring LSP Fragment Extension
8.13 Configuring a Mesh Group on an NBMA Network
8.14 Configuring IPv6 IS-IS Reliability
8.15 Configuring the Overload Bit for an IS-IS Device
8.16 Maintaining IS-IS
8.17 Configuration Examples for IPv6 IS-IS
8.1 Overview of IS-IS
Definition
Intermediate System-to-Intermediate System (IS-IS) is an Interior Gateway
Protocol (IGP) that runs within an autonomous system (AS). IS-IS is also a link-
state routing protocol, using the shortest path first (SPF) algorithm to calculate
routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 624
Purpose
IS-IS is a dynamic routing protocol initially designed by the International
Organization for Standardization (ISO) for its Connectionless Network Protocol
(CLNP).
To support IP routing, the Internet Engineering Task Force (IETF) extended and
modified IS-IS in RFC 1195. This modification enables IS-IS to apply to TCP/IP and
OSI environments. This type of IS-IS is called Integrated IS-IS or Dual IS-IS.
NOTE
IS-IS stated in this document refers to Integrated IS-IS, unless otherwise stated.
In addition to IPv4 networks, IS-IS also applies to IPv6 networks to provide
accurate routing information for IPv6 packets. IS-IS has good scalability, supports
IPv6 network layer protocols, and is capable of discovering, generating, and
forwarding IPv6 routes.
8.2 Understanding IPv6 IS-IS
8.2.1 IPv6 IS-IS
IS-IS is a link-state dynamic routing protocol initially designed by the OSI. To
support IPv4 routing, IS-IS is applied to IPv4 networks and called Integrated IS-IS.
As IPv6 networks are built, IS-IS also needs to provide accurate routing
information for IPv6 packet forwarding. IS-IS has good scalability, supports IPv6
network layer protocols, and is capable of discovering, generating, and forwarding
IPv6 routes.
To process and calculate IPv6 routes, IS-IS uses two new TLVs and one network
layer protocol identifier (NLPID).
The two TLVs are as follows:
● TLV 236 (IPv6 Reachability): describes network reachability by defining the
route prefix and metric.
● TLV 232 (IPv6 Interface Address): is similar to the IP Interface Address TLV of
IPv4, except that it changes a 32-bit IPv4 address to a 128-bit IPv6 address.
The NLPID is an 8-bit field that identifies the protocol packets of the network
layer. The NLPID of IPv6 is 142 (0x8E). If IS-IS supports IPv6, it advertises routing
information through the NLPID value.
8.3 Summary of IPv6 IS-IS Configuration Tasks
Table 8-1 describes the IS-IS configuration tasks.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 625
Table 8-1 IS-IS configuration tasks
Scenario Description Task
Configuring basic IPv6
IS-IS functions
To deploy the IS-IS
protocol on IPv6
networks, configure basic
IS-IS functions to enable
communication between
different nodes on the
network. Other IS-IS
features can only be
configured after the
basic functions are
configured.
8.6 Configuring Basic
IPv6 IS-IS Functions
Configuring IPv6 IS-IS
network security
On IS-IS networks,
unauthorized users can
attack the IS-IS network
by modifying data
packets or forging
authorized users. To
ensure security of
services carried on IS-IS
networks, configure area
or domain
authentication and
interface authentication.
8.7 Improving IPv6 IS-IS
Network Security
Configuring IPv6 IS-IS
route selection
If multiple redundant
links are available in the
network using the IS-IS
protocol, the route in the
IS-IS routing table may
not be the expected
optimal route. This does
not meet the network
planning and traffic
management
requirements. To
optimize the IS-IS
network and facilitate
traffic management,
more accurate control of
the routes on the
network is required.
8.8 Controlling IPv6 IS-
IS Route Selection
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 626
Scenario Description Task
Configuring IPv6 IS-IS
routing information
exchange
In practical applications,
to meet network
requirements, configure
route policies to
accurately control
advertising and receiving
of IS-IS routing
information.
8.9 Controlling IPv6 IS-
IS Route Exchange
Configuring IPv6 IS-IS
route aggregation
Route aggregation
allows multiple routes
with the same IP prefix
to be aggregated into
one route.
Route aggregation on a
large IS-IS network can
effectively reduce entries
in the routing table. This
minimizes system
resource consumption
and facilitates
management. In
addition, if a link in the
aggregated IP address
segment frequently
alternates between Up
and Down, devices
outside this segment will
not be affected by the
change. This prevents
route flapping and
improves network
stability.
8.10 Configuring IPv6
IS-IS Route
Summarization
Configuring IPv6 IS-IS
route convergence
To enable IS-IS to rapidly
detect the network
changes, speed up the
IS-IS network
convergence. To
minimize the effect on
networks from route
flapping and reduce load
on the device, slow down
the IS-IS network
convergence.
8.11 Controlling IPv6
IS-IS Route
Convergence
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 627
Scenario Description Task
Configuring LSP
fragment extension
When information
contained in the LSP
data packet Protocol
Data Unit (PDU) to be
advertised by IS-IS
increases greatly, the IS-
IS device will generate
multiple LSP fragments
to carry and advertise
more information.
8.12 Configuring LSP
Fragment Extension
Configuring mesh groups On the NBMA network,
when an interface of the
switch receives a new
LSP, the LSP is flooded to
other interfaces of the
switch. On highly-
connected networks that
have multiple P2P links,
this processing method
results in repeated LSP
flooding and wastes
bandwidth resources.
To solve this problem,
create a mesh group and
add some interfaces to
the group. The switch
never floods the LSPs
received at interfaces in
the mesh group to other
interfaces from the same
group, and only floods
the LSPs to interfaces
from other groups or
interfaces that are not
configured to any mesh
groups.
8.13 Configuring a
Mesh Group on an
NBMA Network
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 628
Scenario Description Task
Configuring IPv6 IS-IS
overload
If the system cannot
store new LSPs or
synchronize the LSDB
normally, the calculated
routing information will
be incorrect. In this case,
the system can enter the
overload state. Routes
reached through the
device will not be
calculated, but routes
directly connected to the
device will not be
ignored.
When an IS-IS device on
the network requires
upgrade or maintenance,
the device needs to be
temporarily isolated
from the network. To
prevent other devices
from forwarding traffic
through this node, set
the overload bit for the
device.
8.15 Configuring the
Overload Bit for an IS-
IS Device
8.4 Licensing Requirements and Limitations for IPv6 IS-
IS
Involved Network Elements
Other network elements are required to support IPv6 IS-IS.
Licensing Requirements
IPv6 IS-IS is a basic feature of a switch and is not under license control.
Feature Support in V200R024C00
Only the following switch models support IPv6 IS-IS:
S5720I-SI, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S, S5731S-H,
S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and S6730S-
S
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 629
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
Feature Limitations
None.
8.5 Default Settings for IPv6 IS-IS
Table 8-2 describes the default settings for IPv6 IS-IS.
Table 8-2 Default settings for IPv6 IS-IS
Parameter Default Setting
IS-IS Disabled
DIS priority 64
Device level Level-1-2
Interval for sending Hello packets 10s
Minimum interval for sending LSPs 50 ms
Maximum number of LSPs to be sent 10
Interval for updating LSPs 900s
Maximum lifetime of LSPs 1200s
Bandwidth reference value 100 Mbit/s
8.6 Configuring Basic IPv6 IS-IS Functions
Pre-configuration Tasks
Before configuring basic IPv6 IS-IS functions, complete the following tasks:
● Enable the IPv6 forwarding capability on the device.
● Configure IPv6 addresses for interfaces to ensure that neighboring nodes are
reachable at the network layer.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 630
Configuration Procedure
1. Create an IS-IS process.
2. Configure a network entity title (NET).
3. Configure a device level.
4. Establish an IS-IS neighbor relationship.
8.6.1 Creating an IS-IS Process
Context
Creating an IS-IS process is the prerequisite for performing the IS-IS configuration.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
An IS-IS process is created, and the IS-IS process view is displayed.
The
process-id parameter specifies the ID of an IS-IS process. The default process
ID is 1.
Step 3 (Optional) Run description
description
A description for the IS-IS process is configured.
Step 4 (Optional) Enable IS-IS to add the POI and hostname TLV to Purge LSPs.
Run purge-originator-identification enable [ always ]
IS-IS is enabled to determine whether to add the POI TLV and hostname TLV to
Purge LSPs based on the authentication configuration.
● If the purge-originator-identification enable command is run and any
authentication is configured, generated Purge LSPs do not carry the POI TLV
or hostname TLV.
● If the purge-originator-identification enable command is run and no
authentication is configured, generated Purge LSPs carry the POI TLV or
hostname TLV.
● If the purge-originator-identification enable always command is run,
generated Purge LSPs carry the POI TLV and hostname TLV, regardless of
whether authentication is configured.
----End
8.6.2 Configuring a NET and Enabling IPv6 IS-IS
Context
NET is the special form of the network service access point (NSAP). After the IS-IS
view is displayed, IS-IS can start only when a NET is configured for an IS-IS
process.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 631
Generally, you only need to configure one NET for an IS-IS process. When an area
needs to be redefined, for example, the area needs to be merged with other areas
or divided into sub-areas, configure multiple NETs to ensure route correctness. A
maximum of three area addresses can be configured for an IS-IS process.
Therefore, a maximum of three NETs can be configured for an IS-IS process. When
configuring multiple NETs, ensure that their system IDs are the same.
IS-IS can run on an IPv6 topology only when IPv6 is enabled on an IS-IS process.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS process view is displayed.
Step 3 Run network-entity
net
A NET is configured.
NOTE
Configuring NETs based on loopback interface addresses is recommended to ensures that a
NET is unique on the network. If NETs are not unique, route flapping will easily occur.
An area ID is used to uniquely identify an area in the same IS-IS domain. All routers in the
same Level-1 area must share the same area ID, while routers in the same Level-2 area can
have different area IDs.
Step 4 Run ipv6 enable
IPv6 is enabled for the IS-IS process.
----End
8.6.3 Configuring a Device Level
Context
Configure a device level according to network planning requirements:
● A Level-1 device can establish neighbor relationships with only Level-1 and
Level-1-2 routers in the same area and maintains only Level-1 LSDBs.
● A Level-2 device can establish neighbor relationship with Level-2 routers in
the same area or different areas and with Level-1-2 routers in different areas
and maintain only Level-2 LSDB.
● A Level-1-2 device can establish neighbor relationships with Level-1 and
Level-2 routers and maintain Level-1 and Level-2 LSDBs.
NOTICE
If the levels of IS-IS devices are changed during network operation, the IS-IS
process will be restarted, and IS-IS neighbor relationships will be disconnected.
Setting the levels of devices when configuring IS-IS is recommended.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 632
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS process view is displayed.
Step 3 Run is-level { level-1 | level-1-2 | level-2 }
A level is configured for the switch.
By default, the level of the switch is Level-1-2.
----End
8.6.4 Establishing an IS-IS Neighbor Relationship
Context
The methods to establish IS-IS neighbor relationships on a broadcast network and
a P2P network are different. Therefore, you need to set different IS-IS attributes
for interfaces of different types:
● On a broadcast network, IS-IS needs to select a designated intermediate
system (DIS). You can set DIS priorities for IS-IS interfaces to enable the
device with the highest DIS priority to be elected as the DIS.
● On a P2P network, IS-IS does not need to select the DIS. Therefore, the DIS
priority does not need to be configured for interfaces. To ensure P2P link
reliability, configure IS-IS to establish neighbor relationships on P2P interfaces
in 3-way mode for unidirectional link fault detection.
Generally, IS-IS checks the IP addresses of received Hello packets. Neighbor
relationships can be established only when the IP address carried in a received
Hello packet and the address of the interface that receives the Hello packet
are on the same network segment. If the IP addresses of the two P2P
interfaces are on different network segments and the isis peer-ip-ignore
command is run on the two interfaces, IS-IS does not check the peer IP
address. The neighbor relationship can be correctly established on the two
P2P interfaces.
Procedure
● Establish an IS-IS neighbor relationship on a broadcast link.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 633
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run ipv6 enable
IPv6 is enabled on the interface.
e. Run isis ipv6 enable [
process-id ]
IS-IS IPv6 is enabled on the interface.
After this command is run, IS-IS establishes neighbor relationships and
floods LSPs through this interface.
NOTE
Loopback interfaces are not used to establish neighbor relationships. If IS-IS is
enabled on a loopback interface, IS-IS advertises the routes of the network
segment where the interface resides through other IS-IS interfaces.
f. Run isis circuit-level [ level-1 | level-1-2 | level-2 ]
A level is configured for the interface.
By default, the level of an interface is Level-1-2.
When two Level-1-2 devices establish an IS-IS neighbor relationship, they
establish both Level-1 and Level-2 neighbor relationships. To allow the
two Level-1-2 devices to establish only Level-1 or Level-2 neighbor
relationship, change the level of interfaces.
NOTE
Changing the level of an IS-IS interface is valid only when the level of the IS-IS
device is Level-1-2. If the level of the device is not Level-1-2, the level of the
device determines the level of the established neighbor relationship.
g. (Optional) Run isis dis-priority
priority [ level-1 | level-2 ]
A DIS priority is set for the interface. A larger value indicates a higher
priority.
By default, the DIS priority of Level-1 and Level-2 broadcast interfaces is
64.
h. (Optional) Run isis silent [ advertise-zero-cost ]
The interface is suppressed.
By default, an IS-IS interface is not suppressed.
When an IS-IS interface is suppressed, the interface no longer sends or
receives IS-IS packets. The routes of the network segment where the
interface resides, however, can still be advertised to other IS-IS devices
within the same AS.
● Establish an IS-IS neighbor relationship on a P2P link.
a. Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 634
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run ipv6 enable
IPv6 is enabled on the interface.
e. Run isis ipv6 enable [
process-id ]
IS-IS IPv6 is enabled on the interface.
f. Run isis circuit-level [ level-1 | level-1-2 | level-2 ]
A level is configured for the interface.
By default, the level of an interface is Level-1-2.
g. Run isis circuit-type p2p [ strict-snpa-check ]
The network type of the interface is set to P2P.
By default, the network type of an interface is determined by the physical
type of the interface.
When the network type of an IS-IS interface changes, the interface
configuration changes accordingly:
▪ After a broadcast interface is simulated as a P2P interface using the
isis circuit-type p2p [ strict-snpa-check ] command, the interval for
sending Hello packets, number of Hello packets that IS-IS does not
receive from a neighbor before the neighbor is declared Down,
interval for retransmitting LSPs on a P2P link, and various IS-IS
authentication modes are restored to the default settings; Other
configurations such as the DIS priority, DIS name, and interval for
sending CSNPs on a broadcast network become invalid.
▪ After the undo isis circuit-type command is run to restore the
default network type of an IS-IS interface, the interval for sending
Hello packets, number of Hello packets that IS-IS does not receive
from a neighbor before the neighbor is declared Down, interval for
retransmitting LSPs on a P2P link, various IS-IS authentication
modes, DIS priority, and interval for sending CSNPs on a broadcast
network are restored to the default settings.
h. Run isis ppp-negotiation { 2-way | 3-way [ only ] }
A negotiation mode is specified for the interface.
By default, the negotiation mode is 3-way.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 635
i. Run isis peer-ip-ignore
IS-IS is configured not to check the IP addresses of received Hello packets.
By default, IS-IS checks the IP addresses of received Hello packets.
j. Run isis ppp-osicp-check
OSICP negotiation status check is configured on the interface.
By default, the OSICP negotiation status of a PPP interface does not
affect the status of an IS-IS interface.
NOTE
This command applies only to PPP interfaces and is invalid for other P2P
interfaces.
After this command is run, the OSICP negotiation status of a PPP interface
affects the status of an IS-IS interface. When PPP detects that the OSI network
fails, the link status of the IS-IS interface goes Down, and the routes of the
network segment where the interface resides are not advertised through LSPs.
----End
8.6.5 Verifying the Basic IPv6 IS-IS Function Configuration
Procedure
● Run the display isis peer [ verbose ] [
process-id | vpn-instance
vpn-
instance-name ] command to check information about IS-IS neighbors.
● Run the display isis interface [ verbose ] [
process-id | vpn-instance
vpn-
instance-name ] command to check information about IS-IS interfaces.
● Run the display isis route [
process-id | vpn-instance
vpn-instance-name ]
ipv6 [ verbose | [ level-1 | level-2 ] |
ipv6-address [
prefix-length ] ] *
command to check information about IS-IS routes.
----End
8.7 Improving IPv6 IS-IS Network Security
Pre-configuration Tasks
Before improving IS-IS network security, configure basic IPv6 IS-IS functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the IPv6 IS-IS Network Security Optimization Configuration) in any sequence.
8.7.1 Configuring Interface Authentication
Context
Generally, the IS-IS packets to be sent are not encapsulated with authentication
information, and the received packets are not authenticated. If a user sends
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 636
malicious packets to attack a network, information on the entire network may be
stolen. Therefore, you can configure IS-IS authentication to improve network
security.
After the IS-IS interface authentication is configured, authentication information
can be encapsulated into the Hello packet to confirm the validity and correctness
of neighbor relationships.
NOTICE
If plain is selected during the configuration of the authentication mode for the IS-
IS interface, the password is saved in the configuration file in plain text. This
brings security risks. It is recommended that you select cipher to save the
password in cipher text.
Simple authentication and MD5 authentication have potential security risks.
HMAC-SHA256 or Keychain authentication mode is recommended.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run any of the following commands to configure an authentication mode for the
IS-IS interface as required:
● Run isis authentication-mode simple { plain
plain-text | [ cipher ]
plain-
cipher-text } [ level-1 | level-2 ] [ ip | osi ] [ send-only ]
Simple authentication is configured for the IS-IS interface.
● Run isis authentication-mode md5 { plain
plain-text | [ cipher ]
plain-
cipher-text } [ level-1 | level-2 ] [ ip | osi ] [ send-only ]
MD5 authentication is configured for the IS-IS interface.
● Run isis authentication-mode hmac-sha256 key-id
key-id { plain
plain-text |
[ cipher ]
plain-cipher-text } [ level-1 | level-2 ] [ send-only ]
HMAC-SHA256 authentication is configured for the IS-IS interface.
● Run isis authentication-mode keychain
keychain-name [ level-1 | level-2 ]
[ send-only ]
The Keychain authentication is configured for the IS-IS interface.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 637
By default, an IS-IS interface does not authenticate received Hello packets and no
authentication password is configured on the interface.
NOTE
Use the send-only parameter according to network requirements:
● If the send-only parameter is specified, the device only encapsulates the Hello packets
to be sent with authentication information rather than checks whether the received
Hello packets pass the authentication. When the Hello packets do not need to be
authenticated on the local device and pass the authentication on the remote device,
the two devices can establish the neighbor relationship.
● If the send-only parameter is not specified, ensure that passwords of all interfaces
with the same level on the same network are the same.
Parameters level-1 and level-2 apply only to the VLANIF interfaces on which IS-IS is
enabled using the isis ipv6 enable command.
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support keychain
keychain-name.
----End
8.7.2 Configuring Area or Domain Authentication
Context
Generally, the IS-IS packets to be sent are not encapsulated with authentication
information, and the received packets are not authenticated. If a user sends
malicious packets to attack a network, information on the entire network may be
stolen. Therefore, to improve the network security, you can configure IS-IS
authentication.
The area authentication password is encapsulated into Level-1 IS-IS packets. Only
the packets that pass the area authentication can be accepted. Therefore, you
must configure IS-IS area authentication on all the IS-IS devices in the specified
Level-1 area to authenticate the Level-1 area.
The domain authentication password is encapsulated into Level-2 IS-IS packets.
Only the packets that pass the domain authentication can be accepted. Therefore,
you must configure IS-IS domain authentication on all the IS-IS devices in the
Level-2 area to authenticate Level-2 area.
NOTICE
If plain is selected during the configuration of an area or domain authentication
mode, the password is saved in the configuration file in plain text. This brings
security risks. It is recommended that you select cipher to save the password in
cipher text.
Simple authentication and MD5 authentication have potential security risks.
HMAC-SHA256 authentication mode is recommended.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 638
NOTE
When configuring IS-IS authentication, the area or domain authentication modes and
passwords of the routers in the same area must be consistent so that IS-IS packets can be
flooded normally.
Whether IS-IS packets can pass area or domain authentication does not affect the
establishment of Level-1 or Level-2 neighbor relationships.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS process view is displayed.
Step 3 Perform the following operations in any sequence as required.
● Run area-authentication-mode { { simple | md5 } { plain
plain-text |
[ cipher ]
plain-cipher-text } [ ip | osi ] | keychain
keychain-name | hmac-
sha256 key-id
key-id } [ snp-packet { authentication-avoid | send-only } |
all-send-only ]
The area authentication mode is configured.
By default, the system neither encapsulates generated Level-1 packets with
authentication information nor authenticates received Level-1 packets.
● Run domain-authentication-mode { { simple | md5 } { plain
plain-text |
[ cipher ]
plain-cipher-text } [ ip | osi ] | keychain
keychain-name | hmac-
sha256 key-id
key-id } [ snp-packet { authentication-avoid | send-only } |
all-send-only ]
The domain authentication mode is configured.
By default, the system neither encapsulates generated Level-2 packets with
authentication information nor authenticates received Level-2 packets.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 639
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support keychain
keychain-name.
The authentication involves the following situations:
● The device encapsulates the authentication mode into LSPs and SNPs to be sent and
checks whether the received packets pass authentication. Then, the device discards the
packets that do not pass the authentication. In this case, the parameter snp-packet or
all-send-only is not specified.
● The device encapsulates authentication information into LSPs to be sent and checks
whether the received LSPs pass the authentication; the device neither encapsulates the
SNPs to be sent with authentication information nor checks whether the received SNPs
pass the authentication. In this case, the parameter snp-packet authentication-avoid
needs to be specified.
● The device encapsulates the LSPs and SNPs to be sent with authentication information;
the device, however, checks the authentication mode of only the received LSPs rather
than the received SNPs. In this case, the parameter snp-packet send-only needs to be
specified.
● The device encapsulates the LSPs and SNPs to be sent with authentication information,
but does not check whether the received LSPs or SNPs pass the authentication. In this
case, the parameter all-send-only needs to be specified.
----End
8.7.3 Configuring the Optional Checksum
Context
When a network is running, Intermediate System to Intermediate System (IS-IS)
routers may be attacked or IS-IS packets may be modified. As a result, important
network information may be intercepted, causing serious loss to the network. The
optional checksum encapsulates optional checksum TLVs into the Complete
Sequence Numbers Protocol Data Units (CSNPs), Partial Sequence Number
Protocol Data Units (PSNPs), and Hello packets sent by IS-IS routers. When the
peer device receives the encapsulated packets, it checks whether TLVs carried in
the packets are correct. If TLVs are not correct, the peer device discards the
packets for network security.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis
An IS-IS process is created and the IS-IS view is displayed.
Step 3 Run optional-checksum enable
IS-IS optional checksum is enabled.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 640
NOTE
If MD5 authentication or Keychain authentication with valid MD5 authentication is
configured on an IS-IS interface or area, IS-IS routers send Hello packets and SNP packets
carrying no checksum TLVs and verify the checksum of the received packets.
----End
8.7.4 Verifying the IPv6 IS-IS Network Security Optimization
Configuration
Procedure
● Run the display isis lsdb verbose command to check the detailed information
in the IS-IS LSDB.
----End
8.8 Controlling IPv6 IS-IS Route Selection
Pre-configuration Tasks
Before configuring IS-IS route selection, configure basic IPv6 IS-IS functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the IPv6 IS-IS Route Selection Control Configuration) in any sequence.
8.8.1 Configuring a Preference Value for IPv6 IS-IS
Context
If multiple routes to the same destination are discovered by different routing
protocols running on the same device, the route discovered by the protocol with
the highest preference is selected.
To prefer an IPv6 route discovered by IS-IS, configure a higher preference for IS-IS
IPv6 route. In addition, a routing policy can be configured to increase the
preferences of specified IS-IS IPv6 routes, without affecting route selection.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run ipv6 preference { route-policy
route-policy-name |
preference }*
An IS-IS IPv6 route preference value is configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 641
The default IS-IS IPv6 route preference value is 15. A smaller
preference value
indicates a higher preference.
----End
8.8.2 Configuring a Cost for IS-IS Interfaces on an IPv6
Network
Context
The costs of IS-IS interfaces can be determined in the following modes (in
descending order of priority):
● Interface cost: configured for a specified interface.
● Global cost: configured for all interfaces.
● Automatically calculated cost: automatically calculated based on the interface
bandwidth.
If no cost is configured for an IS-IS interface, the IS-IS interface uses the default
cost 10 and cost style narrow.
NOTICE
If you need to change the cost style of IS-IS devices, change it during the
configuration of basic IS-IS functions is recommended. If the cost style of IS-IS
devices is changed during network operation, the IS-IS process will be restarted,
and the neighbor relationship will be re-established.
Procedure
Step 1 Configure an IS-IS cost style.
1. Run system-view
The system view is displayed.
2. Run isis [
process-id ]
The IS-IS view is displayed.
3. Run cost-style { narrow | wide | wide-compatible | { narrow-compatible |
compatible } [ relax-spf-limit ] }
An IS-IS cost style is configured.
By default, the cost style of routes received and sent by an IS-IS device is
narrow.
The cost range of an interface and a route received by the interface vary with the
cost type.
● If the cost style is narrow, the cost of an interface ranges from 1 to 63. The
maximum cost of a route received by the interface is 1023.
● If the cost style is narrow-compatible or compatible, the cost of an interface
ranges from 1 to 63. The cost of a received route is related to relax-spf-limit.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 642
● If the cost style is wide-compatible or wide, the cost of the interface ranges
from 1 to 16777215. When the cost is 16777215, the neighbor TLV generated
on the link cannot be used for route calculation but for the transmission of TE
information. The maximum cost of a received route is 0xFFFFFFFF.
Step 2 Configure a cost for an IS-IS interface on an IPv6 network.
Perform any of the following operations as required:
Configure a cost for a specified IS-IS interface on an IPv6 network.
1. Run system-view
The system view is displayed.
2. Run interface
interface-type interface-number
The interface view is displayed.
3. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
4. Run isis ipv6 cost {
cost | maximum } [ level-1 | level-2 ]
A cost is configured for the IS-IS interface on an IPv6 network.
By default, the cost of an IS-IS interface on an IPv6 network is 10.
NOTE
You can configure the parameter maximum only when the IS-IS cost style is wide or wide-
compatible.
Configure a global IS-IS interface cost on an IPv6 network.
1. Run system-view
The system view is displayed.
2. Run isis [
process-id ]
The IS-IS view is displayed.
3. Run ipv6 circuit-cost {
cost | maximum } [ level-1 | level-2 ]
A global IS-IS interface cost on an IPv6 network is configured.
By default, no global cost is configured.
Enable IS-IS interfaces to automatically calculate their costs on an IPv6
network.
1. Run system-view
The system view is displayed.
2. Run isis [
process-id ]
The IS-IS view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 643
3. Run ipv6 bandwidth-reference
value
A bandwidth reference value is configured. By default, the value is 100 Mbit/s.
4. Run ipv6 auto-cost enable [ compatible ]
IS-IS interfaces are configured to automatically calculate their costs on an
IPv6 network.
The bandwidth reference value set using the ipv6 bandwidth-reference command
takes effect only when the cost style is wide or wide-compatible. In this case, the
interface cost is calculated using the following formula:
Cost of each interface = (Bandwidth-reference/Interface bandwidth) × 10
If the cost-style is narrow, narrow-compatible, or compatible, the cost of each
interface is based on costs listed in Table 8-3.
Table 8-3 Mapping between IS-IS interface costs and interface bandwidth
Cost Bandwidth Range
60 Interface bandwidth ≤ 10 Mbit/s
50 10 Mbit/s < Interface bandwidth ≤ 100
Mbit/s
40 100 Mbit/s < Interface bandwidth ≤ 155
Mbit/s
30 155 Mbit/s < Interface bandwidth ≤ 622
Mbit/s
20 622 Mbit/s < Interface bandwidth ≤ 2.5
Gbit/s
10 2.5 Gbit/s < Interface bandwidth
----End
8.8.3 Configuring Equal-Cost IPv6 IS-IS Routes
Context
If there are redundant IS-IS links, multiple routes may have an equal cost.
Configure load balancing among equal-cost IS-IS routes so that traffic will be
evenly balanced among these links. This mechanism increases the link bandwidth
usage and prevents network congestion caused by link overload. However, this
mechanism may make traffic management more difficult because traffic will be
randomly forwarded.
Procedure
● Configure load balancing among equal-cost IS-IS routes.
a. Run system-view
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 644
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run ipv6 maximum load-balancing
number
The maximum number of equal-cost IPv6 IS-IS routes for load-balancing
is set.
By default, load balancing is supported and a maximum of 8 equal-cost
routes can participate in load balancing.
NOTE
When the number of equal-cost routes is larger than the value specified in the
ipv6 maximum load-balancing command, valid routes are selected for load
balancing based on the following criteria:
1. Route preference: Routes with higher preferences are selected for load
balancing.
2. Next hop system ID: If routes have the same preference, routes with smaller
system IDs are selected for load balancing.
3. Interface index: If routes have the same preference and system ID, routes with
lower interface index values are selected for load balancing.
----End
8.8.4 Configuring IS-IS IPv6 Route Leaking
Context
If multiple Level-1-2 devices in a Level-1 area are connected to devices in the
Level-2 area, a Level-1 LSP sent by each Level-1-2 device carries an ATT flag bit of
1. This Level-1 area will have multiple routes to the Level-2 area and to other
Level-1 areas.
By default, routes in a Level-1 area can be leaked into the Level-2 area so that
Level-1-2 and Level-2 devices can learn about the topology of the entire network.
Devices in a Level-1 area are unaware of the entire network topology because
they only maintain LSDBs in the local Level-1 area. Therefore, a device in a Level-1
area can forward traffic to a Level-2 device only through the nearest Level-1-2
device. The route used may not be the optimal route to the destination.
To enable a device in a Level-1 area to select the optimal route, configure IS-IS
IPv6 route leaking so that specified routes in the Level-2 area can be leaked into
the local Level-1 area.
Routes of services deployed only in the local Level-1 area do not need to be
leaked into the Level-2 area. A policy can be configured to leak only desired routes
into the Level-2 area.
Procedure
● Specify IS-IS IPv6 routes in the Level-2 area and other Level-1 areas that can
be leaked into the local Level-1 area.
a. Run system-view
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 645
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run ipv6 import-route isis level-2 into level-1 [ tag
tag | filter-policy
{
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-prefix-name |
route-policy
route-policy-name } | direct { allow-filter-policy | allow-
up-down-bit } * ] *
IS-IS IPv6 routes in the Level-2 area and other Level-1 areas that meet
the specified conditions are leaked into the local Level-1 area.
By default, IS-IS IPv6 routes in the Level-2 area are not leaked into
Level-1 areas.
NOTE
The command in Step 3 is run on the Level-1-2 device that is connected to an
external area.
● Configure IS-IS IPv6 routes in Level-1 areas to leak into the Level-2 area.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run ipv6 import-route isis level-1 into level-2 [ tag
tag | filter-policy
{
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-prefix-name |
route-policy
route-policy-name }| direct allow-filter-policy ] *
IS-IS IPv6 routes that meet the specified conditions in Level-1 areas are
leaked into the Level-2 area.
By default, all Level-1 IS-IS IPv6 routing information, excluding
information about default routes, is leaked to Level-2 areas.
NOTE
The command in Step 3 is run on the Level-1-2 device that is connected to an
external area.
----End
8.8.5 Controlling Whether a Level-1 Device Generates an IPv6
Default Route
Context
As defined in the IS-IS protocol, if a Level-1-2 device reaches more areas through a
Level-2 area than through a Level-1 area based on the link state database (LSDB),
the Level-1-2 device sets the ATT bit to 1 in the LSPs and sends the LSPs with the
ATT bit 1 to the Level-1 device. Upon receipt, the Level-1 device generates a
default route destined for the Level-1-2 device.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 646
The preceding rules are used by default. You can set the ATT bit as required on a
live network.
Perform the following steps:
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run the following command as required:
● To set the ATT bit in the LSPs sent by the Level-1-2 device, run the attached-
bit advertise { always | never } command.
– If the always parameter is specified, the ATT bit is set to 1. After
receiving the LSPs carrying the ATT bit 1, the Level-1 device generates a
default route.
– If the never parameter is specified, the ATT bit is set to 0. After receiving
the LSPs carrying the ATT bit 0, the Level-1 device does not generate a
default route, which reduces the size of a routing table.
● To disable the Level-1 device from generating default routes even though it
receives the LSPs carrying the ATT bit 1, run the attached-bit avoid-learning
command.
----End
8.8.6 Verifying the IPv6 IS-IS Route Selection Control
Configuration
Procedure
● Run the display isis route [
process-id | vpn-instance
vpn-instance-name ]
ipv6 [ verbose | [ level-1 | level-2 ] |
ipv6-address [
prefix-length ] ] *
command to check IS-IS routing information.
● Run the display isis lsdb [ { level-1 | level-2 } | verbose | { local |
lsp-id | is-
name
symbolic-name } ] * [
process-id | vpn-instance
vpn-instance-name ]
command to check information in the IS-IS LSDB.
----End
8.9 Controlling IPv6 IS-IS Route Exchange
Pre-configuration Tasks
Before controlling IS-IS route exchange, configure basic IPv6 IS-IS functions.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 647
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the IPv6 IS-IS Route Exchange Control Configuration) in any sequence.
8.9.1 Configuring IS-IS to Advertise a Default Route
Context
If IS-IS is configured to advertise a default route on a border device that has
external routes, the device advertises a default route ::/0 in the IS-IS routing
domain. All traffic destined for other routing domains is first forwarded to the
border device.
NOTE
Configuring a static default route can also allow all the traffic to be first forwarded to a
border device, which then forwards the traffic outside an IS-IS routing domain. However,
this method leads to heavy workload in configuration and management when a large
number of devices are deployed on the network.
In addition, advertising default routes using IS-IS is flexible. If multiple border devices are
deployed, a routing policy can be configured to allow only the border device that meets the
specified conditions to advertise a default route, preventing routing blackholes.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run ipv6 default-route-advertise [ always | match default | route-policy
route-
policy-name ] [ cost
cost | tag
tag | [ level-1 | level-1-2 | level-2 ] ] * [ avoid-
learning ]
IS-IS is configured to advertise a default route.
By default, IS-IS does not advertise a default route.
----End
8.9.2 Configuring IS-IS to Import External Routes
Context
After IS-IS is configured to advertise a default route on a border device in an IS-IS
routing domain, all the traffic destined outside the IS-IS routing domain is
forwarded through the border device. This burdens the border device because
other devices in the IS-IS routing domain do not have the routes destined outside
the domain. If multiple border devices are deployed in the IS-IS routing domain,
optimal routes to other routing domains need to be selected.
To ensure optimal routes are selected, all the other devices in the IS-IS routing
domain must learn all or some external routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 648
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Configure IS-IS to import external routes.
● When you need to set a cost for imported routes, run the ipv6 import-route
{ static | direct | unr | { ospfv3 | ripng | isis } [
process-id ] | bgp [ permit-
ibgp ] } [ cost
cost | tag
tag | route-policy
route-policy-name | [ level-1 |
level-2 | level-1-2 ] ] * command.
● When you need to retain the original cost of imported routes, run the ipv6
import-route { direct | unr | { ospfv3 | ripng | isis } [
process-id ] | bgp
[ permit-ibgp ] } inherit-cost [ tag
tag | route-policy
route-policy-name |
[ level-1 | level-2 | level-1-2 ] ] * command. In this case, the source routing
protocol of imported routes cannot be static.
NOTE
IS-IS will advertise all imported external routes to the IS-IS routing domain by default.
----End
8.9.3 Configuring IS-IS to Advertise Specified External Routes
to an IS-IS Routing Domain
Context
When the local IS-IS device advertises imported external routes to other IS-IS
devices, routing policies can be configured to advertise only the external routes
that meet specified conditions if these devices do not require all the imported
external routes.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run ipv6 filter-policy {
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-
prefix-name | route-policy
route-policy-name } export [
protocol [
process-id ] ]
IS-IS is configured to advertise the external IPv6 routes that meet specified
conditions to the IS-IS routing domain.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 649
8.9.4 Adding Specified IS-IS Routes to an IPv6 Routing Table
Context
Only routes in an IPv6 routing table can be used to forward IPv6 packets. An IS-IS
route can take effect only after this IS-IS route has been successfully added to an
IPv6 routing table.
If an IS-IS route does not need to be added to a routing table, specify conditions,
such as IPv6 prefix, and routing policy, to filter the route. IS-IS routes that do not
meet the specified conditions cannot be added to the IPv6 routing table and
cannot be selected to forward IPv6 packets.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run ipv6 filter-policy {
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-
prefix-name | route-policy
route-policy-name } import
Conditions for filtering IS-IS routes are configured.
----End
8.9.5 Verifying the IPv6 IS-IS Route Exchange Control
Configuration
Procedure
● Run the display isis lsdb [ { level-1 | level-2 } | verbose | { local |
lsp-id | is-
name
symbolic-name } ] * [
process-id | vpn-instance
vpn-instance-name ]
command to check IS-IS LSDB information.
● Run the display isis route [
process-id | vpn-instance
vpn-instance-name ]
ipv6 [ verbose | [ level-1 | level-2 ] |
ipv6-address [
prefix-length ] ] *
command to check IS-IS routing information.
● Run the display ipv6 routing-table command to check the IPv6 routing table.
----End
8.10 Configuring IPv6 IS-IS Route Summarization
Pre-configuration Tasks
Before configuring IS-IS route summarization, configures basic IPv6 IS-IS
functions.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 650
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run ipv6 summary
ipv6-address prefix-length [ avoid-feedback |
generate_null0_route | tag
tag | [ level-1 | level-1-2 | level-2 ] ] *
The specified IPv6 IS-IS routes are summarized into one IS-IS route.
NOTE
After route summarization is configured on a device, the local routing table still contains all
specific routes before the summarization. The routing tables on other devices contain only
the summary route, and the summary route is deleted only after all its specific routes are
deleted.
----End
Verifying the Configuration
● Run the display isis route command to check summary routes in the IS-IS
routing table.
● Run the display ipv6 routing-table [ verbose ] command to check summary
routes in the IPv6 routing table.
8.11 Controlling IPv6 IS-IS Route Convergence
Pre-configuration Tasks
Before configuring IS-IS route convergence, configure basic IPv6 IS-IS functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the IPv6 IS-IS Route Convergence Control Configuration) in any sequence.
8.11.1 Configuring Attributes for Hello Packets
Context
IS-IS maintains neighbor relationships by sending and receiving Hello packets. If
the local device does not receive Hello packets from its neighbor within a specified
period, the device considers the neighbor Down.
In IS-IS, you can set the interval for sending Hello packets and the holding
multiplier of neighboring devices to control the holdtime of neighbor relationships
between the local device and neighbors.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 651
● If the interval for sending Hello packets is too short, more system resources
are consumed to send Hello packets, causing a heavy CPU load.
● If the holdtime of neighboring devices is too long, the local device needs to
spend much time detecting the failure of neighbors, slowing down IS-IS route
convergence. If the holdtime of neighboring devices is too short, some Hello
packets may be lost or become incorrect because of network transmission
delay and errors. This will cause neighbor relationships to frequently alternate
between Up and Down and lead to route flapping on the IS-IS network.
NOTE
You are advised to set the same interval for sending Hello packets and same holding
multiplier of neighboring devices on all the devices on the IS-IS network. This method
prevents IS-IS route convergence from being slowed down when some devices detect
link failures at a lower speed than other devices.
Procedure
● Configure an interval for sending Hello packets.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run isis timer hello
hello-interval [ level-1 | level-2 ]
An interval for sending Hello packets is set on an interface.
By default, the interval for sending Hello packets 10 seconds.
NOTE
Parameters level-1 and level-2 are configured only on a broadcast interface.
On a broadcast link, there are Level-1 and Level-2 Hello packets. For different
types of packets, you can set different intervals. If no level is specified, both the
Level-1 timer and Level-2 timer are configured. On a P2P link, there is only one
type of Hello packets. Therefore, neither level-1 nor level-2 is required.
● Set a holding multiplier for neighboring devices.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 652
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run isis timer holding-multiplier
number [ level-1 | level-2 ]
A holding multiplier of neighboring devices is set.
The default holding multiplier is 3. The holdtime of neighbor
relationships is three times the interval for sending Hello packets.
NOTE
Parameters level-1 and level-2 are configured only on a broadcast interface.
----End
8.11.2 Configuring Attributes for LSPs
Context
LSPs are used to exchange link state information. You can configure attributes for
LSPs to control the length and maximum lifetime of LSPs. To accelerate network
convergence, you can enable LSP fast flooding or reduce the minimum interval for
sending LSPs and the interval for updating LSPs to speed up LSP flooding.
However, CPU resources will be consumed too much if the network topology
changes frequently. In this situation, configure the intelligent timer for generating
LSPs. This timer can fast respond to emergencies, speed up network convergence,
and improve CPU resource efficiency because its interval becomes longer when the
network changes frequently.
Configured
Parameters
Function Usage Scenario
Maximum
length of
LSPs
Set a size
for LSPs to
be
generated
and LSPs
to be
received.
When the volume of link status information
increases, the length of LSPs to be generated can
be increased to carry more information in each LSP.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 653
Configured
Parameters
Function Usage Scenario
Maximum
lifetime of
LSPs
Set a
maximum
lifetime
for LSPs to
ensure the
validity of
an LSP
before its
updated
LSP is
received.
When a switch generates the system LSP, it fills in
the maximum lifetime for this LSP. After this LSP is
received by other switches, the lifetime of the LSP
is reduced gradually. If the switch does not receive
any more update LSPs and the lifetime of the LSP is
reduced to 0, the LSP will be deleted from the LSDB
60s later if no more updated LSPs are received.
Refresh
interval of
LSPs
Set a
refresh
interval
for LSPs to
synchroniz
e LSDBs.
On an IS-IS network, LSDB synchronization is
implemented through LSP flooding. During LSP
flooding, a switch sends an LSP to its neighbors
and then the neighbors send the received LSP to
their respective neighbors except the switch that
first sends the LSP. In this manner, the LSP is
flooded among the switches of the same level. LSP
flooding allows each switch of the same level to
have the same LSP information and synchronize its
LSDB with each other.
Minimum
interval at
which LSPs
are sent
Set an
interval
for
sending
an LSP
during LSP
update.
Reducing the minimum interval for sending LSPs
speeds up LSP flooding.
Intelligent
timer used to
generate
LSPs
Control
the
interval
for
generating
LSPs
intelligentl
y to speed
up route
convergen
ce and
reduce
system
load.
On an IS-IS network, if the local routing
information changes, a switch needs to generate a
new LSP to notify this change. If the local routing
information changes frequently, a large number of
new LSPs are generated, which occupies a lot of
system resources and decreases system
performance. To speed up network convergence
and prevent system performance from being
affected, configure an intelligent timer for
generating LSPs. This timer can adjust the delay in
generating LSPs based on the routing information
change frequency.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 654
Configured
Parameters
Function Usage Scenario
LSP fast
flooding
Control
the
number of
LSPs
flooded
each time
on an
interface
to speed
up IS-IS
network
convergen
ce.
When an IS-IS switch receives new LSPs from other
switches, it updates the LSPs in the local LSDB and
periodically floods out the updated LSPs according
to a timer. LSP fast flooding updates the preceding
method. When a device configured with LSP fast
flooding receives one or more new LSPs, it floods
out the LSPs with a number smaller than the
specified number before calculating routes. This
speeds up LSDB synchronization.
Interval at
which LSPs
are
retransmitted
over a P2P
link
Control
the
interval
for
retransmit
ting LSPs
to ensure
LSDB
synchroniz
ation on a
P2P
network.
On a point-to-point network, devices at both ends
of a link synchronize LSDBs with each other by
flooding LSPs. The device at one end of the link
sends an LSP. If the device at the other end receives
this LSP, it replies with a PSNP. If the device that
has sent an LSP does not receive a PSNP from the
other end in a period of time, the device will
retransmit the LSP.
Procedure
● Set a maximum length for LSPs.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Set a maximum length for LSPs.
▪ Run lsp-length originate
max-size
The maximum length is set for each generated LSP.
▪ Run lsp-length receive
max-size
The maximum length is set for each received LSP.
By default, the IS-IS system generates and receives 1497-byte LSPs.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 655
NOTE
Ensure that the value of
max-size for LSPs to be generated must be smaller than
or equal to the value of
max-size for LSPs to be received.
The value of
max-size set through the lsp-length command must meet the
following requirements; otherwise, the MTU status on the interface is considered
Down.
● The MTU of an Ethernet interface must be greater than or equal to the sum
of the value of
max-size and 3.
● The MTU of a P2P interface must be greater than or equal to the value of
max-size.
● Set a maximum lifetime for LSPs.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run timer lsp-max-age
age-time
A maximum lifetime is set for LSPs.
By default, the maximum lifetime of LSPs is 1200 seconds.
● Set a refresh interval for LSPs.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run timer lsp-refresh
refresh-time
A refresh interval is set for LSPs.
By default, the LSP refresh interval is 900s.
NOTE
Ensure that the LSP refresh interval is more than 300s shorter than the maximum
LSP lifetime. This allows new LSPs to reach all devices in an area before existing
LSPs expire.
The larger a network, the greater the deviation between the LSP refresh interval
and the maximum LSP lifetime.
● Set a minimum interval at which LSPs are sent.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 656
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run isis timer lsp-throttle
throttle-interval [ count
count ]
The minimum interval for sending LSPs on an IS-IS interface and the
maximum number of LSPs sent within the interval are set.
By default, the minimum interval for sending LSPs is 50 ms, and the
maximum number of LSPs sent each time is 10.
● Configure the intelligent timer used to generate LSPs.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run timer lsp-generation
max-interval [
init-interval [
incr-interval ] ]
[ level-1 | level-2 ]
The intelligent timer used to generate LSPs is set.
If no level is configured, both Level-1 and Level-2 are configured.
The initial delay for generating the same LSPs (or LSP fragments) is
init-
interval. The delay for generating the same LSPs (or LSP fragments) for
the second time is
incr-interval. When the routes change each time, the
delay for generating the same LSPs (or LSP fragments) is twice as the
previous value until the delay is up to
max-interval. After the delay
reaches
max-interval for three times or the IS-IS process is restarted, the
interval is reduced to
init-interval.
When
incr-interval is not used and generating the same LSPs (or LSP
fragments) for the first time,
init-interval is used as the initial delay. Then,
the delay for generating the same LSPs (or LSP fragments) is
max-
interval. After the delay reaches
max-interval for three times or the IS-IS
process is reset, the interval is reduced to
init-interval.
When only
max-interval is used, the intelligent timer changes into a
normal one-short timer.
● Enable LSP fast flooding.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run flash-flood [
lsp-count | max-timer-interval
interval | [ level-1 |
level-2 ] ] *
LSP fast flooding is enabled.
The
lsp-count parameter specifies the number of LSPs flooded each time,
which is applicable to all interfaces. If the number of LSPs to be sent is
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 657
greater than the value of
lsp-count,
lsp-count takes effect. If the number
of LSPs to be sent is smaller than the value of
lsp-count, LSPs of the
actual number are sent. If a timer is configured and the configured timer
does not expire before the route calculation, the LSPs are flooded
immediately when being received; otherwise, the LSPs are sent when the
timer expires.
When LSP fast flooding is enabled, Level-1 LSPs and Level-2 LSPs are fast
flooded by default if no level is specified.
● Set an interval at which LSPs are retransmitted over a P2P link.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. (Optional) Run isis circuit-type p2p [ strict-snpa-check ]
A broadcast interface is simulated as a P2P interface.
NOTE
If the interface type is P2P, the step is not required.
e. Run isis timer lsp-retransmit
retransmit-interval
An interval at which LSPs are retransmitted over a P2P link is set.
By default, the interval for retransmitting LSPs over a P2P link is 5
seconds.
----End
8.11.3 Configuring Attributes for CSNPs
Context
Complete sequence number PDUs (CSNPs) contain the summary of all the LSPs in
an LSDB to ensure LSDB synchronization between neighbors. CSNPs are processed
differently on broadcast and P2P links.
● On a broadcast link, CSNPs are periodically sent by a DIS device. If a device
detects that its LSDB is not synchronized with its neighbors', the device will
send PSNPs to apply for missing LSPs.
● On a P2P link, CSNPs are sent only during initial establishment of neighboring
relationships.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 658
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run isis timer csnp
csnp-interval [ level-1 | level-2 ]
The interval at which CSNPs are sent is set on the interface.
By default, the interval is 10 seconds.
NOTE
Configure Level-1 and Level-2 only when a broadcast interface is specified.
----End
8.11.4 Setting an SPF Calculation Interval
Context
A network change always triggers IS-IS to perform SPF calculation. Frequent SPF
calculation will consume excessive CPU resources, affecting services.
To solve this problem, configure an intelligent timer to control the SPF calculation
interval. For example, to speed up IS-IS route convergence, set the interval for SPF
calculation to a small value and set the interval to a large value after the IS-IS
network becomes stable.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run timer spf
max-interval [
init-interval [
incr-interval ] ]
An SPF intelligent timer is configured.
By default, no SPF intelligent timer is configured and the maximum delay in SPF
calculation is 5 seconds.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 659
The intelligent timer changes as follows:
● The delay in the first SPF calculation is determined by
init-interval; the delay
in the second SPF calculation is determined by
incr-interval. From the third
time on, the delay in SPF calculation increases twice every time until the delay
reaches the value specified by
max-interval. After the delay remains at the
value specified by
max-interval for three times or the IS-IS process is
restarted, the delay decreases to the value specified by
init-interval.
● If
incr-interval is not specified, the delay in SPF calculation for the first time is
determined by
init-interval. From the second time on, the delay in SPF
calculation is determined by
max-interval. After the delay remains at the
value specified by
max-interval for three times or the IS-IS process is
restarted, the delay decreases to the value specified by
init-interval.
● When only
max-interval is specified, the intelligent timer functions as an
ordinary one-time triggering timer.
Step 4 (Optional) Run spf-slice-size
duration-time
The maximum duration for SPF calculation is configured.
By default, IS-IS route calculation lasts for a maximum of 2 ms at a time.
----End
8.11.5 Configuring Convergence Priorities for IS-IS Routes
Context
You can configure the highest convergence priority for specific IS-IS routes so that
these IS-IS routes will be converged first when a network topology changes.
The application rules of the convergence priorities for IS-IS routes are as follows:
● Existing IS-IS routes are converged based on the priorities configured in the
ipv6 prefix-priority command.
● New IS-IS routes are converged based on the priorities configured in the ipv6
prefix-priority command.
● If an IS-IS route conforms to the matching rules of multiple convergence
priorities, the highest convergence priority is used.
● The convergence priority of a Level-1 IS-IS route is higher than that of a
Level-2 IS-IS route.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run ipv6 prefix-priority [ level-1 | level-2 ] { critical | high | medium } { ipv6-
prefix
prefix-name | tag
tag-value }
Convergence priorities are set for IS-IS routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 660
By default, the convergence priority of 32-bit host routes is medium, and the
convergence priority of the other IS-IS routes is low.
NOTE
The ipv6 prefix-priority command is only applicable to the public network.
After the ipv6 prefix-priority command is run, the convergence priority of 32-bit host
routes is low, and the convergence priorities of the other routes are determined as specified
in the ipv6 prefix-priority command.
Step 4 (Optional) Run quit
The system view is displayed.
----End
8.11.6 Verifying the IPv6 IS-IS Route Convergence Control
Configuration
Procedure
● Run the display isis interface [ verbose ] [
process-id | vpn-instance
vpn-
instance-name ] command to check IS-IS packet information on an IS-IS
interface.
● Run the display isis route [
process-id | vpn-instance
vpn-instance-name ]
ipv6 [ verbose | [ level-1 | level-2 ] |
ipv6-address [
prefix-length ] ] *
command to check IS-IS route information.
----End
8.12 Configuring LSP Fragment Extension
Pre-configuration Tasks
Before configuring LSP fragment extension, configure basic IPv6 IS-IS functions.
NOTE
When a new device connects to an IS-IS network, you are advised to configure LSP
fragment extension and virtual systems before establishing IS-IS neighbors or importing
routes. If you establish IS-IS neighbors or import routes, which causes IS-IS to carry much
information that cannot be loaded through 256 fragments, you must configure LSP
fragment extension and virtual systems. The configurations, however, take effect only after
you restart the IS-IS process.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 661
Step 3 Run lsp-fragments-extend [ [ level-1 | level-2 | level-1-2 ] | [ mode-1 |
mode-2 ] ] *
LSP fragment extension is enabled in an IS-IS process.
By default, LSP fragment extension is disabled in an IS-IS process.
If the mode or level is not specified during the configuration of LSP fragment
extension, mode-1 and level-1-2 are used by default.
NOTE
If there are devices of other manufacturers on the network, LSP fragment extension must
be set to mode-1. Otherwise, devices of other manufacturers cannot identify LSPs.
Step 4 Run virtual-system
virtual-system-id
A virtual system is configured.
By default, no virtual system is configured.
To configure a switch to generate extended LSP fragments, you must configure at
least one virtual system. The ID of the virtual system must be unique in the
domain.
An IS-IS process can be configured with up to 50 virtual system IDs.
----End
Verifying the Configuration
Run the following commands to check IS-IS process statistics.
● display isis statistics [ updated-lsp [ history ] ] [ level-1 | level-2 |
level-1-2 ] [
process-id | vpn-instance
vpn-instance-name ]
● display isis
process-id statistics [ [ [ updated-lsp [ history ] ] [ level-1 |
level-2 | level-1-2 ] ] | [ packet ] ]
8.13 Configuring a Mesh Group on an NBMA Network
Pre-configuration Tasks
Before configuring a mesh group, configure basic IPv6 IS-IS functions.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 662
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run isis mesh-group {
mesh-group-number | mesh-blocked }
The interface is added to a mesh group.
When mesh-blocked is configured on an interface, the interface is blocked and
cannot flood LSPs outside. All the interfaces added to a mesh group implement
global LSDB synchronization through CSNP and PSNP mechanisms.
----End
Verifying the Configuration
Run the following commands to check IS-IS process statistics.
● display isis statistics [ updated-lsp [ history ] ] [ level-1 | level-2 |
level-1-2 ] [
process-id | vpn-instance
vpn-instance-name ]
● display isis
process-id statistics [ [ [ updated-lsp [ history ] ] [ level-1 |
level-2 | level-1-2 ] ] | packet ]
8.14 Configuring IPv6 IS-IS Reliability
Pre-configuration Tasks
Before configuring IS-IS reliability, configure basic IPv6 IS-IS functions.
Configuration Procedure
You can perform the following configuration tasks in any sequence as required.
8.14.1 Configuring Dynamic BFD for IPv6 IS-IS
Context
The switch supports dynamic BFD for IPv6 IS-IS, but not static BFD for IPv6 IS-IS.
Without BFD, connection status between an IS-IS device and its neighbors can be
monitored only by exchanging Hello packets at intervals. The minimum allowable
sending interval is 3s, and a neighbor is declared Down after at least three
intervals during which no response Hello packet is received from the neighbor. IS-
IS takes more than one second to detect that a neighbor becomes Down, resulting
in loss of a large amount of high-speed data.
BFD provides millisecond-level fault detection. After detecting a link or node
failure, BFD will notify IS-IS of the failure. Traffic is rapidly switched to the backup
link or node.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 663
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S BFD for IPv6 IS-IS.
Pre-configuration Tasks
Before configuring dynamic BFD for IPv6 IS-IS, complete the following tasks:
● Configure IPv6 addresses for interfaces to ensure that neighbor nodes are
reachable.
● Configure IPv6 IS-IS functions to ensure that each node is reachable at the
network layer.
Configuration Roadmap
The configuration roadmap is as follows:
No. Data
1 Nodes to be enabled with BFD for IPv6 IS-IS
2 Number of the IS-IS process to be enabled with BFD
3 Type and number of each interface to be enabled with BFD
4 Minimum interval at which BFD packets are sent
5 Minimum interval at which BFD packets are received
6 BFD detection multiplier
You can use either of the following methods to enable BFD for IPv6 IS-IS:
● Enable dynamic BFD for specified IS-IS IPv6 processes. This method is
recommended if you need to enable dynamic BFD for IPv6 IS-IS on a large
number of IS-IS interfaces.
● Enable dynamic BFD for specified IPv6 interfaces. This method is
recommended if you need to enable dynamic BFD for IPv6 IS-IS on a small
number of IS-IS interfaces.
Procedure
● Enable dynamic BFD for an IS-IS IPv6 process.
a. Run system-view
The system view is displayed.
b. Run bfd
BFD is enabled globally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 664
c. Run quit
The system view is displayed.
d. Run isis
process-id
The IS-IS view is displayed.
e. Run ipv6 bfd all-interfaces enable
BFD for IS-IS is enabled.
After BFD is enabled globally and the neighbor status is Up, default BFD
parameters will be used to establish BFD sessions on all interfaces.
f. (Optional) Run ipv6 bfd all-interfaces { min-rx-interval
receive-interval
| min-tx-interval
transmit-interval | detect-multiplier
multiplier-value } *
The parameters for establishing BFD sessions are set for all interfaces.
The command execution result is applicable to BFD session parameters
on all IS-IS interfaces.
g. Run quit
The system view is displayed.
To disable the BFD function on an interface, run the isis ipv6 bfd block
command in the interface view to disable the interface from establishing
BFD sessions.
● Enable dynamic BFD on an IS-IS IPv6 interface.
a. Run system-view
The system view is displayed.
b. Run bfd
BFD is enabled globally.
c. Run quit
The system view is displayed.
d. Run interface
interface-type interface-number
The view of the specified interface is displayed.
e. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
f. Run isis ipv6 bfd enable
BFD is enabled on the interface.
g. (Optional) Run isis ipv6 bfd { min-rx-interval
receive-interval | min-tx-
interval
transmit-interval | detect-multiplier
multiplier-value } *
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 665
Run this command when BFD session parameters need to be configured
for a specified interface.
----End
Verifying the Configurations
After configuring dynamic BFD for IPv6 IS-IS, you can check information about the
BFD session and BFD for IPv6 IS-IS on an interface.
● Run the display isis [
process-id | vpn-instance
vpn-instance-name ] ipv6 bfd
session { all | peer
ipv6-address | interface
interface-type interface-number }
command to check information about a BFD session.
● Run the display isis [
process-id ] ipv6 bfd interface command to check the
configurations of BFD for IPv6 IS-IS on the specified interface.
8.15 Configuring the Overload Bit for an IS-IS Device
Pre-configuration Tasks
Before configuring the overload bit for an IS-IS device, configure basic IPv6 IS-IS
functions.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run set-overload [ on-startup [
timeout1 | start-from-nbr
system-id [
timeout1
[
timeout2 ] ] | wait-for-bgp [
timeout1 ] ] [ send-sa-bit [
timeout3 ] ] ] [ allow
{ interlevel | external }* ]
The overload bit for non-pseudonode LSPs is configured.
----End
Verifying the Configuration
● Run the display isis lsdb [ [ level-1 | level-2 ] | verbose | [ local |
lsp-id | is-
name
symbolic-name ] ] * [
process-id | vpn-instance
vpn-instance-name ]
command to check information in the IS-IS LSDB.
8.16 Maintaining IS-IS
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 666
8.16.1 Resetting IS-IS
Context
To reset IS-IS, reset IS-IS data structure, neighbor relationship and packets
NOTICE
The IS-IS data structure cannot be restored after you reset it. All the previous
structure information and the neighbor relationship are reset. Exercise caution
when running this command.
The specified IS-IS neighbor relationship is deleted after you reset a specified IS-IS
neighbor. Exercise caution when running this command.
Procedure
● Reset IS-IS data structure.
Run the reset isis all[
process-id | vpn-instance
vpn-instance-name ]
command to reset IS-IS data structure.
● Reset IS-IS neighbor relationship.
Run the reset isis peer
system-id [
process-id | vpn-instance
vpn-instance-
name ] command to reset a specific IS-IS neighbor.
After the IS-IS routing policy or the protocol changes, you can reset a specific
IS-IS neighbor to validate the new configuration.
----End
8.16.2 Improving the Maintainability of IS-IS
Context
The administrator can improve the maintainability of IS-IS using either of the
following methods:
● Configuring IS-IS host name mapping: Through this function, the
administrator can use a simple name to replace the system ID. After IS-IS host
name mapping is configured, the dynamic name is displayed in the IS-IS
information to replace the system ID when the display command is executed.
This improves the maintainability of IS-IS networks.
● Configuring IS-IS to add the POI TLV to a PURGE packet: When the value of
the Remaining Lifetime field in an LSP packet is 0, this packet is invalid and
called a PURGE packet. PURGE packets do not record information about the
devices generating these packets. Therefore, when a network is faulty, the
packet source cannot be located. To solve this problem, IS-IS can be
configured to add the POI TLV to a PURGE packet so that the PURGE packet
contains information about its generating device. If the dynamic host name
function is configured locally, the host name TLV is also added to the PURGE
packet to facilitate fault location.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 667
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Configure IS-IS host name mapping.
● Run is-name
symbolic-name
IS-IS dynamic host name mapping is configured and a host name is
configured for the local device.
This configuration is dynamic configuration. Therefore, the configured host
name
symbolic-name is advertised through an LSP to other IS-IS devices in
the same area. When you use IS-IS display commands to view IS-IS
information on other IS-IS devices, the system ID of the local device is
replaced by the configured host name.
● Run is-name map
system-id symbolic-name
IS-IS static host name mapping is configured and a host name is configured
for the remote device.
This configuration is static configuration and takes effect only on the local
device. Therefore, the configured host name
symbolic-name is not advertised
through an LSP.
----End
8.16.3 Configuring the Output of IS-IS Adjacency Status
Context
On an IS-IS network, neighbor flapping will result in network instability and
frequent network convergence. This will consume lots of memory and may even
cause user traffic loss. Therefore, neighbor flapping needs to be rapidly located
and solved.
To rapidly locate problems in the case of neighbor flapping, enable the output of
IS-IS adjacency changes to log these changes.
If the local terminal monitor is enabled and the output of the IS-IS adjacency
status is enabled, IS-IS adjacency changes will be output to the router until the
output of the adjacency status is disabled.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 668
Step 3 Run log-peer-change [ topology ]
The output of the adjacency status is enabled.
By default, the output of IS-IS adjacency changes is disabled.
----End
8.17 Configuration Examples for IPv6 IS-IS
8.17.1 Example for Configuring Basic IPv6 IS-IS Functions
Networking Requirements
In Figure 8-1, the four switches on the IPv6 network need to communicate with
each other. SwitchA and SwitchB can only process a small amount of data.
Figure 8-1 Configuring basic IPv6 IS-IS functions
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IPv6 addresses on interfaces of each switch so that the switches can
be interconnected.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 669
2. Enable IS-IS on each switch so that the switches can be interconnected.
Configure SwitchA and SwitchB as Level-1 switches to enable them to
maintain less data.
Procedure
Step 1 Configure VLANs that interfaces belong to.
# Configure SwitchA. Ensure that the configurations of SwitchB, SwitchC, and
SwitchD are the same as the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Enable the capability of IPv6 forwarding and configure IPv6 address for each
interface.
# Configure SwitchA. Ensure that the configurations of SwitchB, SwitchC, and
SwitchD are the same as the configuration of SwitchA.
[SwitchA] ipv6
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ipv6 enable
[SwitchA-Vlanif10] ipv6 address fc00:0:0:10::2/64
[SwitchA-Vlanif10] quit
Step 3 Configure IS-IS.
# Configure SwitchA.
[SwitchA] isis 1
[SwitchA-isis-1] is-level level-1
[SwitchA-isis-1] network-entity 10.0000.0000.0001.00
[SwitchA-isis-1] ipv6 enable
[SwitchA-isis-1] quit
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] isis ipv6 enable 1
[SwitchA-Vlanif10] quit
# Configure SwitchB.
[SwitchB] isis 1
[SwitchB-isis-1] is-level level-1
[SwitchB-isis-1] network-entity 10.0000.0000.0002.00
[SwitchB-isis-1] ipv6 enable
[SwitchB-isis-1] quit
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] isis ipv6 enable 1
[SwitchB-Vlanif20] quit
# Configure SwitchC.
[SwitchC] isis 1
[SwitchC-isis-1] network-entity 10.0000.0000.0003.00
[SwitchC-isis-1] ipv6 enable
[SwitchC-isis-1] quit
[SwitchC] interface vlanif 10
[SwitchC-Vlanif10] isis ipv6 enable 1
[SwitchC-Vlanif10] quit
[SwitchC] interface vlanif 20
[SwitchC-Vlanif20] isis ipv6 enable 1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 670
[SwitchC-Vlanif20] quit
[SwitchC] interface vlanif 30
[SwitchC-Vlanif30] isis ipv6 enable 1
[SwitchC-Vlanif30] isis circuit-level level-2
[SwitchC-Vlanif30] quit
# Configure SwitchD.
[SwitchD] isis 1
[SwitchD-isis-1] is-level level-2
[SwitchD-isis-1] network-entity 20.0000.0000.0004.00
[SwitchD-isis-1] ipv6 enable
[SwitchD-isis-1] quit
[SwitchD] interface vlanif 30
[SwitchD-Vlanif30] isis ipv6 enable 1
[SwitchD-Vlanif30] quit
[SwitchD] interface vlanif40
[SwitchD-Vlanif40] isis ipv6 enable 1
[SwitchD-Vlanif40] quit
Step 4 Verify the configuration.
# Check the IS-IS routing table of SwitchA.
[SwitchA] display isis route
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-1 Forwarding Table
--------------------------------
IPV4 Destination IntCost ExtCost ExitInterface NextHop Flags
-------------------------------------------------------------------------------
0.0.0.0/0 10 NULL
IPV6 Dest. ExitInterface NextHop Cost Flags
-------------------------------------------------------------------------------
::/0 Vlanif10 FE80::244:1FF:FE41:5411 10 A/-/-
FC00:0:0:10::/64
Vlanif10 Direct 10 D/L/-
FC00:0:0:20::/64
Vlanif10 FE80::244:1FF:FE41:5411 20 A/-/-
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut,
U-Up/Down Bit Set
# Check the IS-IS neighbors of SwitchC.
[SwitchC] display isis peer verbose
Peer information for ISIS(1)
System Id Interface Circuit Id State HoldTime Type PRI
-------------------------------------------------------------------------------
0000.0000.0001 Vlanif10 0000.0000.0001.01 Up 8s L1 64
MT IDs supported : 0(UP)
Local MT IDs : 0
Area Address(es) : 10
Peer IPv6 Address(es): FE80::1234:FCFF:FEFC:199
Uptime : 00:02:08
Adj Protocol : IPV6
Restart Capable : YES
Suppressed Adj : NO
Peer System Id : 0000.0000.0001
0000.0000.0002 Vlanif20 0000.0000.0003.02 Up 24s L1 64
MT IDs supported : 0(UP)
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 671
Local MT IDs : 0
Area Address(es) : 10
Peer IPv6 Address(es): FE80::225:9EFF:FEFB:494A
Uptime : 00:02:09
Adj Protocol : IPV6
Restart Capable : YES
Suppressed Adj : NO
Peer System Id : 0000.0000.0002
0000.0000.0004 Vlanif30 0000.0000.0003.03 Up 27s L2 64
MT IDs supported : 0(UP)
Local MT IDs : 0
Area Address(es) : 20
Peer IPv6 Address(es): FE80::244:1FF:FE41:5410
Uptime : 00:02:16
Adj Protocol : IPV6
Restart Capable : YES
Suppressed Adj : NO
Peer System Id : 0000.0000.0004
Total Peer(s): 3
# Check the IS-IS LSDB of SwitchC.
[SwitchC] display isis lsdb verbose
Database information for ISIS(1)
--------------------------------
Level-1 Link State Database
LSPID Seq Num Checksum Holdtime Length ATT/P/OL
-------------------------------------------------------------------------------
0000.0000.0001.00-00 0x00000005 0x3cb9 1009 86 0/0/0
SOURCE 0000.0000.0001.00
NLPID IPV6
AREA ADDR 10
INTF ADDR V6 FC00:0:0:10::2
Topology Standard
NBR ID 0000.0000.0001.01 COST: 10
IPV6 FC00:0:0:10::/64 COST: 10
0000.0000.0001.01-00 0x00000001 0xd8f1 1009 55 0/0/0
SOURCE 0000.0000.0001.01
NLPID IPV6
NBR ID 0000.0000.0001.00 COST: 0
NBR ID 0000.0000.0003.00 COST: 0
0000.0000.0002.00-00 0x00000005 0x864b 1007 86 0/0/0
SOURCE 0000.0000.0002.00
NLPID IPV6
AREA ADDR 10
INTF ADDR V6 FC00:0:0:20::2
Topology Standard
NBR ID 0000.0000.0003.02 COST: 10
IPV6 FC00:0:0:20::/64 COST: 10
0000.0000.0003.00-00* 0x00000007 0xcf9b 1012 143 1/0/0
SOURCE 0000.0000.0003.00
NLPID IPV6
AREA ADDR 10
INTF ADDR V6 FC00:0:0:10::1
INTF ADDR V6 FC00:0:0:20::1
INTF ADDR V6 FC00:0:0:30::1
Topology Standard
NBR ID 0000.0000.0001.01 COST: 10
NBR ID 0000.0000.0003.02 COST: 10
IPV6 FC00:0:0:10::/64 COST: 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 672
IPV6 FC00:0:0:20::/64 COST: 10
0000.0000.0003.02-00* 0x00000001 0xc9fa 1009 55 0/0/0
SOURCE 0000.0000.0003.02
NLPID IPV6
NBR ID 0000.0000.0003.00 COST: 0
NBR ID 0000.0000.0002.00 COST: 0
Total LSP(s): 5
*(In TLV)-Leaking Route, *(By LSPID)-Self LSP, +-Self LSP(Extended),
ATT-Attached, P-Partition, OL-Overload
Level-2 Link State Database
LSPID Seq Num Checksum Holdtime Length ATT/P/OL
-------------------------------------------------------------------------------
0000.0000.0003.00-00* 0x00000006 0x8ff6 1014 146 0/0/0
SOURCE 0000.0000.0003.00
NLPID IPV6
AREA ADDR 10
INTF ADDR V6 FC00:0:0:10::1
INTF ADDR V6 FC00:0:0:20::1
INTF ADDR V6 FC00:0:0:30::1
Topology Standard
NBR ID 0000.0000.0003.03 COST: 10
IPV6 FC00:0:0:10::/64 COST: 10
IPV6 FC00:0:0:20::/64 COST: 10
IPV6 FC00:0:0:30::/64 COST: 10
0000.0000.0003.03-00* 0x00000001 0xfac6 1012 55 0/0/0
SOURCE 0000.0000.0003.03
NLPID IPV6
NBR ID 0000.0000.0003.00 COST: 0
NBR ID 0000.0000.0004.00 COST: 0
0000.0000.0004.00-00 0x00000005 0x5943 1009 86 0/0/0
SOURCE 0000.0000.0004.00
NLPID IPV6
AREA ADDR 20
INTF ADDR V6 FC00:0:0:30::2
Topology Standard
NBR ID 0000.0000.0003.03 COST: 10
IPV6 FC00:0:0:30::/64 COST: 10
Total LSP(s): 3
*(In TLV)-Leaking Route, *(By LSPID)-Self LSP, +-Self LSP(Extended),
ATT-Attached, P-Partition, OL-Overload
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
vlan batch 10
#
isis 1
is-level level-1
network-entity 10.0000.0000.0001.00
#
ipv6 enable topology standard
#
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 673
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:10::2/64
isis ipv6 enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
vlan batch 20
#
isis 1
is-level level-1
network-entity 10.0000.0000.0002.00
#
ipv6 enable topology standard
#
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:20::2/64
isis ipv6 enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 10 20 30
#
isis 1
network-entity 10.0000.0000.0003.00
#
ipv6 enable topology standard
#
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:10::1/64
isis ipv6 enable 1
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:20::1/64
isis ipv6 enable 1
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:30::1/64
isis ipv6 enable 1
isis circuit-level level-2
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 674
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
return
● SwitchD configuration file
#
sysname SwitchD
#
ipv6
#
vlan batch 30 40
#
isis 1
is-level level-2
network-entity 20.0000.0000.0004.00
#
ipv6 enable topology standard
#
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:30::2/64
isis ipv6 enable 1
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:25::1/64
isis ipv6 enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
return
8.17.2 Example for Configuring Dynamic BFD for IPv6 IS-IS
Networking Requirements
In Figure 8-2, IS-IS is run among SwitchA, SwitchB, and SwitchC. Service traffic is
forwarded along the primary link SwitchA→SwitchB. The link
SwitchA→SwitchC→SwitchB is used as a backup. Customers require that a fault on
the primary link be detected in milliseconds so that service traffic can be fast
switched to the backup link if the primary link fails.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 675
Figure 8-2 Networking diagram for configuring dynamic BFD for IPv6 IS-IS
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic IS-IS IPv6 functions on each switch.
2. Set link cost values for IS-IS interfaces on each switch to make the path
SwitchA→SwitchB become the primary and the path
SwitchA→SwitchC→SwitchB become the backup.
3. Enable BFD globally on each switch to detect faults on the primary link in
milliseconds.
4. Enable IPv6 BFD for IS-IS in the IS-IS view on each switch so that service
traffic can be fast switched to the backup link when the primary link fails.
Procedure
Step 1 Enable the IPv6 forwarding capability and configure IPv6 addresses for interfaces.
# Configure SwitchA. Ensure that the configurations of SwitchB and SwitchC are
the same as the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] ipv6
[SwitchA] interface GigabitEthernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] undo portswitch
[SwitchA-GigabitEthernet0/0/1] ipv6 enable
[SwitchA-GigabitEthernet0/0/1] ipv6 address FC00:3::1 64
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface GigabitEthernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] undo portswitch
[SwitchA-GigabitEthernet0/0/2] ipv6 enable
[SwitchA-GigabitEthernet0/0/2] ipv6 address FC00:1::1 64
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure basic IS-IS IPv6 functions.
# Configure SwitchA.
[SwitchA] isis 10
[SwitchA-isis-10] is-level level-2
[SwitchA-isis-10] network-entity 10.0000.0000.0001.00
[SwitchA-isis-10] ipv6 enable
[SwitchA-isis-10] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 676
[SwitchA] interface GigabitEthernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] isis ipv6 enable 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface GigabitEthernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] isis ipv6 enable 10
[SwitchA-GigabitEthernet0/0/2] quit
# Configure SwitchB.
[SwitchB] isis 10
[SwitchB-isis-10] is-level level-2
[SwitchB-isis-10] network-entity 10.0000.0000.0003.00
[SwitchB-isis-10] ipv6 enable
[SwitchB-isis-10] quit
[SwitchB] interface GigabitEthernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] isis ipv6 enable 10
[SwitchB-GigabitEthernet0/0/1] quit
[SwitchB] interface GigabitEthernet 0/0/2
[SwitchB-GigabitEthernet0/0/2] isis ipv6 enable 10
[SwitchB-GigabitEthernet0/0/2] quit
[SwitchB] interface GigabitEthernet 0/0/3
[SwitchB-GigabitEthernet0/0/3] isis ipv6 enable 10
[SwitchB-GigabitEthernet0/0/3] quit
# Configure SwitchC.
[SwitchC] isis 10
[SwitchC-isis-10] is-level level-2
[SwitchC-isis-10] network-entity 10.0000.0000.0002.00
[SwitchC-isis-10] ipv6 enable
[SwitchC-isis-10] quit
[SwitchC] interface GigabitEthernet 0/0/1
[SwitchC-GigabitEthernet0/0/1] isis ipv6 enable 10
[SwitchC-GigabitEthernet0/0/1] quit
[SwitchC] interface GigabitEthernet 0/0/2
[SwitchC-GigabitEthernet0/0/2] isis ipv6 enable 10
[SwitchC-GigabitEthernet0/0/2] quit
# After the configurations are complete, run the display ipv6 routing-table
command. You can view that the switches have learnt IPv6 routes from each other.
Step 3 Set link cost values for IS-IS interfaces.
# Configure SwitchA.
[SwitchA] interface GigabitEthernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] isis cost 1 level-2
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface GigabitEthernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] isis cost 10 level-2
[SwitchA-GigabitEthernet0/0/2] quit
# Configure SwitchB.
[SwitchB] interface GigabitEthernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] isis cost 1 level-2
[SwitchB-GigabitEthernet0/0/1] quit
[SwitchB] interface GigabitEthernet 0/0/2
[SwitchB-GigabitEthernet0/0/2] isis cost 10 level-2
[SwitchB-GigabitEthernet0/0/2] quit
[SwitchB] interface GigabitEthernet 0/0/3
[SwitchB-GigabitEthernet0/0/3] isis cost 10 level-2
[SwitchB-GigabitEthernet0/0/3] quit
# Configure SwitchC.
[SwitchC] interface GigabitEthernet 0/0/1
[SwitchC-GigabitEthernet0/0/1] isis cost 10 level-2
[SwitchC-GigabitEthernet0/0/1] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 677
[SwitchC] interface GigabitEthernet 0/0/2
[SwitchC-GigabitEthernet0/0/2] isis cost 10 level-2
[SwitchC-GigabitEthernet0/0/2] quit
Step 4 Configure IPv6 BFD for IS-IS.
# Enable IPv6 BFD for IS-IS globally on SwitchA, SwitchB, and SwitchC, and set the
minimum intervals for sending and receiving BFD packets to 150 milliseconds.
# Configure SwitchA.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] isis 10
[SwitchA-isis-10] ipv6 bfd all-interfaces enable
[SwitchA-isis-10] ipv6 bfd all-interfaces min-tx-interval 150 min-rx-interval 150
[SwitchA-isis-10] quit
# Configure SwitchB.
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] isis 10
[SwitchB-isis-10] ipv6 bfd all-interfaces enable
[SwitchB-isis-10] ipv6 bfd all-interfaces min-tx-interval 150 min-rx-interval 150
[SwitchB-isis-10] quit
# Configure SwitchC.
[SwitchC] bfd
[SwitchC-bfd] quit
[SwitchC] isis 10
[SwitchC-isis-10] ipv6 bfd all-interfaces enable
[SwitchC-isis-10] ipv6 bfd all-interfaces min-tx-interval 150 min-rx-interval 150
[SwitchC-isis-10] quit
# After the configurations are complete, run the display isis ipv6 bfd session all
command on SwitchA or SwitchB. You can view that IPv6 BFD parameters already
take effect. Take the display on SwitchA as an example:
[SwitchA] display isis ipv6 bfd session all
IPv6 BFD session information for ISIS(10)
-----------------------------------------
Peer System ID : 0000.0000.0003 Type : L2
Interface : GE0/0/1
IPv6 BFD State : up TX : 150 RX : 150 Multiplier : 3
LocDis : 8198 Local IPv6 Address : FE80::200:13FF:FE82:4569
RemDis : 8199 Peer IPv6 Address : FE80::201:FF:FE01:1
Diag : No diagnostic information
Peer System ID : 0000.0000.0002 Type : L2
Interface : GE0/0/2
IPv6 BFD State : up TX : 150 RX : 150 Multiplier : 3
LocDis : 8197 Local IPv6 Address : FE80::200:13FF:FE82:4569
RemDis : 8199 Peer IPv6 Address : FE80::225:9EFF:FEFB:BFF1
Diag : No diagnostic information
Total IPv6 BFD session(s): 2
Step 5 Verify the configuration.
# On SwitchA, run the display ipv6 routing-table FC00:4::1 64 command to view
the IPv6 routing table. You can view that the next hop address of the route is
FE80::201:FF:FE01:1 and the outbound interface is GE0/0/1.
[SwitchA] display ipv6 routing-table FC00:4::1 64
Routing Table :Public
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 678
Summary Count : 1
Destination : FC00:4:: PrefixLength : 64
NextHop : FE80::201:FF:FE01:1 Preference : 15
Cost : 11 Protocol : ISIS-L2
RelayNextHop : :: TunnelID : 0x0
Interface : GigabitEthernet0/0/1 Flags : D
# Run the shutdown command on GE0/0/1 of SwitchB to simulate a primary link
fault.
[SwitchB] interface GigabitEthernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] shutdown
# On SwitchA, run the display ipv6 routing-table FC00:4::1 64 command to view
the IPv6 routing table.
[SwitchA] display ipv6 routing-table FC00:4::1 64
Routing Table :Public
Summary Count : 1
Destination : FC00:4:: PrefixLength : 64
NextHop : FE80::225:9EFF:FEFB:BFF1 Preference : 15
Cost : 30 Protocol : ISIS-L2
RelayNextHop : :: TunnelID : 0x0
Interface : GigabitEthernet0/0/2 Flags : D
In the IPv6 routing table, you can view that the backup link transmits traffic after
the primary link fails, the next hop address of the route to FC00:4::/64 becomes
FE80::225:9EFF:FEFB:BFF1, and the outbound interface becomes GE0/0/2.
# Run the display isis ipv6 bfd session all command on SwitchA, and you can
view that only one BFD session is established between SwitchA and SwitchC and
its status is Up.
[SwitchA] display isis ipv6 bfd session all
IPv6 BFD session information for ISIS(10)
-----------------------------------------
Peer System ID : 0000.0000.0002 Type : L2
Interface : GE0/0/2
IPv6 BFD State : up TX : 150 RX : 150 Multiplier : 3
LocDis : 8197 Local IPv6 Address : FE80::200:13FF:FE82:4569
RemDis : 8199 Peer IPv6 Address : FE80::225:9EFF:FEFB:BFF1
Diag : No diagnostic information
Total IPv6 BFD session(s): 1
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
bfd
#
isis 10
is-level level-2
network-entity 10.0000.0000.0001.00
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 679
#
ipv6 enable topology standard
ipv6 bfd all-interfaces enable
ipv6 bfd all-interfaces min-tx-interval 150 min-rx-interval 150
#
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:3::1/64
isis ipv6 enable 10
isis cost 1 level-2
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:1::1/64
isis ipv6 enable 10
isis cost 10 level-2
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
bfd
#
isis 10
is-level level-2
network-entity 10.0000.0000.0003.00
#
ipv6 enable topology standard
ipv6 bfd all-interfaces enable
ipv6 bfd all-interfaces min-tx-interval 150 min-rx-interval 150
#
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:3::2/64
isis ipv6 enable 10
isis cost 1 level-2
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:2::2/64
isis ipv6 enable 10
isis cost 10 level-2
#
interface GigabitEthernet0/0/3
undo portswitch
ipv6 enable
ipv6 address FC00:4::1/64
isis ipv6 enable 10
isis cost 10 level-2
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
bfd
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 680
isis 10
is-level level-2
network-entity 10.0000.0000.0002.00
#
ipv6 enable topology standard
ipv6 bfd all-interfaces enable
ipv6 bfd all-interfaces min-tx-interval 150 min-rx-interval 150
#
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:2::1/64
isis ipv6 enable 10
isis cost 10 level-2
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:1::2/64
isis ipv6 enable 10
isis cost 10 level-2
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 681
9 BGP Configuration
9.1 Overview of BGP
9.2 Understanding BGP
9.3 Summary of BGP Configuration Tasks
9.4 Licensing Requirements and Limitations for BGP
9.5 Default Settings for BGP
9.6 Configuring Basic BGP Functions
9.7 Configuring BGP Security
9.8 Simplifying IBGP Network Connections
9.9 Configuring BGP Route Selection and Load Balancing
9.10 Controlling the Receiving and Advertisement of BGP Routes
9.11 Adjusting the BGP Network Convergence Speed
9.12 Configuring BGP Reliability
9.13 Configuring BGP Route Summarization
9.14 Configuring BGP to Advertise Default Routes to Peers
9.15 Configuring MP-BGP
9.16 Maintaining BGP
9.17 Configuration Examples for BGP
9.1 Overview of BGP
Definition
The Border Gateway Protocol (BGP) is a path vector protocol that allows devices
between Autonomous Systems (ASs) to communicate and selects optimal routes.
BGP-1 (defined in RFC 1105), BGP-2 (defined in RFC 1163), and BGP-3 (defined in
RFC 1267) are three earlier versions of BGP. BGP-4 (defined in RFC 1771) has been
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 682
used since 1994. Since 2006, unicast IPv4 networks have been using BGP-4 defined
in RFC 4271, and other networks (such as IPv6 networks) have been using
Multiprotocol BGP (MP-BGP) defined in RFC 4760.
MP-BGP is an extension of BGP-4 and applies to different networks; however, the
original message exchange and routing mechanisms of BGP-4 are not changed.
MP-BGP applications on IPv6 unicast and IPv4 multicast networks are called
BGP4+ and Multicast BGP (MBGP) respectively.
Purpose
A network is divided into different ASs to facilitate network management. In 1982,
the Exterior Gateway Protocol (EGP) was used to dynamically exchange routing
information between ASs. However, EGP advertises only reachable routes and does
not select optimal routes or prevent routing loops. Therefore, EGP cannot meet
network management requirements.
BGP was designed to replace EGP and has the following capabilities:
● Selects optimal routes.
● Prevents routing loops.
● Transmits routing information efficiently.
● Maintains a large number of routes.
Benefits
BGP ensures high network security, flexibility, stability, reliability, and efficiency:
● BGP uses authentication and Generalized TTL Security Mechanism (GTSM) to
ensure network security.
● BGP provides routing policies to allow for flexible route selection.
● BGP provides 9.2.8 Route Summarization and 9.2.9 Route Dampening to
prevent route flapping and improve network stability.
● BGP uses the Transport Control Protocol (TCP) with port number 179 as the
transport layer protocol and supports 9.2.10 BFD for BGP, 9.2.11 BGP
Tracking, and 9.2.12 BGP GR to improve network reliability.
9.2 Understanding BGP
9.2.1 Basic Concepts of BGP
This section describes BGP concepts to help you better understand BGP functions.
Autonomous System
An Autonomous System (AS) is a group of Internet Protocol (IP) networks that are
controlled by one entity, typically an Internet service provider (ISP), and have the
same routing policy. Each AS is assigned a unique AS number, which identifies an
AS on a BGP network. Two types of AS numbers are available: 2-byte AS numbers
and 4-byte AS numbers. A 2-byte AS number ranges from 1 to 65535, and a 4-
byte AS number ranges from 1 to 4294967295. Devices supporting 4-byte AS
numbers are compatible with devices supporting 2-byte AS numbers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 683
BGP Classification
In Figure 9-1, BGP is classified into two types according to where it runs: Internal
BGP (IBGP) and External BGP (EBGP).
Figure 9-1 BGP operating mode
● EBGP
EBGP runs between ASs. To prevent routing loops between ASs, a BGP device
discards the routes with the local AS number when receiving the routes from
EBGP peers.
● IBGP
IBGP runs within an AS. To prevent routing loops within an AS, a BGP device
does not advertise the routes learned from an IBGP peer to the other IBGP
peers and establishes full-mesh connections with all IBGP peers. To address
the problem of too many IBGP connections between IBGP peers, BGP uses
9.2.6 Route Reflector and 9.2.7 BGP Confederation.
NOTE
If a BGP device needs to advertise the route received from an EBGP peer outside an AS
through another BGP device, IBGP is recommended.
Device Roles in BGP Message Exchange
There are two device roles in BGP message exchange:
● Speaker
The device that sends BGP messages is a BGP speaker. A BGP speaker receives
and generates new routes, and advertises the routes to other BGP speakers.
● Peer
BGP speakers that exchange messages with each other are BGP peers. A
group of BGP peers sharing the same policies can form a peer group.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 684
BGP Router ID
The BGP router ID is a 32-bit value that is often represented by an IPv4 address to
identify a BGP device. It is carried in the Open message sent during the
establishment of a BGP session. When two BGP peers need to establish a BGP
session, they each require a unique router ID. Otherwise, the two peers cannot
establish a BGP session.
9.2.2 BGP Fundamentals
BGP peer establishment, update, and deletion involve five types of messages, six
state machine states, and five route exchange rules.
BGP Messages
BGP peers exchange the following messages, among which Keepalive messages
are periodically sent and other messages are triggered by events.
● Open message
Used to establish BGP peer relationships.
● Update message
Used to exchange routes between BGP peers.
● Notification message
Used to terminate BGP connections.
● Keepalive message
Used to maintain BGP connections.
● Route-refresh message
Used to request the peer to retransmit routes if routing policies are changed.
Only the BGP devices supporting route-refresh can send and respond to
Route-refresh messages.
BGP State Machine
In Figure 9-2, a BGP device uses a finite state machine (FSM) to determine its
operations with peers. The FSM has six states: Idle, Connect, Active, OpenSent,
OpenConfirm, and Established. Three common states are involved in BGP peer
establishment: Idle, Active, and Established.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 685
Figure 9-2 BGP state machine
1. The Idle state is the initial BGP state where the BGP device refuses all
connection requests from neighbors. The BGP device initiates a TCP
connection with its BGP peer and changes its state to Connect only after
receiving a Start event from the system.
NOTE
● The Start event occurs when an operator configures a BGP process or resets an
existing BGP process or when the router software resets a BGP process.
● If an error occurs at any state of the FSM, for example, the BGP device receives a
Notification packet or TCP connection termination notification, the BGP device
returns to the Idle state.
2. In Connect state, the BGP device starts the Connect Retry timer and waits to
establish a TCP connection.
– If the TCP connection is established, the BGP device sends an Open
message to the peer and changes to the OpenSent state.
– If the TCP connection fails to be established, the BGP device moves to the
Active state.
– If the BGP device does not receive a response from the peer before the
Connect Retry timer expires, the BGP device attempts to establish a TCP
connection with another peer and stays in Connect state.
3. In Active state, the BGP device keeps trying to establish a TCP connection with
the peer.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 686
– If the TCP connection is established, the BGP device sends an Open
message to the peer, closes the Connect Retry timer, and changes to the
OpenSent state.
– If the TCP connection fails to be established, the BGP device stays in the
Active state.
– If the BGP device does not receive a response from the peer before the
Connect Retry timer expires, the BGP device returns to the Connect state.
4. In OpenSent state, the BGP device waits for an Open message from the peer
and then checks the validity of the received Open message, including the AS
number, version, and authentication password.
– If the received Open message is valid, the BGP device sends a Keepalive
message and changes to the OpenConfirm state.
– If the received Open message is invalid, the BGP device sends a
Notification message to the peer and returns to the Idle state.
5. In OpenConfirm state, the BGP device waits for a Keepalive or Notification
message from the peer. If the BGP device receives a Keepalive message, it
transitions to the Established state. If it receives a Notification message, it
returns to the Idle state.
6. In Established state, the BGP device exchanges Update, Keepalive, Route-
refresh, and Notification messages with the peer.
– If the BGP device receives a valid Update or Keepalive message, it
considers that the peer is working properly and maintains the BGP
connection with the peer.
– If the BGP device receives an invalid Update or Keepalive message, it
sends a Notification message to the peer and returns to the Idle state.
– If the BGP device receives a Route-refresh message, it does not change its
status.
– If the BGP device receives a Notification message, it returns to the Idle
state.
– If the BGP device receives a TCP connection termination notification, it
terminates the TCP connection with the peer and returns to the Idle state.
Route Exchange Rules
A BGP device adds optimal routes to the BGP routing table to generate BGP
routes. After establishing a BGP peer relationship with a neighbor, the BGP device
follows the following rules to exchange routes with the peer:
● Advertises the BGP routes received from IBGP peers only to its EBGP peers.
● Advertises the BGP routes received from EBGP peers to its EBGP peers and
IBGP peers.
● Advertises the optimal route to its peers when there are multiple valid routes
to the same destination.
● Sends only updated BGP routes when BGP routes change.
● Accepts all the routes sent from its peers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 687
9.2.3 Interaction Between BGP and IGPs
BGP and IGPs use different routing tables. To allow devices in different ASs to
communicate, BGP needs to interact with IGPs. That is, BGP and IGP routes can be
imported into IGP and BGP routing tables respectively.
Importing IGP Routes into BGP
BGP cannot discover routes and needs to import IGP routes into a BGP routing
table for inter-AS communication. When an AS needs to advertise routes to
another AS, an AS boundary router (ASBR) will import IGP routes into its BGP
routing table. For better network planning, BGP can filter and set attributes for
imported IGP routes based on routing policies. Alternatively, EBGP peers can select
routes when traffic enters an AS based on the configured Multi-Exit Discriminator
(MED) value.
BGP can import routes in either import or network mode:
● In import mode, BGP imports routes according to protocol types, such as RIP
routes, OSPF routes, and IS-IS routes. To ensure validity of imported IGP
routes, BGP can also import static routes and direct routes in import mode.
● In network mode, BGP imports routes in an IP routing table one by one.
Therefore, the network mode is more precise than the import mode.
Importing BGP Routes into IGPs
When an AS needs to import routes from other ASs, an ASBR of this AS will
import BGP routes into its IGP routing table. To prevent a large number of BGP
routes from affecting devices in this AS, IGPs can filter and set attributes for
imported BGP routes based on routing policies.
Problem and Solution Related to Route Import Between BGP and IGPs
BGP and IGPs often import routes from each other to advertise routes between
ASs. However, the following problems may occur:
● If a large number of BGP routes exist, low-end devices within ASs may be
unable to have these routes installed, resulting in route loss.
● If a route is unstable, for example, a port frequently alternates between Up
and Down states, all routes within an AS may flap, affecting network stability.
● BGP prevents routing loops using route attributes, for example, the AS_Path
attribute. When all BGP routes are re-advertised into IGPs, their route
attributes will be lost. As a result, the BGP routing loop prevention
mechanism becomes ineffective, and routing loops may occur.
On a large IP network, the number of BGP routes is much larger than the number
of IGP routes. Therefore, when BGP routes need to be imported into IGPs, exercise
caution to prevent a large number of imported BGP routes from affecting IGP
routes. To do so, use default routes and summarize routes to reduce the number
of BGP routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 688
Figure 9-3 Using EBGP and IBGP to Advertise Routes Between ASs
Figure 9-3 shows a typical IP backbone network topology. In this topology, the
backbone layer and aggregation layer are AS 200 and AS 100 respectively, and AS
100 has two egress devices, SwitchC and SwitchD. The two ASs need to
communicate using routes. The following requirements need to be met:
● Devices on the aggregation layer are not expected to know route details of
the backbone layer.
● Devices on the aggregation layer have low performance and are not expected
to receive a large number of BGP routes from the backbone layer.
● Devices on the backbone layer have high performance and are expected to
know route details of the aggregation layer.
In Figure 9-3, if the two egress devices SwitchC and SwitchD import BGP routes
into OSPF, a large number of BGP routes will be transmitted from the backbone
layer to the aggregation layer. This will enable the aggregation devices to receive
a large number of BGP routes and know route details of the backbone layer. As a
result, the preceding requirements cannot be met. The following solution can
meet these requirements:
● Two devices on the backbone layer, SwitchE and SwitchF, advertise default
routes through BGP to two egress devices on the aggregation layer, SwitchC
and SwitchD. This operation ensures that aggregation devices do not receive a
large number of BGP routes from the backbone layer and do not know route
details of the backbone layer.
● The two egress devices, SwitchC and SwitchD, import only OSPF routes into
BGP, without importing BGP routes into OSPF. This ensures that backbone
devices know route details of the aggregation layer.
● ASBRs of each AS establish an IBGP peer relationship. That is, SwitchC and
SwitchD establish an IBGP peer relationship, and SwitchE and SwitchF
establish an IBGP peer relationship. This ensures route backup of two egress
devices in the ASs and improves reliability.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 689
9.2.4 BGP Security
BGP uses authentication and Generalized TTL Security Mechanism (GTSM) to
ensure exchange security between BGP peers.
BGP Authentication
BGP authentication includes Message Digest 5 (MD5) authentication and keychain
authentication, which improves communication security between BGP peers. In
MD5 authentication, you can only set the authentication password for a TCP
connection. In keychain authentication, you can set the authentication password
for a TCP connection and authenticate BGP messages.
BGP GTSM
BGP GTSM checks whether the time to live (TTL) value in the IP packet header is
within a predefined range. It permits or discards the packets with TTL values
outside of the predefined range to protect services above the IP layer. BGP GTSM
enhances system security.
Assume that the TTL value range of packets from BGP peers is set to 254-255.
When an attacker forges valid BGP packets and keeps sending these packets to
attack a device, the TTL values of these packets are smaller than 254. If BGP
GTSM is not enabled on the device, the device finds that these packets are
destined for itself and sends the packets to the control plane for processing. Then
the control layer needs to process a large number of such attack packets, causing
high CPU usage. If BGP GTSM is enabled on the device, the system checks the TTL
values in all BGP packets and discards the attack packets with TTL values smaller
than 254. This prevents network attack packets from consuming CPU resources.
9.2.5 BGP Route Selection Rules and Load Balancing
When multiple routes are available to the same destination, BGP selects one
optimal route based on BGP route selection rules and adds it to the IP routing
table for traffic forwarding. Figure 9-4 shows how the optimal route is selected.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 690
Figure 9-4 BGP route selection process
BGP selects routes by comparing route attributes in a fixed order. When a route
attribute is a sufficient condition for determining the optimal route, BGP does not
compare the other attributes; If BGP fails to select the optimal route after
comparing all route attributes, the route that was first received is selected as the
optimal route. Table 9-1 lists the abbreviated alias, route selection rules, and
remarks of each matching item. Table 9-1 shows that the route priority is directly
proportional to the PreVal or Local_Pref value and inversely proportional to the
rest of the attribute values or lengths. In addition, the first column can be
summarized as a character string (PPAAA OMTCC RA), which helps memorize the
matching sequence.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 691
Table 9-1 BGP route selection process
Abbr
eviat
ed
Alias
Matching
Item
Route Selection
Rules
Remarks
P PrefVal The route with the
largest PreVal value is
preferred.
The default value is 0.
PrefVal is Huawei-specific and
valid only on the device where it
is configured.
P Local_Pref The route with the
largest Local_Pref
value is preferred.
The default value is
100.
To modify the default Local_Pref
value of BGP routes, run the
default local-preference
command.
A
NOTE
A is
the
initi
al of
the
char
acte
r
strin
g
(AS
NIL).
Route type A > S > N > I > L, in
which:
● A: indicates that
routes are
summarized using
the aggregate
command.
● S: indicates that
routes are
summarized using
the summary
automatic
command.
● N: indicates that
routes are
imported using the
network
command.
● I: indicates that
routes are
imported using the
import-route
command.
● L: indicates that
routes are learned
from BGP peers.
-
A AS_Path The route with the
shortest AS_Path
length is preferred.
If the bestroute as-path-ignore
command is configured, BGP
does not compare the AS_Path
attribute.
O Origin IGP > EGP >
Incomplete
-
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 692
Abbr
eviat
ed
Alias
Matching
Item
Route Selection
Rules
Remarks
M Multi Exit
Discriminat
or (MED)
The route with the
smallest MED value is
preferred.
The default value is 0.
If the bestroute med-none-as-
maximum command is
configured, BGP considers the
largest MED value (4294967295)
as the MED of the route that
does not carry an MED.
T Peer type EBGP > IBGP Prefers EBGP routes, IBGP routes,
LocalCross routes, and
RemoteCross routes, which are
listed in descending order of
priority.
LocalCross allows a PE to add
the VPNv4 route of a VPN
instance to the routing table of
the VPN instance if the export
RT of the VPNv4 route matches
the import RT of another VPN
instance on the PE. RemoteCross
allows a local PE to add the
VPNv4 route learned from a
remote PE to the routing table
of a VPN instance on the local
PE if the export RT of the VPNv4
route matches the import RT of
the VPN instance.
C IGP cost The route with the
smallest IGP cost is
preferred.
If there are multiple routes to
the same destination, an IGP
calculates the route metric using
its routing algorithm.
If the bestroute igp-metric-
ignore command is configured,
BGP does not compare the IGP
cost.
C Cluster_List The route with the
shortest Cluster_List
length is preferred.
By default, Cluster_List takes
precedence over Originator_ID
during BGP route selection. To
enable Originator_ID to take
precedence over Cluster_List
during BGP route selection, run
the bestroute routerid-prior-
clusterlist command.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 693
Abbr
eviat
ed
Alias
Matching
Item
Route Selection
Rules
Remarks
R Router ID The route with the
smallest router ID is
preferred.
If routes carry the Originator_ID,
the originator ID is substituted
for the router ID during route
selection. The route with the
smallest Originator_ID is
preferred.
A Peer IP
address
The route learned
from the peer with
the smallest IP
address is preferred.
-
Selection of the Routes for Load Balancing
After BGP load balancing is configured, the BGP routes that meet the following
conditions are used as equal-cost routes for load balancing:
● The routes have the same PrefVal value.
● The routes have the same Local_Pref value.
● All the routes are summarized or non-summarized routes.
● The routes have the same AIGP value.
● The routes have the same AS_Path length.
● The routes have the same origin type (IGP, EGP, or incomplete).
● The routes have the same MED value.
● All the routes are EBGP or IBGP routes. After the maximum load-balancing
eibgp command is run, BGP ignores this limitation when selecting the
optimal VPN route.
● The costs of the IGP routes to which the BGP routes are recursed within an AS
are the same. After the maximum load-balancing eibgp command is run,
BGP ignores this limitation when selecting the optimal VPN route.
In addition, BGP labeled routes and non-labeled routes cannot load-balance traffic
even if they meet the preceding conditions.
VPN Route Selection Rules
BGP VPN routes are selected in the same way as BGP public routes except that
VPN target-based route crossing is implemented first on BGP VPN routes.
9.2.6 Route Reflector
To ensure connectivity between IBGP peers, you need to establish full-mesh
connections between IBGP peers. If there are n devices in an AS, n(n-1)/2 IBGP
connections need to be established. When there are a large number of devices,
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 694
many network resources and CPU resources are consumed. A route reflector (RR)
can be used between IBGP peers to solve this problem.
Roles in RR
As shown in Figure 9-5, the following roles are involved in RR scenarios in an AS.
Figure 9-5 Networking diagram of the RR
● Route reflector (RR)
A BGP device that can reflect the routes learned from an IBGP peer to other
IBGP peers. An RR is similar to a designated router (DR) on an OSPF network.
● Client
An IBGP device whose routes are reflected by the RR to other IBGP devices. In
an AS, clients need to connect only to the RR directly.
● Non-client
An IBGP device that is neither an RR nor a client. In an AS, a non-client must
establish full-mesh connections with the RR and all the other non-clients.
● Originator
A device that originates routes in an AS. The Originator_ID attribute helps
eliminate routing loops in a cluster.
● Cluster
A set of the RR and clients. The Cluster_List attribute helps eliminate routing
loops between clusters.
RR Principles
Clients in a cluster need to exchange routing information only with the RR in the
same cluster. Therefore, clients need to establish IBGP connections only with the
RR. This reduces the number of IBGP connections in the cluster. As shown in
Figure 9-5, in AS 65000, Cluster1 is composed of an RR and three clients. The
number of IBGP connections in AS 65000 is then reduced from 10 to 4, which
simplifies the device configuration and reduces the loads on the network and CPU.
The RR allows a BGP device to advertise the BGP routes learned from an IBGP
peer to other IBGP peers, and uses the Cluster_List and Originator_ID attributes to
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 695
eliminate routing loops. The RR advertises routes to IBGP peers based on the
following rules:
● The RR advertises the routes learned from a non-client to all the clients.
● The RR advertises the routes learned from a client to all the other clients and
all the non-clients.
● The RR advertises the routes learned from an EBGP peer to all the clients and
non-clients.
Cluster_List Attribute
An RR and its clients form a cluster, which is identified by a unique cluster ID in an
AS. To prevent routing loops between clusters, an RR uses the Cluster_List
attribute to record the cluster IDs of all the clusters that a route passes through
based on the following rules:
● When a route is reflected by an RR for the first time, the RR adds the local
cluster ID to the top of the cluster list. If there is no cluster list, the RR creates
a Cluster_List attribute.
● When receiving an updated route, the RR checks the cluster list of the route. If
the cluster list contains the local cluster ID, the RR discards the route. If the
cluster list does not contain the local cluster ID, the RR adds the local cluster
ID to the cluster list and then reflects the route.
Originator_ID Attribute
An originator ID identifies the originator of a route and is generated by an RR to
prevent routing loops in a cluster. Its value is the same as a router ID.
When a route is reflected by an RR for the first time, the RR adds the
Originator_ID attribute to this route. The Originator_ID attribute identifies the
originator of the route. If the route contains the Originator_ID attribute, the RR
retains this Originator_ID attribute.
When a device receives a route, the device compares the originator ID of the route
with the local router ID. If they are the same, the device discards the route.
Backup RR
To ensure network reliability and prevent single-point failures, a cluster requires
redundant RRs. An RR allows a BGP device to advertise the routes received from
an IBGP peer to other IBGP peers. Therefore, routing loops may occur between
RRs in the same cluster. To prevent this, all the RRs in the cluster must use the
same cluster ID.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 696
Figure 9-6 Backup RR
As shown in Figure 9-6, RR1 and RR2 reside in the same cluster and have the
same cluster ID configured.
● When Client1 receives an updated route from an EBGP peer, Client1 advertises
this route to RR1 and RR2 using IBGP.
● After RR1 and RR2 receive this route, they add the local cluster ID to the top
of the cluster list of the route and then reflect the route to other clients
(Client2 and Client3) and to each other.
● After RR1 and RR2 receive the reflected route from each other, they check the
cluster list of the route, finding that the cluster list contains their local cluster
IDs. RR1 and RR2 discard this route to prevent routing loops.
RRs of Multiple Clusters in an AS
If there are multiple clusters in an AS, RRs of the clusters establish IBGP peer
relationships. When RRs reside at different network layers, an RR at the lower
network layer can be configured as a client to implement hierarchical RR. When
RRs reside at the same network layer, RRs of different clusters can establish full-
mesh connections to implement flat RR.
Hierarchical RR
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 697
Figure 9-7 Hierarchical RR
In practice, hierarchical RR is often used. As shown in Figure 9-7, the ISP provides
Internet routes to AS 100. AS 100 is divided into two clusters, Cluster1 and
Cluster2. Four devices in Cluster1 are core routers and use a backup RR to ensure
reliability.
Flat RR
Figure 9-8 Flat RR
As shown in Figure 9-8, the backbone network is divided into multiple clusters.
RRs of the clusters are non-clients and establish full-mesh connections with each
other. Although each client only establishes an IBGP connection with its RR, all the
RRs and clients can receive all routing information.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 698
9.2.7 BGP Confederation
In addition to a route reflector, the confederation is another method that reduces
the number of IBGP connections in an AS. A confederation divides an AS into sub-
ASs. Full-mesh IBGP connections are established in each sub-AS. EBGP connections
are established between sub-ASs. ASs outside a confederation still consider the
confederation as an AS. After a confederation divides an AS into sub-ASs, it
assigns a confederation ID (the AS number) to each router within the AS. This
brings two benefits.
● Original IBGP attributes are retained, including the Local_Pref attribute, MED
attribute, and Next_Hop attribute.
● Confederation-related attributes are automatically deleted when being
advertised outside a confederation.
Therefore, the administrator does not need to configure the rules for filtering
information such as sub-AS numbers at the egress of a confederation.
Figure 9-9 Networking diagram of a confederation
As shown in Figure 9-9, AS 100 is divided into three sub-ASs after a confederation
is configured: AS65001, AS65002, and AS65003. The AS number AS 100 is used as
the confederation ID. In Figure 9-9, to implement route transmission and packet
forwarding, 10 IBGP connections are required if a logical full mesh is used. If the
confederation is used, only two IBGP connections and two EBGP connections are
required. Therefore, using the confederation simplifies the device configuration
and reduces the network and CPU burden. In addition, BGP devices outside AS 100
only know the existence of AS 100 but not the confederation within AS 100.
Therefore, the confederation does not increase the CPU load.
Comparisons Between a Route Reflector and a Confederation
Table 9-2 compares a route reflector and a confederation in terms of the
configuration, device connection, and applications.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 699
Table 9-2 Comparisons between a route reflector and a confederation
Route Reflector Confederation
Retains the existing network topology
and ensures compatibility.
Requires the logical topology to be
changed.
Requires only a route reflector to be
configured because clients do not need
to know that they are clients of a
route reflector.
Requires all devices to be reconfigured.
Requires full-mesh connections
between clusters.
Does not require full-mesh
connections between sub-ASs of a
confederation because the sub-ASs are
special EBGP peers.
Applies to medium and large
networks.
Applies to large networks.
9.2.8 Route Summarization
The BGP routing table of each device is large on large networks. This burdens
devices, increases the route flapping probability, and affects network stability.
Route summarization is a mechanism that combines multiple routes into one
route. This mechanism allows a BGP device to advertise only the summarized
route but not all the specific routes to peers, thereby reducing the size of the BGP
routing table. If the summarized route flaps, the network is not affected,
improving network stability.
BGP supports automatic summarization and manual summarization on IPv4
networks, and supports only manual summarization on IPv6 networks. Automatic
and manual summarization work as follows:
● Automatic summarization
Summarizes the routes imported by BGP. After automatic summarization is
configured, BGP summarizes routes based on the natural network segment
and advertises only the summarized route to peers. For example, BGP
summarizes 10.1.1.1/24 and 10.2.1.1/24 (two Class A addresses with non-
natural mask) into 10.0.0.0/8 (Class A address with natural mask).
● Manual summarization
Summarizes routes in the local BGP routing table. Manual summarization can
help control the attributes of the summarized route and determine whether
to advertise specific routes.
To prevent routing loops caused by route summarization, BGP uses the AS_Set
attribute. The AS_Set attribute is an unordered set of all ASs that a route passes
through. When the summarized route enters an AS in the AS_Set attribute again,
BGP finds that the local AS number has been recorded in the AS_Set attribute of
the route and discards this route to prevent a routing loop.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 700
9.2.9 Route Dampening
When BGP is used on complex networks, route flapping occurs frequently. To
prevent this, BGP uses route dampening to suppress unstable routes.
Route flapping is a process of adding a route to an IP routing table and then
withdrawing this route. When route flapping occurs, a BGP device sends an
Update message to its neighbors. The devices that receive the Update message
need to recalculate routes and modify routing tables. Frequent route flapping
consumes lots of bandwidths and CPU resources and even affects normal network
operation.
Figure 9-10 Diagram of BGP route dampening
Route dampening measures the stability of a route using a penalty value. A larger
penalty value indicates a less stable route. In Figure 9-10, each time route
flapping occurs, BGP increases the penalty of this route by a value of 1000. When
the penalty value of a route exceeds the suppression threshold, BGP suppresses
this route, and does not add it to the IP routing table or advertise any Update
message to peers. After a route is suppressed for a period of time (half-life), the
penalty value is reduced by half. When the penalty value of a route decreases to
the reuse threshold, the route is reusable and is added to the routing table. At the
same time, BGP advertises an Update message to peers. The suppression time is
the period from when a route is suppressed to when the route is reusable.
Route dampening applies only to EBGP routes but not IBGP routes. IBGP routes
may include the routes of the local AS, and an IGP network requires that the
routing tables of devices within an AS be the same. If IBGP routes are dampened,
routing tables on devices are inconsistent when these devices have different
dampening parameters. Therefore, route dampening does not apply to IBGP
routes.
9.2.10 BFD for BGP
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 701
BGP periodically sends messages to peers to detect the status of the peers. It takes
more than 1 second for this detection mechanism to detect a fault. When data is
transmitted at gigabit rates, long-time fault detection will cause packet loss. This
cannot meet high reliability requirements of networks. Bidirectional Forwarding
Detection (BFD) provides the millisecond-level fault detection for BGP to improve
network reliability.
Figure 9-11 Networking diagram of BFD for BGP
As shown in Figure 9-11, RouterA belongs to AS 100 and RouterB belongs to AS
200. RouterA and RouterB are directly connected and establish the EBGP peer
relationship. Association between BGP and BFD is configured on RouterA and
RouterB. When a fault occurs on the link between RouterA and RouterB, BFD can
rapidly detect that the BFD session changes from Up to Down and notify this fault
to RouterA and RouterB. RouterA and RouterB process the neighbor Down event
and select routes again using BGP.
9.2.11 BGP Tracking
BGP tracking provides fast link fault detection to speed up network convergence.
When a fault occurs on the link between BGP peers that have BGP tracking
configured, BGP tracking can quickly detect peer unreachability and instruct the
routing management module to notify BGP of the fault, achieving rapid network
convergence.
Compared to BFD, BGP tracking is easy to configure because it needs to be
configured only on the local device. BGP tracking is a fault detection mechanism
at the routing layer, whereas BFD is a fault detection mechanism at the link layer.
BGP route convergence on a network where BGP tracking is configured is slower
than that on a network where BFD is configured. Therefore, BGP tracking is not
suitable for voice services that require fast convergence.
Applications
In Figure 9-12, RouterA and RouterB, and RouterB and RouterC establish IGP
connections. RouterA and RouterC establish an IBGP peer relationship. BGP
tracking is configured on RouterA. When a fault occurs on the link between
RouterA and RouterB, IGP performs fast convergence. Subsequently, BGP tracking
detects the unreachability of the route to RouterC and notifies the fault to BGP on
RouterA, which then interrupts the BGP connection with RouterC.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 702
Figure 9-12 Networking diagram of BGP tracking
NOTE
If establishing an IBGP peer relationship requires IGP routes, the interval between peer
unreachability discovery and connection interruption needs to be configured. This interval
must be longer than the IGP route convergence time. Otherwise, before IGP route flapping
caused by transient interruption is suppressed, the BGP peer relationship may have been
interrupted, causing unnecessary BGP convergence.
9.2.12 BGP GR
BGP graceful restart (GR) is high availability solutions that minimize the impact of
device failures on user services.
BGP GR ensures that the forwarding plane continues to guide data forwarding
during a device restart or active/standby switchover. The operations on the control
plane, such as reestablishing peer relationships and performing route calculation,
do not affect the forwarding plane. This mechanism prevents service interruptions
caused by route flapping and improves network reliability.
GR concepts are as follows:
● GR restarter
The device that is restarted by the administrator or triggered by failures to
perform GR.
● GR helper
The neighbor that helps the GR restarter to perform GR.
● GR time
The time during which the GR helper retains forwarding information after
detecting the restart or active/standby switchover of the GR restarter.
The BGP GR process is as follows:
1. Using the BGP capability negotiation mechanism, the GR restarter and helper
know each other's GR capability and establish a GR session.
2. When detecting the restart or active/standby switchover of the GR restarter,
the GR helper waits to reestablish a BGP connection with the GR restarter. It
does not delete the routing information and forwarding entries of the GR
restarter or notify other neighbors of the restart or switchover.
3. The GR restarter reestablishes neighbor relationships with all GR helpers
before the GR time expires.
9.2.13 Dynamic Update Peer-Groups
Currently, the rapid growth in the size of the routing table and the complexity of
the network topology require BGP to support more peers. Especially in the case of
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 703
a large number of peers and routes, high-performance grouping and forwarding
are required when a router needs to send routes to a large number of BGP peers,
most of which share the same outbound policies.
The dynamic update peer-groups feature treats all the BGP peers with the same
outbound policies as an update-group. In this case, routes are grouped uniformly
and then sent separately. That is, each route to be sent is grouped once and then
sent to all peers in the update-group, improving grouping efficiency exponentially.
For example, a route reflector (RR) has 100 clients and needs to reflect 100,000
routes to these clients. If the RR sends the routes grouped per peer to 100 clients,
the total number of times that all routes are grouped is 10,000,000 (100,000 x
100). After the dynamic update peer-groups feature is used, the total number of
grouping times changes to 100,000 (100,000 x 1), improving grouping
performance by a factor of 100.
Applications
BGP uses the dynamic update peer-groups technology when a large number of
peers and routes exist and most peers share the same outbound policies,
improving BGP route grouping and forwarding performance. The dynamic update
peer-groups feature applies to the following scenarios:
● International gateway
As shown in Figure 9-13, the Internet gateway (IGW) router sends routes to
all neighboring ASs. If the IGW router supports the dynamic update peer-
groups feature, its BGP route forwarding performance will be greatly
improved.
Figure 9-13 Networking diagram of the international gateway
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 704
● RR
As shown in Figure 9-14, RRs send routes to all clients. If the RRs support the
dynamic update peer-groups feature, their BGP route forwarding performance
will be greatly improved.
Figure 9-14 Networking diagram of RRs
● ASBR
As shown in Figure 9-15, RouterB, as an Autonomous System Boundary
Router (ASBR), sends all the routes received from an EBGP neighbor RouterA
to all IBGP neighbors. If RouterB supports the dynamic update peer-groups
feature, its BGP route forwarding performance will be greatly improved.
Figure 9-15 Networking diagram of a PE connecting to multiple IBGP
neighbors
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 705
9.2.14 MP-BGP and Address Families
The Border Gateway Protocol 4 (BGP-4) transmits only IPv4 unicast routing
information and cannot transmit routing information for other network layer
protocols, such as IPv6 and multicast protocols.
To support multiple types of network layer protocols, the Internet Engineering
Task Force (IETF) extended BGP-4 to Multiprotocol Extensions for BGP-4 (MP-
BGP). The current MP-BGP standard is RFC 4760. MP-BGP is forward compatible.
Switches that support BGP extension can communicate with switches that do not.
As an enhancement of BGP-4, MP-BGP provides routing information for various
protocols, such as IPv6 (BGP4+) and multicast:
● MP-BGP maintains unicast and multicast routing information, and stores both
types in different routing tables to ensure their separation.
● MP-BGP supports unicast and multicast, and constructs different network
topologies for each.
● MP-BGP can maintain unicast and multicast routes based on routing policies.
The unicast routing policies and configurations supported by BGP-4 can
mostly be applied to multicast.
Extended Attributes
BGP-4 update packets carry three IPv4-related attributes: network layer reachable
information (NLRI), Next_Hop, and Aggregator. Aggregator contains the IP address
of the BGP speaker that performs route aggregation.
To support multiple types of network layer protocols, BGP-4 needs to carry the
information about network layer protocols in NLRI and Next_Hop. MP-BGP
introduces the following route attributes:
● MP_REACH_NLRI: indicates the multiprotocol reachable NLRI, which is used to
advertise a reachable route and the next hop.
● MP_UNREACH_NLRI: indicates the multiprotocol unreachable NLRI, which is
used to withdraw an unreachable route.
The two attributes are optional non-transitive. Therefore, BGP speakers that do
not support multiprotocol ignore the information carried by the two attributes,
and do not advertise the information to peers.
NOTE
Optional non-transitive is a BGP attribute type. If a BGP device does not support this
attribute type, the Update messages with attributes of this type are ignored, and the
messages are not advertised to other peers.
MP_REACH_NLRI
Multiprotocol Reachable NLRI (MP_REACH_NLRI) is used to advertise reachable
routes and information about the next hop. MP_REACH_NLRI is coded as one or
more 3-tuples of the form <Address Family Information, Next Hop Information,
Network Layer Reachability Information>.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 706
Figure 9-16 Format of the MP_REACH_NLRI field
Descriptions of each part of the MP_REACH_NLRI field are as follows:
● Address Family Information: consists of a 2-byte Address Family Identifier
(AFI) and a 1-byte Subsequent Address Family Identifier (SAFI):
– The AFI identifies a network layer protocol. Defined values for this field
are specified in RFC 1700 (Address Family Number). For example, 1
indicates IPv4; 2 indicates IPv6.
– The SAFI indicates the type of the NLRI field.
If the AFI is 1 and the SAFI is 128, the address in the NLRI field is a BGP-
VPNv4 address.
● Next Hop Network Address Information: consists of the 1-byte length of the
next-hop network address and the next-hop network address of a variable
length. A next-hop network address refers to the network address of the next
device on the path to the destination.
● Network Layer Reachable Information: is a variable-length field that lists NLRI
for the routes being advertised. Figure 9-17 shows the format of the NLRI
field.
Figure 9-17 Format of the NLRI field that carries label information
Descriptions of each part of the NLRI field are as follows:
– Length: indicates the total bits of the label and prefix.
– Label: consists of one or more labels. The length of a label is 3 bytes.
– Prefix: In a BGP/Multiprotocol Label Switching (MPLS) IP VPN, the prefix
field consists of a route distinguisher (RD) and IPv4 address prefix.
VPNv4 update messages exchanged between provider edges (PEs) or autonomous
system boundary routers (ASBRs) carry MP_REACH_NLRI. An Update message can
carry multiple reachable routes with the same routing attributes.
MP_UNREACH_NLRI
Multiprotocol Unreachable NLRI (MP_UNREACH_NLRI) is used to inform a peer to
delete unreachable routes. Figure 9-18 shows the format of the attribute.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 707
Figure 9-18 Format of the MP_UNREACH_NLRI field
Descriptions of each part of the MP_UNREACH_NLRI field are as follows:
● AFI: identifies a network layer protocol. AFI uses the address family values
defined in RFC 1700.
● SAFI: indicates the NLRI type and is similar to SAFI in MP_REACH_NLRI.
● Withdrawn Routes: indicates an unreachable route list, which consists of one
or more NLRI fields. In the Withdrawn Routes field, BGP speakers can
withdraw the route by filling the NLRI field in the same manner as that for
the previously advertised reachable route.
Update messages carrying MP_UNREACH_NLRI are sent to withdraw routes. An
Update message can carry information about multiple unreachable routes.
If the labels of routes to be withdrawn are specified in the messages, the routes
with specified labels are withdrawn. If the labels are not specified, only the routes
without labels are withdrawn.
Update messages with MP_UNREACH_NLRI do not carry any path attributes.
Negotiation of the MP-BGP Capability
A BGP device gets to know the negotiation capability of its peer by checking the
capability parameters in Open messages. If the BGP device and its peer support
the same function, the BGP device and its peer communicate using the function.
The optional parameters of the negotiation capability in an Open message consist
of three parts: Capability Code, Capability Length, and Capability Value. Figure
9-19 shows the format of the capability parameters.
Figure 9-19 Format of BGP capability parameters
Descriptions of BGP capability parameters are as follows:
● Capability Code: uniquely identifies the capability type. The value 1 indicates
that the BGP speaker has the MP-BGP capability.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 708
● Capability Length: indicates the length of the capability field. For MP-BGP, the
length of the capability field is 4.
● Capability Value: indicates the value of the capability field. The length is
variable and depends on the type specified in Capability Code. Figure 9-20
shows the format of the Capability Value field:
– The meanings of 2-byte AFI and 1-byte SAFI are the same as those of
MP_REACH_NLRI.
– Res. is a 1-byte reserved field. The sender sets the value to 0, and the
receiver ignores the field.
Figure 9-20 Format of the Capability Value field
At present, BGP does not support dynamic capability negotiation. After a BGP
speaker advertises an Open message with optional capability fields:
● If the speaker receives a Notification message from its peer, the peer does not
support the capability. Then the BGP speaker tears down the session with its
peer and sends an Open message without any optional capability fields to the
peer to attempt a new BGP connection.
● If the peer supports the capability advertisement but the capability fields are
unknown or unsupported, negotiation fails. Then the BGP speaker tears down
the session with its peer, and sends an Open message without the optional
capability fields (but may carry other optional capability fields) to the peer to
attempt a new BGP connection.
After any change in BGP capabilities, such as enabling or disabling label-routing
capabilities, enabling or disabling address family capabilities (IPv4, IPv6, VPNv4,
and VPNv6), and enabling graceful restart (GR) capabilities, the BGP speaker tears
down the session with its peer, and then re-negotiates the capabilities with its
peer.
Address Family
BGP uses address families to differentiate network protocol applications. The
switch supports a wide range of MP-BGP applications. These applications can be
configured in their respective extended BGP address family views.
Table 9-3 lists BGP address families.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 709
Table 9-3 BGP address families
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
IPv4
unicas
t
addre
ss
family
1 1
or
4
Provides the following functions:
● Maintains public network BGP
peer relationships and transmits
public network IPv4 routes. When
a BGP-IPv4 unicast address family
transmits public network IPv4
routes, the SAFI field is 1.
● Transmits public network labeled
IPv4 routes. This function mainly
applies to BGP/MPLS IPv4 VPN or
BGP/MPLS IPv6 VPN in inter-AS
Option C mode. When a BGP-IPv4
unicast address family transmits
public network labeled IPv4
routes, the SAFI field is 4.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
unicast
[HUAWEI-bgp-af-ipv4]
BGP-
IPv4
multic
ast
addre
ss
family
1 2 Allows PEs to maintain multicast
BGP (MBGP) peer relationships. If
the multicast source and receiver are
in two autonomous systems (ASs),
an inter-AS multicast distribution
tree (MDT) must be established.
MBGP can transmit multicast
routing information across ASs.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
multicast
[HUAWEI-bgp-af-multicast]
BGP
VPN
instan
ce
IPv4
addre
ss
family
1 1 Allows BGP to transmit VPN IPv4
routing information between PEs
and CEs in a BGP/MPLS IPv4 VPN
scenario.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
vpn-instance vpna
[HUAWEI-bgp-vpna]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 710
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
VPNv
4
addre
ss
family
1 1
2
8
Allows PEs to establish BGP VPNv4
peer relationships and exchange
VPNv4 routes in a BGP/MPLS IPv4
VPN scenario.
After a PE receives a CE's local VPN
routes, the PE adds an RD and an
export route target (ERT) to these
routes and exchanges them with its
BGP VPNv4 peers. RDs differentiate
the routes from different VPNs, and
route targets (RTs) control the
distribution of VPNv4 routes into
virtual routing and forwarding tables
(VRFs). A PE maintains only routing
information about the VPNs that the
PE accesses and does not maintain
all VPN routes on the service
provider network.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
vpnv4
[HUAWEI-bgp-af-vpnv4]
BGP-
MDT
addre
ss
family
1 6
6
Allows PEs to exchange information
about share-groups and their
multicast sources over BGP sessions
in Protocol Independent Multicast
(PIM) source-specific multicast
(SSM) scenarios.
PIM-SSM can be configured on a
public network only if PEs know the
locations of the multicast sources in
advance. Share-groups are
configured on PEs, but a PE does not
know the multicast tunnel interface
(MTI) addresses of the share-groups
on other PEs. All PEs in a multicast
domain (MD) select an MTI address
that is used to establish the public
network BGP peer relationship as
the multicast source IP address.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
mdt
[HUAWEI-bgp-af-mdt]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 711
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
multic
ast
VPN
(MVP
N)
addre
ss
family
1 5 Applies to MCAST-VPN SAFI A-D.
BGP A-D MVPN has two modes:
MDT-SAFI A-D and MCAST-VPN SAFI
A-D.
In both modes, PEs discover their
peers by sending BGP update
packets that carry MVPN
configurations, such as the RD and
share-group address. BGP A-D
MVPN services can be transmitted
over public tunnels along the PIM-
SSM MDT. Compared with MDT-SAFI
A-D, MCAST-VPN SAFI A-D has a
broader definition, supports more
extensions, and carries more MVPN
attributes and information for
establishing public network tunnels.
MCAST-VPN SAFI A-D supports the
next-generation MVPN.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
mvpn
[HUAWEI-bgp-af-mvpn]
BGP-
IPv6
unicas
t
addre
ss
family
2 1
or
4
Provides the following functions:
● Maintains public network IPv6
BGP peer relationships and
transmits public network IPv6
routes. When a BGP-IPv6 unicast
address family transmits public
network IPv6 routes, the SAFI
field is 1.
● Transmits labeled IPv6 routes.
This function mainly applies to
6PE scenario. When a BGP-IPv6
unicast address family transmits
labeled IPv6 routes, the SAFI field
is 4.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv6-family
unicast
[HUAWEI-bgp-af-ipv6]
BGP
VPN
instan
ce
IPv6
addre
ss
family
2 1 Allows BGP to transmit VPN IPv6
routing information between PEs
and CEs in a BGP/MPLS IPv6 VPN
scenario.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv6-family
vpn-instance vpna
[HUAWEI-bgp6-vpna]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 712
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
VPNv
6
addre
ss
family
2 1
2
8
Allows PEs to establish BGP VPNv6
peer relationships and exchange
VPNv6 routes in a BGP/MPLS IPv6
VPN scenario.
After a PE receives a CE's local VPN
IPv6 routes, the PE adds an RD and
an ERT to these routes and
exchanges them with its BGP VPNv6
peers. RDs differentiate routes from
different VPNs, and RTs control the
distribution of VPNv6 routes into
VRFs. A PE maintains only routing
information about the VPNs that the
PE accesses and does not maintain
all VPN routes on the service
provider network.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv6-family
vpnv6
[HUAWEI-bgp-af-vpnv6]
BGP-
L2VP
N
addre
ss
family
1
9
6
1
2
8
Allows PEs to manage L2VPN label
blocks. MPLS L2VPN in Kompella
mode uses BGP as the signaling. PEs
on an MPLS L2VPN in Kompella
mode automatically discover their
peer PEs by sending BGP update
packets that carry VPN information
and use RTs to differentiate data
from different VPNs.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] l2vpn-family
[HUAWEI-bgp-af-l2vpn]
BGP-
virtual
privat
e LAN
servic
e
(VPLS
)
addre
ss
family
2
5
6
5
Applies to Kompella VPLS. After you
configure a BGP peer relationship
between two PEs in the BGP-VPLS
address family view, the two PEs can
exchange VPLS label blocks. VPLS is
a point-to-multipoint (P2MP) L2VPN
service provided over a public
network. VPLS can be implemented
in either Kompella or Martini mode.
Kompella VPLS uses BGP as the
signaling, and Martini VPLS uses the
Label Distribution Protocol (LDP) as
the signaling.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] vpls-family
[HUAWEI-bgp-af-vpls]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 713
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
L2VP
N-AD
addre
ss
family
2
5
6
5
Allows PEs to support BGP AD VPLS.
BGP AD VPLS has the advantages of
both Kompella VPLS and Martini
VPLS. BGP-AD-VPLS-enabled devices
exchange extended BGP packets to
automatically discover member
virtual switch instances (VSIs) in a
VPLS domain and use LDP FEC 129
to negotiate pseudo wire (PW)
establishment to achieve automatic
VPLS PW deployment.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] l2vpn-ad-
family
[HUAWEI-bgp-af-l2vpn-ad]
BGP-
EVPN
addre
ss
family
view
2
5
7
0
The BGP-EVPN address family view
is mainly used to configure BGP
EVPN peers.
Ethernet virtual private network
(EVPN) is a VPN technology used for
Layer 2 internetworking. EVPN is
similar to BGP/MPLS IP VPN. EVPN
defines a new type of BGP network
layer reachability information
(NLRI), called the EVPN NLRI. The
EVPN NLRI defines new BGP EVPN
routes to implement MAC address
learning and advertisement between
Layer 2 networks at different sites.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] l2vpn-family
evpn
[HUAWEI-bgp-af-evpn]
9.2.15 BGP VPN Route Crossing
In a BGP/MPLS IP VPN scenario, after a PE receives BGP VPN routes from a CE or
BGP VPNv4 routes from a remote PE, the local PE implements route crossing to
add desired routes to the routing table of this local VPN instance and sends the
crossed routes to corresponding VPN sites, which concludes route learning in this
scenario. Route crossing can be classified as local route crossing and remote route
crossing based on the source of the BGP VPN route.
● Remote route crossing: After a PE receives a BGP VPNv4 route from a remote
PE, the local PE matches the export target (ERT) of the route against the
import targets (IRTs) configured for local VPN instances. If the ERT matches
the IRT of a local VPN instance, the PE converts the BGP VPNv4 route to a
BGP VPN route and adds the BGP VPN route to the routing table of this local
VPN instance.
● Local route crossing: A PE matches the ERT of a BGP VPN route in a local VPN
instance against the IRTs configured for other local VPN instances. If the ERT
matches the IRT of a local VPN instance, the PE adds the BGP VPN route to
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 714
the routing table of this local VPN instance. Locally crossed routes include
both locally imported routes and routes learned from VPN peers.
After a PE receives VPNv4 routes destined for the same IP address from another
PE or VPN routes from a CE, the local PE implements route crossing by following
the steps in Figure 9-21.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 715
Figure 9-21 Flowchart for BGP VPN route crossing
In Figure 9-22, PEs have the same VPN instance (vpna) and RTs (including the
ERT and IRT). The RD configured for PE2 and PE3 is 2:2, and the RD configured for
PE4 is 3:3. Site 2 has a route destined for 10.1.1.0/24. The route is sent to PE2, PE3,
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 716
and PE4, who convert this route to multiple BGP VPNv4 routes and send them to
PE1. On receipt of the BGP VPNv4 routes, PE1 implements route crossing as shown
in Figure 9-23. The detailed process is as follows:
1. After receiving the BGP VPNv4 routes from PE2, PE3, and PE4, PE1 adds them
to the BGP VPNv4 routing table.
2. The RDs configured for the VPN instance on PE2 and PE3 are the same.
Therefore, the BGP VPNv4 routes that PE2 and PE3 send to PE1 are the same.
On receipt of the BGP VPNv4 routes from PE2 and PE3, PE1 selects an optimal
BGP VPNv4 route (the route from PE3 in this example) from them, converts
the optimal BGP VPNv4 route and the BGP VPNv4 route received from PE4 to
BGP VPN routes by removing their RDs, and adds the BGP VPN routes to the
routing table of the BGP VPN instance.
3. PE1 selects an optimal BGP VPN route from the two BGP VPN routes based
on BGP route selection policies and adds the optimal BGP VPN route to the IP
VPN instance routing table.
NOTE
If a PE receives two BGP VPNv4 routes with the same RD from remote PEs, only one of the
BGP VPNv4 routes can be added to the routing table of the BGP VPN instance. As a result,
VPN FRR or load balancing cannot be implemented between VPN routes.
Figure 9-22 Route crossing networking
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 717
Figure 9-23 BGP VPN route crossing process
9.2.16 Route Processing on the BGP router
Figure 9-24 shows the route processing on the BGP router. BGP routes can be
imported from other protocols or learned from BGP peers. Route summarization
can be configured to reduce the routing table size before routes are selected,
advertised, and delivered to the IP routing table.
Figure 9-24 Route processing on the BGP router
Table 9-4 lists some key points for Figure 9-24.
Table 9-4 Key points for route processing
No. Remarks
1 BGP can import direct routes, static routes, user network routes, and IGP
routes based on the import-route (BGP) or network command
configuration.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 718
No. Remarks
2 BGP can use routing policies when importing routes from other protocols,
receiving routes from BGP peers, or advertising routes to BGP peers.
Routing policies can be used to filter routes or modify route attributes.
3 BGP supports automatic and manual summarization. Multiple routing
policies can be used during manual summarization.
4 BGP selects routes based on strict route selection rules, which is the key
point to be discussed in the following part.
5 BGP adds the optimal route to the BGP routing table and advertises it to
BGP peers.
6 BGP adds the routes learned from peers and the optimal route in the BGP
routing table to the IP routing table for traffic forwarding.
9.2.17 BGP Routing Table
Table 9-5 lists all the common route attributes that affect BGP route selection and
the commands that are used to check them.
Table 9-5 Commands used to check route attributes
Route
Attribute
Command Used to Check the Route Attribute
PrefVal display bgp routing-table [
network ]
Local_Pref display bgp routing-table [
network ]
Route type display bgp routing-table
network
AS_Path display bgp routing-table [
network ]
Origin display bgp routing-table [
network ]
MED display bgp routing-table [
network ]
Peer type display bgp routing-table
network
IGP cost ● display bgp routing-table
network
● display ip routing-table
ip-address [
mask |
mask-length ]
[ verbose ], in which
ip-address is the next hop IP address of a
BGP route
Cluster_List display bgp routing-table
network
Originator_I
D
display bgp routing-table
network
Router ID display bgp routing-table
network
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 719
Route
Attribute
Command Used to Check the Route Attribute
Peer IP
address
display bgp routing-table
network
The following example describes how to check BGP route attributes in the display
bgp routing-table command output.
<HUAWEI> display bgp routing-table
BGP Local router ID is 192.168.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 9
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
*>i 2.2.2.7/32 10.1.1.2 0 100 0 (65001)i
* i 10.1.3.1 0 100 0 (65011 65001)i
*>i 2.2.2.8/32 10.1.2.2 0 100 0 (65011)i
* i 10.1.3.2 0 100 0 (65001 65011)i
*>i 2.2.2.9/32 10.1.4.2 0 100 0 (65001 65101)i
* i 10.1.5.2 0 100 0 (65011 65101)i
i 3.3.3.9/32 10.1.6.2 0 100 0 (65001 65101) 300i
i 10.1.6.2 0 100 0 (65011 65001 65101) 300i
Table 9-6 Description of the display bgp routing-table command output
Item Description
BGP Local
router ID is
192.168.2.2 Router ID: 192.168.2.2, in the same format as an IPv4 address
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 720
Item Description
Status
codes
Route status code, displayed in front of each route entry:
● *: indicates a valid route with a reachable next hop address.
● >: indicates an optimal route selected by BGP.
● d: indicates a dampened route.
● h: indicates a History route.
● i: indicates a route learned from an IBGP peer.
● s: indicates a suppressed route. If specific routes for route
summarization are suppressed, s is displayed in front of each
specific route.
● S: indicates a route in Stale status, and the route is being
deleted. Such routes may occur during a BGP GR process.
BGP dampening measures route stability using a penalty value.
The greater the penalty value, the less stable a route. Each time
route flapping occurs (a device receives a Withdraw or an Update
packet), BGP adds a penalty value to the route carried in the
packet.
When the penalty value of a route exceeds the Suppress value,
BGP suppresses the route by replacing the > sign of the route with
the d or h sign. The route is ignored and its Update packets are
not advertised to other BGP peers until the penalty value of the
route decreases to the Reuse value.
● If d is displayed in front of a route, the route is carried in an
Update packet.
● If h is displayed in front of a route, the route is carried in a
Withdraw packet.
The penalty value is not increased after it reaches the suppression
threshold. The penalty value of a suppressed route reduces by half
after a half-life period.
● When the penalty value of a route with the d sign decreases to
the Reuse value, the route becomes reusable, and BGP removes
the d sign, adds the route to the IP routing table, and
advertises an Update packet carrying the route to BGP peers.
● When the penalty value of a route with the h sign decreases to
0, BGP deletes this route from the BGP routing table.
Origin
Route origin code, displayed in front of each route entry:
● IGP: indicates that routes are added to the BGP routing table
using the network (BGP) command.
● EGP: indicates that routes are learned through the EGP
protocol.
● Incomplete: indicates that routes are added to the BGP routing
table using the import-route (BGP) command.
Network Network address in the BGP routing table
NextHop Next hop address
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 721
Item Description
MED MED value of a BGP route, similar to the cost of IGP routes
LocPrf Local_Pref
PrefVal PrefVal
Path/Ogn AS_Path and Origin attributes
Information about Next_Hop, MED, Local_Pref, PrefVal, AS_Path, and Origin can be
displayed using the display bgp routing-table command. To check information
about the route type, peer type, IGP cost, Cluster_List, router ID, and peer IP
address, run the display bgp routing-table
network command.
<HUAWEI> display bgp routing-table 10.1.1.1
BGP local router ID : 192.168.2.2
Local AS number : 65001
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.1/32:
From: 10.1.3.1 (192.168.2.3)
Route Duration: 05h35m04s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet1/0/4
Original nexthop: 10.1.3.1
Qos information : 0x0
AS-path Nil, origin incomplete, MED 1234, localpref 100, pref-val 0, valid, internal, best, select, active,
pre 255, IGP cost 1
Not advertised to any peer yet
Table 9-7 Description of the display bgp routing-table command output
Item Description
BGP local router
ID
Router ID of the local device, in the same format as an IPv4
address.
Local AS
number
Local AS number.
Paths BGP route information.
BGP routing
table entry
information of
10.1.1.1/32
Information about the BGP route 10.1.1.1/32:
From IP address of the device that advertised the route. In this
example, 10.1.3.1 is the IP address of the interface used by
the peer to establish the BGP peer relationship (peer IP
address), and 192.168.2.3 is the router ID of the peer.
Route Duration Duration of a route.
Relay IP
Nexthop
IP address of the route to which the BGP route is recursed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 722
Item Description
Relay IP Out-
Interface
Outbound interface of the route to which the BGP route is
recursed.
Original nexthop Original next hop IP address.
Qos information QoS information.
AS-path AS_Path attribute. If Nil is displayed, the AS_Path attribute is
null.
origin
incomplete
Origin attribute:
● IGP: indicates that routes are added to the BGP routing
table using the network (BGP) command.
● EGP: indicates that routes are learned through the EGP
protocol.
● Incomplete: indicates that routes are imported using the
import-route (BGP) command.
MED MED value of a BGP route, similar to the cost of IGP routes.
localpref Local_Pref
pref-val PrefVal
valid Valid route with a reachable next hop address.
internal Type of the peer from which the route is learned.
● external: indicates that the route is learned from an EBGP
peer.
● internal: indicates that the route is learned from an IBGP
peer.
best Optimal route.
select Selected route to be delivered to the IP routing table.
NOTE
According to BGP selection rules, BGP selects only one optimal route,
and this route is marked with best. In load balancing or FRR
scenarios, more than one route needs to be added to the IP routing
table, and each of the route is marked with select. Therefore, the
number of the route marked with best is 1, and the number of the
routes marked with select is the actual number of routes added to
the IP routing table.
active Active route.
pre 255 Protocol priority of the route: 255
Not advertised
to any peer yet
The route has not advertised to any peer yet.
The display bgp routing-table
network [ {
mask |
mask-length } [ longer-
prefixes ] ] command output varies with the route generation mode and
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 723
transmission mode, and not all BGP attributes are necessarily displayed. In the
preceding example, the route type is not displayed because the route 10.1.1.1/32 is
an IBGP route. For example:
<HUAWEI> display bgp routing-table 10.0.0.0
BGP local router ID : 192.168.2.4
Local AS number : 200
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.0.0.0/8:
Aggregated route.
Route Duration: 04h50m46s
Direct Out-interface: NULL0
Original nexthop: 127.0.0.1
Qos information : 0x0
AS-path {65001 10 100}, origin incomplete, pref-val 0, valid, local, best, select, active, pre 255
Aggregator: AS 200, Aggregator ID 192.168.2.4, Atomic-aggregate
Advertised to such 3 peers:
10.1.7.2
172.16.1.2
192.168.1.2
The route 10.0.0.0/8 was manually summarized using the aggregate command.
Therefore, Aggregated route is displayed in the command output. The route type
varies as follows:
● If the route is automatically summarized using the summary automatic
command, Summary automatic route will be displayed.
● If the route is imported using the network command, Network route will be
displayed.
● If the route is imported using the import-route command, Imported route
will be displayed.
In the following example, an RR and a cluster are configured. Therefore, the
Cluster_List attribute is displayed in the display bgp routing-table
network
[ {
mask |
mask-length } [ longer-prefixes ] ] command output.
<HUAWEI> display bgp routing-table 10.2.1.0
BGP local router ID : 4.4.4.4
Local AS number : 65010
Paths: 1 available, 0 best, 0 select
BGP routing table entry information of 10.2.1.0/24:
From: 10.1.4.1 (2.2.2.2)
Route Duration: 00h00m14s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface:
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, internal, pre 255
Originator: 1.1.1.1
Cluster list: 0.0.0.1
Not advertised to any peer yet
9.2.18 Route Attributes
9.2.18.1 BGP Route Attributes
There may be multiple routes to the same destination in a BGP routing table. BGP
will select one route as the optimal route and advertise it to peers. To select the
optimal route among these routes, BGP compares the BGP attributes of the routes
in sequence based on route selection rules.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 724
BGP Attributes
Route attributes describe routes. BGP route attributes are classified into the
following types. Table 9-8 lists common BGP attributes.
● Well-known mandatory attribute
All BGP devices can identify this type of attribute, which must be carried in
Update messages. Without this type of attribute, errors occur in routing
information.
● Well-known discretionary attribute
All BGP devices can identify this type of attribute, which is optional in Update
messages. Errors do not occur in routing information even if there is a lack of
this type of attribute.
● Optional transitive attribute
This type of attribute can be transmitted between ASs. A BGP device may not
identify this type of attribute but still accepts and advertises them to peers.
● Optional non-transitive attribute
A BGP device may not identify this type of attribute, in which case it ignores
them without advertising them to peers.
Table 9-8 Common BGP attributes
Attribute Type
Origin Well-known mandatory
AS_Path Well-known mandatory
Next_Hop Well-known mandatory
Local_Pref Well-known discretionary
Community Optional transitive
MED Optional non-transitive
Originator_ID Optional non-transitive
Cluster_List Optional non-transitive
The following describes common BGP route attributes:
● Origin
The Origin attribute defines the origin of a route and marks the path of a
BGP route. The Origin attribute is classified into three types:
– IGP
A route with IGP as the Origin attribute has the highest priority. The
Origin attribute of the routes imported into a BGP routing table using the
network command is IGP.
– EGP
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 725
A route with EGP as the Origin attribute has the second highest priority.
The Origin attribute of the routes obtained through EGP is EGP.
– Incomplete
A route with Incomplete as the Origin attribute has the lowest priority.
The Origin attribute of the routes learned by other means is Incomplete.
For example, the Origin attribute of the routes imported by BGP using
the import-route command is Incomplete.
● AS_Path
The AS_Path attribute records all of the ASs that a route passes through from
the source to the destination in the vector order. To prevent inter-AS routing
loops, a BGP device does not receive the routes whose AS_Path list contains
the local AS number.
When a BGP speaker advertises an imported route:
– If the route is advertised to EBGP peers, the BGP speaker creates an
AS_Path list containing the local AS number in an Update message.
– If the route is advertised to IBGP peers, the BGP speaker creates an
empty AS_Path list in an Update message.
When a BGP speaker advertises a route learned in the Update message sent
by another BGP speaker:
– If the route is advertised to EBGP peers, the BGP speaker adds the local
AS number to the leftmost of the AS_Path list. According to the AS_Path
list, the BGP speaker that receives the route can determine the ASs
through which the route passes to reach the destination. The number of
the AS that is nearest to the local AS is placed on the top of the AS_Path
list. The other AS numbers are listed according to the sequence in which
the route passes through ASs.
– If the route is advertised to IBGP peers, the BGP speaker does not change
the AS_Path attribute of the route.
● Next_Hop
The Next_Hop attribute records the next hop that a route passes through. The
Next_Hop attribute of BGP is different from that of an IGP because it may not
be a neighboring IP address. A BGP speaker processes the Next_Hop attribute
based on the following rules:
– When advertising a route to an EBGP peer, a BGP speaker sets the
Next_Hop attribute of the route to the address of the local interface
through which the BGP peer relationship is established.
– When advertising a locally originated route to an IBGP peer, the BGP
speaker sets the Next_Hop attribute of the route to the address of the
local interface through which the BGP peer relationship is established.
– When advertising a route learned from an EBGP peer to an IBGP peer, the
BGP speaker does not change the Next_Hop attribute of the route.
● Local_Pref
The Local_Pref attribute indicates the BGP preference of a device and helps
determine the optimal route when traffic leaves an AS. When a BGP device
obtains multiple routes to the same destination address but with different
next hops from different IBGP peers, the BGP device prefers the route with the
highest Local_Pref. The Local_Pref attribute is exchanged only between IBGP
peers and is not advertised to other ASs. The Local_Pref attribute can be
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 726
manually configured. If no Local_Pref attribute is configured for a route, the
Local_Pref attribute of the route uses the default value 100.
● MED
The multi-exit discriminator (MED) attribute helps determine the optimal
route when traffic enters an AS. When a BGP device obtains multiple routes to
the same destination address but with different next hops from EBGP peers,
the BGP device selects the route with the smallest MED value as the optimal
route.
The MED attribute is exchanged only between two neighboring ASs. The AS
that receives the MED attribute does not advertise it to any other ASs. The
MED attribute can be manually configured. If no MED attribute is configured
for a route, the MED attribute of the route uses the default value 0.
● Community
The Community attribute:
– Identifies the BGP routes with the same characteristics.
– Simplifies the applications of routing policies.
– Facilitates route maintenance and management.
The Community attribute includes self-defined community attributes and
well-known community attributes. Table 9-9 lists well-known community
attributes.
Table 9-9 Well-known community attributes
Community
Attribute
Value Description
Internet 0
(0x00000000)
A BGP device can advertise the
received route with the Internet
attribute to all peers.
No_Advertise 4294967042
(0xFFFFFF02)
A BGP device does not advertise the
received route with the No_Advertise
attribute to any peer.
No_Export 4294967041
(0xFFFFFF01)
A BGP device does not advertise the
received route with the No_Export
attribute to devices outside the local
AS.
No_Export_Subc
onfed
4294967043
(0xFFFFFF03)
A BGP device does not advertise the
received route with the
No_Export_Subconfed attribute to
devices outside the local AS or to
devices outside the local sub-AS.
● Originator_ID and Cluster_List
The Originator_ID attribute and Cluster_List attribute help eliminate loops in
route reflector scenarios. For details, see 9.2.6 Route Reflector.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 727
9.2.18.2 Next_Hop
Unlike the Next_Hop attribute in an IGP, the Next_Hop attribute in BGP is not
necessarily the IP address of a neighboring device. In most cases, the Next_Hop
attribute in BGP complies with the following rules:
● When advertising a route to an EBGP peer, a BGP speaker sets the Next_Hop
of the route to the address of the local interface through which the BGP peer
relationship is established.
● When advertising a locally generated route to an IBGP peer, a BGP speaker
sets the Next_Hop of the route to the address of the local interface through
which the BGP peer relationship is established.
● When advertising a route learned from an EBGP peer to an IBGP peer, the
BGP speaker does not modify the Next_Hop of the route.
Modifying the Next_Hop
In some scenarios, the Next_Hop needs to be modified. Table 9-10 describes
whether the Next_Hop needs to be modified in specific scenarios.
Table 9-10 Next_Hop processing
Objectives Command Usage Scenarios Remarks
To enable an
ASBR to
modify the
Next_Hops
of the routes
to be
advertised to
IBGP peers.
peer {
group-
name |
ipv4-
address |
ipv6-
address } next-
hop-local
By default, when an
ASBR forwards a route
learned from an EBGP
peer to its IBGP peers,
the ASBR does not
change the Next_Hop
of the route. Therefore,
the Next_Hop address
of the route remains
the EBGP peer IP
address. After being
forwarded to the IBGP
peers, the route cannot
become active as the
Next_Hop is
unreachable. To
address this issue,
configure the ASBR to
modify the Next_Hop
of the route to the
local IP address before
advertising the route
to IBGP peers. After
being forwarded to the
IBGP peers, the route
can be active because
the Next_Hop is
reachable (an IGP is
configured in the AS).
If BGP load
balancing has
been configured
using the
maximum load-
balancing
number
command, the
switch modifies
the Next_Hop of
each route to the
local IP address
through which the
IBGP peer
relationship is
established before
it advertises the
route to IBGP
peers, regardless
of whether the
peer next-hop-
local command is
configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 728
Objectives Command Usage Scenarios Remarks
To prevent a
device from
modifying
the
Next_Hops
of the routes
imported
from an IGP
before
advertising
the routes to
IBGP peers.
peer {
ipv4-
address |
group-
name } next-hop-
invariable
- By default, a
device modifies
the Next_Hops of
the routes
imported from an
IGP to the local IP
address before
advertising the
routes to IBGP
peers.
To prevent a
device from
modifying
the
Next_Hops
of routes
before
advertising
the routes to
EBGP peers.
peer {
ipv4-
address |
group-
name } next-hop-
invariable
In an inter-AS VPN
Option C scenario
where an RR is used,
the peer next-hop-
invariable command
needs to be run on the
RR to prevent the RR
from modifying the
Next_Hops of routes
before advertising the
routes to EBGP peers.
This ensures that the
remote PE recurses
routes to the LSP
destined for the local
PE during traffic
transmission.
By default, a
device modifies
the Next_Hops of
routes to the local
IP address before
advertising the
routes to EBGP
peers.
In addition, a
device does not
modify the
Next_Hops of
non-labeled
routes if the
routes are learned
from EBGP peers
and are to be
advertised to IBGP
peers; the device
sets its interface
IP address as the
Next_Hops of
labeled routes if
the routes are
learned from
EBGP peers and
are to be
advertised to IBGP
peers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 729
Objectives Command Usage Scenarios Remarks
To configure
BGP
Next_Hop
recursion
based on a
route-policy.
nexthop
recursive-lookup
route-policy
route-policy-name
To enable a device to
recurse only desired
routes, configure
Next_Hop recursion
based on a specified
route-policy so that
only the routes that
match the route-policy
are recursed.
By default,
Next_Hop
recursion based
on a specified
route-policy is not
configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 730
Objectives Command Usage Scenarios Remarks
To enable a
device to
modify the
Next_Hops
of BGP
routes using
a route-
policy.
apply ip-address
next-hop{
ipv4-
address | peer-
address }
The Next_Hops of BGP
routes can be modified
using a route-policy in
the following
situations:
● For IBGP peers, the
route-policy can be
an import or export
policy. Even if the
next hop address
configured in the
route-policy is
unreachable, the
IBGP peers still add
the routes whose
next hop addresses
have been changed
to the address
configured in the
route-policy to the
BGP routing table.
However, the routes
are invalid.
● For EBGP peers, the
route-policy can
only be an import
policy in most cases.
If the route-policy is
configured as an
export policy, the
routes whose next
hop addresses have
been changed to
the address
configured in the
route-policy are
discarded by the
EBGP peers because
the next hop
address is
unreachable.
If a route-policy
has been specified
in the import-
route or network
command, the
apply clause
configured for the
route-policy using
the apply ip-
address next-hop
command does
not take effect.
Obtaining a Reachable Next Hop
During route selection, BGP first checks whether the next hop addresses of routes
are reachable. Routes carrying unreachable next hop addresses are invalid and are
not selected. Table 9-11 shows how to obtain a reachable next hop IP address or
tunnel.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 731
Table 9-11 Unreachable next hop
Item Description Solutions
Unreachable next hop IP
address
A next hop IP address is
obtained through route
recursion, but no active
routes to the IP address
are available in the IP
routing table.
Common solutions are as
follows:
● Configure static
routes or an IGP.
● Run the import-route
command.
● Run the network
command.
Alternatively, you can
run the peer next-hop-
local command to
change the Next_Hop to
the local IP address.
Unreachable next hop
tunnel
Routes fail to be
recursed to tunnels.
Configure a tunnel policy
or a tunnel selector to
ensure that the routes
can be recursed to
tunnels.
A next hop tunnel is
obtained through route
recursion, but the tunnel
is unavailable.
Ensure that the tunnel is
correctly configured and
is Up.
The following example shows how to obtain a reachable next hop IP address. In
Figure 9-25, an IBGP peer relationship is established between Switch A and Switch
B, and an EBGP peer relationship is established between Switch B and Switch C.
Switch A imports the route 1.1.1.9/32, and Switch C imports the route 3.3.3.9/32.
Figure 9-25 Networking
# Display the BGP routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 732
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
i 3.3.3.9/32 10.1.2.1 0 100 0 65001i
The preceding command output shows that no asterisk (*) is in front of the route
3.3.3.9/32, which indicates that the route is invalid.
# Display the IP routing table of Switch A.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 5 Routes : 5
Destination/Mask Proto Pre Cost Flags NextHop Interface
1.1.1.9/32 Direct 0 0 D 127.0.0.1 LoopBack1
10.1.1.0/30 Direct 0 0 D 10.1.1.1 GigabitEthernet0/0/0
10.1.1.1/32 Direct 0 0 D 127.0.0.1 GigabitEthernet0/0/0
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
The preceding command output shows that the next hop IP address (10.1.2.1) of
the route 3.3.3.9/32 is not in the IP routing table, which indicates that the route is
not selected due to the unreachable next hop IP address. The following solutions
can address this issue:
● Configure a static route destined for 10.1.2.1/30 on Switch A.
● Configure an IGP on Switch B and Switch C and configure BGP to import the
route 10.1.2.1 on Switch B. This solution is not applicable to this specific
scenario because Switch B and Switch C are located in different ASs.
● Run the import-route direct command on Switch B. This solution is not
optimal because unnecessary routes may be imported.
● Run the network 10.1.2.0 30 command on Switch B to advertise the route
10.1.2.0/30 to Switch A.
● Run the peer 10.1.1.1 next-hop-local command on Switch B to configure
Switch B to modify the Next_Hop of the route 3.3.3.9/32 before advertising
the route to Switch A.
In this example, the network 10.1.2.0 30 command is configured on Switch B.
After the command is configured, check the BGP routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
*>i 3.3.3.9/32 10.1.2.1 0 100 0 65001i
*>i 10.1.2.0/30 10.1.1.2 0 100 0 i
The preceding command output shows that both * and > are in front of the route
3.3.3.9/32, which indicates that the route is valid and optimal.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 733
9.2.18.3 PrefVal
PrefVal is Huawei-specific and valid only on the device where it is configured. The
PreVal attribute is set by customers. Therefore, BGP first compares the PreVal
values during route selection.
If multiple routes are available to the same destination, the route with the largest
PreVal value is selected as the optimal route. By default, the PreVal of the routes
learned from BGP peers is 0.
Table 9-12 lists two methods to modify the PreVal value.
Table 9-12 Methods to modify the PreVal value
Method Usage Scenario
Run the peer {
group-name |
ipv4-
address |
ipv6-address } preferred-
value
value command.
This method sets a PreVal value for
the routes learned from a peer or peer
group.
Configure an import policy and run the
apply preferred-value
preferred-value
command to configure an apply clause
for the policy.
This method sets different PreVal
values for different routes learned
from a peer or peer group.
NOTE
If both the methods are used, the method
with the import policy takes effect if routes
match the conditions specified in the peer
preferred-value command and the import
policy.
The following example shows how the PreVal value is used during BGP route
selection. In Figure 9-26, both ISP1 and ISP2 advertise the routes 10.11.0.0/16 and
10.22.0.0/16 to AS 65001.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 734
Figure 9-26 PreVal application networking
Scenario 1: When no PreVal value is configured on Switch A, check the BGP
routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.11.0.0/16 10.1.3.2 0 200?
* 10.1.2.2 0 300 100?
*> 10.22.0.0/16 10.1.3.2 0 200?
* 10.1.2.2 0 300 100?
The BGP routing table of Switch A shows that Switch A receives the routes
10.11.0.0/16 and 10.22.0.0/16 from ISP1 and ISP2. Check the information about
the route 10.11.0.0/16 on Switch A.
[SwitchA] display bgp routing-table 10.11.0.0
BGP local router ID : 10.1.2.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 735
From: 10.1.3.2 (10.1.3.2)
Route Duration: 00h08m35s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 200, origin incomplete, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.2.2
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h04m38s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 300 100, origin incomplete, pref-val 0, valid, external, pre 255, not preferred for AS-Path
Not advertised to any peer yet
The preceding command output shows that the AS_Path of the route learned from
ISP2 is shorter than that of the route learned from ISP1. Therefore, the route
learned from ISP2 is selected as the optimal route. Table 9-13 shows the route
attribute comparison of the routes 10.11.0.0/16 learned from ISP1 and ISP2.
Table 9-13 Route attribute comparison of the route learned from ISP1 and that
learned from ISP2
Route Attribute Route Learned
from ISP1
Route Learned
from ISP2
Comparison
PrefVal 0 0 The same.
Local_Pref - - The same.
NOTE
If a route does not
carry Local_Pref,
the default value
100 takes effect.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 300 100 200 The route learned
from ISP2 is
selected as the
optimal route
because its
AS_Path is shorter
than that of the
route learned
from ISP1.
Scenario 2: The administrator of AS 65001 requires that ISP1 be active and ISP2
be backup for the traffic to 10.11.0.0/16 and 10.22.0.0/16.
To meet the preceding requirements, run the peer {
group-name |
ipv4-address |
ipv6-address } preferred-value
value command on Switch A to increase the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 736
PrefVal values of the routes learned from ISP1. This configuration ensures that the
routes learned from ISP1 are selected as the optimal routes. Detailed
configurations are as follows:
bgp 65001
#
ipv4-family unicast
peer 10.1.2.2 preferred-value 120 //Set the PrefVal of the routes learned from AS 300 to 120.
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.11.0.0/16 10.1.2.2 120 300 100?
* 10.1.3.2 0 200?
*> 10.22.0.0/16 10.1.2.2 120 300 100?
* 10.1.3.2 0 200?
The preceding command output shows that Switch A selects the routes learned
from ISP1.
# Display detailed information about the route 10.11.0.0/16 or 10.22.0.0/16 on
Switch A. The route 10.11.0.0/16 is used as an example.
[SwitchA] display bgp routing-table 10.11.0.0
BGP local router ID : 10.1.2.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h05m36s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 300 100, origin incomplete, pref-val 120, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.2.2
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.3.2 (10.1.3.2)
Route Duration: 00h23m11s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 200, origin incomplete, pref-val 0, valid, external, pre 255, not preferred for PreVal
Not advertised to any peer yet
The preceding command output shows that the PrefVal value of the route learned
from ISP1 is greater than that of the route learned from ISP2 and that the route
learned from ISP1 is selected as the optimal route.
Scenario 3: The expected configurations of the administrator of AS 65001 are as
follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 737
● For the traffic destined to 10.11.0.0/16, ISP1 is active and ISP2 is backup.
● For the traffic destined to 10.22.0.0/16, ISP2 is active and ISP1 is backup.
To meet the preceding requirements, ensure that Switch A selects the route
10.11.0.0/16 learned from ISP1 and the route 10.22.0.0/16 learned from ISP2. In
this situation, the peer preferred-value command can no longer be used because
different PrefVal values are required for the routes learned from the same ISP. To
allow different PrefVal values for the routes learned from the same ISP, configure
import policies. Detailed configurations are as follows:
#
bgp 65001
#
ipv4-family unicast
peer 10.1.2.2 route-policy for_isp1_in import //Apply import policy named for_isp1_in to the routes
learned from 10.1.2.2 and use for_isp1_in to modify the PrefVal value.
peer 10.1.3.2 route-policy for_isp2_in import //Apply import policy named for_isp2_in to the routes
learned from 10.1.3.2 and use for_isp2_in to modify the PrefVal value.
#
route-policy for_isp1_in permit node 10 //Define the first node of for_isp1_in and set the PrefVal
value of the route 10.11.0.0/16 to 80.
if-match ip-prefix for_isp1
apply preferred-value 80
#
route-policy for_isp1_in permit node 20 //Define the second node of for_isp1_in and allow
for_isp1_in to permit all routes.
#
route-policy for_isp2_in permit node 10 //Define the first node of for_isp2_in and set the PrefVal
value of the route 10.22.0.0/16 to 120.
if-match ip-prefix for_isp2
apply preferred-value 120
#
route-policy for_isp2_in permit node 20 //Define the second node of for_isp2_in and allow
for_isp2_in to permit all routes.
#
ip ip-prefix for_isp1 index 10 permit 10.11.0.0 16 //Configure an IP prefix list to match the route
10.11.0.0/16.
ip ip-prefix for_isp2 index 10 permit 10.22.0.0 16 //Configure an IP prefix list to match the route
10.22.0.0/16.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.11.0.0/16 10.1.2.2 80 300 100?
* 10.1.3.2 0 200?
*> 10.22.0.0/16 10.1.3.2 120 200?
* 10.1.2.2 0 300 100?
The preceding command output shows that Switch A selects the route
10.11.0.0/16 learned from ISP1 and the route 10.22.0.0/16 learned from ISP2.
# Display detailed information about the route 10.22.0.0/16 on Switch A.
[SwitchA] display bgp routing-table 10.22.0.0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 738
BGP local router ID : 10.1.2.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.22.0.0/16:
From: 10.1.3.2 (10.1.3.2)
Route Duration: 00h14m14s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 200, origin incomplete, pref-val 120, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.2.2
BGP routing table entry information of 10.22.0.0/16:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h07m54s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 300 100, origin incomplete, pref-val 0, valid, external, pre 255, not preferred for PreVal
Not advertised to any peer yet
The preceding command output shows that two routes 10.22.0.0/16 are available
in the BGP routing table of Switch A and that the route with the next hop address
10.1.3.2 is selected because its PrefVal (120) is greater than the PrefVal (0) of the
route with next hop address 10.1.2.2. The PrefVal value is sufficient enough to
determine the optimal route, and therefore, Switch A does not compare other
route attributes.
The preceding examples show that PrefVal values can be configured as required to
control the traffic forwarding path.
9.2.18.4 Local_Pref
The Local_Pref attribute is used to determine the optimal route when traffic leaves
an AS. The Local_Pref attribute is available only to IBGP peers and is not
advertised to other ASs.
Table 9-14 lists two methods to modify the Local_Pref value.
Table 9-14 Methods to modify the Local_Pref value
Method Usage Scenario
Run the default local-preference
command.
This method sets a default Local_Pref
for the routes that the local device
advertises to IBGP peers.
Configure an import or export policy
and run the apply local-preference
command to configure an apply clause
for the policy.
This method sets different Local_Pref
values for different routes that the
local device advertises to IBGP peers.
NOTE
If both the methods are used, the method
with the import policy takes effect if routes
match the conditions specified in the apply
local-preference command and the policy.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 739
The following example shows how the Local_Pref value is used during BGP route
selection. In Figure 9-27, both ISP1 and ISP2 advertise the routes 10.11.0.0/16 and
10.22.0.0/16 to AS 65001.
Figure 9-27 Local_Pref application networking
Scenario 1: When no Local_Pref value is configured on Switch A and Switch B,
check the BGP routing tables of Switch A and Switch B.
[SwitchA] display bgp routing-table
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/30 0.0.0.0 0 0 i
*>i 10.1.2.0/30 10.1.3.2 0 100 0 i
*> 10.11.0.0/16 10.1.1.1 0 100 10i
* i 10.1.2.1 100 0 200 10i
*> 10.22.0.0/16 10.1.1.1 0 100 10i
* i 10.1.2.1 100 0 200 10i
The BGP routing table of Switch A shows that Switch A receives the routes
10.11.0.0/16 and 10.22.0.0/16 from ISP1 and Switch B. Check the information
about the route 10.11.0.0/16 on Switch A.
[SwitchA] display bgp routing-table 10.11.0.0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 740
BGP local router ID : 192.168.2.3
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.1.1 (192.168.2.5)
Route Duration: 04h41m03s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.4.2
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.3.2 (192.168.2.2)
Route Duration: 01h42m40s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet1/0/3
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for peer type
Not advertised to any peer yet
The preceding command output shows that the route learned from ISP1 is
selected as the optimal route because it is an EBGP route and the route learned
from Switch B is an IBGP route. Table 9-15 shows the route attribute comparison
of the routes 10.11.0.0/16 learned from ISP1 and Switch B.
Table 9-15 Route attribute comparison of the routes 10.11.0.0/16 learned from
ISP1 and Switch B
Route Attribute Route Learned
from ISP1
Route Learned
from Switch B
Comparison
PrefVal 0 0 The same.
Local_Pref - 100 The same.
NOTE
If a route does not
carry Local_Pref,
the default value
100 takes effect.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 100 10 200 10 The same length.
Origin IGP IGP The same.
MED - - The same.
Peer type EBGP IBGP Route
10.11.0.0/16
learned from ISP1
is optimal.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 741
The route selection process on Switch B is the same as that on Switch A. Then,
Switch A and Switch B advertise the optimal routes to Switch C. Check the routing
table of Switch C.
[SwitchC] display bgp routing-table
Total Number of Routes: 6
BGP Local router ID is 192.168.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.4.1 0 100 0 i
*>i 10.1.2.0/30 10.1.5.1 0 100 0 i
*>i 10.11.0.0/16 10.1.2.1 100 0 200 10i
* i 10.1.1.1 100 0 100 10i
*>i 10.22.0.0/16 10.1.2.1 100 0 200 10i
* i 10.1.1.1 100 0 100 10i
The preceding command output shows that Switch C selects the routes advertised
by Switch B.
Check the reason why the routes learned from Switch A are not selected on Switch
C. The route 10.11.0.0/16 is used as an example.
[SwitchC] display bgp routing-table 10.11.0.0
BGP local router ID : 192.168.2.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.5.1 (192.168.2.2)
Route Duration: 00h12m46s
Relay IP Nexthop: 10.1.5.1
Relay IP Out-Interface: GigabitEthernet1/0/1
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Not advertised to any peer yet
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.4.1 (192.168.2.3)
Route Duration: 00h17m30s
Relay IP Nexthop: 10.1.4.1
Relay IP Out-Interface: GigabitEthernet1/0/0
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for router ID
Not advertised to any peer yet
The preceding command output shows that Switch C selects the route
10.11.0.0/16 learned from Switch B because the router ID (192.168.2.2) of Switch
B is smaller than that (192.168.2.3) of Switch A. Table 9-16 shows the route
attribute comparison of the routes 10.11.0.0/16 learned from Switch A and Switch
B.
Table 9-16 Route attribute comparison of the routes 10.11.0.0/16 learned from
Switch A and Switch B
Route Attribute Route Learned
from Switch A
Route Learned
from Switch B
Comparison
PrefVal 0 0 The same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 742
Route Attribute Route Learned
from Switch A
Route Learned
from Switch B
Comparison
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 100 10 200 10 The same length.
Origin IGP IGP The same.
MED - - The same.
Peer type IBGP IBGP The same.
IGP cost - - The same.
Cluster_List - - The same length.
Router ID 192.168.2.3 192.168.2.2 Route
10.11.0.0/16
learned from
Switch B is
optimal.
Scenario 2: The administrator of AS 65001 requires that ISP1 be active and ISP2
be backup for the traffic to 10.11.0.0/16 and 10.22.0.0/16.
To meet the preceding requirements, run the default local-preference command
on Switch A to increase the Local_Pref values of the routes learned from Switch A.
This configuration ensures that the routes learned from ISP1 are selected as the
optimal routes. Detailed configurations are as follows:
#
bgp 65001
#
ipv4-family unicast
default local-preference 120 //Set the Local_Pref of the routes to be advertised to 120.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/30 0.0.0.0 0 0 i
*>i 10.1.2.0/30 10.1.3.2 0 100 0 i
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 743
*> 10.11.0.0/16 10.1.1.1 0 100 10i
*> 10.22.0.0/16 10.1.1.1 0 100 10i
The preceding command output shows that Switch A selects the routes learned
from ISP1.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 192.168.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.3.1 0 120 0 i
*> 10.1.2.0/30 0.0.0.0 0 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
* 10.1.2.1 0 200 10i
*>i 10.22.0.0/16 10.1.1.1 120 0 100 10i
* 10.1.2.1 0 200 10i
The preceding command output shows that Switch B selects the routes learned
from Switch A. Switch B does not advertise the routes learned from ISP2 to its
IBGP peers because those routes are not selected.
# Display detailed information about the route 10.11.0.0/16 or 10.22.0.0/16 on
Switch B. The route 10.11.0.0/16 is used as an example.
[SwitchB] display bgp routing-table 10.11.0.0
BGP local router ID : 192.168.2.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.3.1 (192.168.2.3)
Route Duration: 00h22m16s
Relay IP Nexthop: 10.1.3.1
Relay IP Out-Interface: GigabitEthernet1/0/4
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, localpref 120, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
10.1.2.1
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.2.1 (192.168.2.4)
Route Duration: 00h22m23s
Direct Out-interface: GigabitEthernet1/0/0
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, pref-val 0, valid, external, pre 255, not preferred for Local_Pref
Not advertised to any peer yet
The preceding command output shows that the Local_Pref value of the route
learned from Switch A is greater than that of the route learned from ISP2 and that
the route learned from Switch A is selected as the optimal route. Table 9-17
shows the route attribute comparison of the routes 10.11.0.0/16 learned from
Switch A and ISP2.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 744
Table 9-17 Route attribute comparison of the routes 10.11.0.0/16 learned from
Switch A and ISP2
Route Attribute Route Learned
from Switch A
Route Learned
from ISP2
Comparison
PrefVal 0 0 The same.
Local_Pref 120 - Route
10.11.0.0/16
learned from
Switch A is
optimal.
NOTE
If a route does not
carry Local_Pref,
the default value
100 takes effect.
# Display the routing table of Switch C.
[SwitchC] display bgp routing-table
Total Number of Routes: 4
BGP Local router ID is 192.168.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.4.1 0 120 0 i
*>i 10.1.2.0/30 10.1.5.1 0 100 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
*>i 10.22.0.0/16 10.1.1.1 120 0 100 10i
Switch C selects the routes advertised by ISP1 because Switch B did not advertise
the routes learned from ISP2 to Switch C.
Scenario 3: The requirements of the administrator of AS 65001 are as follows:
● ISP1 is active and ISP2 is backup for the traffic to 10.11.0.0/16.
● ISP2 is active and ISP1 is backup for the traffic to 10.22.0.0/16.
To meet the preceding requirements, ensure that AS 65001 selects the route
10.11.0.0/16 learned from Switch A and the route 10.22.0.0/16 learned from
Switch B. Detailed configurations are as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 745
Figure 9-28 Local_Pref-based BGP route selection networking (1)
In this situation, different Local_Pref values are required for the routes learned
from the same ISP. To configure different Local_Pref values for the routes learned
from the same ISP, configure route-policies. Detailed configurations are as follows:
● Configurations on Switch A
#
bgp 65001
#
ipv4-family unicast
peer 10.1.1.1 route-policy rp1 import //Apply import policy named rp1 to the routes
learned from 10.1.1.1 and use rp1 to modify the Local_Pref.
#
route-policy rp1 permit node 10 //Define the first node of rp1 and set the Local_Pref
value of the route 10.11.0.0/16 to 120.
if-match ip-prefix addpref
apply local-preference 120
#
route-policy rp1 permit node 20 //Define the second node of rp1 and set the
Local_Pref value of the route 10.22.0.0/16 to 80.
if-match ip-prefix reducepref
apply local-preference 80
#
route-policy rp1 permit node 30 //Define the third node of rp1 and allow rp1 to
permit all routes.
#
ip ip-prefix addpref index 10 permit 10.11.0.0 16 //Configure an IP prefix list to match the route
10.11.0.0/16.
ip ip-prefix reducepref index 10 permit 10.22.0.0 16 //Configure an IP prefix list to match the route
10.22.0.0/16.
#
● Configurations on Switch B
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 746
bgp 65001
#
ipv4-family unicast
peer 10.1.2.1 route-policy rp2 import //Apply import policy named rp2 to the routes
learned from 10.1.1.1 and use rp2 to modify the Local_Pref.
#
route-policy rp2 permit node 10 //Define the first node of rp2 and set the Local_Pref
value of the route 10.22.0.0/16 to 200.
if-match ip-prefix addpref
apply local-preference 200
#
route-policy rp2 permit node 20 //Define the second node of rp2 and set the
Local_Pref value of the route 10.11.0.0/16 to 60.
if-match ip-prefix reducepref
apply local-preference 60
#
route-policy rp2 permit node 30 //Define the third node of rp2 and allow rp2 to
permit all routes.
#
ip ip-prefix addpref index 10 permit 10.22.0.0 16 //Configure an IP prefix list to match the route
10.22.0.0/16.
ip ip-prefix reducepref index 10 permit 10.11.0.0 16 //Configure an IP prefix list to match the route
10.11.0.0/16.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/30 0.0.0.0 0 0 i
*>i 10.1.2.0/30 10.1.3.2 0 100 0 i
*> 10.11.0.0/16 10.1.1.1 120 0 100 10i
*>i 10.22.0.0/16 10.1.2.1 200 0 200 10i
* 10.1.1.1 80 0 100 10i
# Display detailed information about the route 10.22.0.0/16 on Switch A.
[SwitchA] display bgp routing-table 10.22.0.0
BGP local router ID : 192.168.2.3
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.22.0.0/16:
From: 10.1.3.2 (192.168.2.2)
Route Duration: 00h20m12s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet1/0/3
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 200, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
10.1.1.1
BGP routing table entry information of 10.22.0.0/16:
From: 10.1.1.1 (192.168.2.5)
Route Duration: 00h19m40s
Direct Out-interface: GigabitEthernet1/0/1
Original nexthop: 10.1.1.1
Qos information : 0x0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 747
AS-path 100 10, origin igp, localpref 80, pref-val 0, valid, external, pre 255, not preferred for Local_Pref
Not advertised to any peer yet
The preceding command output shows that two routes 10.22.0.0/16 are available
in the BGP routing table of Switch A and that the route with next hop address
10.1.2.1 is selected because its Local_Pref (200) is greater than the Local_Pref (80)
of the route with next hop address 10.1.1.1.
Table 9-18 shows the route attribute comparison of the routes 10.22.0.0/16
learned from ISP1 and Switch B.
Table 9-18 Route attribute comparison of the routes 10.22.0.0/16 learned from
ISP1 and Switch B.
Route Attribute Route Learned
from ISP1
Route Learned
from Switch B
Comparison
PrefVal 0 0 The same.
Local_Pref 80 200 Route
10.22.0.0/16
learned from
Switch B is
optimal.
The route with next hop address 10.1.1.1 is not optimal, and therefore, it is not
advertised to Switch B and Switch C. In addition, the route 10.11.0.0/16 with next
hop address 10.1.2.1 is not optimal on Switch B, and therefore, Switch B does not
advertise this route to Switch A and Switch C. As a result, only one route
10.11.0.0/16 with next hop address 10.1.1.1 is available in the BGP routing table of
Switch A.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 192.168.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.3.1 0 100 0 i
*> 10.1.2.0/30 0.0.0.0 0 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
* 10.1.2.1 60 0 200 10i
*> 10.22.0.0/16 10.1.2.1 200 0 200 10i
# Display detailed information about the route 10.11.0.0/16 on Switch B.
[SwitchB] display bgp routing-table 10.11.0.0
BGP local router ID : 192.168.2.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.3.1 (192.168.2.3)
Route Duration: 00h40m28s
Relay IP Nexthop: 10.1.3.1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 748
Relay IP Out-Interface: GigabitEthernet1/0/4
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, localpref 120, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
10.1.2.1
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.2.1 (192.168.2.4)
Route Duration: 00h41m00s
Direct Out-interface: GigabitEthernet1/0/0
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 60, pref-val 0, valid, external, pre 255, not preferred for Local_Pref
Not advertised to any peer yet
The preceding command output shows that two routes 10.11.0.0/16 are available
in the BGP routing table of Switch B and that the route with next hop address
10.1.1.1 is selected because its Local_Pref (120) is greater than the Local_Pref (60)
of the route with next hop address 10.1.2.1. The route with next hop address
10.1.2.1 is not advertised to Switch A and Switch C because it is not optimal.
# Display the routing table of Switch C.
[SwitchC] display bgp routing-table
Total Number of Routes: 4
BGP Local router ID is 192.168.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.4.1 0 100 0 i
*>i 10.1.2.0/30 10.1.5.1 0 100 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
*>i 10.22.0.0/16 10.1.2.1 200 0 200 10i
The preceding command output shows that the next hop address of the route
10.11.0.0/16 is 10.1.1.1 and that the next hop address of the route 10.22.0.0/16 is
10.1.2.1.
Scenario 4: The requirements of the administrator of AS 65001 are as follows:
● ISP1 is active and ISP2 is backup for the traffic from Switch A and Switch C to
10.11.0.0/16 and 10.22.0.0/16.
● ISP2 is active and ISP1 is backup for the traffic from Switch B to 10.11.0.0/16
and 10.22.0.0/16.
To meet the preceding requirements, ensure that Switch A and Switch C select the
routes learned from ISP1. Detailed configurations are as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 749
Figure 9-29 Local_Pref-based BGP route selection networking (2)
You can perform either of the following operations:
● Configure an export policy on Switch A to modify the Local_Pref of the routes
to be advertised to Switch C.
● Configure an import policy on Switch C to modify the Local_Pref of the routes
learned from Switch A.
The configurations on Switch A are used as an example. Detailed configurations
are as follows:
#
bgp 65001
#
ipv4-family unicast
peer 10.1.4.2 route-policy rp2 export //Apply the export route-policy rp2 to the route destined
for the peer 10.1.4.1 to modify the Local_Pref of the route.
#
route-policy rp2 permit node 10 //Define the node index of the route-policy rp2 to 10 and
set the Local_Pref to 120.
apply local-preference 120
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 750
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/30 0.0.0.0 0 0 i
*>i 10.1.2.0/30 10.1.3.2 0 100 0 i
*> 10.11.0.0/16 10.1.1.1 0 100 10i
* i 10.1.2.1 100 0 200 10i
*> 10.22.0.0/16 10.1.1.1 0 100 10i
* i 10.1.2.1 100 0 200 10i
The preceding command output shows that Switch A selects the routes learned
from ISP1.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 192.168.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.3.1 0 100 0 i
*> 10.1.2.0/30 0.0.0.0 0 0 i
*> 10.11.0.0/16 10.1.2.1 0 200 10i
* i 10.1.1.1 100 0 100 10i
*> 10.22.0.0/16 10.1.2.1 0 200 10i
* i 10.1.1.1 100 0 100 10i
The preceding command output shows that Switch B selects the routes learned
from ISP2.
# Display the routing table of Switch C.
[SwitchC] display bgp routing-table
Total Number of Routes: 6
BGP Local router ID is 192.168.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.4.1 0 120 0 i
*>i 10.1.2.0/30 10.1.5.1 0 100 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
* i 10.1.2.1 100 0 200 10i
*>i 10.22.0.0/16 10.1.1.1 120 0 100 10i
* i 10.1.2.1 100 0 200 10i
The preceding command output shows that Switch C selects the routes learned
from ISP1.
# Display detailed information about the route 10.11.0.0/16 or 10.22.0.0/16 on
Switch C. The route 10.11.0.0/16 is used as an example.
[SwitchC] display bgp routing-table 10.11.0.0
BGP local router ID : 192.168.2.1
Local AS number : 65001
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 751
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.4.1 (192.168.2.3)
Route Duration: 00h06m26s
Relay IP Nexthop: 10.1.4.1
Relay IP Out-Interface: GigabitEthernet1/0/0
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, localpref 120, pref-val 0, valid, internal, best, select, active, pre 255
Not advertised to any peer yet
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.5.1 (192.168.2.2)
Route Duration: 00h08m05s
Relay IP Nexthop: 10.1.5.1
Relay IP Out-Interface: GigabitEthernet1/0/1
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for Local_Pref
Not advertised to any peer yet
The preceding command output shows that Switch C selects the routes learned
from ISP1 because the Local_Pref of the routes learned from ISP1 is greater than
that of the route learned from ISP2.
The preceding examples show that the modification of the Local_Pref values
affects not only BGP route advertisement but also BGP route selection with an AS.
We can configure Local_Pref values as required to control the forwarding path of
the traffic that leaves an AS.
9.2.18.5 Route Type
BGP routes can be locally imported or learned from peers. The locally imported
routes take precedence over the routes learned from peers during BGP route
selection. It is unusual for locally imported routes and the routes learned from
peers to carry the same destination IP address and coexist in the routing table.
Generally, locally imported routes can be the routes imported using the network
or import-route command and the automatically and manually summarized
routes. Precedences of these routes are described as follows:
1. Summarized routes take precedence over non-summarized routes.
2. Summarized routes that are manually generated using the aggregate
command take precedence over summarized routes that are automatically
generated based on the summary automatic command settings.
3. The routes imported using the network command take precedence over the
routes imported using the import-route command.
In Figure 9-30, Switch A and Switch B are EBGP peers, and Switch B, Switch C, and
Switch D are IBGP peers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 752
Figure 9-30 Networking
The configurations on Switch C are as follows:
#
bgp 65001
#
ipv4-family unicast
network 10.1.2.0 255.255.255.252 //Advertise the route 10.1.2.0/30.
network 10.1.4.0 255.255.255.252 //Advertise the route 10.1.4.0/30.
import-route direct //Import direct routes.
#
The configurations on Switch D are as follows:
#
bgp 65001
#
ipv4-family unicast
network 10.1.3.0 255.255.255.252 //Advertise the route 10.1.3.0/30.
network 10.1.4.0 255.255.255.252 //Advertise the route 10.1.4.0/30.
import-route direct //Import direct routes.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch D.
[SwitchD] display bgp routing-table
BGP Local router ID is 10.1.3.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 10
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.2.0/30 10.1.4.2 0 100 0 i
*> 10.1.3.0/30 0.0.0.0 0 0 i
* 0.0.0.0 0 0 ?
*> 10.1.3.2/32 0.0.0.0 0 0 ?
*> 10.1.4.0/30 0.0.0.0 0 0 i
* 0.0.0.0 0 0 ?
i 10.1.4.2 0 100 0 ?
*> 10.1.4.1/32 0.0.0.0 0 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
The preceding command output shows that three routes 10.1.4.0/30 are available
in the routing table. The route with the next hop address 10.1.4.2 is learned from
a peer (Switch C). Therefore, BGP first excludes this route from route selection.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 753
[SwitchD] display bgp routing-table 10.1.4.0 30
BGP local router ID : 10.1.3.2
Local AS number : 65001
Paths: 3 available, 1 best, 1 select
BGP routing table entry information of 10.1.4.0/30:
Network route.
From: 0.0.0.0 (0.0.0.0)
Route Duration: 00h03m51s
Direct Out-interface: GigabitEthernet0/0/4
Original nexthop: 10.1.4.1
Qos information : 0x0
AS-path Nil, origin igp, MED 0, pref-val 0, valid, local, best, select, pre 0
Advertised to such 2 peers:
10.1.3.1
10.1.4.2
BGP routing table entry information of 10.1.4.0/30:
Imported route.
From: 0.0.0.0 (0.0.0.0)
Route Duration: 00h04m10s
Direct Out-interface: GigabitEthernet0/0/4
Original nexthop: 10.1.4.1
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, pref-val 0, valid, local, pre 0, not preferred for route type
Not advertised to any peer yet
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.4.2 (10.1.2.2)
Route Duration: 00h02m24s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/4
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, localpref 100, pref-val 0, internal, pre 255
Not advertised to any peer yet
The preceding command output shows that the route imported using the network
command is selected as the optimal route.
The configurations on Switch B are as follows:
bgp 65001
#
ipv4-family unicast
summary automatic
aggregate 10.0.0.0 255.0.0.0
import-route direct
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.1.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 14
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.0.0 127.0.0.1 0 ?
* 127.0.0.1 0 ?
s> 10.1.1.0/30 0.0.0.0 0 0 ?
*> 10.1.1.2/32 0.0.0.0 0 0 ?
s> 10.1.2.0/30 0.0.0.0 0 0 ?
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 754
i 10.1.2.2 0 100 0 i
*> 10.1.2.1/32 0.0.0.0 0 0 ?
s> 10.1.3.0/30 0.0.0.0 0 0 ?
i 10.1.3.2 0 100 0 i
*> 10.1.3.1/32 0.0.0.0 0 0 ?
*>i 10.1.4.0/30 10.1.3.2 0 100 0 i
* i 10.1.2.2 0 100 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
The preceding command output shows that two summarized routes 10.0.0.0 are
available in the routing table.
[SwitchB] display bgp routing-table 10.0.0.0
BGP local router ID : 10.1.1.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.0.0.0/8:
Aggregated route.
Route Duration: 00h17m04s
Direct Out-interface: NULL0
Original nexthop: 127.0.0.1
Qos information : 0x0
AS-path Nil, origin incomplete, pref-val 0, valid, local, best, select, active, pre 255
Aggregator: AS 65001, Aggregator ID 10.1.1.2
Advertised to such 3 peers:
10.1.1.1
10.1.3.2
10.1.2.2
BGP routing table entry information of 10.0.0.0/8:
Summary automatic route
Route Duration: 00h17m04s
Direct Out-interface: NULL0
Original nexthop: 127.0.0.1
Qos information : 0x0
AS-path Nil, origin incomplete, pref-val 0, valid, local, pre 255, not preferred for route type
Aggregator: AS 65001, Aggregator ID 10.1.1.2
Not advertised to any peer yet
The preceding command output shows that the route generated using the
aggregate command is selected as the optimal route.
9.2.18.6 AS_Path
Four types of AS_Path attributes are available:
● AS_Sequence: records in reverse order all the ASs through which a route
passes from the local device to the destination.
● AS_Set: records in random order all the ASs through which a route passes
from the local device to the destination. The AS_Set attribute is used in route
summarization scenarios.
● AS_Confed_Sequence: records in reverse order all the sub-ASs within a BGP
confederation through which a route passes from the local device to the
destination.
● AS_Confed_Set: records in random order all the sub-ASs within a BGP
confederation through which a route passes from the local device to the
destination.
Table 9-19 describes the AS_Path-based route selection rules.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 755
Table 9-19 AS_Path-based route selection rules
Item Description
AS_Set BGP takes an AS_Set as one AS number even if the
AS_Set contains multiple AS numbers.
When the aggregate (BGP) command is
configured to generate a manually summarized
route, if as-set is specified in the command, AS_Set
will be carried in the summarized route. The
information in the AS_Set is as follows:
● If the routes used in the summarization carry
the same AS_Sequence, this AS_Sequence is
carried in the summarized route, and the AS_Set
of the summarized route is null.
● If the routes used in the summarization carry
different AS_Sequences, all the AS numbers
carried in the AS_Sequences are included in the
AS_Set of the summarized route.
AS_Confed_Sequence and
AS_Confed_Set
BGP ignores AS_Confed_Sequence and
AS_Confed_Set when calculating the AS_Path
length.
bestroute as-path-ignore After the command is configured, BGP does not
compare the AS_Path attribute during route
selection.
apply as-path The command can be run to configure an apply
clause for a route-policy so that the ASs in the
AS_Path of the route that matches the route-policy
are cleared or replaced, or new ASs are added.
NOTE
The configuration of the apply as-path command may
change the traffic forwarding path, or cause routing loops
or route selection errors. Therefore, exercise caution when
configuring the command.
peer public-as-only After the command is configured, BGP deletes
private AS numbers (if any) from the AS_Path
attribute before sending Update packets. Private AS
numbers range from 64512 to 65534.
peer fake-as After the command is configured, BGP can use a
fake AS number to set up a BGP peer relationship.
If the local device uses the actual AS number to
establish an EBGP peer relationship with a remote
device, the actual AS number is carried in the
AS_Path of the route sent to the remote device. If
the local device uses the fake AS number to
establish the EBGP peer relationship, the fake AS
number is carried in the AS_Path of the route sent
to the remote device.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 756
Item Description
peer substitute-as If the command is configured and an AS in the
AS_Path carried in the route sent by a PE to the CE
of the specified peer is the same as the AS of the
CE, the PE replaces the AS with the local AS.
NOTE
The peer substitute-as command applies only to PEs in
BGP MPLS IP/VPN scenarios and may cause routing loops
if it is improperly configured. Therefore, exercise caution
when using the command.
During BGP route selection, BGP compares the AS_Path length by calculating the
number of ASs included in the AS_Sequence if AS_Sequence is carried in a route. If
both AS_Sequence and AS_Set are carried in the route, BGP considers the AS_Path
length to be the number of ASs included in the AS_Sequence plus 1.
Deleting Private AS Numbers
As public AS resources are limited, carriers generally use private AS numbers when
deploying VPNs. Private AS numbers, however, must not be advertised to the
Internet because they may cause routing loops. In Figure 9-31, both ISP1 and ISP2
use 65001 as a private AS number.
Figure 9-31 Networking in which a private AS needs to be deleted
In Figure 9-31, Switch A advertises the route 10.0.0.0/8 to Switch D through ISP1
and ISP2. After receiving this route, Switch D checks its AS_Path. This AS_Path
carries AS 65001, which is the same as the AS of Switch D. As a result, Switch D
discards this route.
To address this problem, run the peer public-as-only command on Switch B so
that Switch B deletes AS 65001 before adding AS 100 (public AS) to the AS_Path
and forwarding the route to Switch C.
In the following situations, after the peer public-as-only command is configured,
BGP does not delete any private AS number from the AS_Path:
● The AS_Path of a route carries the AS number of the remote peer. In this case,
deleting private AS numbers may lead to a routing loop.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 757
● The AS_Path carries both public and private AS numbers, which indicates that
the route has passed through the public network. In this case, deleting private
AS numbers may lead to incorrect traffic forwarding.
The preceding limitations also apply to confederation scenarios.
Adding AS Numbers
In Figure 9-32, AS 65005 imports three routes and advertises them to AS 65001
through two paths.
Figure 9-32 Networking in which new AS numbers are added to the AS_Path
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 172.16.1.0/24 10.1.3.2 0 65003 65005?
* 10.1.1.2 0 65002 65004 65005?
*> 172.16.2.0/24 10.1.3.2 0 65003 65005?
* 10.1.1.2 0 65002 65004 65005?
*> 172.16.3.0/24 10.1.3.2 0 65003 65005?
* 10.1.1.2 0 65002 65004 65005?
[SwitchA] display bgp routing-table 172.16.1.0
BGP local router ID : 10.1.1.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 758
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.3.2 (10.1.5.1)
Route Duration: 00h00m56s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 65003 65005, origin incomplete, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.1.2
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.1.2 (10.1.1.2)
Route Duration: 00h34m43s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path 65002 65004 65005, origin incomplete, pref-val 0, valid, external, pre 255, not preferred for AS-
Path
Not advertised to any peer yet
The preceding command output shows that Switch A selects the route learned
from Switch C because this route has a shorter AS_Path length than that learned
from Switch B. To enable Switch A to select the route learned from Switch B,
configure Switch B to reduce the AS_Path length of the route or configure Switch
C to increase the AS_Path length of the route. In the following example, Switch C
is configured to increase the AS_Path length of the route. The detailed
configurations on Switch C are as follows:
#
bgp 65003
#
ipv4-family unicast
undo synchronization
peer 10.1.3.1 route-policy add_asn export //Apply export policy named add_asn to routes to be
advertised to 10.1.3.1.
#
route-policy add_asn permit node 10 //Define the first node of add_asn.
if-match ip-prefix prefix1 //Configure IP prefix list named prefix1.
apply as-path 65003 65003 65003 additive //Add 65003, 65003, 65003 to the AS_Path of the
route that matches prefix1.
#
route-policy add_asn permit node 20 //Define the second node of add_asn to permit all other
routes.
#
ip ip-prefix prefix1 index 10 permit 172.16.1.0 24 //Define the first index of prefix1 to match the route
172.16.1.0/24.
ip ip-prefix prefix1 index 20 permit 172.16.2.0 24 //Define the second index of prefix1 to match the
route 172.16.2.0/24.
ip ip-prefix prefix1 index 30 permit 172.16.3.0 24 //Define the third index of prefix1 to match the route
172.16.3.0/24.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 759
*> 172.16.1.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65003 65003 65003 65003 65005?
*> 172.16.2.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65003 65003 65003 65003 65005?
*> 172.16.3.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65003 65003 65003 65003 65005?
[SwitchA] display bgp routing-table 172.16.1.0
BGP local router ID : 10.1.1.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.1.2 (10.1.1.2)
Route Duration: 00h33m30s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path 65002 65004 65005, origin incomplete, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.1.2
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.3.2 (10.1.5.1)
Route Duration: 00h02m12s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 65003 65003 65003 65003 65005, origin incomplete, pref-val 0, valid, external, pre 255, not
preferred for AS-Path
Not advertised to any peer yet
The preceding command output shows that the AS_Path length of the route
learned from Switch B is shorter than that of the route learned from Switch C and
that the route learned from Switch B is selected as the optimal route. Table 9-20
shows the attribute comparison of the routes 172.16.1.0 learned from Switch B
and Switch C.
Table 9-20 Attribute comparison of the routes 172.16.1.0 learned from Switch B
and Switch C
Route Attribute Route Learned
from Switch B
Route Learned
from Switch C
Comparison
PrefVal 0 0 The same.
Local_Pref - - The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 65002 65004
65005
65003 65003
65003 65003
65005
The route learned
from Switch B is
optimal.
AS numbers can be added to the AS_Path as required. However, if an AS number is
added to the AS_Path of a route, the route cannot be received by devices in this
AS. Therefore, the local AS number is added in most cases. For example in Figure
9-32, if Switch C adds AS 65001 to the AS_Path of a route before advertising the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 760
route to Switch A, Switch A will discard the route upon receipt because the route
carries Switch A's AS number.
Replacing AS Numbers
When the apply as-path command is configured, if overwrite is specified in the
command, the device will replace the AS numbers in the original AS_Path attribute
to achieve the following goals:
● Hide the actual path information.
● Prevent a route from being discarded by replacing the AS_Path of the route
with a shorter one if the as-path-limit command is configured on the device
that receives this route.
● Reduce the AS_Path length.
AS number replacement can also be used for the purpose of load balancing. For
example in Figure 9-32, the apply as-path 65002 65004 65005 overwrite
command can be configured on Switch A to replace the AS_Path of the route
learned from Switch C so that the route has the same AS_Path as that of the route
learned from Switch B, and the two routes are used to load-balance traffic.
Detailed configurations on Switch A are as follows:
#
bgp 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.3.2 route-policy replace_asn import //Apply export policy named replace_asn to routes to
be advertised to 10.1.3.2.
#
route-policy replace_asn permit node 10 //Define the first node of replace_asn.
if-match as-path-filter filter1 //Configure AS_Path filter named filter1.
apply as-path 65002 65004 65005 overwrite //Replace the AS_Path of the route that matches
filter1 with 65002, 65004, 65005.
#
route-policy replace_asn permit node 20 //Define the second node of replace_asn to permit all
other routes.
#
ip as-path-filter filter1 permit ^65003 //Define AS_Path filter named filter1 to match all the
routes learned from AS 65003.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 172.16.1.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65002 65004 65005?
*> 172.16.2.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65002 65004 65005?
*> 172.16.3.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65002 65004 65005?
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 761
The preceding command output shows that the AS_Path of the route received
from AS 65003 has been replaced, after which the routes received from AS 65002
and AS 65003 have the same AS_Path. Run the maximum load-balancing 2
command on Switch A to set the maximum number of routes for load balancing
to 2. Then, check the detailed route information. The route 172.16.1.0/24 is used in
the following example:
[SwitchA] display bgp routing-table 172.16.1.0
BGP local router ID : 10.1.1.1
Local AS number : 65001
Paths: 2 available, 1 best, 2 select
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.1.2 (10.1.1.2)
Route Duration: 19h57m51s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path 65002 65004 65005, origin incomplete, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.1.2
10.1.3.2
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.3.2 (10.1.5.1)
Route Duration: 00h10m21s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 65002 65004 65005, origin incomplete, pref-val 0, valid, external, select, active, pre 255, not
preferred for router ID
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch B is
optimal and is used along with the route learned from Switch C (not optimal) for
load balancing. Check the information about the route 172.16.1.0/24 in the IP
routing table.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 9 Routes : 12
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/30 Direct 0 0 D 10.1.1.1 GigabitEthernet0/0/1
10.1.1.1/32 Direct 0 0 D 127.0.0.1 GigabitEthernet0/0/1
10.1.3.0/30 Direct 0 0 D 10.1.3.1 GigabitEthernet0/0/0
10.1.3.1/32 Direct 0 0 D 127.0.0.1 GigabitEthernet0/0/0
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.1.0/24 EBGP 255 0 D 10.1.1.2 GigabitEthernet0/0/1
EBGP 255 0 D 10.1.3.2 GigabitEthernet0/0/0
172.16.2.0/24 EBGP 255 0 D 10.1.1.2 GigabitEthernet0/0/1
EBGP 255 0 D 10.1.3.2 GigabitEthernet0/0/0
172.16.3.0/24 EBGP 255 0 D 10.1.1.2 GigabitEthernet0/0/1
EBGP 255 0 D 10.1.3.2 GigabitEthernet0/0/0
The preceding command output shows that BGP has delivered the two routes with
the same route prefix to the IP routing table for load balancing.
Clearing the AS_Path
When the apply as-path command is configured, if none overwrite is specified in
the command, the device clears the AS_Path to hide the actual path information
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 762
and shorten the AP_Path list. If the AS_Path is null, BGP considers its length as 0
during route selection.
9.2.18.7 Origin
Three types of Origin attributes are available:
● IGP: indicates that routes are added to the BGP routing table using the
network command. IGP has the highest priority.
● EGP: indicates that routes are learned through the EGP protocol. EGP has the
second highest priority.
NOTE
The switch can receive and send BGP routes with EGP as the Origin. However, the
switch does not support the EGP protocol; therefore, to set the Origin of routes to EGP,
you need to run the apply origin { egp {
as-number-plain |
as-number-dot } | igp |
incomplete } command to configure an apply clause for a route-policy.
● Incomplete: indicates that routes are added to the BGP routing table using
the import-route command. Incomplete has the lowest priority.
The routes imported using the network command are more specific than those
imported using the import-route command. Therefore, IGP takes precedence over
Incomplete in route selection. In Figure 9-33, Switch A and Switch B are EBGP
peers, and Switch B, Switch C, and Switch D are IBGP peers.
Figure 9-33 Networking diagram with Origin configurations
The configurations on Switch D are as follows:
#
bgp 65001
#
ipv4-family unicast
network 10.1.4.0 255.255.255.252 //Advertise the route 10.1.4.0/30.
#
The configurations on Switch C are as follows:
#
bgp 65001
#
ipv4-family unicast
import-route direct //Import direct routes.
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 763
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.1.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
i 10.1.2.0/30 10.1.2.2 0 100 0 ?
*>i 10.1.4.0/30 10.1.3.2 0 100 0 i
* i 10.1.2.2 0 100 0 ?
The preceding command output shows that two active routes 10.1.4.0/30 are
available in the routing table.
[SwitchB] display bgp routing-table 10.1.4.0
BGP local router ID : 10.1.1.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.3.2 (10.1.3.2)
Route Duration: 01h14m48s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/2
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
10.1.1.1
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 01h13m20s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for
Origin
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch D is
selected because it is imported using the network command and its Origin
priority is higher than that of the route learned from Switch C. Table 9-21
describes the attribute comparison of the routes learned from Switch C and Switch
D.
Table 9-21 Attribute comparison of the routes learned from Switch C and Switch
D
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 764
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path - - The same length.
Origin Incomplete IGP The route learned
from Switch D is
optimal.
The Origin attribute can be modified using a route-policy. In the following
example, a route-policy is configured on Switch B to modify the Origin attribute,
and the detailed configurations are as follows:
#
bgp 65001
#
ipv4-family unicast
peer 10.1.3.2 route-policy for_d import //Apply import policy named for_d to the routes learned
from 10.1.3.2 and use for_d to modify the Origin value.
#
route-policy for_d permit node 10 //Define the route-policy named for_d.
apply origin incomplete //Set the Origin type to Incomplete.
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.1.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
i 10.1.2.0/30 10.1.2.2 0 100 0 ?
*>i 10.1.4.0/30 10.1.2.2 0 100 0 ?
* i 10.1.3.2 0 100 0 ?
The preceding command output shows that the route learned from Switch C
becomes the optimal route.
[SwitchB] display bgp routing-table 10.1.4.0
BGP local router ID : 10.1.1.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 01h28m19s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 765
10.1.1.1
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.3.2 (10.1.3.2)
Route Duration: 00h03m18s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/2
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for
router ID
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch C
becomes the optimal route because it has a smaller router ID than the route
learned from Switch D. Table 9-22 shows the attribute comparison of the routes
learned from Switch C and Switch D.
Table 9-22 Attribute comparison of the routes learned from Switch C and Switch
D
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path - - The same.
Origin Incomplete Incomplete The same.
MED 0 0 The same.
Peer type IBGP IBGP The same.
IGP cost - - The same.
Cluster_List - - The same.
Router ID 10.1.2.2 10.1.3.2 The route learned
from Switch C is
optimal.
9.2.18.8 MED
The MED attribute is transmitted only within an AS or between two neighboring
ASs. The AS that receives the MED attribute does not advertise it to a third AS.
Similar to the cost used by an IGP, the MED is used to determine the optimal route
when traffic enters an AS. When a BGP peer learns multiple routes that have the
same destination address but different next hop addresses from EBGP peers, the
route with the smallest MED value is selected as the optimal route if all the other
attributes are the same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 766
Table 9-23 lists two methods used to modify the MED value.
Table 9-23 Methods to modify the MED value
Method Usage Scenario
Run the default med command. This method sets a default MED for all
the routes that the local device
advertises to its BGP peers. The
default med command takes effect
only with the routes imported locally
using the import-route command and
BGP summarized routes.
Configure an import or export policy
and run the apply cost command to
configure an apply clause for the
policy.
This method sets different MED values
for different routes advertised by the
local device to its EBGP peers.
Configure an export policy and run the
apply cost-type internal command to
configure an apply clause for the
export policy.
This method enables a device to set
MED values for the BGP routes that
are learned from IBGP peers and to be
advertised to EBGP peers and match
the export policy to the costs of the
IGP routes to which the BGP routes are
recursed.
The major points about MED attributes that require consideration are as follows:
● If routes are received from different ASs, traffic will be sent to different ASs. In
addition, BGP selects the optimal route only from the routes destined for the
same address. Therefore, BGP only compares the MEDs of routes that are
from the same AS (excluding confederation sub-ASs). MEDs of two routes are
compared only if the leftmost AS number in the AS_Sequence (excluding
AS_Confed_Sequence) of one route is the same as its counterpart in the other
route.
● If the compare-different-as-med command is run, BGP compares MEDs of
routes even when the routes are received from peers in different ASs. Do not
run this command unless the ASs use the same IGP and route selection mode.
Otherwise, a routing loop may occur.
● If a route does not carry MED, BGP uses the default value (0) as the MED of
the route during route selection. If the bestroute med-none-as-maximum
command is run, BGP considers the largest MED value (4294967295) to be
the MED of the route. After route selection is complete, the MED is restored
to the original value.
● After the bestroute med-confederation command is configured, BGP
compares the MEDs of routes only when the AS_Path attributes of the routes
carry no external AS numbers (ASs that do not belong to the confederation)
and the leftmost AS numbers in each AS_Confed_Sequence are the same.
● After the deterministic-med command is configured, routes will not be
selected in the same sequence they are received.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 767
Figure 9-34 shows an example of using the MED attribute in BGP route selection.
In Figure 9-34, ISP1 and ISP2 can learn the route 1.1.1.9/32 from Switch C or
Switch D.
Figure 9-34 Networking diagram for MED applications
Scenario 1: Check the BGP routing tables of Switch A and Switch B before Switch
C and Switch D are configured to modify the MED of the route 1.1.1.9/32.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 10.1.1.2 0 65001i
* 10.1.3.2 0 65001i
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 768
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 10.1.4.2 0 65001i
* 10.1.2.2 0 65001i
The preceding command output shows that both ISP1 and ISP2 select the route
learned from Switch C as the optimal route. As a result, Switch C and Switch D
cannot load-balance the traffic from ISP1 or ISP2 to 1.1.1.9/32.
Run the display bgp routing-table
ip-address command on Switch B to check the
reason why Switch B chooses the route learned from Switch C.
[SwitchB] display bgp routing-table 1.1.1.9
BGP local router ID : 10.1.2.1
Local AS number : 200
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.4.2 (10.1.1.2)
Route Duration: 00h00m58s
Direct Out-interface: GigabitEthernet0/0/2
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path 65001, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.2.2
10.1.4.2
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h01m07s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 65001, origin igp, pref-val 0, valid, external, pre 255, not preferred for router ID
Not advertised to any peer yet
The preceding command output shows that Switch B selects the route learned
from Switch C because the router ID (10.1.1.2) of Switch C is smaller than that
(10.1.2.2) of Switch D. Table 9-24 describes the attribute comparison of the routes
learned from Switch C and Switch D.
Table 9-24 Attribute comparison of the routes learned from Switch C and Switch
D
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
PrefVal 0 0 The same.
Local_Pref - - The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 65001 65001 The same length.
Origin IGP IGP The same.
MED - - The same.
Peer type EBGP EBGP The same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 769
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
IGP cost - - The same.
Cluster_List - - The same length.
Router ID 10.1.1.2 10.1.2.2 The route learned
from Switch C is
optimal.
Scenario 2: The requirements of the administrator of AS 65001 are as follows:
● For the traffic from ISP1 to 1.1.1.9/32, the link Switch A -> Switch C is active
and the link Switch A -> Switch D is backup.
● For the traffic from ISP2 to 1.1.1.9/32, the link Switch B -> Switch D is active
and the link Switch B -> Switch C is backup.
To meet the preceding requirements, ensure that ISP1 selects the route learned
from Switch C and that ISP2 selects the route learned from Switch D. Figure 9-35
shows the networking in which MED is used to control route selection.
Figure 9-35 Networking diagram for MED applications
Configure route-policies to set different MED values for the routes learned from
different peers. Detailed configurations are as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 770
● Configurations on Switch C:
#
bgp 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.4.1 route-policy addmed100 export //Apply export policy named addmed100 to the
routes to be advertised to 10.1.4.1 and use addmed100 to modify the MED value.
#
route-policy addmed100 permit node 10 //Define the first node of addmed100 and set the
MED of the route 1.1.1.9/32 to 100.
if-match ip-prefix p1
apply cost 100
#
route-policy addmed100 permit node 20 //Define the second node of addmed100 to allow
addmed100 to permit all other routes.
#
ip ip-prefix p1 index 10 permit 1.1.1.9 32 //Configure an IP prefix list to match the route
1.1.1.9/32.
● Configurations on Switch D:
NOTE
The following configurations are intended to ensure that Switch A selects the route
learned from Switch C. However, Switch A has already selected the route learned from
Switch C because the router ID of Switch C is smaller than that of Switch D. Therefore,
the following configurations on Switch D are optional.
#
bgp 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.3.1 route-policy addmed200 export //Apply export policy named addmed200 to the
routes to be advertised to 10.1.3.1 and use addmed200 to modify the MED value.
#
route-policy addmed200 permit node 10 //Define the first node of addmed200 and set the
MED of the route 1.1.1.9/32 to 200.
if-match ip-prefix p1
apply cost 200
#
route-policy addmed200 permit node 20 //Define the second node of addmed200 to allow
addmed200 to permit all other routes.
#
ip ip-prefix p1 index 10 permit 1.1.1.9 32 //Configure an IP prefix list to match the route
1.1.1.9/32.
Run the display bgp routing-table [
ip-address ] command to check the
configurations. Use Switch B as an example.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 10.1.2.2 0 65001i
* 10.1.4.2 100 0 65001i
# Display detailed information about the route 1.1.1.9/32 on Switch B.
[SwitchB] display bgp routing-table 1.1.1.9 32
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 771
BGP local router ID : 10.1.2.1
Local AS number : 200
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 01h20m38s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 65001, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.2.2
10.1.4.2
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.4.2 (10.1.1.2)
Route Duration: 01h16m28s
Direct Out-interface: GigabitEthernet0/0/2
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path 65001, origin igp, MED 100, pref-val 0, valid, external, pre 255, not preferred for MED
Not advertised to any peer yet
The preceding command output shows that two routes 1.1.1.9/32 are available in
the BGP routing table of Switch B and that only the route with next hop address
10.1.2.2 is selected as the optimal route.
Table 9-25 describes the attribute comparison of the routes learned from Switch C
and Switch D.
Table 9-25 Attribute comparison of the routes learned from Switch C and Switch
D
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
PrefVal 0 0 The same.
Local_Pref - - The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 65001 65001 The same length.
Origin IGP IGP The same.
MED 100 - The route learned
from Switch D
carries no MED
value, and
therefore, the
default value (0)
is used.
The route learned
from Switch D is
optimal.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 772
Figure 9-35 shows that the route learned from Switch D does not carry the MED
value. During route selection, BGP uses the default value (0) as the MED of the
route. Therefore, this route is selected as the optimal route. To change the route
selection result on Switch B, run the bestroute med-none-as-maximum
command on Switch B. Detailed configurations are as follows:
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 10.1.4.2 100 0 65001i
* 10.1.2.2 0 65001i
[SwitchB] display bgp routing-table 1.1.1.9
BGP local router ID : 10.1.2.1
Local AS number : 200
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.4.2 (10.1.1.2)
Route Duration: 00h08m42s
Direct Out-interface: GigabitEthernet0/0/2
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path 65001, origin igp, MED 100, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.2.2
10.1.4.2
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 16h33m10s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 65001, origin igp, pref-val 0, valid, external, pre 255, not preferred for MED
Not advertised to any peer yet
The preceding command output shows that two routes 1.1.1.9/32 are available in
the BGP routing table of Switch B. The MED of the route with the next hop
address 10.1.4.2 is 100, and the MED of the route with the next hop address
10.1.2.2 is considered as 4294967295 because it carries no MED. Therefore, the
route with the next hop address 10.1.4.2 is selected as the optimal route.
In addition, BGP selects routes in the same sequence they are received. Therefore,
the route selection result is relevant to the sequence in which the routes are
received. For example, the following three BGP routes are available on a device:
● Route A1: AS_Path { 65001 200 }, med 100, igp cost 13, internal, Router id
4.4.4.4
● Route A2: AS_Path { 65001 100 }, med 150, igp cost 11, internal, Router id
5.5.5.5
● Route B: AS_Path { 65002 300 }, med 0, igp cost 12, internal, Router id 6.6.6.6
If the compare-different-as-med (BGP) command is run, route B is the optimal
route, regardless of the sequence in which the routes are received. If the compare-
different-as-med (BGP) command is not configured, BGP does not compare the
MED values of routes learned from different ASs. The route selection is described
in the following cases:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 773
● Case 1: Route A1 is received first, followed by route B, and then route A2.
– BGP first compares route A1 and route B. The leftmost AS number in the
AS_Path of route A1 is 65001, which is different from its counterpart in
route B (65002). Therefore, BGP does not compare the MED values, and
prefers route B to route A1 because the IGP cost (12) of route B is
smaller than that of route A1 (13).
– BGP then compares route A2 and route B. The leftmost AS number in the
AS_Path of route A2 is 65001, which is different from its counterpart in
route B (65002). Therefore, BGP does not compare the MED values, and
selects route A2 as the optimal route because its IGP cost (11) is smaller
than that of route B (12).
● Case 2: Route A2 is received first, followed by route B, and then route A1.
– BGP then compares route A2 and route B. The leftmost AS number in the
AS_Path of route A2 is 65001, which is different from its counterpart in
route B (65002). Therefore, BGP does not compare the MED values and
prefers route A2 to route B because the IGP cost (11) of route A2 is
smaller than that of route B (12).
– BGP then compares route A1 and route A2. The leftmost AS number in
the AS_Path of route A1 is the same as its counterpart in route A2
(65001). In this situation, BGP selects route A1 as the optimal route
because its MED value (100) is smaller than that of route A2 (150).
● Case 3: If the deterministic-med command is run, BGP groups the routes that
are learned from different ASs but are destined for the same network
segment based on the leftmost AS number in the AS_Path, selects one
optimal route from each group, and then compares the optimal routes of all
the groups. Detailed steps are as follows:
– BGP first compares route A1 and route A2. The leftmost AS number in
the AS_Path of route A1 is the same as its counterpart in route A2
(65001). In this situation, BGP selects route A1 as the optimal route
because its MED value (100) is smaller than that of route A2 (150).
– BGP then compares route A1 and route B. The leftmost AS number in the
AS_Path of route A1 is 65001, which is different from its counterpart in
route B (65002). Therefore, BGP does not compare the MED values and
selects route B as the optimal route because the IGP cost (12) of route B
is smaller than that of route A1 (13).
Case 1 and case 2 show that the route selection result is relevant to the sequence
in which routes are received if the deterministic-med is not configured. Case 3
shows that the route selection result is irrelevant to the sequence in which routes
are received if the deterministic-med is configured.
9.2.18.9 Peer Type
When one EBGP route and multiple IBGP routes are available, BGP selects the
optimal route based on the peer type. If no EBGP route is available or multiple
EBGP routes are available, BGP is unable to select the optimal route based on the
peer type.
When multiple egress devices reside on a carrier network and receive routes from
the Internet, the egress devices select the optimal route based on the peer type in
most cases. In Figure 9-36, all devices reside in the same AS, Switch A and Switch
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 774
B function as egress devices and are IBGP peers of all devices in the AS. In
addition, Switch A and Switch B receive routes from the Internet and advertise
EBGP routes to all their IBGP peers. Therefore, Switch A and Switch B have an
IBGP route and an EBGP route, and the two routes have the same AS_Path. In this
situation, Switch A and Switch B select the EBGP route as the optimal route.
Figure 9-36 Peer type application networking
The EBGP route is selected as the optimal route, which prevents the traffic that
leaves Switch A or Switch B for the Internet from being forwarded to the other
egress device.
For more peer type-based route selection examples, see 9.2.18.4 Local_Pref.
9.2.18.10 IGP Cost
This rule helps BGP to choose the route with the smallest cost to its recursive next
hop address quickly. If the bestroute igp-metric-ignore command is configured,
BGP does not compare the IGP cost. In Figure 9-37, OSPF runs in AS 65001, an
EBGP peer relationship is established between Switch E and Switch A and between
Switch E and Switch B, and an IBGP peer relationship is established between
Switch A and Switch C, between Switch A and Switch D, between Switch B and
Switch C, and between Switch B and Switch D; Switch E is configured to import
routes (10.1.1.1/32 for example) from AS 100 to BGP.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 775
Figure 9-37 Networking diagram with IGP cost configurations
Run the display bgp routing-table [
ip-address ] command on Switch C and
Switch D to check the configurations. Switch C is used as an example.
# Display the routing table of Switch C.
[SwitchC] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.1/32 10.1.5.2 0 100 0 100i
* i 10.1.6.2 0 100 0 100i
*>i 10.1.5.0/30 10.1.3.2 0 100 0 i
*>i 10.1.6.0/30 10.1.2.2 0 100 0 i
The preceding command output shows that two routes 10.1.1.1/32 are available in
the routing table of Switch C and that Switch C selects the route learned from
Switch A.
[SwitchC] display bgp routing-table 10.1.1.1
BGP local router ID : 10.1.1.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.1/32:
From: 10.1.3.2 (10.1.1.2)
Route Duration: 00h00m44s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.5.2
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 776
Not advertised to any peer yet
BGP routing table entry information of 10.1.1.1/32:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h00m39s
Relay IP Nexthop: 10.1.1.2
Relay IP Out-Interface: GigabitEthernet0/0/1
Original nexthop: 10.1.6.2
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, IGP cost 2, not preferred
for IGP cost
Not advertised to any peer yet
The preceding command output shows that the route with next hop address
10.1.6.2 is ignored because its IGP cost is larger than that of the other route. Table
9-26 describes the attribute comparison of the routes learned from Switch A and
Switch B.
Table 9-26 Attribute comparison of the routes learned from Switch A and Switch
B.
Route Attribute Route Learned
from Switch A
Route Learned
from Switch B
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 100 100 The same length.
Origin IGP IGP The same.
MED 0 0 The same.
Peer type IBGP IBGP The same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 777
Route Attribute Route Learned
from Switch A
Route Learned
from Switch B
Comparison
IGP cost - 2 The route learned
from Switch A is
optimal.
NOTE
If a BGP route
carries no IGP cost
value, BGP
considers its IGP
cost to be 0. If no
IGP routes are
used during BGP
peer relationship
establishment or
the costs of used
IGP routes are 0,
the IGP cost is not
displayed in the
display bgp
routing-table
ip-
address command
output.
9.2.18.11 Cluster_List
An RR and its clients form a cluster. In an AS, each RR is uniquely identified by a
Cluster_ID.
Similar to an AS_Path, a Cluster_List is composed of a series of Cluster_IDs and is
generated by an RR. The Cluster_List records all the RRs through which a route
passes.
● Before an RR reflects a route between its clients or between its clients and
non-clients, the RR adds the local Cluster_ID to the leftmost position of the
Cluster_List. If a route does not carry any Cluster_List, the RR creates one for
the route.
● After the RR receives an updated route, it checks the Cluster_List of the route.
If the RR finds that its cluster ID is included in the Cluster_List, the RR discards
the route. If its cluster ID is not included in the Cluster_List, the RR adds its
cluster ID to the Cluster_List and then reflects the route.
The following example shows how Cluster_List is used in BGP route selection. In
Figure 9-38, an IBGP peer relationship is established between each two
neighboring devices in AS 65001. Switch B functions as a level-1 RR, and Switch D
is its client. Switch D functions as a level-2 RR, and Switch E is its client. Switch C
functions as an RR, and Switch E is its client. Switch E is configured to import the
route 1.1.1.9/32 to BGP.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 778
Figure 9-38 Networking diagram with Cluster_List configurations
Run the display bgp routing-table [
ip-address ] command on Switch A to check
the configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.3.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 1.1.1.9/32 10.1.5.2 0 100 0 i
* i 10.1.4.2 0 100 0 i
The preceding command output shows that two routes 1.1.1.9/32 are available in
the routing table of Switch C and that Switch A selects the route learned from
Switch C.
[SwitchA] display bgp routing-table 1.1.1.9
BGP local router ID : 10.1.3.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.3.2 (2.2.2.9)
Route Duration: 00h53m08s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet0/0/1
Original nexthop: 10.1.5.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255, IGP cost
3
Originator: 1.1.1.9
Cluster list: 0.0.0.3
Not advertised to any peer yet
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.1.2 (10.1.2.1)
Route Duration: 00h28m05s
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 779
Relay IP Nexthop: 10.1.1.2
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, IGP cost 3, not preferred
for Cluster List
Originator: 1.1.1.9
Cluster list: 0.0.0.2, 0.0.0.1
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch B is
ignored because its Cluster_List is longer than that of the route learned from
Switch C. Table 9-27 describes attribute comparison of the routes learned from
Switch B and Switch C.
Table 9-27 Attribute comparison of the routes learned from Switch B and Switch
C
Route Attribute Route Learned
from Switch B
Route Learned
from Switch C
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path - - The same length.
Origin IGP IGP The same.
MED 0 0 The same.
Peer type IBGP IBGP The same.
IGP cost 3 3 The same.
Cluster_List 0.0.0.2, 0.0.0.1 0.0.0.3 The route learned
from Switch C is
optimal.
In most cases, BGP does not advertise the routes learned from an AS to the AS
again. When RRs are deployed, such routes may be advertised to the AS again
although routing loops may occur. Using the Cluster_List attribute can prevent
such routing loops.
9.2.18.12 Originator_ID
The Originator_ID attribute is four bytes long and is generated by an RR. It carries
the router ID of the route originator in the local AS.
● When a route is reflected by an RR for the first time, the RR adds the
Originator_ID to this route. If a route already carries the Originator_ID
attribute, the RR does not create a new one.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 780
● After receiving the route, a BGP speaker checks whether the Originator_ID is
the same as its router ID. If Originator_ID is the same as its router ID, the BGP
speaker discards this route.
The following example shows how Originator_ID is used during BGP route
selection. In Figure 9-39, an IBGP peer relationship is established between each
two neighboring devices in AS 65001. The router IDs of Switch B and Switch C are
2.2.2.9 and 3.3.3.9, respectively, and they function as RRs. Switch D is a client of
Switch B, and Switch E is a client of Switch C. Switch D and Switch E are
configured to import the route 10.1.4.0/30 to BGP.
Figure 9-39 Networking diagram with Originator_ID configurations
Run the display bgp routing-table [
ip-address ] command on Switch A to check
the configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.3.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.4.0/30 10.1.5.2 0 100 0 i
* i 10.1.2.2 0 100 0 i
The preceding command output shows that two routes 10.1.4.0/30 are available in
the routing table of Switch A and that Switch A selects the route learned from
Switch C.
[SwitchA] display bgp routing-table 1.1.1.9
BGP local router ID : 10.1.3.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.3.2 (3.3.3.9)
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 781
Route Duration: 00h00m01s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet0/0/1
Original nexthop: 10.1.5.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, pre 255, IGP cost 2
Originator: 10.1.4.1
Cluster list: 0.0.0.3
Not advertised to any peer yet
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.1.2 (2.2.2.9)
Route Duration: 00h00m17s
Relay IP Nexthop: 10.1.1.2
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, IGP cost 2, not preferred
for router ID
Originator: 10.1.4.2
Cluster list: 0.0.0.2
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch B is not
selected due to a router ID issue. In fact, the router ID of Switch B is 2.2.2.9,
smaller than that (3.3.3.9) of Switch C. The route learned from Switch B should be
selected if the router IDs are used to determine the optimal route. However, the
routes carry Originator_ID attributes. In this situation, the Originator_ID attributes
(rather than router IDs) are compared. Switch A selects the route learned from
Switch C because its Originator_ID (10.1.4.1) is smaller than that (10.1.4.2) of the
route learned from Switch B.
Table 9-28 describes the attribute comparison of the routes learned from Switch B
and Switch C.
Table 9-28 Attribute comparison of the routes learned from Switch B and Switch
C
Route Attribute Route Learned
from Switch B
Route Learned
from Switch C
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path - - The same length.
Origin IGP IGP The same.
MED 0 0 The same.
Peer type IBGP IBGP The same.
IGP cost 2 2 The same.
Cluster_List 0.0.0.2 0.0.0.3 The same length.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 782
Route Attribute Route Learned
from Switch B
Route Learned
from Switch C
Comparison
Originator_ID 10.1.4.2 10.1.4.1 The route learned
from Switch C is
optimal.
If routes carry Originator_ID attributes, the Originator_ID attributes (rather than
router IDs) are compared.
9.2.18.13 BGP Router ID
A router ID uniquely identifies a router in an AS, and the router ID can be
configured as follows:
● Run the router-id(BGP) {
ipv4-address | vpn-instance auto-select }
command. If no router ID is configured in the BGP view, BGP selects the
global router ID. For details on how a global router ID is selected, see router-
id.
● Run the router-id (BGP-VPN Instance IPv4 Address Family View) {
ipv4-
address | auto-select } command in the BGP VPN instance IPv4 address
family view. The router-id (BGP-VPN Instance IPv4 Address Family View)
command takes precedence over the router-id(BGP) command.
If each route carries an Originator_ID, the Originator_IDs rather than router IDs
are compared during route selection. The route with the smallest Originator_ID is
preferred. By default, Cluster_List takes precedence over Originator_ID during BGP
route selection. To enable Originator_ID to take precedence over Cluster_List
during BGP route selection, run the bestroute router id-prior-clusterlist
command.
For more router ID-based route selection examples, see 9.2.18.4 Local_Pref,
9.2.18.7 Origin, and 9.2.18.8 MED.
9.2.18.14 Peer IP Address
The peer IP address is the IP address specified in
ipv4-address or
ipv6-address in
the peer {
group-name |
ipv4-address |
ipv6-address } as-number {
as-number-
plain |
as-number-dot } command. The
group-name parameter specified in the
command is the one specified in the peer {
ipv4-address |
ipv6-address } group
group-name command.
If the optimal route has not been selected yet before BGP begins to compare peer
IP addresses, the local device may have established multiple BGP peer
relationships with another device through equal-cost links. In most cases, if a
backup physical link is available between two devices, using loopback interfaces to
establish a BGP peer relationship is recommended although multiple BGP peer
relationships may be established between the two devices through the physical
links.
In Figure 9-40, two physical links are available between Switch A and Switch B.
Switch A and Switch B can use loopback interfaces to establish a BGP peer
relationship or use the two links to establish two BGP peer relationships. In the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 783
following example, the two links are used to establish two BGP peer relationships
to show how peer addresses are used in route selection.
Figure 9-40 Networking in which two links are used to establish two BGP peer
relationships
The configurations on Switch A are as follows:
#
bgp 65001
peer 10.1.1.2 as-number 65002
peer 10.1.2.2 as-number 65002
#
ipv4-family unicast
peer 10.1.1.2 enable
peer 10.1.2.2 enable
#
The configurations on Switch B are as follows:
#
bgp 65002
peer 10.1.1.1 as-number 65001
peer 10.1.2.1 as-number 65001
#
ipv4-family unicast
network 2.2.2.9 255.255.255.255
peer 10.1.1.1 enable
peer 10.1.2.1 enable
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 2.2.2.9/32 10.1.1.2 0 0 65002i
* 10.1.2.2 0 0 65002i
The preceding command output shows that two routes 2.2.2.9/32 are available in
the routing table and that the route with the next hop address 10.1.1.2 is selected
as the optimal route.
[SwitchA] display bgp routing-table 2.2.2.9
BGP local router ID : 192.168.2.3
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 784
BGP routing table entry information of 2.2.2.9/32:
From: 10.1.1.2 (192.168.2.4)
Route Duration: 00h19m10s
Direct Out-interface: GigabitEthernet1/0/5
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path 65002, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.1.2
10.1.2.2
BGP routing table entry information of 2.2.2.9/32:
From: 10.1.2.2 (192.168.2.4)
Route Duration: 00h19m05s
Direct Out-interface: GigabitEthernet1/0/10
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 65002, origin igp, MED 0, pref-val 0, valid, external, pre 255, not preferred for peer address
Not advertised to any peer yet
The preceding command output shows that the route with the next hop address
10.1.1.2 is selected as the optimal route because its peer IP address is smaller than
that of the other route.
9.3 Summary of BGP Configuration Tasks
Table 9-29 describes the BGP configuration tasks.
NOTE
If BGP is configured on an IPv6 network, all the peer addresses specified in the peer
command must be IPv6 addresses.
Table 9-29 BGP configuration tasks
Scenario Description Task
Configuring basic BGP
functions
The configuration of
basic BGP functions is
the foundation of the
BGP network
construction and the
precondition for other
BGP functions.
9.6 Configuring Basic
BGP Functions
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 785
Scenario Description Task
Configuring BGP security On BGP networks,
unauthorized users can
attack the BGP network
by modifying data
packets or forging
authorized users. To
ensure security of
services carried on BGP
networks, configure BGP
MD5 authentication, BGP
keychain authentication,
or Generalized TTL
Security Mechanism
(GTSM) function.
9.7 Configuring BGP
Security
Simplifying IBGP
network connections
Because routes received
from an IBGP peer will
not be sent to other
IBGP peers, fully-meshed
connections must be
established on the IBGP
network. However, when
there are many devices,
peer configuration is very
complex on the fully-
meshed IBGP network,
and the consumption of
network resources and
device CPU resources will
increase. To reduce the
number of IBGP network
connections and better
plan the network,
configure the route
reflector and
confederation.
9.8 Simplifying IBGP
Network Connections
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 786
Scenario Description Task
Configuring BGP route
selection and load
balancing
In a BGP routing table,
there may be multiple
routes to the same
destination. To guide
route selection, BGP
defines next-hop policies
and route selection rules.
The priority of next-hop
policies is higher than
that of BGP route
selection rules. After the
next-hop policies are
performed, BGP selects
routes according to the
route selection rules.
Usually there are
multiple valid routes to
the same destination on
the network. If BGP only
advertises the optimal
route to its peer,
unbalanced traffic on
different routes will
occur. The BGP load-
balancing configuration
can balance load on
different routes and
reduce network
congestion.
9.9 Configuring BGP
Route Selection and
Load Balancing
Controlling the
advertising and receiving
of BGP routes
With the expansion of
the network scale, the
sharp increase of routing
tables leads to greater
load on networks and
increasing network
security problems. To
solve this problem, filter
routes according to the
routing policies and only
send and receive
required BGP routes. In
addition, multiple routes
to the same destination
may exist. If these routes
need to pass through
different ASs, direct
service traffic to specific
ASs or filter the routes to
be advertised.
9.10 Controlling the
Receiving and
Advertisement of BGP
Routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 787
Scenario Description Task
Adjusting the BGP
network convergence
speed
To enable BGP to rapidly
detect network changes,
speed up the BGP
network convergence. To
minimize the effect on
networks from route
flapping and reduce load
on the device, slow down
the BGP network
convergence.
9.11 Adjusting the BGP
Network Convergence
Speed
Configuring BGP
reliability
To avoid long service
interruption when faults
occur on BGP networks,
adopt the solution of
standby link. However,
the BGP mechanism
requires more than 1
second to detect the
faults and perform an
active/standby
switchover. To ensure
that users of delay-
sensitive services such as
the voice service do not
detect the service
interruption, associate
BGP tracking, BGP, and
BFD to implement fast
fault detection, and use
BGP GR to perform a
fast switchover after the
fault detection.
9.12 Configuring BGP
Reliability
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 788
Scenario Description Task
Configuring BGP route
summarization
The BGP routing table on
a medium or large BGP
network contains a large
number of routing
entries. Storing the
routing table consumes a
lot of memory, and
transmitting and
processing the routing
information consumes a
lot of network resources.
Route summarization
can reduce the size of a
routing table, prevent
specific routes from
being advertised, and
minimize the impact of
route flapping on
networks. Although BGP
automatic route
summarization is easy to
configure, it only
summarizes routes
according to the natural
network segment. BGP
manual route
summarization can be
used with flexible
routing policies to enable
BGP to effectively
transmit and control
routes.
9.13 Configuring BGP
Route Summarization
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 789
Scenario Description Task
Configuring BGP to
advertise default routes
to peers
The BGP routing table on
a medium or large BGP
network contains a large
number of routing
entries. Storing the
routing table consumes a
large number of memory
resources, and
transmitting and
processing the routing
information consumes a
large number of network
resources. If multiple
routes in a peer BGP
routing table are sent
only from a local device,
configure the local
device to send a default
route to its peer. In this
case, the local device will
send a default route with
the next-hop address as
the local address to its
peer, regardless of
whether there is a
default route in the local
routing table. After the
local device is configured
to send only the default
route to its peer using
the routing policies, the
number of network
routes is greatly reduced
and the peer and
network memory
resources are greatly
saved.
9.14 Configuring BGP to
Advertise Default
Routes to Peers
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 790
Scenario Description Task
Configuring MP-BGP Traditional BGP-4 only
manages IPv4 unicast
routing information and
does not support route
transmission between
ASs of other networks
such as multicast
networks. To support
multiple types of
network layer protocols,
the Internet Engineering
Task Force (IETF)
extends BGP-4 to
Multiprotocol Extensions
for BGP-4 (MP-BGP)
defined in RFC 4760. MP-
BGP is called Multicast
BGP (MBGP) on
multicast networks.
9.15 Configuring MP-
BGP
9.4 Licensing Requirements and Limitations for BGP
Involved Network Elements
Other network elements are required to support BGP.
Licensing Requirements
The BGP4/BGP4+ feature is a basic feature of a switch and is not under license
control.
Feature Support in V200R024C00
Only the following switch models support BGP:
S5720I-SI, S500, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S,
S5731S-H, S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S,
and S6730S-S
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 791
Feature Limitations
None.
9.5 Default Settings for BGP
Table 9-30 describes the default settings for BGP.
Table 9-30 Default settings for BGP
Parameter Default Setting
BGP Disabled
Keepalive message interval 60s
Hold time 180s
9.6 Configuring Basic BGP Functions
Pre-configuration Tasks
Before configuring basic BGP functions, configure IP addresses for interfaces to
ensure network-layer communication between neighbor nodes.
Configuration Procedure
Perform the following operations in sequence and as required.
9.6.1 Starting a BGP Process
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
BGP is started, the local AS number is specified, and the BGP view is displayed.
NOTICE
After BGP peers are configured, changing the router ID of a BGP peer resets BGP
peer relationships.
Step 3 Run router-id
ipv4-address
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 792
A router ID is set.
NOTE
By default, BGP automatically selects the global router ID. If the IP address of a physical
interface is used as the router ID, route flapping occurs when the IP address of the physical
interface changes. To enhance network stability, configuring the address of a loopback
interface as the router ID is recommended. For router ID selection rules in the system view,
see descriptions in Command Reference about the router-id command.
----End
9.6.2 Configuring BGP Peers
Context
During the configuration of BGP peers, if the AS number of the specified peer is
the same as the local AS number, an IBGP peer is configured. If the AS number of
the specified peer is different from the local AS number, an EBGP peer is
configured. To enhance the stability of BGP connections, you are advised to use
the reachable loopback interface addresses to establish BGP connections.
When loopback interface addresses are used to establish a BGP connection, run
the peer connect-interface command on both ends of the BGP connection to
ensure the correctness of interfaces and addresses on the TCP connection. If the
command is run on only one end, the BGP connection may fail to be established.
When loopback interface addresses are used to establish an EBGP connection, the
peer ebgp-max-hop command with
hop-count greater than or equal to 2 must
be run. Otherwise, the EBGP connection cannot be established.
To perform the same configuration on a large number of peers, configure a BGP
peer group according to 9.6.3 (Optional) Configuring a BGP Peer Group to
reduce the configuration workload.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run peer {
ipv4-address |
ipv6-address } as-number {
as-number-plain |
as-
number-dot }
The BGP peer is created.
By default, no BGP peer is created.
Step 4 (Optional) Run peer
ipv4-address connect-interface
interface-type interface-
number [
ipv4-source-address ]
Or run peer
ipv6-address connect-interface
interface-type interface-number
[
ipv6-source-address ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 793
A source interface and a source IP address are specified for the peer to establish a
TCP connection.
By default, BGP uses the interface that is directly connected to the peer to
establish a TCP connection.
Step 5 (Optional) Run peer {
ipv4-address |
ipv6-address } ebgp-max-hop [
hop-count ]
The maximum number of hops allowed for the establishment of an EBGP
connection is set.
By default, the maximum number of hops allowed for an EBGP connection is 1.
That is, an EBGP connection must be established on a directly connected physical
link.
If a one-hop EBGP peer relationship is established using loopback interface
addresses, you can also run the peer connected-check-ignore command to
establish an EBGP peer relationship.
Step 6 (Optional) Run peer {
ipv4-address |
ipv6-address } description
description-text
The description of the peer is configured.
NOTE
If a BGP peer is configured on an IPv4 unicast network, steps 7 and 8 are not required. If a
BGP peer is configured on an IPv4 multicast network and an IPv6 unicast network, steps 7
and 8 are required.
Step 7 (Optional) Run the following commands as required.
● Run ipv4-family multicast
The BGP-IPv4 multicast address family view is displayed.
● Run ipv6-family [ unicast ]
The BGP-IPv6 unicast address family view is displayed.
Step 8 (Optional) Run peer {
ipv4-address |
ipv6-address } enable
MP-BGP is enabled on the BGP peers to configure them as MP-BGP peers.
----End
9.6.3 (Optional) Configuring a BGP Peer Group
Context
A large BGP network has a large number of peers. It is difficult to configure and
maintain these peers. You can add the BGP peers with the same configurations to
a BGP peer group and then configure the BGP peers in batches. This simplifies
peer management and improves route advertisement efficiency.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 794
NOTE
● If a function is configured on a peer and its peer group, the function configured on the peer
takes precedence over that configured on the peer group.
● When loopback interface addresses are used to establish a BGP connection, you are advised
to perform step 6 on the both ends of the BGP connection simultaneously to ensure the
correct establishment of the connection. If step 6 is performed on only one end, the BGP
connection may fail to be established.
● When loopback interfaces are used to establish an EBGP connection, step 7 is required and
hop-count in the
peer ebgp-max-hop command must be greater than or equal to 2.
Otherwise, the EBGP connection cannot be established.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run group
group-name [ external | internal ]
A BGP peer group is created.
NOTE
The AS number of an IBGP peer group is the local AS number. Therefore, step 4 is not
required.
Step 4 Run peer
group-name as-number {
as-number-plain |
as-number-dot }
An AS number is configured for the EBGP peer group.
NOTE
To add an EBGP peer to a peer group, configure the EBGP peer according to 9.6.2
Configuring BGP Peers and then perform step 5.
To add an IBGP peer to a peer group, perform step 5. The system creates an IBGP peer in
the BGP view and sets its AS number as the AS number of the peer group.
Step 5 Run peer {
ipv4-address |
ipv6-address } group
group-name
A peer is added to the peer group.
NOTE
You can repeat step 5 to add multiple peers to a peer group.
Step 6 (Optional) Run peer
group-name connect-interface
interface-type interface-
number [
ipv4-source-address ] or peer
group-name connect-interface
interface-
type interface-number [
ipv6-source-address ]
A source interface and a source IP address are specified for the peer to establish a
TCP connection.
By default, the outbound interface of a BGP packet serves as the source interface
of a BGP packet.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 795
NOTE
The configurations of GTSM and EBGP-MAX-HOP affect the TTL values of BGP packets,
which may cause a conflict between TTL values. Therefore, you can configure only one of
the two functions for a peer or peer group.
Step 7 (Optional) Run peer
group-name ebgp-max-hop [
hop-count ]
The maximum number of hops allowed for the establishment of an EBGP
connection is set.
By default, the maximum number of hops allowed for an EBGP connection is 1.
That is, an EBGP connection must be established on a directly connected physical
link.
If a one-hop EBGP peer relationship is established using loopback interface
addresses, you can also run the peer connected-check-ignore command to
establish an EBGP peer relationship.
Step 8 (Optional) Run peer
group-name description
description-text
The description is configured for the peer group.
NOTE
If you want to configure an IPv4 peer group in the BGP-IPv4 unicast address family view,
skip steps 9, 10, and 11. To configure a BGP peer group in another address family view,
perform steps 9, 10, and 11.
Step 9 Enter the required address family view based on the actual network. The following
example uses the BGP-IPv6 unicast address family view.
Run ipv6-family [ unicast ]
The BGP-IPv6 unicast address family view is displayed.
Step 10 Run peer
group-name enable
The switch is enabled to exchange routing information with the specified peer or
peer group in the address family view.
Step 11 Run peer {
ipv4-address |
ipv6-address } group
group-name
The specified peer is added to the peer group.
----End
9.6.4 (Optional) Configuring Dynamic BGP Peers
Context
If static BGP peers change frequently, the local device needs to add or delete BGP
peer configurations in response to each change, which requires a heavy
maintenance workload. To address this problem, configure the dynamic BGP peer
function, which allows BGP to listen to BGP connection requests from a specified
network segment, establish BGP peer relationships dynamically, and add the peers
to a peer group. This spares the local device from adding or deleting BGP peer
configurations in response to each change in the peer number, which reduces the
maintenance workload.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 796
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 (Optional) Run bgp dynamic-session-limit
limit-value
The maximum number of dynamic BGP peer sessions is configured.
By default, a maximum of 100 dynamic BGP peer sessions can be established after
the dynamic BGP peer function is enabled.
Step 4 (Optional) Run ipv4-family vpn-instance
vpn-instance-name
The BGP-VPN instance IPv4 address family view is displayed.
Perform this step if you need to configure the dynamic BGP peer function in the
BGP-VPN instance IPv4 address family view in a BGP/MPLS IP VPN scenario.
Step 5 Run group
group-name [ external | internal ]
A BGP peer group is created.
● If the local device and its peers reside in the same AS, configure internal to
create an IBGP peer group.
● If the local device and its peers reside in different ASs, configure external to
create an EBGP peer group.
Step 6 Run peer
group-name listen-net
network {
mask |
mask-length }
BGP is configured to listen to BGP connection requests from a specified network
segment and establish BGP peer relationships dynamically.
If you run the command multiple times, BGP listens to BGP connection requests
from multiple network segments.
Step 7 Run peer
group-name as-number {
as-number-plain |
as-number-dot }
[ optional-as {
optional-as-number-plain |
optional-as-number-dot } &<1-5> ]
An AS number is configured for the peer group.
● If the dynamic peers in the peer group reside in the same AS, configure {
as-
number-plain |
as-number-dot } to set a fixed AS number.
● If the dynamic peers in the peer group may reside in different ASs, in addition
to a fixed AS number, you need to configure optional-as {
optional-as-
number-plain |
optional-as-number-dot } &<1-5> to set an optional AS
number. A maximum of five optional AS numbers can be set.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 797
9.6.5 Configuring BGP to Import Routes
Context
BGP cannot discover routes and needs to import routes such as IGP routes into
BGP routing tables so that the imported routes can be transmitted within an AS or
between ASs. BGP imports routes in either import or network mode:
● In import mode, BGP imports IGP routes, including RIP, OSPF, and IS-IS routes,
into BGP routing tables based on protocol type. To ensure the validity of
imported IGP routes, BGP can also import static routes and direct routes in
import mode.
● In network mode, BGP imports the routes in the IP routing table one by one
into BGP routing tables. The network mode is more accurate than the import
mode.
Procedure
● In import mode
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Run import-route
protocol [
process-id ] [ med
med | route-policy
route-policy-name ] *
BGP is configured to import routes of other routing protocols.
e. (Optional) Run default-route imported
BGP is allowed to import default routes from the local IP routing table.
To import default routes, you need to run both the default-route
imported command and the import-route (BGP) command. If only the
import-route (BGP) command is used, default routes cannot be
imported. In addition, the default-route imported command is used to
import only the default routes that exist in the local routing table.
By default, BGP does not add default routes to BGP routing tables.
● In network mode
a. Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 798
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Run network
ipv4-address [
mask |
mask-length ] [ route-policy
route-
policy-name ]
Or run network
ipv6-address prefix-length [ route-policy
route-policy-
name ]
BGP is configured to import routes from the IPv4 or IPv6 routing table
one by one.
----End
9.6.6 Verifying the Basic BGP Function Configuration
Procedure
● Run the display bgp peer [ verbose ] command to check information about
all BGP peers.
● Run the display bgp peer
ipv4-address { log-info | verbose } command to
check information about the specified BGP peer.
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check BGP routing information.
● Run the display bgp group [
group-name ] command to check information
about the specified BGP peer group.
● Run the display bgp multicast peer [ [
peer-address ] verbose ] command to
check information about the specified MBGP peer.
● Run the display bgp multicast group [
group-name ] command to check
information about an MBGP peer group.
● Run the display bgp multicast network command to check the routing
information that MBGP advertises.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check the
MBGP routing table.
----End
9.7 Configuring BGP Security
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 799
Pre-configuration Tasks
Before configuring BGP security, configure basic BGP functions.
Configuration Procedure
You can perform the following configuration tasks as required. The following
configuration tasks (excluding the task of Verifying the BGP Security
Configuration) can be performed in any sequence.
9.7.1 Configuring MD5 Authentication
Context
BGP uses TCP as the transmission protocol, and considers a packet valid as long as
the source address, destination address, source port, destination port, and TCP
sequence number of the packet are correct. However, most parameters in a packet
may be easily obtained by attackers. To protect BGP from attacks, use MD5
authentication or keychain authentication between BGP peers to reduce the
possibility of attacks. The MD5 algorithm is easy to configure and generates a
single password that can only be manually changed.
NOTICE
If simple is selected during the configuration of the MD5 authentication
password, the password is saved in the configuration file in plain text. This brings
security risks. It is recommended that you select cipher to save the password in
cipher text. MD5 authentication has potential security risks.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run peer {
ipv4-address |
group-name |
ipv6-address } password { cipher
cipher-
password | simple
simple-password }
The MD5 authentication password is set.
NOTE
● To prevent the MD5 password set on BGP peers from being decrypted, update the MD5
password periodically.
● BGP MD5 authentication and BGP keychain authentication are mutually exclusive, and
only either of them can be configured for a BGP peer.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 800
9.7.2 Configuring Keychain Authentication
Context
BGP uses TCP as the transmission protocol, and considers a packet valid as long as
the source address, destination address, source port, destination port, and TCP
sequence number of the packet are correct. However, most parameters in a packet
may be easily obtained by attackers. To protect BGP from attacks, use MD5
authentication or keychain authentication between BGP peers to reduce the
possibility of attacks. The keychain algorithm is complex to configure and
generates a set of passwords. Keychain authentication allows automatically
changing a password based on the configuration. Therefore, keychain
authentication applies to networks requiring high security.
NOTE
Before configuring BGP keychain authentication, configure a keychain corresponding to
keychain-name. Otherwise, the TCP connection cannot be established. For details about
configuring a keychain, see Keychain Configuration in the
S300, S500, S2700, S5700, and
S6700 V200R024C00 Configuration Guide - Security.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run peer {
ipv4-address |
group-name |
ipv6-address } keychain
keychain-name
Keychain authentication is configured.
NOTE
● You must configure keychain authentication on both ends of the BGP connection.
Encryption algorithms and passwords configured on both ends must be the same;
otherwise, the TCP connection cannot be established between BGP peers and BGP
messages cannot be transmitted. SHA256 and HMAC-SHA256 encryption algorithms are
recommended in keychain authentication.
● BGP MD5 authentication and BGP keychain authentication are mutually exclusive, and
only either of them can be configured for a BGP peer.
● Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support keychain
keychain-name.
----End
9.7.3 Configuring BGP GTSM
Context
To protect a device against the attacks of forged BGP packets, you can configure
GTSM to check whether the TTL value in the IP packet header is within the
specified range. GTSM allows or discards packets with TTL values outside of the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 801
specified range according to networking requirements. When the default action to
be taken on packets is set to drop in GTSM, set a proper TTL range according to
the network topology. Then packets with TTL values outside of the specified range
are discarded. This prevents attackers from sending forged BGP packets to
consume CPU resources.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
NOTE
The configurations of GTSM and peer ebgp-max-hop affect the TTL values of BGP packets,
which may cause a conflict between TTL values. Therefore, you can configure only either of
the two functions for a peer or peer group.
Step 3 Run peer {
group-name |
ipv4-address |
ipv6-address } valid-ttl-hops [
hops ]
BGP GTSM is configured.
By default, GTSM is not configured on any BGP peer or peer group.
Step 4 (Optional) Run the gtsm default-action { drop | pass } command in the system
view:
The default action to be taken on the packets that do not match a GTSM policy is
set.
By default, the action to be taken on the packets that do not match the GTSM
policy is pass.
Step 5 (Optional) Run the gtsm log drop-packet all command in the system view:
The function of recording logs about discarded GTSM packet is enabled on the
device.
The logs help locate faults.
----End
9.7.4 Verifying the BGP Security Configuration
Procedure
● Run the display bgp peer verbose command to check detailed authentication
information about the specified BGP peer.
----End
9.8 Simplifying IBGP Network Connections
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 802
Pre-configuration Tasks
Before simplifying IBGP network connections, configure basic BGP functions.
Configuration Procedure
Perform the following configuration tasks in any sequence as required.
9.8.1 Configuring a BGP Route Reflector
Context
To ensure the connectivity between IBGP peers within an AS, you need to establish
full-mesh connections between the IBGP peers. When there are many IBGP peers,
it is costly to establish a fully-meshed network. A route reflector (RR) can solve
this problem.
A cluster ID can help prevent routing loops between multiple RRs within a cluster
and between clusters. When a cluster has multiple RRs, the same cluster ID must
be configured for all the RRs within the cluster.
If full-mesh IBGP connections are established between clients of multiple RRs,
route reflection between clients is not required and wastes bandwidth resources.
In this case, prohibit route reflection between clients to reduce the network
burden.
Within an AS, an RR transmits routing information and forwards traffic. When an
RR connects to a large number of clients and non-clients, many CPU resources are
consumed if the RR transmits routing information and forwards traffic
simultaneously. This also reduces route transmission efficiency. To improve route
transmission efficiency, prohibit BGP from adding preferred routes to IP routing
tables on the RR to enable the RR only to transmit routing information.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
BGP is enabled and the BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family unicast
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run peer {
group-name |
ipv4-address |
ipv6-address } reflect-client
An RR and its client are configured.
By default, the route reflector and its client are not configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 803
Step 5 (Optional) Run reflector cluster-id
cluster-id
A cluster ID is configured for the RR.
By default, each RR uses its router ID as the cluster ID.
Step 6 (Optional) Run undo reflect between-clients
Route reflection is prohibited between clients.
By default, route reflection is allowed between clients.
Step 7 (Optional) Run routing-table rib-only [ route-policy
route-policy-name ]
BGP is prohibited from adding preferred routes to IP routing tables.
By default, BGP adds preferred routes to IP routing tables.
----End
Verifying the Configuration
● Run the display bgp group [
group-name ] command to check information
about the specified BGP peer group.
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check routing information in a BGP
routing table.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check the
MBGP routing table.
9.8.2 Configuring a BGP Confederation
Context
A confederation divides an AS into sub-ASs. Within each sub-AS, IBGP peers
establish full-mesh connections or have an RR configured. Sub-ASs establish EBGP
connections. On a large BGP network, configuring a confederation can reduce the
number of IBGP connections, simplify routing policy management, and improve
route advertisement efficiency.
Other devices may implement the confederation not in accordance with RFC 3065.
You can configure confederation compatibility to make standard devices
compatible with nonstandard devices.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
BGP is enabled and the BGP view is displayed.
Step 3 Run confederation id {
as-number-plain |
as-number-dot }
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 804
A confederation ID is configured.
By default, no BGP confederation is configured.
NOTICE
An old speaker that has a 2-byte AS number cannot be in the same confederation
with a new speaker that has a 4-byte AS number. Otherwise, a routing loop may
occur. This is because the AS4_Path attribute does not support confederations.
Step 4 Run confederation peer-as {
as-number-plain |
as-number-dot } &<1-32>
A sub-AS number is configured for a confederation.
By default, no sub-AS number of the confederation is configured.
Step 5 (Optional) Run confederation nonstandard
Confederation compatibility is configured.
By default, confederations comply with RFC 3065.
----End
Verifying the Configuration
● Run the display bgp peer [
ipv4-address ] verbose command to check
detailed information about BGP peers.
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check routing information in a BGP
routing table.
9.9 Configuring BGP Route Selection and Load
Balancing
Pre-configuration Tasks
Before configuring BGP route attributes, configure basic BGP functions.
Configuration Procedure
Perform the following configuration tasks as required. The following configuration
tasks (excluding the task of Verifying the BGP Route Selection and Load Balancing
Configuration) can be performed in any sequence. For detailed route selection
rules, see 9.2.5 BGP Route Selection Rules and Load Balancing.
9.9.1 Configuring the BGP Priority
Context
The routing protocols may share and select routing information because switches
may run multiple dynamic routing protocols at the same time. The system sets a
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 805
default priority for each routing protocol. When multiple routing protocols are
used to select routes, the route selected by the routing protocol with a higher
priority takes effect.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run preference {
external internal local | route-policy
route-policy-name }
Or run preference
external internal local route-policy
route-policy-name
The BGP priority is set.
The default BGP priority is 255.
The smaller the preference value, the higher the preference.
BGP has the following types of routes:
● EBGP routes learned from peers in other ASs
● IBGP routes learned from peers in the same AS
● Locally originated routes (A locally originated route is a route summarized by
using the summary automatic command or the aggregate command.)
Different preference values can be set for these three types of routes.
In addition, a routing policy can also be used to set the preferences for the routes
that match the policy. The routes that do not match the policy use the default
preference.
NOTE
You cannot use the peer route-policy command on BGP peers to apply routing policies to
set the BGP priority.
----End
9.9.2 Configuring the Next_Hop Attribute
Context
When an Autonomous System Boundary Router (ASBR) forwards the route
learned from an EBGP peer to an IBGP peer, the ASBR does not change the next
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 806
hop of the route by default. When the IBGP peer receives this route, it finds the
next hop unreachable, sets the route to inactive, and does not use this route to
guide traffic forwarding. To enable the IBGP peer to use this route to guide traffic
forwarding, configure the ASBR to set its IP address as the next hop of the route
when the ASBR forwards this route to the IBGP peer. After the IBGP peer receives
the route from the ASBR, it finds the next hop of the route reachable, sets the
route to active, and uses this route to guide traffic forwarding.
When a BGP route changes, BGP needs to recurse the indirect next hop of the
route again. If no restriction is imposed on the recursed route, BGP may recurse
the next hop to an incorrect forwarding path, causing traffic loss. To prevent traffic
loss, configure routing policy-based route recursion.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Perform any of the following operations as required:
● Run peer {
ipv4-address |
group-name |
ipv6-address } next-hop-local
A BGP device is configured to set its IP address as the next hop when the
device advertises routes to an IBGP peer or an IBGP peer group.
By default, a BGP device does not change the next-hop address when
advertising routes to its IBGP peers.
● Run nexthop recursive-lookup route-policy
route-policy-name
BGP is configured to recurse the next hop based on a routing policy.
BGP does not recurse the next hop based on a routing policy.
● Run the peer {
ipv4-address |
group-name } next-hop-invariable command
in the IPv4 unicast address family view:
The device is prevented from changing the next-hop address of a route
imported from an IGP before advertising the route to an IBGP peer.
By default, a device changes the next-hop address of a route imported from
an IGP to the address of the interface connecting the device to its peer when
advertising the route to an IBGP peer.
NOTE
The nexthop recursive-lookup route-policy
route-policy-name command does not take
effect for the routes received from directly connected EBGP peers.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 807
9.9.3 Configuring the PrefVal Attribute
Context
The PrefVal attribute is a Huawei proprietary attribute and is valid only on the device where
it is configured. When a BGP routing table contains multiple routes to the same
destination, BGP prefers the route with the highest PrefVal.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run peer {
group-name |
ipv4-address |
ipv6-address } preferred-value
value
The PrefVal attribute is configured for all the routes learned from a specified peer.
By default, the PrefVal of a route learned from a peer is 0.
----End
9.9.4 Configuring the Default Local_Pref Attribute
Context
The Local_Pref attribute is used to determine the optimal route for outgoing traffic
of an AS. When a BGP device obtains multiple routes to the same destination
address but with different next hops from different IBGP peers, the BGP device
prefers the route with the highest Local_Pref value.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 808
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run default local-preference
local-preference
The default Local_Pref attribute is configured.
By default, the Local_Pref attribute is 100.
----End
9.9.5 Configuring the AS_Path Attribute
Context
The AS_Path attribute records all of the ASs that a route passes through from the
source to the destination in the vector order. You can configure the AS_Path
attribute to implement flexible route selection.
● Generally, BGP compares the AS_Path lists of routes and prefers the route
with the shortest AS_Path list. When the AS_Path attribute is not required in
route selection, configure BGP not to compare the AS_Path lists of routes
during route selection.
● In most cases, BGP detects routing loops based on the AS number. However,
to ensure correct route transmission on a hub-and-spoke network, you need
to configure all the BGP peers that VPN routes advertised from a hub CE to a
spoke CE pass through to accept the routes with a repeated AS number.
● Public AS numbers can be used on the Internet, but not private AS numbers
because they may cause routing loops. To prevent routing loops, configure the
AS_Path attribute to carry only public AS numbers in EBGP Update messages.
● When the AS_Path attribute is reconstructed or summarized routes are
generated, you can set the maximum number of AS numbers in the AS_Path
attribute. Then a BGP device checks whether the number of AS numbers in
the AS_Path attribute of a route exceeds the maximum value. If so, the BGP
device discards the route.
● A device usually supports only one BGP process. This indicates that a device
supports only one AS number. In some cases, for example, when network
migration changes an AS number, you can set a fake AS number to ensure
successful network migration.
● BGP checks the first AS number in the AS_Path list that is carried in the
Update message sent by an EBGP peer. If the first AS number specifies the AS
where the EBGP peer resides, BGP accepts the Update message. Otherwise,
BGP rejects the Update message and interrupts the EBGP connection. If you
do not want BGP to check the first AS number, disable the option.
Procedure
Step 1 Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 809
Step 2 Run route-policy
route-policy-name { deny | permit } node
node
A node is configured for a route-policy, and the view of the route-policy is
displayed.
Step 3 (Optional) Configure matching rules for the route-policy to change only the
community attributes of the routes that meet the matching rules.
By default, all routes meet matching rules. For details, see 10.6.2 (Optional)
Configuring an if-match Clause.
Step 4 Run apply as-path {
as-number-plain |
as-number-dot } &<1-10> { additive |
overwrite }
The AS_Path attribute is set for BGP routes.
Step 5 Run quit
Return to the system view.
Step 6 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 7 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 8 Add the AS_Path attribute to routes.
● Run peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-
policy-name export
The AS_Path attribute is added to the routes advertised to BGP peers or peer
groups.
● Run peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-
policy-name import
The AS_Path attribute is added to the routes received from BGP peers or peer
groups.
● Run import-route
protocol [
process-id ] route-policy
route-policy-name
The AS_Path attribute is added to the routes imported by BGP in import
mode.
● Run network {
ipv4-address [
mask |
mask-length ] |
ipv6-address prefix-
length } route-policy
route-policy-name
The AS_Path attribute is added to the routes imported by BGP in network
mode.
Step 9 (Optional) Run any of the following commands to configure the AS_Path attribute
as required.
● Run bestroute as-path-ignore
BGP is configured not to compare the AS_Path attributes of routes during
route selection.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 810
By default, BGP compares the AS_Path attributes of routes during route
selection.
● Run peer {
ipv4-address |
group-name |
ipv6-address } allow-as-loop
[
number ]
Repeated local AS numbers are allowed in routes.
By default, repeated local AS numbers are not allowed.
● Run peer {
ipv4-address |
group-name |
ipv6-address } public-as-only
[ force ]
BGP is configured to carry only public AS numbers in the AS_Path attribute in
an EBGP Update message.
By default, the AS_Path attribute can carry both public and private AS
numbers in an EBGP Update message.
● Run peer {
group-name |
ipv4-address |
ipv6-address } substitute-as
AS number substitution is enabled. The device replaces the AS number of the
peer specified in the AS_Path attribute with the local AS number.
By default, AS number substitution is disabled.
NOTE
Enabling BGP AS number substitution may cause route loops in a CE multi-homing
network.
● Return to the BGP view to configure the AS_Path attribute.
a. Run quit
Return to the BGP view.
b. (Optional) Run any of the following commands to configure the AS_Path
attribute as required.
▪ Run as-path-limit
as-path-limit-num
The maximum number of AS numbers in the AS_Path attribute is set.
By default, the maximum number of AS numbers in the AS_Path
attribute is 255.
▪ Run peer {
ipv4-address |
group-name |
ipv6-address } fake-as
[ prepend-global-as ]
The peer fake-as command can be used to hide the actual AS
number of a BGP device. EBGP peers in other ASs will use the fake
AS number of this BGP device to set up EBGP peer relationships with
this device.
A fake AS number is configured for an EBGP peer group.
By default, EBGP peers establish a connection using the actual AS
number.
NOTICE
Running the undo check-first-as command increases the probability
of routing loops. Therefore, exercise caution when using this
command.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 811
▪ Run undo check-first-as
BGP is configured not to check the first AS number in the AS_Path
list that is carried in the Update message sent by an EBGP peer.
By default, BGP checks the first AS number in the AS_Path list that is
carried in the Update message sent by an EBGP peer.
NOTE
When BGP is disabled from checking the first AS number, run the refresh
bgp command in the user view if you want BGP to check the first AS
number of received routes.
----End
9.9.6 Configuring the MED Attribute
Context
The multi-exit discriminator (MED) helps determine the optimal route for
incoming traffic of an AS. It is similar to the metric used in IGP. When a BGP
device obtains multiple routes to the same destination address but with different
next hops from EBGP peers, the BGP device selects the route with the smallest
MED value as the optimal route.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Perform any of the following operations as required:
● Run default med
med
The default MED value is set.
By default, the MED is 0.
● Run bestroute med-none-as-maximum
BGP defines the MED value as the maximum value if a route does not have
the MED attribute.
By default, BGP uses the default MED value when a route does not have the
MED attribute.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 812
● Run compare-different-as-med
BGP is allowed to compare the MED values of routes received from EBGP
peers in any AS.
By default, BGP compares only the MEDs of the routes received from EBGP
peers within the same AS.
● Run deterministic-med
The deterministic-MED function is enabled.
By default, the BGP deterministic-MED function is disabled.
● Run bestroute med-confederation
The MED values of routes in a confederation are compared.
By default, BGP compares only the MEDs of the routes from the same AS.
----End
9.9.7 Configuring the BGP Community Attribute
Context
The Community attribute is a private BGP route attribute. It is transmitted
between BGP peers and is not restricted within an AS. The Community attribute
allows a group of BGP devices in multiple ASs to share the same routing policies,
which simplifies routing policy applications and facilitates routing policy
management and maintenance. A BGP device can add or change the community
attributes of routes to be advertised.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run route-policy
route-policy-name { deny | permit } node
node
A node is configured for a route-policy, and the view of the route-policy is
displayed.
Step 3 (Optional) Configure matching rules for the route-policy to change only the
community attributes of the routes that meet the matching rules.
By default, all routes meet matching rules. For details, see 10.6.2 (Optional)
Configuring an if-match Clause.
Step 4 Run either of the following commands to configure the Community attribute.
● Run apply community {
community-number |
aa:nn | internet | no-advertise
| no-export | no-export-subconfed } &<1-32> [ additive ]
Common community attributes are configured for BGP routes.
NOTE
You can run this command to configure a maximum of 32 community attributes at a
time.
● Run apply extcommunity { rt {
as-number:nn |
ipv4-address:nn } } &<1-16>
[ additive ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 813
A BGP extended community attribute (route-target) is configured.
Extended community attributes are extensions to community attributes in
services. Currently, only the route-target attribute is supported in VPN.
Step 5 Run quit
Return to the system view.
Step 6 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 7 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 8 Add the Community attribute to routes.
● Run peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-
policy-name export
The Community attribute is added to the routes advertised to BGP peers or
peer groups.
● Run peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-
policy-name import
The Community attribute is added to the routes received from BGP peers or
peer groups.
● Run import-route
protocol [
process-id ] route-policy
route-policy-name
The Community attribute is added to the routes imported by BGP in import
mode.
● Run network {
ipv4-address [
mask |
mask-length ] |
ipv6-address prefix-
length } route-policy
route-policy-name
The Community attribute is added to the routes imported by BGP in network
mode.
NOTE
Step 9 is required only when the Community attribute needs to be added to the routes
advertised to BGP peers or peer groups.
Step 9 (Optional) Allow BGP to advertise community attributes when BGP adds
community attributes to the routes advertised to BGP peers or peer groups.
● Run peer {
ipv4-address |
group-name |
ipv6-address } advertise-community
BGP is allowed to advertise community attributes to BGP peers or peer
groups.
By default, BGP does not advertise community attributes to any peer or peer
group.
● To advertise an extended community attribute to a specified peer or peer
group, perform the following steps:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 814
a. Run the peer {
ipv4-address |
group-name |
ipv6-address } advertise-ext-
community command to advertise an extended community attribute to a
specified peer or peer group.
b. Run the ext-community-change enable command to enable the device
to change extended community attributes using a routing policy.
By default, BGP peers cannot change extended community attributes
using a route-policy; specifically, BGP peers advertise only the extended
community attributes carried in routes to a specified peer or peer group,
and the peer route-policy command cannot be used to modify the
extended community attributes.
----End
9.9.8 Configuring BGP Load Balancing
Context
On a large network, there may be multiple valid BGP routes to the same
destination. A switch will select and add the optimal BGP route to its routing table
for traffic forwarding and advertises this route to its peers. This, however, will
result in uneven load balancing of much traffic. Configuring BGP load balancing
can enable the switch to add these multiple equal-cost BGP routes to its routing
table, implementing traffic load balancing and reducing network congestion. After
BGP load balancing is configured, the switch will still select the optimal route
among the multiple routes and advertise only this route to its peers.
Equal-cost BGP routes can be generated for traffic load balancing only when the
first eight route attributes described in "BGP Route Selection Policies" are the
same. Change load balancing rules by adjusting some configurations, for example,
ignoring the comparison of the AS_Path attribute. When adjusting these
configurations, ensure that these configurations do not result in routing loops.
NOTE
If BGP load balancing is configured, the local device changes the next-hop address of routes
to its address when advertising routes to IBGP peer groups, regardless of whether the peer
next-hop-local command is used.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 815
The IPv6 address family view is displayed.
Step 4 Run maximum load-balancing [ ebgp | ibgp ]
number [ ecmp-nexthop-
changed ]
The maximum number of BGP routes to be used for load balancing is set.
By default, the maximum number of BGP routes to be used for load balancing is
1, indicating that load balancing is not implemented.
NOTE
● On a public network, if the routes to the same destination implement load balancing,
the system will determine the optimal route type. If the optimal routes are IBGP routes,
only IBGP routes carry out load balancing. If the optimal routes are EBGP routes, only
EBGP routes carry out load balancing. This means that load balancing cannot be
implemented among IBGP and EBGP routes with the same destination address.
● On an IPv4 multicast network, BGP compares the AS_Path attributes of the routes to be
used for load balancing. In this case, step 5 is not supported.
NOTICE
Configuring BGP not to compare the AS_Path attributes of the routes to be used
for load balancing may cause routing loops.
Step 5 (Optional) Run load-balancing as-path-ignore
BGP is configured not to compare the AS_Path attributes of the routes to be used
for load balancing.
By default, BGP compares the AS_Path attributes of the routes to be used for load
balancing.
----End
9.9.9 Verifying the BGP Route Selection and Load Balancing
Configuration
Procedure
● Run the display bgp paths [
as-regular-expression ] command to check BGP
AS_Path information.
● Run the display bgp routing-table different-origin-as command to check
the routes with the same destination address but different origin ASs.
● Run the display bgp routing-table regular-expression
as-regular-expression
command to check information about routes that match the AS regular
expression.
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check routing information in a BGP
routing table.
● Run the display bgp routing-table community [
community-number |
aa:nn ] &<1-29> [ internet | no-advertise | no-export | no-export-
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 816
subconfed ] * [ whole-match ] command to check routing information with
the specified BGP community.
● Run the display bgp routing-table community-filter { {
community-filter-
name |
basic-community-filter-number } [ whole-match ] |
advanced-
community-filter-number } command to check information about routes
matching a specified BGP community filter.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check the
MBGP routing table.
● Run the display bgp multicast routing-table statistics command to check
statistics about the MBGP routing table.
----End
9.10 Controlling the Receiving and Advertisement of
BGP Routes
Pre-configuration Tasks
Before controlling the receiving and advertisement of BGP routes, configure basic
BGP functions.
Configuration Procedure
Figure 9-41 Flowchart of controlling the receiving and advertisement of BGP
routes
9.10.1 Configuring a Routing Policy
Context
Before controlling the receiving and advertisement of BGP routes, configure
routing policies or filters of routing policies for route selection. For details, see 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 817
Routing Policy Configuration in the
S300, S500, S2700, S5700, and S6700
V200R024C00 Configuration Guide - IP Unicast Routing.
9.10.2 Controlling the Advertisement of BGP Routes
Context
There are usually a large number of routes in a BGP routing table. Transmitting a
great deal of routing information heavily burdens devices. To address this problem,
you can configure devices to advertise only the routes that they want to advertise
or routes that their peers require. Multiple routes to the same destination may
exist and traverse different ASs. Routes to be advertised need to be filtered in
order to direct routes to specific ASs.
Procedure
● Configure the BGP device to filter the routes advertised by all its peers or peer
groups.
You can configure a BGP device to filter routes to be advertised.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform either of the following operations to configure the BGP device to
advertise routes to all peers or peer groups:
▪ To filter routes based on an ACL, run the filter-policy {
acl-number |
acl-name
acl-name } export [
protocol [
process-id ] ] or the filter-
policy {
acl6-number | acl6-name
acl6-name } export [
protocol
[
process-id ] ] command.
▪ To filter routes based on an IP prefix list, run the filter-policy ip-
prefix
ip-prefix-name export [
protocol [
process-id ] ] or the filter-
policy ipv6-prefix
ipv6-prefix-name export [
protocol [
process-id ] ]
command.
NOTE
If an ACL has been referenced in the filter-policy command but no VPN instance
is specified in the ACL rule, BGP will filter routes including public and private
network routes in all address families. If a VPN instance is specified in the ACL
rule, only the data traffic from the VPN instance will be filtered, and no route of
this VPN instance will be filtered.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 818
● Configure BGP to filter the routes advertised by a specified peer or peer
group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform any of the following operations to configure the BGP device to
advertise routes to a specific peer or peer group:
▪ To filter routes based on an ACL, run the peer {
group-name |
ipv4-
address |
ipv6-address } filter-policy {
acl-number | acl-name
acl-
name |
acl6-number | acl6-name
acl6-name } export command.
▪ To filter routes based on an IP prefix list, run the peer {
ipv4-address
|
group-name } ip-prefix
ip-prefix-name export or the peer {
group-
name |
ipv4-address |
ipv6-address } ipv6-prefix
ipv6-prefix-name
export command.
▪ To filter routes based on an AS_Path filter, run the peer {
ipv4-
address |
group-name |
ipv6-address } as-path-filter {
as-path-filter-
number |
as-path-filter-name } export command.
▪ To filter routes based on a route-policy, run the peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-policy-name export
command.
NOTE
The routing policy applied in the peer route-policy export command does not
support a specific interface as one matching rule. That is, the routing policy does
not support the if-match interface command.
----End
9.10.3 Controlling the Receiving of BGP Routes
Context
When a BGP device is attacked or network configuration errors occur, the BGP
device will receive a large number of routes from its peer. As a result, many device
resources are consumed. Therefore, the administrator must limit the resources
used by the device based on network planning and device capacity. BGP provides
peer-based route control to limit the number of routes to be sent by a peer. This
addresses the preceding problem.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 819
Procedure
● Configure the BGP device to filter the routes received from all its peers or
peer groups.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform either of the following operations to configure the BGP device to
filter the routes received from all its peers or peer groups:
▪ To filter routes based on an ACL, run the filter-policy {
acl-number |
acl-name
acl-name } import or the filter-policy {
acl6-number |
acl6-name
acl6-name } import command.
▪ To filter routes based on an IP prefix list, run the filter-policy ip-
prefix
ip-prefix-name import or the filter-policy ipv6-prefix
ipv6-
prefix-name import command.
NOTE
If an ACL has been referenced in the filter-policy command but no VPN instance
is specified in the ACL rule, BGP will filter routes including public and private
network routes in all address families. If a VPN instance is specified in the ACL
rule, only the data traffic from the VPN instance will be filtered, and no route of
this VPN instance will be filtered.
● Configure BGP to filter the routes received from a specified peer or peer
group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform any of the following operations to configure the BGP device to
filter the routes received from a specific peer or peer group:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 820
▪ To filter routes based on an ACL, run the peer {
group-name |
ipv4-
address |
ipv6-address } filter-policy {
acl-number | acl-name
acl-
name |
acl6-number | acl6-name
acl6-name } import command.
▪ To filter routes based on an IP prefix list, run the peer {
ipv4-address
|
group-name } ip-prefix
ip-prefix-name import or the peer {
group-
name |
ipv4-address |
ipv6-address } ipv6-prefix
ipv6-prefix-name
import command.
▪ To filter routes based on an AS_Path filter, run the peer {
ipv4-
address |
group-name |
ipv6-address } as-path-filter {
as-path-filter-
number |
as-path-filter-name } import command.
▪ To filter routes based on a route-policy, run the peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-policy-name import
command.
NOTE
The routing policy applied in the peer route-policy import command does not
support a specific interface as one matching rule. That is, the routing policy does
not support the if-match interface command.
NOTICE
If the number of routes received by the local device exceeds the upper
limit and the peer route-limit command is used for the first time, the
local device and its peer reestablish the peer relationship, regardless of
whether alert-only is set.
e. (Optional) Run peer {
group-name |
ipv4-address |
ipv6-address } route-
limit
limit [
percentage ] [ alert-only | idle-forever | idle-timeout
times ]
The maximum number of routes that can be received from the peer or
peer group is set.
----End
9.10.4 Configuring BGP Soft Reset
Context
After changing a BGP import policy, you must reset BGP connections for the new
import policy to take effect. This, however, interrupts the BGP connections
temporarily. BGP route-refresh allows the system to softly reset BGP connections
to refresh a BGP routing table without tearing down any BGP connection. If a
device's peer does not support route-refresh, configure the device to retain all
routing updates received from the peer so that the device can refresh its routing
table without tearing down the BGP connection with the peer.
Procedure
● If a device's peer supports route-refresh, configure the device to softly reset
the BGP connection with the peer and update the BGP routing table.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 821
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. (Optional) Run peer {
ipv4-address |
group-name } capability-advertise
route-refresh
Or run peer
ipv6-address capability-advertise { 4-byte-as | route-
refresh }
Route-refresh is enabled.
By default, route-refresh is enabled.
d. Run quit
Return to the system view.
e. Run quit
Return to the user view.
f. Run refresh bgp [ vpn-instance
vpn-instance-name ipv4-family |
vpnv4 ] { all |
ipv4-address | group
group-name | external | internal }
{ export | import }
Or run refresh bgp ipv6 { all | group
group-name |
ipv4-address |
ipv6-
address | external | internal } { export | import }
BGP soft reset is configured.
● If a device's peer does not support route-refresh, configure the device to
retain all routing updates received from the peer so that the device can
refresh its routing table without tearing down the BGP connection with the
peer.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
NOTICE
If the peer keep-all-routes command is used on the device for the first
time, the sessions between the device and its peers are reestablished.
The refresh bgp command takes effect when the peer keep-all-routes
command is used on the device supporting route-refresh.
d. Run peer {
ipv4-address |
group-name |
ipv6-address } keep-all-routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 822
The device is configured to store all the routing updates received from its
peers or peer groups.
By default, the device stores only the routing updates that are received
from peers or peer groups and match a configured import policy.
----End
9.10.5 Verifying the BGP Route Receiving and Advertisement
Configuration
Procedure
● Run the display ip as-path-filter [
as-path-filter-number |
as-path-filter-
name ] command to check information about a configured AS_Path filter.
● Run the display ip community-filter [
basic-comm-filter-num |
adv-comm-
filter-num |
comm-filter-name ] command to check information about a
configured community filter.
● Run the display ip extcommunity-filter [
extcomm-filter-number |
extcomm-
filter-name ] command to check information about a configured extended
community filter.
● Run the display bgp routing-table as-path-filter {
as-path-filter-number |
as-path-filter-name } command to check information about routes matching
a specified AS_Path filter.
● Run the display bgp routing-table community-filter { {
community-filter-
name |
basic-community-filter-number } [ whole-match ] |
advanced-
community-filter-number } command to check information about routes
matching a specified BGP community filter.
● Run the display bgp routing-table peer
ipv4-address received-routes
[ active ] [ statistics ] command to check information about routes received
by a BGP device from its peers.
● Run the display bgp multicast routing-table different-origin-as command
to check information about MBGP routes with different origin ASs.
● Run the display bgp multicast routing-table regular-expression
as-regular-
expression to check information about MBGP routes matching the AS regular
expression.
● Run the display bgp multicast paths [
as-regular-expression ] command to
check information about AS paths.
● Run the display bgp multicast routing-table as-path-filter {
as-path-filter-
number |
as-path-filter-name } command to check information about MBGP
routes matching the AS_Path filter.
● Run the display bgp multicast routing-table community-filter
{ {
community-filter-name |
basic-community-filter-number } [ whole-
match ] |
advanced-community-filter-number } command to check
information about routes matching a specified MBGP community filter.
● Run the display bgp multicast routing-table peer
peer-address
{ advertised-routes [
network [ {
mask |
mask-length } [ longer-prefixes ] ] ]
| received-routes [ active ] | accepted-routes } command to check
information about routes that are sent by and received from the specified
MBGP peer.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 823
● Run the display bgp multicast network command to check the routing
information that MBGP advertises.
----End
9.11 Adjusting the BGP Network Convergence Speed
Pre-configuration Tasks
Before adjusting the BGP network convergence speed, configure basic BGP
functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the BGP Network Convergence Speed Adjustment Configuration) in any sequence.
9.11.1 Configuring a BGP ConnectRetry Timer
Context
After BGP initiates a TCP connection, the ConnectRetry timer will be stopped if the
TCP connection is established successfully. If the first attempt to establish a TCP
connection fails, BGP tries again to establish the TCP connection after the
ConnectRetry timer expires.
● Setting a short ConnectRetry interval reduces the period BGP waits between
attempts to establish a TCP connection. This speeds up the establishment of
the TCP connection.
● Setting a long ConnectRetry interval suppresses routing flapping caused by
peer relationship flapping.
A ConnectRetry timer can be configured either for all peers or peer groups, or for
a specific peer or peer group. A ConnectRetry timer configured for a specific peer
takes precedence over that configured for the peer group of this peer. In addition,
a ConnectRetry timer configured for a specific peer or peer group takes
precedence over that configured for all peers or peer groups.
Procedure
● Configure a BGP ConnectRetry timer for all peers or peer groups.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run timer connect-retry
connect-retry-time
A BGP ConnectRetry timer is configured for all peers or peer groups.
By default, the ConnectRetry timer value is 32s.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 824
● Configure a ConnectRetry timer for a specific peer or peer group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run peer {
group-name |
ipv4-address |
ipv6-address } timer connect-
retry
connect-retry-time
A ConnectRetry timer is configured for a specific peer or peer group.
By default, the ConnectRetry timer value is 32s.
----End
9.11.2 Configuring BGP Keepalive and Hold Timers
Context
Keepalive messages are used by BGP to maintain peer relationships.
● If short Keepalive time and holdtime are set, BGP can detect a link fault
quickly. This speeds up BGP network convergence, but increases the number
of Keepalive messages on the network and loads of devices, and consumes
more network bandwidth resources.
● If long Keepalive time and holdtime are set, the number of Keepalive
messages on the network is reduced, loads of devices are reduced, and less
network bandwidth is consumed. If the Keepalive time is too long, BGP is
unable to detect link status changes in a timely manner. This hinders the
implementation of rapid BGP network convergence and may cause significant
packet loss.
Keepalive and hold timers can be configured either for all peers or peer groups, or
for a specific peer or peer group. Keepalive and hold timers configured for a
specific peer take precedence over those configured for the peer group of the peer.
In addition, Keepalive and hold timers configured for a specific peer or peer group
take precedence over those configured for all peers or peer groups.
NOTICE
Changing timer values using the timer command or the peer timer command
interrupts BGP peer relationships between switches.
Setting the Keepalive time to 20s is recommended. If the Keepalive time is less
than 20s, sessions between peers may be closed.
Procedure
● Configure BGP timers for all peers or peer groups.
a. Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 825
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run timer keepalive
keepalive-time hold
hold-time [ min-holdtime
min-holdtime ]
BGP timers are configured.
The proper maximum interval at which Keepalive messages are sent is
one third the holdtime. By default, the Keepalive time is 60s and the
holdtime is 180s.
● Configure BGP timers for a specific peer or peer group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run peer {
ipv4-address |
group-name |
ipv6-address } timer keepalive
keepalive-time hold
hold-time [ min-holdtime
min-holdtime ]
The Keepalive and hold timers are configured for a specific peer or peer
group.
The proper maximum interval at which Keepalive messages are sent is
one third the holdtime. By default, the Keepalive time is 60s and the
holdtime is 180s.
----End
9.11.3 Configuring an Update Message Timer
Context
BGP does not periodically update a routing table. When BGP routes change, BGP
updates the changed BGP routes in the BGP routing table by sending Update
messages.
● If a short Update message interval is set, BGP can fast detect route changes.
This speeds up BGP network convergence, but increases the number of
Update messages on the network and loads of devices, and consumes more
network bandwidth resources.
● If a long Update message interval is set, the number of Update messages on
the network is reduced, loads of devices are reduced, and less network
bandwidth is consumed. This avoids network flapping. If the Update message
interval is too long, BGP is unable to detect route changes in a timely manner.
This hinders the implementation of rapid BGP network convergence and may
cause significant packet loss.
Procedure
Step 1 Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 826
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run peer {
ipv4-address |
group-name |
ipv6-address } route-update-interval
interval
An Update message timer is configured.
By default, the interval at which Update messages are sent to IBGP peers is 15s,
and the interval at which Update messages are sent to EBGP peers is 30s.
----End
9.11.4 Disabling Rapid EBGP Connection Reset
Context
Rapid EBGP connection reset is enabled by default. This allows BGP to
immediately respond to a fault on an interface and delete the direct EBGP sessions
on the interface without waiting for the hold timer to expire and implements rapid
BGP network convergence.
If the status of an interface used to establish an EBGP connection changes
frequently, the EBGP session will be deleted and reestablished repeatedly, causing
network flapping. Rapid EBGP connection reset can be disabled in such a situation.
BGP will delete direct EBGP sessions on the interface until the hold timer expires.
This suppresses BGP network flapping and reduces network bandwidth
consumption.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run undo ebgp-interface-sensitive
Rapid EBGP connection reset is disabled.
By default, rapid EBGP connection reset is enabled.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 827
NOTE
Rapid EBGP connection reset enables BGP to quickly respond to interface faults but
prevents BGP from quickly responding to interface recovery. After the interface recovers,
BGP uses its state machine to restore relevant sessions.
Rapid EBGP connection reset is disabled in a situation where the status of an interface used
to establish an EBGP connection changes frequently. If the status of the interface becomes
stable, run the ebgp-interface-sensitive command to enable rapid EBGP connection reset
to implement rapid BGP network convergence.
----End
9.11.5 Configuring the BGP Next Hop Delayed Response
Context
Configuring the BGP next hop delayed response can speed up BGP route
convergence and minimize traffic loss.
As shown in Figure 9-42, PE1, PE2, and PE3 are the clients of the RR. CE2 is dual-
homed to PE1 and PE2. PE1 and PE2 advertise their routes to CE2 to the RR. The
RR advertises the route from PE1 to PE3. PE3 has a route to CE2 only and
advertises this route to CE1. After the route exchange, CE1 and CE2 can
communicate. If PE1 fails, PE3 detects that the next hop is unreachable and
instructs CE1 to delete the route to CE2. Traffic is then interrupted. After BGP
route convergence is complete, the RR selects the route advertised by PE2 and
sends a route update message to PE3. PE3 then advertises this route to CE1, and
traffic forwarding is restored to the normal state. A high volume of traffic will be
lost during traffic interruption because BGP route convergence is rather slow.
If the BGP next hop delayed response is enabled on PE3, PE3 does not reselect a
route or instruct CE1 to delete the route to CE2 immediately after detecting that
the route to PE1 is unreachable. After BGP convergence is complete, the RR selects
the route advertised by PE2 and sends the route to PE3. PE3 then reselects a route
and sends a route update message to CE1. Traffic forwarding is restored to the
normal state. After the BGP next hop delayed response is enabled on PE3, PE3
does not need to delete the route or instruct CE1 to delete the route. This delayed
response speeds up BGP route convergence and minimizes traffic loss.
Figure 9-42 Networking diagram of configuring the BGP next hop delayed
response
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 828
The BGP next hop delayed response applies to scenarios where the next hop has
multiple links to reach the same destination. If there is only one link between the
next hop and the destination, configuring the BGP next hop delayed response may
cause heavier traffic loss when the link fails because link switching is impossible.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Set a delay in responding to next hop changes.
The recursion results are as follows:
● Urgent recursion result change
The recursive next hop is changed, and BGP route reachability is also changed.
For example, if a fault occurs on a network, a device finds no next-hop route
or tunnel to which a BGP route is recursed. As a result, traffic is interrupted.
● Non-urgent recursion result change
The recursive next hop is changed, and BGP route reachability is not affected.
For example, after the interface or type of a tunnel to which the next hop of a
BGP route is recursed is changed (that is, the recursed tunnel is changed),
traffic keeps traveling over the BGP route.
Run either of the following commands to set a delay time after which a device
responds to a BGP next hop change:
● Run nexthop recursive-lookup delay [
delay-time ]
A device is enabled to delay responses to all next hop changes.
● Run nexthop recursive-lookup non-critical-event delay [
delay-time ]
A device is enabled to delay responses to non-urgent next hop changes.
If
delay-time is not specified, the default delay time is 5s.
The preceding commands can be run separately or simultaneously. The nexthop
recursive-lookup non-critical-event delay command takes precedence over the
nexthop recursive-lookup delay command if both commands are run.
The delay time specified in the nexthop recursive-lookup non-critical-event
delay command must be greater than or equal to that specified in the nexthop
recursive-lookup delay command if both commands are run.
----End
9.11.6 Configuring BGP Route Dampening
Context
A route is considered to be flapping when it repeatedly appears and then
disappears in the routing table. BGP generally applies to complex networks where
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 829
routes change frequently. Frequent route flapping consumes lots of bandwidths
and CPU resources and even affects normal network operation. BGP route
dampening prevents frequent route flapping.
BGP can differentiate routes based on policies and use different route dampening
parameters to suppress different routes. For example, on a network, you can set a
long suppression time for routes with a long mask and set a short suppression
time for routes with a short mask (such as 8-bit mask).
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast | vpnv4 [ unicast ] | vpn-instance
vpn-
instance-name }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast | vpn-instance
vpn-instance-name ]
The IPv6 address family view is displayed.
Step 4 Run dampening [ ibgp ] [
half-life-reach reuse suppress ceiling | route-policy
route-policy-name ] *
BGP route dampening parameters are configured.
NOTE
The dampening command is valid only for EBGP routes.
----End
9.11.7 Configuring Slow Peer Detection
Context
An update peer-group may consist of multiple BGP peers. If a network problem
(congestion for example) occurs and slows down the speed at which the local
device advertises routes to a BGP peer in the update peer-group, the speed at
which the local device advertises routes to other BGP peers in the update peer-
group is affected. To address this problem, slow peer detection is enabled by
default.
When slow peer detection is enabled, the local device identifies the BGP peer to
which routes are sent the slowest based on the time taken to send 100 packets to
each BGP peer. If this time is greater than the period threshold for slow peer
detection plus the average time taken to send 100 packets to BGP peers
(excluding the longest and shortest times), the local device considers the peer a
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 830
slow peer and removes it from the update peer-group. Slow peer detection
prevents this slow peer from affecting route advertisement to other peers in the
update peer-group. By default, the period threshold for slow peer detection is
300s.
To adjust the period threshold for slow peer detection or disable slow peer
detection, run the following steps.
NOTE
After a slow peer is removed from the update peer-group, the peer relationship between
the local device and the slow peer is reestablished.
Procedure
● Adjust the period threshold for slow peer detection
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run slow-peer detection threshold
threshold-value
Set a period threshold for slow peer detection.
By default, the period threshold for slow peer detection is 300s.
threshold-value specifies a period threshold for slow peer detection. If the
time taken to send 100 packets to a BGP peer is X, the configured period
is Y, the average time taken to send 100 packets to BGP peers (excluding
the longest and shortest times) is Z, and the inequality (X > Y + Z) is met,
the local device considers the BGP peer a slow peer and removes it from
the update peer-group.
● Disable slow peer detection
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run slow-peer detection disable
The slow peer detection is disabled.
----End
9.11.8 Verifying the BGP Network Convergence Speed
Adjustment Configuration
Procedure
● Run the display bgp peer [ verbose ] command to check information about
all BGP peers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 831
● Run the display bgp group [
group-name ] command to check information
about the specified BGP peer group.
● Run the display bgp routing-table dampened command to check dampened
BGP routes.
● Run the display bgp routing-table dampening parameter command to
check configured BGP route dampening parameters.
● Run the display bgp routing-table flap-info [ regular-expression
as-
regular-expression | as-path-filter
as-path-filter-number |
network-address
[ {
mask |
mask-length } [ longer-match ] ] ] command to check route
flapping statistics.
● Run the display bgp multicast routing-table dampened command to check
dampened MBGP routes.
● Run the display bgp multicast routing-table dampening parameter
command to check MBGP route dampening parameters.
● Run the following commands to check statistics about flapping MBGP routes:
– display bgp multicast routing-table flap-info [
ip-address [
mask
[ longer-match ] |
mask-length [ longer-match ] ] | as-path-filter
as-
path-filter-number | regular-expression
as-regular-expression ]
– display bgp multicast routing-table flap-info regular-expression
as-
regular-expression
----End
9.12 Configuring BGP Reliability
Pre-configuration Tasks
Before configuring BGP reliability, configure basic BGP functions.
Configuration Procedure
You can perform the following configuration tasks in any sequence.
9.12.1 Enabling BGP Tracking
Context
BFD can be configured to detect peer relationship status changes in order to
implement rapid BGP convergence. BFD, however, needs to be configured on the
entire network, and has poor extensibility. If BFD cannot be deployed on a device
to detect BGP peer relationship status, BGP peer tracking can be enabled on the
device to quickly detect link or peer unreachability, implementing rapid network
convergence.
BGP tracking can be used to adjust the interval between peer unreachability
discovery and connection interruption. This suppresses BGP peer relationship
flapping caused by route flapping and improves BGP network stability.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 832
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run peer {
group-name |
ipv4-address |
ipv6-address } tracking [ delay
delay-
time ]
BGP peer tracking is enabled on the device to detect the status of a specified peer.
By default, BGP peer tracking is disabled.
----End
9.12.2 Configuring BFD for BGP
Context
BGP periodically sends Keepalive messages to its peers to detect the status of its
peers. It takes more than 1 second for this detection mechanism to detect a fault.
When data is transmitted at gigabit rates, long-time fault detection will cause
packet loss and cannot meet high reliability requirements of carrier-class
networks. BFD for BGP can solve this problem. BFD is a millisecond-level fault
detection mechanism. It can fast detect faults on the link between BGP neighbors.
Therefore, BFD speeds up BGP route convergence, ensures fast link switching, and
reduces traffic loss.
When a peer joins a peer group on which BFD is enabled, BFD also takes effect on
the peer and a BFD session is created on the peer. To prevent BFD from taking
effect on the peer, run the peer bfd block command.
By default, Huawei devices establish multi-hop IBGP sessions with each other.
When a Huawei device communicates with a non-Huawei device that establishes
a single-hop IBGP session by default, you are advised to configure only association
between IGP and BFD or association between IBGP and BFD.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support BFD for BGP.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bfd
Global BFD is enabled on the local device.
Step 3 Run quit
Return to the system view.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 833
Step 4 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 5 Run peer {
group-name |
ipv4-address |
ipv6-address } bfd enable [ single-hop-
prefer ]
BFD is configured for the peer or peer group, and default BFD parameters are
used to establish BFD sessions.
single-hop-prefer takes effect only on IBGP peers. By default, if single-hop-
prefer is not specified, multi-hop sessions are established between direct IBGP
peers (Huawei devices). To interconnect a Huawei device and a non-Huawei
device that defaults the sessions between IBGP peers to single-hop, configure
single-hop-prefer in the command.
If BFD is configured for a peer group, BFD sessions are created for the peers on
which the peer bfd block command is not used.
Step 6 Run peer {
group-name |
ipv4-address |
ipv6-address } bfd { min-tx-interval
min-
tx-interval | min-rx-interval
min-rx-interval | detect-multiplier
multiplier | wtr
wtr-value } *
BFD session parameters are configured.
Step 7 (Optional) Run peer {
ipv4-address |
ipv6-address } bfd block
The peer is disabled from inheriting the BFD function of the peer group to which
the peer belongs.
NOTE
● BFD sessions are established when they are in Established state.
● If BFD parameters are configured on a peer, BFD sessions are established using these
parameters.
● The peer {
ipv4-address |
ipv6-address } bfd block and peer {
group-name |
ipv4-
address |
ipv6-address } bfd enable [ single-hop-prefer ] commands are mutually
exclusive.
----End
Verifying the Configuration
● Run the display bgp bfd session { [ vpnv4 vpn-instance
vpn-instance-
name ] peer
ipv4-address | all } command to check information about the
BFD sessions established between BGP peers.
● Run the display bgp [ vpnv4 vpn-instance
vpn-instance-name ] peer
[ [
ipv4-address ] verbose ] command to check information about BGP peers.
● Run the display bgp group [
group-name ] command to check information
about the specified BGP peer group.
● Run the display bgp vpnv4 { all | vpn-instance
vpn-instance-name } group
[
group-name ] command to check information about the BGP VPNv4 peer
group.
9.12.3 Configuring BGP GR
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 834
Context
After the graceful-restart command is configured to enable GR for the switch, to
prevent traffic interruption, another GR-capable device can assist the switch to
perform GR when BGP on the switch restarts due to an active/standby switchover,
and the switch can assist other GR-capable devices to perform GR when BGP on
other devices restarts.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run graceful-restart
BGP GR is enabled.
By default, BGP GR is disabled.
Step 4 (Optional) Run graceful-restart timer wait-for-rib
timer
The time during which the restarting speaker and receiving speaker wait for End-
of-RIB messages is set.
By default, the time for waiting for End-of-RIB messages is 600 seconds.
Step 5 (Optional) Run graceful-restart peer-reset
The device is enabled to reset a BGP session in GR mode.
By default, a device is disabled from resetting a BGP connection in GR mode.
----End
Verifying the Configuration
● Run the display bgp peer verbose command to check detailed information
about BGP GR.
9.13 Configuring BGP Route Summarization
Pre-configuration Tasks
Before configuring BGP route summarization, configure basic BGP functions.
Procedure
● Configure automatic route summarization.
a. Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 835
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
d. Run summary automatic
BGP summarizes subnet routes based on natural mask.
NOTE
The command summarizes the routes imported by BGP. These routes can be direct
routes, static routes, RIP routes, OSPF routes, or IS-IS routes. The command, however,
is invalid for the routes imported using the network command.
● Configure manual route summarization.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform any of the following operations to configure manual route
summarization.
▪ To advertise the summarized routes and specific routes, run the
aggregate
ipv4-address {
mask |
mask-length } command.
▪ To advertise only the summarized routes, run the aggregate
ipv4-
address {
mask |
mask-length } detail-suppressed or the aggregate
ipv6-address prefix-length detail-suppressed command.
▪ To advertise the summarized routes and specific routes that meet the
specified route-policy, run the aggregate
ipv4-address {
mask |
mask-length } suppress-policy
route-policy-name or the aggregate
ipv6-address prefix-length suppress-policy
route-policy-name
command.
▪ To advertise the summarized routes of which the AS_Set attribute
helps detect routing loops, run the aggregate
ipv4-address {
mask |
mask-length } as-set or the aggregate
ipv6-address prefix-length as-
set command.
▪ To set attributes for the summarized routes, run the aggregate
ipv4-
address {
mask |
mask-length } attribute-policy
route-policy-name
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 836
or the aggregate
ipv6-address prefix-length attribute-policy
route-
policy-name command.
▪ To summarize the specific routes that meet the specified route-policy,
run the aggregate
ipv4-address {
mask |
mask-length } origin-policy
route-policy-name or the aggregate
ipv6-address prefix-length
origin-policy
route-policy-name command.
NOTE
Manual route summarization is valid for the routes in the local BGP routing table. For
example, if the local BGP routing table does not contain routes with mask longer than
16 bits, such as 10.1.1.1/24, BGP will not generate an aggregated route for it even if
the aggregate 10.1.1.1 16 command is used.
----End
Verifying the Configuration
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check information about summarized
routes.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check the
MBGP routing table.
9.14 Configuring BGP to Advertise Default Routes to
Peers
Pre-configuration Tasks
Before configuring BGP to send default routes to peers, configure basic BGP
functions.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run peer {
group-name |
ipv4-address |
ipv6-address } default-route-advertise
[ route-policy
route-policy-name ] [ conditional-route-match-all {
ipv4-address1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 837
{
mask1 |
mask-length1 } } &<1-4> | conditional-route-match-any {
ipv4-
address2 {
mask2 |
mask-length2 } } &<1-4> ]
Or run peer {
group-name |
ipv4-address |
ipv6-address } default-route-advertise
[ route-policy
route-policy-name ] [ conditional-route-match-all {
ipv6-address1
prefix-length1 } &<1-4> | conditional-route-match-any {
ipv6-address2 prefix-
length2 } &<1-4> ]
A BGP device is configured to send default routes to a peer or peer group.
----End
Verifying the Configuration
● Run the display bgp routing-table [
ipv4-address [
mask |
mask-length
[ longer-prefixes ] ] ] command to check received BGP default routes.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check received
MBGP default routes.
9.15 Configuring MP-BGP
Pre-configuration Tasks
Before configuring MP-BGP, 9.6.1 Starting a BGP Process.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
BGP is started, the local AS number is specified, and the BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family unicast
The BGP-IPv4 unicast address family view is displayed.
● Run ipv4-family vpnv4
The BGP-VPNv4 address family view is displayed.
● Run ipv4-family vpn-instance
vpn-instance-name
The BGP-VPN instance IPv4 address family view is displayed.
● Run ipv4-family multicast
The BGP-IPv4 multicast address family view is displayed.
● Run ipv6-family unicast
The BGP-IPv6 unicast address family view is displayed.
● Run ipv6-family vpnv6
The BGP-VPNv6 address family view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 838
● Run ipv6-family vpn-instance
vpn-instance-name
The BGP-VPN instance IPv6 address family view is displayed.
NOTE
● Only the S5731-H, S5731S-H, S5732-H, S6735-S, S6730S-H, and S6730-H support BGP-
VPNv4 address family view and BGP-VPNv6 address family view.
● Different extended BGP functions must be configured in their respective address family
views, while common BGP functions are configured in the BGP view.
● The Switch supports the following MBGP features: basic BGP functions, BGP security
(MD5 authentication and keychain authentication), simplifying IBGP network
connections (route reflector and confederation), BGP route selection and load balancing,
controlling the receiving and advertisement of BGP routes, adjusting the BGP network
convergence speed, BGP reliability, BGP route summarization, and advertising default
routes to peers.
● Some BGP4+ functions can be configured in the BGP view, and some BGP4+ functions
need to be configured in the IPv6 unicast address family view. For example, the
following BGP4+ functions need to be configured in the IPv6 unicast address family
view: load balancing, manual route summarization, route dampening, community, and
route reflector.
----End
9.16 Maintaining BGP
9.16.1 Configuring Alarm and Clear Alarm Thresholds for the
Number of BGP Routes
Context
There are a limited number of BGP routes that can be added to a routing table. If
the limit is reached, new routes cannot be added, which may interrupt services. To
address this problem, configure alarm and clear alarm thresholds for the number
of BGP routes as required. With the alarm and clear alarm thresholds, alarms are
generated and cleared as expected. The alarms prompt you to check whether an
exception occurs and to take preventive measures.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run routing-table limit threshold-alarm upper-limit
upper-limit-value lower-
limit
lower-limit-value
Alarm and clear alarm thresholds are configured for the number of BGP routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 839
●
upper-limit-value specifies the alarm threshold. If the ratio of BGP routes to
the maximum number that is allowed exceeds the alarm threshold, an alarm
is generated.
●
lower-limit-value specifies the clear alarm threshold. If the ratio of BGP routes
to the maximum number that is allowed falls below this threshold, the alarm
is cleared.
●
upper-limit-value must be greater than
lower-limit-value; otherwise, alarms
are generated and cleared repeatedly if route flapping occurs.
By default,
upper-limit-value is 80%, and
lower-limit-value is 70%.
----End
9.16.2 Resetting BGP Connections
Context
NOTICE
Running the reset bgp command to reset BGP connections will interrupt BGP peer
relationships between BGP devices. Exercise caution when you use this command.
When the BGP routing policy changes, for example, the switch does not support
the route-refresh capability, reset BGP connections to make the modification take
effect.
Procedure
● To reset all BGP connections, run the reset bgp all command in the user view.
● To reset the BGP connection with a specified AS, run the reset bgp {
as-
number-plain |
as-number-dot } command in the user view.
● To reset the BGP connection with a specified peer, run the reset bgp
ipv4-
address command in the user view.
● To reset all EBGP connections, run the reset bgp external command in the
user view.
● To reset the BGP connection with a specified peer group, run the reset bgp
group
group-name command in the user view.
● To reset all IBGP connections, run the reset bgp internal command in the
user view.
● To reset the MBGP connection with a specified peer, run the reset bgp
multicast
peer-address command in the user view.
● To reset all MBGP connections, run the reset bgp multicast all command in
the user view.
● To reset the MBGP connection with all the peers in a specified peer group, run
the reset bgp multicast group
group-name command in the user view.
● To reset all external connections, run the reset bgp multicast external
command in the user view.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 840
● To reset all internal connections, run the reset bgp multicast internal
command in the user view.
----End
9.16.3 Clearing BGP Statistics
Context
NOTICE
BGP statistics cannot be restored after being cleared. Exercise caution when you
clear BGP statistics.
Procedure
● To clear route flapping statistics, run the reset bgp flap-info [ regexp
as-
path-regexp | as-path-filter
as-path-filter-number |
ipv4-address [
mask |
mask-length ] ] command in the user view.
● To clear route flapping statistics on a specified peer, run the reset bgp
ipv4-
address flap-info command in the user view.
● To clear route dampening statistics and release suppressed routes, run the
reset bgp dampening [
ipv4-address [
mask |
mask-length ] ] command in
the user view.
● To clear MBGP route dampening statistics, run the reset bgp multicast
dampening [
ip-address [
mask |
mask-length ] ] command in the user view.
● To clear MBGP route flapping statistics, run the reset bgp multicast flap-info
[
ip-address [
mask |
mask-length ] | as-path-filter {
as-path-list-number |
as-
path-list-name } | regexp
regexp ] command in the user view.
----End
9.17 Configuration Examples for BGP
9.17.1 Example for Configuring Basic BGP Functions
Networking Requirements
As shown in Figure 9-43, BGP runs between Switches; an EBGP connection is
established between SwitchA and SwitchB; IBGP full-mesh connections are
established between SwitchB, SwitchC, and SwitchD.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 841
Figure 9-43 Networking diagram of configuring basic BGP functions
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IBGP connections between SwitchB, SwitchC, and SwitchD.
2. Configure an EBGP connection between SwitchA and SwitchB.
Procedure
Step 1 Create VLANs and add interfaces to the corresponding VLANs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 50
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 50
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.2 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 50
[SwitchA-Vlanif50] ip address 10.1.1.1 16
[SwitchA-Vlanif50] quit
Step 3 Configure IBGP connections.
# Configure SwitchB.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 842
[SwitchB] bgp 65009
[SwitchB-bgp] router-id 172.17.2.2
[SwitchB-bgp] peer 172.16.1.2 as-number 65009
[SwitchB-bgp] peer 172.16.3.2 as-number 65009
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 65009
[SwitchC-bgp] router-id 172.17.3.3
[SwitchC-bgp] peer 172.16.3.1 as-number 65009
[SwitchC-bgp] peer 172.16.2.2 as-number 65009
[SwitchC-bgp] quit
# Configure SwitchD.
[SwitchD] bgp 65009
[SwitchD-bgp] router-id 172.17.4.4
[SwitchD-bgp] peer 172.16.1.1 as-number 65009
[SwitchD-bgp] peer 172.16.2.1 as-number 65009
[SwitchD-bgp] quit
Step 4 Configure EBGP connections.
# Configure SwitchA.
[SwitchA] bgp 65008
[SwitchA-bgp] router-id 172.17.1.1
[SwitchA-bgp] peer 192.168.1.1 as-number 65009
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] peer 192.168.1.2 as-number 65008
[SwitchB-bgp] quit
# Check the status of BGP connections.
[SwitchB] display bgp peer
BGP local router ID : 172.17.2.2
Local AS number : 65009
Total number of peers : 3 Peers in established state : 3
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
172.16.1.2 4 65009 49 62 0 00:44:58 Established 0
172.16.3.2 4 65009 56 56 0 00:40:54 Established 0
192.168.1.2 4 65008 49 65 0 00:44:03 Established 0
You can view that the BGP connections between SwitchB and all the other
Switches are set up.
Step 5 Configure SwitchA to advertise route 10.1.0.0/16.
# Configure SwitchA to advertise routes.
[SwitchA] bgp 65008
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] network 10.1.0.0 255.255.0.0
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.17.1.1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 843
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.0.0/16 0.0.0.0 0 0 i
# Check the routing table of SwitchB.
[SwitchB] display bgp routing-table
BGP Local router ID is 172.17.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.0.0/16 192.168.1.2 0 0 65008i
# Check the routing table of SwitchC.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.17.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
i 10.1.0.0/16 192.168.1.2 0 100 0 65008i
According to the routing table, you can view that SwitchC has learned the route to
the destination 10.1.0.0 in AS 65008, but the next hop 192.168.1.2 is unreachable.
Therefore, this route is invalid.
Step 6 Configure BGP to import direct routes.
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] import-route direct
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Check the BGP routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.17.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.0.0/16 0.0.0.0 0 0 i
*> 172.16.1.0/24 192.168.1.1 0 0 65009?
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 844
*> 172.16.3.0/24 192.168.1.1 0 0 65009?
192.168.1.0 192.168.1.1 0 0 65009?
# Check the routing table of SwitchC.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.17.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.0.0/16 192.168.1.2 0 100 0 65008i
*>i 172.16.1.0/24 172.16.3.1 0 100 0 ?
i 172.16.3.0/24 172.16.3.1 0 100 0 ?
*>i 192.168.1.0 172.16.3.1 0 100 0 ?
You can view that the route destined for 10.1.0.0 becomes valid, and the next hop
is the address of SwitchA.
# Perform the ping operation to verify the configuration.
[SwitchC] ping 10.1.1.1
PING 10.1.1.1: 56 data bytes, press CTRL_C to break
Reply from 10.1.1.1: bytes=56 Sequence=1 ttl=255 time=31 ms
Reply from 10.1.1.1: bytes=56 Sequence=2 ttl=255 time=47 ms
Reply from 10.1.1.1: bytes=56 Sequence=3 ttl=255 time=31 ms
Reply from 10.1.1.1: bytes=56 Sequence=4 ttl=255 time=16 ms
Reply from 10.1.1.1: bytes=56 Sequence=5 ttl=255 time=31 ms
--- 10.1.1.1 ping statistics ---
5 packet(s) transmitted
5 packet(s) received
0.00% packet loss
round-trip min/avg/max = 16/31/47 ms
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 50
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif50
ip address 10.1.1.1 255.255.0.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 65008
router-id 172.17.1.1
peer 192.168.1.1 as-number 65009
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 845
ipv4-family unicast
undo synchronization
network 10.1.0.0 255.255.0.0
peer 192.168.1.1 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20 30
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface Vlanif20
ip address 172.16.3.1 255.255.255.0
#
interface Vlanif30
ip address 172.16.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65009
router-id 172.17.2.2
peer 172.16.1.2 as-number 65009
peer 172.16.3.2 as-number 65009
peer 192.168.1.2 as-number 65008
#
ipv4-family unicast
undo synchronization
import-route direct
peer 172.16.1.2 enable
peer 172.16.3.2 enable
peer 192.168.1.2 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 40
#
interface Vlanif20
ip address 172.16.3.2 255.255.255.0
#
interface Vlanif40
ip address 172.16.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
bgp 65009
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 846
router-id 172.17.3.3
peer 172.16.2.2 as-number 65009
peer 172.16.3.1 as-number 65009
#
ipv4-family unicast
undo synchronization
peer 172.16.2.2 enable
peer 172.16.3.1 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30 40
#
interface Vlanif30
ip address 172.16.1.2 255.255.255.0
#
interface Vlanif40
ip address 172.16.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
bgp 65009
router-id 172.17.4.4
peer 172.16.1.1 as-number 65009
peer 172.16.2.1 as-number 65009
#
ipv4-family unicast
undo synchronization
peer 172.16.1.1 enable
peer 172.16.2.1 enable
#
return
9.17.2 Example for Configuring Basic BGP4+ Functions
Networking Requirements
As shown in Figure 9-44, there are two ASs: 65008 and 65009. SwitchA belongs to
AS 65008, and SwitchB, SwitchC, and SwitchD belong to AS 65009. BGP4+ is
required to exchange the routing information between the two ASs.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 847
Figure 9-44 Networking diagram of configuring basic BGP4+ functions
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IBGP connections between SwitchB, SwitchC, and SwitchD.
2. Configure an EBGP connection between SwitchA and SwitchB.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Enable the IPv6 forwarding capability, and assign an IPv6 address for each
interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] ipv6
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ipv6 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 848
[SwitchA-Vlanif10] ipv6 address fc00:0:0:8::1/64
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ipv6 enable
[SwitchA-Vlanif20] ipv6 address fc00:0:0:100::2/64
[SwitchA-Vlanif20] quit
Step 3 Configure IBGP.
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer fc00:0:0:91::2 as-number 65009
[SwitchB-bgp] peer fc00:0:0:93::2 as-number 65009
[SwitchB-bgp] ipv6-family unicast
[SwitchB-bgp-af-ipv6] peer fc00:0:0:91::2 enable
[SwitchB-bgp-af-ipv6] peer fc00:0:0:93::2 enable
[SwitchB-bgp-af-ipv6] network fc00:0:0:91:: 64
[SwitchB-bgp-af-ipv6] network fc00:0:0:93:: 64
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 65009
[SwitchC-bgp] router-id 10.3.3.3
[SwitchC-bgp] peer fc00:0:0:93::1 as-number 65009
[SwitchC-bgp] peer fc00:0:0:92::2 as-number 65009
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer fc00:0:0:93::1 enable
[SwitchC-bgp-af-ipv6] peer fc00:0:0:92::2 enable
[SwitchC-bgp-af-ipv6] network fc00:0:0:93:: 64
[SwitchC-bgp-af-ipv6] network fc00:0:0:92:: 64
[SwitchC-bgp-af-ipv6] quit
[SwitchC-bgp] quit
# Configure SwitchD.
[SwitchD] bgp 65009
[SwitchD-bgp] router-id 10.4.4.4
[SwitchD-bgp] peer fc00:0:0:91::1 as-number 65009
[SwitchD-bgp] peer fc00:0:0:92::1 as-number 65009
[SwitchD-bgp] ipv6-family unicast
[SwitchD-bgp-af-ipv6] peer fc00:0:0:91::1 enable
[SwitchD-bgp-af-ipv6] peer fc00:0:0:92::1 enable
[SwitchD-bgp-af-ipv6] network fc00:0:0:92:: 64
[SwitchD-bgp-af-ipv6] network fc00:0:0:91:: 64
[SwitchD-bgp-af-ipv6] quit
[SwitchD-bgp] quit
Step 4 Configure an EBGP connection.
# Configure SwitchA.
[SwitchA] bgp 65008
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer fc00:0:0:100::1 as-number 65009
[SwitchA-bgp] ipv6-family unicast
[SwitchA-bgp-af-ipv6] peer fc00:0:0:100::1 enable
[SwitchA-bgp-af-ipv6] network fc00:0:0:100:: 64
[SwitchA-bgp-af-ipv6] network fc00:0:0:8:: 64
[SwitchA-bgp-af-ipv6] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] peer fc00:0:0:100::2 as-number 65008
[SwitchB-bgp] ipv6-family unicast
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 849
[SwitchB-bgp-af-ipv6] peer fc00:0:0:100::2 enable
[SwitchB-bgp-af-ipv6] network fc00:0:0:100:: 64
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# View the status of the BGP4+ peers.
[SwitchB] display bgp ipv6 peer
BGP local router ID : 10.2.2.2
Local AS number : 65009
Total number of peers : 3 Peers in established state : 3
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
FC00:0:0:91::2 4 65009 8 9 0 00:05:37 Established 2
FC00:0:0:93::2 4 65009 2 2 0 00:00:09 Established 2
FC00:0:0:100::2 4 65008 9 7 0 00:05:38 Established 1
The preceding information shows that the BGP4+ connections between SwitchB
and other Switches are set up.
# Display the routing table of SwitchA.
[SwitchA] display bgp ipv6 routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
*> Network : FC00:0:0:91:: PrefixLen : 64
NextHop : FC00:0:0:100::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 65009 i
*> Network : FC00:0:0:92:: PrefixLen : 64
NextHop : FC00:0:0:100::1 LocPrf :
MED : PrefVal : 0
Label :
Path/Ogn : 65009 i
*> Network : FC00:0:0:93:: PrefixLen : 64
NextHop : FC00:0:0:100::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 65009 i
*> Network : FC00:0:0:100:: PrefixLen : 64
NextHop : :: LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
NextHop : FC00:0:0:100::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 65009 i
The routing table shows that SwitchA has learned the route from AS 65009. AS
65008 and AS 65009 can exchange their routing information.
----End
Configuration Files
● SwitchA configuration file
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 850
#
sysname SwitchA
#
ipv6
#
vlan batch 10 20
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:8::1/64
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:100::2/64
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 65008
router-id 10.1.1.1
peer FC00:0:0:100::1 as-number 65009
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:8:: 64
network FC00:0:0:100:: 64
peer FC00:0:0:100::1 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
vlan batch 20 30 40
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:100::1/64
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:93::1/64
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:91::1/64
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 851
bgp 65009
router-id 10.2.2.2
peer FC00:0:0:91::2 as-number 65009
peer FC00:0:0:93::2 as-number 65009
peer FC00:0:0:100::2 as-number 65008
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:91:: 64
network FC00:0:0:93:: 64
network FC00:0:0:100:: 64
peer FC00:0:0:91::2 enable
peer FC00:0:0:93::2 enable
peer FC00:0:0:100::2 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 30 50
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:93::2/64
#
interface Vlanif50
ipv6 enable
ipv6 address FC00:0:0:92::1/64
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65009
router-id 10.3.3.3
peer FC00:0:0:92::2 as-number 65009
peer FC00:0:0:93::1 as-number 65009
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:92:: 64
network FC00:0:0:93:: 64
peer FC00:0:0:92::2 enable
peer FC00:0:0:93::1 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
ipv6
#
vlan batch 40 50
#
interface Vlanif40
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 852
ipv6 enable
ipv6 address FC00:0:0:91::2/64
#
interface Vlanif50
ipv6 enable
ipv6 address FC00:0:0:92::2/64
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 65009
router-id 10.4.4.4
peer FC00:0:0:91::1 as-number 65009
peer FC00:0:0:92::1 as-number 65009
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:91:: 64
network FC00:0:0:92:: 64
peer FC00:0:0:91::1 enable
peer FC00:0:0:92::1 enable
#
return
9.17.3 Example for Configuring Basic MBGP Functions
Networking Requirements
As shown in Figure 9-45, the receiver receives VoD information in multicast mode.
The receiver and the source reside in different ASs. Multicast routing information
needs to be transmitted between ASs.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 853
Figure 9-45 Networking diagram of MBGP configuration
Data Plan
Table 9-31 IP addresses of interconnected interfaces
Link
Name
(Local
End-
Remote
End)
Local Interface and IP Address Remote Interface and IP
Address
SwitchA-
SwitchB
GE0/0/1
VLANIF100: 192.168.1.1/24
GE0/0/1
VLANIF100: 192.168.1.2/24
SwitchA-
Source
GE0/0/2
VLANIF101: 10.10.10.1/24
-
SwitchB-
SwitchD
GE0/0/2
VLANIF200: 192.168.4.2/24
GE0/0/2
VLANIF200: 192.168.4.1/24
SwitchB-
SwitchC
GE0/0/3
VLANIF300: 192.168.3.2/24
GE0/0/3
VLANIF300: 192.168.3.1/24
SwitchC-
SwitchD
GE0/0/1
VLANIF400: 192.168.5.1/24
GE0/0/1
VLANIF400: 192.168.5.2/24
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 854
Link
Name
(Local
End-
Remote
End)
Local Interface and IP Address Remote Interface and IP
Address
SwitchC-
Receiver
GE0/0/2
VLANIF102: 10.22.22.1/24
-
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure MBGP peers for inter-AS multicast transmission.
2. Configure the routes advertised by MBGP.
3. Enable the multicast function on each switch.
4. Configure basic PIM-SM functions on each switch in ASs and enable IGMP on
receiver-side interfaces.
5. Configure a BSR boundary on the interfaces that connect to two ASs.
6. Configure MSDP peers to transmit inter-domain multicast source information.
Procedure
Step 1 Configure IP addresses for interfaces on each Switch and the OSPF protocol in the
ASs.
# Configure IP addresses and masks for the interfaces on each switch according to
Figure 9-45 and configure OSPF on the switches in ASs. Ensure that SwitchB,
SwitchC, and SwitchD in AS 200 can communicate with the receiver at the
network layer, learn routes to the loopback interfaces of each other, and
dynamically update routes using a unicast routing protocol. Configure OSPF
process 1. The configuration procedure is not mentioned here.
Step 2 Configure BGP, enable the MBGP protocol, and configure the MBGP peers.
# Configure BGP and the MBGP peer on SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] peer 192.168.1.2 as-number 200
[SwitchA-bgp] ipv4-family multicast
[SwitchA-bgp-af-multicast] peer 192.168.1.2 enable
[SwitchA-bgp-af-multicast] quit
[SwitchA-bgp] quit
# Configure BGP and the MBGP peer on SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] peer 192.168.1.1 as-number 100
[SwitchB-bgp] peer 192.168.3.1 as-number 200
[SwitchB-bgp] peer 192.168.4.1 as-number 200
[SwitchB-bgp] ipv4-family multicast
[SwitchB-bgp-af-multicast] peer 192.168.1.1 enable
[SwitchB-bgp-af-multicast] peer 192.168.3.1 enable
[SwitchB-bgp-af-multicast] peer 192.168.4.1 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 855
[SwitchB-bgp-af-multicast] quit
[SwitchB-bgp] quit
# Configure BGP and the MBGP peer on SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] peer 192.168.3.2 as-number 200
[SwitchC-bgp] peer 192.168.5.2 as-number 200
[SwitchC-bgp] ipv4-family multicast
[SwitchC-bgp-af-multicast] peer 192.168.3.2 enable
[SwitchC-bgp-af-multicast] peer 192.168.5.2 enable
[SwitchC-bgp-af-multicast] quit
[SwitchC-bgp] quit
# Configure BGP and the MBGP peer on SwitchD.
[SwitchD] bgp 200
[SwitchD-bgp] peer 192.168.4.2 as-number 200
[SwitchD-bgp] peer 192.168.5.1 as-number 200
[SwitchD-bgp] ipv4-family multicast
[SwitchD-bgp-af-multicast] peer 192.168.4.2 enable
[SwitchD-bgp-af-multicast] peer 192.168.5.1 enable
[SwitchD-bgp-af-multicast] quit
[SwitchD-bgp] quit
Step 3 Configure the routes to be advertised.
# Configure the routes to be advertised on SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] import-route direct
[SwitchA-bgp] ipv4-family multicast
[SwitchA-bgp-af-multicast] import-route direct
[SwitchA-bgp-af-multicast] quit
[SwitchA-bgp] quit
# Configure the routes to be advertised on SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] import-route direct
[SwitchB-bgp] import-route ospf 1
[SwitchB-bgp] ipv4-family multicast
[SwitchB-bgp-af-multicast] import-route direct
[SwitchB-bgp-af-multicast] import-route ospf 1
[SwitchB-bgp-af-multicast] quit
[SwitchB-bgp] quit
Step 4 Enable multicast on each Switch and the interfaces that are connected.
# Configure SwitchA.
[SwitchA] multicast routing-enable
[SwitchA] interface vlanif 100
[SwitchA-Vlanif100] pim sm
[SwitchA-Vlanif100] quit
[SwitchA] interface vlanif 101
[SwitchA-Vlanif101] pim sm
[SwitchA-Vlanif101] quit
# Configure SwitchB.
[SwitchB] multicast routing-enable
[SwitchB] interface vlanif 100
[SwitchB-Vlanif100] pim sm
[SwitchB-Vlanif100] quit
[SwitchB] interface vlanif 200
[SwitchB-Vlanif200] pim sm
[SwitchB-Vlanif200] quit
[SwitchB] interface vlanif 300
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 856
[SwitchB-Vlanif300] pim sm
[SwitchB-Vlanif300] quit
# Configure SwitchC.
[SwitchC] multicast routing-enable
[SwitchC] interface vlanif 400
[SwitchC-Vlanif400] pim sm
[SwitchC-Vlanif400] quit
[SwitchC] interface vlanif 102
[SwitchC-Vlanif102] pim sm
[SwitchC-Vlanif102] igmp enable
[SwitchC-Vlanif102] quit
[SwitchC] interface vlanif 300
[SwitchC-Vlanif300] pim sm
[SwitchC-Vlanif300] quit
# Configure SwitchD.
[SwitchD] multicast routing-enable
[SwitchD] interface vlanif 400
[SwitchD-Vlanif400] pim sm
[SwitchD-Vlanif400] quit
[SwitchD] interface vlanif 200
[SwitchD-Vlanif200] pim sm
[SwitchD-Vlanif200] quit
Step 5 Configure BSR and RP within each AS.
# Configure SwitchA.
[SwitchA] interface LoopBack 0
[SwitchA-LoopBack0] ip address 10.1.1.1 255.255.255.255
[SwitchA-LoopBack0] pim sm
[SwitchA-LoopBack0] quit
[SwitchA] pim
[SwitchA-pim] c-bsr LoopBack 0
[SwitchA-pim] c-rp LoopBack 0
[SwitchA-pim] quit
# Configure SwitchB.
[SwitchB] interface LoopBack 0
[SwitchB-LoopBack0] ip address 10.2.2.2 255.255.255.255
[SwitchB-LoopBack0] pim sm
[SwitchB-LoopBack0] quit
[SwitchB] pim
[SwitchB-pim] c-bsr LoopBack 0
[SwitchB-pim] c-rp LoopBack 0
[SwitchB-pim] quit
Step 6 Configure the BSR boundary on the interfaces connecting two ASs.
# Configure SwitchA.
[SwitchA] interface vlanif 100
[SwitchA-Vlanif100] pim bsr-boundary
[SwitchA-Vlanif100] quit
# Configure SwitchB.
[SwitchB] interface vlanif 100
[SwitchB-Vlanif100] pim bsr-boundary
[SwitchB-Vlanif100] quit
Step 7 Configure MSDP peers.
# Configure SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 857
[SwitchA] msdp
[SwitchA-msdp] peer 192.168.1.2 connect-interface Vlanif100
[SwitchA-msdp] quit
# Configure SwitchB.
[SwitchB] msdp
[SwitchB-msdp] peer 192.168.1.1 connect-interface Vlanif100
[SwitchB-msdp] quit
Step 8 Verify the configuration.
# Run the display bgp multicast peer command to view the MBGP peer
relationship between switches. For example, the following information shows the
MBGP peer relationship on SwitchA:
[SwitchA] display bgp multicast peer
BGP local router ID : 10.1.1.1
Local AS number : 100
Total number of peers : 1 Peers in established state : 1
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
192.168.1.2 4 200 82 75 0 00:30:29 Established 17
# Run the display msdp brief command to view information about the MSDP
peer relationship between switches. For example, the following information shows
the MSDP peer relationship on SwitchB:
[SwitchB] display msdp brief
MSDP Peer Brief Information
Configured Up Listen Connect Shutdown Down
1 1 0 0 0 0
Peer's Address State Up/Down time AS SA Count Reset Count
192.168.1.1 Up 00:07:17 100 1 0
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 100 to 101
#
multicast routing-enable
#
interface Vlanif100
ip address 192.168.1.1 255.255.255.0
pim bsr-boundary
pim sm
#
interface Vlanif101
ip address 10.10.10.1 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 100
#
interface GigabitEthernet0/0/2
port link-type access
port default vlan 101
#
interface LoopBack0
ip address 10.1.1.1 255.255.255.255
pim sm
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 858
#
pim
c-bsr LoopBack0
c-rp LoopBack0
#
bgp 100
peer 192.168.1.2 as-number 200
#
ipv4-family unicast
undo synchronization
import-route direct
peer 192.168.1.2 enable
#
ipv4-family multicast
undo synchronization
peer 192.168.1.2 enable
#
msdp
peer 192.168.1.2 connect-interface Vlanif100
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 100 200 300
#
multicast routing-enable
#
interface Vlanif100
ip address 192.168.1.2 255.255.255.0
pim bsr-boundary
pim sm
#
interface Vlanif200
ip address 192.168.4.2 255.255.255.0
pim sm
#
interface Vlanif300
ip address 192.168.3.2 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 100
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 200
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 300
#
interface LoopBack0
ip address 10.2.2.2 255.255.255.255
pim sm
#
pim
c-bsr LoopBack0
c-rp LoopBack0
#
ospf 1
area 0.0.0.0
network 10.2.2.2 0.0.0.0
network 192.168.3.0 0.0.0.255
network 192.168.4.0 0.0.0.255
#
bgp 200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 859
peer 192.168.1.1 as-number 100
peer 192.168.3.1 as-number 200
peer 192.168.4.1 as-number 200
#
ipv4-family unicast
undo synchronization
import-route direct
import-route ospf 1
peer 192.168.1.1 enable
peer 192.168.3.1 enable
peer 192.168.4.1 enable
#
ipv4-family multicast
undo synchronization
import-route direct
import-route ospf 1
peer 192.168.1.1 enable
peer 192.168.3.1 enable
peer 192.168.4.1 enable
#
msdp
peer 192.168.1.1 connect-interface Vlanif100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 102 300 400
#
multicast routing-enable
#
interface Vlanif102
ip address 10.22.22.1 255.255.255.0
pim sm
igmp enable
#
interface Vlanif300
ip address 192.168.3.1 255.255.255.0
pim sm
#
interface Vlanif400
ip address 192.168.5.1 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 400
#
interface GigabitEthernet0/0/2
port link-type access
port default vlan 102
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 300
#
interface LoopBack0
ip address 10.3.3.3 255.255.255.255
#
ospf 1
area 0.0.0.0
network 10.3.3.3 0.0.0.0
network 10.22.22.0 0.0.0.255
network 192.168.3.0 0.0.0.255
network 192.168.5.0 0.0.0.255
#
bgp 200
peer 192.168.3.2 as-number 200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 860
peer 192.168.5.2 as-number 200
#
ipv4-family unicast
undo synchronization
peer 192.168.3.2 enable
peer 192.168.5.2 enable
#
ipv4-family multicast
undo synchronization
peer 192.168.3.2 enable
peer 192.168.5.2 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 200 400
#
multicast routing-enable
#
interface Vlanif200
ip address 192.168.4.1 255.255.255.0
pim sm
#
interface Vlanif400
ip address 192.168.5.2 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 400
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 200
#
interface LoopBack0
ip address 10.4.4.4 255.255.255.255
#
ospf 1
area 0.0.0.0
network 10.4.4.4 0.0.0.0
network 192.168.4.0 0.0.0.255
network 192.168.5.0 0.0.0.255
#
bgp 200
peer 192.168.4.2 as-number 200
peer 192.168.5.1 as-number 200
#
ipv4-family unicast
undo synchronization
peer 192.168.4.2 enable
peer 192.168.5.1 enable
#
ipv4-family multicast
undo synchronization
peer 192.168.4.2 enable
peer 192.168.5.1 enable
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 861
9.17.4 Example for Configuring BGP to Interact with an IGP
Networking Requirements
The network shown in Figure 9-46 is divided into AS 65008 and AS 65009. In AS
65009, an IGP is used to calculate routes. In this example, OSPF is used as an IGP.
The two ASs need to communicate with each other.
Figure 9-46 Networking diagram of configuring BGP to interact with an IGP
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure OSPF on SwitchB and SwitchC so that these devices can access each
other.
2. Establish an EBGP connection between SwitchA and SwitchB so that these
devices can exchange routing information.
3. Configure BGP and OSPF to import routes from each other on SwitchB so that
the two ASs can communicate with each other.
4. (Optional) Configure BGP route summarization on SwitchB to simplify the
BGP routing table.
Procedure
Step 1 Create VLANs and add interfaces to the corresponding VLANs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 30
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 30
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 862
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.3.1.2 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 30
[SwitchA-Vlanif30] ip address 10.8.1.1 24
[SwitchA-Vlanif30] quit
Step 3 Configure OSPF.
# Configure SwitchB.
[SwitchB] ospf 1
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 10.9.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
# Configure SwitchC.
[SwitchC] ospf 1
[SwitchC-ospf-1] area 0
[SwitchC-ospf-1-area-0.0.0.0] network 10.9.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] network 10.9.2.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] quit
[SwitchC-ospf-1] quit
Step 4 Configure an EBGP connection.
# Configure SwitchA.
[SwitchA] bgp 65008
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer 10.3.1.1 as-number 65009
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] network 10.8.1.0 255.255.255.0
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer 10.3.1.2 as-number 65008
Step 5 Configure BGP to interact with an IGP.
# On SwitchB, configure BGP to import OSPF routes.
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] import-route ospf 1
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 863
*> 10.8.1.0/24 0.0.0.0 0 0 i
*> 10.9.1.0/24 10.3.1.1 0 0 65009?
*> 10.9.2.0/24 10.3.1.1 2 0 65009?
# On SwitchB, configure OSPF to import BGP routes.
[SwitchB] ospf
[SwitchB-ospf-1] import-route bgp
[SwitchB-ospf-1] quit
# Check the routing table of SwitchC.
[SwitchC] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 7 Routes : 7
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.8.1.0/24 O_ASE 150 1 D 10.9.1.1 Vlanif20
10.9.1.0/24 Direct 0 0 D 10.9.1.2 Vlanif20
10.9.1.2/32 Direct 0 0 D 127.0.0.1 Vlanif20
10.9.2.0/24 Direct 0 0 D 10.9.2.1 Vlanif40
10.9.2.1/32 Direct 0 0 D 127.0.0.1 Vlanif40
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
Step 6 Configure automatic summarization.
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] summary automatic
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Check the BGP routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.0.0 10.3.1.1 0 65009?
*> 10.8.1.0/24 0.0.0.0 0 0 i
# Perform the ping operation to verify the configuration.
[SwitchA] ping -a 10.8.1.1 10.9.2.1
PING 10.9.2.1: 56 data bytes, press CTRL_C to break
Reply from 10.9.2.1: bytes=56 Sequence=1 ttl=253 time=15 ms
Reply from 10.9.2.1: bytes=56 Sequence=2 ttl=253 time=31 ms
Reply from 10.9.2.1: bytes=56 Sequence=3 ttl=253 time=47 ms
Reply from 10.9.2.1: bytes=56 Sequence=4 ttl=253 time=46 ms
Reply from 10.9.2.1: bytes=56 Sequence=5 ttl=253 time=47 ms
--- 10.9.2.1 ping statistics ---
5 packet(s) transmitted
5 packet(s) received
0.00% packet loss
round-trip min/avg/max = 15/37/47 ms
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 864
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 30
#
interface Vlanif10
ip address 10.3.1.2 255.255.255.0
#
interface Vlanif30
ip address 10.8.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65008
router-id 10.1.1.1
peer 10.3.1.1 as-number 65009
#
ipv4-family unicast
undo synchronization
network 10.8.1.0 255.255.255.0
peer 10.3.1.1 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.3.1.1 255.255.255.0
#
interface Vlanif20
ip address 10.9.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 65009
router-id 10.2.2.2
peer 10.3.1.2 as-number 65008
#
ipv4-family unicast
undo synchronization
summary automatic
import-route ospf 1
peer 10.3.1.2 enable
#
ospf 1
import-route bgp
area 0.0.0.0
network 10.9.1.0 0.0.0.255
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 865
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 40
#
interface Vlanif20
ip address 10.9.1.2 255.255.255.0
#
interface Vlanif40
ip address 10.9.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
ospf 1
area 0.0.0.0
network 10.9.1.0 0.0.0.255
network 10.9.2.0 0.0.0.255
#
return
9.17.5 Example for Configuring AS_Path Filter
Networking Requirements
On the network shown in Figure 9-47, SwitchB establish EBGP connections with
SwitchA and SwitchC. The user wants to disable the devices in AS 10 from
communicating with devices in AS 30.
Figure 9-47 Networking diagram of configuring the AS_Path filter
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 866
Configuration Roadmap
The configuration roadmap is as follows:
1. Establish EBGP connections between SwitchA and SwitchB and between
SwitchB and SwitchC and configure these devices to import direct routes so
that the ASs can communicate with each other through these EBGP
connections.
2. Configure AS_Path filters on SwitchB and use filtering rules to prevent AS 20
from advertising routes of AS 30 to AS 10 or routes of AS 10 to AS 30.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 1/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.0.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.2.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure EBGP connections.
# Configure SwitchA.
[SwitchA] bgp 10
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] peer 192.168.2.2 as-number 20
[SwitchA-bgp] import-route direct
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 20
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] peer 192.168.2.1 as-number 10
[SwitchB-bgp] peer 192.168.3.2 as-number 30
[SwitchB-bgp] import-route direct
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 30
[SwitchC-bgp] router-id 172.16.3.3
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 867
[SwitchC-bgp] peer 192.168.3.1 as-number 20
[SwitchC-bgp] import-route direct
[SwitchC-bgp] quit
# Check the routing table advertised by SwitchB. Take the routing table advertised
by SwitchB to SwitchC as an example. You can find that SwitchB advertises the
direct route of AS 10.
[SwitchB] display bgp routing-table peer 192.168.3.2 advertised-routes
BGP Local router ID is 172.16.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.1.0/24 192.168.3.1 0 20 10?
*> 10.1.1.0/24 192.168.3.1 0 20 30?
*> 192.168.2.0 192.168.3.1 0 0 20?
*> 192.168.3.0 192.168.3.1 0 0 20?
Check the routing table of SwitchC. You can find that SwitchC learns this route
advertised by SwitchB.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.16.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 9
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.1.0/24 192.168.3.1 0 20 10?
*> 10.1.1.0/24 0.0.0.0 0 0 ?
*> 10.1.1.1/32 0.0.0.0 0 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
*> 192.168.2.0 192.168.3.1 0 0 20?
*> 192.168.3.0 0.0.0.0 0 0 ?
192.168.3.1 0 0 20?
*> 192.168.3.2/32 0.0.0.0 0 0 ?
Step 4 Configure the AS_Path filter on SwitchB and apply the filter on the outbound
interface of SwitchB.
# Create AS_Path filter 1, denying the passing of routes carrying AS 30. The
regular expression "_30_" indicates any AS list that contains AS 30 and ".*"
matches any character.
[SwitchB] ip as-path-filter path-filter1 deny _30_
[SwitchB] ip as-path-filter path-filter1 permit .*
# Create AS_Path filter 2, denying the passing of routes carrying AS 10. The
regular expression "_10_" indicates any AS list that contains AS 10 and "*"
matches any character.
[SwitchB] ip as-path-filter path-filter2 deny _10_
[SwitchB] ip as-path-filter path-filter2 permit .*
# Apply the AS_Path filter on two outbound interfaces of SwitchB.
[SwitchB] bgp 20
[SwitchB-bgp] peer 192.168.2.1 as-path-filter path-filter1 export
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 868
[SwitchB-bgp] peer 192.168.3.2 as-path-filter path-filter2 export
[SwitchB-bgp] quit
Step 5 Check the routing table advertised by SwitchB.
Check the routing table advertised by SwitchB to AS 30. You can find that the
direct route of AS 10 advertised by SwitchB does not exist.
[SwitchB] display bgp routing-table peer 192.168.3.2 advertised-routes
BGP Local router ID is 172.16.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 192.168.2.0 192.168.3.1 0 0 20?
*> 192.168.3.0 192.168.3.1 0 0 20?
Similarly, the BGP routing table of SwitchC does not have the route.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.16.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 8
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 0.0.0.0 0 0 ?
*> 10.1.1.1/32 0.0.0.0 0 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
*> 192.168.2.0 192.168.3.1 0 0 20?
*> 192.168.3.0 0.0.0.0 0 0 ?
192.168.3.1 0 0 20?
*> 192.168.3.2/32 0.0.0.0 0 0 ?
Check the routing table advertised by SwitchB to AS 10. You can find that the
direct route of AS 30 advertised by SwitchB does not exist.
[SwitchB] display bgp routing-table peer 192.168.2.1 advertised-routes
BGP Local router ID is 172.16.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 192.168.2.0 192.168.2.2 0 0 20?
*> 192.168.3.0 192.168.2.2 0 0 20?
Similarly, the BGP routing table of SwitchA does not have the route.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.16.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 869
Total Number of Routes: 8
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.1.0/24 0.0.0.0 0 0 ?
*> 10.0.1.1/32 0.0.0.0 0 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
*> 192.168.2.0 0.0.0.0 0 0 ?
192.168.2.2 0 0 20?
*> 192.168.2.1/32 0.0.0.0 0 0 ?
*> 192.168.3.0 192.168.2.2 0 0 20?
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.0.1.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 10
router-id 172.16.1.1
peer 192.168.2.2 as-number 20
#
ipv4-family unicast
undo synchronization
import-route direct
peer 192.168.2.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 20 30
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.3.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 20
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 870
router-id 172.16.2.2
peer 192.168.2.1 as-number 10
peer 192.168.3.2 as-number 30
#
ipv4-family unicast
undo synchronization
import-route direct
peer 192.168.2.1 enable
peer 192.168.2.1 as-path-filter path-filter1 export
peer 192.168.3.2 enable
peer 192.168.3.2 as-path-filter path-filter2 export
#
ip as-path-filter path-filter1 deny _30_
ip as-path-filter path-filter1 permit .*
ip as-path-filter path-filter2 deny _10_
ip as-path-filter path-filter2 permit .*
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 30 40
#
interface Vlanif30
ip address 192.168.3.2 255.255.255.0
#
interface Vlanif40
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 30
router-id 172.16.3.3
peer 192.168.3.1 as-number 20
#
ipv4-family unicast
undo synchronization
import-route direct
peer 192.168.3.1 enable
#
return
9.17.6 Example for Configuring MED Attributes to Control BGP
Route Selection
Networking Requirements
As shown in Figure 9-48, BGP is configured on all switches; SwitchA resides in AS
65008; SwitchB and SwitchC reside in AS 65009. EBGP connections are established
between SwitchA and SwitchB, and between SwitchA and SwitchC. An IBGP
connection is established between SwitchB and SwitchC. After a period, traffic
from AS 65008 to AS 65009 needs to first pass through SwitchC.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 871
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-48 Networking diagram of configuring MED attributes of routes to
control route selection
Configuration Roadmap
The configuration roadmap is as follows:
1. Establish EBGP connections between SwitchA and SwitchB and between
SwitchA and SwitchC, and establish an IBGP connection between SwitchB and
SwitchC.
2. Apply a routing policy to increase the MED value of the route sent by SwitchB
to SwitchA so that SwitchA will send traffic to AS 65009 through SwitchC.
Procedure
Step 1 Create VLANs and add interfaces to the corresponding VLANs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 872
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.2 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.2.2 24
[SwitchA-Vlanif20] quit
Step 3 Establish a BGP connection.
# Configure SwitchA.
[SwitchA] bgp 65008
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] peer 192.168.1.1 as-number 65009
[SwitchA-bgp] peer 192.168.2.1 as-number 65009
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] peer 192.168.1.2 as-number 65008
[SwitchB-bgp] peer 10.1.1.2 as-number 65009
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] network 10.1.1.0 255.255.255.0
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 65009
[SwitchC-bgp] router-id 172.16.3.3
[SwitchC-bgp] peer 192.168.2.2 as-number 65008
[SwitchC-bgp] peer 10.1.1.1 as-number 65009
[SwitchC-bgp] ipv4-family unicast
[SwitchC-bgp-af-ipv4] network 10.1.1.0 255.255.255.0
[SwitchC-bgp-af-ipv4] quit
[SwitchC-bgp] quit
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.16.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.1.1 0 0 65009i
* 192.168.2.1 0 0 65009i
According to the routing table, you can view that there are two valid routes
destined for 10.1.1.0/24. The route whose next hop is 192.168.1.1 is the optimal
route because the router ID of SwitchB is smaller.
Step 4 Configure load balancing.
# Configure SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 873
[SwitchA] bgp 65008
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] maximum load-balancing 2
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.16.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.1.1 0 0 65009i
*> 192.168.2.1 0 0 65009i
According to the routing table, you can view that the BGP route 10.1.1.0/24 has
two next hops that are 192.168.1.1 and 192.168.2.1. Both of them are optimal
routes.
Step 5 Set the MED.
# Set the MED sent from SwitchB to SwitchA through the policy.
[SwitchB] route-policy 10 permit node 10
[SwitchB-route-policy] apply cost 100
[SwitchB-route-policy] quit
[SwitchB] bgp 65009
[SwitchB-bgp] peer 192.168.1.2 route-policy 10 export
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.16.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.2.1 0 0 65009i
* 192.168.1.1 100 0 65009i
According to the routing table, you can view that the MED of the next hop
192.168.1.1 (SwitchB) is 100, and that of the next hop 192.168.2.1 is 0. Therefore,
the route with the smaller MED is selected.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif20
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 874
ip address 192.168.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 65008
router-id 172.16.1.1
peer 192.168.1.1 as-number 65009
peer 192.168.2.1 as-number 65009
#
ipv4-family unicast
undo synchronization
maximum load-balancing 2
peer 192.168.1.1 enable
peer 192.168.2.1 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 30
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface Vlanif30
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65009
router-id 172.16.2.2
peer 10.1.1.2 as-number 65009
peer 192.168.1.2 as-number 65008
#
ipv4-family unicast
undo synchronization
network 10.1.1.0 255.255.255.0
peer 10.1.1.2 enable
peer 192.168.1.2 enable
peer 192.168.1.2 route-policy 10 export
#
route-policy 10 permit node 10
apply cost 100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 30
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface Vlanif30
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 875
ip address 10.1.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65009
router-id 172.16.3.3
peer 10.1.1.1 as-number 65009
peer 192.168.2.2 as-number 65008
#
ipv4-family unicast
undo synchronization
network 10.1.1.0 255.255.255.0
peer 10.1.1.1 enable
peer 192.168.2.2 enable
#
return
9.17.7 Example for Configuring a BGP Route Reflector
Networking Requirements
In Figure 9-49, four switches belong to two ASs, SwitchA and SwitchB establish an
EBGP neighbor relationship, and SwitchC establishes an IBGP neighbor relationship
with SwitchB and SwitchD. To prevent IBGP fully meshed connections and simplify
network configurations, the user requires that devices in the two ASs
communicate when no IBGP connection is established between SwitchB and
SwitchD.
Figure 9-49 Networking diagram of configuring a BGP route reflector (RR)
Configuration Roadmap
The configuration roadmap is as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 876
1. Configure basic BGP functions to allow BGP neighbors to communicate.
2. Configure SwitchC as an RR and configure SwitchB and SwitchD as two clients
of the RR. Subsequently, SwitchB and SwitchD can learn the routes advertised
by SwitchA without establishing an IBGP connection, simplifying
configurations.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA, and are not mentioned here.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Configure IP addresses for interfaces and set the IP address of LoopBack0 on
SwitchA as the destination IP address of a ping test.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA, and are not mentioned here.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.10.10.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface LoopBack 0
[SwitchA-LoopBack0] ip address 192.168.10.1 32
[SwitchA-LoopBack0] quit
Step 3 Configure basic BGP functions and advertise direct network segments in the BGP
processes of the four switches.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer 10.10.10.2 as-number 200
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] network 192.168.10.1 32
[SwitchA-bgp-af-ipv4] network 10.10.10.0 24
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer 10.10.10.1 as-number 100
[SwitchB-bgp] peer 10.10.20.2 as-number 200
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] network 10.10.10.0 24
[SwitchB-bgp-af-ipv4] network 10.10.20.0 24
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] router-id 10.3.3.3
[SwitchC-bgp] peer 10.10.20.1 as-number 200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 877
[SwitchC-bgp] peer 10.10.30.2 as-number 200
[SwitchC-bgp] ipv4-family unicast
[SwitchC-bgp-af-ipv4] network 10.10.20.0 24
[SwitchC-bgp-af-ipv4] network 10.10.30.0 24
[SwitchC-bgp-af-ipv4] quit
[SwitchC-bgp] quit
# Configure SwitchD.
[SwitchD] bgp 200
[SwitchD-bgp] router-id 10.4.4.4
[SwitchD-bgp] peer 10.10.30.1 as-number 200
[SwitchD-bgp] ipv4-family unicast
[SwitchD-bgp-af-ipv4] network 10.10.30.0 24
[SwitchD-bgp-af-ipv4] quit
[SwitchD-bgp] quit
Step 4 Configure an RR.
# Configure SwitchC as an RR and configure SwitchB and SwitchD as two clients
of the RR.
[SwitchC] bgp 200
[SwitchC-bgp] ipv4-family unicast
[SwitchC-bgp-af-ipv4] peer 10.10.20.1 reflect-client
[SwitchC-bgp-af-ipv4] peer 10.10.30.2 reflect-client
[SwitchC-bgp-af-ipv4] quit
[SwitchC-bgp] quit
Step 5 Verify the configuration.
# Check the BGP routing table of SwitchB.
[SwitchB] display bgp routing-table 192.168.10.1 32
BGP local router ID : 10.2.2.2
Local AS number : 200
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 192.168.10.1/32:
From: 10.10.10.1 (10.1.1.1)
Route Duration: 00h34m09s
Direct Out-interface: Vlanif10
Original nexthop: 10.10.10.1
Qos information : 0x0
AS-path 100, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 1 peers:
10.10.20.2
The command output shows that SwitchB has learned and advertised the route
192.168.10.1/32 to SwitchC.
# Check the BGP routing table of SwitchC.
[SwitchC] display bgp routing-table 192.168.10.1 32
BGP local router ID : 10.3.3.3
Local AS number : 200
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 192.168.10.1/32:
RR-client route.
From: 10.10.20.1 (10.2.2.2)
Route Duration: 00h34m17s
Relay IP Nexthop: 10.10.20.1
Relay IP Out-Interface: Vlanif20
Original nexthop: 10.10.10.1
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 2 peers:
10.10.20.1
10.10.30.2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 878
The command output shows that SwitchC has learned and advertised the route
192.168.10.1/32 to its two clients SwitchB and SwitchD.
# Check the BGP routing table of SwitchD.
[SwitchD] display bgp routing-table 192.168.10.1 32
BGP local router ID : 10.4.4.4
Local AS number : 200
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 192.168.10.1/32:
From: 10.10.30.1 (10.3.3.3)
Route Duration: 00h34m25s
Relay IP Nexthop: 10.10.30.1
Relay IP Out-Interface: Vlanif30
Original nexthop: 10.10.10.1
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Originator: 10.2.2.2
Cluster list: 10.3.3.3
Not advertised to any peer yet
The command output shows that SwitchD has learned from SwitchC the route
192.168.10.1/32 advertised by SwitchA.
# On SwitchD, ping the IP address of LoopBack0 on SwitchA to test route
reachability.
[SwitchD] ping 192.168.10.1
PING 192.168.10.1: 56 data bytes, press CTRL_C to break
Reply from 192.168.10.1: bytes=56 Sequence=1 ttl=255 time=31 ms
Reply from 192.168.10.1: bytes=56 Sequence=2 ttl=255 time=16 ms
Reply from 192.168.10.1: bytes=56 Sequence=3 ttl=255 time=40 ms
Reply from 192.168.10.1: bytes=56 Sequence=4 ttl=255 time=30 ms
Reply from 192.168.10.1: bytes=56 Sequence=5 ttl=255 time=26 ms
--- 192.168.10.1 ping statistics ---
5 packet(s) transmitted
5 packet(s) received
0.00% packet loss
round-trip min/avg/max = 70/84/100 ms
The command output shows that SwitchD pings the IP address of LoopBack0 on
SwitchA successfully, indicating that routes to SwitchA are reachable.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10
#
interface Vlanif10
ip address 10.10.10.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface LoopBack0
ip address 192.168.10.1 255.255.255.255
#
bgp 100
router-id 10.1.1.1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 879
peer 10.10.10.2 as-number 200
#
ipv4-family unicast
undo synchronization
network 10.10.10.0 255.255.255.0
network 192.168.10.1 255.255.255.255
peer 10.10.10.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.10.10.2 255.255.255.0
#
interface Vlanif20
ip address 10.10.20.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 200
router-id 10.2.2.2
peer 10.10.10.1 as-number 100
peer 10.10.20.2 as-number 200
#
ipv4-family unicast
undo synchronization
network 10.10.10.0 255.255.255.0
network 10.10.20.0 255.255.255.0
peer 10.10.10.1 enable
peer 10.10.20.2 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 30
#
interface Vlanif20
ip address 10.10.20.2 255.255.255.0
#
interface Vlanif30
ip address 10.10.30.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 200
router-id 10.3.3.3
peer 10.10.20.1 as-number 200
peer 10.10.30.2 as-number 200
#
ipv4-family unicast
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 880
undo synchronization
network 10.10.20.0 255.255.255.0
network 10.10.30.0 255.255.255.0
peer 10.10.20.1 enable
peer 10.10.20.1 reflect-client
peer 10.10.30.2 enable
peer 10.10.30.2 reflect-client
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30
#
interface Vlanif30
ip address 10.10.30.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 200
router-id 10.4.4.4
peer 10.10.30.1 as-number 200
#
ipv4-family unicast
undo synchronization
network 10.10.30.0 255.255.255.0
peer 10.10.30.1 enable
#
return
9.17.8 Example for Configuring a BGP4+ Route Reflector
Networking Requirements
As shown in Figure 9-50, four devices belong to two ASs. You are required to
perform simplified configuration to ensure that the two ASs communicate with
each other.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 881
Figure 9-50 Networking diagram of configuring a BGP4+ route reflector
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic BGP4+ functions to allow BGP neighbors to communicate.
2. Configure SwitchC as a route reflector so that no IBGP connection needs to be
established between SwitchB and SwitchD. This simplifies the configuration.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Enable the IPv6 forwarding capability, and assign an IPv6 address for each
interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] ipv6
[SwitchA] interface vlanif 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 882
[SwitchA-Vlanif10] ipv6 enable
[SwitchA-Vlanif10] ipv6 address fc00:0:0:0:1::1/64
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ipv6 enable
[SwitchA-Vlanif20] ipv6 address fc00:0:0:0:10::1/96
[SwitchA-Vlanif20] quit
Step 3 Configure basic BGP4+ functions.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer fc00:0:0:0:10::2 as-number 200
[SwitchA-bgp] ipv6-family unicast
[SwitchA-bgp-af-ipv6] peer fc00:0:0:0:10::2 enable
[SwitchA-bgp-af-ipv6] network fc00:0:0:0:1:: 64
[SwitchA-bgp-af-ipv6] network fc00:0:0:0:10:: 96
[SwitchA-bgp-af-ipv6] quit
# Configure SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer fc00:0:0:0:10::1 as-number 100
[SwitchB-bgp] peer fc00:0:0:0:11::1 as-number 200
[SwitchB-bgp] ipv6-family unicast
[SwitchB-bgp-af-ipv6] peer fc00:0:0:0:10::1 enable
[SwitchB-bgp-af-ipv6] peer fc00:0:0:0:11::1 enable
[SwitchB-bgp-af-ipv6] network fc00:0:0:0:10:: 96
[SwitchB-bgp-af-ipv6] network fc00:0:0:0:11:: 96
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] router-id 10.3.3.3
[SwitchC-bgp] peer fc00:0:0:0:11::2 as-number 200
[SwitchC-bgp] peer fc00:0:0:0:12::2 as-number 200
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer fc00:0:0:0:11::2 enable
[SwitchC-bgp-af-ipv6] peer fc00:0:0:0:12::2 enable
[SwitchC-bgp-af-ipv6] network fc00:0:0:0:11:: 96
[SwitchC-bgp-af-ipv6] network fc00:0:0:0:12:: 96
[SwitchC-bgp-af-ipv6] quit
# Configure SwitchD.
[SwitchD] bgp 200
[SwitchD-bgp] router-id 10.4.4.4
[SwitchD-bgp] peer fc00:0:0:0:12::1 as-number 200
[SwitchD-bgp] ipv6-family unicast
[SwitchD-bgp-af-ipv6] peer fc00:0:0:0:12::1 enable
[SwitchD-bgp-af-ipv6] network fc00:0:0:0:12:: 96
[SwitchD-bgp-af-ipv6] quit
[SwitchD-bgp] quit
Step 4 Configure the route reflector.
# Configure SwitchC as the route reflector and SwitchB and SwitchD as the clients.
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer fc00:0:0:0:11::2 reflect-client
[SwitchC-bgp-af-ipv6] peer fc00:0:0:0:12::2 reflect-client
# View the routing table of SwitchB.
[SwitchB] display bgp ipv6 routing-table
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 883
BGP Local router ID is 10.2.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
*> Network : 1:: PrefixLen : 64
NextHop : FC00:0:0:0:10::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 100 i
*> Network : FC00:0:0:0:10:: PrefixLen : 96
NextHop : :: LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
NextHop : FC00:0:0:0:10::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 100 i
*> Network : FC00:0:0:0:11:: PrefixLen : 96
NextHop : :: LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
i
NextHop : FC00:0:0:0:11::1 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
*>i Network : FC00:0:0:0:12:: PrefixLen : 96
NextHop : FC00:0:0:0:11::1 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
# View the routing table of SwitchD.
[SwitchD] display bgp ipv6 routing-table
BGP Local router ID is 10.4.4.4
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
*>i Network : FC00:0:0:1:: PrefixLen : 64
NextHop : FC00:0:0:10::1 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : 100 i
*>i Network : FC00:0:0:10:: PrefixLen : 96
NextHop : FC00:0:0:11::2 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
*>i Network : FC00:0:0:11:: PrefixLen : 96
NextHop : FC00:0:0:12::1 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
*> Network : FC00:0:0:12:: PrefixLen : 96
NextHop : :: LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
i
NextHop : FC00:0:0:12::1 LocPrf : 100
MED : 0 PrefVal : 0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 884
Label :
Path/Ogn : i
The routing tables show that SwitchD and SwitchB have learned the routing
information advertised by SwitchA from SwitchC.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
vlan batch 10 20
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:1::1/64
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:10::1/96
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 100
router-id 10.1.1.1
peer FC00:0:0:10::2 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:1:: 64
network FC00:0:0:10:: 96
peer FC00:0:0:10::2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
vlan batch 20 30
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:10::2/96
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:11::2/96
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 885
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 200
router-id 10.2.2.2
peer FC00:0:0:10::1 as-number 100
peer FC00:0:0:11::1 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:10:: 96
network FC00:0:0:11:: 96
peer FC00:0:0:10::1 enable
peer FC00:0:0:11::1 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 30 40
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:11::1/96
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:12::1/96
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 200
router-id 10.3.3.3
peer FC00:0:0:11::2 as-number 200
peer FC00:0:0:12::2 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:11:: 96
network FC00:0:0:12:: 96
peer FC00:0:0:11::2 enable
peer FC00:0:0:11::2 reflect-client
peer FC00:0:0:12::2 enable
peer FC00:0:0:12::2 reflect-client
#
return
● SwitchD configuration file
#
sysname SwitchD
#
ipv6
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 886
#
vlan batch 40
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:12::2/96
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
bgp 200
router-id 10.4.4.4
peer FC00:0:0:12::1 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:12:: 96
peer FC00:0:0:12::1 enable
#
return
9.17.9 Example for Configuring a BGP Confederation
Networking Requirements
In Figure 9-51, there are multiple BGP switches in AS 200. It is required that the
number of IBGP connections be reduced.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 887
Figure 9-51 Networking diagram of configuring a BGP confederation
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure a BGP confederation on each switch in AS 200 to divide AS 200 into
three sub-ASs: AS 65001, AS 65002, and AS 65003. Three switches in AS
65001 establish full-mesh IBGP connections to reduce the number of IBGP
connections.
Procedure
Step 1 Create VLANs and add interfaces to the corresponding VLANs.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20 30 40 60
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
[SwitchA] interface gigabitethernet 0/0/3
[SwitchA-GigabitEthernet0/0/3] port link-type trunk
[SwitchA-GigabitEthernet0/0/3] port trunk allow-pass vlan 30
[SwitchA-GigabitEthernet0/0/3] quit
[SwitchA] interface gigabitethernet 0/0/4
[SwitchA-GigabitEthernet0/0/4] port link-type trunk
[SwitchA-GigabitEthernet0/0/4] port trunk allow-pass vlan 40
[SwitchA-GigabitEthernet0/0/4] quit
[SwitchA] interface gigabitethernet 0/0/5
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 888
[SwitchA-GigabitEthernet0/0/5] port link-type trunk
[SwitchA-GigabitEthernet0/0/5] port trunk allow-pass vlan 60
[SwitchA-GigabitEthernet0/0/5] quit
The configurations of SwitchB, SwitchC, SwitchD, SwitchE, and SwitchF are similar
to the configuration of SwitchA, and are not mentioned here.
Step 2 Assign an IP address to each VLANIF interface.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 10.1.2.1 24
[SwitchA-Vlanif20] quit
[SwitchA] interface vlanif 30
[SwitchA-Vlanif30] ip address 10.1.3.1 24
[SwitchA-Vlanif30] quit
[SwitchA] interface vlanif 40
[SwitchA-Vlanif40] ip address 10.1.4.1 24
[SwitchA-Vlanif40] quit
[SwitchA] interface vlanif 60
[SwitchA-Vlanif60] ip address 192.168.1.1 24
[SwitchA-Vlanif60] quit
The configurations of SwitchB, SwitchC, SwitchD, SwitchE, and SwitchF are similar
to the configuration of SwitchA, and are not mentioned here.
Step 3 Configure the BGP confederation.
# Configure SwitchA.
[SwitchA] bgp 65001
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] confederation id 200
[SwitchA-bgp] confederation peer-as 65002 65003
[SwitchA-bgp] peer 10.1.1.2 as-number 65002
[SwitchA-bgp] peer 10.1.2.2 as-number 65003
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] peer 10.1.1.2 next-hop-local
[SwitchA-bgp-af-ipv4] peer 10.1.2.2 next-hop-local
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65002
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] confederation id 200
[SwitchB-bgp] confederation peer-as 65001 65003
[SwitchB-bgp] peer 10.1.1.1 as-number 65001
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 65003
[SwitchC-bgp] router-id 172.16.3.3
[SwitchC-bgp] confederation id 200
[SwitchC-bgp] confederation peer-as 65001 65002
[SwitchC-bgp] peer 10.1.2.1 as-number 65001
[SwitchC-bgp] quit
Step 4 Establish IBGP connection in AS 65001.
# Configure SwitchA.
[SwitchA] bgp 65001
[SwitchA-bgp] peer 10.1.3.2 as-number 65001
[SwitchA-bgp] peer 10.1.4.2 as-number 65001
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 889
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] peer 10.1.3.2 next-hop-local
[SwitchA-bgp-af-ipv4] peer 10.1.4.2 next-hop-local
[SwitchA-bgp-af-ipv4] quit
# Configure SwitchD.
[SwitchD] bgp 65001
[SwitchD-bgp] router-id 172.16.4.4
[SwitchD-bgp] peer 10.1.3.1 as-number 65001
[SwitchD-bgp] peer 10.1.5.2 as-number 65001
[SwitchD-bgp] quit
# Configure SwitchE.
[SwitchE] bgp 65001
[SwitchE-bgp] router-id 172.16.5.5
[SwitchE-bgp] peer 10.1.4.1 as-number 65001
[SwitchE-bgp] peer 10.1.5.1 as-number 65001
[SwitchE-bgp] quit
Step 5 Establish an EBGP connection between AS 100 and AS 200.
# Configure SwitchA.
[SwitchA] bgp 65001
[SwitchA-bgp] peer 192.168.1.2 as-number 100
[SwitchA-bgp] quit
# Configure SwitchF.
[SwitchF] bgp 100
[SwitchF-bgp] router-id 172.16.6.6
[SwitchF-bgp] peer 192.168.1.1 as-number 200
[SwitchF-bgp] ipv4-family unicast
[SwitchF-bgp-af-ipv4] network 10.0.1.0 255.255.255.0
[SwitchF-bgp-af-ipv4] quit
[SwitchF-bgp] quit
Step 6 Verify the configuration.
# Check the BGP routing table of SwitchB.
[SwitchB] display bgp routing-table
BGP Local router ID is 172.16.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.0.1.0/24 10.1.1.1 0 100 0 (65001) 100i
[SwitchB] display bgp routing-table 10.0.1.0
BGP local router ID : 172.16.2.2
Local AS number : 65002
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.0.1.0/24:
From: 10.1.1.1 (172.16.1.1)
Route Duration: 00h01m22s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: Vlanif10
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path (65001) 100, origin igp, MED 0, localpref 100, pref-val 0, valid, external-confed, best,select, active,
pre 255
Not advertised to any peer yet
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 890
# Check the BGP routing table of SwitchD.
[SwitchD] display bgp routing-table
BGP Local router ID is 172.16.4.4
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.0.1.0/24 10.1.3.1 0 100 0 100i
[SwitchD] display bgp routing-table 10.0.1.0
BGP local router ID : 172.16.4.4
Local AS number : 65001
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.0.1.0/24:
From: 10.1.3.1 (172.16.1.1)
Route Duration: 00h18m34s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: Vlanif30
Original nexthop: 10.1.3.1
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best,select, active, pre 255
Not advertised to any peer yet
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20 30 40 60
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
#
interface Vlanif20
ip address 10.1.2.1 255.255.255.0
#
interface Vlanif30
ip address 10.1.3.1 255.255.255.0
#
interface Vlanif40
ip address 10.1.4.1 255.255.255.0
#
interface Vlanif60
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/4
port link-type trunk
port trunk allow-pass vlan 40
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 891
#
interface GigabitEthernet0/0/5
port link-type trunk
port trunk allow-pass vlan 60
#
bgp 65001
router-id 172.16.1.1
confederation id 200
confederation peer-as 65002 65003
peer 10.1.1.2 as-number 65002
peer 10.1.2.2 as-number 65003
peer 10.1.3.2 as-number 65001
peer 10.1.4.2 as-number 65001
peer 192.168.1.2 as-number 100
#
ipv4-family unicast
undo synchronization
peer 10.1.1.2 enable
peer 10.1.1.2 next-hop-local
peer 10.1.2.2 enable
peer 10.1.2.2 next-hop-local
peer 10.1.3.2 enable
peer 10.1.3.2 next-hop-local
peer 10.1.4.2 enable
peer 10.1.4.2 next-hop-local
peer 192.168.1.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
bgp 65002
router-id 172.16.2.2
confederation id 200
confederation peer-as 65001 65003
peer 10.1.1.1 as-number 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.1.1 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20
#
interface Vlanif20
ip address 10.1.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 65003
router-id 172.16.3.3
confederation id 200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 892
confederation peer-as 65001 65002
peer 10.1.2.1 as-number 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.2.1 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30 50
#
interface Vlanif30
ip address 10.1.3.2 255.255.255.0
#
interface Vlanif50
ip address 10.1.5.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 65001
router-id 172.16.4.4
peer 10.1.3.1 as-number 65001
peer 10.1.5.2 as-number 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.3.1 enable
peer 10.1.5.2 enable
#
return
● SwitchE configuration file
#
sysname SwitchE
#
vlan batch 40 50
#
interface Vlanif40
ip address 10.1.4.2 255.255.255.0
#
interface Vlanif50
ip address 10.1.5.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 65001
router-id 172.16.5.5
peer 10.1.4.1 as-number 65001
peer 10.1.5.1 as-number 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.4.1 enable
peer 10.1.5.1 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 893
#
return
● SwitchF configuration file
#
sysname SwitchF
#
vlan batch 60 70
#
interface Vlanif60
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif70
ip address 10.0.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 60
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 70
#
bgp 100
router-id 172.16.6.6
peer 192.168.1.1 as-number 200
#
ipv4-family unicast
undo synchronization
network 10.0.1.0 255.255.255.0
peer 192.168.1.1 enable
#
return
9.17.10 Example for Configuring the BGP Community
Attribute
Networking Requirements
As shown in Figure 9-52, EBGP connections are established between SwitchB and
SwitchA, and between SwitchB and SwitchC. It is required that the routes
advertised from AS 10 to AS 20 are not advertised to other ASs by AS 20.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 894
Figure 9-52 Networking diagram of configuring the BGP community
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure a route-policy on SwitchA to advertise the No_Export attribute so
that AS 20 does not advertise the routes received from AS 10 to other ASs.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.2.1 24
[SwitchA-Vlanif20] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 895
Step 3 Configure EBGP.
# ConfigureSwitchA.
[SwitchA] bgp 10
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] peer 192.168.2.2 as-number 20
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] network 10.1.1.0 255.255.255.0
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 20
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] peer 192.168.2.1 as-number 10
[SwitchB-bgp] peer 192.168.3.2 as-number 30
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 30
[SwitchC-bgp] router-id 172.16.3.3
[SwitchC-bgp] peer 192.168.3.1 as-number 20
[SwitchC-bgp] quit
# Check the routing table of SwitchB.
[SwitchB] display bgp routing-table 10.1.1.0
BGP local router ID : 172.16.2.2
Local AS number : 20
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.2.1 (172.16.1.1)
Route Duration: 00h00m15s
Direct Out-interface: Vlanif20
Original nexthop: 192.168.2.1
Qos information : 0x0
AS-path 10, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
192.168.2.1
192.168.3.2
You can view that SwitchB advertises the received routes to SwitchC in AS 30.
# Check the routing table of SwitchC.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.16.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.3.1 0 20 10i
You can find that SwitchC has learned a route to the destination 10.1.1.0/24 from
SwitchB.
Step 4 Configure BGP community attributes.
# Configure the routing policy on SwitchA to enable SwitchB not to advertise the
routes advertised by SwitchA to any other AS.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 896
[SwitchA] route-policy comm_policy permit node 10
[SwitchA-route-policy] apply community no-export
[SwitchA-route-policy] quit
# Apply routing policies.
[SwitchA] bgp 10
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] peer 192.168.2.2 route-policy comm_policy export
[SwitchA-bgp-af-ipv4] peer 192.168.2.2 advertise-community
# Check the routing table of SwitchB.
[SwitchB] display bgp routing-table 10.1.1.0
BGP local router ID : 172.16.2.2
Local AS number : 20
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.2.1 (172.16.1.1)
Route Duration: 00h00m33s
Direct Out-interface: Vlanif20
Original nexthop: 192.168.2.1
Qos information : 0x0
Community:no-export
AS-path 10, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
Not advertised to any peer yet
You can view the configured community attribute in the BGP routing table of
SwitchB. At this time, there are no routes to the destination 10.1.1.0/24 in the BGP
routing table of SwitchC.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 10
router-id 172.16.1.1
peer 192.168.2.2 as-number 20
#
ipv4-family unicast
undo synchronization
network 10.1.1.0 255.255.255.0
peer 192.168.2.2 enable
peer 192.168.2.2 route-policy comm_policy export
peer 192.168.2.2 advertise-community
#
route-policy comm_policy permit node 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 897
apply community no-export
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 20 30
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.3.1 255.255.255.0
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 20
router-id 172.16.2.2
peer 192.168.2.1 as-number 10
peer 192.168.3.2 as-number 30
#
ipv4-family unicast
undo synchronization
peer 192.168.2.1 enable
peer 192.168.3.2 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan 30
#
interface Vlanif30
ip address 192.168.3.2 255.255.255.0
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 30
router-id 172.16.3.3
peer 192.168.3.1 as-number 20
#
ipv4-family unicast
undo synchronization
peer 192.168.3.1 enable
#
return
9.17.11 Example for Configuring BGP Load Balancing
Networking Requirements
On the network shown in Figure 9-53, BGP is configured on all switches. SwitchA
is in AS 100. SwitchB and SwitchC are in AS 300. SwitchD is in AS 200. Network
congestion from SwitchA to destination address 10.1.1.0/24 needs to be relieved
and network resources need to be fully utilized.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 898
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-53 Networking diagram of configuring BGP load balancing
Configuration Roadmap
The configuration roadmap is as follows:
1. Establish EBGP connections between SwitchA and SwitchB and between
SwitchA and SwitchC, between SwitchD and SwitchB and between SwitchD
and SwitchC to enable ASs to communicate with each other using BGP.
2. Configuring load balancing on SwitchA so that SwitchA can send traffic to
SwitchD through either SwitchB or SwitchC.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 899
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.2.1 24
[SwitchA-Vlanif20] quit
Step 3 Establish BGP connections.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] peer 192.168.1.2 as-number 300
[SwitchA-bgp] peer 192.168.2.2 as-number 300
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 300
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] peer 192.168.1.1 as-number 100
[SwitchB-bgp] peer 192.168.3.1 as-number 200
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 300
[SwitchC-bgp] router-id 172.16.3.3
[SwitchC-bgp] peer 192.168.2.1 as-number 100
[SwitchC-bgp] peer 192.168.4.1 as-number 200
[SwitchC-bgp] quit
# Configure SwitchD.
[SwitchD] bgp 200
[SwitchD-bgp] router-id 172.16.4.4
[SwitchD-bgp] peer 192.168.3.2 as-number 300
[SwitchD-bgp] peer 192.168.4.2 as-number 300
[SwitchD-bgp] ipv4-family unicast
[SwitchD-bgp-af-ipv4] network 10.1.1.0 255.255.255.0
[SwitchD-bgp-af-ipv4] quit
[SwitchD-bgp] quit
# View the routing table of SwitchA.
[SwitchA] display bgp routing-table 10.1.1.0 24
BGP local router ID : 172.16.1.1
Local AS number : 100
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.1.2 (172.16.2.2)
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 900
Route Duration: 0d00h00m50s
Direct Out-interface: Vlanif10
Original nexthop: 192.168.1.2
Qos information : 0x0
AS-path 300 200, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
192.168.2.2
192.168.1.2
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.2.2 (172.16.3.3)
Route Duration: 0d00h00m51s
Direct Out-interface: Vlanif20
Original nexthop: 192.168.2.2
Qos information : 0x0
AS-path 300 200, origin igp, pref-val 0, valid, external, pre 255, not preferred for router ID
Not advertised to any peer yet
The preceding command output shows that there are two valid routes from
SwitchA to destination 10.1.1.0/24. The route with the next-hop address of
192.168.1.2 is the optimal route because the router ID of SwitchB is smaller.
Step 4 Configure BGP load balancing.
# Configure load balancing on SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] maximum load-balancing 2
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
Step 5 Verify the configuration.
# View the routing table of SwitchA.
[SwitchA] display bgp routing-table 10.1.1.0 24
BGP local router ID : 172.16.1.1
Local AS number : 100
Paths: 2 available, 1 best, 2 select
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.1.2 (172.16.2.2)
Route Duration: 0d00h03m55s
Direct Out-interface: Vlanif10
Original nexthop: 192.168.1.2
Qos information : 0x0
AS-path 300 200, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
192.168.2.2
192.168.1.2
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.2.2 (172.16.3.3)
Route Duration: 0d00h03m56s
Direct Out-interface: Vlanif20
Original nexthop: 192.168.2.2
Qos information : 0x0
AS-path 300 200, origin igp, pref-val 0, valid, external, select, active, pre 255, not preferred for router ID
Not advertised to any peer yet
The preceding command output shows that BGP route 10.1.1.0/24 has two next
hops: 192.168.1.2 and 192.168.2.2. Both of them are optimal routes.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 901
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 100
router-id 172.16.1.1
peer 192.168.1.2 as-number 300
peer 192.168.2.2 as-number 300
#
ipv4-family unicast
undo synchronization
maximum load-balancing 2
peer 192.168.1.2 enable
peer 192.168.2.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 30
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.3.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 300
router-id 172.16.2.2
peer 192.168.1.1 as-number 100
peer 192.168.3.1 as-number 200
#
ipv4-family unicast
undo synchronization
peer 192.168.1.1 enable
peer 192.168.3.1 enable
#
return
● SwitchC configuration file
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 902
#
sysname SwitchC
#
vlan batch 20 40
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif40
ip address 192.168.4.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 300
router-id 172.16.3.3
peer 192.168.2.1 as-number 100
peer 192.168.4.1 as-number 200
#
ipv4-family unicast
undo synchronization
peer 192.168.2.1 enable
peer 192.168.4.1 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30 40 50
#
interface Vlanif30
ip address 192.168.3.1 255.255.255.0
#
interface Vlanif40
ip address 192.168.4.1 255.255.255.0
#
interface Vlanif50
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 200
router-id 172.16.4.4
peer 192.168.3.2 as-number 300
peer 192.168.4.2 as-number 300
#
ipv4-family unicast
undo synchronization
network 10.1.1.0 255.255.255.0
peer 192.168.3.2 enable
peer 192.168.4.2 enable
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 903
9.17.12 Example for Configuring a BGP Routing Policy
Networking Requirements
Figure 9-54 shows the simplified MPLS network that carries multiple types of
L3VPN services, such as multimedia, signaling, and accounting. In Figure 9-54,
two sites, each of which has two PEs accessing the core layer, are taken as an
example. The core layer is divided into two planes. All the P nodes on the same
plane are full-meshed P nodes. Nodes on different planes are connected to
provide backup paths across plane. MP-BGP is used to advertise inner labels and
VPNv4 routes between the PEs. All PEs set up MP-IBGP peer relationships with the
RR.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-54 Networking diagram
NOTE
Figure 9-54 is a simplified networking diagram, in which two sites are taken as an example
and each plane takes three P nodes and one RR as an example. In the actual network, there
are 14 sites with 28 PEs and each plane has four P nodes and two RR nodes, and each RR
needs to set up MP-IBGP connections with 28 PEs.
In Figure 9-54, each PE sends BGP Update messages to the RR, other PEs receive
BGP Update messages from different planes. Therefore, routing policies need to be
deployed to ensure that one VPN flow is transmitted only through one plane.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 904
Data Plan
Table 9-32 IP addresses of interconnected interfaces
Link
Name
(Local
End-
Remote
End)
Local Interface and IP Address Remote Interface and IP
Address
P1–P3 GE1/0/0
VLANIF10: 10.1.1.1/30
GE1/0/0
VLANIF10: 10.1.1.2/30
P1–P5 GE2/0/0
VLANIF20: 10.1.2.1/30
GE1/0/0
VLANIF20: 10.1.2.2/30
P1–RR GE3/0/0
VLANIF30: 10.1.3.1/30
GE1/0/0
VLANIF30: 10.1.3.2/30
P1–P2 GE4/0/0
VLANIF40: 10.1.4.1/30
GE1/0/0
VLANIF40: 10.1.4.2/30
P1–PE1 GE5/0/0
VLANIF50: 10.1.5.1/30
GE1/0/0
VLANIF50: 10.1.5.2/30
P2–P6 GE4/0/0
VLANIF80: 10.1.6.1/30
GE1/0/0
VLANIF80: 10.1.6.2/30
P2–P4 GE3/0/0
VLANIF70: 10.1.7.1/30
GE1/0/0
VLANIF70: 10.1.7.2/30
P2–RR GE2/0/0
VLANIF60: 10.1.8.1/30
GE2/0/0
VLANIF60: 10.1.8.2/30
P2–PE2 GE5/0/0
VLANIF90: 10.1.9.1/30
GE1/0/0
VLANIF90: 10.1.9.2/30
P3–P5 GE2/0/0
VLANIF110: 10.1.10.1/30
GE2/0/0
VLANIF110: 10.1.10.2/30
P3–P4 GE3/0/0
VLANIF120: 10.1.11.1/30
GE2/0/0
VLANIF120: 10.1.11.2/30
P3–PE3 GE4/0/0
VLANIF130: 10.1.12.1/30
GE1/0/0
VLANIF130: 10.1.12.2/30
P4–P6 GE3/0/0
VLANIF150: 10.1.13.1/30
GE3/0/0
VLANIF150: 10.1.13.2/30
P4–PE4 GE4/0/0
VLANIF160: 10.1.14.1/30
GE1/0/0
VLANIF160: 10.1.14.2/30
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 905
Link
Name
(Local
End-
Remote
End)
Local Interface and IP Address Remote Interface and IP
Address
P5–P6 GE3/0/0
VLANIF170: 10.1.15.1/30
GE2/0/0
VLANIF170: 10.1.15.2/30
PE1–PE2 GE2/0/0
VLANIF100: 10.1.16.1/30
GE2/0/0
VLANIF100: 10.1.16.2/30
PE3–PE4 GE2/0/0
VLANIF140: 10.1.17.1/30
GE2/0/0
VLANIF140: 10.1.17.2/30
Table 9-33 IP addresses of loopback interfaces
Local Device IP Address of the
local Loopback 0
Interface
Remote Device IP Address of the
Remote
Loopback 0
Interface
P1 10.1.1.9/32 P2 10.2.2.9/32
P3 10.3.3.9/32 P4 10.4.4.9/32
P5 10.5.5.9/32 P6 10.6.6.9/32
PE1 10.7.7.9/32 PE2 10.8.8.9/32
PE3 10.9.9.9/32 PE4 10.10.10.9/32
RR 10.11.11.9/32 - -
Table 9-34 BGP parameter Value
BGP Parameter Value
AS number 65000
Router ID Same as the address of Loopback 0
interface
BGP community attribute Plane A: 65000:100
Plane B: 65000:200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 906
BGP Parameter Value
BGP local preference Plane A: The local preference of
community attribute 65000:100 is set
to 200.
Plane B: The local preference of
community attribute 65000:200 is set
to 200.
NOTE
By default, the BGP local preference is 100.
The greater the value, the higher the
preference.
Routing policy name Route import policy: local_pre
Route export policy: comm
Community filter name 1
BGP peer group name Client
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure different RDs for two PEs in the same site to ensure that each PE
can receive two routes from different BGP next hops in the remote site. When
two PEs in a site advertise the routes to the same destination, configuring
different RDs for the two PEs can ensure that BGP peers consider the
advertised routes as two different routes. This is because BGP-VPNv4 uses the
VPNv4 addresses that consist of IPv4 addresses and RDs.
2. Assign different communities for BGP routes from PE in plane A and BGP
routes from PE in plane B.
3. Set different local preferences for routes based on the community attributes
of the routes. In this manner, the PEs in plane A choose the routes advertised
by remote PEs in plane A, and the PEs in plane B always choose the routes
advertised by the remote PEs in plane B.
Procedure
Step 1 Configure names for devices and IP addresses for interfaces.
For detailed configurations, see the configuration files of this example.
Step 2 Configure an IGP.
In this example, IS-IS is used as an IGP. For detailed configurations, see the
configuration files of this example.
After the configuration, run the display ip routing-table command. You can view
that PEs, Ps and PEs, and Ps have learned the addresses of Loopback 0 interfaces
from each other.
Step 3 Establish MP-IBGP connections between the PEs and RR.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 907
# Take the configuration of PE1 as an example. Configurations of other PEs are
similar to that of PE1, and are not mentioned here.
[PE1] bgp 65000
[PE1-bgp] peer 10.11.11.9 as-number 65000
[PE1-bgp] peer 10.11.11.9 connect-interface LoopBack0
[PE1-bgp] ipv4-family unicast
[PE1-bgp-af-ipv4] undo peer 10.11.11.9 enable
[PE1-bgp-af-ipv4] quit
[PE1-bgp] ipv4-family vpnv4
[PE1-bgp-af-vpnv4] peer 10.11.11.9 enable
# Configure the RR.
[RR] bgp 65000
[RR-bgp] group client internal
[RR-bgp] peer client connect-interface LoopBack0
[RR-bgp] ipv4-family unicast
[RR-bgp-af-ipv4] undo peer client enable
[RR-bgp-af-ipv4] quit
[RR-bgp] ipv4-family vpnv4
[RR-bgp-af-vpnv4] undo policy vpn-target
[RR-bgp-af-vpnv4] peer client enable
[RR-bgp-af-vpnv4] peer 10.7.7.9 group client
[RR-bgp-af-vpnv4] peer 10.8.8.9 group client
[RR-bgp-af-vpnv4] peer 10.9.9.9 group client
[RR-bgp-af-vpnv4] peer 10.10.10.9 group client
[RR-bgp-af-vpnv4] peer client reflect-client
NOTE
You need to run the undo policy vpn-target command in the BGP-VPNv4 address family
view of the RR to ensure that VPN-target-based filtering is not performed on VPNv4 routes.
By default, an RR performs VPN-target-based filtering on the received VPNv4 routes. The
matching routes are added to the VPN routing table, and the other routes are discarded. In
this example, VPN instances are not configured on the RR. As a result, if VPN-target-based
filtering is enabled, all the received VPNv4 routes will be discarded.
After the configuration, run the display bgp vpnv4 all peer command on the RR.
You can view that the RR sets up MP-IBGP peers with all PEs.
[RR] display bgp vpnv4 all peer
BGP local router ID : 10.11.11.9
Local AS number : 65000
Total number of peers : 4 Peers in established state : 4
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
10.7.7.9 4 65000 79 82 0 00:01:31 Established 0
10.8.8.9 4 65000 42 66 0 00:01:16 Established 0
10.9.9.9 4 65000 21 34 0 00:00:50 Established 0
10.10.10.9 4 65000 2 4 0 00:00:21 Established 0
Step 4 Configure a routing policy.
NOTE
Take the configurations of PE1, PE2, and the RR as an example. The configurations of PE3
and PE4 are similar to the configurations of PE1 and PE2 respectively, and are not
mentioned here.
# Configure a routing policy on PE1 so that the BGP VPNv4 route advertised by
PE1 can carry community attribute 65000:100.
[PE1] route-policy comm permit node 10
[PE1-route-policy] apply community 65000:100
# Configure the routing policy on PE2 so that the BGP VPNv4 route advertised by
PE2 can carry community attribute 65000:200.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 908
[PE2] route-policy comm permit node 10
[PE2-route-policy] apply community 65000:200
# On PE1, apply the routing policy to the BGP VPNv4 route advertised by PE1 to
the RR so that the route can carry the community attribute.
[PE1] bgp 65000
[PE1-bgp] ipv4-family vpnv4
[PE1-bgp-af-vpnv4] peer 10.11.11.9 route-policy comm export
[PE1-bgp-af-vpnv4] peer 10.11.11.9 advertise-community
# On PE2, apply the routing policy to the advertised BGP VPNv4 route advertised
by PE2 to the RR so that the route can carry the community attribute.
[PE2] bgp 65000
[PE2-bgp] ipv4-family vpnv4
[PE2-bgp-af-vpnv4] peer 10.11.11.9 route-policy comm export
[PE2-bgp-af-vpnv4] peer 10.11.11.9 advertise-community
# Configure the RR to advertise the community attribute to the PEs.
[RR] bgp 65000
[RR-bgp] ipv4-family vpnv4
[RR-bgp-af-vpnv4] peer client advertise-community
# Configure the community attribute filter on PE1.
[PE1] ip community-filter 1 permit 65000:100
# Configure the community attribute filter on PE2.
[PE2] ip community-filter 1 permit 65000:200
# On PE1, configure a routing policy and set the local preference of the route with
community attribute 65000:100 to 200.
[PE1] route-policy local_pre permit node 10
[PE1-route-policy] if-match community-filter 1
[PE1-route-policy] apply local-preference 200
[PE1-route-policy] quit
# On PE2, configure a routing policy and set the local preference of the route with
community attribute 65000:200 to 200.
[PE2] route-policy local_pre permit node 10
[PE2-route-policy] if-match community-filter 1
[PE2-route-policy] apply local-preference 200
[PE2-route-policy] quit
# On PE1, apply the routing policy to the imported BGP VPNv4 route so that the
PE1 chooses the route advertised by the remote PEs in plane A.
[PE1] bgp 65000
[PE1-bgp] ipv4-family vpnv4
[PE1-bgp-af-vpnv4] peer 10.11.11.9 route-policy local_pre import
# On PE2, apply the routing policy to the imported BGP VPNv4 route so that the
PE2 chooses the route advertised by the remote PEs in plane B.
[PE2] bgp 65000
[PE2-bgp] ipv4-family vpnv4
[PE2-bgp-af-vpnv4] peer 10.11.11.9 route-policy local_pre import
NOTE
After this configuration, you also need to configure MPLS, establish tunnels, configure MPLS
L3VPN, and configure PEs to access CEs. For detailed configurations, see the configuration files
of this example.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 909
Step 5 Verify the configuration.
Run the display bgp vpnv4 all routing-table community command on a PE. You
can view information about the VPNv4 routes with community attributes. Take the
display on PE1 and PE2 as an example.
[PE1] display bgp vpnv4 all routing-table community
BGP Local router ID is 10.7.7.9
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes from all PE: 2
Route Distinguisher: 65000:10001012
Network NextHop MED LocPrf PrefVal Community
*> 10.22.1.0/24 10.9.9.9 0 200 65000:100
* 10.10.10.9 0 100 65000:200
VPN-Instance NGN_Media, router ID 10.7.7.9:
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Community
*>i 10.22.1.0/24 10.9.9.9 0 200 0 65000:100
* 10.10.10.9 0 100 0 65000:200
[PE2] display bgp vpnv4 all routing-table community
BGP Local router ID is 10.8.8.9
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes from all PE: 2
Route Distinguisher: 65000:10001011
Route Distinguisher: 65000:10001011
Network NextHop MED LocPrf PrefVal Community
*> 10.22.1.0/24 10.10.10.9 0 200 65000:200
* 10.9.9.9 0 100 65000:100
VPN-Instance NGN_Media, router ID 10.7.7.9:
Total Number of Routes: 2
Total routes of vpn-instance NGN_Media: 2
Network NextHop MED LocPrf PrefVal Community
*>i 10.22.1.0/24 10.10.10.9 0 200 0 65000:200
* 10.9.9.9 0 100 0 65000:100
Run the display ip routing-table vpn-instance NGN_Media 10.22.1.0 24
command on PE1, and you can find that the next hop of route 10.22.1.0/24 is PE3.
That is, PE1 chooses the route advertised by PE3.
[PE1] display ip routing-table vpn-instance NGN_Media 10.22.1.0 24
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 910
Routing Table: NGN_Media
Summary Count: 1
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.22.1.0/24 IBGP 255 0 RD 10.9.9.9 Vlanif50
----End
Configuration Files
● P1 configuration file
#
sysname P1
#
vlan batch 10 20 30 40 50
#
mpls lsr-id 10.1.1.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0100.1009.00
#
interface Vlanif10
description toP3Vlanif10
ip address 10.1.1.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif20
description toP5Vlanif20
ip address 10.1.2.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif30
description toRRVlanif30
ip address 10.1.3.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif40
description toP2Vlanif40
ip address 10.1.4.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif50
description toP1Vlanif50
ip address 10.1.5.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet3/0/0
port link-type trunk
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 911
port trunk allow-pass vlan 30
#
interface GigabitEthernet4/0/0
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet5/0/0
port link-type trunk
port trunk allow-pass vlan 50
#
interface LoopBack0
ip address 10.1.1.9 255.255.255.255
isis enable 64
#
return
● P2 configuration file
#
sysname P2
#
vlan batch 40 60 70 80 90
#
mpls lsr-id 10.2.2.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0200.2009.00
#
interface Vlanif40
description toP1Vlanif40
ip address 10.1.4.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif60
description toRRVlanif60
ip address 10.1.8.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif70
description toP4Vlanif70
ip address 10.1.7.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif80
description toP6Vlanif80
ip address 10.1.6.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif90
description toPE2Vlanif90
ip address 10.1.9.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet2/0/0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 912
port link-type trunk
port trunk allow-pass vlan 60
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 70
#
interface GigabitEthernet4/0/0
port link-type trunk
port trunk allow-pass vlan 80
#
interface GigabitEthernet5/0/0
port link-type trunk
port trunk allow-pass vlan 90
#
interface LoopBack0
ip address 10.2.2.9 255.255.255.255
isis enable 64
#
return
● P3 configuration file
#
sysname P3
#
vlan batch 10 110 120 130
#
mpls lsr-id 10.3.3.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0300.3009.00
#
interface Vlanif10
description toP1Vlanif10
ip address 10.1.1.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif110
description toP5Vlanif110
ip address 10.1.10.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif120
description toP4Vlanif120
ip address 10.1.11.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif130
description toPE3Vlanif130
ip address 10.1.12.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 110
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 913
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 120
#
interface GigabitEthernet4/0/0
port link-type trunk
port trunk allow-pass vlan 130
#
interface LoopBack0
ip address 10.3.3.9 255.255.255.255
isis enable 64
#
return
● P4 configuration file
#
sysname P4
#
vlan batch 70 120 150 160
#
mpls lsr-id 10.4.4.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0400.4009.00
#
interface Vlanif70
description toP2Vlanif70
ip address 10.1.7.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif120
description toP3Vlanif120
ip address 10.1.11.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif150
description toP6Vlanif150
ip address 10.1.13.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif160
description toPE4Vlanif160
ip address 10.1.14.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 70
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 120
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 150
#
interface GigabitEthernet4/0/0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 914
port link-type trunk
port trunk allow-pass vlan 160
#
interface LoopBack0
ip address 10.4.4.9 255.255.255.255
isis enable 64
#
return
● P5 configuration file
#
sysname P5
#
vlan batch 20 110 170
#
mpls lsr-id 10.5.5.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0500.5009.00
#
interface Vlanif20
description toP1Vlanif20
ip address 10.1.2.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif110
description toP3Vlanif110
ip address 10.1.10.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif170
description toP6Vlanif170
ip address 10.1.15.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 110
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 170
#
interface LoopBack0
ip address 10.5.5.9 255.255.255.255
isis enable 64
#
return
● P6 configuration file
#
sysname P6
#
vlan batch 80 150 170
#
mpls lsr-id 10.6.6.9
mpls
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 915
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0600.6009.00
#
interface Vlanif80
description toP2Vlanif80
ip address 10.1.6.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif150
description toP4Vlanif150
ip address 10.1.13.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif170
description toP5Vlanif170
ip address 10.1.15.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 80
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 170
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 150
#
interface LoopBack0
ip address 10.6.6.9 255.255.255.255
isis enable 64
#
return
● PE1 configuration file
#
sysname PE1
#
vlan batch 50 100
#
ip vpn-instance NGN_Media
ipv4-family
route-distinguisher 65000:10001012
apply-label per-instance
vpn-target 65000:100 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Other
ipv4-family
route-distinguisher 65000:30001012
apply-label per-instance
vpn-target 65000:300 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Signaling
ipv4-family
route-distinguisher 65000:20001012
apply-label per-instance
vpn-target 65000:200 export-extcommunity
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 916
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
mpls lsr-id 10.7.7.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0700.7009.00
#
interface Vlanif50
description toP1Vlanif50
ip address 10.1.5.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif100
description toPE2Vlanif100
ip address 10.1.16.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet3/0/0
#
interface GigabitEthernet3/0/0.10
dot1q termination vid 180
ip binding vpn-instance NGN_Media
ip address 10.21.1.73 255.255.255.252
#
interface GigabitEthernet3/0/0.11
dot1q termination vid 190
ip binding vpn-instance NGN_Signaling
ip address 10.21.1.77 255.255.255.252
#
interface GigabitEthernet3/0/0.12
dot1q termination vid 200
ip binding vpn-instance NGN_Other
ip address 10.21.1.81 255.255.255.252
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 50
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 100
#
interface LoopBack0
ip address 10.7.7.9 255.255.255.255
isis enable 64
#
bgp 65000
peer 10.11.11.9 as-number 65000
peer 10.11.11.9 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
undo peer 10.11.11.9 enable
#
ipv4-family vpnv4
policy vpn-target
peer 10.11.11.9 enable
peer 10.11.11.9 route-policy local_pre import
peer 10.11.11.9 route-policy comm export
peer 10.11.11.9 advertise-community
#
ipv4-family vpn-instance NGN_Media
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 917
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Other
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Signaling
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
route-policy comm permit node 10
apply community 65000:100
#
route-policy local_pre permit node 10
if-match community-filter 1
apply local-preference 200
#
ip community-filter 1 permit 65000:100
#
return
● PE2 configuration file
#
sysname PE2
#
vlan batch 90 100
#
ip vpn-instance NGN_Media
ipv4-family
route-distinguisher 65000:10001011
apply-label per-instance
vpn-target 65000:100 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Other
ipv4-family
route-distinguisher 65000:30001011
apply-label per-instance
vpn-target 65000:300 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Signaling
ipv4-family
route-distinguisher 65000:20001011
apply-label per-instance
vpn-target 65000:200 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
mpls lsr-id 10.8.8.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0800.8009.00
#
interface Vlanif90
description toP2Vlanif90
ip address 10.1.9.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif100
description toPE1Vlanif100
ip address 10.1.16.2 255.255.255.252
isis enable 64
mpls
mpls ldp
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 918
#
interface GigabitEthernet3/0/0
#
interface GigabitEthernet3/0/0.10
dot1q termination vid 210
ip binding vpn-instance NGN_Media
ip address 10.21.1.13 255.255.255.252
#
interface GigabitEthernet3/0/0.11
dot1q termination vid 220
ip binding vpn-instance NGN_Signaling
ip address 10.21.1.17 255.255.255.252
#
interface GigabitEthernet3/0/0.12
dot1q termination vid 230
ip binding vpn-instance NGN_Other
ip address 10.21.1.21 255.255.255.252
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 90
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 100
#
interface LoopBack0
ip address 10.8.8.9 255.255.255.255
isis enable 64
#
bgp 65000
peer 10.11.11.9 as-number 65000
peer 10.11.11.9 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
undo peer 10.11.11.9 enable
#
ipv4-family vpnv4
policy vpn-target
peer 10.11.11.9 enable
peer 10.11.11.9 route-policy local_pre import
peer 10.11.11.9 route-policy comm export
peer 10.11.11.9 advertise-community
#
ipv4-family vpn-instance NGN_Media
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Other
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Signaling
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
route-policy comm permit node 10
apply community 65000:200
#
route-policy local_pre permit node 10
if-match community-filter 1
apply local-preference 200
#
ip community-filter 1 permit 65000:200
#
return
● PE3 configuration file
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 919
#
sysname PE3
#
vlan batch 130 140
#
ip vpn-instance NGN_Media
ipv4-family
route-distinguisher 65000:10000811
apply-label per-instance
vpn-target 65000:100 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Other
ipv4-family
route-distinguisher 65000:30000811
apply-label per-instance
vpn-target 65000:300 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Signaling
ipv4-family
route-distinguisher 65000:20000811
apply-label per-instance
vpn-target 65000:200 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
mpls lsr-id 10.9.9.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0900.9009.00
#
interface Vlanif130
description toP3Vlanif130
ip address 10.1.12.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif140
description toPE4Vlanif140
ip address 10.1.17.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet3/0/0
#
interface GigabitEthernet3/0/0.10
dot1q termination vid 240
ip binding vpn-instance NGN_Media
ip address 10.22.1.73 255.255.255.252
#
interface GigabitEthernet3/0/0.11
dot1q termination vid 250
ip binding vpn-instance NGN_Signaling
ip address 10.22.1.77 255.255.255.252
#
interface GigabitEthernet3/0/0.12
dot1q termination vid 260
ip binding vpn-instance NGN_Other
ip address 10.22.1.81 255.255.255.252
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 130
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 920
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 140
#
interface LoopBack0
ip address 10.9.9.9 255.255.255.255
isis enable 64
#
bgp 65000
peer 10.11.11.9 as-number 65000
peer 10.11.11.9 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
undo peer 10.11.11.9 enable
#
ipv4-family vpnv4
policy vpn-target
peer 10.11.11.9 enable
peer 10.11.11.9 route-policy local_pre import
peer 10.11.11.9 route-policy comm export
peer 10.11.11.9 advertise-community
#
ipv4-family vpn-instance NGN_Media
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Other
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Signaling
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
route-policy comm permit node 10
apply community 65000:100
#
route-policy local_pre permit node 10
if-match community-filter 1
apply local-preference 200
#
route-policy local_pre permit node 20
#
ip community-filter 1 permit 65000:100
#
return
● PE4 configuration file
#
sysname PE4
#
vlan batch 140 160
#
ip vpn-instance NGN_Media
ipv4-family
route-distinguisher 65000:10000712
apply-label per-instance
vpn-target 65000:100 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Other
ipv4-family
route-distinguisher 65000:30000712
apply-label per-instance
vpn-target 65000:300 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Signaling
ipv4-family
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 921
route-distinguisher 65000:20000712
apply-label per-instance
vpn-target 65000:200 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
mpls lsr-id 10.10.10.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.1001.0009.00
#
interface Vlanif140
description toPE3Vlanif140
ip address 10.1.17.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif160
description toP4Vlanif160
ip address 10.1.14.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet3/0/0
#
interface GigabitEthernet3/0/0.10
dot1q termination vid 270
ip binding vpn-instance NGN_Media
ip address 10.22.1.13 255.255.255.252
#
interface GigabitEthernet3/0/0.11
dot1q termination vid 280
ip binding vpn-instance NGN_Signaling
ip address 10.22.1.17 255.255.255.252
#
interface GigabitEthernet3/0/0.12
dot1q termination vid 290
ip binding vpn-instance NGN_Other
ip address 10.22.1.21 255.255.255.252
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 160
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 140
#
interface LoopBack0
ip address 10.10.10.9 255.255.255.255
isis enable 64
#
bgp 65000
peer 10.11.11.9 as-number 65000
peer 10.11.11.9 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
undo peer 10.11.11.9 enable
#
ipv4-family vpnv4
policy vpn-target
peer 10.11.11.9 enable
peer 10.11.11.9 route-policy local_pre import
peer 10.11.11.9 route-policy comm export
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 922
peer 10.11.11.9 advertise-community
#
ipv4-family vpn-instance NGN_Media
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Other
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Signaling
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
route-policy comm permit node 10
apply community 65000:200
#
route-policy local_pre permit node 10
if-match community-filter 1
apply local-preference 200
#
ip community-filter 1 permit 65000:200
#
return
● RR configuration file
#
sysname RR
#
vlan batch 30 60
#
isis 64
network-entity 49.0091.0100.1101.1009.00
#
interface Vlanif30
description toP1Vlanif30
ip address 10.1.3.2 255.255.255.252
isis enable 64
#
interface Vlanif60
description toP2Vlanif60
ip address 10.1.8.2 255.255.255.252
isis enable 64
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 60
#
interface LoopBack0
ip address 10.11.11.9 255.255.255.255
isis enable 64
#
bgp 65000
group client internal
peer client connect-interface LoopBack0
peer 10.7.7.9 as-number 65000
peer 10.8.8.9 as-number 65000
peer 10.9.9.9 as-number 65000
peer 10.10.10.9 as-number 65000
#
ipv4-family unicast
undo synchronization
undo peer client enable
undo peer 10.7.7.9 enable
undo peer 10.8.8.9 enable
undo peer 10.9.9.9 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 923
undo peer 10.10.10.9 enable
#
ipv4-family vpnv4
undo policy vpn-target
peer client enable
peer client reflect-client
peer client advertise-community
peer 10.7.7.9 enable
peer 10.7.7.9 group client
peer 10.8.8.9 enable
peer 10.8.8.9 group client
peer 10.9.9.9 enable
peer 10.9.9.9 group client
peer 10.10.10.9 enable
peer 10.10.10.9 group client
#
return
9.17.13 Example for Configuring BFD for BGP
Networking Requirements
As shown in Figure 9-55, SwitchA belongs to AS 100, and SwitchB and SwitchC
belong to AS 200. EBGP connections are established between SwitchA and
SwitchB, and between SwitchA and SwitchC.
Service traffic is transmitted along the primary link SwitchA→SwitchB. The link
SwitchA→SwitchC→SwitchB functions as the backup link. Fast fault detection is
required to allow traffic to be fast switched from the primary link to the backup
link.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-55 Networking diagram of configuring BFD for BGP
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 924
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic BGP functions on each switch.
2. Configure the MED attribute to control route selection.
3. Enable BFD on SwitchA and SwitchB.
NOTE
If two switches establish an EBGP peer relationship over a direct link, BFD for BGP does not
need to be configured. This is because the ebgp-interface-sensitive command is enabled
by default for directly-connected EBGP peers.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.2.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.1.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure basic BGP functions. Establish EBGP peer relationships between SwitchA
and SwitchB, and between SwitchA and SwitchC and an IBGP peer relationship
between SwitchB and SwitchC.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 172.17.1.1
[SwitchA-bgp] peer 192.168.1.2 as-number 200
[SwitchA-bgp] peer 192.168.1.2 ebgp-max-hop
[SwitchA-bgp] peer 192.168.2.2 as-number 200
[SwitchA-bgp] peer 192.168.2.2 ebgp-max-hop
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] router-id 172.17.2.2
[SwitchB-bgp] peer 192.168.1.1 as-number 100
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 925
[SwitchB-bgp] peer 192.168.1.1 ebgp-max-hop
[SwitchB-bgp] peer 10.1.1.2 as-number 200
[SwitchB-bgp] network 172.16.1.0 255.255.255.0
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] router-id 172.17.3.3
[SwitchC-bgp] peer 192.168.2.1 as-number 100
[SwitchC-bgp] peer 192.168.2.1 ebgp-max-hop
[SwitchC-bgp] peer 10.1.1.1 as-number 200
[SwitchC-bgp] import-route direct
[SwitchC-bgp] quit
# Check the status of BGP peer relationships on SwitchA. The command output
shows that the BGP peer relationships are in the Established state.
[SwitchA] display bgp peer
BGP local router ID : 172.17.1.1
Local AS number : 100
Total number of peers : 2 Peers in established state : 2
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
192.168.1.2 4 200 2 5 0 00:01:25 Established 0
192.168.2.2 4 200 2 4 0 00:00:55 Established 0
Step 4 Set the MED.
Set the MED sent from SwitchB to SwitchC through the policy.
# Configure SwitchB.
[SwitchB] route-policy 10 permit node 10
[SwitchB-route-policy] apply cost 100
[SwitchB-route-policy] quit
[SwitchB] bgp 200
[SwitchB-bgp] peer 192.168.1.1 route-policy 10 export
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] route-policy 10 permit node 10
[SwitchC-route-policy] apply cost 150
[SwitchC-route-policy] quit
[SwitchC] bgp 200
[SwitchC-bgp] peer 192.168.2.1 route-policy 10 export
[SwitchC-bgp] quit
# View all BGP routing information on SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.17.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.2.2 150 0 200?
*> 172.16.1.0/24 192.168.1.2 100 0 200i
* 192.168.2.2 150 0 200i
*> 192.168.2.0 192.168.1.2 100 0 200?
192.168.2.2 150 0 200?
According to the BGP routing table, the next-hop address of the route destined for
172.16.1.0/24 is 192.168.1.2 and service flow is transmitted on the active link
SwitchA → SwitchB.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 926
Step 5 Configure BFD, and set the interval for transmitting BFD packets, the interval for
receiving BFD packets, and the local detection multiplier.
# Enable BFD on SwitchA. Set the minimum intervals for transmitting and
receiving BFD packets to 100 ms and the local detection multiplier to 4.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] bgp 100
[SwitchA-bgp] peer 192.168.1.2 bfd enable
[SwitchA-bgp] peer 192.168.1.2 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchA-bgp] quit
# Enable BFD on SwitchB. Set the minimum intervals for transmitting and
receiving BFD packets to 100 ms and the local detection multiplier to 4.
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] bgp 200
[SwitchB-bgp] peer 192.168.1.1 bfd enable
[SwitchB-bgp] peer 192.168.1.1 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchB-bgp] quit
# Display all BFD sessions on SwitchA.
[SwitchA] display bgp bfd session all
Local_Address Peer_Address LD/RD Interface
192.168.1.1 192.168.1.2 8201/8201 Vlanif20
Tx-interval(ms) Rx-interval(ms) Multiplier Session-State
100 100 4 Up
Wtr-interval(m)
0
Step 6 Verify the configuration.
# Run the shutdown command on VLANIF20 of SwitchB to simulate faults on the
active link.
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] shutdown
# Check the BGP routing table on SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.17.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.2.2 150 0 200?
*> 172.16.1.0/24 192.168.2.2 150 0 200i
192.168.2.0 192.168.2.2 150 0 200?
According to the BGP routing table, the standby link SwitchA → SwitchC →
SwitchB takes effect after the active link fails. The next-hop address of the route
destined for 172.16.1.0/24 becomes 192.168.2.2.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 927
#
vlan batch 10 20
#
bfd
#
interface Vlanif10
ip address 192.168.2.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 100
router-id 172.17.1.1
peer 192.168.1.2 as-number 200
peer 192.168.1.2 ebgp-max-hop 255
peer 192.168.1.2 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
peer 192.168.1.2 bfd enable
peer 192.168.2.2 as-number 200
peer 192.168.2.2 ebgp-max-hop 255
#
ipv4-family unicast
undo synchronization
peer 192.168.1.2 enable
peer 192.168.2.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 20 30 40
#
bfd
#
interface Vlanif20
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif30
ip address 10.1.1.1 255.255.255.0
#
interface Vlanif40
ip address 172.16.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 40
#
bgp 200
router-id 172.17.2.2
peer 10.1.1.2 as-number 200
peer 192.168.1.1 as-number 100
peer 192.168.1.1 ebgp-max-hop 255
peer 192.168.1.1 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 928
peer 192.168.1.1 bfd enable
#
ipv4-family unicast
undo synchronization
network 172.16.1.0 255.255.255.0
peer 10.1.1.2 enable
peer 192.168.1.1 enable
peer 192.168.1.1 route-policy 10 export
#
route-policy 10 permit node 10
apply cost 100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 10 30
#
bfd
#
interface Vlanif10
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif30
ip address 10.1.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 200
router-id 172.17.3.3
peer 10.1.1.1 as-number 200
peer 192.168.2.1 as-number 100
peer 192.168.2.1 ebgp-max-hop 255
#
ipv4-family unicast
undo synchronization
import-route direct
peer 10.1.1.1 enable
peer 192.168.2.1 enable
peer 192.168.2.1 route-policy 10 export
#
route-policy 10 permit node 10
apply cost 150
#
return
9.17.14 Example for Configuring BFD for BGP4+
Networking Requirements
In Figure 9-56, SwitchA belongs to AS 100, and SwitchB and SwitchC belong to AS
200. SwitchA establishes EBGP connections with both SwitchB and SwitchC.
Service traffic is forwarded along the primary link SwitchA→SwitchB. The link
SwitchA→SwitchC→SwitchB is used as a backup. Customers require that a fault on
the primary link be detected in milliseconds so that service traffic can be fast
switched to the backup link if the primary link fails.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 929
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-56 Networking diagram of configuring BFD for BGP4+
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic BGP4+ functions on all switches so that they can establish
BGP peer relationships with each other.
2. Configure MED-based route selection on SwitchA and SwitchB to forward
traffic on the primary link between SwitchA and SwitchB.
3. Enable BFD on SwitchA and SwitchB to detect faults in milliseconds so that
service traffic can be fast switched to the backup link if the primary link fails.
Procedure
Step 1 Enable the IPv6 forwarding capability and configure IPv6 addresses for interfaces.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] ipv6
[SwitchA] interface GigabitEthernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] undo portswitch
[SwitchA-GigabitEthernet0/0/1] ipv6 enable
[SwitchA-GigabitEthernet0/0/1] ipv6 address FC00:3::1 64
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface GigabitEthernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] undo portswitch
[SwitchA-GigabitEthernet0/0/2] ipv6 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 930
[SwitchA-GigabitEthernet0/0/2] ipv6 address FC00:1::1 64
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure basic BGP4+ functions, establish EBGP connections between SwitchA
and SwitchB and between SwitchA and SwitchC, and establish an IBGP connection
between SwitchB and SwitchC.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer FC00:3::2 as-number 200
[SwitchA-bgp] peer FC00:1::2 as-number 200
[SwitchA-bgp] ipv6-family unicast
[SwitchA-bgp-af-ipv6] peer FC00:3::2 enable
[SwitchA-bgp-af-ipv6] peer FC00:1::2 enable
[SwitchA-bgp-af-ipv6] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer FC00:3::1 as-number 100
[SwitchB-bgp] peer FC00:2::1 as-number 200
[SwitchB-bgp] ipv6-family unicast
[SwitchB-bgp-af-ipv6] peer FC00:3::1 enable
[SwitchB-bgp-af-ipv6] peer FC00:2::1 enable
[SwitchB-bgp-af-ipv6] network FC00:4:: 64
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] router-id 10.3.3.3
[SwitchC-bgp] peer FC00:1::1 as-number 100
[SwitchC-bgp] peer FC00:2::2 as-number 200
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer FC00:1::1 enable
[SwitchC-bgp-af-ipv6] peer FC00:2::2 enable
[SwitchC-bgp-af-ipv6] quit
[SwitchC-bgp] quit
# Run the display bgp ipv6 peer command on SwitchA. The command output
shows that BGP peer relationships have been established.
[SwitchA] display bgp ipv6 peer
BGP local router ID : 10.1.1.1
Local AS number : 100
Total number of peers : 2 Peers in established state : 2
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
FC00:1::2 4 200 2 4 0 00:00:27 Established 0
FC00:3::2 4 200 2 3 0 00:00:27 Established 0
Step 3 Configure the MED attribute.
Set the MED values of routes sent from SwitchB and SwitchC to SwitchA through
routing policies.
# Configure SwitchB.
[SwitchB] route-policy 10 permit node 10
[SwitchB-route-policy] apply cost 100
[SwitchB-route-policy] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 931
[SwitchB] bgp 200
[SwitchB-bgp] ipv6-family unicast
[SwitchB-bgp-af-ipv6] peer FC00:3::1 route-policy 10 export
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] route-policy 10 permit node 10
[SwitchC-route-policy] apply cost 150
[SwitchC-route-policy] quit
[SwitchC] bgp 200
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer FC00:1::1 route-policy 10 export
[SwitchC-bgp-af-ipv6] quit
[SwitchC-bgp] quit
# Check the BGP routing table on SwitchA.
[SwitchA] display bgp ipv6 routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
*> Network : FC00:4:: PrefixLen : 64
NextHop : FC00:3::2 LocPrf :
MED : 100 PrefVal : 0
Label :
Path/Ogn : 200 i
*
NextHop : FC00:1::2 LocPrf :
MED : 150 PrefVal : 0
Label :
Path/Ogn : 200 i
In the BGP routing table, you can view that the next-hop address of the route to
FC00:4::1/64 is FC00:3::2, and traffic is transmitted on the primary link
SwitchA→SwitchB.
Step 4 Configure BFD, and set the intervals at which BFD packets are sent and received
and the local detection multiplier.
# Configure BFD on SwitchA, and set the minimum intervals for sending and
receiving BFD packets to both 100 ms and the local detection multiplier to 4.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] bgp 100
[SwitchA-bgp] peer FC00:3::2 bfd enable
[SwitchA-bgp] peer FC00:3::2 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchA-bgp] quit
# Configure BFD on SwitchB, and set the minimum intervals for sending and
receiving BFD packets to both 100 ms and the local detection multiplier to 4.
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] bgp 200
[SwitchB-bgp] peer FC00:3::1 bfd enable
[SwitchB-bgp] peer FC00:3::1 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchB-bgp] quit
# Check all BFD sessions on SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 932
[SwitchA] display bgp ipv6 bfd session all
Local_Address : FC00:3::1
Peer_Address : FC00:3::2
Tx-interval(ms): 100 Rx-interval(ms): 100
Multiplier : 4 Interface : GigabitEthernet0/0/1
LD/RD : 8199/8200 Session-State : Up
Wtr-interval(m): 0
Step 5 Verify the configuration.
# Run the shutdown command on GE0/0/1 of SwitchB to simulate a primary link
fault.
[SwitchB] interface GigabitEthernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] shutdown
# Check the BGP routing table on SwitchA.
[SwitchA] display bgp ipv6 routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
*> Network : FC00:4:: PrefixLen : 64
NextHop : FC00:1::2 LocPrf :
MED : 150 PrefVal : 0
Label :
Path/Ogn : 200 i
In the BGP routing table, you can view that the backup link
SwitchA→SwitchC→SwitchB transmits traffic after the primary link
SwitchA→SwitchB fails, and the next-hop address of the route to FC00:4::1/64
becomes FC00:1::2.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
bfd
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:3::1/64
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:1::1/64
#
bgp 100
router-id 10.1.1.1
peer FC00:1::2 as-number 200
peer FC00:3::2 as-number 200
peer FC00:3::2 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
peer FC00:3::2 bfd enable
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 933
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
peer FC00:1::2 enable
peer FC00:3::2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
bfd
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:3::2/64
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:2::2/64
#
interface GigabitEthernet0/0/3
undo portswitch
ipv6 enable
ipv6 address FC00:4::1/64
#
bgp 200
router-id 10.2.2.2
peer FC00:2::1 as-number 200
peer FC00:3::1 as-number 100
peer FC00:3::1 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
peer FC00:3::1 bfd enable
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:4:: 64
peer FC00:2::1 enable
peer FC00:3::1 enable
peer FC00:3::1 route-policy 10 export
#
route-policy 10 permit node 10
apply cost 100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:2::1/64
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:1::2/64
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 934
#
bgp 200
router-id 10.3.3.3
peer FC00:1::1 as-number 100
peer FC00:2::2 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
peer FC00:1::1 enable
peer FC00:1::1 route-policy 10 export
peer FC00:2::2 enable
#
route-policy 10 permit node 10
apply cost 150
#
return
9.17.15 Example for Configuring BGP GTSM
Networking Requirements
As shown in Figure 9-57, SwitchA belongs to AS 10, and SwitchB, SwitchC, and
SwitchD belong to AS 20. BGP runs on the network. To protect a device against
the attacks of forged BGP packets, you can configure GTSM to check whether the
TTL value in the IP packet header is within the specified range.
Figure 9-57 Networking diagram of configuring BGP GTSM
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure OSPF on SwitchB, SwitchC, and SwitchD to implement interworking
in AS 20.
2. Set up an EBGP connection between SwitchA and SwitchB, and set up IBGP
connections between SwitchB, SwitchC, and SwitchD through loopback
interfaces to implement interworking between ASs.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 935
3. Configure GTSM on SwitchA, SwitchB, SwitchC, and SwitchD so that it can
protect SwitchB against CPU-utilization attacks.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign an IP address to each interface.
# Configure SwitchB. The configurations of SwitchA, SwitchC, and SwitchD are
similar to the configuration of SwitchB.
[SwitchB] interface vlanif 10
[SwitchB-Vlanif10] ip address 10.1.1.2 24
[SwitchB-Vlanif10] quit
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] ip address 10.2.1.2 24
[SwitchB-Vlanif20] quit
[SwitchB] interface loopback 0
[SwitchB-LoopBack0] ip address 172.16.2.9 32
[SwitchB-LoopBack0] quit
Step 3 Configure OSPF.
# Configure SwitchB. The configurations of SwitchC and SwitchD are similar to the
configuration of SwitchB.
[SwitchB] ospf
[SwitchB-ospf-1] area 0.0.0.0
[SwitchB-ospf-1-area-0.0.0.0] network 10.2.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] network 172.16.2.9 0.0.0.0
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
Step 4 Configure an IBGP connection.
# Configure SwitchB.
[SwitchB] bgp 20
[SwitchB-bgp] router-id 172.16.2.9
[SwitchB-bgp] peer 172.16.3.9 as-number 20
[SwitchB-bgp] peer 172.16.3.9 connect-interface LoopBack0
[SwitchB-bgp] peer 172.16.3.9 next-hop-local
[SwitchB-bgp] peer 172.16.4.9 as-number 20
[SwitchB-bgp] peer 172.16.4.9 connect-interface LoopBack0
[SwitchB-bgp] peer 172.16.4.9 next-hop-local
# Configure SwitchC.
[SwitchC] bgp 20
[SwitchC-bgp] router-id 172.16.3.9
[SwitchC-bgp] peer 172.16.2.9 as-number 20
[SwitchC-bgp] peer 172.16.2.9 connect-interface LoopBack0
[SwitchC-bgp] peer 172.16.4.9 as-number 20
[SwitchC-bgp] peer 172.16.4.9 connect-interface LoopBack0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 936
# Configure SwitchD.
[SwitchD] bgp 20
[SwitchD-bgp] router-id 172.16.4.9
[SwitchD-bgp] peer 172.16.2.9 as-number 20
[SwitchD-bgp] peer 172.16.2.9 connect-interface LoopBack0
[SwitchD-bgp] peer 172.16.3.9 as-number 20
[SwitchD-bgp] peer 172.16.3.9 connect-interface LoopBack0
Step 5 Configure an EBGP connection.
# Configure SwitchA.
[SwitchA] bgp 10
[SwitchA-bgp] router-id 172.16.1.9
[SwitchA-bgp] peer 10.1.1.2 as-number 20
# Configure SwitchB.
[SwitchB-bgp] peer 10.1.1.1 as-number 10
[SwitchB-bgp] quit
# Display the connection status of the BGP peers.
[SwitchB] display bgp peer
BGP local router ID : 172.16.2.9
Local AS number : 20
Total number of peers : 3 Peers in established state : 3
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
172.16.3.9 4 20 8 7 0 00:05:06 Established 0
172.16.4.9 4 20 8 10 0 00:05:33 Established 0
10.1.1.1 4 10 7 7 0 00:04:09 Established 0
You can view that SwitchB has set up BGP connections with other routers.
Step 6 Configure GTSM on SwitchA and SwitchB. SwitchA and SwitchB are directly
connected, so the range of the TTL value between the two switches is [255, 255].
The value of valid-ttl-hops is 1.
# Configure GTSM on SwitchA.
[SwitchA-bgp] peer 10.1.1.2 valid-ttl-hops 1
# Configure GTSM of the EBGP connection on SwitchB.
[SwitchB-bgp] peer 10.1.1.1 valid-ttl-hops 1
# Check the GTSM configuration.
[SwitchB] display bgp peer 10.1.1.1 verbose
BGP Peer is 10.1.1.1, remote AS 10
Type: EBGP link
BGP version 4, Remote router ID 172.16.1.9
Update-group ID : 0
BGP current state: Established, Up for 00h49m35s
BGP current event: RecvKeepalive
BGP last state: OpenConfirm
BGP Peer Up count: 1
Received total routes: 0
Received active routes total: 0
Received mac routes: 0
Advertised total routes: 0
Port: Local - 179 Remote - 52876
Configured: Connect-retry Time: 32 sec
Configured: Min Hold Time: 0 sec
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 937
Configured: Active Hold Time: 180 sec Keepalive Time:60 sec
Received : Active Hold Time: 180 sec
Negotiated: Active Hold Time: 180 sec Keepalive Time:60 sec
Peer optional capabilities:
Peer supports bgp multi-protocol extension
Peer supports bgp route refresh capability
Peer supports bgp 4-byte-as capability
Address family IPv4 Unicast: advertised and received
Received: Total 59 messages
Update messages 0
Open messages 2
KeepAlive messages 57
Notification messages 0
Refresh messages 0
Sent: Total 79 messages
Update messages 5
Open messages 2
KeepAlive messages 71
Notification messages 1
Refresh messages 0
Authentication type configured: None
Last keepalive received: 2012/03/06 19:17:37 Last keepalive sent : 2012/03/06 19:17:37 Last update
received: 2012/03/06 19:17:43 Last update sent : 2012/03/06 19:17:37
Minimum route advertisement interval is 30 seconds
Optional capabilities:
Route refresh capability has been enabled
4-byte-as capability has been enabled
GTSM has been enabled, valid-ttl-hops: 1
Peer Preferred Value: 0
Routing policy configured:
No routing policy is configured
You can view that GTSM is enabled, the valid hop count is 1, and the BGP
connection is in the Established state.
Step 7 Configure GTSM on SwitchB and SwitchC. SwitchB and SwitchC are directly
connected, so the range of the TTL value between the two switches is [255, 255].
The value of valid-ttl-hops is 1.
# Configure GTSM on SwitchB.
[SwitchB-bgp] peer 172.16.3.9 valid-ttl-hops 1
# Configure GTSM of the IBGP connection on SwitchC.
[SwitchC-bgp] peer 172.16.2.9 valid-ttl-hops 1
# View the GTSM configuration.
[SwitchB] display bgp peer 172.16.3.9 verbose
BGP Peer is 172.16.3.9, remote AS 20
Type: IBGP link
BGP version 4, Remote router ID 172.16.3.9
Update-group ID : 1
BGP current state: Established, Up for 00h54m36s
BGP current event: KATimerExpired
BGP last state: OpenConfirm
BGP Peer Up count: 2
Received total routes: 0
Received active routes total: 0
Received mac routes: 0
Advertised total routes: 0
Port: Local - 54998 Remote - 179
Configured: Connect-retry Time: 32 sec
Configured: Min Hold Time: 0 sec
Configured: Active Hold Time: 180 sec Keepalive Time:60 sec
Received : Active Hold Time: 180 sec
Negotiated: Active Hold Time: 180 sec Keepalive Time:60 sec
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 938
Peer optional capabilities:
Peer supports bgp multi-protocol extension
Peer supports bgp route refresh capability
Peer supports bgp 4-byte-as capability
Address family IPv4 Unicast: advertised and received
Received: Total 63 messages
Update messages 0
Open messages 1
KeepAlive messages 62
Notification messages 0
Refresh messages 0
Sent: Total 69 messages
Update messages 10
Open messages 1
KeepAlive messages 58
Notification messages 0
Refresh messages 0
Authentication type configured: None
Last keepalive received: 2012/03/06 19:18:37 Last keepalive sent : 2012/03/06 19:18:37 Last update
received: 2012/03/06 19:18:43 Last update sent : 2012/03/06 19:18:37
Minimum route advertisement interval is 15 seconds
Optional capabilities:
Route refresh capability has been enabled
4-byte-as capability has been enabled
Nexthop self has been configured
Connect-interface has been configured
GTSM has been enabled, valid-ttl-hops: 1
Peer Preferred Value: 0
Routing policy configured:
No routing policy is configured
You can view that GTSM is enabled, the valid hop count is 1, and the BGP
connection is in the Established state.
Step 8 Configure GTSM on SwitchC and SwitchD. SwitchC and SwitchD are directly
connected, so the range of the TTL value between the two switches is [255, 255].
The value of valid-ttl-hops is 1.
# Configure GTSM of the IBGP connection on SwitchC.
[SwitchC-bgp] peer 172.16.4.9 valid-ttl-hops 1
# Configure GTSM of the IBGP connection on SwitchD.
[SwitchD-bgp] peer 172.16.3.9 valid-ttl-hops 1
# Check the GTSM configuration.
[SwitchC] display bgp peer 172.16.4.9 verbose
BGP Peer is 172.16.4.9, remote AS 20
Type: IBGP link
BGP version 4, Remote router ID 172.16.4.9
Update-group ID : 1
BGP current state: Established, Up for 00h56m06s
BGP current event: KATimerExpired
BGP last state: OpenConfirm
BGP Peer Up count: 2
Received total routes: 0
Received active routes total: 0
Received mac routes: 0
Advertised total routes: 0
Port: Local - 179 Remote - 53758
Configured: Connect-retry Time: 32 sec
Configured: Min Hold Time: 0 sec
Configured: Active Hold Time: 180 sec Keepalive Time:60 sec
Received : Active Hold Time: 180 sec
Negotiated: Active Hold Time: 180 sec Keepalive Time:60 sec
Peer optional capabilities:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 939
Peer supports bgp multi-protocol extension
Peer supports bgp route refresh capability
Peer supports bgp 4-byte-as capability
Address family IPv4 Unicast: advertised and received
Received: Total 63 messages
Update messages 0
Open messages 1
KeepAlive messages 62
Notification messages 0
Refresh messages 0
Sent: Total 63 messages
Update messages 0
Open messages 2
KeepAlive messages 61
Notification messages 0
Refresh messages 0
Authentication type configured: None
Last keepalive received: 2012/03/06 19:19:37 Last keepalive sent : 2012/03/06 19:19:37 Last update
received: 2012/03/06 19:19:43 Last update sent : 2012/03/06 19:19:37
Minimum route advertisement interval is 15 seconds
Optional capabilities:
Route refresh capability has been enabled
4-byte-as capability has been enabled
Connect-interface has been configured
GTSM has been enabled, valid-ttl-hops: 1
Peer Preferred Value: 0
Routing policy configured:
No routing policy is configured
You can view that GTSM is enabled, the valid hop count is 1, and the BGP
connection is in the Established state.
Step 9 Configure GTSM on SwitchB and SwitchD. SwitchB and SwitchD are connected by
SwitchC, so the range of the TTL value between the two switches is [254, 255].
The value of valid-ttl-hops is 2.
# Configure GTSM of the IBGP connection on SwitchB.
[SwitchB-bgp] peer 172.16.4.9 valid-ttl-hops 2
# Configure GTSM on SwitchD.
[SwitchD-bgp] peer 172.16.2.9 valid-ttl-hops 2
# Check the GTSM configuration.
[SwitchB] display bgp peer 172.16.4.9 verbose
BGP Peer is 172.16.4.9, remote AS 20
Type: IBGP link
BGP version 4, Remote router ID 172.16.4.9
Update-group ID : 1
BGP current state: Established, Up for 00h57m48s
BGP current event: RecvKeepalive
BGP last state: OpenConfirm
BGP Peer Up count: 2
Received total routes: 0
Received active routes total: 0
Received mac routes: 0
Advertised total routes: 0
Port: Local - 53714 Remote - 179
Configured: Connect-retry Time: 32 sec
Configured: Min Hold Time: 0 sec
Configured: Active Hold Time: 180 sec Keepalive Time:60 sec
Received : Active Hold Time: 180 sec
Negotiated: Active Hold Time: 180 sec Keepalive Time:60 sec
Peer optional capabilities:
Peer supports bgp multi-protocol extension
Peer supports bgp route refresh capability
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 940
Peer supports bgp 4-byte-as capability
Address family IPv4 Unicast: advertised and received
Received: Total 72 messages
Update messages 0
Open messages 1
KeepAlive messages 71
Notification messages 0
Refresh messages 0
Sent: Total 82 messages
Update messages 10
Open messages 1
KeepAlive messages 71
Notification messages 0
Refresh messages 0
Authentication type configured: None
Last keepalive received: 2012/03/06 19:20:37 Last keepalive sent : 2012/03/06 19:20:37 Last update
received: 2012/03/06 19:20:43 Last update sent : 2012/03/06 19:20:37
Minimum route advertisement interval is 15 seconds
Optional capabilities:
Route refresh capability has been enabled
4-byte-as capability has been enabled
Nexthop self has been configured
Connect-interface has been configured
GTSM has been enabled, valid-ttl-hops: 2
Peer Preferred Value: 0
Routing policy configured:
No routing policy is configured
You can view that GTSM is configured, the valid hop count is 2, and the BGP
connection is in the Established state.
NOTE
● In this example, if the value of valid-ttl-hops of either SwitchB or SwitchD is smaller
than 2, the IBGP connection cannot be set up.
● GTSM must be configured on the two ends of the BGP connection.
Step 10 Verify the configuration.
# Run the display gtsm statistics all command on SwitchB to check the GTSM
statistics of SwitchB. By default, SwitchB does not discard any packet when all
packets match the GTSM policy.
[SwitchB] display gtsm statistics all
GTSM Statistics Table
----------------------------------------------------------------
SlotId Protocol Total Counters Drop Counters Pass Counters
----------------------------------------------------------------
0 BGP 17 0 17
0 BGPv6 0 0 0
0 OSPF 0 0 0
0 LDP 0 0 0
0 OSPFv3 0 0 0 0 RIP 0 0 0
----------------------------------------------------------------
If the host simulates the BGP packets of SwitchA to attack SwitchB, the packets
are discarded because their TTL value is not 255 when reaching SwitchB. In the
GTSM statistics of SwitchB, the number of dropped packets increases accordingly.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 941
#
vlan batch 10
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
bgp 10
router-id 172.16.1.9
peer 10.1.1.2 as-number 20
peer 10.1.1.2 valid-ttl-hops 1
#
ipv4-family unicast
undo synchronization
peer 10.1.1.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
#
interface Vlanif20
ip address 10.2.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface LoopBack0
ip address 172.16.2.9 255.255.255.255
#
bgp 20
router-id 172.16.2.9
peer 172.16.3.9 as-number 20
peer 172.16.3.9 connect-interface LoopBack0
peer 172.16.3.9 valid-ttl-hops 1
peer 172.16.4.9 as-number 20
peer 172.16.4.9 connect-interface LoopBack0
peer 172.16.4.9 valid-ttl-hops 2
peer 10.1.1.1 as-number 10
peer 10.1.1.1 valid-ttl-hops 1
#
ipv4-family unicast
undo synchronization
import-route ospf 1
peer 172.16.3.9 enable
peer 172.16.3.9 next-hop-local
peer 172.16.4.9 enable
peer 172.16.4.9 next-hop-local
peer 10.1.1.1 enable
#
ospf 1
area 0.0.0.0
network 172.16.2.9 0.0.0.0
network 10.2.1.0 0.0.0.255
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 942
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 30
#
interface Vlanif20
ip address 10.2.1.2 255.255.255.0
#
interface Vlanif30
ip address 10.2.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
interface LoopBack0
ip address 172.16.3.9 255.255.255.255
#
bgp 20
router-id 172.16.3.9
peer 172.16.2.9 as-number 20
peer 172.16.2.9 connect-interface LoopBack0
peer 172.16.2.9 valid-ttl-hops 1
peer 172.16.4.9 as-number 20
peer 172.16.4.9 connect-interface LoopBack0
peer 172.16.4.9 valid-ttl-hops 1
#
ipv4-family unicast
undo synchronization
peer 172.16.2.9 enable
peer 172.16.4.9 enable
#
ospf 1
area 0.0.0.0
network 172.16.3.9 0.0.0.0
network 10.2.1.0 0.0.0.255
network 10.2.2.0 0.0.0.255
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30
#
interface Vlanif30
ip address 10.2.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface LoopBack0
ip address 172.16.4.9 255.255.255.255
#
bgp 20
router-id 172.16.4.9
peer 172.16.2.9 as-number 20
peer 172.16.2.9 connect-interface LoopBack0
peer 172.16.2.9 valid-ttl-hops 2
peer 172.16.3.9 as-number 20
peer 172.16.3.9 connect-interface LoopBack0
peer 172.16.3.9 valid-ttl-hops 1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 943
#
ipv4-family unicast
undo synchronization
peer 172.16.2.9 enable
peer 172.16.3.9 enable
#
ospf 1
area 0.0.0.0
network 172.16.4.9 0.0.0.0
network 10.2.2.0 0.0.0.255
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 944
10 Routing Policy Configuration
10.1 Overview of Routing Policies
10.2 Understanding Routing Policies
10.3 Summary of Routing Policy Configuration Tasks
10.4 Licensing Requirements and Limitations for Routing Policies
10.5 Configuring Filters
10.6 Configuring a Routing Policy
10.7 Configuring Filter-Policy
10.8 Controlling the Valid Time of Routing Policies
10.9 Maintaining Routing Policies
10.10 Configuration Examples for Routing Policies
10.1 Overview of Routing Policies
Definition
Routing policy is a policy that controls routes using a series of tools or methods.
This type of policy will affect route generation, advertisement, and selection and
so affect the packet forwarding path. These tools include ACL, route-policy, ip-
prefix, and filter-policy, and these methods include filtering routes and setting
attributes for routes.
Purpose
On an IP network, routing policy is mainly used to filter routing information and
modify route attributes. Table 10-1 describes its functions.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 945
Table 10-1 Functions of routing policy
Function Execution Process Result
Filter routing
information.
If a route meets a specific
condition, it is accepted.
If a route meets a specific
condition, it is advertised.
If a route meets a specific
condition, it is imported.
This route is processed as
required.
Modify route
attributes.
If a route meets a specific
condition, a certain attribute
value of this route is
changed to a specified value.
A certain attribute value of
this route is changed to a
specified value.
Using routing policy to filter routing information
Figure 10-1 Using routing policy to filter routing information
In Figure 10-1, SwitchA is dual-homed to SwitchB and SwitchC and will receive
routes from both SwitchB and SwitchC. If SwitchA wants to receive routes only
from SwitchB but not from SwitchC, configure routing policy on SwitchA to permit
the routes received from SwitchB and deny the routes received from SwitchC.
Using routing policy to modify route attributes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 946
Figure 10-2 Using routing policy to modify route attributes
In Figure 10-2, SwitchA is also dual-homed to SwitchB and SwitchC. Because
SwitchB has better link stability and higher bandwidth than SwitchC, links of
SwitchB and SwitchC need to function as the primary and backup links
respectively. When the primary link fails, traffic is automatically switched to the
backup link. To meet this requirement, you can use routing policy to set a lower
route cost on SwitchB and set a higher route cost on SwitchC. Subsequently, traffic
is automatically transmitted over the primary link of SwitchB, and the link of
SwitchC functions as the backup link for route backup.
Benefits
Routing policies offer the following benefits:
● Improves network security by controlling route receiving, advertising and
importing.
● Improves network performance by modifying route attributes for proper
traffic planning.
Relevant Information
Technology Forum
Huawei S Series Switches Routing Policy
10.2 Understanding Routing Policies
10.2.1 Routing Policy Fundamentals
Filters
A filter is the core of a routing policy and is used to define a set of matching rules.
The switch provides the filters listed in Table 10-2.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 947
Table 10-2 Comparisons between filters
Filter Applicabl
e Scope
Matching Rules
Access control list
(ACL)
Dynamic
routing
protocols
Inbound interface, source or destination IP
address, protocol type, and source or
destination port number
IP prefix list Dynamic
routing
protocols
Source and destination IP addresses and
next hop address
AS_Path filter BGP AS_Path attribute
Community filter BGP Community attribute
Extcommunity filter VPN Extended community attribute
Route distinguisher
(RD) filter
VPN RD attribute
Route-policy Dynamic
routing
protocols
Destination IP address, next-hop address,
cost, interface information, route type, ACL,
IP prefix list, AS_Path filter, community
filter, extcommunity filter, and RD filter
The ACL, IP prefix list, AS_Path filter, community filter, extcommunity filter, and RD
filter can be used only to filter routes but not modify attributes of filtered routes.
A route-policy is a comprehensive filter, and it can use the matching rules of the
ACL, IP prefix list, AS_Path filter, community filter, extcommunity filter, and RD
filter to filter routes. In addition, attributes of filtered routes can be modified using
the route-policy. The following describes these filters.
ACL
An ACL is a set of sequential filtering rules. Users can define rules based on packet
information, such as inbound interfaces, source or destination IP addresses,
protocol types, and source or destination port numbers, and specify an action to
deny or permit packets. After an ACL is configured, the system classifies received
packets based on the rules defined in the ACL and denies or permits the packets
accordingly.
An ACL only classifies packets based on defined rules and can be used to filter
packets only when it is applied to a routing policy.
ACLs can be configured for both IPv4 packets and IPv6 packets. Users can specify
the IP address and subnet address range in an ACL to match the source IP address,
destination network segment address, or next-hop address of a route.
IP Prefix List
An IP prefix list contains a group of route filtering rules. Users can specify the
prefix and mask length range to match the destination network segment address
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 948
or next-hop address of a route. An IP prefix list is used to filter routes that are
advertised and received by dynamic routing protocols.
An IP prefix list is easier to configure and more flexible than an ACL. However, if a
large number of routes with different prefixes need to be filtered, it is complex to
configure an IP prefix list to filter these routes.
IP prefix lists can be configured for both IPv4 routes and IPv6 routes, and these IP
prefix lists share the same implementation process. An IP prefix list filters routes
based on the mask length or mask length range.
● Mask length: An IP prefix list filters routes based on IP address prefixes. An IP
address prefix is defined by an IP address and a mask length. For example, for
the route to 10.1.1.1/16, the mask length is 16 bits, and the valid prefix is 16
bits (10.1.0.0).
● Mask length range: If routes have the same IP address prefix but different
masks, the prefix mask length range can be specified for exact match or for
matching routes within the specified mask length range.
NOTE
0.0.0.0 is a wildcard address. If the IP prefix is 0.0.0.0, either a mask or a mask length range
can be specified following the prefix:
● If a mask is specified, all routes with this mask are permitted or denied.
● If a mask length range is specified, all routes with the mask length in this range are
permitted or denied.
AS_Path Filter
An AS_Path filter is used to filter BGP routes based on AS_Path attributes
contained in BGP routes. The AS_Path attribute records numbers of all ASs that a
BGP route passes through from the local end to the destination in the distance-
vector (DV) order. Therefore, filtering rules defined based on AS_Path attributes
can be used to filter BGP routes. The matching condition of an AS_Path filter is
specified using a regular expression. For example, ^30 indicates that only the
AS_Path attribute starting with 30 is matched.
For details about AS_Path filter principles and applications, see 10.2.5 AS_Path
Filter Applications in BGP.
Community Filter
A community filter is used to filter BGP routes based on Community attributes
contained in BGP routes. The Community attribute is a set of destination
addresses with the same characteristics. Therefore, filtering rules defined based on
Community attributes can be used to filter BGP routes.
In addition to well-known Community attributes, users can define community
attributes using digits. The matching condition of a community filter can be
specified using a community ID or regular expression.
For details about community filter principles and applications, see 10.2.6
Community Attribute Applications in BGP.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 949
Extcommunity Filter
An extcommunity filter is used to filter BGP routes based on extended community
attributes. BGP extended community attributes are classified into two types:
● VPN target: A VPN target controls route learning between VPN instances,
isolating routes of VPN instances. A VPN target may be either an import or
export VPN target. Before advertising a Virtual Private Network version 4
(VPNv4) or Virtual Private Network version 6 (VPNv6) route to a remote
Multi-protocol Extensions for Border Gateway Protocol (MP-BGP) peer, a PE
adds an export VPN target to the route. After receiving a VPNv4 or VPNv6
route, the remote MP-BGP peer compares the received export VPN target with
the local import VPN target to determine which routes can be added to the
routing table of the local VPN instance.
● Site-of-Origin (SoO): If multiple CEs at a VPN site are connected to different
PEs, the routes advertised from the CEs to the PEs may be re-advertised to
this VPN site after the routes have traversed the backbone network. This may
cause routing loops within the VPN site. To prevent routing loops, you can
configure an SoO attribute to differentiate routes advertised from different
VPN sites.
RD Filter
An RD filter is used to filter BGP routes based on RDs in VPN routes. RDs are used
to distinguish IPv4 and IPv6 prefixes in the same address segment in VPN
instances. RD filters specify matching rules regarding RD attributes.
Route-Policy
A route-policy is a complex filter. It is used to match attributes of specified routes
and change route attributes when specific conditions are met. A route-policy can
use the preceding six filters to define its matching rules.
Invoking Between Tools in Routing Policy
In applications, to control routes, tools used in routing policy must be used
together. Figure 10-3 shows invoking between these tools.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 950
Figure 10-3 Invoking between tools in routing policy
InFigure 10-3, all the tools used in routing policy are classified into the following
types:
● Conditional tool: captures required routes.
● Policy tool: performs an action on the captured routes, for example, permit,
deny, and modify attributes.
● Invoking tool: applies a routing policy to a specific routing protocol to make
the routing policy to take effect.
NOTE
Among the invoking tools, filter-policy and peer have the policy tool function, so they can
directly invoke conditional tools. Other invoking tools must invoke conditional tools through
route-policy.
The invoking tool, peer, can invoke all conditional tools except ACL.
Relevant Information
Technology Forum
Huawei S Series Switches Routing Policy
10.2.2 IP Prefix List
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 951
Filtering Rules
An IP prefix list can contain multiple index entries, each of which corresponds to a
filtering rule. In Figure 10-4, the system matches routes against entries in
ascending order of index number.
● If a route matches a permit entry, this route is permitted. If a route matches a
deny entry, this route is denied.
● If a route does not match any entry in the IP prefix list, this route is denied.
Figure 10-4 Matching principles of an IP prefix list
Route filtering rules of an IP prefix list include: sequential match, unique match,
and deny by default.
● Sequential match: Routes are matched against entries in ascending order of
index number. If different index numbers are configured for multiple entries in
the same IP prefix list, different filtering results may be obtained. Therefore,
exercise caution when configuring index numbers.
● Unique match: If a route matches one entry, it no longer tries to match other
entries.
● Deny by default: By default, all the routes that do not match any entry are
denied. Therefore, after one or multiple deny entries are created in an IP
prefix list, one entry needs to be created to permit all the other routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 952
Mask Matching
One advantage of IP prefix list over ACL is that routes can be matched against
their mask. The following example shows the ip ip-prefix command used to
configure an IPv4 prefix list:
ip ip-prefix
ip-prefix-name [ index
index-number ] { permit | deny }
ipv4-address
mask-length [ greater-equal
greater-equal-value ] [ less-equal
less-equal-value ]
In this command,
ipv4-address mask-length [ greater-equal
greater-equal-value ]
[ less-equal
less-equal-value ] defines the network ID and mask range of routes
to be filtered. Table 10-3 describes parameters in this command.
Table 10-3 An address range in an IP prefix list
Parameter Description
ipv4-address Specifies a network ID.
mask-length Specifies the mask length for exact match.
greater-equal
greater-equal-value
Indicates that the mask length must be greater than or
equal to
greater-equal-value.
less-equal
less-
equal-value
Indicates that the mask length must be less than or
equal to
less-equal-value.
When a route to be filtered has matched a network ID, the mask length can be
matched exactly or within a specified mask length.
● If both greater-equal and less-equal are not configured in the command,
exact match is performed on routes. That is, only the routes with the specified
mask-length are matched.
● If only greater-equal is configured in the command, the mask length range
used for matching routes is [
greater-equal-value, 32].
● If only less-equal is configured in the command, the mask length range used
for matching routes is [
mask-length,
less-equal-value].
● If both greater-equal and less-equal are configured in the command, the
mask length range used for matching routes is [
greater-equal-value,
less-
equal-value].
Differences Between IP Prefix List and ACL
Both IP prefix list and ACL can be used to filter routes. ACLs can match only the
network ID but not the mask (prefix length), but an IP prefix list is more flexible
than ACLs because it can match both the network ID and mask, improving route
matching accuracy.
The following two examples can help differentiate ACL and IP prefix list.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 953
Figure 10-5 Using an IP prefix list to filter imported routes
In Figure 10-5, SwitchB has two static routes, but only the static route
192.168.0.0/16 needs to be imported into OSPF.
Check the IP routing table of SwitchB. The following command output shows that
it has two static routes 192.168.0.0/16 and 192.168.0.0/24. Now only the route
192.168.0.0/16 needs to be re-advertised into OSPF.
[SwitchB] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
-----------------------------------------------------------------------------
Routing Tables: Public Destinations : 6 Routes : 6
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.10.12.0/24 Direct 0 0 D 10.10.12.1 Vlanif10
10.10.12.1/32 Direct 0 0 D 127.0.0.1 Vlanif10
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.0.0/16 Static 60 0 D 0.0.0.0 NULL0
192.168.0.0/24 Static 60 0 D 0.0.0.0 NULL0
First, use an ACL to meet this requirement.
1. 1. Configure a basic ACL 2001.
[SwitchB] acl 2001
[SwitchB-acl-basic-2001] rule permit source 192.168.0.0 0.0.255.255
[SwitchB-acl-basic-2001] quit
2. Configure node 10 in the route-policy RP to permit the route matching the
basic ACL 2001 and deny all the unmatched routes.
[SwitchB] route-policy RP permit node 10
[SwitchB-route-policy] if-match acl 2001
[SwitchB-route-policy] quit
3. Import the static route permitted by the route-policy RP into OSPF.
[SwitchB] ospf
[SwitchB-ospf-1] import-route static route-policy RP
[SwitchB-ospf-1] quit
After the preceding configurations are complete, check the IP routing table of
SwitchC.
<SwitchC> display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
-----------------------------------------------------------------------------
Routing Tables: Public
Destinations : 6 Routes : 6
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 954
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.10.12.0/24 Direct 0 0 D 10.10.12.2 Vlanif10
10.10.12.2/32 Direct 0 0 D 127.0.0.1 Vlanif10
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.0.0/16 O_ASE 150 1 D 10.10.12.1 Vlanif10
192.168.0.0/24 O_ASE 150 1 D 10.10.12.1 Vlanif10
The command output shows that the two routes to 192.168.0.0 have been
imported. This is because in the ACL 2001 rule permit source 192.168.0.0
0.0.255.255, 0.0.255.255 indicates a wildcard but not the mask length.
After a wildcard is converted into a binary number, 0 indicates that routes need to
match this ACL, while 1 indicates that routes do not. For example, 192.168.0.0
0.0.255.255 specifies a route prefix range: 192.168.0.0 to 192.168.255.255. The two
routes 192.168.0.0/16 and 192.168.0.0/24 both match the ACL 2001. Therefore, the
two routes match node 10 in the route-policy RP and both are imported into
OSPF. ACLs cannot ensure that only the route 192.168.0.0/16 or 192.168.0.0/24 is
matched because ACLs can match only network ID but not mask.
The following uses an IP prefix list to filter the imported routes. Check
whether an IP prefix list can ensure that only the route 192.168.0.0/16 is
imported and the route 192.168.0.0/24 is filtered out.
1. Configure an IP prefix list huawei and configure node 10 to permit the route
192.168.0.0/16.
[SwitchB] ip ip-prefix huawei index 10 permit 192.168.0.0 16
2. Configure a route-policy RP and configure node 10 to permit the route that
matches the IP prefix list huawei and deny all the unmatched routes.
[SwitchB] route-policy RP permit node 10
[SwitchB-route-policy] if-match ip-prefix huawei
[SwitchB-route-policy] quit
3. Import the static route permitted by the route-policy RP into OSPF.
[SwitchB] ospf
[SwitchB-ospf-1] import-route static route-policy RP
[SwitchB-ospf-1] quit
4. After the preceding configurations are complete, check the IP routing table of
SwitchC. The following command output shows that only the route
192.168.0.0/16 is imported into OSPF.
<SwitchC> display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
-----------------------------------------------------------------------------
Routing Tables: Public
Destinations : 5 Routes : 5
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.10.12.0/24 Direct 0 0 D 10.10.12.2 Vlanif10
10.10.12.2/32 Direct 0 0 D 127.0.0.1 Vlanif10
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.0.0/16 O_ASE 150 1 D 10.10.12.1 Vlanif10
Relevant Information
Technology Forum
Huawei S Series Switches Routing Policy
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 955
10.2.3 Route-Policy Implementation and Applications
Components
A route-policy is a complicated filter, which can match route attributes and change
route attributes when conditions are met.
In Figure 10-6, a route-policy consists of node ID, matching mode, if-match clause
(condition statement), and apply clause (action statement).
Figure 10-6 Components of a route-policy
● Node ID
A route-policy can contain multiple nodes. Routes must follow the following
rules when matching a route-policy:
– Sequential match: The system checks routing entries against nodes in
ascending order of node ID. Therefore, you need to specify node IDs in
the required sequence.
– Unique match: The relationship between all nodes in a route-policy is
"OR". This means that if a route matches one node in a route-policy, the
route matches this route-policy and does not need to match the other
nodes in this route-policy.
● Matching mode
Two node matching modes are available: permit and deny.
– permit: If a route matches a node, the actions defined by the apply
clauses of this node are performed on this route, and the system does not
match this route against the next node. If a route does not match a node,
the system matches this route against the next node.
– deny: If a route matches all the if-match clauses of a node, this route is
denied by this node, the system does not match this route against the
next node, and the actions defined by the apply clauses of this node will
not be performed on this route. If a route does not match the if-match
clauses of a node, the system matches this route against the next node.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 956
NOTE
A route-policy in permit mode that does not contain if-match and apply clauses is
often set behind multiple deny nodes to allow all other routes to pass through.
● if-match clause (condition statement)
if-match clauses define matching conditions. Each node in a route-policy can
contain multiple or no if-match clauses. If a permit node does not contain any
if-match clause, this node matches all routes.
● apply clause (action statement)
apply clauses define actions. When routes are filtered against a route-policy,
the system sets attributes for the routes according to the actions defined by
apply clauses. Each node in a route-policy can contain multiple or no apply
clauses. If you only need to filter routes but do not need to set attributes for
routes, apply clauses do not need to be used.
Matching Rules
The matching rules of each node in a route-policy depend on the following
factors:
● Matching mode of the node in the route-policy: permit or deny
● Matching conditions (permit or deny) defined by if-match clauses (for
example, IP prefix list or ACL) of the node
The following table describes possible matching results for each node.
Table 10-4 Matching rules of a route-policy
Rule (Matching
Rule Contained
in if-match
Clauses)
Mode
(Matching
Mode of a
Node)
Matching Result
permit permit ● Routes that match the if-match clauses
of this node are permitted by this route-
policy, and the matching ends.
● The system matches the routes that do
not match the if-match clauses of this
node against the next node of this
route-policy.
deny ● Routes that match the if-match clauses
of this node are denied by this route-
policy, and the matching ends.
● The system matches the routes that do
not match the if-match clauses of this
node against the next node of this
route-policy.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 957
Rule (Matching
Rule Contained
in if-match
Clauses)
Mode
(Matching
Mode of a
Node)
Matching Result
deny permit ● Routes that match the if-match clauses
of this node are denied by this route-
policy, and the system matches these
routes against the next node of this
route-policy.
● The system matches the routes that do
not match the if-match clauses of this
node against the next node of this
route-policy.
deny ● Routes that match the if-match clauses
of this node are denied by this route-
policy, and the system matches these
routes against the next node of this
route-policy.
● The system matches the routes that do
not match the if-match clauses of this
node against the next node of this
route-policy.
NOTE
On the switch, all unmatched routes are denied by the route-policy by default. If more than
one node is defined in a route-policy, at least one node must be in permit mode. The
reason is as follows:
● If a route fails to match any node, the route is denied by the route-policy.
● If all the nodes in the route-policy are set in deny mode, all the routes to be filtered are
denied by the route-policy.
Among the preceding four combinations, the first two combinations are easy to
understand and commonly used. The last two combinations are a little difficult to
understand, and the following example describes the third combination for your
reference.
Assume that the matching condition of if-match clauses in a node is deny and the
matching condition of this node is permit. The configuration is as follows:
#
acl number 2001
rule 5 deny source 172.16.16.0 0 //Deny 172.16.16.0
#
acl number 2002
rule 5 permit source 172.16.16.0 0 //Permit 172.16.16.0
#
route-policy RP permit node 10 //In this node, the route 172.16.16.0 is denied and the system matches
it against the next node.
if-match acl 2001
#
route-policy RP permit node 20 //In this node, the route 172.16.16.0 is permitted.
if-match acl 2002
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 958
The route 172.16.16.0 is denied by node 10, and the system matches this route
against the next node 20. This route is permitted by node 20 and so is permitted
by this route-policy.
Relevant Information
Technology Forum
Huawei S Series Switches Routing Policy
10.2.4 Filter-Policy Implementation and Applications
Overview
A filter-policy is a commonly used routing information filtering tool. In Figure
10-7, SwitchA, SwitchB, and SwitchC run a routing protocol, and routes are
transmitted among these devices. A filter-policy can be used to filter specific
routing information as required.
Figure 10-7 Filter-policy application
NOTE
Filter-policies can only filter routing information and cannot filter LSAs or change route
attributes.
Filtering Rules
Distance-vector routing protocols (such as RIP) and link-state routing protocols
(such as OSPF) vary in principles. Therefore, filter-policy filtering rules vary
between the two types of routing protocols. The following table lists differences in
routing information transmission between distance-vector routing protocols and
link-state routing protocols.
Table 10-5 Differences in routing information transmission between distance-
vector routing protocols and link-state routing protocols
Routing Protocol
Type
Route Transmission Principles
Distance-vector
routing protocols
Routing devices transmit routing information. This routing
information is like roadmap for packets. The devices guide
packet forwarding based on the roadmap.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 959
Routing Protocol
Type
Route Transmission Principles
Link-state routing
protocols
Routing devices transmit link state advertisements (LSAs).
A link state database (LSDB) is a set of LSAs and describes
the entire network topology, which is like a map. The
devices find the optimal forwarding path for packets based
on the map and shortest path algorithm.
Filter-policy in distance-vector routing protocols
Figure 10-8 Filter-policy in distance-vector routing protocols
In Figure 10-8, when using distance-vector routing protocols, devices transmit
routing information. To filter the routing information, use a filter-policy. Figure
10-8 shows where a filter-policy takes effect in the inbound and outbound
directions. To filter the routing information transmitted from an upstream device
to a downstream device, you only need to configure filter-policy export on the
upstream device or configure filter-policy import on the downstream device.
Filter-policy in link-state routing protocols
Figure 10-9 Filter-policy in link-state routing protocols
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 960
In Figure 10-9, when using link-state routing protocols, routing devices transmit
LSAs and then calculate their routing tables based on the LSDB. The following
uses OSPF as an example to describe filter-policy filtering rules:
● The filter-policy import command filters the routes calculated by OSPF but
not the LSAs advertised and received.
● The filter-policy export command filters the imported routes to be advertised
so that only eligible external routes are translated into Type 5 LSAs (AS-
external-LSAs) and advertised. In this manner, imported external routes can
be filtered as required to prevent routing loops.
Using a Filter-Policy to Filter the Routes Advertised by RIP
Requirement Description
In Figure 10-10, three switches exchange routes through RIP. Three static routes
(used as test routes) are imported into the RIP process of SwitchA. It is required
that the filter-policy export command be configured on SwitchB to filter the
routes advertised to SwitchC, that is, deny the route 192.168.3.0/24 and permit
other routes.
Figure 10-10 Using a filter-policy to filter the routes advertised by RIP
Configuration
1. Define an IP prefix list on SwitchB to filter routes as required.
[SwitchB] ip ip-prefix huawei index 10 deny 192.168.3.0 24 //Deny this route.
[SwitchB] ip ip-prefix huawei index 20 permit 0.0.0.0 0 less-equal 32 //Permit all routes.
2. Configure the filter-policy export command in the RIP view of SwitchB.
[SwitchB] rip
[SwitchB-rip-1] filter-policy ip-prefix huawei export Vlanif20
Verification
After the preceding configurations are complete, check the IP routing tables of
SwitchB and SwitchC.
[SwitchB] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 961
-----------------------------------------------------------------------------
Routing Tables: Public
Destinations : 9 Routes : 9
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.1.0/24 RIP 100 1 D 192.168.10.1 Vlanif10
192.168.2.0/24 RIP 100 1 D 192.168.10.1 Vlanif10
192.168.3.0/24 RIP 100 1 D 192.168.10.1 Vlanif10
192.168.10.0/24 Direct 0 0 D 192.168.10.2 Vlanif10
192.168.10.2/32 Direct 0 0 D 127.0.0.1 Vlanif10
192.168.20.0/24 Direct 0 0 D 192.168.20.1 Vlanif20
192.168.20.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
[SwitchC] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
-----------------------------------------------------------------------------
Routing Tables: Public
Destinations : 7 Routes : 7
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.1.0/24 RIP 100 2 D 192.168.20.1 Vlanif20
192.168.2.0/24 RIP 100 2 D 192.168.20.1 Vlanif20
192.168.10.0/24 RIP 100 1 D 192.168.20.1 Vlanif20
192.168.20.0/24 Direct 0 0 D 192.168.20.2 Vlanif20
192.168.20.2/32 Direct 0 0 D 127.0.0.1 Vlanif20
The preceding command output shows that after the filter-policy export
command is configured on SwitchB, SwitchB still has a complete IP routing table;
however, SwitchC cannot learn the route 192.168.3.0/24 through RIP because this
route has been filtered out before being advertised by SwitchB.
Using a Filter-Policy to Filter the Routes Received by RIP
Requirement Description
In Figure 10-11, three switches exchange routes through RIP. Three static routes
(used as test routes) are imported into the RIP process of SwitchA. It is required
that the filter-policy import command be configured on SwitchB to deny the
route 192.168.3.0/24 and permit other routes.
Figure 10-11 Using a filter-policy to filter the routes received by RIP
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 962
Configuration
1. Define an IP prefix list on SwitchB to filter routes as required.
[SwitchB] ip ip-prefix huawei index 10 deny 192.168.3.0 24 //Deny this route.
[SwitchB] ip ip-prefix huawei index 20 permit 0.0.0.0 0 less-equal 32 //Permit all routes.
2. Configure the filter-policy import command in the RIP view of SwitchB.
[SwitchB] rip
[SwitchB-rip-1] filter-policy ip-prefix huawei import Vlanif10
Verification
After the preceding configurations are complete, check the IP routing tables of
SwitchB and SwitchC.
[SwitchB] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
-----------------------------------------------------------------------------
Routing Tables: Public
Destinations : 8 Routes : 8
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.1.0/24 RIP 100 1 D 192.168.10.1 Vlanif10
192.168.2.0/24 RIP 100 1 D 192.168.10.1 Vlanif10
192.168.10.0/24 Direct 0 0 D 192.168.10.2 Vlanif10
192.168.10.2/32 Direct 0 0 D 127.0.0.1 Vlanif10
192.168.20.0/24 Direct 0 0 D 192.168.20.1 Vlanif20
192.168.20.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
[SwitchC] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
-----------------------------------------------------------------------------
Routing Tables: Public
Destinations : 7 Routes : 7
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.1.0/24 RIP 100 2 D 192.168.20.1 Vlanif20
192.168.2.0/24 RIP 100 2 D 192.168.20.1 Vlanif20
192.168.10.0/24 RIP 100 1 D 192.168.20.1 Vlanif20
192.168.20.0/24 Direct 0 0 D 192.168.20.2 Vlanif20
192.168.20.2/32 Direct 0 0 D 127.0.0.1 Vlanif20
The preceding command output shows that after the filter-policy import
command is configured on SwitchB, the IP routing tables of SwitchB and SwitchC
do not contain the route 192.168.3.0/24.
RIP is a distance-vector routing protocol and a RIP device advertises its routing
table to its neighbors. When the route 192.168.3.0/24 is filtered out from the IP
routing table of SwitchB, SwitchC can no longer learn this route through RIP. That
is, if routes in an IP routing table of a RIP device are filtered, the IP routing tables
of upstream devices of this RIP device are also affected.
NOTE
Both the filter-policy export and filter-policy import commands are configured in the RIP
process view. If routes are filtered based on interfaces or protocols, only one filter-policy can
be configured for one interface or protocol. If no interface or protocol is specified, a global
filter-policy is configured and similarly, only one filter-policy can be configured. If multiple
filter-policies are configured, only the latest filter-policy takes effect.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 963
Using a Filter-Policy to Filter the Intra-Area Routes Received by OSPF
Requirement Description
In Figure 10-12, three switches belong to OSPF Area 0. SwitchA advertises the test
network segment 10.1.1.0/24. It is required that the filter-policy import command
be configured on SwitchB so that the IP routing table of SwitchB does not contain
the route 10.1.1.0/24.
Figure 10-12 Using a filter-policy to filter the intra-area routes received by OSPF
Configuration
1. Define an IP prefix list on SwitchB to filter routes as required.
[SwitchB] ip ip-prefix huawei index 10 deny 10.1.1.0 24 //Deny this route.
[SwitchB] ip ip-prefix huawei index 20 permit 0.0.0.0 0 less-equal 32 //Permit all routes.
2. Configure the filter-policy import command in the OSPF view of SwitchB.
[SwitchB] ospf
[SwitchB-ospf-1] filter-policy ip-prefix huawei import
Verification
After the preceding configurations are complete, check the IP routing tables of
SwitchB and SwitchC.
[SwitchB] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
-----------------------------------------------------------------------------
Routing Tables: Public
Destinations : 6 Routes : 6
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.12.0/24 Direct 0 0 D 192.168.12.2 Vlanif12
192.168.12.2/32 Direct 0 0 D 127.0.0.1 Vlanif12
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 964
192.168.23.0/24 Direct 0 0 D 192.168.23.1 Vlanif23
192.168.23.1/32 Direct 0 0 D 127.0.0.1 Vlanif23
[SwitchC] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 6 Routes : 6
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/24 OSPF 10 3 D 192.168.23.1 Vlanif23
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.12.0/24 OSPF 10 2 D 192.168.23.1 Vlanif23
192.168.23.0/24 Direct 0 0 D 192.168.23.2 Vlanif23
192.168.23.2/32 Direct 0 0 D 127.0.0.1 Vlanif23
The preceding command output shows that, although the route 10.1.1.0/24 has
been filtered out on SwitchB, its LSA is still transmitted to SwitchC, so the IP
routing table of SwitchC still contains this route. This result also confirms that in
link-state routing protocols, a filter-policy filters only routing information but not
LSAs.
The LSDBs of SwitchB and SwitchC still contain the LSA describing the route
10.1.1.0/24. To verify this, check LSA information on SwitchB and SwitchC.
[SwitchB] display ospf lsdb router
OSPF Process 1 with Router ID 10.10.10.2
Area: 0.0.0.0
Link State Database
………
Type : Router
Ls id : 10.10.10.1
Adv rtr : 10.10.10.1
Ls age : 139
Len : 48
Options : E
seq# : 80000005
chksum : 0x41c4
Link count: 2
* Link ID: 10.1.1.0
Data : 255.255.255.0
Link Type: StubNet
Metric : 1
Priority : Low
* Link ID: 192.168.12.2
Data : 192.168.12.1
Link Type: TransNet
Metric : 1
[SwitchC] display ospf lsdb router
OSPF Process 1 with Router ID 10.10.10.3
Area: 0.0.0.0
Link State Database
…………
Type : Router
Ls id : 10.10.10.1
Adv rtr : 10.10.10.1
Ls age : 81
Len : 48
Options : E
seq# : 80000005
chksum : 0x41c4
Link count: 2
* Link ID: 10.1.1.0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 965
Data : 255.255.255.0
Link Type: StubNet
Metric : 1
Priority : Low
* Link ID: 192.168.12.2
Data : 192.168.12.1
Link Type: TransNet
Metric : 1
The preceding command output shows that the LSDBs of SwitchB and SwitchC still
contain the LSA describing the route 10.1.1.0/24.
Using a Filter-Policy to Filter the Inter-Area Routes Received by OSPF
In Figure 10-13 there are two OSPF areas, Area 0 and Area 1. SwitchB and
SwitchC transmit Type 3 LSAs, which are generated by SwitchB to describe inter-
area routes. The configuration is similar to the configuration in the previous
scenario. The following describes the filtering result.
Figure 10-13 Using a filter-policy to filter the inter-area routes received by OSPF
Before configuring a filter-policy, check the IP routing tables of SwitchB and
SwitchC.
[SwitchB] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
-----------------------------------------------------------------------------
Routing Tables: Public
Destinations : 7 Routes : 7
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/24 OSPF 10 2 D 192.168.12.1 Vlanif12
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.12.0/24 Direct 0 0 D 192.168.12.2 Vlanif12
192.168.12.2/32 Direct 0 0 D 127.0.0.1 Vlanif12
192.168.23.0/24 Direct 0 0 D 192.168.23.1 Vlanif23
192.168.23.1/32 Direct 0 0 D 127.0.0.1 Vlanif23
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 966
[SwitchC] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
-----------------------------------------------------------------------------
Routing Tables: Public
Destinations : 6 Routes : 6
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/24 OSPF 10 3 D 192.168.23.1 Vlanif23
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.12.0/24 OSPF 10 2 D 192.168.23.1 Vlanif23
192.168.23.0/24 Direct 0 0 D 192.168.23.2 Vlanif23
192.168.23.2/32 Direct 0 0 D 127.0.0.1 Vlanif23
The preceding command output shows that before a filter-policy is configured, the
IP routing tables of SwitchB and SwitchC contain the route 10.1.1.0/24.
Verification
After the filter-policy import command is configured on SwitchB, check the IP
routing tables of SwitchB and SwitchC.
[SwitchB] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
-----------------------------------------------------------------------------
Routing Tables: Public
Destinations : 6 Routes : 6
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.12.0/24 Direct 0 0 D 192.168.12.2 Vlanif12
192.168.12.2/32 Direct 0 0 D 127.0.0.1 Vlanif12
192.168.23.0/24 Direct 0 0 D 192.168.23.1 Vlanif23
192.168.23.1/32 Direct 0 0 D 127.0.0.1 Vlanif23
[SwitchC] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 5 Routes : 5
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
192.168.12.0/24 OSPF 10 2 D 192.168.23.1 Vlanif23
192.168.23.0/24 Direct 0 0 D 192.168.23.2 Vlanif23
192.168.23.2/32 Direct 0 0 D 127.0.0.1 Vlanif23
There are two OSPF areas. The route 10.1.1.0/24 on SwitchC is described by the
Type 3 LSA generated by SwitchB, but this route has been filtered out by SwitchB.
Therefore, the Type 3 LSA describing an inter-area route cannot be generated, and
SwitchC cannot learn the route 10.1.1.0/24 again.
Relevant Information
Technology Forum
Huawei S Series Switches Routing Policy
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 967
10.2.5 AS_Path Filter Applications in BGP
Overview
The AS_Path attribute is an ordered list of all the ASs that a route passes through
from the source to the destination. In Figure 10-14, the AS_Path attribute of a
BGP route can be considered as a string containing spaces and can be used to
match routes through a regular expression.
Figure 10-14 AS_Path attributes of BGP routes
A regular expression is a string that describes a characteristic and verifies whether
another string conforms to this characteristic. The AS_Path filter of BGP defines an
AS_Path regular expression to match AS_Path attributes of BGP routes for filtering
BGP routing information.
For example, ip as-path-filter 1 permit 495 defines an AS_Path filter 1 and a
regular expression 495, indicating that any string containing 495 can be matched.
AS_Path Regular Expressions
The core of an AS_Path filter is a regular expression. The content of a regular
expression is complex. The following describes the AS_Path filter.
An AS_Path filter uses a regular expression to define matching rules. A regular
expression consists of the following parts:
● Metacharacter: defines matching rules.
● General character: defines matching objects.
Table 10-6 lists metacharacters supported by BGP AS_Path regular expressions.
Table 10-6 Metacharacters supported by BGP AS_Path regular expressions
Meta
chara
cter
Description Example
. Matches AS_Paths with
any single character
except "\n", including
spaces.
.* matches any AS_Path or route.
NOTE
If you have defined multiple ip as-path-filter
clauses in deny mode, run the ip as-path-filter
as-path-filter-name permit .* command to permit
other routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 968
Meta
chara
cter
Description Example
* Matches AS_Paths with 0
or more sequences of
the character before the
asterisk "*".
See the preceding example.
+ Matches AS_Paths with 1
or more sequences of
the character before the
plus "+".
65+ matches AS_Paths that begin with 6 and
include one 5 or consecutive 5s.
● AS_Path examples that 65+ matches: 65,
655, 6559, 65259, and 65529
● AS_Path examples that 65+ does not
match: 56, 556, 5669, 55269, and 56259
| Matches any AS_Path
with characters on either
side of the vertical bar
"|".
100|65002|65003 matches 100, 65002, or
65003.
^ Matches AS_Paths
beginning with the
characters that follow
the caret "^".
^65 matches AS_Paths beginning with 65.
● AS_Path examples that ^65 matches: 65,
651, 6501, and 65001
● AS_Path examples that ^65 does not
match: 165, 1650, 6650, and 60065
$ Matches AS_Paths
ending with the
characters before the
dollar sign "$".
65$ matches AS_Paths ending with 65.
● AS_Path examples that 65$ matches: 65,
165, 1065, 10065, and 60065
● AS_Path examples that 65$ does not
match: 651, 1650, 6650, 60650, and
65001
NOTE
^$ matches null character strings (null AS_Path)
and can be used to match the locally originated
routes.
(xyz) Defines a subexpression,
which can be null. Both
the expression and the
subexpression should be
matched.
100(200)+ matches "100200" and
"100200200".
[xyz] Matches AS_Paths with
any character in the
brackets "[ ]".
[896] matches AS_Paths with 8, 9, or 6.
[^xyz
]
Matches AS_Paths with
any character except
those in the brackets
"[ ]".
[^896] matches AS_Paths with any character
except 8, 9, and 6.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 969
Meta
chara
cter
Description Example
[a-z] Matches AS_Paths with
any character within the
range specified in the
brackets "[ ]".
[2-4] matches 2, 3, and 4, and [0-9]
matches numbers 0 to 9.
NOTE
The characters in the brackets "[ ]" can only be
numbers 0 to 9. To match AS_Paths within the
range of 735 to 907, use (73[5-9]|7[4-9][0-9]|
8[0-9][0-9]|90[0-7]).
[^a-
z]
Matches AS_Paths
without any character
within the range
specified in the brackets
"[ ]".
[^2-4] matches AS_Paths without 2, 3, or 4,
and [^0-9] matches AS_Paths without
numbers 0 to 9.
_ Matches AS_Paths with a
sign, such as a comma
",", left brace "{", right
brace "}", left
parenthesis "(", right
parenthesis ")", or space.
The underscore "_" can
be used at the beginning
of a regular expression
with the same function
as the caret "^" or at the
end of a regular
expression with the same
function as the dollar
sign "$".
● ^65001_ matches AS_Paths that begin
with 65001 followed by a sign.
Specifically, ^65001_ matches AS_Paths
with 65001 as the leftmost AS number
(the number of the last AS through which
a route passes) or the routes sent by
peers in AS 65001.
● _65001_ matches AS_Paths with 65001 or
matches routes that pass through AS
65001.
● _65001$ matches AS_Paths that end with
a sign followed by 65001. Specifically,
_65001$ matches AS_Paths with 65001 as
the rightmost AS number (the number of
the first AS through which a route
passes) or matches the routes that are
originated in AS 65001.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 970
Meta
chara
cter
Description Example
\ Indicates an escape
character.
A backslash "\" is used to disable special
functions of signs in regular expressions,
such as the left parenthesis "(" and right
parenthesis ")" in an AS_Confed_Sequence,
the left bracket "[" and right bracket "]" in
an AS_Confed_Set, and the left brace "{" and
right brace "}" in an AS_Set.
● \(65002_ matches AS_Confed_Sequences
that begin with (65002 followed by a
sign. Specifically, \(65002_ matches
AS_Confed_Sequences with 65002 as the
leftmost AS number (the number of the
last AS through which a route passes) or
matches the routes sent by peers in AS
65002.
● \(.*_65003_.*\) matches
AS_Confed_Sequences with 65003 or
matches the routes that pass through AS
65003.
● _65004\) matches AS_Confed_Sequences
that end with a sign followed by 65004).
Specifically, _65004\) matches
AS_Confed_Sequences with 65004 as the
rightmost AS number (the number of the
first AS through which a route passes) or
matches the routes that are originated in
AS 65004. _65004\) and 65004\) have the
same function.
Multiple rules (permit or deny) can be specified in an AS_Path filter. The
relationship between theses rules is "OR", which means that if a route meets one
of the matching rules, the route matches the AS_Path filter. The following
demonstrates the functions of AS_Path filters in different scenarios.
Applications
The AS_Path filter defines only a filtering tool, which takes effect only after being
invoked. Two methods are available in BGP to invoke the AS_Path filter:
● Use the peer command.
● Use a route-policy.
Method 1: Invoke the AS_Path filter using the peer command.
#
ip as-path-filter s1 permit ^100$
#
bgp 65100
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 971
peer 10.1.1.2 as-path-filter s1 import
#
In method 1, an AS_Path filter s1 is defined and associated with a regular
expression ^100$. This AS_Path filter can match routes carrying the AS_Path
attribute 100 (this attribute contains only the AS number 100) and is applied in
the peer command. In this situation, only the routes that match AS_Path filter s1
can be advertised to the BGP peer 10.1.1.2.
Method 2: Invoke the AS_Path filter using a route-policy.
#
ip as-path-filter s1 permit ^100$
#
route-policy huawei permit node 10
if-match as-path-filter s1
apply local-preference 100
#
bgp 65100
peer 10.1.1.2 route-policy huawei import
#
In method 2, a defined AS_Path filter s1 is invoked in the if-match command in a
route-policy, and then the Local-Preference attribute is set using the apply
command and applied in the peer command (in the import direction) in BGP
configuration mode. In this situation, among the BGP routes received from the
BGP peer 10.1.1.2, all the routes that match the AS_Path filter s1 have their LP
path attributes set to 100.
AS_Path Filter Examples
In Figure 10-15, an EBGP peer relationship is established between LSW1 and
LSW2, between LSW1 and LSW3, between LSW2 and LSW3, between LSW2 and
LSW4, between LSW3 and LSW4, and between LSW4 and LSW5. Each device uses
the network command to advertise IP addresses of LoopBack0 into BGP and filter
these routes.
Figure 10-15 Using an AS_Path filter to filter BGP routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 972
If no AS_Path filter is used, the original BGP routing table of LSW1 is as follows:
[LSW1] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 9
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
*> 2.2.2.9/32 10.1.1.2 0 0 65200i
* 10.1.2.2 0 65300 65200i
*> 3.3.3.9/32 10.1.2.2 0 0 65300i
* 10.1.1.2 0 65200 65300i
*> 4.4.4.9/32 10.1.1.2 0 65200 65400i
* 10.1.2.2 0 65300 65400i
*> 5.5.5.9/32 10.1.1.2 0 65200 65400 65500i
* 10.1.2.2 0 65300 65400 65500i
Case 1: Define an AS_Path filter s1 to receive only the routes originated in
AS65500.
[LSW1] ip as-path-filter s1 permit _65500$ //Define an AS_Path filter s1.
[LSW1] bgp 65100
[LSW1-bgp] ipv4-family unicast
[LSW1-bgp-af-ipv4] peer 10.1.1.2 as-path-filter s1 import //Invoke the AS_Path filter s1 using the peer
command.
[LSW1-bgp-af-ipv4] peer 10.1.2.2 as-path-filter s1 import
After the preceding configurations are complete, the BGP routing table is as
follows:
[LSW1] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
*> 5.5.5.9/32 10.1.1.2 0 65200 65400 65500i
* 10.1.2.2 0 65300 65400 65500i
The preceding command output shows that the routes originated in AS65500 are
permitted and other routes are denied.
Case 2: Define an AS_Path filter s2 to deny the routes originated in AS65500 and
permit other routes.
[LSW1] ip as-path-filter s2 deny _65500$
[LSW1] ip as-path-filter s2 permit .*
[LSW1] bgp 65100
[LSW1-bgp] ipv4-family unicast
[LSW1-bgp-af-ipv4] peer 10.1.1.2 as-path-filter s2 import
[LSW1-bgp-af-ipv4] peer 10.1.2.2 as-path-filter s2 import
After the preceding configurations are complete, the BGP routing table is as
follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 973
[LSW1] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 7
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
*> 2.2.2.9/32 10.1.1.2 0 0 65200i
* 10.1.2.2 0 65300 65200i
*> 3.3.3.9/32 10.1.2.2 0 0 65300i
* 10.1.1.2 0 65200 65300i
*> 4.4.4.9/32 10.1.1.2 0 65200 65400i
* 10.1.2.2 0 65300 65400i
The preceding command output shows that the routes originated in AS65500 are
denied and other routes are permitted.
Case 3: Define an AS_Path filter s3 to deny the routes that pass through AS65400.
[LSW1] ip as-path-filter s3 deny _65400_
[LSW1] ip as-path-filter s3 permit .*
[LSW1] bgp 65100
[LSW1-bgp] ipv4-family unicast
[LSW1-bgp-af-ipv4] peer 10.1.1.2 as-path-filter s3 import
[LSW1-bgp-af-ipv4] peer 10.1.2.2 as-path-filter s3 import
After the preceding configurations are complete, the BGP routing table is as
follows:
[LSW1] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
*> 2.2.2.9/32 10.1.1.2 0 0 65200i
* 10.1.2.2 0 65300 65200i
*> 3.3.3.9/32 10.1.2.2 0 0 65300i
* 10.1.1.2 0 65200 65300i
The preceding command output shows that the routes that pass through AS65400
are denied and other routes are permitted.
Case 4: Define an AS_Path filter s4 to deny the routes that pass through AS65400.
AS65400 is not the first or last AS that routes pass through.
[LSW1] ip as-path-filter s4 deny ._65400_.
[LSW1] ip as-path-filter s4 permit .*
[LSW1] bgp 65100
[LSW1-bgp] ipv4-family unicast
[LSW1-bgp-af-ipv4] peer 10.1.1.2 as-path-filter s4 import
[LSW1-bgp-af-ipv4] peer 10.1.2.2 as-path-filter s4 import
After the preceding configurations are complete, the BGP routing table is as
follows:
[LSW1] display bgp routing-table
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 974
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 7
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
*> 2.2.2.9/32 10.1.1.2 0 0 65200i
* 10.1.2.2 0 65300 65200i
*> 3.3.3.9/32 10.1.2.2 0 0 65300i
* 10.1.1.2 0 65200 65300i
*> 4.4.4.9/32 10.1.1.2 0 65200 65400i
* 10.1.2.2 0 65300 65400i
The preceding command output shows that the routes carrying the AS_Path
attribute in which AS65400 is neither the first nor last AS number are denied and
other routes are permitted.
Case 5: Define an AS_Path filter s5 to permit locally originated routes and deny
routes of other ASs.
[LSW1] ip as-path-filter s5 permit ^$
[LSW1] bgp 65100
[LSW1-bgp] ipv4-family unicast
[LSW1-bgp-af-ipv4] peer 10.1.1.2 as-path-filter s5 import
[LSW1-bgp-af-ipv4] peer 10.1.2.2 as-path-filter s5 import
After the preceding configurations are complete, the BGP routing table is as
follows:
[LSW1] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
The preceding command output shows that only locally originated routes with
empty AS_Path attribute are permitted and other routes are denied.
Relevant Information
Technology Forum
Huawei S Series Switches Routing Policy
10.2.6 Community Attribute Applications in BGP
Community Attribute
The Community attribute is a set of destination addresses with the same
characteristics. It simplifies routing policy applications and facilitates routing policy
management and maintenance and allows a group of BGP devices in multiple ASs
to share the same routing policies. This attribute is a route attribute and
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 975
transmitted between BGP peers and not restricted within an AS. Before advertising
a route with the Community attribute to peers, a BGP device can change the
original Community attribute of this route.
● The Community attribute is a set of 4-byte values, in the format AA:NN. As
defined in RFC1997, the first two bytes indicate an AS number, and the last
two bytes indicate a community identifier used for management.
● The Community attribute is a BGP route tag that simplifies the
implementation of routing policy. A specific Community attribute can be
assigned to some routes. Based on this Community attribute, these routes can
be managed and routing policy can be performed on these routes.
Figure 10-16 Community attribute application
In Figure 10-16, a large number of routes in AS100 are imported into BGP, and
these routes are used for voice calls and video surveillance. These routes are
advertised to AS200 through BGP. Devices in AS200 need to carry out different
policies on the routes used for voice calls and video surveillance. How to match
these routes? You can use ACLs or IP prefix lists to match the routes one by one.
This method, however, has a heavy workload and is inefficient because a large
number of route prefixes exist.
You can use the Community attribute to address this issue. When these routes are
imported into AS100, respective Community attributes are added to the routes to
differentiate the routes used for voice calls and video surveillance. That is, the
Community attribute 100:1 is added to the routes used for voice calls, and the
Community attribute 100:2 is added to the routes used for video surveillance.
These Community attributes are transmitted to AS200 along with the routes. In
AS200, to carry out different policies for the routes used for voice calls and video
surveillance, match the routes based on their respective Community attributes. For
example, you can match all the routes used for voice calls based on the
Community attribute 100:1.
BGP defines some well-known Community attributes. Table 10-7 lists these
Community attributes.
Table 10-7 BGP well-known Community attributes
Community
Attribute
Description
internet By default, all routes belong to the internet community. A
route with this attribute can be advertised to all BGP peers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 976
Community
Attribute
Description
no-advertise A route with this attribute cannot be advertised to any
other BGP peers.
no-export A route with this attribute cannot be advertised outside the
local AS. If a confederation is defined, the route with this
attribute cannot be advertised to the ASs outside the
confederation but can be advertised to other sub-ASs in the
confederation.
no-export-
subconfed
A route with this attribute cannot be advertised outside the
local AS or advertised to other sub-ASs in the
confederation.
Setting the Community Attribute for Routes
To use the Community filter, ensure that the Community attribute is carried in
routes. The following describes how to set the Community attribute for routes.
Figure 10-17 Setting the Community attribute for routes
Requirement Description
In Figure 10-17, LSW1 in AS100 advertises two routes 10.1.1.0/24 and 10.1.2.0/24
through BGP. In the BGP process of LSW1, use an export route-policy to modify
the Community attribute of the route 10.1.1.0/24 to 100:1 so that downstream
devices can carry out policies on the route based on this Community attribute.
Configuration
The key configuration of LSW1 is as follows:
#
ip ip-prefix huawei index 10 permit 10.1.1.0 24 //Define an IP prefix list to match the target route.
#
route-policy RP permit node 10 //Define a route-policy to set the Community attribute for the
target route.
if-match ip-prefix huawei
apply community 100:1
route-policy RP permit node 20 //Permit the remaining routes.
#
bgp 100
router-id 1.1.1.1
peer 192.168.12.2 as-number 200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 977
#
ipv4-family unicast
undo synchronization
network 10.1.1.0 255.255.255.0 //Advertise the route 10.1.1.0/24.
network 10.1.2.0 255.255.255.0 //Advertise the route 10.1.2.0/24.
peer 192.168.12.2 enable
peer 192.168.12.2 route-policy RP export //Apply the route-policy in the export direction of the
specified BGP peer.
peer 192.168.12.2 advertise-community //Advertise the Community attribute to the specified BGP
peer.
#
The key configuration of LSW2 is as follows:
#
bgp 200
router-id 2.2.2.2
peer 192.168.12.1 as-number 100
peer 192.168.23.2 as-number 300
#
ipv4-family unicast
undo synchronization
peer 192.168.12.1 enable
peer 192.168.23.2 enable
peer 192.168.23.2 advertise-community //Advertise the Community attribute to the specified BGP
peer.
#
By default, the Community attribute is not updated to BGP peers along with the
route prefix. Therefore, the peer advertise-community command needs to be
configured on LSW1 and LSW2 to advertise this attribute to BGP peers.
Verification
After the preceding configurations are complete, check the BGP route 10.1.1.0 in
the BGP routing table of LSW3.
<LSW3> display bgp routing-table 10.1.1.0
BGP local router ID : 3.3.3.3
Local AS number : 300
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.23.1 (2.2.2.2)
Route Duration: 01h08m07s
Direct Out-interface: Vlanif23
Original nexthop: 192.168.23.1
Qos information : 0x0
Community:<100:1> //This Community attribute is set and transmitted to downstream devices using a
route-policy on LSW1.
AS-path 200 100, origin igp, pref-val 0, valid, external, best, select, active,
pre 255
Not advertised to any peer yet
The preceding command output shows that after the Community attribute is set
for the route, this route carries a Community attribute when reaching LSW3, which
then can carry out some policies on the route based on the Community attribute.
Multiple methods are available to set the Community attribute for BGP routes.
Table 10-8 lists common methods to set this attribute.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 978
Table 10-8 Example for setting the Community attribute for BGP routes
Command Description
apply community
100
Changes the community name to 100.
apply community
100 150
Changes the community name to 100 or 150. That is, BGP
routes belong to two communities.
apply community
100 150 additive
Adds two Community attributes 100 and 150. That, BGP
routes belong to three communities.
apply community
none
Deletes the Community attribute of BGP routes.
Using a Community Filter to Match BGP Routes
The previous section describes how to set the Community attribute for BGP routes.
After this attribute is set on an upstream router, it is transmitted along with routes
so that downstream devices can carry out policies based on this attribute. BGP
provides a tool, Community filter, to match BGP routes based on the Community
attribute. The following describes how to use a Community filter to match BGP
routes.
Figure 10-18 Using a Community filter to match BGP routes
Requirement Description
In Figure 10-18, LSW1 in AS100 advertises three BGP routes. The Community
attribute is set for the routes and transmitted along with the routes to LSW3 in
AS300. Before policies are carried out, check the BGP routing table of LSW3.
<LSW3> display bgp routing-table
BGP Local router ID is 3.3.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.23.1 0 200 100i
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 979
*> 10.1.2.0/24 192.168.23.1 0 200 100i
*> 10.1.3.0/24 192.168.23.1 0 200 100i
The preceding command output shows that the BGP routing table of LSW3
contains three routes. Routing policy needs to be carried out on LSW3 to permit
only the routes carrying the Community attribute 100:999.
Configuration
The previous section has described how to set the Community attribute. The
following describes how to use a Community filter to filter routes.
The key configuration of LSW3 is as follows:
#
ip community-filter 1 permit 100:999 //Permit the route carrying the Community attribute 100:999.
#
route-policy huawei permit node 10 //Invoke the Community filter using a route-policy.
if-match community-filter 1
#
bgp 300
router-id 3.3.3.3
peer 192.168.23.1 as-number 200
#
ipv4-family unicast
undo synchronization
peer 192.168.23.1 enable
peer 192.168.23.1 route-policy huawei import //Use the route-policy in the import direction of the
specified BGP peer.
#
Verification
After the preceding configurations are complete, check the BGP routing table of
LSW3.
[LSW3] display bgp routing-table
BGP Local router ID is 3.3.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.23.1 0 200 100i
*> 10.1.2.0/24 192.168.23.1 0 200 100i
The defined Community filter matches the route carrying the Community attribute
100:999. Therefore, the two routes 10.1.1.0/24 and 10.1.2.0/24 are permitted on
LSW3, and other BGP routes are denied.
For this scenario, the following provides three common methods to configure the
Community filter:
Case 1:
ip community-filter 1 permit 100:1 100:999
//Only the routes that carry two Community attributes 100:1 and 100:999 can be matched. Therefore, the
route 10.1.1.0/24 is matched.
Case 2:
ip community-filter 1 permit 100:1
ip community-filter 1 permit 100:2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 980
//The routes that carry the Community attribute 100:1 or 100:2 can be matched. Therefore, the routes
10.1.1.0/24 and 10.1.2.0/24 are matched.
Case 3:
ip community-filter 1 permit internet
//By default, all routes carry the Internet attribute. Therefore, all routes are matched.
Relevant Information
Technology Forum
Huawei S Series Switches Routing Policy
10.3 Summary of Routing Policy Configuration Tasks
Table 10-9 describes the routing policy configuration tasks. After routing policies
are configured, apply them only when using routing protocols to advertise, receive,
or import routes to implement the route filtering and attribute configuration
functions.
Table 10-9 Routing policy configuration tasks
Scenario Description Task
Configuring the filter Routing policy filters
include: ACLs, IP prefix lists,
AS path filters, community
filters, extended community
filters, and RD filters. These
routing policy filters can be
applied to the if-match
clauses of a routing policy
and can also be used
separately in specific
situations.
10.5 Configuring
Filters
Configuring routing
policies
To reduce network burden
and ensure network
security, apply the routing
policies with if-match
clauses in the following
situations:
● Importing routes
● Advertising and receiving
routes
● Filtering using the RT
and RD attributes in the
VPN
10.6 Configuring a
Routing Policy
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 981
Scenario Description Task
Configuring filter-policies If you need to control
receiving and advertisement
of routes in each routing
protocol, use filter-policies:
● filter-policy import
allows receiving only the
routes that meet filtering
criteria.
● filter-policy export
allows advertising only
the routes that meet
filtering criteria.
10.7 Configuring
Filter-Policy
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 982
Scenario Description Task
Configuring the valid
time of a routing policy
In practical applications,
when multiple cooperative
configurations of a routing
policy change, the routing
management (RM) module
immediately informs the
protocols to re-apply the
routing policy after a
configuration is complete. If
routing policies are
incomplete, route flapping
occurs, which results in
network instability.
The processing rules for
routing policy changes are
as follows:
● By default, if a routing
policy changes, the RM
module immediately
informs the protocols to
apply a new routing
policy.
● If the valid time of a
routing policy is
configured, the RM
module does not
immediately inform the
protocols to process the
changes when the
related command
configurations of the
routing policy change.
Instead, routing protocols
wait for the configured
valid time and then apply
a new routing policy.
● If the configuration of
the routing policy
changes again during the
configured valid time, the
RM module resets the
timer.
To configure the valid time,
run the route-policy-
change notify-delay
command.
10.8 Controlling the
Valid Time of
Routing Policies
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 983
10.4 Licensing Requirements and Limitations for
Routing Policies
Involved Network Elements
Other network elements are not required.
Licensing Requirements
Routing policy is a basic feature of a switch and is not under license control.
Feature Support in V200R024C00
All models of S300, S500, S2700, S5700, and S6700 series switches (except the
S5751-L, S5731-L and S5731S-L) support Routing Policy.
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
Feature Limitations
None.
10.5 Configuring Filters
Pre-configuration Tasks
Before configuring filters, configure routing protocols.
Configuration Procedure
Configure each of the filters in any sequence according to network requirements.
10.5.1 Configuring an IP Prefix List
Context
Configuring an IP prefix list controls the advertising and receiving of routes based
on the destination address.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 984
NOTICE
If an IP prefix list is not used together with the if-match clauses in a routing
policy, you must set at least one node to the permit mode in the IP prefix list. If
no node is set to the permit mode, all routes are filtered out.
Procedure
Step 1 Configure an IPv4 prefix list.
1. Run system-view
The system view is displayed.
2. Run ip ip-prefix
ip-prefix-name [ index
index-number ] { permit | deny }
ipv4-address mask-length [ match-network ] [ greater-equal
greater-equal-
value ] [ less-equal
less-equal-value ]
An IPv4 prefix list is configured.
Step 2 Configure an IPv6 prefix list.
1. Run system-view
The system view is displayed.
2. Run ip ipv6-prefix
ipv6-prefix-name [ index
index-number ] { permit | deny }
ipv6-address prefix-length [ match-network ] [ greater-equal
greater-equal-
value ] [ less-equal
less-equal-value ]
An IPv6 prefix list is configured.
----End
Verifying the Configuration
● Run the display ip ip-prefix [
ip-prefix-name ] command to check
information about the IPv4 prefix list.
● Run the display ip ipv6-prefix [
ipv6-prefix-name ] command to check
information about the IPv6 prefix list.
10.5.2 Configuring an AS_Path Filter
Context
An AS_Path filter is used to filter routes based on the AS_Path attributes of BGP
routes. If you do not want to receive routes of a specified AS number, configure an
AS_Path filter based on the specified AS number. On a complex network, multiple
ACLs or IP prefix lists must be configured to filter BGP routes. This can be a
complicated process; configuring an AS_Path filter can simplify the configuration.
Procedure
Step 1 Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 985
Step 2 Run ip as-path-filter {
as-path-filter-number |
as-path-filter-name } { permit |
deny }
regular-expression
An AS_Path filter is configured.
In the preceding command,
regular-expression indicates that the AS_Path filter
uses a regular expression to define matching rules.
----End
Verifying the Configuration
● Run the display ip as-path-filter [
as-path-filter-number |
as-path-filter-
name ] command to check information about a configured AS_Path filter.
10.5.3 Configuring a Community Filter
Context
The community attribute identifies routes with the same characteristics without
considering IP prefixes and AS numbers. Configuring community filters and
community attributes simplifies route management when it is inconvenient to use
the IP prefix list or AS_Path filter. For example, a company branch needs to receive
routes only from its headquarters and from branches in adjacent countries. In this
case, you can configure different community attributes for each of the branches.
Routes in the original branch can then be managed based on community
attributes, without considering IP prefixes and AS numbers of routes in different
countries.
Community filters are classified into basic and advanced community filters. An
advanced community filter supports regular expressions and is more flexible than
a basic community filter.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ip community-filter
A community filter is configured.
● To configure a basic community filter, run the ip community-filter { basic
comm-filter-name |
basic-comm-filter-num } { permit | deny } [
community-
number |
aa:nn | internet | no-export-subconfed | no-advertise | no-export ]
&<1-20> command.
● To configure an advanced community filter, run the ip community-filter
{ advanced
comm-filter-name |
adv-comm-filter-num } { permit | deny }
regular-expression command.
In the preceding command,
regular-expression indicates that the community filter
uses a regular expression to define matching rules.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 986
Verifying the Configuration
● Run the display ip community-filter [
basic-comm-filter-num |
adv-comm-
filter-num |
comm-filter-name ] command to check information about a
configured community filter.
10.5.4 Configuring an Extended Community Filter
Context
You can use an extended community filter when using the route target (RT)
attribute to filter routes in a VPN.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ip extcommunity-filter {
basic-extcomm-filter-num | basic
basic-extcomm-
filter-name } { deny | permit } { rt {
as-number:nn |
4as-number:nn |
ipv4-
address:
nn } } &<1-16>
Or run ip extcommunity-filter {
advanced-extcomm-filter-num | advanced
advanced-extcomm-filter-name } { deny | permit }
regular-expression
An extended community filter is configured.
----End
Verifying the Configuration
Run the display ip extcommunity-filter [
basic-extcomm-filter-num |
advanced-
extcomm-filter-num |
extcomm-filter-name ] command to check information
about a configured extended community filter.
10.5.5 Configuring an RD Filter
Context
You can use an RD filter when using the RD attribute to filter routes in a VPN.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ip rd-filter
rd-filter-number { deny | permit }
route-distinguisher &<1-10>
An RD filter is configured.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 987
Verifying the Configuration
● Run the display ip rd-filter [
rd-filter-number ] command to check
information about a configured RD filter.
10.6 Configuring a Routing Policy
Pre-configuration Tasks
Before configuring a routing policy, configure routing protocols.
Configuration Procedure
Before configuring the if-match and apply clauses, you must configure a routing
policy. You can configure the if-match and apply clauses in any sequence
according to network requirements.
10.6.1 Creating a Routing Policy
Context
A routing policy can consist of multiple matching rules and actions.
NOTICE
You must set at least one node to the permit mode in a routing policy; otherwise,
all routes are filtered out.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run route-policy
route-policy-name { permit | deny } node
node
A routing policy is created, and the routing policy view is displayed.
When a routing policy is used to filter a route, the route is matched with nodes in
the routing policy in ascending order of node ID. Therefore, a route is first
matched with the node with the smallest node ID. If a route matches a node in
the routing policy, the system does not continue to match it with other nodes. If a
route fails to match all the nodes in the routing policy, the route is filtered out.
Step 3 (Optional) Run description
text
The description of the routing policy is configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 988
NOTE
By default, the system does not allow a nonexistent route-policy to be specified in a
command. To enable the system to allow a nonexistent route-policy to be specified in a
command, run the route-policy nonexistent-config-check disable command.
----End
10.6.2 (Optional) Configuring an if-match Clause
Context
An if-match clause defines matching rules related to route filters and attributes in
a routing policy.
If no if-match clause is configured for a node in a routing policy, routes match the
routing policy in this node. If one or more if-match clauses are configured in a
node, the relationship between the clauses is "AND". This means that a route
matches this node only when they match all the if-match clauses in this node.
This rule does not apply to if-match as-path-filter, if-match community-filter,
if-match extcommunity-filter, if-match interface, or if-match route-type
clauses. The relationship between these clauses is "OR", and the relationship
between these clauses and other if-match clauses is "AND". For example, if
multiple if-match as-path-filter clauses are configured in a node, the relationship
between these clauses is "OR", and the relationship between these clauses and
other if-match clauses is "AND".
NOTE
If an if-match clause defines a filter that is not configured, all routes match this if-match
clause by default.
The if-match acl and if-match ip-prefix commands cannot be used together in the same
node. When both the commands are used in a node, the most recently configured one
overrides the previous one.
NOTICE
When modifying the configurations of cooperative routing policies with multiple
if-match clauses, it is recommended that you also perform the configuration task
of 10.8 Controlling the Valid Time of Routing Policies. Otherwise, an
incomplete routing policy will cause route flapping.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run route-policy
route-policy-name { permit | deny } node
node
The routing policy view is displayed.
Step 3 Configure if-match clauses in any sequence for a routing policy according to your
network requirements.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 989
● Run if-match acl {
acl-number |
acl-name }
An if-match clause is configured to match the basic ACL.
● Run if-match as-path-filter {
as-path-filter-number &<1-16> |
as-path-filter-
name }
An if-match clause is configured to match AS_Path filters.
● Run either of the following commands as required to configure an if-match
clause based on community filters:
– if-match community-filter {
basic-comm-filter-num [ whole-match ] |
adv-comm-filter-num } &<1-16>
– if-match community-filter
comm-filter-name [ whole-match ]
● Run if-match extcommunity-filter { {
basic-extcomm-filter-num |
adv-
extcomm-filter-num } &<1-16> |
extcomm-filter-name }
An if-match clause is configured to match extended community filters.
● Run if-match cost {
cost | greater-equal
greater-equal-value [ less-equal
less-equal-value ] | less-equal
less-equal-value }
An if-match clause is configured to match the route cost of routes.
● Run if-match interface {
interface-type interface-number } &<1-16>
An if-match clause is configured to match the outbound interface of routes.
● Run if-match ip { next-hop | route-source | group-address } { acl {
acl-
number |
acl-name } | ip-prefix
ip-prefix-name }
An if-match clause is configured to match the next hop or source address of
IPv4 routes.
● Run if-match ipv6 { address | next-hop | route-source } prefix-list
ipv6-
prefix-name
An if-match clause is configured to match the destination address, next hop,
or source address of IPv6 routes.
● Run if-match ip-prefix
ip-prefix-name
An if-match clause is configured to match the IP prefix list.
● Run if-match rd-filter
rd-filter-number
An if-match clause is configured to match the RD filter.
● Run the following command as required to match the type of route:
– Run if-match route-type { external-type1 | external-type1or2 |
external-type2 | internal | nssa-external-type1 | nssa-external-
type1or2 | nssa-external-type2 }
An if-match clause is configured to match a specified type of OSPF
routes.
– Run if-match route-type { is-is-level-1 | is-is-level-2 }
An if-match clause is configured to match a specified type of IS-IS routes.
● Run if-match tag
tag
An if-match clause is configured to match the tag of routes.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 990
10.6.3 (Optional) Configuring an apply Clause
Context
An apply clause specifies the action of setting attributes for routes that have
matched a routing policy node. If a node does not have an apply clause
configured, the node will only filter routes. If one or more apply clauses are
configured in a node, all the apply clauses are applied to routes that have
matched the node.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run route-policy
route-policy-name { permit | deny } node
node
The route-policy view is displayed.
Step 3 Run the following commands as required to configure apply clauses. A node can
have multiple or no apply clauses.
● Run apply as-path { {
as-number-plain |
as-number-dot } &<1-10> { additive
| overwrite } | none overwrite }
An apply clause is configured to change the AS_Path attribute of BGP routes.
● Run apply backup-interface
interface-type interface-number
An apply clause is configured to change the backup outbound interface of
routes.
● Run apply backup-nexthop {
ip-address | auto }
An apply clause is configured to change the backup next hop of routes.
● Run apply comm-filter {
basic-comm-filter-number |
adv-comm-filter-
number |
comm-filter-name } delete
An apply clause is configured to delete the specified community attribute of
BGP routes.
NOTE
To delete the community attributes, you can run the ip community-filter command
several times to configure community attributes one by one, and apply the routing
policy containing the apply comm-filter delete command to delete these community
attributes. If multiple community attributes are specified in one community filter, none
of them can be deleted.
● Run apply community none
An apply clause is configured to delete all community attributes of BGP
routes.
● Run apply community {
community-number |
aa:nn | internet | no-advertise
| no-export | no-export-subconfed } &<1-32> [ additive ]
An apply clause is configured to set the community attributes of BGP routes.
● Run apply cost [ + | - ]
cost
The route cost is set.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 991
● Run the following commands as required to set the cost type of a route:
– Run apply cost-type { external | internal }
The IS-IS cost type is set.
– Run apply cost-type { type-1 | type-2 }
The OSPF cost type is set.
● Run apply dampening
half-life-reach reuse suppress ceiling
The dampening parameters of EBGP routes are set.
● Run apply extcommunity { rt {
as-number:nn |
4as-number:nn |
ipv4-
address:nn } }&<1-16> [ additive ]
An extended community attribute (route-target) of BGP is set.
● Run apply ip-address next-hop {
ipv4-address | peer-address }
The next-hop address of the IPv4 route is set.
● Run apply ipv6 next-hop { peer-address |
ipv6-address }
The next-hop address of the IPv6 route is set.
● Run apply isis { level-1 | level-1-2 | level-2 }
The level of the IS-IS route is set.
● Run apply local-preference
preference
The local preference for BGP routes is set.
● Run apply origin { egp {
as-number-plain |
as-number-dot } | igp |
incomplete }
The Origin attribute of BGP routes is set.
● Run apply ospf { backbone | stub-area }
An OSPF area into which routes are imported is set.
● Run apply preference
preference
The preference of the routing protocol is set.
● Run apply preferred-value
preferred-value
A preferred value is set for BGP routes.
● Run apply tag
tag
The route tag is set.
----End
10.6.4 (Optional) Enabling Further Route Matching Against a
Specified Node
Context
The relationship among the matching rules of nodes in the same route-policy is
OR. Specifically, if a route matches a node, it matches the route-policy and is no
longer matched against other nodes. If you want the route to be matched against
two or more nodes, run the goto next-node command so that the route is further
matched against a specified node after the route matches the current node.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 992
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run route-policy
route-policy-name { permit | deny } node
node
The route-policy view is displayed.
Step 3 Run goto next-node [
node ]
The route-policy is configured to further match routes against a specified node
after the routes match the current node.
● If
node is not specified in the command, the route will be further matched
against the next node of the current node by default.
● If the node specified in the command does not exist, the route will be further
matched against the next node of the specified node by default. If the next
node of the specified node does not exist either, the route fails to match the
route-policy, and no apply clause will be applied to the route.
----End
10.6.5 Applying a Route-Policy
Context
A route-policy can be applied to direct, static, RIP/RIPng, IS-IS, OSPF/OSPFv3, BGP/
BGP4+, multicast, and BGP/MPLS IP VPN routes. In addition, a route-policy can be
applied to an FRR scenario. Perform one of the following configurations as
needed:
● Apply a route-policy to direct routes.
● Apply a route-policy to RIP routes.
● Apply a route-policy to RIPng routes.
● Apply a route-policy to IPv4 IS-IS routes.
● Apply a route-policy to IPv6 IS-IS routes.
● Apply a route-policy to OSPF routes.
● Apply a route-policy to OSPFv3 routes.
● Apply a route-policy to BGP routes.
● Apply a route-policy to BGP4+ routes.
● Apply a route-policy to multicast routes.
● Apply a route-policy to BGP/MPLS IP VPN routes.
● Apply a route-policy to an FRR scenario.
NOTE
By default, the system does not allow a nonexistent route-policy to be specified in a
command. To enable the system to allow a nonexistent route-policy to be specified in a
command, run the route-policy nonexistent-config-check disable command.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 993
Procedure
● Apply a route-policy to direct routes.
a. Run system-view
The system view is displayed.
b. To apply a route-policy to specific direct routes, see Table 10-10.
Table 10-10 Applying a route-policy to direct routes
Configuration
Task
Command Reference
Configure a
device to
advertise ARP
Vlink direct
routes that
match a route-
policy on the
public network
arp vlink-direct-route
advertise [ route-policy
route-policy-name ]
11.2.7 Configuring
the Advertisement
of IPv4 ARP Vlink
Direct Routes
● Apply a route-policy to RIP routes.
a. Run system-view
The system view is displayed.
b. Run rip [
process-id ]
A RIP process is enabled, and the RIP view is displayed.
c. To apply a route-policy to specific RIP routes, see Table 10-11.
Table 10-11 Applying a route-policy to RIP routes
Configuration
Task
Command Reference
Configure a
device to
generate a
default route or
advertise a
default route in
the routing table
to neighbors only
when the
matching
conditions of a
route-policy are
met.
default-route originate
[ cost
cost | { match default |
route-policy
route-policy-
name } [ avoid-learning ] ]*
3.10.1 Configuring
RIP to Advertise
Default Routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 994
Configuration
Task
Command Reference
Configure RIP to
import the BGP
routes that match
a route-policy.
import-route bgp [ permit-
ibgp ] [ cost {
cost |
transparent } | route-policy
route-policy-name ] *
3.10.3 Configuring
RIP to Import Routes
Configure RIP to
import routes
that match a
route-policy from
another routing
protocol.
import-route { { static |
direct | unr } | { rip | ospf |
isis } [
process-id ] } [ cost
cost | route-policy
route-
policy-name ] *
3.10.3 Configuring
RIP to Import Routes
Set a priority for
routes that match
a route-policy.
preference {
preference |
route-policy
route-policy-
name } *
3.9.1 Configuring RIP
Preference
● Apply a route-policy to RIPng routes.
a. Run system-view
The system view is displayed.
b. Run ripng [
process-id ]
A RIPng process is enabled, and the RIPng view is displayed.
c. To apply a route-policy to specific RIPng routes, see Table 10-12.
Table 10-12 Applying a route-policy to RIPng routes
Configuration
Task
Command Reference
Configure RIPng
to import routes
that match a
route-policy from
another routing
protocol.
import-route { { ripng | isis |
ospfv3 } [
process-id ] | bgp
[ permit-ibgp ] | unr | direct |
static } [ [ cost
cost | inherit-
cost ] | route-policy
route-
policy-name ] *
4.9.3 Configuring a
RIPng Process to
Import External
Routes
Set a priority for
RIPng routes that
match a route-
policy.
preference {
preference |
route-policy
route-policy-
name } *
4.8.1 Configuring
RIPng Preference
● Apply a route-policy to IPv4 IS-IS routes.
– To apply a route-policy in the IS-IS view, perform the following
operations:
i. Run the system-view command to enter the system view.
ii. Run the isis [
process-id ] command to enter the IS-IS view.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 995
iii. To apply a route-policy to IPv4 IS-IS routes in the IS-IS view, see
Table 10-13.
Table 10-13 Applying a route-policy to IPv4 IS-IS routes in the IS-IS view
Configuration
Task
Command Reference
Configure IS-IS
to generate and
advertise default
routes to the IS-
IS domain only
when external
routes that
match a route-
policy exist in
the routing table
of a Level-1-2
router.
default-route-advertise
[ always | match default |
route-policy
route-policy-
name ] [ cost
cost | tag
tag
| [ level-1 | level-1-2 |
level-2 ] ] * [ avoid-
learning ]
7.9.1 Configuring
IS-IS to Advertise a
Default Route
Configure IS-IS
to advertise the
routes that are
imported from
another routing
protocol and
match a route-
policy.
filter-policy route-policy
route-policy-name export
[
protocol [
process-id ] ]
7.9.3 Configuring
IS-IS to Advertise
Specified External
Routes to an IS-IS
Routing Domain
Configure IS-IS
to accept the
routes that
match a route-
policy.
filter-policy route-policy
route-policy-name import
7.9.4 Adding
Specified IS-IS
Routes to the IP
Routing Table
Configure IS-IS
to import routes
that match a
route-policy
from another
routing protocol.
import-route { { rip | isis |
ospf } [
process-id ] | static
| direct | unr | bgp
[ permit-ibgp ] } [ cost-
type { external | internal } |
cost
cost | tag
tag | route-
policy
route-policy-name |
[ level-1 | level-2 |
level-1-2 ] ] *
import-route { { rip | isis |
ospf } [
process-id ] | direct
| unr | bgp } inherit-cost
[ tag
tag | route-policy
route-policy-name |
[ level-1 | level-2 |
level-1-2 ] ] *
7.9.2 Configuring
IS-IS to Import
External Routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 996
Configuration
Task
Command Reference
Leak Level-1
routes that
match a route-
policy to a
Level-2 area.
import-route isis level-1
into level-2 filter-policy
route-policy
route-policy-
name
7.8.4 Configuring
IS-IS Route Leaking
Leak Level-2
routes that
match a route-
policy to a
Level-1 area.
import-route isis level-2
into level-1 filter-policy
route-policy
route-policy-
name
7.8.4 Configuring
IS-IS Route Leaking
Configure a
priority for the
IS-IS routes that
match a route-
policy.
preference {
preference |
route-policy
route-policy-
name } *
7.8.1 Configuring a
Preference Value
for IS-IS
– To apply a route-policy in the IS-IS FRR view, perform the following
operations:
i. Run the system-view command to enter the system view.
ii. Run the isis [
process-id ] command to enter the IS-IS view.
iii. Run the frr command to enter the IS-IS FRR view.
iv. Run the frr-policy route route-policy
route-policy-name command
to configure IS-IS to add the backup routes that match a route-policy
to the IP routing table.
For details on how to configure IS-IS Auto FRR (IPv4), see 7.15
Configuring IPv4 IS-IS Auto FRR.
● Apply a route-policy to IPv6 IS-IS routes.
– To apply a route-policy in the IS-IS view, perform the following
operations:
i. Run the system-view command to enter the system view.
ii. Run the isis [
process-id ] command to enter the IS-IS view.
iii. To apply a route-policy to IPv6 IS-IS routes in the IS-IS view, see
Table 10-14.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 997
Table 10-14 Applying a route-policy to IPv6 IS-IS routes in the IS-IS view
Configuration
Task
Command Reference
Configure IS-IS
to generate and
advertise default
IPv6 routes to
the IS-IS domain
only when
external routes
that match a
route-policy exist
in the routing
table of a
Level-1-2 router.
ipv6 default-route-
advertise route-policy
route-policy-name [ cost
cost | tag
tag | [ level-1 |
level-1-2 | level-2 ] ] *
[ avoid-learning ]
8.9.1 Configuring
IS-IS to Advertise a
Default Route
Configure IS-IS
to advertise the
IPv6 routes that
are imported
from another
routing protocol
and match a
route-policy.
ipv6 filter-policy route-
policy
route-policy-name
export [
protocol [
process-
id ] ]
8.9.3 Configuring
IS-IS to Advertise
Specified External
Routes to an IS-IS
Routing Domain
Configure IS-IS
to accept the
IPv6 routes that
match a route-
policy.
ipv6 filter-policy route-
policy
route-policy-name
import
8.9.4 Adding
Specified IS-IS
Routes to an IPv6
Routing Table
Configure IS-IS
to import IPv6
routes that
match a route-
policy from
another routing
protocol.
ipv6 import-route { static |
direct | unr | { ospfv3 |
ripng | isis } [
process-id ] |
bgp [ permit-ibgp ] } [ cost
cost | tag
tag | route-policy
route-policy-name |
[ level-1 | level-2 |
level-1-2 ] ] *
ipv6 import-route { direct |
unr | { ospfv3 | ripng | isis }
[
process-id ] | bgp
[ permit-ibgp ] } inherit-
cost [ tag
tag | route-policy
route-policy-name |
[ level-1 | level-2 |
level-1-2 ] ] *
8.9.2 Configuring
IS-IS to Import
External Routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 998
Configuration
Task
Command Reference
Leak Level-1
IPv6 routes that
match a route-
policy to a
Level-2 area.
ipv6 import-route isis
level-1 into level-2 [ filter-
policy route-policy
route-
policy-name | tag
tag ] *
8.8.4 Configuring
IS-IS IPv6 Route
Leaking
Leak Level-2
IPv6 routes that
match a route-
policy to a
Level-1 area.
ipv6 import-route isis
level-2 into level-1 [ filter-
policy route-policy
route-
policy-name | tag
tag ] *
8.8.4 Configuring
IS-IS IPv6 Route
Leaking
Configure a
priority for the
IPv6 IS-IS routes
that match a
route-policy.
ipv6 preference { route-
policy
route-policy-name |
preference } *
8.8.1 Configuring a
Preference Value
for IPv6 IS-IS
● Apply a route-policy to OSPF routes.
– To apply a route-policy in the OSPF view, perform the following
operations:
i. Run the system-view command to enter the system view.
ii. Run the ospf [
process-id ] command to enable an OSPF process and
enter the OSPF view.
iii. To apply a route-policy to OSPF routes in the OSPF view, see Table
10-15.
Table 10-15 Applying a route-policy to OSPF routes
Configuration
Task
Command Reference
Configure OSPF
to advertise the
default routes in
the routing table
that are not
generated by
OSPF to a
common area
based on the
parameters of a
route-policy.
default-route-advertise
[ [ always | permit-
calculate-other ] | cost
cost
| type
type | route-policy
route-policy-name [ match-
any ] ] *
5.15.2 Configuring
OSPF to Advertise
Default Routes to
an OSPF Area
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 999
Configuration
Task
Command Reference
Configure OSPF
to advertise the
routes that are
imported from
another routing
protocol and
match a route-
policy.
filter-policy route-policy
route-policy-name export
[
protocol [
process-id ] ]
5.15.5 Configuring
OSPF to Filter the
Routes to Be
Advertised
Configure OSPF
to accept the
routes that
match a route-
policy.
filter-policy route-policy
route-policy-name
[ secondary ] import
5.15.4 Configuring
OSPF to Filter
Received Routes
Configure OSPF
to import the
routes that
match a route-
policy.
import-route { limit
limit-
number | { bgp [ permit-
ibgp ] | direct | unr | rip
[
process-id-rip ] | static |
isis [
process-id-isis ] | ospf
[
process-id-ospf ] } [ cost
cost | type
type | tag
tag |
route-policy
route-policy-
name ] * }
5.15.1 Configuring
OSPF to Import
External Routes
Configure a
priority for OSPF
routes that
match a route-
policy.
preference [ ase ]
{
preference | route-policy
route-policy-name } *
5.20.1 Setting a
Priority for OSPF
Routes
– To apply a route-policy in the OSPF area view, perform the following
operations:
i. Run the system-view command to enter the system view.
ii. Run the ospf [
process-id ] command to enable an OSPF process and
enter the OSPF process view.
iii. Run the area
area-id command to enter the OSPF area view.
iv. Perform either of the following operations to apply a route-policy in
the OSPF area view:
○ Run the filter route-policy
route-policy-name export command
to apply a route-policy to outgoing Type 3 LSAs (summary LSAs)
in the area.
○ Run the filter route-policy
route-policy-name import command
to apply a route-policy to incoming Type 3 LSAs in the area.
5.15.7 Configuring OSPF to Filter ABR Type3 LSAs
– To apply a route-policy in the OSPF FRR view, perform the following
operations:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1000
i. Run the system-view command to enter the system view.
ii. Run the ospf [
process-id ] command to enable an OSPF process and
enter the OSPF process view.
iii. Run the frr command to enter the OSPF FRR view.
iv. Run the loop-free-alternate command to enable OSPF IP FRR to
generate a loop-free backup link.
v. Run the frr-policy route route-policy
route-policy-name command
to configure OSPF to add the backup routes that match a route-
policy to the IP routing table.
For details on how to configure OSPF IP FRR, see 5.17.1 Enabling
OSPF IP FRR.
● Apply a route-policy to OSPFv3 routes.
– To apply a route-policy in the OSPFv3 view, perform the following
operations:
i. Run the system-view command to enter the system view.
ii. Run the ospfv3 [
process-id ] command to enable an OSPFv3 process
and enter the OSPFv3 process view.
iii. To apply a route-policy to OSPFv3 routes in the OSPFv3 view, see
Table 10-16.
Table 10-16 Applying a route-policy to OSPFv3 routes
Configuration
Task
Command Reference
Configure
OSPFv3 to
advertise the
default routes in
the routing table
that are not
generated by
OSPFv3 to an
OSPFv3 area
based on the
parameters of a
route-policy.
default-route-advertise
[ always | cost
cost | type
type | tag
tag | route-policy
route-policy-name ] *
6.11.3 Configuring
OSPFv3 to Import
External Routes
Configure
OSPFv3 to
import the
routes that
match a route-
policy.
import-route { bgp
[ permit-ibgp ] | unr |
direct | ripng
help-process-
id | static | isis
help-process-
id | ospfv3
help-process-id }
[ { cost
cost | inherit-cost }
| type
type | tag
tag | route-
policy
route-policy-name ]*
6.11.3 Configuring
OSPFv3 to Import
External Routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1001
Configuration
Task
Command Reference
Configure a
priority for
OSPFv3 routes
that match a
route-policy.
preference [ ase ]
{
preference | route-policy
route-policy-name } *
-
– To apply a route-policy in the OSPFv3 area view, perform the following
operations:
i. Run the system-view command to enter the system view.
ii. Run the ospfv3 [
process-id ] command to enable an OSPFv3 process
and enter the OSPFv3 process view.
iii. Run the area
area-id command to enter the OSPFv3 area view.
iv. Perform either of the following operations to apply a route-policy in
the OSPFv3 area view:
○ Run the filter route-policy
route-policy-name export command
to apply a route-policy to outgoing Type 3 LSAs (Inter-Area-
Prefix-LSAs) in the area.
○ Run the filter route-policy
route-policy-name import command
to apply a route-policy to incoming Type 3 LSAs in the area.
For details on how to apply a route-policy to Type 3 LSAs in an
OSPFv3 area, see 6.11.4 (Optional) Configuring OSPFv3 to Filter
LSAs in an Area.
● Apply a route-policy to BGP routes.
a. Run the system-view command to enter the system view.
b. Run the bgp {
as-number-plain |
as-number-dot } command to enter the
BGP view.
c. Run the ipv4-family unicast command to enter the IPv4 unicast address
family view.
d. To apply a route-policy to specific BGP routes, see Table 10-17.
Table 10-17 Applying a route-policy to BGP routes
Configuration
Task
Command Reference
Configure a
summarized BGP
route and apply
a route-policy to
it.
aggregate
ipv4-address
{
mask |
mask-length } [ as-
set | attribute-policy
route-
policy-name1 | detail-
suppressed | origin-policy
route-policy-name2 |
suppress-policy
route-
policy-name3 ] *
9.13 Configuring
BGP Route
Summarization
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1002
Configuration
Task
Command Reference
Configure BGP
route
dampening.
dampening [
half-life-reach
reuse suppress ceiling |
route-policy
route-policy-
name ] *
-
Configure BGP
to import routes
that match a
route-policy
from another
routing protocol.
import-route
protocol
[
process-id ] [ med
med |
route-policy
route-policy-
name ] *
9.6.5 Configuring
BGP to Import
Routes
Import local
routes that
match a route-
policy to the
BGP routing
table and
advertise them
to BGP peers.
network
ipv4-address
[
mask |
mask-length ]
[ route-policy
route-policy-
name ]
9.6.5 Configuring
BGP to Import
Routes
Enable BGP
route recursion
based on a
route-policy.
nexthop recursive-lookup
route-policy
route-policy-
name
9.9.2 Configuring
the Next_Hop
Attribute
Configure a
device to send a
default route to
a peer or a peer
group and use a
route-policy to
modify the
attributes of the
default route.
peer {
group-name |
ipv4-
address } default-route-
advertise [ route-policy
route-policy-name ]
[ conditional-route-match-
all {
ipv4-address1 {
mask1 |
mask-length1 } } &<1-4> |
conditional-route-match-
any {
ipv4-address2 {
mask2
|
mask-length2 } } &<1-4> ]
9.14 Configuring
BGP to Advertise
Default Routes to
Peers
Configure a
device to accept
the routes that
match a route-
policy from a
peer or peer
group or
advertise the
routes that
match a route-
policy to a peer
or peer group.
peer {
group-name |
ipv4-
address } route-policy
route-policy-name { import
| export }
9.10.2 Controlling
the Advertisement
of BGP Routes
9.10.3 Controlling
the Receiving of
BGP Routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1003
Configuration
Task
Command Reference
Use a route-
policy to set a
BGP priority.
preference route-policy
route-policy-name
9.9.1 Configuring
the BGP Priority
Prevent the BGP
routes that
match a route-
policy from
being added to
the IP routing
table.
routing-table rib-only
[ route-policy
route-policy-
name ]
-
● Apply a route-policy to BGP4+ routes.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run ipv6-family [ unicast ]
The IPv6 unicast address family view is displayed.
d. To apply a route-policy to specific BGP4+ routes, see Table 10-18.
Table 10-18 Applying a route-policy to BGP4+ routes
Configuration
Task
Command Reference
Configure a
summarized
BGP4+ route and
apply a route-
policy to it.
aggregate
ipv6-address
prefix-length [ as-set |
attribute-policy
route-
policy-name1 | detail-
suppressed | origin-policy
route-policy-name2 |
suppress-policy
route-
policy-name3 ] *
9.13 Configuring
BGP Route
Summarization
Configure BGP4+
route
dampening and
apply
dampening
parameters to
the routes that
match a route-
policy.
dampening [
half-life-reach
reuse suppress ceiling |
route-policy
route-policy-
name ] *
-
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1004
Configuration
Task
Command Reference
Configure BGP4+
to import routes
that match a
route-policy
from another
routing protocol.
import-route
protocol
[
process-id ] [ med
med |
route-policy
route-policy-
name ] *
9.6.5 Configuring
BGP to Import
Routes
Import local
routes that
match a route-
policy to the
BGP4+ routing
table and
advertise them
to BGP4+ peers.
network
ipv6-address
prefix-length [ route-policy
route-policy-name ]
9.6.5 Configuring
BGP to Import
Routes
Enable BGP4+
route recursion
based on a
route-policy.
nexthop recursive-lookup
route-policy
route-policy-
name
9.9.2 Configuring
the Next_Hop
Attribute
Configure a
device to send a
default route to
a peer or a peer
group and use a
route-policy to
modify the
attributes of the
default route.
peer {
group-name |
ipv6-
address } default-route-
advertise [ route-policy
route-policy-name ]
9.14 Configuring
BGP to Advertise
Default Routes to
Peers
Configure a
device to accept
the routes that
match a route-
policy from a
peer or peer
group or
advertise the
routes that
match a route-
policy to a peer
or peer group.
peer {
group-name |
ipv6-
address } route-policy
route-policy-name { import
| export }
9.10.2 Controlling
the Advertisement
of BGP Routes
9.10.3 Controlling
the Receiving of
BGP Routes
Use a route-
policy to set a
BGP4+ priority.
preference route-policy
route-policy-name
9.9.1 Configuring
the BGP Priority
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1005
Configuration
Task
Command Reference
Prevent the
BGP4+ routes
that match a
route-policy
from being
added to the
IPv6 routing
table.
routing-table rib-only
[ route-policy
route-policy-
name ]
-
● Apply a route-policy to multicast routes.
a. Run the system-view command to enter the system view.
b. Run the ip rpf-route-static [ vpn-instance
vpn-instance-name ]
source-
address {
mask |
mask-length } [ isis
process-id | ospf
process-id | rip
process-id | bgp | static ] [ route-policy
route-policy-name ] {
interface-
type interface-number |
gateway-address } [ preference
preference ]
[ order
order-number ] command to configure multicast static routes and
use route-policy
route-policy-name to configure matching rules of
multicast static routes.
For details on how to configure multicast static routes, see Configuring a
Multicast Static Route.
● Apply a route-policy to BGP/MPLS IP VPN routes.
– To apply a route-policy in the BGP view, perform the following
operations:
i. Run the system-view command to enter the system view.
ii. Run the bgp {
as-number-plain |
as-number-dot } command to enter
the BGP view.
iii. Run the ingress-lsp trigger route-policy
route-policy-name
command to enable the function of establishing ingress LSPs for
labeled BGP routes based on a route-policy.
On a MAN where the hybrid access mode is used, a large number of
BGP labeled routes are used to establish end-to-end LSPs. Some
intermediate nodes do not need to carry VPN services, but excessive
ingress LSPs are created, wasting network resources. In this situation,
run this command to establish ingress LSPs based on a route-policy
to reduce network resource consumption.
– To apply a route-policy in the VPN instance view, perform the following
operations:
i. Run the system-view command to enter the system view.
ii. Run the ip vpn-instance
vpn-instance-name command to enter the
VPN instance view.
iii. Perform either of the following operations as required:
○ To associate the current VPN instance address family with one
export route-policy, run the export route-policy
route-policy-
name command. Only one route-policy can be associated, and
the last associated route-policy takes effect.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1006
The export command can control route transmission between
different VPN instances on a PE, while the peer route-policy
export command can control only the VPNv4 or VPNv6 routes
that a PE sends to other PE peers.
○ To associate the current VPN instance address family with one
import route-policy, run the import route-policy
route-policy-
name command. Only one route-policy can be associated, and
the last associated route-policy takes effect.
The import route-policy command can control route receiving
between different VPN instances on a PE, while the peer route-
policy import command can control only the VPNv4 or VPNv6
routes that a PE sends to other PE peers.
● Apply a route-policy to an FRR scenario.
– For route-policy applications in IP FRR on the public network, see
Configuring IP FRR on the Public Network.
– For route-policy applications in IP FRR for VPN routes, see Configuring IP
FRR for VPN Routes.
– For route-policy applications in IP+VPNv4 hybrid FRR, see Configuring IP
+VPNv4 Hybrid FRR.
– For route-policy applications in VPN FRR, see Configuring VPN FRR.
----End
10.6.6 Verifying the Routing Policy Configuration
Procedure
● Run the display route-policy [
route-policy-name ] command to check
information about the route-policy.
----End
10.7 Configuring Filter-Policy
Pre-configuration Tasks
Before configuring a filter-policy, configure routing protocols.
Configuration Procedure
You can configure a filter-policy to filter the routes to be received or advertised.
Choose one of the following configurations as needed:
10.7.1 Applying Filters to Received Routes
Procedure
● Configuring RIP to filter received routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1007
a. Run system-view
The system view is displayed.
b. Run rip [
process-id ]
The RIP view is displayed.
c. Depending on type of desired filtering, run one of following commands
to configure RIP to filter the received routes:
▪ Run filter-policy {
acl-number | acl-name
acl-name } import
[
interface-type interface-number ]
Learned routing information is filtered based on an ACL.
▪ Run filter-policy gateway
ip-prefix-name import
Routing information advertised by neighbors is filtered based on the
IP prefix list.
▪ Run filter-policy ip-prefix
ip-prefix-name [ gateway
ip-prefix-
name ] import [
interface-type interface-number ]
Routes learned by the specified interface are filtered based on the IP
prefix list and neighbors.
● Configuring OSPF to filter received routes
a. Run system-view
The system view is displayed.
b. Run ospf [
process-id ]
The OSPF process view is displayed.
c. Run filter-policy {
acl-number | acl-name
acl-name | ip-prefix
ip-prefix-
name | route-policy
route-policy-name [ secondary ] } import
OSPF is configured to filter received routes.
▪ The
acl-number parameter specifies the number of a basic ACL.
▪ The acl-name
acl-name parameter specifies the name of an ACL.
▪ The ip-prefix
ip-prefix-name parameter specifies the name of an IP
prefix list.
The filter-policy import command filters the routes calculated by OSPF
but cannot filter advertised or received LSAs. Only the routes that pass
the filtering criteria are added to the OSPF routing table. However, routes
that do not pass the filtering criteria are not added to the OSPF routing
table but can still be advertised.
● Configuring IS-IS to filter received routes
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run filter-policy {
acl-number | acl-name
acl-name | ip-prefix
ip-prefix-
name | route-policy
route-policy-name } import
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1008
IS-IS routes that match the filter-policy are delivered to the IP routing
table.
● Configure the BGP device to filter the routes received from all its peers or
peer groups.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform either of the following operations to configure the BGP device to
filter the routes received from all its peers or peer groups:
▪ To filter routes based on an ACL, run the filter-policy {
acl-number |
acl-name
acl-name } import or the filter-policy {
acl6-number |
acl6-name
acl6-name } import command.
▪ To filter routes based on an IP prefix list, run the filter-policy ip-
prefix
ip-prefix-name import or the filter-policy ipv6-prefix
ipv6-
prefix-name import command.
NOTE
If an ACL has been referenced in the filter-policy command but no VPN instance
is specified in the ACL rule, BGP will filter routes including public and private
network routes in all address families. If a VPN instance is specified in the ACL
rule, only the data traffic from the VPN instance will be filtered, and no route of
this VPN instance will be filtered.
● Configure BGP to filter the routes received from a specified peer or peer
group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform any of the following operations to configure the BGP device to
filter the routes received from a specific peer or peer group:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1009
▪ To filter routes based on an ACL, run the peer {
group-name |
ipv4-
address |
ipv6-address } filter-policy {
acl-number | acl-name
acl-
name |
acl6-number | acl6-name
acl6-name } import command.
▪ To filter routes based on an IP prefix list, run the peer {
ipv4-address
|
group-name } ip-prefix
ip-prefix-name import or the peer {
group-
name |
ipv4-address |
ipv6-address } ipv6-prefix
ipv6-prefix-name
import command.
▪ To filter routes based on an AS_Path filter, run the peer {
ipv4-
address |
group-name |
ipv6-address } as-path-filter {
as-path-filter-
number |
as-path-filter-name } import command.
▪ To filter routes based on a route-policy, run the peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-policy-name import
command.
NOTE
The routing policy applied in the peer route-policy import command does not
support a specific interface as one matching rule. That is, the routing policy does
not support the if-match interface command.
NOTICE
If the number of routes received by the local device exceeds the upper
limit and the peer route-limit command is used for the first time, the
local device and its peer reestablish the peer relationship, regardless of
whether alert-only is set.
e. (Optional) Run peer {
group-name |
ipv4-address |
ipv6-address } route-
limit
limit [
percentage ] [ alert-only | idle-forever | idle-timeout
times ]
The maximum number of routes that can be received from the peer or
peer group is set.
----End
10.7.2 Applying Filters to Advertised Routes
Procedure
● Configuring RIP to filter advertised routes
a. Run system-view
The system view is displayed.
b. Run rip [
process-id ]
The RIP view is displayed.
c. Run filter-policy {
acl-number | acl-name
acl-name | ip-prefix
ip-prefix-
name } export [
protocol [
process-id ] |
interface-type interface-
number ]
Imported routes are filtered before being advertised.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1010
Routing information advertised by RIP may contain the routing
information imported from other protocols. You can use the
protocol
parameter to filter the routing information imported from a specified
routing protocol. If the
protocol parameter is not used, all the routes
advertised by RIP are filtered, including imported routes and local routes
(direct routes).
NOTE
RIP-2 defines a 16-bit tag, while other routing protocols define 32-bit tags. If the
routes of other routing protocols are imported into RIP and the tag is used in the
routing policy, the tag value cannot exceed 65535. If the tag value exceeds
65535, the routing policy becomes invalid or the matching result is incorrect.
● Configuring OSPF to filter advertised routes
a. Run system-view
The system view is displayed.
b. Run ospf [
process-id ]
The OSPF process view is displayed.
c. Run filter-policy {
acl-number | acl-name
acl-name | ip-prefix
ip-prefix-
name | route-policy
route-policy-name } export [
protocol [
process-
id ] ]
OSPF is configured to filter the routes imported using the import-route
command. Only the routes that pass the filtering criteria are advertised.
▪ The
acl-number parameter specifies the number of a basic ACL.
▪ The acl-name
acl-name parameter specifies the name of an ACL.
▪ The ip-prefix
ip-prefix-name parameter specifies the name of an IP
prefix list.
▪ The route-policy
route-policy-name parameter specifies the name of
a route policy.
To filter the routes of a specific routing protocol or OSPF process, specify
the
protocol [
process-id ] parameter. If this parameter is not specified,
OSPF filters all the imported routes.
NOTE
● The import-route command cannot import external default routes.
● OSPF filters imported routes and generates Type 5 LSAs to advertise only
external routes that pass the filtering criteria.
● Configuring IS-IS to filter advertised routes
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1011
c. Run filter-policy {
acl-number | acl-name
acl-name | ip-prefix
ip-prefix-
name | route-policy
route-policy-name } export [
protocol [
process-
id ] ]
IS-IS is configured to advertise the external routes that meet specified
conditions to the IS-IS routing domain.
● Configure the BGP device to filter the routes advertised by all its peers or peer
groups.
You can configure a BGP device to filter routes to be advertised.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform either of the following operations to configure the BGP device to
advertise routes to all peers or peer groups:
▪ To filter routes based on an ACL, run the filter-policy {
acl-number |
acl-name
acl-name } export [
protocol [
process-id ] ] or the filter-
policy {
acl6-number | acl6-name
acl6-name } export [
protocol
[
process-id ] ] command.
▪ To filter routes based on an IP prefix list, run the filter-policy ip-
prefix
ip-prefix-name export [
protocol [
process-id ] ] or the filter-
policy ipv6-prefix
ipv6-prefix-name export [
protocol [
process-id ] ]
command.
NOTE
If an ACL has been referenced in the filter-policy command but no VPN instance
is specified in the ACL rule, BGP will filter routes including public and private
network routes in all address families. If a VPN instance is specified in the ACL
rule, only the data traffic from the VPN instance will be filtered, and no route of
this VPN instance will be filtered.
● Configure BGP to filter the routes advertised by a specified peer or peer
group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1012
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform any of the following operations to configure the BGP device to
advertise routes to a specific peer or peer group:
▪ To filter routes based on an ACL, run the peer {
group-name |
ipv4-
address |
ipv6-address } filter-policy {
acl-number | acl-name
acl-
name |
acl6-number | acl6-name
acl6-name } export command.
▪ To filter routes based on an IP prefix list, run the peer {
ipv4-address
|
group-name } ip-prefix
ip-prefix-name export or the peer {
group-
name |
ipv4-address |
ipv6-address } ipv6-prefix
ipv6-prefix-name
export command.
▪ To filter routes based on an AS_Path filter, run the peer {
ipv4-
address |
group-name |
ipv6-address } as-path-filter {
as-path-filter-
number |
as-path-filter-name } export command.
▪ To filter routes based on a route-policy, run the peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-policy-name export
command.
NOTE
The routing policy applied in the peer route-policy export command does not
support a specific interface as one matching rule. That is, the routing policy does
not support the if-match interface command.
----End
10.8 Controlling the Valid Time of Routing Policies
Pre-configuration Tasks
None
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run route-policy-change notify-delay
delay-time
The delay in applying the routing policy is set.
The value ranges from 1 to 180, in seconds.
By default, the RM immediately instructs protocols to apply a new policy when the
existing routing policy changes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1013
Step 3 Run quit
Return to the user view.
Step 4 (Optional) Run refresh bgp all { export | import }
BGP is configured to apply the new routing policy.
After a routing policy is configured, to make policy-based filtering take effect
immediately, use this command to configure BGP to apply the new policy
immediately.
The policies affected by the timer are ACLs, IP prefix lists, AS_Path filters,
community filters, extended community filters, RD filters, and route-policies.
----End
Verifying the Configuration
● Run the display current-configuration | include notify-delay command to
check the delay in applying a routing policy.
10.9 Maintaining Routing Policies
Context
NOTICE
Statistics of IP prefix lists cannot be restored after being cleared. Exercise caution
when running these commands.
Procedure
● Run reset ip ip-prefix [
ip-prefix-name ] command in the user view to clear
IPv4 prefix list statistics.
● Run reset ip ipv6-prefix [
ipv6-prefix-name ] command in the user view to
clear IPv6 prefix list statistics.
----End
10.10 Configuration Examples for Routing Policies
10.10.1 Example for Filtering the Routes to Be Received or
Advertised
Networking Requirements
Figure 10-19 shows how on an OSPF network, SwitchA receives routes from the
Internet and provides these routes for the OSPF network. A user wants devices on
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1014
the OSPF network to access only the network segments 172.16.17.0/24,
172.16.18.0/24, and 172.16.19.0/24, and SwitchC to access only the network
segment 172.16.18.0/24.
Figure 10-19 Networking diagram for filtering the received and advertised routes
Device Interface VLANIF Interface IP Address
SwitchA GE0/0/1 VLANIF10 192.168.1.1/24
SwitchB GE0/0/1 VLANIF10 192.168.1.2/24
SwitchB GE0/0/2 VLANIF20 192.168.2.1/24
SwitchC GE0/0/1 VLANIF20 192.168.2.2/24
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure a routing policy on SwitchA and apply the routing policy during
route advertisement. When routes are advertised, the routing policy allows
SwitchA to provide routes from network segments 172.16.17.0/24,
172.16.18.0/24, and 172.16.19.0/24 for SwitchB, and allows devices on the
OSPF network to access the three network segments.
2. Configure a routing policy on SwitchC and apply the routing policy during
route importing. When routes are imported, the routing policy allows SwitchC
to receive only the routes from the network segment 172.16.18.0/24 and
access this network segment.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. Ensure that the configurations of SwitchB and SwitchC are
the same as the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1015
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign IP addresses to VLANIF interfaces.
# Configure SwitchA. Ensure that the configurations of SwitchB and SwitchC are
the same as the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.1 24
[SwitchA-Vlanif10] quit
Step 3 Configure basic OSPF functions.
# Configure SwitchA.
[SwitchA] ospf
[SwitchA-ospf-1] area 0
[SwitchA-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] quit
[SwitchA-ospf-1] quit
# Configure SwitchB.
[SwitchB] ospf
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] network 192.168.2.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
# Configure SwitchC.
[SwitchC] ospf
[SwitchC-ospf-1] area 0
[SwitchC-ospf-1-area-0.0.0.0] network 192.168.2.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] quit
[SwitchC-ospf-1] quit
Step 4 Configure five static routes on SwitchA and import these routes into OSPF.
[SwitchA] ip route-static 172.16.16.0 24 NULL 0
[SwitchA] ip route-static 172.16.17.0 24 NULL 0
[SwitchA] ip route-static 172.16.18.0 24 NULL 0
[SwitchA] ip route-static 172.16.19.0 24 NULL 0
[SwitchA] ip route-static 172.16.20.0 24 NULL 0
[SwitchA] ospf
[SwitchA-ospf-1] import-route static
[SwitchA-ospf-1] quit
# Check the IP routing table on SwitchB. You can see that the five static routes are
imported into OSPF.
[SwitchB] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 11 Routes : 11
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.16.0/24 O_ASE 150 1 D 192.168.1.1 Vlanif10
172.16.17.0/24 O_ASE 150 1 D 192.168.1.1 Vlanif10
172.16.18.0/24 O_ASE 150 1 D 192.168.1.1 Vlanif10
172.16.19.0/24 O_ASE 150 1 D 192.168.1.1 Vlanif10
172.16.20.0/24 O_ASE 150 1 D 192.168.1.1 Vlanif10
192.168.1.0/24 Direct 0 0 D 192.168.1.2 Vlanif10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1016
192.168.1.2/32 Direct 0 0 D 127.0.0.1 Vlanif10
192.168.2.0/24 Direct 0 0 D 192.168.2.1 Vlanif20
192.168.2.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
Step 5 Configure a policy for advertising routes.
# Configure an IP prefix list named a2b on SwitchA.
[SwitchA] ip ip-prefix a2b index 10 permit 172.16.17.0 24
[SwitchA] ip ip-prefix a2b index 20 permit 172.16.18.0 24
[SwitchA] ip ip-prefix a2b index 30 permit 172.16.19.0 24
# Configure a policy for advertising routes on SwitchA, and use the IP prefix list
a2b to filter routes.
[SwitchA] ospf
[SwitchA-ospf-1] filter-policy ip-prefix a2b export static
# Check the IP routing table on SwitchB. You can see that SwitchB receives only
three routes defined in a2b.
[SwitchB] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 9 Routes : 9
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.17.0/24 O_ASE 150 1 D 192.168.1.1 Vlanif10
172.16.18.0/24 O_ASE 150 1 D 192.168.1.1 Vlanif10
172.16.19.0/24 O_ASE 150 1 D 192.168.1.1 Vlanif10
192.168.1.0/24 Direct 0 0 D 192.168.1.2 Vlanif10
192.168.1.2/32 Direct 0 0 D 127.0.0.1 Vlanif10
192.168.2.0/24 Direct 0 0 D 192.168.2.1 Vlanif20
192.168.2.1/32 Direct 0 0 D 127.0.0.1 Vlanif20
Step 6 Configure a policy for receiving routes.
# Configure an IP prefix list named in on SwitchC.
[SwitchC] ip ip-prefix in index 10 permit 172.16.18.0 24
# Configure a policy for receiving routes on SwitchC, and use the IP prefix list in to
filter routes.
[SwitchC] ospf
[SwitchC-ospf-1] filter-policy ip-prefix in import
[SwitchC-ospf-1] quit
# Check the IP routing table on SwitchC. You can see that the IP routing table
contains only one route defined in the IP prefix list in.
[SwitchC] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 5 Routes : 5
Destination/Mask Proto Pre Cost Flags NextHop Interface
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.18.0/24 O_ASE 150 1 D 192.168.2.1 Vlanif20
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1017
192.168.2.0/24 Direct 0 0 D 192.168.2.2 Vlanif20
192.168.2.2/32 Direct 0 0 D 127.0.0.1 Vlanif20
----End
Configuration Files
● Configuration file of SwitchA
#
sysname SwitchA
#
vlan batch 10
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
ospf 1
filter-policy ip-prefix a2b export static
import-route static
area 0.0.0.0
network 192.168.1.0 0.0.0.255
#
ip ip-prefix a2b index 10 permit 172.16.17.0 24
ip ip-prefix a2b index 20 permit 172.16.18.0 24
ip ip-prefix a2b index 30 permit 172.16.19.0 24
#
ip route-static 172.16.16.0 255.255.255.0 NULL0
ip route-static 172.16.17.0 255.255.255.0 NULL0
ip route-static 172.16.18.0 255.255.255.0 NULL0
ip route-static 172.16.19.0 255.255.255.0 NULL0
ip route-static 172.16.20.0 255.255.255.0 NULL0
#
return
● Configuration file of SwitchB
#
sysname SwitchB
#
vlan batch 10 20
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
ospf 1
area 0.0.0.0
network 192.168.1.0 0.0.0.255
network 192.168.2.0 0.0.0.255
#
return
● Configuration file of SwitchC
#
sysname SwitchC
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1018
#
vlan batch 20
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
ospf 1
filter-policy ip-prefix in import
area 0.0.0.0
network 192.168.2.0 0.0.0.255
#
ip ip-prefix in index 10 permit 172.16.18.0 24
#
return
10.10.2 Example for Applying a Routing Policy for Importing
Routes
Networking Requirements
In Figure 10-20, SwitchB exchanges routing information with SwitchA through
OSPF, and with SwitchC through IS-IS. A user wants SwitchB to import IS-IS routes
into the OSPF network. The user also wants the route to 172.17.1.0/24 on the
OSPF network to have a low preference and the route to 172.17.2.0/24 to have a
tag, making it easy to reference by a routing policy.
Figure 10-20 Networking diagram for applying a routing policy for importing
routes
Device Interface VLANIF
Interface
IP Address
SwitchA GE0/0/1 VLANIF10 192.168.1.1/24
SwitchB GE0/0/1 VLANIF10 192.168.1.2/24
SwitchB GE0/0/2 VLANIF20 192.168.2.2/24
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1019
SwitchC GE0/0/1 VLANIF20 192.168.2.1/24
SwitchC GE0/0/2 VLANIF30 172.17.1.1/24
SwitchC GE0/0/3 VLANIF40 172.17.2.1/24
SwitchC GE0/0/4 VLANIF50 172.17.3.1/24
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure a routing policy on SwitchB, set the cost of the route to
172.17.1.0/24 to 100, and apply the routing policy when OSPF imports IS-IS
routes. The routing policy allows the route to 172.17.1.0/24 to have a low
preference.
2. Configure a routing policy on SwitchB, set the tag of the route to
172.17.2.0/24 to 20, and apply the routing policy when OSPF imports IS-IS
routes. This allows the tag of the route to 172.17.2.0/24 to take effect,
making it easy to reference by a routing policy.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. Ensure that the configurations of SwitchB, and SwitchC are
the same as the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign IP addresses to VLANIF interfaces.
# Configure SwitchA. Ensure that the configurations of SwitchB, and SwitchC are
the same as the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.1 24
[SwitchA-Vlanif10] quit
Step 3 Configure IS-IS.
# Configure SwitchC.
[SwitchC] isis
[SwitchC-isis-1] is-level level-2
[SwitchC-isis-1] network-entity 10.0000.0000.0001.00
[SwitchC-isis-1] quit
[SwitchC] interface vlanif 20
[SwitchC-Vlanif20] isis enable
[SwitchC-Vlanif20] quit
[SwitchC] interface vlanif 30
[SwitchC-Vlanif30] isis enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1020
[SwitchC-Vlanif30] quit
[SwitchC] interface vlanif 40
[SwitchC-Vlanif40] isis enable
[SwitchC-Vlanif40] quit
[SwitchC] interface vlanif 50
[SwitchC-Vlanif50] isis enable
[SwitchC-Vlanif50] quit
# Configure SwitchB.
[SwitchB] isis
[SwitchB-isis-1] is-level level-2
[SwitchB-isis-1] network-entity 10.0000.0000.0002.00
[SwitchB-isis-1] quit
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] isis enable
[SwitchB-Vlanif20] quit
Step 4 Configure OSPF and import routes.
# Configure SwitchA and enable OSPF.
[SwitchA] ospf
[SwitchA-ospf-1] area 0
[SwitchA-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
[SwitchA-ospf-1-area-0.0.0.0] quit
[SwitchA-ospf-1] quit
# Configure SwitchB, enable OSPF, and import IS-IS routes.
[SwitchB] ospf
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] import-route isis 1
[SwitchB-ospf-1] quit
# Check the OSPF routing table on SwitchA. You can see the imported routes.
[SwitchA] display ospf routing
OSPF Process 1 with Router ID 192.168.1.1
Routing Tables
Routing for Network
Destination Cost Type NextHop AdvRouter Area
192.168.1.0/24 1 Transit 192.168.1.1 192.168.1.1 0.0.0.0
Routing for ASEs
Destination Cost Type Tag NextHop AdvRouter
172.17.1.0/24 1 Type2 1 192.168.1.2 192.168.1.2
172.17.2.0/24 1 Type2 1 192.168.1.2 192.168.1.2
172.17.3.0/24 1 Type2 1 192.168.1.2 192.168.1.2
192.168.2.0/24 1 Type2 1 192.168.1.2 192.168.1.2
Total Nets: 5
Intra Area: 1 Inter Area: 0 ASE: 4 NSSA: 0
Step 5 Set the filtering list.
# Configure ACL 2002 to match 172.17.2.0/24.
[SwitchB] acl number 2002
[SwitchB-acl-basic-2002] rule permit source 172.17.2.0 0.0.0.255
[SwitchB-acl-basic-2002] quit
# Configure an IP prefix list named prefix-a to match 172.17.1.0/24.
[SwitchB] ip ip-prefix prefix-a index 10 permit 172.17.1.0 24
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1021
Step 6 Configure a routing policy.
[SwitchB] route-policy isis2ospf permit node 10
[SwitchB-route-policy] if-match ip-prefix prefix-a
[SwitchB-route-policy] apply cost 100
[SwitchB-route-policy] quit
[SwitchB] route-policy isis2ospf permit node 20
[SwitchB-route-policy] if-match acl 2002
[SwitchB-route-policy] apply tag 20
[SwitchB-route-policy] quit
[SwitchB] route-policy isis2ospf permit node 30
[SwitchB-route-policy] quit
Step 7 Apply the routing policy when routes are imported.
# Configure SwitchB and apply the routing policy when routes are imported.
[SwitchB] ospf
[SwitchB-ospf-1] import-route isis 1 route-policy isis2ospf
[SwitchB-ospf-1] quit
# Check the OSPF routing table on SwitchA. You can see that the cost of the route
to 172.17.1.0/24 is 100; the tag of the route to 172.17.2.0/24 is 20; other route
attributes remain unchanged.
[SwitchA] display ospf routing
OSPF Process 1 with Router ID 192.168.1.1
Routing Tables
Routing for Network
Destination Cost Type NextHop AdvRouter Area
192.168.1.0/24 1 Transit 192.168.1.1 192.168.1.1 0.0.0.0
Routing for ASEs
Destination Cost Type Tag NextHop AdvRouter
172.17.1.0/24 100 Type2 1 192.168.1.2 192.168.1.2
172.17.2.0/24 1 Type2 20 192.168.1.2 192.168.1.2
172.17.3.0/24 1 Type2 1 192.168.1.2 192.168.1.2
192.168.2.0/24 1 Type2 1 192.168.1.2 192.168.1.2
Total Nets: 5
Intra Area: 1 Inter Area: 0 ASE: 4 NSSA: 0
----End
Configuration Files
● Configuration file of SwitchA
#
sysname SwitchA
#
vlan batch 10
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
ospf 1
area 0.0.0.0
network 192.168.1.0 0.0.0.255
#
return
● Configuration file of SwitchB
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1022
#
sysname SwitchB
#
vlan batch 10 20
#
acl number 2002
rule 5 permit source 172.17.2.0 0.0.0.255
#
isis 1
is-level level-2
network-entity 10.0000.0000.0002.00
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
ospf 1
import-route isis 1 route-policy isis2ospf
area 0.0.0.0
network 192.168.1.0 0.0.0.255
#
route-policy isis2ospf permit node 10
if-match ip-prefix prefix-a
apply cost 100
#
route-policy isis2ospf permit node 20
if-match acl 2002
apply tag 20
#
route-policy isis2ospf permit node 30
#
ip ip-prefix prefix-a index 10 permit 172.17.1.0 24
#
return
● Configuration file of SwitchC
#
sysname SwitchC
#
vlan batch 20 30 40 50
#
isis 1
is-level level-2
network-entity 10.0000.0000.0001.00
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
isis enable 1
#
interface Vlanif30
ip address 172.17.1.1 255.255.255.0
isis enable 1
#
interface Vlanif40
ip address 172.17.2.1 255.255.255.0
isis enable 1
#
interface Vlanif50
ip address 172.17.3.1 255.255.255.0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1023
isis enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/4
port link-type trunk
port trunk allow-pass vlan 50
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1024
11 IP Routing Table Management
11.1 Licensing Requirements and Limitations for IP Routing Table Management
11.2 Managing IP Routing Tables
11.3 Example for Configuring IP FRR on the Public Network
11.1 Licensing Requirements and Limitations for IP
Routing Table Management
Involved Network Elements
Other network elements are not required.
Licensing Requirements
The number of IPv4 FIB entries supported by the S5720-HI and S5730-HI depends
on licenses. For the maximum number of IPv4 FIB entries, contact the equipment
supplier.
For details about how to apply for a license, see Applying for Licenses in the
S1720, S5700, and S6700 Series Switches License Usage Guide.
Feature Support in V200R024C00
All models of S300, S500, S2700, S5700, and S6700 series switches (except the
S5751-L, S5731-L and S5731S-L) support IP Routing Table Management.
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1025
Feature Limitations
When the S6720-SI, S6720S-S, S6720S-SI, S5730-SI, S5735S-H, S5736-S, S5730S-EI,
S6720-LI, and S6720S-LI function as route-based forwarding devices, you are
advised to use them in the following typical route-based forwarding scenarios:
● IPv4 routes: Among all routing entries, there are no more than 1500 types of
16-bit prefixes or no more than 200 types of 8-bit prefixes. In VPN scenarios,
the same prefix is counted multiple times in different VPNs.
● IPv6 routes: Among all routing entries, there are no more than 1200 types of
32-bit prefixes or no more than 3 types of 8-bit prefixes. In VPN scenarios, the
same prefix is counted multiple times in different VPNs.
Routes with a mask less than 64 bits are recommended, and routes with a
128-bit mask are not recommended. It is not recommended that you use a
large number of Layer 3 interfaces to configure IPv6 services. This is because
two routes will be generated for an IPv6 Layer 3 interface: one is a network
segment route and the other is a 128-bit local route, and this 128-bit local
route occupies many hardware resources.
For example, there are four IP addresses: 10.1.1.1, 10.1.2.1, 10.2.1.1, 192.168.1.1
● There are three types of 16-bit prefixes: 10.1, 10.2, and 192.168.
● There are two types of 8-bit prefixes: 10 and 192.
When the preceding switches are used as route forwarding devices in scenarios
other than the preceding typical scenarios, collect log information, configuration,
and routing entries if route forwarding failures occur, and contact technical
support personnel.
In a VXLAN scenario, the configuration of ECMP-based distribution of packets with
the same source address and destination address does not take effect; traffic is
still load balanced based on the configured ECMP load balancing mode.
11.2 Managing IP Routing Tables
11.2.1 Displaying and Maintaining an IP Routing Table
Context
You can view IP routing table information to locate routing faults. The following
describes the commands used to display and maintain IP routing table
information.
display commands can be used in all views, and reset commands can only be used
in the user view.
If the switch imports a large number of routes, system performance may be
affected when services are being processed because the routes consume a lot of
system resources. To improve system security and reliability, configure a limit on
the number of public route prefixes. When the number of public route prefixes
exceeds the limit, an alarm is generated, prompting you to check validity of public
route prefixes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1026
Procedure
● Run the display ip routing-table command to check brief information about
the active routes in the IPv4 routing table.
● Run the display ip routing-table verbose command to check detailed
information about the IPv4 routing table.
● Run the display ip routing-table
ip-address [
mask |
mask-length ] [ longer-
match ] [ verbose ] command to check detailed information about the routes
with the specified destination address in the IPv4 routing table.
● Run the display ip routing-table
ip-address1 {
mask1 |
mask-length1 }
ip-
address2 {
mask2 |
mask-length2 } [ verbose ] command to check detailed
information about the routes within the specified destination address range in
the IPv4 routing table.
● Run the display ip routing-table acl {
acl-number |
acl-name } [ verbose ]
command to check detailed information about the routes that match the
specified basic ACL in the IPv4 routing table.
● Run the display ip routing-table ip-prefix
ip-prefix-name [ verbose ]
command to check detailed information about the routes that match the
specified IP prefix list in the IPv4 routing table.
● Run the display ip routing-table protocol
protocol [ inactive | verbose ]
command to check detailed information about the routes discovered by the
specified routing protocol in the IPv4 routing table.
● Run the display ip routing-table statistics command to check route statistics
in the IPv4 routing table.
● Run the display ipv6 routing-table command to check brief information
about the active routes in the IPv6 routing table.
● Run the display ipv6 routing-table verbose command to check detailed
information about the IPv6 routing table.
● Run the display ipv6 routing-table
protocol [ inactive | verbose ] command
to check detailed information about the routes discovered by the specified
routing protocol in the IPv6 routing table.
● Run the display ipv6 routing-table statistics command to check route
statistics in the IPv6 routing table.
● Run the reset ip routing-table statistics protocol { all |
protocol } command
to clear route statistics in the IPv4 routing table.
● Run the reset ipv6 routing-table statistics protocol { all |
protocol }
command to clear route statistics in the IPv6 routing table.
----End
11.2.2 Displaying and Maintaining the Routing Management
Module
Context
If the device imports a large number of routes, system performance may be
affected when services are being processed because the routes consume a lot of
system resources. To improve system reliability, configure a limit on the number of
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1027
public route prefixes. When the number of public route prefixes exceeds the limit,
an alarm is generated, prompting you to check validity of public route prefixes.
Procedure
● Run the display rm interface [
interface-type interface-number ] command
to check IPv4 routing management (RM) information on the specified
interface.
● Run the display rm ipv6 interface [
interface-type interface-number ]
command to check IPv6 RM information on the specified interface.
● Maintain the RM module.
Configure a limit on the number of public route prefixes.
a. Run system-view
The system view is displayed.
b. Run either of the following commands as required:
▪ Run ip prefix-limit
number {
alert-percent [ route-unchanged ] |
simply-alert }
A limit on the number of IPv4 public route prefixes is configured.
By default, the maximum number of IPv4 public route prefixes is not
limited.
▪ Run ipv6 prefix-limit
number {
alert-percent [ route-unchanged ] |
simply-alert }
A limit on the number of IPv6 public route prefixes is configured.
By default, the maximum number of IPv6 public route prefixes is not
limited.
alert-percent specifies the percentage of the maximum number of
supported public route prefixes. If you specify
alert-percent in the
command, an alarm is generated when the number of public route
prefixes exceeds the value calculated by the following formula:
(
number x
alert-percent)/100
New public route prefixes can still be added to the IP routing table until
the number of public route prefixes reaches the value of
number.
Subsequent route prefixes will then be discarded.
If you specify simply-alert in the command, new public route prefixes
can still be added to the IP routing table and only an alarm is generated
after the number of public route prefixes exceeds the value of
number.
However, when the total number of private and public route prefixes
reaches the limit on the number of unicast route prefixes, subsequent
public route prefixes will be discarded.
If you decrease the value of
alert-percent after the number of public
route prefixes exceeds the value of
number, whether the IP routing table
remains unchanged depends on whether route-unchanged is specified in
the command:
▪ If it is specified, the IP routing table remains unchanged.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1028
▪ If it is not specified, the system deletes all the routes from the IP
routing table and re-adds routes to the IP routing table.
NOTE
After the number of public route prefixes exceeds the limit, note the following
rules:
● If you run the ip prefix-limit command to increase the value of
number or
run the undo ip prefix-limit command to remove the limit, the device
relearns IPv4 public route prefixes.
● If you run the ipv6 prefix-limit command to increase the value of
number
or run the undo ipv6 prefix-limit command to remove the limit, the device
relearns IPv6 public route prefixes.
● Direct and static routes can still be added to the IP routing table.
c. (Optional) Run ip prefix-limit log-interval
interval
An interval at which the system generates logs after the number of public
route prefixes exceeds the limit is configured.
By default, the system generates logs at an interval of 5s after the
number of public route prefixes exceeds the limit.
You can set a longer interval to decrease the frequency at which the
system generates logs.
----End
11.2.3 Displaying and Maintaining FIB Tables
Context
NOTE
Unless otherwise stated, FIB tables in this document refer to unicast FIB tables.
A device selects routes according to its IP routing table and forwards packets
according to FIB tables. If the number of entries in a FIB table reaches or exceeds
the limit, that is, the FIB table is overloaded, new active routes cannot be delivered
to the FIB table, affecting packet forwarding.
Procedure
● Check FIB entries.
– Run the display fib [
slot-id ] [ vpn-instance
vpn-instance-name ]
[ verbose ] command to check IPv4 FIB entries.
– Run the display fib [ vpn-instance
vpn-instance-name ] acl
acl-number
[ verbose ] command to check IPv4 FIB entries that match a specified
ACL.
– Run the display fib [ vpn-instance
vpn-instance-name ] ip-prefix
prefix-
name [ verbose ] command to check IPv4 FIB entries that match a
specified IP prefix list.
– Run the display fib [
slot-id ] [ vpn-instance
vpn-instance-name ]
destination-address1 [ verbose ] command to check IPv4 FIB entries that
match a specified destination IP address.
– Run the display fib [
slot-id ] [ vpn-instance
vpn-instance-name ]
destination-address1 destination-mask1 [ verbose ] command to check
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1029
IPv4 FIB entries that exactly match a specified destination IP address and
mask.
– Run the display fib [
slot-id ] [ vpn-instance
vpn-instance-name ]
destination-address1 longer [ verbose ] command to check all IPv4 FIB
entries that match destination IP addresses in the natural mask range.
– Run the display fib [
slot-id ] [ vpn-instance
vpn-instance-name ]
destination-address1 destination-mask1 longer [ verbose ] command to
check all IPv4 FIB entries that match destination IP addresses in a
specified mask range.
– Run the display fib [
slot-id ] [ vpn-instance
vpn-instance-name ]
destination-address1 destination-mask1 destination-address2 destination-
mask2 [ verbose ] command to check IPv4 FIB entries that match
destination IP addresses in the range of
destination-address1 destination-
mask1 and
destination-address2 destination-mask2.
– Run the display fib [ vpn-instance
vpn-instance-name ] next-hop
ip-
address command to check IPv4 FIB entries that match a specified next-
hop IP address.
– Run the display fib [
slot-id ] [ vpn-instance
vpn-instance-name ]
statistics command to check the total number of IPv4 FIB entries.
– Run the display fib [
slot-id ] statistics all command to check IPv4 FIB
entry statistics.
– Run the display ipv6 fib [
slot-id ] [ vpn-instance
vpn-instance-name ]
[ verbose ] command to check IPv6 FIB entries.
– Run the display ipv6 fib [
slot-id ] [ vpn-instance
vpn-instance-name ]
ipv6-address [ verbose ] command to check IPv6 FIB entries that match a
specified destination IPv6 address.
– Run the display ipv6 fib [
slot-id ] [ vpn-instance
vpn-instance-name ]
ipv6-address prefix-length [ verbose ] command to check IPv6 FIB entries
that exactly match a specified destination IPv6 address and mask.
– Run the display ipv6 fib [
slot-id ] [ vpn-instance
vpn-instance-name ]
[ verbose ] statistics command to check the total number of IPv6 FIB
entries.
– Run the display ipv6 fib [
slot-id ] statistics all command to check IPv6
FIB entry statistics.
● Maintain FIB tables.
– Enable the alarm function for the IPv4 route prefix usage and set the
alarm threshold.
i. Run system-view
The system view is displayed.
ii. Run fib threshold-alarm upper-limit
upper-limit-value lower-limit
lower-limit-value
The alarm function for the IPv4 route prefix usage is enabled and the
alarm threshold is set.
By default, the alarm function for IPv4 route prefix usage is enabled.
The upper alarm threshold is 85% and the lower alarm threshold is
75%.
– Configure the resource mode of the extended entry space register to
adjust the IPv4 and IPv6 FIB table sizes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1030
i. (Optional) Run the display resource-mode configuration command
to check the resource mode configuration of the extended entry
space.
ii. Run the system-view command to enter the system view.
iii. Configure the resource allocation mode of the extended entry space.
○ assign resource-mode { enhanced-mac | enhanced-arp |
enhanced-ipv4 | super-arp } [ slot
slot-id | all ] (S6735-S)
○ assign resource-mode { enhanced-arp | enhanced-sac |
enhanced-sipfpm | eca | sac } [ slot
slot-id | all ] (S5731-H,
S5731S-H, S5731-S, and S5731S-S)
○ assign resource-mode { enhanced-arp | enhanced-sac |
enhanced-sipfpm | sac } [ slot
slot-id | all ] (S6730-S, S6730S-S,
and S5732-H)
○ assign resource-mode { enhanced-mac | enhanced-arp |
enhanced-fib | enhanced-sac | sac | enhanced-sipfpm } [ slot
slot-id | all ] (S6730-H and S6730S-H)
○ assign resource-mode { enhanced-mac | enhanced-arp }
global (S500, S5735-S, S300, S5735-L, S5735-S-I, S5735-L-I,
S5735-L1, and S5735S-L1)
By default, the resource allocation mode of the S5731-H, S5731S-H,
S500, S5735-S, S300, S5735-L, S5735-S-I, S5735-L-I, S5735-
L1,S5735S-L1, S5732-H, S5731-S, S5731S-S, S6730-S, S6730S-S,
S6730-H, S6730S-H, S6735-S is enhanced-arp.
– Configure periodic refresh of FIB entries.
i. Run system-view
The system view is displayed.
ii. Run undo fib regularly-refresh disable
Periodic refresh of FIB entries is enabled.
By default, periodic refresh of FIB entries is enabled.
iii. Run fib regularly-refresh { interval
interval [ entry-number
entry-
number ] | entry-number
entry-number | cycle-interval
cycle-
interval }
The entire FIB entry update interval, FIB entry update interval per
cycle, and the number of FIB entries updated per cycle are
configured.
By default, the FIB entry update interval per cycle is 1 second, and
the number of FIB entries updated per cycle is 50. The entire FIB
entry update interval is 1 minute on the S5731-S, S5731-H, S5731S-
H, S5732-H, S6730-S, S6730S-H, and S6730-H, and is fixed to 1440
minutes on other devices.
– Configure periodic refresh of IPv6 FIB entries.
i. Run system-view
The system view is displayed.
ii. Run undo ipv6 fib regularly-refresh disable
Periodic refresh of IPv6 FIB entries is enabled.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1031
iii. Run ipv6 fib regularly-refresh { interval
interval | entry-number
entry-number | cycle-interval
cycle-interval }
The entire IPv6 FIB entry update interval, IPv6 FIB entry update
interval per cycle, and the number of IPv6 FIB entries updated per
cycle are configured.
By default, the IPv6 FIB entry update interval per cycle is 1 second,
and the number of IPv6 FIB entries updated per cycle is 50. The
entire IPv6 FIB entry update interval is 1 minute on the S5731-S,
S5731-H, S5731S-H, S5732-H, S6730-S, S6730S-H, and S6730-H, and
is fixed to 1440 minutes on other devices.
----End
11.2.4 Configuring IP FRR on the Public Network
Usage Scenario
On a traditional IP network, when a lower-layer failure occurs on the forwarding
link of a device, the physical interface of the device becomes Down. After the
device detects the failure, it instructs the upper-layer routing system to recalculate
routes and update routing information. It often takes the routing system several
seconds to reselect an available route.
Second-level convergence is intolerable to the services that are quite sensitive to
delay and packet loss because it may lead to service interruptions. For example,
Voice over Internet Protocol (VoIP) services are only tolerant of millisecond-level
interruptions. IP FRR ensures that the forwarding system rapidly responds to link
failures and uses backup routes to forward data, minimizing service traffic
interruptions.
NOTE
Only the S5720I-SI, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S, S5731S-H,
S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and S6730S-S
support this function.
Pre-configuration Tasks
Before configuring IP FRR on the public network, complete the following tasks:
● Configure static routes or an IGP to ensure that there are reachable routes
between devices.
● Configure different costs for routes to generate two non-equal-cost routes.
Configuration Procedure
Configure a route-policy and then enable IP FRR on the public network for the
route-policy.
Procedure
Step 1 Configure a route-policy.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1032
1. Run system-view
The system view is displayed.
2. Run route-policy
route-policy-name { permit | deny } node
node
A route-policy is created and the route-policy view is displayed.
3. (Optional) Run if-match
Matching conditions are configured to filter the routes to be backed up.
Select the if-match command according to 10.6.2 (Optional) Configuring
an if-match Clause.
If no matching condition is configured, backup outbound interfaces and
backup next hops will be specified for all routes of the device. This, however,
causes backup information to be specified for some routes that do not need
to be backed up. To correctly configure backup between routes, you are
advised to configure matching conditions.
4. Run apply backup-interface
interface-type interface-number
A backup outbound interface is configured.
5. Run apply backup-nexthop
ip-address
A backup next hop is configured.
NOTE
– If a backup outbound interface is configured on a P2P link, no backup next hop
needs to be specified.
– If a backup outbound interface is configured on a non-P2P link, a backup next hop
needs to be specified.
6. Run quit
Return to the system view.
Step 2 Enable IP FRR on the public network.
1. Run ip frr route-policy
route-policy-name
IP FRR on the public network is enabled.
When using IP FRR, use this command to enable IP FRR so that the route-
policy can take effect.
NOTE
Only one route-policy can be configured every time you use the command. If you run
this command multiple times, only the latest configuration takes effect.
----End
Verifying the Configuration
Run the display ip routing-table [ verbose ] command to check information
about the IPv4 routing table.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1033
11.2.5 Configuring IPv6 FRR on the Public Network
Usage Scenario
On a traditional IP network, when a lower-layer failure occurs on the forwarding
link of a device, the physical interface of the device becomes Down. After the
device detects the failure, it instructs the upper-layer routing system to recalculate
routes and update routing information. It often takes the routing system several
seconds to reselect an available route.
Second-level convergence is intolerable to the services that are quite sensitive to
delay and packet loss because it may lead to service interruptions. For example,
Voice over Internet Protocol (VoIP) services are only tolerant of millisecond-level
interruptions. IPv6 FRR ensures that the forwarding system rapidly responds to link
failures and uses backup routes to forward data, minimizing service traffic
interruptions.
NOTE
Only the S5720I-SI, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S, S5731S-H,
S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and S6730S-S
support this function.
Pre-configuration Tasks
Before configuring IPv6 FRR on the public network, complete the following tasks:
● Configure static routes or an IGP to ensure that there are reachable routes
between devices.
● Configure different costs for routes to generate two non-equal-cost routes.
Configuration Procedure
Configure a route-policy and then enable IPv6 FRR on the public network for the
route-policy.
Procedure
Step 1 Configure a route-policy.
1. Run system-view
The system view is displayed.
2. Run route-policy
route-policy-name { permit | deny } node
node
A route-policy is created and the route-policy view is displayed.
3. (Optional) Run if-match
Matching conditions are configured to filter the routes to be backed up.
Select the if-match command according to 10.6.2 (Optional) Configuring
an if-match Clause.
If no matching condition is configured, backup outbound interfaces and
backup next hops will be specified for all routes of the device. This, however,
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1034
causes backup information to be specified for some routes that do not need
to be backed up. To correctly configure backup between routes, you are
advised to configure matching conditions.
4. Run apply ipv6 backup-interface
interface-type interface-number
A backup outbound interface is configured.
5. Run apply ipv6 backup-nexthop
ipv6-address
A backup next hop is configured.
NOTE
– If a backup next hop is specified, a backup outbound interface also needs to be
specified.
– If a backup outbound interface is configured on a P2P link, no backup next hop
needs to be specified.
– If a backup outbound interface is configured on a non-P2P link, a backup next hop
needs to be specified.
6. Run quit
Return to the system view.
Step 2 Enable IPv6 FRR on the public network.
1. Run ipv6 frr route-policy
route-policy-name
IPv6 FRR on the public network is enabled.
When using IPv6 FRR, use this command to enable IPv6 FRR so that the
route-policy can take effect.
NOTE
Only one route-policy can be configured every time you use the command. If you run
this command multiple times, only the latest configuration takes effect.
----End
Verifying the Configuration
Run the display ipv6 routing-table [ verbose ] command to check information
about the IPv6 routing table.
11.2.6 Configuring the ECMP Load Balancing Mode
Context
ECMP applies to the network where multiple links to the same destination are
available. In the traditional routing technology, packets are forwarded to the
destination through one link only; the other links are in backup or inactive state;
switching between these links requires a certain period when dynamic routes are
used. Different from the traditional routing technology, ECMP can use multiple
links to increase transmission bandwidth and transmit data on a faulty link
without any delay or packet loss.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1035
NOTE
Only the S5720I-SI, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S, S5731S-H,
S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and S6730S-S
support ECMP load balancing.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run ecmp load-balance sip [ dip ] [ port ]
The ECMP load balancing mode is set.
By default, ECMP load balancing is performed on packets based on the source IP
address, destination IP address, transport-layer source port number and
destination port number.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S5735-S, S5735-S-I, S6735-S,
S6730-H, S6730S-H, S6730-S, and S6730S-S support the ECMP load balancing mode.
Step 3 Run ecmp load-balance diffluence
ECMP-based distribution of packets with the same source address and destination
address is configured.
By default, ECMP-based distribution of packets with the same source address and
destination address is not configured.
In a VXLAN scenario, ECMP-based distribution of packets with the same source
address and destination address does not take effect; instead, the configured
ECMP load balancing mode takes effect..
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6730-H, S6730S-H, S6730-S,
and S6730S-S support this command.
----End
11.2.7 Configuring the Advertisement of IPv4 ARP Vlink Direct
Routes
Context
After a device's sub-interfaces or VLANIF interfaces have static ARP entries
configured or dynamically learn ARP entries, the device generates a type of 32-bit
host route according to ARP entries if the arp direct-route enable command is
executed to configure the ARP module of the device to report IPv4 ARP Vlink
direct routes to the RM module. This type of 32-bit host route is called IPv4 ARP
Vlink direct route.
By default, IPv4 ARP Vlink direct routes are only used to guide local traffic
forwarding. To control the routing table size and ensure routing table stability,
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1036
devices are prohibited from redistributing these direct routes into dynamic routing
protocols. In some situations, however, devices need to perform operations based
on specific routes. For example, a device needs to direct remote traffic for different
users using different export policies. Subsequently, the device needs to redistribute
IPv4 ARP Vlink direct routes into dynamic routing protocols and advertises them to
the remote end.
You can use a route-policy to filter IPv4 ARP Vlink direct routes to be advertised so
that only the routes matching the route-policy can be advertised. This operation
can control the routing table size and implement precise control over data traffic.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support the configuration of the advertisement of IPv4 ARP Vlink
direct routes.
Pre-configuration Tasks
Before configuring the advertisement of IPv4 ARP Vlink direct routes, set link layer
protocol parameters and assign IP addresses to interfaces to ensure that the status
of the link layer protocol of the interfaces is Up.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run arp vlink-direct-route advertise [ route-policy
route-policy-name ]
The advertisement of IPv4 ARP Vlink direct routes is configured.
By default, a device does not advertise IPv4 ARP Vlink direct routes.
You can specify the route-policy
route-policy-name parameter in the command to
filter the IPv4 ARP Vlink direct routes to be advertised.
NOTE
Currently, apply clauses cannot be used to set route attributes for the routes that match
the specified route-policy.
IPv4 ARP Vlink direct routes need to be redistributed into the routing tables of
dynamic routing protocols on the device running dynamic routing protocols before
these routes are advertised by dynamic routing protocols.
----End
Verifying the Configuration
After the configuration of the advertisement of IPv4 ARP Vlink direct routes is
complete, you can run the display ip routing-table verbose command to check
information about IPv4 ARP Vlink direct routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1037
11.3 Example for Configuring IP FRR on the Public
Network
Networking Requirements
In Figure 11-1, RouterB and RouterC are egress routers on the Internet. SwitchA is
connected to two core switches SwitchB and SwitchC through two GE interfaces.
Each of SwitchB and SwitchC is connected to the two egress routers through two
GE interfaces. When a fault occurs on the link between SwitchB and RouterB,
SwitchB must rapidly respond to the link fault and use a backup route for data
forwarding to ensure that services are forwarded correctly.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 11-1 Networking diagram of configuring IP FRR on the public network
Configuration Roadmap
The configuration roadmap is as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1038
1. Configure static routes on SwitchA to ensure that packets destined for
192.168.1.1/24 are forwarded by SwitchC and packets destined for
10.55.1.1/24 are forwarded by SwitchB.
2. Configure a route-policy on SwitchB and apply this route-policy for IP FRR on
the public network so that services can be rapidly switched to the backup link
SwitchB→SwitchC→RouterB when the primary link SwitchB→RouterB fails.
Procedure
Step 1 Create VLANs and add interfaces to the VLANs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 50 60
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 50
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 60
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign IPv4 addresses to VLANIF interfaces.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 50
[SwitchA-Vlanif50] ip address 10.50.1.2 24
[SwitchA-Vlanif50] quit
[SwitchA] interface vlanif 60
[SwitchA-Vlanif60] ip address 10.60.1.2 24
[SwitchA-Vlanif60] quit
Step 3 Configure basic OSPF functions on SwitchB and SwitchC.
# Configure SwitchB.
[SwitchB] ospf
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 10.10.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] network 10.20.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] network 10.60.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] network 10.70.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
# Configure SwitchC.
[SwitchC] ospf
[SwitchC-ospf-1] area 0
[SwitchC-ospf-1-area-0.0.0.0] network 10.30.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] network 10.40.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] network 10.50.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] network 10.70.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] quit
[SwitchC-ospf-1] quit
Step 4 Configure IP addresses and basic OSPF functions on RouterB and RouterC to
ensure that there are reachable routes between RouterB, RouterC, SwitchB, and
SwitchC.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1039
Step 5 Configure static routes on SwitchA to ensure that packets destined for
192.168.1.1/24 are forwarded by SwitchC and packets destined for 10.55.1.1/24 are
forwarded by SwitchB.
# Configure SwitchA.
[SwitchA] ip route-static 10.55.1.0 24 vlanif 60 10.60.1.1
[SwitchA] ip route-static 192.168.1.0 24 vlanif 50 10.50.1.1
Step 6 Configure a route-policy and enable IP FRR on the public network.
# Configure an IP prefix list on SwitchB.
[SwitchB] ip ip-prefix ip_frr_pre index 10 permit 10.55.1.0 24
# On SwitchB, configure a route-policy, backup next hop, and backup outbound
interface.
[SwitchB] route-policy ip_frr_rp permit node 10
[SwitchB-route-policy] if-match ip-prefix ip_frr_pre
[SwitchB-route-policy] apply backup-nexthop 10.70.1.1
[SwitchB-route-policy] apply backup-interface vlanif 70
[SwitchB-route-policy] quit
# On SwitchB, enable IP FRR on the public network.
[SwitchB] ip frr route-policy ip_frr_rp
Step 7 Check information about the backup outbound interface and backup next hop.
# Check information about the backup outbound interface and backup next hop
on SwitchB.
[SwitchB] display ip routing-table verbose
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 1 Routes : 1
Destination: 10.55.1.0/24
Protocol: OSPF Process ID: 1
Preference: 10 Cost: 2
NextHop: 10.10.1.1 Neighbour: 0.0.0.0
State: Active Adv Age: 1d17h58m22s
Tag: 0 Priority: medium
Label: NULL QoSInfo: 0x0
IndirectID: 0x80000001
RelayNextHop: 0.0.0.0 Interface: Vlanif10
TunnelID: 0x0 Flags: RD
BkNextHop: 10.70.1.1 BkInterface: Vlanif70
BkLabel: NULL SecTunnelID: 0x0
BkPETunnelID: 0x0 BkPESecTunnelID: 0x0
BkIndirectID: 0x0
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 50 60
#
interface Vlanif50
ip address 10.50.1.2 255.255.255.0
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1040
interface Vlanif60
ip address 10.60.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 50
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 60
#
ip route-static 10.55.1.0 255.255.255.0 Vlanif60 10.60.1.1
ip route-static 192.168.1.0 255.255.255.0 Vlanif50 10.50.1.1
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20 60 70
#
ip frr route-policy ip_frr_rp
#
interface Vlanif10
ip address 10.10.1.2 255.255.255.0
#
interface Vlanif20
ip address 10.20.1.2 255.255.255.0
#
interface Vlanif60
ip address 10.60.1.1 255.255.255.0
#
interface Vlanif70
ip address 10.70.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 70
#
interface GigabitEthernet0/0/4
port link-type trunk
port trunk allow-pass vlan 60
#
ospf 1
area 0.0.0.0
network 10.10.1.0 0.0.0.255
network 10.20.1.0 0.0.0.255
network 10.60.1.0 0.0.0.255
network 10.70.1.0 0.0.0.255
#
ip ip-prefix ip_frr_pre index 10 permit 10.55.1.0 24
#
route-policy ip_frr_rp permit node 10
if-match ip-prefix ip_frr_pre
apply backup-nexthop 10.70.1.1
apply backup-interface Vlanif70
#
return
● SwitchC configuration file
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1041
#
sysname SwitchC
#
vlan batch 30 40 50 70
#
interface Vlanif30
ip address 10.30.1.1 255.255.255.0
#
interface Vlanif40
ip address 10.40.1.1 255.255.255.0
#
interface Vlanif50
ip address 10.50.1.1 255.255.255.0
#
interface Vlanif70
ip address 10.70.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 70
#
interface GigabitEthernet0/0/4
port link-type trunk
port trunk allow-pass vlan 50
#
ospf 1
area 0.0.0.0
network 10.30.1.0 0.0.0.255
network 10.40.1.0 0.0.0.255
network 10.50.1.0 0.0.0.255
network 10.70.1.0 0.0.0.255
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 11 IP Routing Table Management
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1042
12 PBR Configuration
12.1 Overview of PBR
12.2 Licensing Requirements and Limitations for PBR
12.3 Configuring PBR
12.4 Configuring NQA for PBR
12.5 (Optional) Configuring PBR to Take Precedence over Blackhole Routes
12.6 Configuration Examples for PBR
12.1 Overview of PBR
Definition
Policy-based routing (PBR) allows switches to select routes based on user-defined
policies, and it takes precedence over direct routes, static routes, and routes
generated by dynamic routing protocols. After PBR is configured on the device, if
the received packets (including Layer 2 packets) match PBR rules, the device
forwards the packets according to the rules. If the packets do not match PBR rules,
the device forwards the packets according to the destination address of the
packets.
NOTE
The main differences between PBR and routing policies are:
● PBR changes the forwarding path of packets based on user-defined policies instead of
based on the routes in an IP routing table.
● Routing policies change the forwarding path of packets by filtering routes and setting
route attributes. For example, route attributes (including reachability) can be set to
change the forwarding path of network traffic.
Purpose
Traditionally, to determine the routes used to forward packets, a switch searches
its IP routing table based on the destination address carried in the packets. To
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1043
allow switches to route packets based on user-defined policies, PRB can be
configured.
Benefits
PBR has the following advantages:
● Allows network administrators to define policies for routing packets,
improving route selection flexibility.
● Enables different data flows to be forwarded on different links, increasing link
efficiency.
● Allows cost-effective links to be used for transmitting service data without
affecting service quality, reducing the cost of enterprise data services.
12.2 Licensing Requirements and Limitations for PBR
Involved Network Elements
Other network elements are not required.
Licensing Requirements
PBR is a basic feature of a switch and is not under license control.
Feature Support in V200R024C00
All models of S300, S500, S2700, S5700, and S6700 series switches (except the
S5751-L, S5731-L and S5731S-L) support PBR.
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
Feature Limitations
On the S5720I-SI, S5720-LI, S2730S-S, S5735-L-I, S5735-L1,S300, S5735-L, S5735S-
L1, S5720S-LI, S5720S-SI, S5720-SI, S5735-S, S500, and S5735-S-I, PBR takes effect
only for the packets forwarded at Layer 3 but not for the packets forwarded at
Layer 2. On other switch models, PBR takes effect for the packets forwarded at
both Layer 2 and Layer 3.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1044
12.3 Configuring PBR
Context
After a redirection action is configured, a switch redirects packets matching traffic
classification rules to a specified next-hop address.
A traffic policy containing the redirection action can be used globally, on an
interface, or in a VLAN in the inbound direction.
Pre-configuration Tasks
Before configuring PBR, complete the following tasks:
● Configure IP addresses for interfaces and configure routing protocols to
ensure connectivity.
● Configure an ACL to classify traffic.
Procedure
1. Configure a traffic classifier.
For details about configuring a traffic classifier, see Configuring a Traffic
Classifier in "MQC Configuration" in the
S300, S500, S2700, S5700, and S6700
V200R024C00 Configuration Guide - QoS.
2. Configure a traffic behavior.
a. Run traffic behavior
behavior-name
A traffic behavior is created and the traffic behavior view is displayed;
alternatively, the view of an existing traffic behavior is displayed.
b. Run the following commands as required.
▪ Run redirect [ remote ] [ vpn-instance
vpn-instance-name ] ip-
nexthop {
ip-address [ track-nqa
admin-name test-name ] } &<1-4>
[ forced | low-precedence ] *
The switch is configured to redirect packets matching traffic
classification rules to the specified next-hop IP address.
A maximum of four next-hop IP addresses can be configured in a
traffic behavior. If multiple next-hop IP addresses are configured, the
switch determines the active and standby links according to the
sequence in which next-hop IP addresses were configured. The next-
hop IP address that was configured first has the highest priority and
the link for this next hop is used as the active link. Links for other
next hops are used as standby links. If the active link goes Down, the
link for the next hop with the highest priority functions as the new
active link to transmit traffic. If the previous active link recovers from
the fault, traffic is switched back to this previous active link.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1045
NOTE
Configuring redirection can implement PBR.
If the low-precedence parameter is specified, the priority of redirection-
based PBR is lowered below that of statically configured routes or routes
generated by dynamic routing protocols (rather than being higher by
default).
▪ Run redirect [ remote ] [ vpn-instance
vpn-instance-name ] ipv6-
nexthop {
ipv6-address | link-local
link-local-address interface
interface-type interface-number } &<1-4> [ forced ]
The switch is configured to redirect IPv6 packets matching traffic
classification rules to the configured next-hop address.
▪ Run redirect [ vpn-instance
vpn-instance-name ] ip-multihop
{ nexthop
ip-address } &<2-4>
Or run redirect [ vpn-instance
vpn-instance-name ] ip-multihop
acl-ip-pool-name
The switch is configured to redirect packets matching traffic
classification rules to one of the configured next hops.
If multiple next hops are specified, the switch redirects packets
through equal-cost routes for load balancing.
If the outbound interface corresponding to a next-hop IP address
goes Down or a route changes, the switch transmits traffic to the
outbound interface corresponding to an available next hop.
If the switch has no ARP entry matching the specified next-hop IP
address, the redirect ip-multihop command can be used but
redirection does not take effect (the switch continues to forward
packets to the original destination) until the switch obtains the
corresponding ARP entry.
▪ Run redirect [ vpn-instance
vpn-instance-name ] ipv6-multihop
{
ipv6-address | link-local
link-local-address interface
interface-type
interface-number } &<2-4>
Or run redirect [ vpn-instance
vpn-instance-name ] ipv6-multihop
acl6-ip-pool-name
The switch is configured to redirect IPv6 packets matching traffic
classification rules to one of the configured next hops.
If multiple next hops are specified, the switch redirects packets
through equal-cost routes for load balancing.
c. (Optional) Run statistic enable
The traffic statistics collection function is enabled.
d. Run quit
Exit from the traffic behavior view.
e. Run quit
Exit from the system view.
3. Configure a traffic policy.
For details about configuring a traffic policy, see Configuring a Traffic Policy in
"MQC Configuration" in the
S300, S500, S2700, S5700, and S6700
V200R024C00 Configuration Guide - QoS.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1046
4. Apply the traffic policy.
– Apply a traffic policy to an interface.
i. Run system-view
The system view is displayed.
ii. Run interface
interface-type interface-number
The interface view is displayed.
iii. Run traffic-policy
policy-name inbound
A traffic policy is applied to the inbound direction of the interface.
– Apply a traffic policy to a VLAN.
i. Run system-view
The system view is displayed.
ii. Run vlan
vlan-id
The VLAN view is displayed.
iii. Run traffic-policy
policy-name inbound
A traffic policy is applied to the VLAN.
The system then applies the policy to the incoming packets that are
sent from the VLAN and match traffic classification rules.
– Apply a traffic policy globally.
i. Run system-view
The system view is displayed.
ii. Run traffic-policy
policy-name global inbound [ slot
slot-id ]
A traffic policy is applied globally.
Verifying the Configuration
● Run the display traffic classifier user-defined [
classifier-name ] command
to check the traffic classifier configuration.
● Run the display traffic behavior user-defined [
behavior-name ] command
to check the traffic behavior configuration.
● Run the display traffic policy user-defined [
policy-name [ classifier
classifier-name ] ] command to check the configuration of a specified user-
defined traffic policy.
● Run the display traffic-applied [ interface [
interface-type interface-
number ] | vlan [
vlan-id ] ] { inbound | outbound } [ verbose ] command to
check information about ACL-based simplified and MQC-based traffic policies
applied to the system, a VLAN, or an interface.
NOTE
The display traffic-applied command cannot be used to check information about
ACL-based simplified and MQC-based traffic policies applied to a sub-interface.
However, traffic policies can be applied to a sub-interface.
● Run the display traffic policy { interface [
interface-type interface-number
[
.subinterface-number ] ] | vlan [
vlan-id ] | ssid-profile [
ssid-profile-name ]
| global } [ inbound | outbound ] command to check the traffic policy
configuration.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1047
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support sub-interfaces.
Only the S5731-H, S5731S-H, S5732-H, S6730S-H, and S6730-H support ssid-profile
[
ssid-profile-name ].
● Run the display traffic-policy applied-record [
policy-name ] command to
check the application records of a specified traffic policy.
12.4 Configuring NQA for PBR
Background
PBR allows switches to select paths and forward packets based on defined policies.
However, PBR lacks a fault detection mechanism. In a scenario where the link for
the redirection next hop becomes faulty, PBR becomes ineffective only after the
ARP entry of the redirection next hop is aged. As a result, services cannot be
immediately switched to another link, causing service interruptions.
Network quality analysis (NQA) for PBR solves this issue by providing a fault
detection mechanism for PBR. In the same scenario, the next hop will become
ineffective immediately without waiting for the aging of its ARP entry. This is
because the NQA test identifies the fault. NQA for PBR helps shorten the service
interruption time and improve QoS.
Pre-configuration Tasks
Before configuring NQA for PBR, complete the following tasks:
● Configure IP addresses and routing protocols for interfaces to ensure
connectivity.
● Configure an ACL if the ACL needs to be used to classify traffic.
Procedure
1. Configure an ICMP NQA test instance.
a. Run system-view
The system view is displayed.
b. Run nqa test-instance
admin-name test-name
An NQA test instance is created, and the test instance view is displayed.
c. Run test-type icmp
The test type is set to ICMP.
NOTE
When NQA is associated with PBR, only an ICMP NQA test instance can be used
to check whether a route from the source to the destination is reachable.
d. Run destination-address ipv4
ip-address
The destination address is set for the NQA test instance.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1048
e. (Optional) Run frequency
interval
The interval at which the NQA test instance automatically runs is set.
By default, no automatic test interval is set. The system performs the test
only once.
f. (Optional) Run probe-count
number
The number of probes to be sent each time is set for the NQA test
instance.
By default, the number of probes to be sent each time is 3.
By sending multiple probes for an NQA test instance, the network quality
can be estimated more accurately based on the collected statistics.
g. (Optional) Run interval { milliseconds
interval | seconds
interval }
The interval at which probe packets are sent is set for the NQA test
instance.
For the default interval at which probe packets are sent, see the
command reference manual.
h. (Optional) Run timeout
time
The timeout period of a probe is set for the NQA test instance.
By default, the timeout period of a probe for FTP test instances is 15s and
that for other test instances is 3s.
i. Set the NQA test instance startup mode as required to start the NQA test
instance.
▪ Run start now [ end { at [
yyyy/
mm/
dd ]
hh:
mm:
ss | delay
{ seconds
second |
hh:
mm:
ss } | lifetime { seconds
second |
hh:
mm:
ss } } ]
The NQA test instance is started immediately.
▪ Run start at [
yyyy/mm/
dd ]
hh:
mm:
ss [ end { at [
yyyy/
mm/
dd ]
hh:mm:
ss | delay { seconds
second |
hh:
mm:
ss } | lifetime { seconds
second |
hh:mm:
ss } } ]
The NQA test instance is started at the specified time.
▪ Run start delay { seconds
second |
hh:
mm:ss } [ end { at [
yyyy/
mm/dd ]
hh:
mm:
ss | delay { seconds
second |
hh:
mm:
ss } | lifetime
{ seconds
second |
hh:
mm:
ss } } ]
The NQA test instance is started after the specified delay.
j. Run quit
Return to the system view.
k. Run quit
Exit from the system view.
2. Configure a traffic classifier.
For details about configuring a traffic classifier, see Configuring a Traffic
Classifier in "MQC Configuration" in the
S300, S500, S2700, S5700, and S6700
V200R024C00 Configuration Guide - QoS.
3. Configure a traffic behavior.
a. Run system-view
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1049
The system view is displayed.
b. Run traffic behavior
behavior-name
A traffic behavior is created and the traffic behavior view is displayed;
alternatively, the existing traffic behavior view is displayed.
c. Run redirect [ remote ] [ vpn-instance
vpn-instance-name ] ip-nexthop
{
ip-address [ track-nqa
admin-name test-name ] } &<1-4> [ forced |
low-precedence ] *
The packets matching traffic classification rules are redirected to the
specified next hop, and association between PBR and the NQA test
instance is configured.
To configure association between PBR and the NQA test instance, specify
the track-nqa
admin-name test-name parameter.
NOTE
In a given traffic behavior, a next-hop IP address can be bound to only one NQA
test instance.
On the switch, a maximum of eight NQA test instances can be bound.
d. (Optional) Run statistic enable
The traffic statistics collection function is enabled.
e. Run quit
Return to the system view.
f. Run quit
Exit from the system view.
4. Configure a traffic policy.
For details about configuring a traffic policy, see Configuring a Traffic Policy in
"MQC Configuration" in the
S300, S500, S2700, S5700, and S6700
V200R024C00 Configuration Guide - QoS.
5. Apply the traffic policy.
– Apply the traffic policy to an interface.
i. Run system-view
The system view is displayed.
ii. Run interface
interface-type interface-number
The interface view is displayed.
iii. Run traffic-policy
policy-name inbound
The traffic policy is applied to the inbound direction of the interface.
– Apply the traffic policy to a VLAN.
i. Run system-view
The system view is displayed.
ii. Run vlan
vlan-id
The VLAN view is displayed.
iii. Run traffic-policy
policy-name inbound
The traffic policy is applied to the VLAN.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1050
Subsequently, the system performs traffic policing on the incoming
packets that are sent from the VLAN and match traffic classification
rules.
– Apply the traffic policy globally.
i. Run system-view
The system view is displayed.
ii. Run traffic-policy
policy-name global inbound [ slot
slot-id ]
The traffic policy is applied globally.
Verifying the Configuration
● Run the display traffic classifier user-defined [
classifier-name ] command
to check the traffic classifier configuration.
● Run the display traffic behavior user-defined [
behavior-name ] command
to check the traffic behavior configuration.
● Run the display traffic policy user-defined [
policy-name [ classifier
classifier-name ] ] command to check the configuration of a specified user-
defined traffic policy.
● Run the display traffic-applied [ interface [
interface-type interface-
number ] | vlan [
vlan-id ] ] { inbound | outbound } [ verbose ] command to
check information about ACL-based simplified and MQC-based traffic policies
applied to the system, a VLAN, or an interface.
NOTE
The display traffic-applied command cannot be used to check information about
ACL-based simplified and MQC-based traffic policies applied to a sub-interface.
However, traffic policies can be applied to a sub-interface.
● Run the display traffic policy { interface [
interface-type interface-number
[
.subinterface-number ] ] | vlan [
vlan-id ] | ssid-profile [
ssid-profile-name ]
| global } [ inbound | outbound ] command to check the traffic policy
configuration.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support sub-interfaces.
Only the S5731-H, S5731S-H, S5732-H, S6730S-H, and S6730-H support ssid-profile
[
ssid-profile-name ].
● Run the display traffic-policy applied-record [
policy-name ] command to
check the application records of a specified traffic policy.
12.5 (Optional) Configuring PBR to Take Precedence
over Blackhole Routes
On the S5731-H, S5731S-H, S5732-H, S5731-S, S5731S-S, S6730-H, S6730S-H,
S6730-S, S6730S-S, PBR has a lower priority than a blackhole route. That is, when
traffic matches both PBR and a blackhole route, the PBR configuration does not
take effect.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1051
To make PBR take effect in this scenario, run the blackhole-route optimize
enable command to enable PBR to take precedence over blackhole routes.
Procedure
1. Run system-view
The system view is displayed.
2. Run blackhole-route optimize enable
PBR is configured to take precedence over blackhole routes.
By default, blackhole routes take precedence over PBR on the devices that
support this command.
NOTE
Only the following device models support this command: S5731-H, S5731S-H, S5732-
H, S5731-S, S5731S-S, S6730-H, S6730S-H, S6730-S, S6730S-S.
12.6 Configuration Examples for PBR
12.6.1 Example for Configuring PBR Based on IP Addresses
Networking Requirements
In Figure 12-1, the Switch on the aggregation layer is a Layer 3 forwarding device,
and an LSW on the access layer serves as the user gateway. There is a reachable
route between the Switch and LSW. The Switch is connected to two core routers
through two links: a high-speed link with the gateway 10.1.20.1/24 and a low-
speed link with the gateway 10.1.30.1/24.
The enterprise requires that the Switch forward packets from 192.168.100.0/24
and 192.168.101.0/24 to the core layer through the high-speed link and low-speed
link, respectively.
Figure 12-1 Networking diagram for configuring PBR
Configuration Roadmap
Implement PBR through redirection so that the Switch can provide differentiated
services. The configuration roadmap is as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1052
1. Create VLANs and configure interfaces to connect the enterprise' devices to
external network devices.
2. Configure ACL rules to separately match packets with source IP addresses
192.168.100.0/24 and 192.168.101.0/24.
3. Configure traffic classifiers and bind them to ACL rules so that the Switch can
differentiate packets.
4. Configure traffic behaviors to redirect the packets matching different rules to
10.1.20.1/24 and 10.1.30.1/24 separately.
5. Configure a traffic policy, bind it to the traffic classifiers and traffic behaviors,
and apply it to the inbound direction of GE0/0/3 to implement PBR.
Procedure
Step 1 Create VLANs and configure interfaces.
# Create VLANs 100 and 200 on the Switch.
<HUAWEI> system-view
[HUAWEI] sysname Switch
[Switch] vlan batch 100 200
Configure GE0/0/1, GE0/0/2, and GE0/0/3 on the Switch as trunk interfaces, and
add them to VLANs 100 and 200.
[Switch] interface gigabitethernet 0/0/1
[Switch-GigabitEthernet0/0/1] port link-type trunk
[Switch-GigabitEthernet0/0/1] port trunk allow-pass vlan 100 200
[Switch-GigabitEthernet0/0/1] quit
[Switch] interface gigabitethernet 0/0/2
[Switch-GigabitEthernet0/0/2] port link-type trunk
[Switch-GigabitEthernet0/0/2] port trunk allow-pass vlan 100 200
[Switch-GigabitEthernet0/0/2] quit
[Switch] interface gigabitethernet 0/0/3
[Switch-GigabitEthernet0/0/3] port link-type trunk
[Switch-GigabitEthernet0/0/3] port trunk allow-pass vlan 100 200
[Switch-GigabitEthernet0/0/3] quit
# Create VLANIF 100 and VLANIF 200, and configure IP addresses for them.
[Switch] interface vlanif 100
[Switch-Vlanif100] ip address 10.1.20.2 24
[Switch-Vlanif100] quit
[Switch] interface vlanif 200
[Switch-Vlanif200] ip address 10.1.30.2 24
[Switch-Vlanif200] quit
Step 2 Configure ACL rules.
# On the Switch, create advanced ACLs 3001 and 3002 to permit packets with
source IP addresses 192.168.100.0/24 and 192.168.101.0/24 respectively.
[Switch] acl 3001
[Switch-acl-adv-3001] rule permit ip source 192.168.100.0 0.0.0.255
[Switch-acl-adv-3001] quit
[Switch] acl 3002
[Switch-acl-adv-3002] rule permit ip source 192.168.101.0 0.0.0.255
[Switch-acl-adv-3002] quit
Step 3 Configure traffic classifiers.
# On the Switch, create traffic classifiers c1 and c2, and bind c1 to ACL 3001 and
c2 to ACL 3002.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1053
[Switch] traffic classifier c1 operator or
[Switch-classifier-c1] if-match acl 3001
[Switch-classifier-c1] quit
[Switch] traffic classifier c2 operator or
[Switch-classifier-c2] if-match acl 3002
[Switch-classifier-c2] quit
Step 4 Configure traffic behaviors.
# On the Switch, create traffic behaviors b1 and b2 to redirect traffic to
10.1.20.1/24 and 10.1.30.1/24, respectively.
[Switch] traffic behavior b1
[Switch-behavior-b1] redirect ip-nexthop 10.1.20.1
[Switch-behavior-b1] quit
[Switch] traffic behavior b2
[Switch-behavior-b2] redirect ip-nexthop 10.1.30.1
[Switch-behavior-b2] quit
Step 5 Configure a traffic policy and apply it to an interface.
# On the Switch, create a traffic policy p1, and bind it to the traffic classifiers and
traffic behaviors.
[Switch] traffic policy p1
[Switch-trafficpolicy-p1] classifier c1 behavior b1
[Switch-trafficpolicy-p1] classifier c2 behavior b2
[Switch-trafficpolicy-p1] quit
# Apply the traffic policy p1 to the inbound direction of GE0/0/3.
[Switch] interface gigabitethernet 0/0/3
[Switch-GigabitEthernet0/0/3] traffic-policy p1 inbound
[Switch-GigabitEthernet0/0/3] return
Step 6 Verify the configuration.
# Check the ACL configuration.
<Switch> display acl 3001
Advanced ACL 3001, 1 rule
Acl's step is 5
rule 5 permit ip source 192.168.100.0 0.0.0.255
<Switch> display acl 3002
Advanced ACL 3002, 1 rule
Acl's step is 5
rule 5 permit ip source 192.168.101.0 0.0.0.255
# Check the traffic classifier configuration.
<Switch> display traffic classifier user-defined
User Defined Classifier Information:
Classifier: c2
Operator: OR
Rule(s) :if-match acl 3002
Classifier: c1
Operator: OR
Rule(s) : if-match acl 3001
Total classifier number is 2
# Check the traffic policy configuration.
<Switch> display traffic policy user-defined p1
User Defined Traffic Policy Information:
Policy: p1
Classifier: c1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1054
Operator: OR
Behavior: b1
Redirect: no forced
Redirect ip-nexthop
10.1.20.1
Classifier: c2
Operator: OR
Behavior: b2
Redirect: no forced
Redirect ip-nexthop
10.1.30.1
----End
Configuration Files
● Switch configuration file
#
sysname Switch
#
vlan batch 100 200
#
acl number 3001
rule 5 permit ip source 192.168.100.0 0.0.0.255
acl number 3002
rule 5 permit ip source 192.168.101.0 0.0.0.255
#
traffic classifier c1 operator or
if-match acl 3001
traffic classifier c2 operator or
if-match acl 3002
#
traffic behavior b1
redirect ip-nexthop 10.1.20.1
traffic behavior b2
redirect ip-nexthop 10.1.30.1
#
traffic policy p1 match-order config
classifier c1 behavior b1
classifier c2 behavior b2
#
interface Vlanif100
ip address 10.1.20.2 255.255.255.0
#
interface Vlanif200
ip address 10.1.30.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 100 200
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 100 200
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 100 200
traffic-policy p1 inbound
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1055
12.6.2 Example for Configuring PBR
Networking Requirements
In Figure 12-2, enterprise users are dual-homed to external network devices
through the Switch. The Switch is connected to two core routers through two
links, a high-speed link with the gateway 10.1.30.1/24 and a low-speed link with
the gateway 10.1.20.1/24.
The enterprise requires that outgoing packets with IP precedences 4, 5, 6, and 7 be
transmitted on the high-speed link and outgoing packets with IP precedences 0, 1,
2, and 3 be transmitted on the low-speed link.
Figure 12-2 PBR networking
Configuration Roadmap
Implement PBR through redirection so that the Switch can provide differentiated
services. The configuration roadmap is as follows:
1. Create VLANs and configure interfaces to connect the enterprise' devices to
external network devices.
2. Configure ACL rules to separately match the packets with IP precedences of 4,
5, 6, and 7 and the packets with IP precedences of 0, 1, 2, and 3.
3. Configure traffic classifiers and bind them to ACL rules in the traffic classifiers
so that the Switch can differentiate packets.
4. Configure traffic behaviors to redirect the packets matching traffic
classification rules to 10.1.20.1/24 and 10.1.30.1/24 separately.
5. Configure a traffic policy, bind it to the traffic classifiers and traffic behaviors,
and apply it to the inbound direction of GE0/0/3 to implement PBR.
Procedure
Step 1 Create VLANs and configure interfaces.
# Create VLAN 100 and VLAN 200 on the Switch.
<HUAWEI> system-view
[HUAWEI] sysname Switch
[Switch] vlan batch 100 200
# Configure GE0/0/1, GE0/0/2, and GE0/0/3 on the Switch as trunk interfaces and
add them to VLAN 100 and VLAN 200.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1056
[Switch] interface gigabitethernet 0/0/1
[Switch-GigabitEthernet0/0/1] port link-type trunk
[Switch-GigabitEthernet0/0/1] port trunk allow-pass vlan 100 200
[Switch-GigabitEthernet0/0/1] quit
[Switch] interface gigabitethernet 0/0/2
[Switch-GigabitEthernet0/0/2] port link-type trunk
[Switch-GigabitEthernet0/0/2] port trunk allow-pass vlan 100 200
[Switch-GigabitEthernet0/0/2] quit
[Switch] interface gigabitethernet 0/0/3
[Switch-GigabitEthernet0/0/3] port link-type trunk
[Switch-GigabitEthernet0/0/3] port trunk allow-pass vlan 100 200
[Switch-GigabitEthernet0/0/3] quit
NOTE
Configure the interface connecting the LSW to the Switch as a trunk interface and add it to
VLAN 100 and VLAN 200.
# Create VLANIF 100 and VLANIF 200 and configure IP addresses for them.
[Switch] interface vlanif 100
[Switch-Vlanif100] ip address 10.1.20.2 24
[Switch-Vlanif100] quit
[Switch] interface vlanif 200
[Switch-Vlanif200] ip address 10.1.30.2 24
[Switch-Vlanif200] quit
Step 2 Configure ACLs.
# Create advanced ACLs 3001 and 3002 on the Switch. ACL 3001 permits packets
with IP precedences of 0, 1, 2, and 3 and ACL 3002 permits packets with IP
precedences of 4, 5, 6, and 7.
[Switch] acl 3001
[Switch-acl-adv-3001] rule permit ip precedence 0
[Switch-acl-adv-3001] rule permit ip precedence 1
[Switch-acl-adv-3001] rule permit ip precedence 2
[Switch-acl-adv-3001] rule permit ip precedence 3
[Switch-acl-adv-3001] quit
[Switch] acl 3002
[Switch-acl-adv-3002] rule permit ip precedence 4
[Switch-acl-adv-3002] rule permit ip precedence 5
[Switch-acl-adv-3002] rule permit ip precedence 6
[Switch-acl-adv-3002] rule permit ip precedence 7
[Switch-acl-adv-3002] quit
Step 3 Configure traffic classifiers.
On the Switch, create traffic classifiers c1 and c2, and bind c1 to ACL 3001 and c2
to ACL 3002.
[Switch] traffic classifier c1 operator and
[Switch-classifier-c1] if-match acl 3001
[Switch-classifier-c1] quit
[Switch] traffic classifier c2 operator and
[Switch-classifier-c2] if-match acl 3002
[Switch-classifier-c2] quit
Step 4 Configure traffic behaviors.
# On the Switch, create traffic behaviors b1 and b2 to redirect traffic to
10.1.20.1/24 and 10.1.30.1/24, respectively.
[Switch] traffic behavior b1
[Switch-behavior-b1] redirect ip-nexthop 10.1.20.1
[Switch-behavior-b1] quit
[Switch] traffic behavior b2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1057
[Switch-behavior-b2] redirect ip-nexthop 10.1.30.1
[Switch-behavior-b2] quit
Step 5 Configure a traffic policy and apply it to an interface.
# On the Switch, create a traffic policy p1, and bind it to the traffic classifiers and
traffic behaviors.
[Switch] traffic policy p1
[Switch-trafficpolicy-p1] classifier c1 behavior b1
[Switch-trafficpolicy-p1] classifier c2 behavior b2
[Switch-trafficpolicy-p1] quit
# Apply the traffic policy p1 to the inbound direction of GE0/0/3.
[Switch] interface gigabitethernet 0/0/3
[Switch-GigabitEthernet0/0/3] traffic-policy p1 inbound
[Switch-GigabitEthernet0/0/3] return
Step 6 Verify the configuration.
# Check the ACL configuration.
<Switch> display acl 3001
Advanced ACL 3001, 4 rules
Acl's step is 5
rule 5 permit ip precedence routine
rule 10 permit ip precedence priority
rule 15 permit ip precedence immediate
rule 20 permit ip precedence flash
<Switch> display acl 3002
Advanced ACL 3002, 4 rules
Acl's step is 5
rule 5 permit ip precedence flash-override
rule 10 permit ip precedence critical
rule 15 permit ip precedence internet
rule 20 permit ip precedence network
# Check the traffic classifier configuration.
<Switch> display traffic classifier user-defined
User Defined Classifier Information:
Classifier: c2
Operator: AND
Rule(s) : if-match acl 3002
Classifier: c1
Operator: AND
Rule(s) : if-match acl 3001
Total classifier number is 2
# Check the traffic policy configuration.
<Switch> display traffic policy user-defined p1
User Defined Traffic Policy Information:
Policy: p1
Classifier: c1
Operator: AND
Behavior: b1
Redirect: no forced
Redirect ip-nexthop
10.1.20.1
Classifier: c2
Operator: AND
Behavior: b2
Redirect: no forced
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1058
Redirect ip-nexthop
10.1.30.1
----End
Configuration Files
● Switch configuration file
#
sysname Switch
#
vlan batch 100 200
#
acl number 3001
rule 5 permit ip precedence routine
rule 10 permit ip precedence priority
rule 15 permit ip precedence immediate
rule 20 permit ip precedence flash
acl number 3002
rule 5 permit ip precedence flash-override
rule 10 permit ip precedence critical
rule 15 permit ip precedence internet
rule 20 permit ip precedence network
#
traffic classifier c1 operator and
if-match acl 3001
traffic classifier c2 operator and
if-match acl 3002
#
traffic behavior b1
redirect ip-nexthop 10.1.20.1
traffic behavior b2
redirect ip-nexthop 10.1.30.1
#
traffic policy p1 match-order config
classifier c1 behavior b1
classifier c2 behavior b2
#
interface Vlanif100
ip address 10.1.20.2 255.255.255.0
#
interface Vlanif200
ip address 10.1.30.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 100 200
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 100 200
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 100 200
traffic-policy p1 inbound
#
return
12.6.3 Example for Configuring PBR to Import Traffic to the
Firewall in Bypass Mode
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1059
Networking Requirements
In Figure 12-3, enterprise users need to access the Internet through SwitchA (core
switch) and the router (access gateway).
To ensure the security of the enterprise's intranet, traffic entering the intranet
needs to be imported to the firewall in bypass mode.
Figure 12-3 Networking for configuring PBR to import traffic to the firewall in
bypass mode
Configuration Roadmap
The configuration roadmap is as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1060
● Configure an IP address for each interface and configure a routing protocol
between the switch and firewall to ensure that there is a reachable route.
● Configure PBR on SwitchA to redirect traffic to the firewall for security
detection. Traffic that is sent from the external network to the enterprise
intranet will be redirected.
NOTE
This example provides only the switch configuration. For the firewall configuration, see the
firewall documentation.
Procedure
Step 1 Configure an IP address for each interface on SwitchA and the firewall, and
configure a routing protocol on SwitchA.
# Assign an IP address to each interface of SwitchA. By default, a switch interface
is a Layer 2 interface. Before configuring an IP address for a switch interface, run
the undo portswitch command to change the interface to a Layer 3 interface.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] undo portswitch
[SwitchA-GigabitEthernet0/0/1] ip address 10.1.1.2 24
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] undo portswitch
[SwitchA-GigabitEthernet0/0/2] ip address 10.1.20.1 24
[SwitchA-GigabitEthernet0/0/2] quit
[SwitchA] interface gigabitethernet 0/0/3
[SwitchA-GigabitEthernet0/0/3] undo portswitch
[SwitchA-GigabitEthernet0/0/3] ip address 10.1.10.6 24
[SwitchA-GigabitEthernet0/0/3] quit
[SwitchA] interface gigabitethernet 0/0/4
[SwitchA-GigabitEthernet0/0/4] undo portswitch
[SwitchA-GigabitEthernet0/0/4] ip address 10.1.11.6 24
[SwitchA-GigabitEthernet0/0/4] quit
# Configure a routing protocol on SwitchA to ensure Layer 3 connectivity. OSPF is
used as an example.
Generally, two OSPF processes are configured on the firewall to advertise uplink
and downlink network segments. Therefore, two OSPF processes need to be
configured on SwitchA.
[SwitchA] ospf 100
[SwitchA-ospf-100] area 0
[SwitchA-ospf-100-area-0.0.0.0] network 10.1.1.0 0.0.0.255
[SwitchA-ospf-100-area-0.0.0.0] network 10.1.10.0 0.0.0.255
[SwitchA-ospf-100-area-0.0.0.0] quit
[SwitchA-ospf-100] quit
[SwitchA] ospf 200
[SwitchA-ospf-200] area 0
[SwitchA-ospf-200-area-0.0.0.0] network 10.1.11.0 0.0.0.255
[SwitchA-ospf-200-area-0.0.0.0] network 10.1.20.0 0.0.0.255
[SwitchA-ospf-200-area-0.0.0.0] quit
[SwitchA-ospf-200] quit
Step 2 Configure PBR on SwitchA to redirect traffic to the firewall for security detection.
Traffic that is sent from the external network to the enterprise intranet will be
redirected.
# Configure a traffic classifier to match all traffic.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1061
[SwitchA] traffic classifier c1
[SwitchA-classifier-c1] if-match any
[SwitchA-classifier-c1] quit
# Configure a traffic behavior to redirect matching traffic to the firewall (with the
next-hop address 10.1.10.5).
[SwitchA] traffic behavior b1
[SwitchA-behavior-b1] redirect ip-nexthop 10.1.10.5
[SwitchA-behavior-b1] quit
# Configure a traffic policy.
[SwitchA] traffic policy p1
[SwitchA-trafficpolicy-p1] classifier c1 behavior b1
[SwitchA-trafficpolicy-p1] quit
# Apply the traffic policy to the inbound direction of GigabitEthernet0/0/1 on
SwitchA.
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] traffic-policy p1 inbound
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] quit
Step 3 Verify the configuration.
# Check the traffic classifier configuration.
<SwitchA> display traffic classifier user-defined c1
User Defined Classifier Information:
Classifier: c1
Operator: AND
Rule(s) : if-match any
# Check the traffic behavior configuration.
<SwitchA> display traffic behavior user-defined b1
User Defined Behavior Information:
Behavior: b1
Redirect: no forced
Redirect ip-nexthop
10.1.10.5
# Check the traffic policy configuration.
<SwitchA> display traffic policy user-defined p1
User Defined Traffic Policy Information:
Policy: p1
Classifier: c1
Operator: AND
Behavior: b1
Redirect: no forced
Redirect ip-nexthop
10.1.10.5
# Check the traffic policy record.
<SwitchA> display traffic-policy applied-record
#
-------------------------------------------------
Policy Name: p1
Policy Index: 0
Classifier:c1 Behavior:b1
-------------------------------------------------
*interface GigabitEthernet0/0/1
traffic-policy p1 inbound
slot 0 : success
-------------------------------------------------
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1062
Policy total applied times: 1.
#
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
traffic classifier c1 operator and
if-match any
#
traffic behavior b1
redirect ip-nexthop 10.1.10.5
#
traffic policy p1 match-order config
classifier c1 behavior b1
#
interface GigabitEthernet0/0/1
undo portswitch
ip address 10.1.1.2 255.255.255.0
traffic-policy p1 inbound
#
interface GigabitEthernet0/0/2
undo portswitch
ip address 10.1.20.1 255.255.255.0
#
interface GigabitEthernet0/0/3
undo portswitch
ip address 10.1.10.6 255.255.255.0
#
interface GigabitEthernet0/0/4
undo portswitch
ip address 10.1.11.6 255.255.255.0
#
ospf 100
area 0.0.0.0
network 10.1.1.0 0.0.0.255
network 10.1.10.0 0.0.0.255
#
ospf 200
area 0.0.0.0
network 10.1.11.0 0.0.0.255
network 10.1.20.0 0.0.0.255
#
return
12.6.4 Example for Configuring NQA for PBR
Networking Requirements
In Figure 12-4, an enterprise uses SwitchA as an aggregation switch and access
switch LSW as a user gateway. There are reachable routes between SwitchA and
LSW. SwitchA connects to two core switches, SwitchB and SwitchC, through a
high-speed link with the gateway 10.1.20.1/24 and a low-speed link with the
gateway 10.1.30.1/24, respectively. A default route has been configured on
SwitchA to ensure that traffic is transmitted through the high-speed link by
default. The enterprise has the following requirements:
● Use PBR to direct packets with the source IP address 192.168.101.0/24 to the
low-speed link. This is to reduce the bandwidth pressure on the high-speed
link.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1063
● If the low-speed link becomes faulty, packets with the source IP address
192.168.101.0/24 must be rapidly switched back to the high-speed link to
minimize service interruption caused by the link fault.
Figure 12-4 Configuring NQA for PBR
Configuration Roadmap
The configuration roadmap is as follows:
1. Create VLANs and configure interfaces to connect the enterprise' devices to
external network devices.
2. Configure an NQA test instance to detect low-speed link quality. This
configuration provides a fault detection mechanism for PBR.
3. Configure an ACL to match packets with the source address 192.168.101.0/24
that need to be directed to the low-speed link.
4. Configure a traffic classifier and bind it to the ACL so that SwitchA can
differentiate packets.
5. Configure a traffic behavior to redirect packets with the source IP address
192.168.101.0/24 to 10.1.30.1 and configure the NQA test instance for PBR.
6. Configure a traffic policy, bind it to the traffic classifier and traffic behavior,
and apply it to the inbound direction of GE0/0/3 on SwitchA to associate NQA
with PBR.
Procedure
Step 1 Specify the VLANs to which interfaces belong.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar and
are not mentioned here.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1064
[SwitchA] vlan batch 100 200
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 100
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 200
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure an IP address for each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar and
are not mentioned here.
[SwitchA] interface vlanif 100
[SwitchA-Vlanif100] ip address 10.1.20.2 24
[SwitchA-Vlanif100] quit
[SwitchA] interface vlanif 200
[SwitchA-Vlanif200] ip address 10.1.30.2 24
[SwitchA-Vlanif200] quit
Step 3 Configure an NQA test instance on SwitchA.
[SwitchA] nqa test-instance user test
[SwitchA-nqa-user-test] test-type icmp
[SwitchA-nqa-user-test] destination-address ipv4 10.1.30.1
[SwitchA-nqa-user-test] frequency 11
[SwitchA-nqa-user-test] probe-count 2
[SwitchA-nqa-user-test] interval seconds 5
[SwitchA-nqa-user-test] timeout 4
[SwitchA-nqa-user-test] start now
[SwitchA-nqa-user-test] quit
Step 4 Check the NQA test result on SwitchA.
[SwitchA] display nqa results test-instance user test
NQA entry(user, test) :testflag is active ,testtype is icmp
1 . Test 288 result The test is finished
Send operation times: 2 Receive response times: 2
Completion:success RTD OverThresholds number: 0
Attempts number:1 Drop operation number:0
Disconnect operation number:0 Operation timeout number:0
System busy operation number:0 Connection fail number:0
Operation sequence errors number:0 RTT Status errors number:0
Destination ip address:10.1.30.1
Min/Max/Average Completion Time: 3/4/3
Sum/Square-Sum Completion Time: 7/25
Last Good Probe Time: 2014-09-09 09:55:38.2
Lost packet ratio: 0 %
If the command output contains Completion:success and Lost packet ratio: 0 %,
the NQA test is successful and links are normal.
Step 5 Configure an ACL.
# Create an advanced ACL 3001 on SwitchA to permit packets with the source IP
address 192.168.101.0/24.
[SwitchA] acl 3001
[SwitchA-acl-adv-3001] rule permit ip source 192.168.101.0 0.0.0.255
[SwitchA-acl-adv-3001] quit
Step 6 Configure a traffic classifier.
# Create a traffic classifier c1 on SwitchA, and bind c1 to ACL 3001.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1065
[SwitchA] traffic classifier c1 operator or
[SwitchA-classifier-c1] if-match acl 3001
[SwitchA-classifier-c1] quit
Step 7 Configure a traffic behavior.
# Create a traffic behavior b1 on SwitchA to redirect packets to 10.1.30.1, and
configure NQA for PBR.
[SwitchA] traffic behavior b1
[SwitchA-behavior-b1] redirect ip-nexthop 10.1.30.1 track-nqa user test
[SwitchA-behavior-b1] quit
Step 8 Configure a traffic policy and apply it to an interface.
# Create a traffic policy p1 on SwitchA, and bind it to the traffic classifier and
traffic behavior.
[SwitchA] traffic policy p1
[SwitchA-trafficpolicy-p1] classifier c1 behavior b1
[SwitchA-trafficpolicy-p1] quit
# Apply the traffic policy p1 to the inbound direction of GE0/0/3 on SwitchA.
[SwitchA] interface gigabitethernet 0/0/3
[SwitchA-GigabitEthernet0/0/3] traffic-policy p1 inbound
[SwitchA-GigabitEthernet0/0/3] return
Step 9 Verify the configuration.
# Check the ACL configuration.
<SwitchA> display acl 3001
Advanced ACL 3001, 1 rule
Acl's step is 5
rule 5 permit ip source 192.168.101.0 0.0.0.255
# Check the traffic classifier configuration.
<SwitchA> display traffic classifier user-defined
User Defined Classifier Information:
Classifier: c1
Operator: OR
Rule(s) : if-match acl 3001
Total classifier number is 1
# Check the traffic policy configuration.
<SwitchA> display traffic policy user-defined p1
User Defined Traffic Policy Information:
Policy: p1
Classifier: c1
Operator: OR
Behavior: b1
Redirect: no forced
Redirect ip-nexthop
10.1.30.1 track-nqa user test
The preceding command output shows that PBR on SwitchA has been associated
with NQA. If a link becomes faulty, PBR on SwitchA becomes ineffective
immediately without waiting for the aging of ARP entries. Subsequently, traffic is
forwarded according to the IP routing table on SwitchA.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1066
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 100 200
#
acl number 3001
rule 5 permit ip source 192.168.101.0 0.0.0.255
#
traffic classifier c1 operator or
if-match acl 3001
#
traffic behavior b1
redirect ip-nexthop 10.1.30.1 track-nqa user test
#
traffic policy p1 match-order config
classifier c1 behavior b1
#
interface Vlanif100
ip address 10.1.20.2 255.255.255.0
#
interface Vlanif200
ip address 10.1.30.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 100
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 200
#
interface GigabitEthernet0/0/3
traffic-policy p1 inbound
#
nqa test-instance user test
test-type icmp
destination-address ipv4 10.1.30.1
frequency 11
interval seconds 5
timeout 4
probe-count 2
start now
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 100
#
interface Vlanif100
ip address 10.1.20.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 200
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1067
interface Vlanif200
ip address 10.1.30.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 200
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 12 PBR Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1068
13 Route Monitoring Group
Configuration
13.1 Overview of Route Monitoring Groups
13.2 Application Scenarios for Route Monitoring Groups
13.3 Understanding Route Monitoring Groups
13.4 Licensing Requirements and Limitations for Route Monitoring Group
13.5 Configuring Association Between IPv4 Static Routes and a Route Monitoring
Group
13.6 Example for Configuring Association Between IPv4 Static Routes and a Route
Monitoring Group
13.1 Overview of Route Monitoring Groups
Definition
Route monitoring groups monitor the connectivity of network-side IPv4 routes,
and their status is associated with IPv4 static routes. By leveraging route
monitoring groups, access-side service modules can perform active/standby link
switchovers upon changes to the connectivity status of network-side IP routes,
preventing network congestion or traffic loss.
Purpose
To improve network reliability, device-level redundancy is used on live networks.
This involves two devices that back up each other and operate in load balancing
mode. If one device fails, the other device takes over services from the faulty
device. Inter-device link reliability and load balancing issues need to be resolved
when one device is dual-homed to two devices that operate in active/standby
mode.
In a two-node hot standby scenario, if some or all network-side links fail, the
bandwidth of the network-side links decreases accordingly. Network congestion or
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 13 Route Monitoring Group Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1069
traffic loss will occur if the access side cannot promptly detect link failures. To
prevent these problems from arising, you can configure a route monitoring group
and associate its status with the status of IPv4 static routes. This allows status
changes of network-side routes to trigger switching between the active and
standby links of access-side service modules.
13.2 Application Scenarios for Route Monitoring
Groups
13.2.1 Preventing Network Congestion
On the network shown in Figure 13-1, AGG_Switch_A and AGG_Switch_B back up
each other, and several ACC_Switches are dual-homed to the two AGG_Switches to
implement load balancing. If some network-side links between AGG_Switch_A and
the core network fail, the available bandwidth of links between them decreases
accordingly. However, ACC_Switches cannot detect link failures and still forward
packets destined for the core network to AGG_Switch_A. In this scenario,
congestion will occur on the links between AGG_Switch_A and the core network.
To prevent network congestion, you can deploy route monitoring groups on
ACC_Switches to quickly detect the connectivity of IP routes on the network. This
will allow ACC_Switches to promptly perform access-side link switching when
there are changes to the status of IP routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 13 Route Monitoring Group Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1070
Figure 13-1 Typical networking diagram of route monitoring groups
13.2.2 Preventing Traffic Loss
On the network shown in Figure 13-2, AGG_Switch_A and AGG_Switch_B back up
each other, and several ACC_Switches are dual-homed to the two AGG_Switches to
implement load balancing. If all the links between AGG_Switch_A and the core
network fail, only the links between AGG_Switch_B and the core network are
available on the network side. However, ACC_Switches cannot detect link failures
and still forward packets destined for the core network to AGG_Switch_A. In this
scenario, the packets transmitted from ACC_Switches are lost because all the links
between AGG_Switch_A and the core network are unavailable.
To prevent traffic loss, you can configure route monitoring groups on
ACC_Switches to quickly detect the connectivity of IP routes on the network. This
will allow ACC_Switches to promptly perform access-side link switching when
there are changes to the status of IP routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 13 Route Monitoring Group Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1071
Figure 13-2 Typical networking diagram of route monitoring groups
13.3 Understanding Route Monitoring Groups
Monitored routes of the same type on the network side can be added to a route
monitoring group. Each route monitoring group is identified by a unique name.
The status of a route monitoring group depends on the status of its member
routes. Service modules will switch links if the status of the route monitoring
group changes.
A route monitoring group monitors the status of all its member routes. You can
set the logical relationship between the monitored routes in a group to AND or
OR.
● When the logical relationship between the monitored routes in a route
monitoring group is set to AND, the group status changes to Down as long as
one route in the group goes Down. The route management (RM) module
then instructs the service modules to switch links.
● When the logical relationship between the monitored routes in a route
monitoring group is set to OR, the group status only changes to Down when
all the routes in the group go Down. The RM module then instructs the
service modules to switch links.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 13 Route Monitoring Group Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1072
13.4 Licensing Requirements and Limitations for Route
Monitoring Group
Involved Network Elements
Other network elements are not required.
Licensing Requirements
Route monitoring group is a basic feature of a switch and is not under license
control.
Feature Support in V200R024C00
All models of S300, S500, S2700, S5700, and S6700 series switches (except the
S5751-L, S5731-L and S5731S-L) support Route Monitoring Group.
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
Feature Limitations
None
13.5 Configuring Association Between IPv4 Static
Routes and a Route Monitoring Group
Context
To quickly detect link quality changes for static routes and ensure timely link
switching, you can associate the IPv4 static routes with a route monitoring group.
If a network-side link fails, the route monitoring group detects the status change
of the corresponding network-side route and triggers switching between the active
and standby links on the access side. This prevents network congestion and traffic
loss and ensures service continuity.
Pre-configuration Tasks
Before configuring association between IPv4 static routes and a route monitoring
group, configure link-layer protocol parameters and IP addresses for interfaces to
ensure that the link-layer protocol status of the interfaces is Up.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 13 Route Monitoring Group Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1073
Procedure
1. Configure a route monitoring group.
a. Run system-view
The system view is displayed.
b. Run ip route-monitor-group
group-name
A route monitoring group is created and the route monitoring group view
is displayed.
By default, no route monitoring group is created on a switch.
c. Run track ip route [ vpn-instance
vpn-instance-name ]
dest-address
{
mask |
mask-length }
A route is added to the route monitoring group.
By default, no route is added to a route monitoring group.
To add more routes to the route monitoring group, repeat this step. A
route monitoring group can monitor a maximum of 16 routes.
d. (Optional) Run operator and
The relationship between routes in the route monitoring group is set to
AND.
By default, the status of routes in a route monitoring group is of the OR
relationship. That is, the status of the route monitoring group is Up as
long as one route in the group is Up. The status of the monitoring group
is Down only when all routes in the group are Down.
e. (Optional) Run trigger-down-delay
delay-value
A delay after which the RM module instructs the associated service
modules to perform link switchovers is configured.
By default, the delay is 0s.
f. (Optional) Run trigger-up-delay
delay-value
A delay after which the RM module instructs the associated service
modules to perform link switchbacks is configured.
By default, the delay is 5s.
g. Run monitor enable
The route monitoring group is enabled.
2. Configure association between IPv4 static routes and the route monitoring
group.
a. Run system-view
The system view is displayed.
b. Run ip route-static
ip-address {
mask |
mask-length } {
nexthop-address |
interface-type interface-number [
nexthop-address ] | vpn-instance
vpn-
instance-name nexthop-address } [ preference
preference | tag
tag ]
track route-monitor-group
route-monitor-group-name [ description
text ]
Association between IPv4 static routes and the route monitoring group is
configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 13 Route Monitoring Group Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1074
NOTE
The destination address of a route monitored by a route monitoring group cannot be
the destination address of an associated static route.
Verifying the Configuration
● Run the display ip route-monitor-group [
group-name ] command to check
information about the route monitoring group.
● Run the display ip route-monitor-group track-route [ vpn-instance
vpn-
instance-name ]
dest-address {
mask |
mask-length } command to check
information about all route monitoring groups to which a route is added.
● Run the display current-configuration | include track route-monitor-group
command to check the configuration of the association between IPv4 static
routes and route monitoring groups.
13.6 Example for Configuring Association Between IPv4
Static Routes and a Route Monitoring Group
Networking Requirements
On a company's network shown in Figure 13-3, SwitchC at the access layer
connects to SwitchB and SwitchD at the aggregation layer through static routes.
SwitchB and SwitchD work in redundancy mode. The customer requirements are
as follows:
● A link failure detection mechanism is deployed for static routes, so that traffic
can be switched from a faulty link to a normal link in a timely manner to
prevent service interruption for a long time.
● In normal situations, service traffic from the access side is forwarded to the IP
network through SwitchB.
● If the link between SwitchB and SwitchA fails, only the link between SwitchD
and the IP network is available. In this case, service traffic from the access
side is switched to SwitchD to prevent traffic loss.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 13 Route Monitoring Group Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1075
Figure 13-3 Configuring association between IPv4 static routes and a route
monitoring group
Device Name Interface IP Address
SwitchA
VLANIF 10 192.168.10.1/24
VLANIF 20 192.168.20.1/24
VLANIF 100 192.168.100.1/24
SwitchB
VLANIF 10 192.168.10.2/24
VLANIF 40 192.168.40.1/24
SwitchC
VLANIF 30 192.168.30.2/24
VLANIF 40 192.168.40.2/24
VLANIF 50 192.168.50.1/24
SwitchD VLANIF 20 192.168.20.2/24
VLANIF 30 192.168.30.1/24
Configuration Roadmap
The configuration roadmap is as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 13 Route Monitoring Group Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1076
1. Create VLANs, add interfaces to the VLANs, and configure IP addresses for
VLANIF interfaces, so that neighboring devices can communicate with each
other.
2. Configure static routes and bind them to a route monitoring group. On
SwitchC, configure static routes, set a low cost for the route corresponding to
the active link, and bind the static routes to a route monitoring group. In this
way, the links can work in active/standby mode, and IPv4 static routes are
associated with the route monitoring group.
Procedure
1. Configure VLANs to which interfaces belong.
# Configure SwitchC. The configurations of other devices are similar to those
of SwitchC.
<HUAWEI> system-view
[HUAWEI] sysname SwitchC
[SwitchC] vlan batch 30 40 50
[SwitchC] interface gigabitethernet 0/0/1
[SwitchC-gigabitethernet0/0/1] port link-type trunk
[SwitchC-gigabitethernet0/0/1] port trunk allow-pass vlan 30
[SwitchC-gigabitethernet0/0/1] quit
[SwitchC] interface gigabitethernet 0/0/2
[SwitchC-gigabitethernet0/0/2] port link-type trunk
[SwitchC-gigabitethernet0/0/2] port trunk allow-pass vlan 40
[SwitchC-gigabitethernet0/0/2] quit
[SwitchC] interface gigabitethernet 0/0/3
[SwitchC-gigabitethernet0/0/3] port link-type trunk
[SwitchC-gigabitethernet0/0/3] port trunk allow-pass vlan 50
[SwitchC-gigabitethernet0/0/3] quit
2. Configure an IP address for each VLANIF interface.
# Configure SwitchC. The configurations of other devices are similar to those
of SwitchC.
[SwitchC] interface vlanif 30
[SwitchC-Vlanif10] ip address 192.168.30.2 24
[SwitchC-Vlanif10] quit
[SwitchC] interface vlanif 40
[SwitchC-Vlanif40] ip address 192.168.40.2 24
[SwitchC-Vlanif40] quit
[SwitchC] interface vlanif 50
[SwitchC-Vlanif50] ip address 192.168.50.1 24
[SwitchC-Vlanif50] quit
3. Configure static routes and bind them to a route monitoring group.
# On SwitchC, create the route monitoring group uplink.
[SwitchC] ip route-monitor-group uplink
# On SwitchC, add routes to be monitored to the route monitoring group
uplink.
[SwitchC-route-monitor-group-uplink] track ip route 192.168.100.0 255.255.255.0
# On SwitchC, enable the route monitoring group.
[SwitchC-route-monitor-group-uplink] monitor enable
[SwitchC-route-monitor-group-uplink] quit
# On SwitchC, configure static routes to the external network and bind the
static routes to the route monitoring group uplink.
[SwitchC] ip route-static 0.0.0.0 0.0.0.0 192.168.40.1 preference 50 track route-monitor-group
uplink
[SwitchC] ip route-static 0.0.0.0 0.0.0.0 192.168.30.1
# On SwitchB, configure a static route to Client1.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 13 Route Monitoring Group Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1077
<HUAWEI> system-view
[HUAWEI] sysname SwitchB
[SwitchB] ip route-static 192.168.50.0 255.255.255.0 192.168.40.2
# On SwitchD, configure a static route to Client1.
<HUAWEI> system-view
[HUAWEI] sysname SwitchD
[SwitchD] ip route-static 192.168.50.0 255.255.255.0 192.168.30.2
4. Verify the configuration.
# Check information about the route monitoring group uplink on SwitchC.
The command output shows that the route monitoring group has been
enabled and the route to 192.168.100.0/24 is an active route.
[SwitchC] display ip route-monitor-group uplink
route monitor group uplink
State : Enabled
-------------------------------------------------------
route monitor group tracking route number : 1
-------------------------------------------------------
VPN name : Public
Destination : 192.168.100.0
Mask : 255.255.255.0
State : Active
# Check information about static routes on SwitchC to determine the active
and standby links.
[SwitchC] display ip routing-table protocol static
Route Flags: R - relay, D - download to fib, T - to vpn-
instance
------------------------------------------------------------------------------
Public routing table : Static
Destinations : 1 Routes : 2 Configured Routes : 6
Static routing table status : <Active>
Destinations : 1 Routes : 1
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 Static 50 0 D 192.168.40.1 Vlanif40
Static routing table status : <Inactive>
Destinations : 1 Routes : 1
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 Static 60 0 192.168.30.1 Vlanif30
# Disable gigabitethernet0/0/1 on SwitchB to simulate a link failure.
[SwitchB] interface gigabitethernet 0/0/1
[SwitchB-gigabitethernet0/0/1] shutdown
[SwitchB-gigabitethernet0/0/1] quit
# Check information about the route monitoring group uplink on SwitchC.
The command output shows that the route status corresponding to the faulty
link is Inactive.
[SwitchC] display ip route-monitor-group uplink
route monitor group uplink
State : Enabled
-------------------------------------------------------
route monitor group tracking route number : 1
-------------------------------------------------------
VPN name : Public
Destination : 192.168.100.0
Mask : 255.255.255.0
State : Inactive
# Check information about static routes on SwitchC. The command output
shows that static routes on SwitchC have been bound to a route monitoring
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 13 Route Monitoring Group Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1078
group. If the route monitoring group detects a link failure, the RM module
immediately notifies the access device that the corresponding route is
unavailable.
[SwitchC] display ip routing-table protocol static
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Public routing table : Static
Destinations : 1 Routes : 2 Configured Routes : 6
Static routing table status : <Active>
Destinations : 1 Routes : 1
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 Static 60 0 D 192.168.30.1 Vlanif40
Static routing table status : <Inactive>
Destinations : 1 Routes : 1
Destination/Mask Proto Pre Cost Flags NextHop Interface
0.0.0.0/0 Static 50 0 192.168.40.1 Vlanif30
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20 100
#
interface Vlanif10
ip address 192.168.100.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.20.1 255.255.255.0
#
interface Vlanif100
ip address 192.168.100.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 100
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 40
#
interface Vlanif10
ip address 192.168.10.2 255.255.255.0
#
interface Vlanif40
ip address 192.168.40.1 255.255.255.0
#
interface GigabitEthernet0/0/1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 13 Route Monitoring Group Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1079
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
ip route-static 192.168.50.0 255.255.255.0 192.168.40.2
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 30 40 50
#
interface Vlanif30
ip address 192.168.30.2 255.255.255.0
#
interface Vlanif40
ip address 192.168.40.2 255.255.255.0
#
interface Vlanif50
ip address 192.168.50.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 50
#
ip route-monitor-group uplink
track ip route 192.168.100.0 255.255.255.0
monitor enable
#
ip route-static 0.0.0.0 0.0.0.0 192.168.40.1 preference 50 track route-monitor-group uplink
ip route-static 0.0.0.0 0.0.0.0 192.168.30.1
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 20 30
#
interface Vlanif20
ip address 192.168.20.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.30.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
ip route-static 192.168.50.0 255.255.255.0 192.168.30.2
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 13 Route Monitoring Group Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 1080