8.15 Configuring the
Overload Bit for an IS-
IS Device
8.4 Licensing Requirements and Limitations for IPv6 IS-
IS
Involved Network Elements
Other network elements are required to support IPv6 IS-IS.
Licensing Requirements
IPv6 IS-IS is a basic feature of a switch and is not under license control.
Feature Support in V200R024C00
Only the following switch models support IPv6 IS-IS:
S5720I-SI, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S, S5731S-H,
S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S, and S6730S-
S
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 629
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
Feature Limitations
None.
8.5 Default Settings for IPv6 IS-IS
Table 8-2 describes the default settings for IPv6 IS-IS.
Table 8-2 Default settings for IPv6 IS-IS
Parameter Default Setting
IS-IS Disabled
DIS priority 64
Device level Level-1-2
Interval for sending Hello packets 10s
Minimum interval for sending LSPs 50 ms
Maximum number of LSPs to be sent 10
Interval for updating LSPs 900s
Maximum lifetime of LSPs 1200s
Bandwidth reference value 100 Mbit/s
8.6 Configuring Basic IPv6 IS-IS Functions
Pre-configuration Tasks
Before configuring basic IPv6 IS-IS functions, complete the following tasks:
● Enable the IPv6 forwarding capability on the device.
● Configure IPv6 addresses for interfaces to ensure that neighboring nodes are
reachable at the network layer.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 630
Configuration Procedure
1. Create an IS-IS process.
2. Configure a network entity title (NET).
3. Configure a device level.
4. Establish an IS-IS neighbor relationship.
8.6.1 Creating an IS-IS Process
Context
Creating an IS-IS process is the prerequisite for performing the IS-IS configuration.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
An IS-IS process is created, and the IS-IS process view is displayed.
The
process-id parameter specifies the ID of an IS-IS process. The default process
ID is 1.
Step 3 (Optional) Run description
description
A description for the IS-IS process is configured.
Step 4 (Optional) Enable IS-IS to add the POI and hostname TLV to Purge LSPs.
Run purge-originator-identification enable [ always ]
IS-IS is enabled to determine whether to add the POI TLV and hostname TLV to
Purge LSPs based on the authentication configuration.
● If the purge-originator-identification enable command is run and any
authentication is configured, generated Purge LSPs do not carry the POI TLV
or hostname TLV.
● If the purge-originator-identification enable command is run and no
authentication is configured, generated Purge LSPs carry the POI TLV or
hostname TLV.
● If the purge-originator-identification enable always command is run,
generated Purge LSPs carry the POI TLV and hostname TLV, regardless of
whether authentication is configured.
----End
8.6.2 Configuring a NET and Enabling IPv6 IS-IS
Context
NET is the special form of the network service access point (NSAP). After the IS-IS
view is displayed, IS-IS can start only when a NET is configured for an IS-IS
process.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 631
Generally, you only need to configure one NET for an IS-IS process. When an area
needs to be redefined, for example, the area needs to be merged with other areas
or divided into sub-areas, configure multiple NETs to ensure route correctness. A
maximum of three area addresses can be configured for an IS-IS process.
Therefore, a maximum of three NETs can be configured for an IS-IS process. When
configuring multiple NETs, ensure that their system IDs are the same.
IS-IS can run on an IPv6 topology only when IPv6 is enabled on an IS-IS process.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS process view is displayed.
Step 3 Run network-entity
net
A NET is configured.
NOTE
Configuring NETs based on loopback interface addresses is recommended to ensures that a
NET is unique on the network. If NETs are not unique, route flapping will easily occur.
An area ID is used to uniquely identify an area in the same IS-IS domain. All routers in the
same Level-1 area must share the same area ID, while routers in the same Level-2 area can
have different area IDs.
Step 4 Run ipv6 enable
IPv6 is enabled for the IS-IS process.
----End
8.6.3 Configuring a Device Level
Context
Configure a device level according to network planning requirements:
● A Level-1 device can establish neighbor relationships with only Level-1 and
Level-1-2 routers in the same area and maintains only Level-1 LSDBs.
● A Level-2 device can establish neighbor relationship with Level-2 routers in
the same area or different areas and with Level-1-2 routers in different areas
and maintain only Level-2 LSDB.
● A Level-1-2 device can establish neighbor relationships with Level-1 and
Level-2 routers and maintain Level-1 and Level-2 LSDBs.
NOTICE
If the levels of IS-IS devices are changed during network operation, the IS-IS
process will be restarted, and IS-IS neighbor relationships will be disconnected.
Setting the levels of devices when configuring IS-IS is recommended.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 632
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS process view is displayed.
Step 3 Run is-level { level-1 | level-1-2 | level-2 }
A level is configured for the switch.
By default, the level of the switch is Level-1-2.
----End
8.6.4 Establishing an IS-IS Neighbor Relationship
Context
The methods to establish IS-IS neighbor relationships on a broadcast network and
a P2P network are different. Therefore, you need to set different IS-IS attributes
for interfaces of different types:
● On a broadcast network, IS-IS needs to select a designated intermediate
system (DIS). You can set DIS priorities for IS-IS interfaces to enable the
device with the highest DIS priority to be elected as the DIS.
● On a P2P network, IS-IS does not need to select the DIS. Therefore, the DIS
priority does not need to be configured for interfaces. To ensure P2P link
reliability, configure IS-IS to establish neighbor relationships on P2P interfaces
in 3-way mode for unidirectional link fault detection.
Generally, IS-IS checks the IP addresses of received Hello packets. Neighbor
relationships can be established only when the IP address carried in a received
Hello packet and the address of the interface that receives the Hello packet
are on the same network segment. If the IP addresses of the two P2P
interfaces are on different network segments and the isis peer-ip-ignore
command is run on the two interfaces, IS-IS does not check the peer IP
address. The neighbor relationship can be correctly established on the two
P2P interfaces.
Procedure
● Establish an IS-IS neighbor relationship on a broadcast link.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 633
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run ipv6 enable
IPv6 is enabled on the interface.
e. Run isis ipv6 enable [
process-id ]
IS-IS IPv6 is enabled on the interface.
After this command is run, IS-IS establishes neighbor relationships and
floods LSPs through this interface.
NOTE
Loopback interfaces are not used to establish neighbor relationships. If IS-IS is
enabled on a loopback interface, IS-IS advertises the routes of the network
segment where the interface resides through other IS-IS interfaces.
f. Run isis circuit-level [ level-1 | level-1-2 | level-2 ]
A level is configured for the interface.
By default, the level of an interface is Level-1-2.
When two Level-1-2 devices establish an IS-IS neighbor relationship, they
establish both Level-1 and Level-2 neighbor relationships. To allow the
two Level-1-2 devices to establish only Level-1 or Level-2 neighbor
relationship, change the level of interfaces.
NOTE
Changing the level of an IS-IS interface is valid only when the level of the IS-IS
device is Level-1-2. If the level of the device is not Level-1-2, the level of the
device determines the level of the established neighbor relationship.
g. (Optional) Run isis dis-priority
priority [ level-1 | level-2 ]
A DIS priority is set for the interface. A larger value indicates a higher
priority.
By default, the DIS priority of Level-1 and Level-2 broadcast interfaces is
64.
h. (Optional) Run isis silent [ advertise-zero-cost ]
The interface is suppressed.
By default, an IS-IS interface is not suppressed.
When an IS-IS interface is suppressed, the interface no longer sends or
receives IS-IS packets. The routes of the network segment where the
interface resides, however, can still be advertised to other IS-IS devices
within the same AS.
● Establish an IS-IS neighbor relationship on a P2P link.
a. Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 634
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run ipv6 enable
IPv6 is enabled on the interface.
e. Run isis ipv6 enable [
process-id ]
IS-IS IPv6 is enabled on the interface.
f. Run isis circuit-level [ level-1 | level-1-2 | level-2 ]
A level is configured for the interface.
By default, the level of an interface is Level-1-2.
g. Run isis circuit-type p2p [ strict-snpa-check ]
The network type of the interface is set to P2P.
By default, the network type of an interface is determined by the physical
type of the interface.
When the network type of an IS-IS interface changes, the interface
configuration changes accordingly:
▪ After a broadcast interface is simulated as a P2P interface using the
isis circuit-type p2p [ strict-snpa-check ] command, the interval for
sending Hello packets, number of Hello packets that IS-IS does not
receive from a neighbor before the neighbor is declared Down,
interval for retransmitting LSPs on a P2P link, and various IS-IS
authentication modes are restored to the default settings; Other
configurations such as the DIS priority, DIS name, and interval for
sending CSNPs on a broadcast network become invalid.
▪ After the undo isis circuit-type command is run to restore the
default network type of an IS-IS interface, the interval for sending
Hello packets, number of Hello packets that IS-IS does not receive
from a neighbor before the neighbor is declared Down, interval for
retransmitting LSPs on a P2P link, various IS-IS authentication
modes, DIS priority, and interval for sending CSNPs on a broadcast
network are restored to the default settings.
h. Run isis ppp-negotiation { 2-way | 3-way [ only ] }
A negotiation mode is specified for the interface.
By default, the negotiation mode is 3-way.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 635
i. Run isis peer-ip-ignore
IS-IS is configured not to check the IP addresses of received Hello packets.
By default, IS-IS checks the IP addresses of received Hello packets.
j. Run isis ppp-osicp-check
OSICP negotiation status check is configured on the interface.
By default, the OSICP negotiation status of a PPP interface does not
affect the status of an IS-IS interface.
NOTE
This command applies only to PPP interfaces and is invalid for other P2P
interfaces.
After this command is run, the OSICP negotiation status of a PPP interface
affects the status of an IS-IS interface. When PPP detects that the OSI network
fails, the link status of the IS-IS interface goes Down, and the routes of the
network segment where the interface resides are not advertised through LSPs.
----End
8.6.5 Verifying the Basic IPv6 IS-IS Function Configuration
Procedure
● Run the display isis peer [ verbose ] [
process-id | vpn-instance
vpn-
instance-name ] command to check information about IS-IS neighbors.
● Run the display isis interface [ verbose ] [
process-id | vpn-instance
vpn-
instance-name ] command to check information about IS-IS interfaces.
● Run the display isis route [
process-id | vpn-instance
vpn-instance-name ]
ipv6 [ verbose | [ level-1 | level-2 ] |
ipv6-address [
prefix-length ] ] *
command to check information about IS-IS routes.
----End
8.7 Improving IPv6 IS-IS Network Security
Pre-configuration Tasks
Before improving IS-IS network security, configure basic IPv6 IS-IS functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the IPv6 IS-IS Network Security Optimization Configuration) in any sequence.
8.7.1 Configuring Interface Authentication
Context
Generally, the IS-IS packets to be sent are not encapsulated with authentication
information, and the received packets are not authenticated. If a user sends
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 636
malicious packets to attack a network, information on the entire network may be
stolen. Therefore, you can configure IS-IS authentication to improve network
security.
After the IS-IS interface authentication is configured, authentication information
can be encapsulated into the Hello packet to confirm the validity and correctness
of neighbor relationships.
NOTICE
If plain is selected during the configuration of the authentication mode for the IS-
IS interface, the password is saved in the configuration file in plain text. This
brings security risks. It is recommended that you select cipher to save the
password in cipher text.
Simple authentication and MD5 authentication have potential security risks.
HMAC-SHA256 or Keychain authentication mode is recommended.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run any of the following commands to configure an authentication mode for the
IS-IS interface as required:
● Run isis authentication-mode simple { plain
plain-text | [ cipher ]
plain-
cipher-text } [ level-1 | level-2 ] [ ip | osi ] [ send-only ]
Simple authentication is configured for the IS-IS interface.
● Run isis authentication-mode md5 { plain
plain-text | [ cipher ]
plain-
cipher-text } [ level-1 | level-2 ] [ ip | osi ] [ send-only ]
MD5 authentication is configured for the IS-IS interface.
● Run isis authentication-mode hmac-sha256 key-id
key-id { plain
plain-text |
[ cipher ]
plain-cipher-text } [ level-1 | level-2 ] [ send-only ]
HMAC-SHA256 authentication is configured for the IS-IS interface.
● Run isis authentication-mode keychain
keychain-name [ level-1 | level-2 ]
[ send-only ]
The Keychain authentication is configured for the IS-IS interface.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 637
By default, an IS-IS interface does not authenticate received Hello packets and no
authentication password is configured on the interface.
NOTE
Use the send-only parameter according to network requirements:
● If the send-only parameter is specified, the device only encapsulates the Hello packets
to be sent with authentication information rather than checks whether the received
Hello packets pass the authentication. When the Hello packets do not need to be
authenticated on the local device and pass the authentication on the remote device,
the two devices can establish the neighbor relationship.
● If the send-only parameter is not specified, ensure that passwords of all interfaces
with the same level on the same network are the same.
Parameters level-1 and level-2 apply only to the VLANIF interfaces on which IS-IS is
enabled using the isis ipv6 enable command.
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support keychain
keychain-name.
----End
8.7.2 Configuring Area or Domain Authentication
Context
Generally, the IS-IS packets to be sent are not encapsulated with authentication
information, and the received packets are not authenticated. If a user sends
malicious packets to attack a network, information on the entire network may be
stolen. Therefore, to improve the network security, you can configure IS-IS
authentication.
The area authentication password is encapsulated into Level-1 IS-IS packets. Only
the packets that pass the area authentication can be accepted. Therefore, you
must configure IS-IS area authentication on all the IS-IS devices in the specified
Level-1 area to authenticate the Level-1 area.
The domain authentication password is encapsulated into Level-2 IS-IS packets.
Only the packets that pass the domain authentication can be accepted. Therefore,
you must configure IS-IS domain authentication on all the IS-IS devices in the
Level-2 area to authenticate Level-2 area.
NOTICE
If plain is selected during the configuration of an area or domain authentication
mode, the password is saved in the configuration file in plain text. This brings
security risks. It is recommended that you select cipher to save the password in
cipher text.
Simple authentication and MD5 authentication have potential security risks.
HMAC-SHA256 authentication mode is recommended.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 638
NOTE
When configuring IS-IS authentication, the area or domain authentication modes and
passwords of the routers in the same area must be consistent so that IS-IS packets can be
flooded normally.
Whether IS-IS packets can pass area or domain authentication does not affect the
establishment of Level-1 or Level-2 neighbor relationships.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS process view is displayed.
Step 3 Perform the following operations in any sequence as required.
● Run area-authentication-mode { { simple | md5 } { plain
plain-text |
[ cipher ]
plain-cipher-text } [ ip | osi ] | keychain
keychain-name | hmac-
sha256 key-id
key-id } [ snp-packet { authentication-avoid | send-only } |
all-send-only ]
The area authentication mode is configured.
By default, the system neither encapsulates generated Level-1 packets with
authentication information nor authenticates received Level-1 packets.
● Run domain-authentication-mode { { simple | md5 } { plain
plain-text |
[ cipher ]
plain-cipher-text } [ ip | osi ] | keychain
keychain-name | hmac-
sha256 key-id
key-id } [ snp-packet { authentication-avoid | send-only } |
all-send-only ]
The domain authentication mode is configured.
By default, the system neither encapsulates generated Level-2 packets with
authentication information nor authenticates received Level-2 packets.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 639
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support keychain
keychain-name.
The authentication involves the following situations:
● The device encapsulates the authentication mode into LSPs and SNPs to be sent and
checks whether the received packets pass authentication. Then, the device discards the
packets that do not pass the authentication. In this case, the parameter snp-packet or
all-send-only is not specified.
● The device encapsulates authentication information into LSPs to be sent and checks
whether the received LSPs pass the authentication; the device neither encapsulates the
SNPs to be sent with authentication information nor checks whether the received SNPs
pass the authentication. In this case, the parameter snp-packet authentication-avoid
needs to be specified.
● The device encapsulates the LSPs and SNPs to be sent with authentication information;
the device, however, checks the authentication mode of only the received LSPs rather
than the received SNPs. In this case, the parameter snp-packet send-only needs to be
specified.
● The device encapsulates the LSPs and SNPs to be sent with authentication information,
but does not check whether the received LSPs or SNPs pass the authentication. In this
case, the parameter all-send-only needs to be specified.
----End
8.7.3 Configuring the Optional Checksum
Context
When a network is running, Intermediate System to Intermediate System (IS-IS)
routers may be attacked or IS-IS packets may be modified. As a result, important
network information may be intercepted, causing serious loss to the network. The
optional checksum encapsulates optional checksum TLVs into the Complete
Sequence Numbers Protocol Data Units (CSNPs), Partial Sequence Number
Protocol Data Units (PSNPs), and Hello packets sent by IS-IS routers. When the
peer device receives the encapsulated packets, it checks whether TLVs carried in
the packets are correct. If TLVs are not correct, the peer device discards the
packets for network security.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis
An IS-IS process is created and the IS-IS view is displayed.
Step 3 Run optional-checksum enable
IS-IS optional checksum is enabled.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 640
NOTE
If MD5 authentication or Keychain authentication with valid MD5 authentication is
configured on an IS-IS interface or area, IS-IS routers send Hello packets and SNP packets
carrying no checksum TLVs and verify the checksum of the received packets.
----End
8.7.4 Verifying the IPv6 IS-IS Network Security Optimization
Configuration
Procedure
● Run the display isis lsdb verbose command to check the detailed information
in the IS-IS LSDB.
----End
8.8 Controlling IPv6 IS-IS Route Selection
Pre-configuration Tasks
Before configuring IS-IS route selection, configure basic IPv6 IS-IS functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the IPv6 IS-IS Route Selection Control Configuration) in any sequence.
8.8.1 Configuring a Preference Value for IPv6 IS-IS
Context
If multiple routes to the same destination are discovered by different routing
protocols running on the same device, the route discovered by the protocol with
the highest preference is selected.
To prefer an IPv6 route discovered by IS-IS, configure a higher preference for IS-IS
IPv6 route. In addition, a routing policy can be configured to increase the
preferences of specified IS-IS IPv6 routes, without affecting route selection.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run ipv6 preference { route-policy
route-policy-name |
preference }*
An IS-IS IPv6 route preference value is configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 641
The default IS-IS IPv6 route preference value is 15. A smaller
preference value
indicates a higher preference.
----End
8.8.2 Configuring a Cost for IS-IS Interfaces on an IPv6
Network
Context
The costs of IS-IS interfaces can be determined in the following modes (in
descending order of priority):
● Interface cost: configured for a specified interface.
● Global cost: configured for all interfaces.
● Automatically calculated cost: automatically calculated based on the interface
bandwidth.
If no cost is configured for an IS-IS interface, the IS-IS interface uses the default
cost 10 and cost style narrow.
NOTICE
If you need to change the cost style of IS-IS devices, change it during the
configuration of basic IS-IS functions is recommended. If the cost style of IS-IS
devices is changed during network operation, the IS-IS process will be restarted,
and the neighbor relationship will be re-established.
Procedure
Step 1 Configure an IS-IS cost style.
1. Run system-view
The system view is displayed.
2. Run isis [
process-id ]
The IS-IS view is displayed.
3. Run cost-style { narrow | wide | wide-compatible | { narrow-compatible |
compatible } [ relax-spf-limit ] }
An IS-IS cost style is configured.
By default, the cost style of routes received and sent by an IS-IS device is
narrow.
The cost range of an interface and a route received by the interface vary with the
cost type.
● If the cost style is narrow, the cost of an interface ranges from 1 to 63. The
maximum cost of a route received by the interface is 1023.
● If the cost style is narrow-compatible or compatible, the cost of an interface
ranges from 1 to 63. The cost of a received route is related to relax-spf-limit.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 642
● If the cost style is wide-compatible or wide, the cost of the interface ranges
from 1 to 16777215. When the cost is 16777215, the neighbor TLV generated
on the link cannot be used for route calculation but for the transmission of TE
information. The maximum cost of a received route is 0xFFFFFFFF.
Step 2 Configure a cost for an IS-IS interface on an IPv6 network.
Perform any of the following operations as required:
Configure a cost for a specified IS-IS interface on an IPv6 network.
1. Run system-view
The system view is displayed.
2. Run interface
interface-type interface-number
The interface view is displayed.
3. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
4. Run isis ipv6 cost {
cost | maximum } [ level-1 | level-2 ]
A cost is configured for the IS-IS interface on an IPv6 network.
By default, the cost of an IS-IS interface on an IPv6 network is 10.
NOTE
You can configure the parameter maximum only when the IS-IS cost style is wide or wide-
compatible.
Configure a global IS-IS interface cost on an IPv6 network.
1. Run system-view
The system view is displayed.
2. Run isis [
process-id ]
The IS-IS view is displayed.
3. Run ipv6 circuit-cost {
cost | maximum } [ level-1 | level-2 ]
A global IS-IS interface cost on an IPv6 network is configured.
By default, no global cost is configured.
Enable IS-IS interfaces to automatically calculate their costs on an IPv6
network.
1. Run system-view
The system view is displayed.
2. Run isis [
process-id ]
The IS-IS view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 643
3. Run ipv6 bandwidth-reference
value
A bandwidth reference value is configured. By default, the value is 100 Mbit/s.
4. Run ipv6 auto-cost enable [ compatible ]
IS-IS interfaces are configured to automatically calculate their costs on an
IPv6 network.
The bandwidth reference value set using the ipv6 bandwidth-reference command
takes effect only when the cost style is wide or wide-compatible. In this case, the
interface cost is calculated using the following formula:
Cost of each interface = (Bandwidth-reference/Interface bandwidth) × 10
If the cost-style is narrow, narrow-compatible, or compatible, the cost of each
interface is based on costs listed in Table 8-3.
Table 8-3 Mapping between IS-IS interface costs and interface bandwidth
Cost Bandwidth Range
60 Interface bandwidth ≤ 10 Mbit/s
50 10 Mbit/s < Interface bandwidth ≤ 100
Mbit/s
40 100 Mbit/s < Interface bandwidth ≤ 155
Mbit/s
30 155 Mbit/s < Interface bandwidth ≤ 622
Mbit/s
20 622 Mbit/s < Interface bandwidth ≤ 2.5
Gbit/s
10 2.5 Gbit/s < Interface bandwidth
----End
8.8.3 Configuring Equal-Cost IPv6 IS-IS Routes
Context
If there are redundant IS-IS links, multiple routes may have an equal cost.
Configure load balancing among equal-cost IS-IS routes so that traffic will be
evenly balanced among these links. This mechanism increases the link bandwidth
usage and prevents network congestion caused by link overload. However, this
mechanism may make traffic management more difficult because traffic will be
randomly forwarded.
Procedure
● Configure load balancing among equal-cost IS-IS routes.
a. Run system-view
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 644
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run ipv6 maximum load-balancing
number
The maximum number of equal-cost IPv6 IS-IS routes for load-balancing
is set.
By default, load balancing is supported and a maximum of 8 equal-cost
routes can participate in load balancing.
NOTE
When the number of equal-cost routes is larger than the value specified in the
ipv6 maximum load-balancing command, valid routes are selected for load
balancing based on the following criteria:
1. Route preference: Routes with higher preferences are selected for load
balancing.
2. Next hop system ID: If routes have the same preference, routes with smaller
system IDs are selected for load balancing.
3. Interface index: If routes have the same preference and system ID, routes with
lower interface index values are selected for load balancing.
----End
8.8.4 Configuring IS-IS IPv6 Route Leaking
Context
If multiple Level-1-2 devices in a Level-1 area are connected to devices in the
Level-2 area, a Level-1 LSP sent by each Level-1-2 device carries an ATT flag bit of
1. This Level-1 area will have multiple routes to the Level-2 area and to other
Level-1 areas.
By default, routes in a Level-1 area can be leaked into the Level-2 area so that
Level-1-2 and Level-2 devices can learn about the topology of the entire network.
Devices in a Level-1 area are unaware of the entire network topology because
they only maintain LSDBs in the local Level-1 area. Therefore, a device in a Level-1
area can forward traffic to a Level-2 device only through the nearest Level-1-2
device. The route used may not be the optimal route to the destination.
To enable a device in a Level-1 area to select the optimal route, configure IS-IS
IPv6 route leaking so that specified routes in the Level-2 area can be leaked into
the local Level-1 area.
Routes of services deployed only in the local Level-1 area do not need to be
leaked into the Level-2 area. A policy can be configured to leak only desired routes
into the Level-2 area.
Procedure
● Specify IS-IS IPv6 routes in the Level-2 area and other Level-1 areas that can
be leaked into the local Level-1 area.
a. Run system-view
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 645
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run ipv6 import-route isis level-2 into level-1 [ tag
tag | filter-policy
{
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-prefix-name |
route-policy
route-policy-name } | direct { allow-filter-policy | allow-
up-down-bit } * ] *
IS-IS IPv6 routes in the Level-2 area and other Level-1 areas that meet
the specified conditions are leaked into the local Level-1 area.
By default, IS-IS IPv6 routes in the Level-2 area are not leaked into
Level-1 areas.
NOTE
The command in Step 3 is run on the Level-1-2 device that is connected to an
external area.
● Configure IS-IS IPv6 routes in Level-1 areas to leak into the Level-2 area.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run ipv6 import-route isis level-1 into level-2 [ tag
tag | filter-policy
{
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-prefix-name |
route-policy
route-policy-name }| direct allow-filter-policy ] *
IS-IS IPv6 routes that meet the specified conditions in Level-1 areas are
leaked into the Level-2 area.
By default, all Level-1 IS-IS IPv6 routing information, excluding
information about default routes, is leaked to Level-2 areas.
NOTE
The command in Step 3 is run on the Level-1-2 device that is connected to an
external area.
----End
8.8.5 Controlling Whether a Level-1 Device Generates an IPv6
Default Route
Context
As defined in the IS-IS protocol, if a Level-1-2 device reaches more areas through a
Level-2 area than through a Level-1 area based on the link state database (LSDB),
the Level-1-2 device sets the ATT bit to 1 in the LSPs and sends the LSPs with the
ATT bit 1 to the Level-1 device. Upon receipt, the Level-1 device generates a
default route destined for the Level-1-2 device.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 646
The preceding rules are used by default. You can set the ATT bit as required on a
live network.
Perform the following steps:
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run the following command as required:
● To set the ATT bit in the LSPs sent by the Level-1-2 device, run the attached-
bit advertise { always | never } command.
– If the always parameter is specified, the ATT bit is set to 1. After
receiving the LSPs carrying the ATT bit 1, the Level-1 device generates a
default route.
– If the never parameter is specified, the ATT bit is set to 0. After receiving
the LSPs carrying the ATT bit 0, the Level-1 device does not generate a
default route, which reduces the size of a routing table.
● To disable the Level-1 device from generating default routes even though it
receives the LSPs carrying the ATT bit 1, run the attached-bit avoid-learning
command.
----End
8.8.6 Verifying the IPv6 IS-IS Route Selection Control
Configuration
Procedure
● Run the display isis route [
process-id | vpn-instance
vpn-instance-name ]
ipv6 [ verbose | [ level-1 | level-2 ] |
ipv6-address [
prefix-length ] ] *
command to check IS-IS routing information.
● Run the display isis lsdb [ { level-1 | level-2 } | verbose | { local |
lsp-id | is-
name
symbolic-name } ] * [
process-id | vpn-instance
vpn-instance-name ]
command to check information in the IS-IS LSDB.
----End
8.9 Controlling IPv6 IS-IS Route Exchange
Pre-configuration Tasks
Before controlling IS-IS route exchange, configure basic IPv6 IS-IS functions.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 647
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the IPv6 IS-IS Route Exchange Control Configuration) in any sequence.
8.9.1 Configuring IS-IS to Advertise a Default Route
Context
If IS-IS is configured to advertise a default route on a border device that has
external routes, the device advertises a default route ::/0 in the IS-IS routing
domain. All traffic destined for other routing domains is first forwarded to the
border device.
NOTE
Configuring a static default route can also allow all the traffic to be first forwarded to a
border device, which then forwards the traffic outside an IS-IS routing domain. However,
this method leads to heavy workload in configuration and management when a large
number of devices are deployed on the network.
In addition, advertising default routes using IS-IS is flexible. If multiple border devices are
deployed, a routing policy can be configured to allow only the border device that meets the
specified conditions to advertise a default route, preventing routing blackholes.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run ipv6 default-route-advertise [ always | match default | route-policy
route-
policy-name ] [ cost
cost | tag
tag | [ level-1 | level-1-2 | level-2 ] ] * [ avoid-
learning ]
IS-IS is configured to advertise a default route.
By default, IS-IS does not advertise a default route.
----End
8.9.2 Configuring IS-IS to Import External Routes
Context
After IS-IS is configured to advertise a default route on a border device in an IS-IS
routing domain, all the traffic destined outside the IS-IS routing domain is
forwarded through the border device. This burdens the border device because
other devices in the IS-IS routing domain do not have the routes destined outside
the domain. If multiple border devices are deployed in the IS-IS routing domain,
optimal routes to other routing domains need to be selected.
To ensure optimal routes are selected, all the other devices in the IS-IS routing
domain must learn all or some external routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 648
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Configure IS-IS to import external routes.
● When you need to set a cost for imported routes, run the ipv6 import-route
{ static | direct | unr | { ospfv3 | ripng | isis } [
process-id ] | bgp [ permit-
ibgp ] } [ cost
cost | tag
tag | route-policy
route-policy-name | [ level-1 |
level-2 | level-1-2 ] ] * command.
● When you need to retain the original cost of imported routes, run the ipv6
import-route { direct | unr | { ospfv3 | ripng | isis } [
process-id ] | bgp
[ permit-ibgp ] } inherit-cost [ tag
tag | route-policy
route-policy-name |
[ level-1 | level-2 | level-1-2 ] ] * command. In this case, the source routing
protocol of imported routes cannot be static.
NOTE
IS-IS will advertise all imported external routes to the IS-IS routing domain by default.
----End
8.9.3 Configuring IS-IS to Advertise Specified External Routes
to an IS-IS Routing Domain
Context
When the local IS-IS device advertises imported external routes to other IS-IS
devices, routing policies can be configured to advertise only the external routes
that meet specified conditions if these devices do not require all the imported
external routes.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run ipv6 filter-policy {
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-
prefix-name | route-policy
route-policy-name } export [
protocol [
process-id ] ]
IS-IS is configured to advertise the external IPv6 routes that meet specified
conditions to the IS-IS routing domain.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 649
8.9.4 Adding Specified IS-IS Routes to an IPv6 Routing Table
Context
Only routes in an IPv6 routing table can be used to forward IPv6 packets. An IS-IS
route can take effect only after this IS-IS route has been successfully added to an
IPv6 routing table.
If an IS-IS route does not need to be added to a routing table, specify conditions,
such as IPv6 prefix, and routing policy, to filter the route. IS-IS routes that do not
meet the specified conditions cannot be added to the IPv6 routing table and
cannot be selected to forward IPv6 packets.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run ipv6 filter-policy {
acl6-number | acl6-name
acl6-name | ipv6-prefix
ipv6-
prefix-name | route-policy
route-policy-name } import
Conditions for filtering IS-IS routes are configured.
----End
8.9.5 Verifying the IPv6 IS-IS Route Exchange Control
Configuration
Procedure
● Run the display isis lsdb [ { level-1 | level-2 } | verbose | { local |
lsp-id | is-
name
symbolic-name } ] * [
process-id | vpn-instance
vpn-instance-name ]
command to check IS-IS LSDB information.
● Run the display isis route [
process-id | vpn-instance
vpn-instance-name ]
ipv6 [ verbose | [ level-1 | level-2 ] |
ipv6-address [
prefix-length ] ] *
command to check IS-IS routing information.
● Run the display ipv6 routing-table command to check the IPv6 routing table.
----End
8.10 Configuring IPv6 IS-IS Route Summarization
Pre-configuration Tasks
Before configuring IS-IS route summarization, configures basic IPv6 IS-IS
functions.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 650
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run ipv6 summary
ipv6-address prefix-length [ avoid-feedback |
generate_null0_route | tag
tag | [ level-1 | level-1-2 | level-2 ] ] *
The specified IPv6 IS-IS routes are summarized into one IS-IS route.
NOTE
After route summarization is configured on a device, the local routing table still contains all
specific routes before the summarization. The routing tables on other devices contain only
the summary route, and the summary route is deleted only after all its specific routes are
deleted.
----End
Verifying the Configuration
● Run the display isis route command to check summary routes in the IS-IS
routing table.
● Run the display ipv6 routing-table [ verbose ] command to check summary
routes in the IPv6 routing table.
8.11 Controlling IPv6 IS-IS Route Convergence
Pre-configuration Tasks
Before configuring IS-IS route convergence, configure basic IPv6 IS-IS functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the IPv6 IS-IS Route Convergence Control Configuration) in any sequence.
8.11.1 Configuring Attributes for Hello Packets
Context
IS-IS maintains neighbor relationships by sending and receiving Hello packets. If
the local device does not receive Hello packets from its neighbor within a specified
period, the device considers the neighbor Down.
In IS-IS, you can set the interval for sending Hello packets and the holding
multiplier of neighboring devices to control the holdtime of neighbor relationships
between the local device and neighbors.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 651
● If the interval for sending Hello packets is too short, more system resources
are consumed to send Hello packets, causing a heavy CPU load.
● If the holdtime of neighboring devices is too long, the local device needs to
spend much time detecting the failure of neighbors, slowing down IS-IS route
convergence. If the holdtime of neighboring devices is too short, some Hello
packets may be lost or become incorrect because of network transmission
delay and errors. This will cause neighbor relationships to frequently alternate
between Up and Down and lead to route flapping on the IS-IS network.
NOTE
You are advised to set the same interval for sending Hello packets and same holding
multiplier of neighboring devices on all the devices on the IS-IS network. This method
prevents IS-IS route convergence from being slowed down when some devices detect
link failures at a lower speed than other devices.
Procedure
● Configure an interval for sending Hello packets.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run isis timer hello
hello-interval [ level-1 | level-2 ]
An interval for sending Hello packets is set on an interface.
By default, the interval for sending Hello packets 10 seconds.
NOTE
Parameters level-1 and level-2 are configured only on a broadcast interface.
On a broadcast link, there are Level-1 and Level-2 Hello packets. For different
types of packets, you can set different intervals. If no level is specified, both the
Level-1 timer and Level-2 timer are configured. On a P2P link, there is only one
type of Hello packets. Therefore, neither level-1 nor level-2 is required.
● Set a holding multiplier for neighboring devices.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 652
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run isis timer holding-multiplier
number [ level-1 | level-2 ]
A holding multiplier of neighboring devices is set.
The default holding multiplier is 3. The holdtime of neighbor
relationships is three times the interval for sending Hello packets.
NOTE
Parameters level-1 and level-2 are configured only on a broadcast interface.
----End
8.11.2 Configuring Attributes for LSPs
Context
LSPs are used to exchange link state information. You can configure attributes for
LSPs to control the length and maximum lifetime of LSPs. To accelerate network
convergence, you can enable LSP fast flooding or reduce the minimum interval for
sending LSPs and the interval for updating LSPs to speed up LSP flooding.
However, CPU resources will be consumed too much if the network topology
changes frequently. In this situation, configure the intelligent timer for generating
LSPs. This timer can fast respond to emergencies, speed up network convergence,
and improve CPU resource efficiency because its interval becomes longer when the
network changes frequently.
Configured
Parameters
Function Usage Scenario
Maximum
length of
LSPs
Set a size
for LSPs to
be
generated
and LSPs
to be
received.
When the volume of link status information
increases, the length of LSPs to be generated can
be increased to carry more information in each LSP.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 653
Configured
Parameters
Function Usage Scenario
Maximum
lifetime of
LSPs
Set a
maximum
lifetime
for LSPs to
ensure the
validity of
an LSP
before its
updated
LSP is
received.
When a switch generates the system LSP, it fills in
the maximum lifetime for this LSP. After this LSP is
received by other switches, the lifetime of the LSP
is reduced gradually. If the switch does not receive
any more update LSPs and the lifetime of the LSP is
reduced to 0, the LSP will be deleted from the LSDB
60s later if no more updated LSPs are received.
Refresh
interval of
LSPs
Set a
refresh
interval
for LSPs to
synchroniz
e LSDBs.
On an IS-IS network, LSDB synchronization is
implemented through LSP flooding. During LSP
flooding, a switch sends an LSP to its neighbors
and then the neighbors send the received LSP to
their respective neighbors except the switch that
first sends the LSP. In this manner, the LSP is
flooded among the switches of the same level. LSP
flooding allows each switch of the same level to
have the same LSP information and synchronize its
LSDB with each other.
Minimum
interval at
which LSPs
are sent
Set an
interval
for
sending
an LSP
during LSP
update.
Reducing the minimum interval for sending LSPs
speeds up LSP flooding.
Intelligent
timer used to
generate
LSPs
Control
the
interval
for
generating
LSPs
intelligentl
y to speed
up route
convergen
ce and
reduce
system
load.
On an IS-IS network, if the local routing
information changes, a switch needs to generate a
new LSP to notify this change. If the local routing
information changes frequently, a large number of
new LSPs are generated, which occupies a lot of
system resources and decreases system
performance. To speed up network convergence
and prevent system performance from being
affected, configure an intelligent timer for
generating LSPs. This timer can adjust the delay in
generating LSPs based on the routing information
change frequency.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 654
Configured
Parameters
Function Usage Scenario
LSP fast
flooding
Control
the
number of
LSPs
flooded
each time
on an
interface
to speed
up IS-IS
network
convergen
ce.
When an IS-IS switch receives new LSPs from other
switches, it updates the LSPs in the local LSDB and
periodically floods out the updated LSPs according
to a timer. LSP fast flooding updates the preceding
method. When a device configured with LSP fast
flooding receives one or more new LSPs, it floods
out the LSPs with a number smaller than the
specified number before calculating routes. This
speeds up LSDB synchronization.
Interval at
which LSPs
are
retransmitted
over a P2P
link
Control
the
interval
for
retransmit
ting LSPs
to ensure
LSDB
synchroniz
ation on a
P2P
network.
On a point-to-point network, devices at both ends
of a link synchronize LSDBs with each other by
flooding LSPs. The device at one end of the link
sends an LSP. If the device at the other end receives
this LSP, it replies with a PSNP. If the device that
has sent an LSP does not receive a PSNP from the
other end in a period of time, the device will
retransmit the LSP.
Procedure
● Set a maximum length for LSPs.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Set a maximum length for LSPs.
▪ Run lsp-length originate
max-size
The maximum length is set for each generated LSP.
▪ Run lsp-length receive
max-size
The maximum length is set for each received LSP.
By default, the IS-IS system generates and receives 1497-byte LSPs.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 655
NOTE
Ensure that the value of
max-size for LSPs to be generated must be smaller than
or equal to the value of
max-size for LSPs to be received.
The value of
max-size set through the lsp-length command must meet the
following requirements; otherwise, the MTU status on the interface is considered
Down.
● The MTU of an Ethernet interface must be greater than or equal to the sum
of the value of
max-size and 3.
● The MTU of a P2P interface must be greater than or equal to the value of
max-size.
● Set a maximum lifetime for LSPs.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run timer lsp-max-age
age-time
A maximum lifetime is set for LSPs.
By default, the maximum lifetime of LSPs is 1200 seconds.
● Set a refresh interval for LSPs.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run timer lsp-refresh
refresh-time
A refresh interval is set for LSPs.
By default, the LSP refresh interval is 900s.
NOTE
Ensure that the LSP refresh interval is more than 300s shorter than the maximum
LSP lifetime. This allows new LSPs to reach all devices in an area before existing
LSPs expire.
The larger a network, the greater the deviation between the LSP refresh interval
and the maximum LSP lifetime.
● Set a minimum interval at which LSPs are sent.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 656
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. Run isis timer lsp-throttle
throttle-interval [ count
count ]
The minimum interval for sending LSPs on an IS-IS interface and the
maximum number of LSPs sent within the interval are set.
By default, the minimum interval for sending LSPs is 50 ms, and the
maximum number of LSPs sent each time is 10.
● Configure the intelligent timer used to generate LSPs.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run timer lsp-generation
max-interval [
init-interval [
incr-interval ] ]
[ level-1 | level-2 ]
The intelligent timer used to generate LSPs is set.
If no level is configured, both Level-1 and Level-2 are configured.
The initial delay for generating the same LSPs (or LSP fragments) is
init-
interval. The delay for generating the same LSPs (or LSP fragments) for
the second time is
incr-interval. When the routes change each time, the
delay for generating the same LSPs (or LSP fragments) is twice as the
previous value until the delay is up to
max-interval. After the delay
reaches
max-interval for three times or the IS-IS process is restarted, the
interval is reduced to
init-interval.
When
incr-interval is not used and generating the same LSPs (or LSP
fragments) for the first time,
init-interval is used as the initial delay. Then,
the delay for generating the same LSPs (or LSP fragments) is
max-
interval. After the delay reaches
max-interval for three times or the IS-IS
process is reset, the interval is reduced to
init-interval.
When only
max-interval is used, the intelligent timer changes into a
normal one-short timer.
● Enable LSP fast flooding.
a. Run system-view
The system view is displayed.
b. Run isis [
process-id ]
The IS-IS view is displayed.
c. Run flash-flood [
lsp-count | max-timer-interval
interval | [ level-1 |
level-2 ] ] *
LSP fast flooding is enabled.
The
lsp-count parameter specifies the number of LSPs flooded each time,
which is applicable to all interfaces. If the number of LSPs to be sent is
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 657
greater than the value of
lsp-count,
lsp-count takes effect. If the number
of LSPs to be sent is smaller than the value of
lsp-count, LSPs of the
actual number are sent. If a timer is configured and the configured timer
does not expire before the route calculation, the LSPs are flooded
immediately when being received; otherwise, the LSPs are sent when the
timer expires.
When LSP fast flooding is enabled, Level-1 LSPs and Level-2 LSPs are fast
flooded by default if no level is specified.
● Set an interval at which LSPs are retransmitted over a P2P link.
a. Run system-view
The system view is displayed.
b. Run interface
interface-type interface-number
The interface view is displayed.
c. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
d. (Optional) Run isis circuit-type p2p [ strict-snpa-check ]
A broadcast interface is simulated as a P2P interface.
NOTE
If the interface type is P2P, the step is not required.
e. Run isis timer lsp-retransmit
retransmit-interval
An interval at which LSPs are retransmitted over a P2P link is set.
By default, the interval for retransmitting LSPs over a P2P link is 5
seconds.
----End
8.11.3 Configuring Attributes for CSNPs
Context
Complete sequence number PDUs (CSNPs) contain the summary of all the LSPs in
an LSDB to ensure LSDB synchronization between neighbors. CSNPs are processed
differently on broadcast and P2P links.
● On a broadcast link, CSNPs are periodically sent by a DIS device. If a device
detects that its LSDB is not synchronized with its neighbors', the device will
send PSNPs to apply for missing LSPs.
● On a P2P link, CSNPs are sent only during initial establishment of neighboring
relationships.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 658
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run isis timer csnp
csnp-interval [ level-1 | level-2 ]
The interval at which CSNPs are sent is set on the interface.
By default, the interval is 10 seconds.
NOTE
Configure Level-1 and Level-2 only when a broadcast interface is specified.
----End
8.11.4 Setting an SPF Calculation Interval
Context
A network change always triggers IS-IS to perform SPF calculation. Frequent SPF
calculation will consume excessive CPU resources, affecting services.
To solve this problem, configure an intelligent timer to control the SPF calculation
interval. For example, to speed up IS-IS route convergence, set the interval for SPF
calculation to a small value and set the interval to a large value after the IS-IS
network becomes stable.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run timer spf
max-interval [
init-interval [
incr-interval ] ]
An SPF intelligent timer is configured.
By default, no SPF intelligent timer is configured and the maximum delay in SPF
calculation is 5 seconds.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 659
The intelligent timer changes as follows:
● The delay in the first SPF calculation is determined by
init-interval; the delay
in the second SPF calculation is determined by
incr-interval. From the third
time on, the delay in SPF calculation increases twice every time until the delay
reaches the value specified by
max-interval. After the delay remains at the
value specified by
max-interval for three times or the IS-IS process is
restarted, the delay decreases to the value specified by
init-interval.
● If
incr-interval is not specified, the delay in SPF calculation for the first time is
determined by
init-interval. From the second time on, the delay in SPF
calculation is determined by
max-interval. After the delay remains at the
value specified by
max-interval for three times or the IS-IS process is
restarted, the delay decreases to the value specified by
init-interval.
● When only
max-interval is specified, the intelligent timer functions as an
ordinary one-time triggering timer.
Step 4 (Optional) Run spf-slice-size
duration-time
The maximum duration for SPF calculation is configured.
By default, IS-IS route calculation lasts for a maximum of 2 ms at a time.
----End
8.11.5 Configuring Convergence Priorities for IS-IS Routes
Context
You can configure the highest convergence priority for specific IS-IS routes so that
these IS-IS routes will be converged first when a network topology changes.
The application rules of the convergence priorities for IS-IS routes are as follows:
● Existing IS-IS routes are converged based on the priorities configured in the
ipv6 prefix-priority command.
● New IS-IS routes are converged based on the priorities configured in the ipv6
prefix-priority command.
● If an IS-IS route conforms to the matching rules of multiple convergence
priorities, the highest convergence priority is used.
● The convergence priority of a Level-1 IS-IS route is higher than that of a
Level-2 IS-IS route.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run ipv6 prefix-priority [ level-1 | level-2 ] { critical | high | medium } { ipv6-
prefix
prefix-name | tag
tag-value }
Convergence priorities are set for IS-IS routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 660
By default, the convergence priority of 32-bit host routes is medium, and the
convergence priority of the other IS-IS routes is low.
NOTE
The ipv6 prefix-priority command is only applicable to the public network.
After the ipv6 prefix-priority command is run, the convergence priority of 32-bit host
routes is low, and the convergence priorities of the other routes are determined as specified
in the ipv6 prefix-priority command.
Step 4 (Optional) Run quit
The system view is displayed.
----End
8.11.6 Verifying the IPv6 IS-IS Route Convergence Control
Configuration
Procedure
● Run the display isis interface [ verbose ] [
process-id | vpn-instance
vpn-
instance-name ] command to check IS-IS packet information on an IS-IS
interface.
● Run the display isis route [
process-id | vpn-instance
vpn-instance-name ]
ipv6 [ verbose | [ level-1 | level-2 ] |
ipv6-address [
prefix-length ] ] *
command to check IS-IS route information.
----End
8.12 Configuring LSP Fragment Extension
Pre-configuration Tasks
Before configuring LSP fragment extension, configure basic IPv6 IS-IS functions.
NOTE
When a new device connects to an IS-IS network, you are advised to configure LSP
fragment extension and virtual systems before establishing IS-IS neighbors or importing
routes. If you establish IS-IS neighbors or import routes, which causes IS-IS to carry much
information that cannot be loaded through 256 fragments, you must configure LSP
fragment extension and virtual systems. The configurations, however, take effect only after
you restart the IS-IS process.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 661
Step 3 Run lsp-fragments-extend [ [ level-1 | level-2 | level-1-2 ] | [ mode-1 |
mode-2 ] ] *
LSP fragment extension is enabled in an IS-IS process.
By default, LSP fragment extension is disabled in an IS-IS process.
If the mode or level is not specified during the configuration of LSP fragment
extension, mode-1 and level-1-2 are used by default.
NOTE
If there are devices of other manufacturers on the network, LSP fragment extension must
be set to mode-1. Otherwise, devices of other manufacturers cannot identify LSPs.
Step 4 Run virtual-system
virtual-system-id
A virtual system is configured.
By default, no virtual system is configured.
To configure a switch to generate extended LSP fragments, you must configure at
least one virtual system. The ID of the virtual system must be unique in the
domain.
An IS-IS process can be configured with up to 50 virtual system IDs.
----End
Verifying the Configuration
Run the following commands to check IS-IS process statistics.
● display isis statistics [ updated-lsp [ history ] ] [ level-1 | level-2 |
level-1-2 ] [
process-id | vpn-instance
vpn-instance-name ]
● display isis
process-id statistics [ [ [ updated-lsp [ history ] ] [ level-1 |
level-2 | level-1-2 ] ] | [ packet ] ]
8.13 Configuring a Mesh Group on an NBMA Network
Pre-configuration Tasks
Before configuring a mesh group, configure basic IPv6 IS-IS functions.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run interface
interface-type interface-number
The interface view is displayed.
Step 3 (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 662
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support switching between Layer 2 and Layer 3 modes.
Step 4 Run isis mesh-group {
mesh-group-number | mesh-blocked }
The interface is added to a mesh group.
When mesh-blocked is configured on an interface, the interface is blocked and
cannot flood LSPs outside. All the interfaces added to a mesh group implement
global LSDB synchronization through CSNP and PSNP mechanisms.
----End
Verifying the Configuration
Run the following commands to check IS-IS process statistics.
● display isis statistics [ updated-lsp [ history ] ] [ level-1 | level-2 |
level-1-2 ] [
process-id | vpn-instance
vpn-instance-name ]
● display isis
process-id statistics [ [ [ updated-lsp [ history ] ] [ level-1 |
level-2 | level-1-2 ] ] | packet ]
8.14 Configuring IPv6 IS-IS Reliability
Pre-configuration Tasks
Before configuring IS-IS reliability, configure basic IPv6 IS-IS functions.
Configuration Procedure
You can perform the following configuration tasks in any sequence as required.
8.14.1 Configuring Dynamic BFD for IPv6 IS-IS
Context
The switch supports dynamic BFD for IPv6 IS-IS, but not static BFD for IPv6 IS-IS.
Without BFD, connection status between an IS-IS device and its neighbors can be
monitored only by exchanging Hello packets at intervals. The minimum allowable
sending interval is 3s, and a neighbor is declared Down after at least three
intervals during which no response Hello packet is received from the neighbor. IS-
IS takes more than one second to detect that a neighbor becomes Down, resulting
in loss of a large amount of high-speed data.
BFD provides millisecond-level fault detection. After detecting a link or node
failure, BFD will notify IS-IS of the failure. Traffic is rapidly switched to the backup
link or node.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 663
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S BFD for IPv6 IS-IS.
Pre-configuration Tasks
Before configuring dynamic BFD for IPv6 IS-IS, complete the following tasks:
● Configure IPv6 addresses for interfaces to ensure that neighbor nodes are
reachable.
● Configure IPv6 IS-IS functions to ensure that each node is reachable at the
network layer.
Configuration Roadmap
The configuration roadmap is as follows:
No. Data
1 Nodes to be enabled with BFD for IPv6 IS-IS
2 Number of the IS-IS process to be enabled with BFD
3 Type and number of each interface to be enabled with BFD
4 Minimum interval at which BFD packets are sent
5 Minimum interval at which BFD packets are received
6 BFD detection multiplier
You can use either of the following methods to enable BFD for IPv6 IS-IS:
● Enable dynamic BFD for specified IS-IS IPv6 processes. This method is
recommended if you need to enable dynamic BFD for IPv6 IS-IS on a large
number of IS-IS interfaces.
● Enable dynamic BFD for specified IPv6 interfaces. This method is
recommended if you need to enable dynamic BFD for IPv6 IS-IS on a small
number of IS-IS interfaces.
Procedure
● Enable dynamic BFD for an IS-IS IPv6 process.
a. Run system-view
The system view is displayed.
b. Run bfd
BFD is enabled globally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 664
c. Run quit
The system view is displayed.
d. Run isis
process-id
The IS-IS view is displayed.
e. Run ipv6 bfd all-interfaces enable
BFD for IS-IS is enabled.
After BFD is enabled globally and the neighbor status is Up, default BFD
parameters will be used to establish BFD sessions on all interfaces.
f. (Optional) Run ipv6 bfd all-interfaces { min-rx-interval
receive-interval
| min-tx-interval
transmit-interval | detect-multiplier
multiplier-value } *
The parameters for establishing BFD sessions are set for all interfaces.
The command execution result is applicable to BFD session parameters
on all IS-IS interfaces.
g. Run quit
The system view is displayed.
To disable the BFD function on an interface, run the isis ipv6 bfd block
command in the interface view to disable the interface from establishing
BFD sessions.
● Enable dynamic BFD on an IS-IS IPv6 interface.
a. Run system-view
The system view is displayed.
b. Run bfd
BFD is enabled globally.
c. Run quit
The system view is displayed.
d. Run interface
interface-type interface-number
The view of the specified interface is displayed.
e. (Optional) On an Ethernet interface, run undo portswitch
The interface is switched to Layer 3 mode.
By default, an Ethernet interface works in Layer 2 mode.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H,
S6730S-H, S6730-S, and S6730S-S support switching between Layer 2 and Layer
3 modes.
f. Run isis ipv6 bfd enable
BFD is enabled on the interface.
g. (Optional) Run isis ipv6 bfd { min-rx-interval
receive-interval | min-tx-
interval
transmit-interval | detect-multiplier
multiplier-value } *
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 665
Run this command when BFD session parameters need to be configured
for a specified interface.
----End
Verifying the Configurations
After configuring dynamic BFD for IPv6 IS-IS, you can check information about the
BFD session and BFD for IPv6 IS-IS on an interface.
● Run the display isis [
process-id | vpn-instance
vpn-instance-name ] ipv6 bfd
session { all | peer
ipv6-address | interface
interface-type interface-number }
command to check information about a BFD session.
● Run the display isis [
process-id ] ipv6 bfd interface command to check the
configurations of BFD for IPv6 IS-IS on the specified interface.
8.15 Configuring the Overload Bit for an IS-IS Device
Pre-configuration Tasks
Before configuring the overload bit for an IS-IS device, configure basic IPv6 IS-IS
functions.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Run set-overload [ on-startup [
timeout1 | start-from-nbr
system-id [
timeout1
[
timeout2 ] ] | wait-for-bgp [
timeout1 ] ] [ send-sa-bit [
timeout3 ] ] ] [ allow
{ interlevel | external }* ]
The overload bit for non-pseudonode LSPs is configured.
----End
Verifying the Configuration
● Run the display isis lsdb [ [ level-1 | level-2 ] | verbose | [ local |
lsp-id | is-
name
symbolic-name ] ] * [
process-id | vpn-instance
vpn-instance-name ]
command to check information in the IS-IS LSDB.
8.16 Maintaining IS-IS
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 666
8.16.1 Resetting IS-IS
Context
To reset IS-IS, reset IS-IS data structure, neighbor relationship and packets
NOTICE
The IS-IS data structure cannot be restored after you reset it. All the previous
structure information and the neighbor relationship are reset. Exercise caution
when running this command.
The specified IS-IS neighbor relationship is deleted after you reset a specified IS-IS
neighbor. Exercise caution when running this command.
Procedure
● Reset IS-IS data structure.
Run the reset isis all[
process-id | vpn-instance
vpn-instance-name ]
command to reset IS-IS data structure.
● Reset IS-IS neighbor relationship.
Run the reset isis peer
system-id [
process-id | vpn-instance
vpn-instance-
name ] command to reset a specific IS-IS neighbor.
After the IS-IS routing policy or the protocol changes, you can reset a specific
IS-IS neighbor to validate the new configuration.
----End
8.16.2 Improving the Maintainability of IS-IS
Context
The administrator can improve the maintainability of IS-IS using either of the
following methods:
● Configuring IS-IS host name mapping: Through this function, the
administrator can use a simple name to replace the system ID. After IS-IS host
name mapping is configured, the dynamic name is displayed in the IS-IS
information to replace the system ID when the display command is executed.
This improves the maintainability of IS-IS networks.
● Configuring IS-IS to add the POI TLV to a PURGE packet: When the value of
the Remaining Lifetime field in an LSP packet is 0, this packet is invalid and
called a PURGE packet. PURGE packets do not record information about the
devices generating these packets. Therefore, when a network is faulty, the
packet source cannot be located. To solve this problem, IS-IS can be
configured to add the POI TLV to a PURGE packet so that the PURGE packet
contains information about its generating device. If the dynamic host name
function is configured locally, the host name TLV is also added to the PURGE
packet to facilitate fault location.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 667
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
Step 3 Configure IS-IS host name mapping.
● Run is-name
symbolic-name
IS-IS dynamic host name mapping is configured and a host name is
configured for the local device.
This configuration is dynamic configuration. Therefore, the configured host
name
symbolic-name is advertised through an LSP to other IS-IS devices in
the same area. When you use IS-IS display commands to view IS-IS
information on other IS-IS devices, the system ID of the local device is
replaced by the configured host name.
● Run is-name map
system-id symbolic-name
IS-IS static host name mapping is configured and a host name is configured
for the remote device.
This configuration is static configuration and takes effect only on the local
device. Therefore, the configured host name
symbolic-name is not advertised
through an LSP.
----End
8.16.3 Configuring the Output of IS-IS Adjacency Status
Context
On an IS-IS network, neighbor flapping will result in network instability and
frequent network convergence. This will consume lots of memory and may even
cause user traffic loss. Therefore, neighbor flapping needs to be rapidly located
and solved.
To rapidly locate problems in the case of neighbor flapping, enable the output of
IS-IS adjacency changes to log these changes.
If the local terminal monitor is enabled and the output of the IS-IS adjacency
status is enabled, IS-IS adjacency changes will be output to the router until the
output of the adjacency status is disabled.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run isis [
process-id ]
The IS-IS view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 668
Step 3 Run log-peer-change [ topology ]
The output of the adjacency status is enabled.
By default, the output of IS-IS adjacency changes is disabled.
----End
8.17 Configuration Examples for IPv6 IS-IS
8.17.1 Example for Configuring Basic IPv6 IS-IS Functions
Networking Requirements
In Figure 8-1, the four switches on the IPv6 network need to communicate with
each other. SwitchA and SwitchB can only process a small amount of data.
Figure 8-1 Configuring basic IPv6 IS-IS functions
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IPv6 addresses on interfaces of each switch so that the switches can
be interconnected.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 669
2. Enable IS-IS on each switch so that the switches can be interconnected.
Configure SwitchA and SwitchB as Level-1 switches to enable them to
maintain less data.
Procedure
Step 1 Configure VLANs that interfaces belong to.
# Configure SwitchA. Ensure that the configurations of SwitchB, SwitchC, and
SwitchD are the same as the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Enable the capability of IPv6 forwarding and configure IPv6 address for each
interface.
# Configure SwitchA. Ensure that the configurations of SwitchB, SwitchC, and
SwitchD are the same as the configuration of SwitchA.
[SwitchA] ipv6
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ipv6 enable
[SwitchA-Vlanif10] ipv6 address fc00:0:0:10::2/64
[SwitchA-Vlanif10] quit
Step 3 Configure IS-IS.
# Configure SwitchA.
[SwitchA] isis 1
[SwitchA-isis-1] is-level level-1
[SwitchA-isis-1] network-entity 10.0000.0000.0001.00
[SwitchA-isis-1] ipv6 enable
[SwitchA-isis-1] quit
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] isis ipv6 enable 1
[SwitchA-Vlanif10] quit
# Configure SwitchB.
[SwitchB] isis 1
[SwitchB-isis-1] is-level level-1
[SwitchB-isis-1] network-entity 10.0000.0000.0002.00
[SwitchB-isis-1] ipv6 enable
[SwitchB-isis-1] quit
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] isis ipv6 enable 1
[SwitchB-Vlanif20] quit
# Configure SwitchC.
[SwitchC] isis 1
[SwitchC-isis-1] network-entity 10.0000.0000.0003.00
[SwitchC-isis-1] ipv6 enable
[SwitchC-isis-1] quit
[SwitchC] interface vlanif 10
[SwitchC-Vlanif10] isis ipv6 enable 1
[SwitchC-Vlanif10] quit
[SwitchC] interface vlanif 20
[SwitchC-Vlanif20] isis ipv6 enable 1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 670
[SwitchC-Vlanif20] quit
[SwitchC] interface vlanif 30
[SwitchC-Vlanif30] isis ipv6 enable 1
[SwitchC-Vlanif30] isis circuit-level level-2
[SwitchC-Vlanif30] quit
# Configure SwitchD.
[SwitchD] isis 1
[SwitchD-isis-1] is-level level-2
[SwitchD-isis-1] network-entity 20.0000.0000.0004.00
[SwitchD-isis-1] ipv6 enable
[SwitchD-isis-1] quit
[SwitchD] interface vlanif 30
[SwitchD-Vlanif30] isis ipv6 enable 1
[SwitchD-Vlanif30] quit
[SwitchD] interface vlanif40
[SwitchD-Vlanif40] isis ipv6 enable 1
[SwitchD-Vlanif40] quit
Step 4 Verify the configuration.
# Check the IS-IS routing table of SwitchA.
[SwitchA] display isis route
Route information for ISIS(1)
-----------------------------
ISIS(1) Level-1 Forwarding Table
--------------------------------
IPV4 Destination IntCost ExtCost ExitInterface NextHop Flags
-------------------------------------------------------------------------------
0.0.0.0/0 10 NULL
IPV6 Dest. ExitInterface NextHop Cost Flags
-------------------------------------------------------------------------------
::/0 Vlanif10 FE80::244:1FF:FE41:5411 10 A/-/-
FC00:0:0:10::/64
Vlanif10 Direct 10 D/L/-
FC00:0:0:20::/64
Vlanif10 FE80::244:1FF:FE41:5411 20 A/-/-
Flags: D-Direct, A-Added to URT, L-Advertised in LSPs, S-IGP Shortcut,
U-Up/Down Bit Set
# Check the IS-IS neighbors of SwitchC.
[SwitchC] display isis peer verbose
Peer information for ISIS(1)
System Id Interface Circuit Id State HoldTime Type PRI
-------------------------------------------------------------------------------
0000.0000.0001 Vlanif10 0000.0000.0001.01 Up 8s L1 64
MT IDs supported : 0(UP)
Local MT IDs : 0
Area Address(es) : 10
Peer IPv6 Address(es): FE80::1234:FCFF:FEFC:199
Uptime : 00:02:08
Adj Protocol : IPV6
Restart Capable : YES
Suppressed Adj : NO
Peer System Id : 0000.0000.0001
0000.0000.0002 Vlanif20 0000.0000.0003.02 Up 24s L1 64
MT IDs supported : 0(UP)
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 671
Local MT IDs : 0
Area Address(es) : 10
Peer IPv6 Address(es): FE80::225:9EFF:FEFB:494A
Uptime : 00:02:09
Adj Protocol : IPV6
Restart Capable : YES
Suppressed Adj : NO
Peer System Id : 0000.0000.0002
0000.0000.0004 Vlanif30 0000.0000.0003.03 Up 27s L2 64
MT IDs supported : 0(UP)
Local MT IDs : 0
Area Address(es) : 20
Peer IPv6 Address(es): FE80::244:1FF:FE41:5410
Uptime : 00:02:16
Adj Protocol : IPV6
Restart Capable : YES
Suppressed Adj : NO
Peer System Id : 0000.0000.0004
Total Peer(s): 3
# Check the IS-IS LSDB of SwitchC.
[SwitchC] display isis lsdb verbose
Database information for ISIS(1)
--------------------------------
Level-1 Link State Database
LSPID Seq Num Checksum Holdtime Length ATT/P/OL
-------------------------------------------------------------------------------
0000.0000.0001.00-00 0x00000005 0x3cb9 1009 86 0/0/0
SOURCE 0000.0000.0001.00
NLPID IPV6
AREA ADDR 10
INTF ADDR V6 FC00:0:0:10::2
Topology Standard
NBR ID 0000.0000.0001.01 COST: 10
IPV6 FC00:0:0:10::/64 COST: 10
0000.0000.0001.01-00 0x00000001 0xd8f1 1009 55 0/0/0
SOURCE 0000.0000.0001.01
NLPID IPV6
NBR ID 0000.0000.0001.00 COST: 0
NBR ID 0000.0000.0003.00 COST: 0
0000.0000.0002.00-00 0x00000005 0x864b 1007 86 0/0/0
SOURCE 0000.0000.0002.00
NLPID IPV6
AREA ADDR 10
INTF ADDR V6 FC00:0:0:20::2
Topology Standard
NBR ID 0000.0000.0003.02 COST: 10
IPV6 FC00:0:0:20::/64 COST: 10
0000.0000.0003.00-00* 0x00000007 0xcf9b 1012 143 1/0/0
SOURCE 0000.0000.0003.00
NLPID IPV6
AREA ADDR 10
INTF ADDR V6 FC00:0:0:10::1
INTF ADDR V6 FC00:0:0:20::1
INTF ADDR V6 FC00:0:0:30::1
Topology Standard
NBR ID 0000.0000.0001.01 COST: 10
NBR ID 0000.0000.0003.02 COST: 10
IPV6 FC00:0:0:10::/64 COST: 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 672
IPV6 FC00:0:0:20::/64 COST: 10
0000.0000.0003.02-00* 0x00000001 0xc9fa 1009 55 0/0/0
SOURCE 0000.0000.0003.02
NLPID IPV6
NBR ID 0000.0000.0003.00 COST: 0
NBR ID 0000.0000.0002.00 COST: 0
Total LSP(s): 5
*(In TLV)-Leaking Route, *(By LSPID)-Self LSP, +-Self LSP(Extended),
ATT-Attached, P-Partition, OL-Overload
Level-2 Link State Database
LSPID Seq Num Checksum Holdtime Length ATT/P/OL
-------------------------------------------------------------------------------
0000.0000.0003.00-00* 0x00000006 0x8ff6 1014 146 0/0/0
SOURCE 0000.0000.0003.00
NLPID IPV6
AREA ADDR 10
INTF ADDR V6 FC00:0:0:10::1
INTF ADDR V6 FC00:0:0:20::1
INTF ADDR V6 FC00:0:0:30::1
Topology Standard
NBR ID 0000.0000.0003.03 COST: 10
IPV6 FC00:0:0:10::/64 COST: 10
IPV6 FC00:0:0:20::/64 COST: 10
IPV6 FC00:0:0:30::/64 COST: 10
0000.0000.0003.03-00* 0x00000001 0xfac6 1012 55 0/0/0
SOURCE 0000.0000.0003.03
NLPID IPV6
NBR ID 0000.0000.0003.00 COST: 0
NBR ID 0000.0000.0004.00 COST: 0
0000.0000.0004.00-00 0x00000005 0x5943 1009 86 0/0/0
SOURCE 0000.0000.0004.00
NLPID IPV6
AREA ADDR 20
INTF ADDR V6 FC00:0:0:30::2
Topology Standard
NBR ID 0000.0000.0003.03 COST: 10
IPV6 FC00:0:0:30::/64 COST: 10
Total LSP(s): 3
*(In TLV)-Leaking Route, *(By LSPID)-Self LSP, +-Self LSP(Extended),
ATT-Attached, P-Partition, OL-Overload
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
vlan batch 10
#
isis 1
is-level level-1
network-entity 10.0000.0000.0001.00
#
ipv6 enable topology standard
#
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 673
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:10::2/64
isis ipv6 enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
vlan batch 20
#
isis 1
is-level level-1
network-entity 10.0000.0000.0002.00
#
ipv6 enable topology standard
#
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:20::2/64
isis ipv6 enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 10 20 30
#
isis 1
network-entity 10.0000.0000.0003.00
#
ipv6 enable topology standard
#
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:10::1/64
isis ipv6 enable 1
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:20::1/64
isis ipv6 enable 1
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:30::1/64
isis ipv6 enable 1
isis circuit-level level-2
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 674
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
return
● SwitchD configuration file
#
sysname SwitchD
#
ipv6
#
vlan batch 30 40
#
isis 1
is-level level-2
network-entity 20.0000.0000.0004.00
#
ipv6 enable topology standard
#
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:30::2/64
isis ipv6 enable 1
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:25::1/64
isis ipv6 enable 1
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
return
8.17.2 Example for Configuring Dynamic BFD for IPv6 IS-IS
Networking Requirements
In Figure 8-2, IS-IS is run among SwitchA, SwitchB, and SwitchC. Service traffic is
forwarded along the primary link SwitchA→SwitchB. The link
SwitchA→SwitchC→SwitchB is used as a backup. Customers require that a fault on
the primary link be detected in milliseconds so that service traffic can be fast
switched to the backup link if the primary link fails.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 675
Figure 8-2 Networking diagram for configuring dynamic BFD for IPv6 IS-IS
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic IS-IS IPv6 functions on each switch.
2. Set link cost values for IS-IS interfaces on each switch to make the path
SwitchA→SwitchB become the primary and the path
SwitchA→SwitchC→SwitchB become the backup.
3. Enable BFD globally on each switch to detect faults on the primary link in
milliseconds.
4. Enable IPv6 BFD for IS-IS in the IS-IS view on each switch so that service
traffic can be fast switched to the backup link when the primary link fails.
Procedure
Step 1 Enable the IPv6 forwarding capability and configure IPv6 addresses for interfaces.
# Configure SwitchA. Ensure that the configurations of SwitchB and SwitchC are
the same as the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] ipv6
[SwitchA] interface GigabitEthernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] undo portswitch
[SwitchA-GigabitEthernet0/0/1] ipv6 enable
[SwitchA-GigabitEthernet0/0/1] ipv6 address FC00:3::1 64
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface GigabitEthernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] undo portswitch
[SwitchA-GigabitEthernet0/0/2] ipv6 enable
[SwitchA-GigabitEthernet0/0/2] ipv6 address FC00:1::1 64
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure basic IS-IS IPv6 functions.
# Configure SwitchA.
[SwitchA] isis 10
[SwitchA-isis-10] is-level level-2
[SwitchA-isis-10] network-entity 10.0000.0000.0001.00
[SwitchA-isis-10] ipv6 enable
[SwitchA-isis-10] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 676
[SwitchA] interface GigabitEthernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] isis ipv6 enable 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface GigabitEthernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] isis ipv6 enable 10
[SwitchA-GigabitEthernet0/0/2] quit
# Configure SwitchB.
[SwitchB] isis 10
[SwitchB-isis-10] is-level level-2
[SwitchB-isis-10] network-entity 10.0000.0000.0003.00
[SwitchB-isis-10] ipv6 enable
[SwitchB-isis-10] quit
[SwitchB] interface GigabitEthernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] isis ipv6 enable 10
[SwitchB-GigabitEthernet0/0/1] quit
[SwitchB] interface GigabitEthernet 0/0/2
[SwitchB-GigabitEthernet0/0/2] isis ipv6 enable 10
[SwitchB-GigabitEthernet0/0/2] quit
[SwitchB] interface GigabitEthernet 0/0/3
[SwitchB-GigabitEthernet0/0/3] isis ipv6 enable 10
[SwitchB-GigabitEthernet0/0/3] quit
# Configure SwitchC.
[SwitchC] isis 10
[SwitchC-isis-10] is-level level-2
[SwitchC-isis-10] network-entity 10.0000.0000.0002.00
[SwitchC-isis-10] ipv6 enable
[SwitchC-isis-10] quit
[SwitchC] interface GigabitEthernet 0/0/1
[SwitchC-GigabitEthernet0/0/1] isis ipv6 enable 10
[SwitchC-GigabitEthernet0/0/1] quit
[SwitchC] interface GigabitEthernet 0/0/2
[SwitchC-GigabitEthernet0/0/2] isis ipv6 enable 10
[SwitchC-GigabitEthernet0/0/2] quit
# After the configurations are complete, run the display ipv6 routing-table
command. You can view that the switches have learnt IPv6 routes from each other.
Step 3 Set link cost values for IS-IS interfaces.
# Configure SwitchA.
[SwitchA] interface GigabitEthernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] isis cost 1 level-2
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface GigabitEthernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] isis cost 10 level-2
[SwitchA-GigabitEthernet0/0/2] quit
# Configure SwitchB.
[SwitchB] interface GigabitEthernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] isis cost 1 level-2
[SwitchB-GigabitEthernet0/0/1] quit
[SwitchB] interface GigabitEthernet 0/0/2
[SwitchB-GigabitEthernet0/0/2] isis cost 10 level-2
[SwitchB-GigabitEthernet0/0/2] quit
[SwitchB] interface GigabitEthernet 0/0/3
[SwitchB-GigabitEthernet0/0/3] isis cost 10 level-2
[SwitchB-GigabitEthernet0/0/3] quit
# Configure SwitchC.
[SwitchC] interface GigabitEthernet 0/0/1
[SwitchC-GigabitEthernet0/0/1] isis cost 10 level-2
[SwitchC-GigabitEthernet0/0/1] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 677
[SwitchC] interface GigabitEthernet 0/0/2
[SwitchC-GigabitEthernet0/0/2] isis cost 10 level-2
[SwitchC-GigabitEthernet0/0/2] quit
Step 4 Configure IPv6 BFD for IS-IS.
# Enable IPv6 BFD for IS-IS globally on SwitchA, SwitchB, and SwitchC, and set the
minimum intervals for sending and receiving BFD packets to 150 milliseconds.
# Configure SwitchA.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] isis 10
[SwitchA-isis-10] ipv6 bfd all-interfaces enable
[SwitchA-isis-10] ipv6 bfd all-interfaces min-tx-interval 150 min-rx-interval 150
[SwitchA-isis-10] quit
# Configure SwitchB.
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] isis 10
[SwitchB-isis-10] ipv6 bfd all-interfaces enable
[SwitchB-isis-10] ipv6 bfd all-interfaces min-tx-interval 150 min-rx-interval 150
[SwitchB-isis-10] quit
# Configure SwitchC.
[SwitchC] bfd
[SwitchC-bfd] quit
[SwitchC] isis 10
[SwitchC-isis-10] ipv6 bfd all-interfaces enable
[SwitchC-isis-10] ipv6 bfd all-interfaces min-tx-interval 150 min-rx-interval 150
[SwitchC-isis-10] quit
# After the configurations are complete, run the display isis ipv6 bfd session all
command on SwitchA or SwitchB. You can view that IPv6 BFD parameters already
take effect. Take the display on SwitchA as an example:
[SwitchA] display isis ipv6 bfd session all
IPv6 BFD session information for ISIS(10)
-----------------------------------------
Peer System ID : 0000.0000.0003 Type : L2
Interface : GE0/0/1
IPv6 BFD State : up TX : 150 RX : 150 Multiplier : 3
LocDis : 8198 Local IPv6 Address : FE80::200:13FF:FE82:4569
RemDis : 8199 Peer IPv6 Address : FE80::201:FF:FE01:1
Diag : No diagnostic information
Peer System ID : 0000.0000.0002 Type : L2
Interface : GE0/0/2
IPv6 BFD State : up TX : 150 RX : 150 Multiplier : 3
LocDis : 8197 Local IPv6 Address : FE80::200:13FF:FE82:4569
RemDis : 8199 Peer IPv6 Address : FE80::225:9EFF:FEFB:BFF1
Diag : No diagnostic information
Total IPv6 BFD session(s): 2
Step 5 Verify the configuration.
# On SwitchA, run the display ipv6 routing-table FC00:4::1 64 command to view
the IPv6 routing table. You can view that the next hop address of the route is
FE80::201:FF:FE01:1 and the outbound interface is GE0/0/1.
[SwitchA] display ipv6 routing-table FC00:4::1 64
Routing Table :Public
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 678
Summary Count : 1
Destination : FC00:4:: PrefixLength : 64
NextHop : FE80::201:FF:FE01:1 Preference : 15
Cost : 11 Protocol : ISIS-L2
RelayNextHop : :: TunnelID : 0x0
Interface : GigabitEthernet0/0/1 Flags : D
# Run the shutdown command on GE0/0/1 of SwitchB to simulate a primary link
fault.
[SwitchB] interface GigabitEthernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] shutdown
# On SwitchA, run the display ipv6 routing-table FC00:4::1 64 command to view
the IPv6 routing table.
[SwitchA] display ipv6 routing-table FC00:4::1 64
Routing Table :Public
Summary Count : 1
Destination : FC00:4:: PrefixLength : 64
NextHop : FE80::225:9EFF:FEFB:BFF1 Preference : 15
Cost : 30 Protocol : ISIS-L2
RelayNextHop : :: TunnelID : 0x0
Interface : GigabitEthernet0/0/2 Flags : D
In the IPv6 routing table, you can view that the backup link transmits traffic after
the primary link fails, the next hop address of the route to FC00:4::/64 becomes
FE80::225:9EFF:FEFB:BFF1, and the outbound interface becomes GE0/0/2.
# Run the display isis ipv6 bfd session all command on SwitchA, and you can
view that only one BFD session is established between SwitchA and SwitchC and
its status is Up.
[SwitchA] display isis ipv6 bfd session all
IPv6 BFD session information for ISIS(10)
-----------------------------------------
Peer System ID : 0000.0000.0002 Type : L2
Interface : GE0/0/2
IPv6 BFD State : up TX : 150 RX : 150 Multiplier : 3
LocDis : 8197 Local IPv6 Address : FE80::200:13FF:FE82:4569
RemDis : 8199 Peer IPv6 Address : FE80::225:9EFF:FEFB:BFF1
Diag : No diagnostic information
Total IPv6 BFD session(s): 1
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
bfd
#
isis 10
is-level level-2
network-entity 10.0000.0000.0001.00
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 679
#
ipv6 enable topology standard
ipv6 bfd all-interfaces enable
ipv6 bfd all-interfaces min-tx-interval 150 min-rx-interval 150
#
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:3::1/64
isis ipv6 enable 10
isis cost 1 level-2
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:1::1/64
isis ipv6 enable 10
isis cost 10 level-2
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
bfd
#
isis 10
is-level level-2
network-entity 10.0000.0000.0003.00
#
ipv6 enable topology standard
ipv6 bfd all-interfaces enable
ipv6 bfd all-interfaces min-tx-interval 150 min-rx-interval 150
#
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:3::2/64
isis ipv6 enable 10
isis cost 1 level-2
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:2::2/64
isis ipv6 enable 10
isis cost 10 level-2
#
interface GigabitEthernet0/0/3
undo portswitch
ipv6 enable
ipv6 address FC00:4::1/64
isis ipv6 enable 10
isis cost 10 level-2
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
bfd
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 680
isis 10
is-level level-2
network-entity 10.0000.0000.0002.00
#
ipv6 enable topology standard
ipv6 bfd all-interfaces enable
ipv6 bfd all-interfaces min-tx-interval 150 min-rx-interval 150
#
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:2::1/64
isis ipv6 enable 10
isis cost 10 level-2
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:1::2/64
isis ipv6 enable 10
isis cost 10 level-2
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 8 IPv6 IS-IS Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 681
9 BGP Configuration
9.1 Overview of BGP
9.2 Understanding BGP
9.3 Summary of BGP Configuration Tasks
9.4 Licensing Requirements and Limitations for BGP
9.5 Default Settings for BGP
9.6 Configuring Basic BGP Functions
9.7 Configuring BGP Security
9.8 Simplifying IBGP Network Connections
9.9 Configuring BGP Route Selection and Load Balancing
9.10 Controlling the Receiving and Advertisement of BGP Routes
9.11 Adjusting the BGP Network Convergence Speed
9.12 Configuring BGP Reliability
9.13 Configuring BGP Route Summarization
9.14 Configuring BGP to Advertise Default Routes to Peers
9.15 Configuring MP-BGP
9.16 Maintaining BGP
9.17 Configuration Examples for BGP
9.1 Overview of BGP
Definition
The Border Gateway Protocol (BGP) is a path vector protocol that allows devices
between Autonomous Systems (ASs) to communicate and selects optimal routes.
BGP-1 (defined in RFC 1105), BGP-2 (defined in RFC 1163), and BGP-3 (defined in
RFC 1267) are three earlier versions of BGP. BGP-4 (defined in RFC 1771) has been
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 682
used since 1994. Since 2006, unicast IPv4 networks have been using BGP-4 defined
in RFC 4271, and other networks (such as IPv6 networks) have been using
Multiprotocol BGP (MP-BGP) defined in RFC 4760.
MP-BGP is an extension of BGP-4 and applies to different networks; however, the
original message exchange and routing mechanisms of BGP-4 are not changed.
MP-BGP applications on IPv6 unicast and IPv4 multicast networks are called
BGP4+ and Multicast BGP (MBGP) respectively.
Purpose
A network is divided into different ASs to facilitate network management. In 1982,
the Exterior Gateway Protocol (EGP) was used to dynamically exchange routing
information between ASs. However, EGP advertises only reachable routes and does
not select optimal routes or prevent routing loops. Therefore, EGP cannot meet
network management requirements.
BGP was designed to replace EGP and has the following capabilities:
● Selects optimal routes.
● Prevents routing loops.
● Transmits routing information efficiently.
● Maintains a large number of routes.
Benefits
BGP ensures high network security, flexibility, stability, reliability, and efficiency:
● BGP uses authentication and Generalized TTL Security Mechanism (GTSM) to
ensure network security.
● BGP provides routing policies to allow for flexible route selection.
● BGP provides 9.2.8 Route Summarization and 9.2.9 Route Dampening to
prevent route flapping and improve network stability.
● BGP uses the Transport Control Protocol (TCP) with port number 179 as the
transport layer protocol and supports 9.2.10 BFD for BGP, 9.2.11 BGP
Tracking, and 9.2.12 BGP GR to improve network reliability.
9.2 Understanding BGP
9.2.1 Basic Concepts of BGP
This section describes BGP concepts to help you better understand BGP functions.
Autonomous System
An Autonomous System (AS) is a group of Internet Protocol (IP) networks that are
controlled by one entity, typically an Internet service provider (ISP), and have the
same routing policy. Each AS is assigned a unique AS number, which identifies an
AS on a BGP network. Two types of AS numbers are available: 2-byte AS numbers
and 4-byte AS numbers. A 2-byte AS number ranges from 1 to 65535, and a 4-
byte AS number ranges from 1 to 4294967295. Devices supporting 4-byte AS
numbers are compatible with devices supporting 2-byte AS numbers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 683
BGP Classification
In Figure 9-1, BGP is classified into two types according to where it runs: Internal
BGP (IBGP) and External BGP (EBGP).
Figure 9-1 BGP operating mode
● EBGP
EBGP runs between ASs. To prevent routing loops between ASs, a BGP device
discards the routes with the local AS number when receiving the routes from
EBGP peers.
● IBGP
IBGP runs within an AS. To prevent routing loops within an AS, a BGP device
does not advertise the routes learned from an IBGP peer to the other IBGP
peers and establishes full-mesh connections with all IBGP peers. To address
the problem of too many IBGP connections between IBGP peers, BGP uses
9.2.6 Route Reflector and 9.2.7 BGP Confederation.
NOTE
If a BGP device needs to advertise the route received from an EBGP peer outside an AS
through another BGP device, IBGP is recommended.
Device Roles in BGP Message Exchange
There are two device roles in BGP message exchange:
● Speaker
The device that sends BGP messages is a BGP speaker. A BGP speaker receives
and generates new routes, and advertises the routes to other BGP speakers.
● Peer
BGP speakers that exchange messages with each other are BGP peers. A
group of BGP peers sharing the same policies can form a peer group.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 684
BGP Router ID
The BGP router ID is a 32-bit value that is often represented by an IPv4 address to
identify a BGP device. It is carried in the Open message sent during the
establishment of a BGP session. When two BGP peers need to establish a BGP
session, they each require a unique router ID. Otherwise, the two peers cannot
establish a BGP session.
9.2.2 BGP Fundamentals
BGP peer establishment, update, and deletion involve five types of messages, six
state machine states, and five route exchange rules.
BGP Messages
BGP peers exchange the following messages, among which Keepalive messages
are periodically sent and other messages are triggered by events.
● Open message
Used to establish BGP peer relationships.
● Update message
Used to exchange routes between BGP peers.
● Notification message
Used to terminate BGP connections.
● Keepalive message
Used to maintain BGP connections.
● Route-refresh message
Used to request the peer to retransmit routes if routing policies are changed.
Only the BGP devices supporting route-refresh can send and respond to
Route-refresh messages.
BGP State Machine
In Figure 9-2, a BGP device uses a finite state machine (FSM) to determine its
operations with peers. The FSM has six states: Idle, Connect, Active, OpenSent,
OpenConfirm, and Established. Three common states are involved in BGP peer
establishment: Idle, Active, and Established.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 685
Figure 9-2 BGP state machine
1. The Idle state is the initial BGP state where the BGP device refuses all
connection requests from neighbors. The BGP device initiates a TCP
connection with its BGP peer and changes its state to Connect only after
receiving a Start event from the system.
NOTE
● The Start event occurs when an operator configures a BGP process or resets an
existing BGP process or when the router software resets a BGP process.
● If an error occurs at any state of the FSM, for example, the BGP device receives a
Notification packet or TCP connection termination notification, the BGP device
returns to the Idle state.
2. In Connect state, the BGP device starts the Connect Retry timer and waits to
establish a TCP connection.
– If the TCP connection is established, the BGP device sends an Open
message to the peer and changes to the OpenSent state.
– If the TCP connection fails to be established, the BGP device moves to the
Active state.
– If the BGP device does not receive a response from the peer before the
Connect Retry timer expires, the BGP device attempts to establish a TCP
connection with another peer and stays in Connect state.
3. In Active state, the BGP device keeps trying to establish a TCP connection with
the peer.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 686
– If the TCP connection is established, the BGP device sends an Open
message to the peer, closes the Connect Retry timer, and changes to the
OpenSent state.
– If the TCP connection fails to be established, the BGP device stays in the
Active state.
– If the BGP device does not receive a response from the peer before the
Connect Retry timer expires, the BGP device returns to the Connect state.
4. In OpenSent state, the BGP device waits for an Open message from the peer
and then checks the validity of the received Open message, including the AS
number, version, and authentication password.
– If the received Open message is valid, the BGP device sends a Keepalive
message and changes to the OpenConfirm state.
– If the received Open message is invalid, the BGP device sends a
Notification message to the peer and returns to the Idle state.
5. In OpenConfirm state, the BGP device waits for a Keepalive or Notification
message from the peer. If the BGP device receives a Keepalive message, it
transitions to the Established state. If it receives a Notification message, it
returns to the Idle state.
6. In Established state, the BGP device exchanges Update, Keepalive, Route-
refresh, and Notification messages with the peer.
– If the BGP device receives a valid Update or Keepalive message, it
considers that the peer is working properly and maintains the BGP
connection with the peer.
– If the BGP device receives an invalid Update or Keepalive message, it
sends a Notification message to the peer and returns to the Idle state.
– If the BGP device receives a Route-refresh message, it does not change its
status.
– If the BGP device receives a Notification message, it returns to the Idle
state.
– If the BGP device receives a TCP connection termination notification, it
terminates the TCP connection with the peer and returns to the Idle state.
Route Exchange Rules
A BGP device adds optimal routes to the BGP routing table to generate BGP
routes. After establishing a BGP peer relationship with a neighbor, the BGP device
follows the following rules to exchange routes with the peer:
● Advertises the BGP routes received from IBGP peers only to its EBGP peers.
● Advertises the BGP routes received from EBGP peers to its EBGP peers and
IBGP peers.
● Advertises the optimal route to its peers when there are multiple valid routes
to the same destination.
● Sends only updated BGP routes when BGP routes change.
● Accepts all the routes sent from its peers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 687
9.2.3 Interaction Between BGP and IGPs
BGP and IGPs use different routing tables. To allow devices in different ASs to
communicate, BGP needs to interact with IGPs. That is, BGP and IGP routes can be
imported into IGP and BGP routing tables respectively.
Importing IGP Routes into BGP
BGP cannot discover routes and needs to import IGP routes into a BGP routing
table for inter-AS communication. When an AS needs to advertise routes to
another AS, an AS boundary router (ASBR) will import IGP routes into its BGP
routing table. For better network planning, BGP can filter and set attributes for
imported IGP routes based on routing policies. Alternatively, EBGP peers can select
routes when traffic enters an AS based on the configured Multi-Exit Discriminator
(MED) value.
BGP can import routes in either import or network mode:
● In import mode, BGP imports routes according to protocol types, such as RIP
routes, OSPF routes, and IS-IS routes. To ensure validity of imported IGP
routes, BGP can also import static routes and direct routes in import mode.
● In network mode, BGP imports routes in an IP routing table one by one.
Therefore, the network mode is more precise than the import mode.
Importing BGP Routes into IGPs
When an AS needs to import routes from other ASs, an ASBR of this AS will
import BGP routes into its IGP routing table. To prevent a large number of BGP
routes from affecting devices in this AS, IGPs can filter and set attributes for
imported BGP routes based on routing policies.
Problem and Solution Related to Route Import Between BGP and IGPs
BGP and IGPs often import routes from each other to advertise routes between
ASs. However, the following problems may occur:
● If a large number of BGP routes exist, low-end devices within ASs may be
unable to have these routes installed, resulting in route loss.
● If a route is unstable, for example, a port frequently alternates between Up
and Down states, all routes within an AS may flap, affecting network stability.
● BGP prevents routing loops using route attributes, for example, the AS_Path
attribute. When all BGP routes are re-advertised into IGPs, their route
attributes will be lost. As a result, the BGP routing loop prevention
mechanism becomes ineffective, and routing loops may occur.
On a large IP network, the number of BGP routes is much larger than the number
of IGP routes. Therefore, when BGP routes need to be imported into IGPs, exercise
caution to prevent a large number of imported BGP routes from affecting IGP
routes. To do so, use default routes and summarize routes to reduce the number
of BGP routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 688
Figure 9-3 Using EBGP and IBGP to Advertise Routes Between ASs
Figure 9-3 shows a typical IP backbone network topology. In this topology, the
backbone layer and aggregation layer are AS 200 and AS 100 respectively, and AS
100 has two egress devices, SwitchC and SwitchD. The two ASs need to
communicate using routes. The following requirements need to be met:
● Devices on the aggregation layer are not expected to know route details of
the backbone layer.
● Devices on the aggregation layer have low performance and are not expected
to receive a large number of BGP routes from the backbone layer.
● Devices on the backbone layer have high performance and are expected to
know route details of the aggregation layer.
In Figure 9-3, if the two egress devices SwitchC and SwitchD import BGP routes
into OSPF, a large number of BGP routes will be transmitted from the backbone
layer to the aggregation layer. This will enable the aggregation devices to receive
a large number of BGP routes and know route details of the backbone layer. As a
result, the preceding requirements cannot be met. The following solution can
meet these requirements:
● Two devices on the backbone layer, SwitchE and SwitchF, advertise default
routes through BGP to two egress devices on the aggregation layer, SwitchC
and SwitchD. This operation ensures that aggregation devices do not receive a
large number of BGP routes from the backbone layer and do not know route
details of the backbone layer.
● The two egress devices, SwitchC and SwitchD, import only OSPF routes into
BGP, without importing BGP routes into OSPF. This ensures that backbone
devices know route details of the aggregation layer.
● ASBRs of each AS establish an IBGP peer relationship. That is, SwitchC and
SwitchD establish an IBGP peer relationship, and SwitchE and SwitchF
establish an IBGP peer relationship. This ensures route backup of two egress
devices in the ASs and improves reliability.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 689
9.2.4 BGP Security
BGP uses authentication and Generalized TTL Security Mechanism (GTSM) to
ensure exchange security between BGP peers.
BGP Authentication
BGP authentication includes Message Digest 5 (MD5) authentication and keychain
authentication, which improves communication security between BGP peers. In
MD5 authentication, you can only set the authentication password for a TCP
connection. In keychain authentication, you can set the authentication password
for a TCP connection and authenticate BGP messages.
BGP GTSM
BGP GTSM checks whether the time to live (TTL) value in the IP packet header is
within a predefined range. It permits or discards the packets with TTL values
outside of the predefined range to protect services above the IP layer. BGP GTSM
enhances system security.
Assume that the TTL value range of packets from BGP peers is set to 254-255.
When an attacker forges valid BGP packets and keeps sending these packets to
attack a device, the TTL values of these packets are smaller than 254. If BGP
GTSM is not enabled on the device, the device finds that these packets are
destined for itself and sends the packets to the control plane for processing. Then
the control layer needs to process a large number of such attack packets, causing
high CPU usage. If BGP GTSM is enabled on the device, the system checks the TTL
values in all BGP packets and discards the attack packets with TTL values smaller
than 254. This prevents network attack packets from consuming CPU resources.
9.2.5 BGP Route Selection Rules and Load Balancing
When multiple routes are available to the same destination, BGP selects one
optimal route based on BGP route selection rules and adds it to the IP routing
table for traffic forwarding. Figure 9-4 shows how the optimal route is selected.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 690
Figure 9-4 BGP route selection process
BGP selects routes by comparing route attributes in a fixed order. When a route
attribute is a sufficient condition for determining the optimal route, BGP does not
compare the other attributes; If BGP fails to select the optimal route after
comparing all route attributes, the route that was first received is selected as the
optimal route. Table 9-1 lists the abbreviated alias, route selection rules, and
remarks of each matching item. Table 9-1 shows that the route priority is directly
proportional to the PreVal or Local_Pref value and inversely proportional to the
rest of the attribute values or lengths. In addition, the first column can be
summarized as a character string (PPAAA OMTCC RA), which helps memorize the
matching sequence.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 691
Table 9-1 BGP route selection process
Abbr
eviat
ed
Alias
Matching
Item
Route Selection
Rules
Remarks
P PrefVal The route with the
largest PreVal value is
preferred.
The default value is 0.
PrefVal is Huawei-specific and
valid only on the device where it
is configured.
P Local_Pref The route with the
largest Local_Pref
value is preferred.
The default value is
100.
To modify the default Local_Pref
value of BGP routes, run the
default local-preference
command.
A
NOTE
A is
the
initi
al of
the
char
acte
r
strin
g
(AS
NIL).
Route type A > S > N > I > L, in
which:
● A: indicates that
routes are
summarized using
the aggregate
command.
● S: indicates that
routes are
summarized using
the summary
automatic
command.
● N: indicates that
routes are
imported using the
network
command.
● I: indicates that
routes are
imported using the
import-route
command.
● L: indicates that
routes are learned
from BGP peers.
-
A AS_Path The route with the
shortest AS_Path
length is preferred.
If the bestroute as-path-ignore
command is configured, BGP
does not compare the AS_Path
attribute.
O Origin IGP > EGP >
Incomplete
-
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 692
Abbr
eviat
ed
Alias
Matching
Item
Route Selection
Rules
Remarks
M Multi Exit
Discriminat
or (MED)
The route with the
smallest MED value is
preferred.
The default value is 0.
If the bestroute med-none-as-
maximum command is
configured, BGP considers the
largest MED value (4294967295)
as the MED of the route that
does not carry an MED.
T Peer type EBGP > IBGP Prefers EBGP routes, IBGP routes,
LocalCross routes, and
RemoteCross routes, which are
listed in descending order of
priority.
LocalCross allows a PE to add
the VPNv4 route of a VPN
instance to the routing table of
the VPN instance if the export
RT of the VPNv4 route matches
the import RT of another VPN
instance on the PE. RemoteCross
allows a local PE to add the
VPNv4 route learned from a
remote PE to the routing table
of a VPN instance on the local
PE if the export RT of the VPNv4
route matches the import RT of
the VPN instance.
C IGP cost The route with the
smallest IGP cost is
preferred.
If there are multiple routes to
the same destination, an IGP
calculates the route metric using
its routing algorithm.
If the bestroute igp-metric-
ignore command is configured,
BGP does not compare the IGP
cost.
C Cluster_List The route with the
shortest Cluster_List
length is preferred.
By default, Cluster_List takes
precedence over Originator_ID
during BGP route selection. To
enable Originator_ID to take
precedence over Cluster_List
during BGP route selection, run
the bestroute routerid-prior-
clusterlist command.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 693
Abbr
eviat
ed
Alias
Matching
Item
Route Selection
Rules
Remarks
R Router ID The route with the
smallest router ID is
preferred.
If routes carry the Originator_ID,
the originator ID is substituted
for the router ID during route
selection. The route with the
smallest Originator_ID is
preferred.
A Peer IP
address
The route learned
from the peer with
the smallest IP
address is preferred.
-
Selection of the Routes for Load Balancing
After BGP load balancing is configured, the BGP routes that meet the following
conditions are used as equal-cost routes for load balancing:
● The routes have the same PrefVal value.
● The routes have the same Local_Pref value.
● All the routes are summarized or non-summarized routes.
● The routes have the same AIGP value.
● The routes have the same AS_Path length.
● The routes have the same origin type (IGP, EGP, or incomplete).
● The routes have the same MED value.
● All the routes are EBGP or IBGP routes. After the maximum load-balancing
eibgp command is run, BGP ignores this limitation when selecting the
optimal VPN route.
● The costs of the IGP routes to which the BGP routes are recursed within an AS
are the same. After the maximum load-balancing eibgp command is run,
BGP ignores this limitation when selecting the optimal VPN route.
In addition, BGP labeled routes and non-labeled routes cannot load-balance traffic
even if they meet the preceding conditions.
VPN Route Selection Rules
BGP VPN routes are selected in the same way as BGP public routes except that
VPN target-based route crossing is implemented first on BGP VPN routes.
9.2.6 Route Reflector
To ensure connectivity between IBGP peers, you need to establish full-mesh
connections between IBGP peers. If there are n devices in an AS, n(n-1)/2 IBGP
connections need to be established. When there are a large number of devices,
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 694
many network resources and CPU resources are consumed. A route reflector (RR)
can be used between IBGP peers to solve this problem.
Roles in RR
As shown in Figure 9-5, the following roles are involved in RR scenarios in an AS.
Figure 9-5 Networking diagram of the RR
● Route reflector (RR)
A BGP device that can reflect the routes learned from an IBGP peer to other
IBGP peers. An RR is similar to a designated router (DR) on an OSPF network.
● Client
An IBGP device whose routes are reflected by the RR to other IBGP devices. In
an AS, clients need to connect only to the RR directly.
● Non-client
An IBGP device that is neither an RR nor a client. In an AS, a non-client must
establish full-mesh connections with the RR and all the other non-clients.
● Originator
A device that originates routes in an AS. The Originator_ID attribute helps
eliminate routing loops in a cluster.
● Cluster
A set of the RR and clients. The Cluster_List attribute helps eliminate routing
loops between clusters.
RR Principles
Clients in a cluster need to exchange routing information only with the RR in the
same cluster. Therefore, clients need to establish IBGP connections only with the
RR. This reduces the number of IBGP connections in the cluster. As shown in
Figure 9-5, in AS 65000, Cluster1 is composed of an RR and three clients. The
number of IBGP connections in AS 65000 is then reduced from 10 to 4, which
simplifies the device configuration and reduces the loads on the network and CPU.
The RR allows a BGP device to advertise the BGP routes learned from an IBGP
peer to other IBGP peers, and uses the Cluster_List and Originator_ID attributes to
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 695
eliminate routing loops. The RR advertises routes to IBGP peers based on the
following rules:
● The RR advertises the routes learned from a non-client to all the clients.
● The RR advertises the routes learned from a client to all the other clients and
all the non-clients.
● The RR advertises the routes learned from an EBGP peer to all the clients and
non-clients.
Cluster_List Attribute
An RR and its clients form a cluster, which is identified by a unique cluster ID in an
AS. To prevent routing loops between clusters, an RR uses the Cluster_List
attribute to record the cluster IDs of all the clusters that a route passes through
based on the following rules:
● When a route is reflected by an RR for the first time, the RR adds the local
cluster ID to the top of the cluster list. If there is no cluster list, the RR creates
a Cluster_List attribute.
● When receiving an updated route, the RR checks the cluster list of the route. If
the cluster list contains the local cluster ID, the RR discards the route. If the
cluster list does not contain the local cluster ID, the RR adds the local cluster
ID to the cluster list and then reflects the route.
Originator_ID Attribute
An originator ID identifies the originator of a route and is generated by an RR to
prevent routing loops in a cluster. Its value is the same as a router ID.
When a route is reflected by an RR for the first time, the RR adds the
Originator_ID attribute to this route. The Originator_ID attribute identifies the
originator of the route. If the route contains the Originator_ID attribute, the RR
retains this Originator_ID attribute.
When a device receives a route, the device compares the originator ID of the route
with the local router ID. If they are the same, the device discards the route.
Backup RR
To ensure network reliability and prevent single-point failures, a cluster requires
redundant RRs. An RR allows a BGP device to advertise the routes received from
an IBGP peer to other IBGP peers. Therefore, routing loops may occur between
RRs in the same cluster. To prevent this, all the RRs in the cluster must use the
same cluster ID.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 696
Figure 9-6 Backup RR
As shown in Figure 9-6, RR1 and RR2 reside in the same cluster and have the
same cluster ID configured.
● When Client1 receives an updated route from an EBGP peer, Client1 advertises
this route to RR1 and RR2 using IBGP.
● After RR1 and RR2 receive this route, they add the local cluster ID to the top
of the cluster list of the route and then reflect the route to other clients
(Client2 and Client3) and to each other.
● After RR1 and RR2 receive the reflected route from each other, they check the
cluster list of the route, finding that the cluster list contains their local cluster
IDs. RR1 and RR2 discard this route to prevent routing loops.
RRs of Multiple Clusters in an AS
If there are multiple clusters in an AS, RRs of the clusters establish IBGP peer
relationships. When RRs reside at different network layers, an RR at the lower
network layer can be configured as a client to implement hierarchical RR. When
RRs reside at the same network layer, RRs of different clusters can establish full-
mesh connections to implement flat RR.
Hierarchical RR
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 697
Figure 9-7 Hierarchical RR
In practice, hierarchical RR is often used. As shown in Figure 9-7, the ISP provides
Internet routes to AS 100. AS 100 is divided into two clusters, Cluster1 and
Cluster2. Four devices in Cluster1 are core routers and use a backup RR to ensure
reliability.
Flat RR
Figure 9-8 Flat RR
As shown in Figure 9-8, the backbone network is divided into multiple clusters.
RRs of the clusters are non-clients and establish full-mesh connections with each
other. Although each client only establishes an IBGP connection with its RR, all the
RRs and clients can receive all routing information.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 698
9.2.7 BGP Confederation
In addition to a route reflector, the confederation is another method that reduces
the number of IBGP connections in an AS. A confederation divides an AS into sub-
ASs. Full-mesh IBGP connections are established in each sub-AS. EBGP connections
are established between sub-ASs. ASs outside a confederation still consider the
confederation as an AS. After a confederation divides an AS into sub-ASs, it
assigns a confederation ID (the AS number) to each router within the AS. This
brings two benefits.
● Original IBGP attributes are retained, including the Local_Pref attribute, MED
attribute, and Next_Hop attribute.
● Confederation-related attributes are automatically deleted when being
advertised outside a confederation.
Therefore, the administrator does not need to configure the rules for filtering
information such as sub-AS numbers at the egress of a confederation.
Figure 9-9 Networking diagram of a confederation
As shown in Figure 9-9, AS 100 is divided into three sub-ASs after a confederation
is configured: AS65001, AS65002, and AS65003. The AS number AS 100 is used as
the confederation ID. In Figure 9-9, to implement route transmission and packet
forwarding, 10 IBGP connections are required if a logical full mesh is used. If the
confederation is used, only two IBGP connections and two EBGP connections are
required. Therefore, using the confederation simplifies the device configuration
and reduces the network and CPU burden. In addition, BGP devices outside AS 100
only know the existence of AS 100 but not the confederation within AS 100.
Therefore, the confederation does not increase the CPU load.
Comparisons Between a Route Reflector and a Confederation
Table 9-2 compares a route reflector and a confederation in terms of the
configuration, device connection, and applications.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 699
Table 9-2 Comparisons between a route reflector and a confederation
Route Reflector Confederation
Retains the existing network topology
and ensures compatibility.
Requires the logical topology to be
changed.
Requires only a route reflector to be
configured because clients do not need
to know that they are clients of a
route reflector.
Requires all devices to be reconfigured.
Requires full-mesh connections
between clusters.
Does not require full-mesh
connections between sub-ASs of a
confederation because the sub-ASs are
special EBGP peers.
Applies to medium and large
networks.
Applies to large networks.
9.2.8 Route Summarization
The BGP routing table of each device is large on large networks. This burdens
devices, increases the route flapping probability, and affects network stability.
Route summarization is a mechanism that combines multiple routes into one
route. This mechanism allows a BGP device to advertise only the summarized
route but not all the specific routes to peers, thereby reducing the size of the BGP
routing table. If the summarized route flaps, the network is not affected,
improving network stability.
BGP supports automatic summarization and manual summarization on IPv4
networks, and supports only manual summarization on IPv6 networks. Automatic
and manual summarization work as follows:
● Automatic summarization
Summarizes the routes imported by BGP. After automatic summarization is
configured, BGP summarizes routes based on the natural network segment
and advertises only the summarized route to peers. For example, BGP
summarizes 10.1.1.1/24 and 10.2.1.1/24 (two Class A addresses with non-
natural mask) into 10.0.0.0/8 (Class A address with natural mask).
● Manual summarization
Summarizes routes in the local BGP routing table. Manual summarization can
help control the attributes of the summarized route and determine whether
to advertise specific routes.
To prevent routing loops caused by route summarization, BGP uses the AS_Set
attribute. The AS_Set attribute is an unordered set of all ASs that a route passes
through. When the summarized route enters an AS in the AS_Set attribute again,
BGP finds that the local AS number has been recorded in the AS_Set attribute of
the route and discards this route to prevent a routing loop.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 700
9.2.9 Route Dampening
When BGP is used on complex networks, route flapping occurs frequently. To
prevent this, BGP uses route dampening to suppress unstable routes.
Route flapping is a process of adding a route to an IP routing table and then
withdrawing this route. When route flapping occurs, a BGP device sends an
Update message to its neighbors. The devices that receive the Update message
need to recalculate routes and modify routing tables. Frequent route flapping
consumes lots of bandwidths and CPU resources and even affects normal network
operation.
Figure 9-10 Diagram of BGP route dampening
Route dampening measures the stability of a route using a penalty value. A larger
penalty value indicates a less stable route. In Figure 9-10, each time route
flapping occurs, BGP increases the penalty of this route by a value of 1000. When
the penalty value of a route exceeds the suppression threshold, BGP suppresses
this route, and does not add it to the IP routing table or advertise any Update
message to peers. After a route is suppressed for a period of time (half-life), the
penalty value is reduced by half. When the penalty value of a route decreases to
the reuse threshold, the route is reusable and is added to the routing table. At the
same time, BGP advertises an Update message to peers. The suppression time is
the period from when a route is suppressed to when the route is reusable.
Route dampening applies only to EBGP routes but not IBGP routes. IBGP routes
may include the routes of the local AS, and an IGP network requires that the
routing tables of devices within an AS be the same. If IBGP routes are dampened,
routing tables on devices are inconsistent when these devices have different
dampening parameters. Therefore, route dampening does not apply to IBGP
routes.
9.2.10 BFD for BGP
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 701
BGP periodically sends messages to peers to detect the status of the peers. It takes
more than 1 second for this detection mechanism to detect a fault. When data is
transmitted at gigabit rates, long-time fault detection will cause packet loss. This
cannot meet high reliability requirements of networks. Bidirectional Forwarding
Detection (BFD) provides the millisecond-level fault detection for BGP to improve
network reliability.
Figure 9-11 Networking diagram of BFD for BGP
As shown in Figure 9-11, RouterA belongs to AS 100 and RouterB belongs to AS
200. RouterA and RouterB are directly connected and establish the EBGP peer
relationship. Association between BGP and BFD is configured on RouterA and
RouterB. When a fault occurs on the link between RouterA and RouterB, BFD can
rapidly detect that the BFD session changes from Up to Down and notify this fault
to RouterA and RouterB. RouterA and RouterB process the neighbor Down event
and select routes again using BGP.
9.2.11 BGP Tracking
BGP tracking provides fast link fault detection to speed up network convergence.
When a fault occurs on the link between BGP peers that have BGP tracking
configured, BGP tracking can quickly detect peer unreachability and instruct the
routing management module to notify BGP of the fault, achieving rapid network
convergence.
Compared to BFD, BGP tracking is easy to configure because it needs to be
configured only on the local device. BGP tracking is a fault detection mechanism
at the routing layer, whereas BFD is a fault detection mechanism at the link layer.
BGP route convergence on a network where BGP tracking is configured is slower
than that on a network where BFD is configured. Therefore, BGP tracking is not
suitable for voice services that require fast convergence.
Applications
In Figure 9-12, RouterA and RouterB, and RouterB and RouterC establish IGP
connections. RouterA and RouterC establish an IBGP peer relationship. BGP
tracking is configured on RouterA. When a fault occurs on the link between
RouterA and RouterB, IGP performs fast convergence. Subsequently, BGP tracking
detects the unreachability of the route to RouterC and notifies the fault to BGP on
RouterA, which then interrupts the BGP connection with RouterC.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 702
Figure 9-12 Networking diagram of BGP tracking
NOTE
If establishing an IBGP peer relationship requires IGP routes, the interval between peer
unreachability discovery and connection interruption needs to be configured. This interval
must be longer than the IGP route convergence time. Otherwise, before IGP route flapping
caused by transient interruption is suppressed, the BGP peer relationship may have been
interrupted, causing unnecessary BGP convergence.
9.2.12 BGP GR
BGP graceful restart (GR) is high availability solutions that minimize the impact of
device failures on user services.
BGP GR ensures that the forwarding plane continues to guide data forwarding
during a device restart or active/standby switchover. The operations on the control
plane, such as reestablishing peer relationships and performing route calculation,
do not affect the forwarding plane. This mechanism prevents service interruptions
caused by route flapping and improves network reliability.
GR concepts are as follows:
● GR restarter
The device that is restarted by the administrator or triggered by failures to
perform GR.
● GR helper
The neighbor that helps the GR restarter to perform GR.
● GR time
The time during which the GR helper retains forwarding information after
detecting the restart or active/standby switchover of the GR restarter.
The BGP GR process is as follows:
1. Using the BGP capability negotiation mechanism, the GR restarter and helper
know each other's GR capability and establish a GR session.
2. When detecting the restart or active/standby switchover of the GR restarter,
the GR helper waits to reestablish a BGP connection with the GR restarter. It
does not delete the routing information and forwarding entries of the GR
restarter or notify other neighbors of the restart or switchover.
3. The GR restarter reestablishes neighbor relationships with all GR helpers
before the GR time expires.
9.2.13 Dynamic Update Peer-Groups
Currently, the rapid growth in the size of the routing table and the complexity of
the network topology require BGP to support more peers. Especially in the case of
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 703
a large number of peers and routes, high-performance grouping and forwarding
are required when a router needs to send routes to a large number of BGP peers,
most of which share the same outbound policies.
The dynamic update peer-groups feature treats all the BGP peers with the same
outbound policies as an update-group. In this case, routes are grouped uniformly
and then sent separately. That is, each route to be sent is grouped once and then
sent to all peers in the update-group, improving grouping efficiency exponentially.
For example, a route reflector (RR) has 100 clients and needs to reflect 100,000
routes to these clients. If the RR sends the routes grouped per peer to 100 clients,
the total number of times that all routes are grouped is 10,000,000 (100,000 x
100). After the dynamic update peer-groups feature is used, the total number of
grouping times changes to 100,000 (100,000 x 1), improving grouping
performance by a factor of 100.
Applications
BGP uses the dynamic update peer-groups technology when a large number of
peers and routes exist and most peers share the same outbound policies,
improving BGP route grouping and forwarding performance. The dynamic update
peer-groups feature applies to the following scenarios:
● International gateway
As shown in Figure 9-13, the Internet gateway (IGW) router sends routes to
all neighboring ASs. If the IGW router supports the dynamic update peer-
groups feature, its BGP route forwarding performance will be greatly
improved.
Figure 9-13 Networking diagram of the international gateway
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 704
● RR
As shown in Figure 9-14, RRs send routes to all clients. If the RRs support the
dynamic update peer-groups feature, their BGP route forwarding performance
will be greatly improved.
Figure 9-14 Networking diagram of RRs
● ASBR
As shown in Figure 9-15, RouterB, as an Autonomous System Boundary
Router (ASBR), sends all the routes received from an EBGP neighbor RouterA
to all IBGP neighbors. If RouterB supports the dynamic update peer-groups
feature, its BGP route forwarding performance will be greatly improved.
Figure 9-15 Networking diagram of a PE connecting to multiple IBGP
neighbors
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 705
9.2.14 MP-BGP and Address Families
The Border Gateway Protocol 4 (BGP-4) transmits only IPv4 unicast routing
information and cannot transmit routing information for other network layer
protocols, such as IPv6 and multicast protocols.
To support multiple types of network layer protocols, the Internet Engineering
Task Force (IETF) extended BGP-4 to Multiprotocol Extensions for BGP-4 (MP-
BGP). The current MP-BGP standard is RFC 4760. MP-BGP is forward compatible.
Switches that support BGP extension can communicate with switches that do not.
As an enhancement of BGP-4, MP-BGP provides routing information for various
protocols, such as IPv6 (BGP4+) and multicast:
● MP-BGP maintains unicast and multicast routing information, and stores both
types in different routing tables to ensure their separation.
● MP-BGP supports unicast and multicast, and constructs different network
topologies for each.
● MP-BGP can maintain unicast and multicast routes based on routing policies.
The unicast routing policies and configurations supported by BGP-4 can
mostly be applied to multicast.
Extended Attributes
BGP-4 update packets carry three IPv4-related attributes: network layer reachable
information (NLRI), Next_Hop, and Aggregator. Aggregator contains the IP address
of the BGP speaker that performs route aggregation.
To support multiple types of network layer protocols, BGP-4 needs to carry the
information about network layer protocols in NLRI and Next_Hop. MP-BGP
introduces the following route attributes:
● MP_REACH_NLRI: indicates the multiprotocol reachable NLRI, which is used to
advertise a reachable route and the next hop.
● MP_UNREACH_NLRI: indicates the multiprotocol unreachable NLRI, which is
used to withdraw an unreachable route.
The two attributes are optional non-transitive. Therefore, BGP speakers that do
not support multiprotocol ignore the information carried by the two attributes,
and do not advertise the information to peers.
NOTE
Optional non-transitive is a BGP attribute type. If a BGP device does not support this
attribute type, the Update messages with attributes of this type are ignored, and the
messages are not advertised to other peers.
MP_REACH_NLRI
Multiprotocol Reachable NLRI (MP_REACH_NLRI) is used to advertise reachable
routes and information about the next hop. MP_REACH_NLRI is coded as one or
more 3-tuples of the form <Address Family Information, Next Hop Information,
Network Layer Reachability Information>.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 706
Figure 9-16 Format of the MP_REACH_NLRI field
Descriptions of each part of the MP_REACH_NLRI field are as follows:
● Address Family Information: consists of a 2-byte Address Family Identifier
(AFI) and a 1-byte Subsequent Address Family Identifier (SAFI):
– The AFI identifies a network layer protocol. Defined values for this field
are specified in RFC 1700 (Address Family Number). For example, 1
indicates IPv4; 2 indicates IPv6.
– The SAFI indicates the type of the NLRI field.
If the AFI is 1 and the SAFI is 128, the address in the NLRI field is a BGP-
VPNv4 address.
● Next Hop Network Address Information: consists of the 1-byte length of the
next-hop network address and the next-hop network address of a variable
length. A next-hop network address refers to the network address of the next
device on the path to the destination.
● Network Layer Reachable Information: is a variable-length field that lists NLRI
for the routes being advertised. Figure 9-17 shows the format of the NLRI
field.
Figure 9-17 Format of the NLRI field that carries label information
Descriptions of each part of the NLRI field are as follows:
– Length: indicates the total bits of the label and prefix.
– Label: consists of one or more labels. The length of a label is 3 bytes.
– Prefix: In a BGP/Multiprotocol Label Switching (MPLS) IP VPN, the prefix
field consists of a route distinguisher (RD) and IPv4 address prefix.
VPNv4 update messages exchanged between provider edges (PEs) or autonomous
system boundary routers (ASBRs) carry MP_REACH_NLRI. An Update message can
carry multiple reachable routes with the same routing attributes.
MP_UNREACH_NLRI
Multiprotocol Unreachable NLRI (MP_UNREACH_NLRI) is used to inform a peer to
delete unreachable routes. Figure 9-18 shows the format of the attribute.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 707
Figure 9-18 Format of the MP_UNREACH_NLRI field
Descriptions of each part of the MP_UNREACH_NLRI field are as follows:
● AFI: identifies a network layer protocol. AFI uses the address family values
defined in RFC 1700.
● SAFI: indicates the NLRI type and is similar to SAFI in MP_REACH_NLRI.
● Withdrawn Routes: indicates an unreachable route list, which consists of one
or more NLRI fields. In the Withdrawn Routes field, BGP speakers can
withdraw the route by filling the NLRI field in the same manner as that for
the previously advertised reachable route.
Update messages carrying MP_UNREACH_NLRI are sent to withdraw routes. An
Update message can carry information about multiple unreachable routes.
If the labels of routes to be withdrawn are specified in the messages, the routes
with specified labels are withdrawn. If the labels are not specified, only the routes
without labels are withdrawn.
Update messages with MP_UNREACH_NLRI do not carry any path attributes.
Negotiation of the MP-BGP Capability
A BGP device gets to know the negotiation capability of its peer by checking the
capability parameters in Open messages. If the BGP device and its peer support
the same function, the BGP device and its peer communicate using the function.
The optional parameters of the negotiation capability in an Open message consist
of three parts: Capability Code, Capability Length, and Capability Value. Figure
9-19 shows the format of the capability parameters.
Figure 9-19 Format of BGP capability parameters
Descriptions of BGP capability parameters are as follows:
● Capability Code: uniquely identifies the capability type. The value 1 indicates
that the BGP speaker has the MP-BGP capability.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 708
● Capability Length: indicates the length of the capability field. For MP-BGP, the
length of the capability field is 4.
● Capability Value: indicates the value of the capability field. The length is
variable and depends on the type specified in Capability Code. Figure 9-20
shows the format of the Capability Value field:
– The meanings of 2-byte AFI and 1-byte SAFI are the same as those of
MP_REACH_NLRI.
– Res. is a 1-byte reserved field. The sender sets the value to 0, and the
receiver ignores the field.
Figure 9-20 Format of the Capability Value field
At present, BGP does not support dynamic capability negotiation. After a BGP
speaker advertises an Open message with optional capability fields:
● If the speaker receives a Notification message from its peer, the peer does not
support the capability. Then the BGP speaker tears down the session with its
peer and sends an Open message without any optional capability fields to the
peer to attempt a new BGP connection.
● If the peer supports the capability advertisement but the capability fields are
unknown or unsupported, negotiation fails. Then the BGP speaker tears down
the session with its peer, and sends an Open message without the optional
capability fields (but may carry other optional capability fields) to the peer to
attempt a new BGP connection.
After any change in BGP capabilities, such as enabling or disabling label-routing
capabilities, enabling or disabling address family capabilities (IPv4, IPv6, VPNv4,
and VPNv6), and enabling graceful restart (GR) capabilities, the BGP speaker tears
down the session with its peer, and then re-negotiates the capabilities with its
peer.
Address Family
BGP uses address families to differentiate network protocol applications. The
switch supports a wide range of MP-BGP applications. These applications can be
configured in their respective extended BGP address family views.
Table 9-3 lists BGP address families.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 709
Table 9-3 BGP address families
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
IPv4
unicas
t
addre
ss
family
1 1
or
4
Provides the following functions:
● Maintains public network BGP
peer relationships and transmits
public network IPv4 routes. When
a BGP-IPv4 unicast address family
transmits public network IPv4
routes, the SAFI field is 1.
● Transmits public network labeled
IPv4 routes. This function mainly
applies to BGP/MPLS IPv4 VPN or
BGP/MPLS IPv6 VPN in inter-AS
Option C mode. When a BGP-IPv4
unicast address family transmits
public network labeled IPv4
routes, the SAFI field is 4.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
unicast
[HUAWEI-bgp-af-ipv4]
BGP-
IPv4
multic
ast
addre
ss
family
1 2 Allows PEs to maintain multicast
BGP (MBGP) peer relationships. If
the multicast source and receiver are
in two autonomous systems (ASs),
an inter-AS multicast distribution
tree (MDT) must be established.
MBGP can transmit multicast
routing information across ASs.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
multicast
[HUAWEI-bgp-af-multicast]
BGP
VPN
instan
ce
IPv4
addre
ss
family
1 1 Allows BGP to transmit VPN IPv4
routing information between PEs
and CEs in a BGP/MPLS IPv4 VPN
scenario.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
vpn-instance vpna
[HUAWEI-bgp-vpna]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 710
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
VPNv
4
addre
ss
family
1 1
2
8
Allows PEs to establish BGP VPNv4
peer relationships and exchange
VPNv4 routes in a BGP/MPLS IPv4
VPN scenario.
After a PE receives a CE's local VPN
routes, the PE adds an RD and an
export route target (ERT) to these
routes and exchanges them with its
BGP VPNv4 peers. RDs differentiate
the routes from different VPNs, and
route targets (RTs) control the
distribution of VPNv4 routes into
virtual routing and forwarding tables
(VRFs). A PE maintains only routing
information about the VPNs that the
PE accesses and does not maintain
all VPN routes on the service
provider network.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
vpnv4
[HUAWEI-bgp-af-vpnv4]
BGP-
MDT
addre
ss
family
1 6
6
Allows PEs to exchange information
about share-groups and their
multicast sources over BGP sessions
in Protocol Independent Multicast
(PIM) source-specific multicast
(SSM) scenarios.
PIM-SSM can be configured on a
public network only if PEs know the
locations of the multicast sources in
advance. Share-groups are
configured on PEs, but a PE does not
know the multicast tunnel interface
(MTI) addresses of the share-groups
on other PEs. All PEs in a multicast
domain (MD) select an MTI address
that is used to establish the public
network BGP peer relationship as
the multicast source IP address.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
mdt
[HUAWEI-bgp-af-mdt]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 711
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
multic
ast
VPN
(MVP
N)
addre
ss
family
1 5 Applies to MCAST-VPN SAFI A-D.
BGP A-D MVPN has two modes:
MDT-SAFI A-D and MCAST-VPN SAFI
A-D.
In both modes, PEs discover their
peers by sending BGP update
packets that carry MVPN
configurations, such as the RD and
share-group address. BGP A-D
MVPN services can be transmitted
over public tunnels along the PIM-
SSM MDT. Compared with MDT-SAFI
A-D, MCAST-VPN SAFI A-D has a
broader definition, supports more
extensions, and carries more MVPN
attributes and information for
establishing public network tunnels.
MCAST-VPN SAFI A-D supports the
next-generation MVPN.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv4-family
mvpn
[HUAWEI-bgp-af-mvpn]
BGP-
IPv6
unicas
t
addre
ss
family
2 1
or
4
Provides the following functions:
● Maintains public network IPv6
BGP peer relationships and
transmits public network IPv6
routes. When a BGP-IPv6 unicast
address family transmits public
network IPv6 routes, the SAFI
field is 1.
● Transmits labeled IPv6 routes.
This function mainly applies to
6PE scenario. When a BGP-IPv6
unicast address family transmits
labeled IPv6 routes, the SAFI field
is 4.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv6-family
unicast
[HUAWEI-bgp-af-ipv6]
BGP
VPN
instan
ce
IPv6
addre
ss
family
2 1 Allows BGP to transmit VPN IPv6
routing information between PEs
and CEs in a BGP/MPLS IPv6 VPN
scenario.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv6-family
vpn-instance vpna
[HUAWEI-bgp6-vpna]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 712
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
VPNv
6
addre
ss
family
2 1
2
8
Allows PEs to establish BGP VPNv6
peer relationships and exchange
VPNv6 routes in a BGP/MPLS IPv6
VPN scenario.
After a PE receives a CE's local VPN
IPv6 routes, the PE adds an RD and
an ERT to these routes and
exchanges them with its BGP VPNv6
peers. RDs differentiate routes from
different VPNs, and RTs control the
distribution of VPNv6 routes into
VRFs. A PE maintains only routing
information about the VPNs that the
PE accesses and does not maintain
all VPN routes on the service
provider network.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] ipv6-family
vpnv6
[HUAWEI-bgp-af-vpnv6]
BGP-
L2VP
N
addre
ss
family
1
9
6
1
2
8
Allows PEs to manage L2VPN label
blocks. MPLS L2VPN in Kompella
mode uses BGP as the signaling. PEs
on an MPLS L2VPN in Kompella
mode automatically discover their
peer PEs by sending BGP update
packets that carry VPN information
and use RTs to differentiate data
from different VPNs.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] l2vpn-family
[HUAWEI-bgp-af-l2vpn]
BGP-
virtual
privat
e LAN
servic
e
(VPLS
)
addre
ss
family
2
5
6
5
Applies to Kompella VPLS. After you
configure a BGP peer relationship
between two PEs in the BGP-VPLS
address family view, the two PEs can
exchange VPLS label blocks. VPLS is
a point-to-multipoint (P2MP) L2VPN
service provided over a public
network. VPLS can be implemented
in either Kompella or Martini mode.
Kompella VPLS uses BGP as the
signaling, and Martini VPLS uses the
Label Distribution Protocol (LDP) as
the signaling.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] vpls-family
[HUAWEI-bgp-af-vpls]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 713
BGP
Addre
ss
Famil
y
A
FI
S
A
FI
Description Access to BGP
Address Family View
BGP-
L2VP
N-AD
addre
ss
family
2
5
6
5
Allows PEs to support BGP AD VPLS.
BGP AD VPLS has the advantages of
both Kompella VPLS and Martini
VPLS. BGP-AD-VPLS-enabled devices
exchange extended BGP packets to
automatically discover member
virtual switch instances (VSIs) in a
VPLS domain and use LDP FEC 129
to negotiate pseudo wire (PW)
establishment to achieve automatic
VPLS PW deployment.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] l2vpn-ad-
family
[HUAWEI-bgp-af-l2vpn-ad]
BGP-
EVPN
addre
ss
family
view
2
5
7
0
The BGP-EVPN address family view
is mainly used to configure BGP
EVPN peers.
Ethernet virtual private network
(EVPN) is a VPN technology used for
Layer 2 internetworking. EVPN is
similar to BGP/MPLS IP VPN. EVPN
defines a new type of BGP network
layer reachability information
(NLRI), called the EVPN NLRI. The
EVPN NLRI defines new BGP EVPN
routes to implement MAC address
learning and advertisement between
Layer 2 networks at different sites.
<HUAWEI> system-view
[HUAWEI] bgp 65001
[HUAWEI-bgp] l2vpn-family
evpn
[HUAWEI-bgp-af-evpn]
9.2.15 BGP VPN Route Crossing
In a BGP/MPLS IP VPN scenario, after a PE receives BGP VPN routes from a CE or
BGP VPNv4 routes from a remote PE, the local PE implements route crossing to
add desired routes to the routing table of this local VPN instance and sends the
crossed routes to corresponding VPN sites, which concludes route learning in this
scenario. Route crossing can be classified as local route crossing and remote route
crossing based on the source of the BGP VPN route.
● Remote route crossing: After a PE receives a BGP VPNv4 route from a remote
PE, the local PE matches the export target (ERT) of the route against the
import targets (IRTs) configured for local VPN instances. If the ERT matches
the IRT of a local VPN instance, the PE converts the BGP VPNv4 route to a
BGP VPN route and adds the BGP VPN route to the routing table of this local
VPN instance.
● Local route crossing: A PE matches the ERT of a BGP VPN route in a local VPN
instance against the IRTs configured for other local VPN instances. If the ERT
matches the IRT of a local VPN instance, the PE adds the BGP VPN route to
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 714
the routing table of this local VPN instance. Locally crossed routes include
both locally imported routes and routes learned from VPN peers.
After a PE receives VPNv4 routes destined for the same IP address from another
PE or VPN routes from a CE, the local PE implements route crossing by following
the steps in Figure 9-21.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 715
Figure 9-21 Flowchart for BGP VPN route crossing
In Figure 9-22, PEs have the same VPN instance (vpna) and RTs (including the
ERT and IRT). The RD configured for PE2 and PE3 is 2:2, and the RD configured for
PE4 is 3:3. Site 2 has a route destined for 10.1.1.0/24. The route is sent to PE2, PE3,
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 716
and PE4, who convert this route to multiple BGP VPNv4 routes and send them to
PE1. On receipt of the BGP VPNv4 routes, PE1 implements route crossing as shown
in Figure 9-23. The detailed process is as follows:
1. After receiving the BGP VPNv4 routes from PE2, PE3, and PE4, PE1 adds them
to the BGP VPNv4 routing table.
2. The RDs configured for the VPN instance on PE2 and PE3 are the same.
Therefore, the BGP VPNv4 routes that PE2 and PE3 send to PE1 are the same.
On receipt of the BGP VPNv4 routes from PE2 and PE3, PE1 selects an optimal
BGP VPNv4 route (the route from PE3 in this example) from them, converts
the optimal BGP VPNv4 route and the BGP VPNv4 route received from PE4 to
BGP VPN routes by removing their RDs, and adds the BGP VPN routes to the
routing table of the BGP VPN instance.
3. PE1 selects an optimal BGP VPN route from the two BGP VPN routes based
on BGP route selection policies and adds the optimal BGP VPN route to the IP
VPN instance routing table.
NOTE
If a PE receives two BGP VPNv4 routes with the same RD from remote PEs, only one of the
BGP VPNv4 routes can be added to the routing table of the BGP VPN instance. As a result,
VPN FRR or load balancing cannot be implemented between VPN routes.
Figure 9-22 Route crossing networking
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 717
Figure 9-23 BGP VPN route crossing process
9.2.16 Route Processing on the BGP router
Figure 9-24 shows the route processing on the BGP router. BGP routes can be
imported from other protocols or learned from BGP peers. Route summarization
can be configured to reduce the routing table size before routes are selected,
advertised, and delivered to the IP routing table.
Figure 9-24 Route processing on the BGP router
Table 9-4 lists some key points for Figure 9-24.
Table 9-4 Key points for route processing
No. Remarks
1 BGP can import direct routes, static routes, user network routes, and IGP
routes based on the import-route (BGP) or network command
configuration.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 718
No. Remarks
2 BGP can use routing policies when importing routes from other protocols,
receiving routes from BGP peers, or advertising routes to BGP peers.
Routing policies can be used to filter routes or modify route attributes.
3 BGP supports automatic and manual summarization. Multiple routing
policies can be used during manual summarization.
4 BGP selects routes based on strict route selection rules, which is the key
point to be discussed in the following part.
5 BGP adds the optimal route to the BGP routing table and advertises it to
BGP peers.
6 BGP adds the routes learned from peers and the optimal route in the BGP
routing table to the IP routing table for traffic forwarding.
9.2.17 BGP Routing Table
Table 9-5 lists all the common route attributes that affect BGP route selection and
the commands that are used to check them.
Table 9-5 Commands used to check route attributes
Route
Attribute
Command Used to Check the Route Attribute
PrefVal display bgp routing-table [
network ]
Local_Pref display bgp routing-table [
network ]
Route type display bgp routing-table
network
AS_Path display bgp routing-table [
network ]
Origin display bgp routing-table [
network ]
MED display bgp routing-table [
network ]
Peer type display bgp routing-table
network
IGP cost ● display bgp routing-table
network
● display ip routing-table
ip-address [
mask |
mask-length ]
[ verbose ], in which
ip-address is the next hop IP address of a
BGP route
Cluster_List display bgp routing-table
network
Originator_I
D
display bgp routing-table
network
Router ID display bgp routing-table
network
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 719
Route
Attribute
Command Used to Check the Route Attribute
Peer IP
address
display bgp routing-table
network
The following example describes how to check BGP route attributes in the display
bgp routing-table command output.
<HUAWEI> display bgp routing-table
BGP Local router ID is 192.168.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 9
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
*>i 2.2.2.7/32 10.1.1.2 0 100 0 (65001)i
* i 10.1.3.1 0 100 0 (65011 65001)i
*>i 2.2.2.8/32 10.1.2.2 0 100 0 (65011)i
* i 10.1.3.2 0 100 0 (65001 65011)i
*>i 2.2.2.9/32 10.1.4.2 0 100 0 (65001 65101)i
* i 10.1.5.2 0 100 0 (65011 65101)i
i 3.3.3.9/32 10.1.6.2 0 100 0 (65001 65101) 300i
i 10.1.6.2 0 100 0 (65011 65001 65101) 300i
Table 9-6 Description of the display bgp routing-table command output
Item Description
BGP Local
router ID is
192.168.2.2 Router ID: 192.168.2.2, in the same format as an IPv4 address
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 720
Item Description
Status
codes
Route status code, displayed in front of each route entry:
● *: indicates a valid route with a reachable next hop address.
● >: indicates an optimal route selected by BGP.
● d: indicates a dampened route.
● h: indicates a History route.
● i: indicates a route learned from an IBGP peer.
● s: indicates a suppressed route. If specific routes for route
summarization are suppressed, s is displayed in front of each
specific route.
● S: indicates a route in Stale status, and the route is being
deleted. Such routes may occur during a BGP GR process.
BGP dampening measures route stability using a penalty value.
The greater the penalty value, the less stable a route. Each time
route flapping occurs (a device receives a Withdraw or an Update
packet), BGP adds a penalty value to the route carried in the
packet.
When the penalty value of a route exceeds the Suppress value,
BGP suppresses the route by replacing the > sign of the route with
the d or h sign. The route is ignored and its Update packets are
not advertised to other BGP peers until the penalty value of the
route decreases to the Reuse value.
● If d is displayed in front of a route, the route is carried in an
Update packet.
● If h is displayed in front of a route, the route is carried in a
Withdraw packet.
The penalty value is not increased after it reaches the suppression
threshold. The penalty value of a suppressed route reduces by half
after a half-life period.
● When the penalty value of a route with the d sign decreases to
the Reuse value, the route becomes reusable, and BGP removes
the d sign, adds the route to the IP routing table, and
advertises an Update packet carrying the route to BGP peers.
● When the penalty value of a route with the h sign decreases to
0, BGP deletes this route from the BGP routing table.
Origin
Route origin code, displayed in front of each route entry:
● IGP: indicates that routes are added to the BGP routing table
using the network (BGP) command.
● EGP: indicates that routes are learned through the EGP
protocol.
● Incomplete: indicates that routes are added to the BGP routing
table using the import-route (BGP) command.
Network Network address in the BGP routing table
NextHop Next hop address
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 721
Item Description
MED MED value of a BGP route, similar to the cost of IGP routes
LocPrf Local_Pref
PrefVal PrefVal
Path/Ogn AS_Path and Origin attributes
Information about Next_Hop, MED, Local_Pref, PrefVal, AS_Path, and Origin can be
displayed using the display bgp routing-table command. To check information
about the route type, peer type, IGP cost, Cluster_List, router ID, and peer IP
address, run the display bgp routing-table
network command.
<HUAWEI> display bgp routing-table 10.1.1.1
BGP local router ID : 192.168.2.2
Local AS number : 65001
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.1/32:
From: 10.1.3.1 (192.168.2.3)
Route Duration: 05h35m04s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet1/0/4
Original nexthop: 10.1.3.1
Qos information : 0x0
AS-path Nil, origin incomplete, MED 1234, localpref 100, pref-val 0, valid, internal, best, select, active,
pre 255, IGP cost 1
Not advertised to any peer yet
Table 9-7 Description of the display bgp routing-table command output
Item Description
BGP local router
ID
Router ID of the local device, in the same format as an IPv4
address.
Local AS
number
Local AS number.
Paths BGP route information.
BGP routing
table entry
information of
10.1.1.1/32
Information about the BGP route 10.1.1.1/32:
From IP address of the device that advertised the route. In this
example, 10.1.3.1 is the IP address of the interface used by
the peer to establish the BGP peer relationship (peer IP
address), and 192.168.2.3 is the router ID of the peer.
Route Duration Duration of a route.
Relay IP
Nexthop
IP address of the route to which the BGP route is recursed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 722
Item Description
Relay IP Out-
Interface
Outbound interface of the route to which the BGP route is
recursed.
Original nexthop Original next hop IP address.
Qos information QoS information.
AS-path AS_Path attribute. If Nil is displayed, the AS_Path attribute is
null.
origin
incomplete
Origin attribute:
● IGP: indicates that routes are added to the BGP routing
table using the network (BGP) command.
● EGP: indicates that routes are learned through the EGP
protocol.
● Incomplete: indicates that routes are imported using the
import-route (BGP) command.
MED MED value of a BGP route, similar to the cost of IGP routes.
localpref Local_Pref
pref-val PrefVal
valid Valid route with a reachable next hop address.
internal Type of the peer from which the route is learned.
● external: indicates that the route is learned from an EBGP
peer.
● internal: indicates that the route is learned from an IBGP
peer.
best Optimal route.
select Selected route to be delivered to the IP routing table.
NOTE
According to BGP selection rules, BGP selects only one optimal route,
and this route is marked with best. In load balancing or FRR
scenarios, more than one route needs to be added to the IP routing
table, and each of the route is marked with select. Therefore, the
number of the route marked with best is 1, and the number of the
routes marked with select is the actual number of routes added to
the IP routing table.
active Active route.
pre 255 Protocol priority of the route: 255
Not advertised
to any peer yet
The route has not advertised to any peer yet.
The display bgp routing-table
network [ {
mask |
mask-length } [ longer-
prefixes ] ] command output varies with the route generation mode and
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 723
transmission mode, and not all BGP attributes are necessarily displayed. In the
preceding example, the route type is not displayed because the route 10.1.1.1/32 is
an IBGP route. For example:
<HUAWEI> display bgp routing-table 10.0.0.0
BGP local router ID : 192.168.2.4
Local AS number : 200
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.0.0.0/8:
Aggregated route.
Route Duration: 04h50m46s
Direct Out-interface: NULL0
Original nexthop: 127.0.0.1
Qos information : 0x0
AS-path {65001 10 100}, origin incomplete, pref-val 0, valid, local, best, select, active, pre 255
Aggregator: AS 200, Aggregator ID 192.168.2.4, Atomic-aggregate
Advertised to such 3 peers:
10.1.7.2
172.16.1.2
192.168.1.2
The route 10.0.0.0/8 was manually summarized using the aggregate command.
Therefore, Aggregated route is displayed in the command output. The route type
varies as follows:
● If the route is automatically summarized using the summary automatic
command, Summary automatic route will be displayed.
● If the route is imported using the network command, Network route will be
displayed.
● If the route is imported using the import-route command, Imported route
will be displayed.
In the following example, an RR and a cluster are configured. Therefore, the
Cluster_List attribute is displayed in the display bgp routing-table
network
[ {
mask |
mask-length } [ longer-prefixes ] ] command output.
<HUAWEI> display bgp routing-table 10.2.1.0
BGP local router ID : 4.4.4.4
Local AS number : 65010
Paths: 1 available, 0 best, 0 select
BGP routing table entry information of 10.2.1.0/24:
From: 10.1.4.1 (2.2.2.2)
Route Duration: 00h00m14s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface:
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, internal, pre 255
Originator: 1.1.1.1
Cluster list: 0.0.0.1
Not advertised to any peer yet
9.2.18 Route Attributes
9.2.18.1 BGP Route Attributes
There may be multiple routes to the same destination in a BGP routing table. BGP
will select one route as the optimal route and advertise it to peers. To select the
optimal route among these routes, BGP compares the BGP attributes of the routes
in sequence based on route selection rules.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 724
BGP Attributes
Route attributes describe routes. BGP route attributes are classified into the
following types. Table 9-8 lists common BGP attributes.
● Well-known mandatory attribute
All BGP devices can identify this type of attribute, which must be carried in
Update messages. Without this type of attribute, errors occur in routing
information.
● Well-known discretionary attribute
All BGP devices can identify this type of attribute, which is optional in Update
messages. Errors do not occur in routing information even if there is a lack of
this type of attribute.
● Optional transitive attribute
This type of attribute can be transmitted between ASs. A BGP device may not
identify this type of attribute but still accepts and advertises them to peers.
● Optional non-transitive attribute
A BGP device may not identify this type of attribute, in which case it ignores
them without advertising them to peers.
Table 9-8 Common BGP attributes
Attribute Type
Origin Well-known mandatory
AS_Path Well-known mandatory
Next_Hop Well-known mandatory
Local_Pref Well-known discretionary
Community Optional transitive
MED Optional non-transitive
Originator_ID Optional non-transitive
Cluster_List Optional non-transitive
The following describes common BGP route attributes:
● Origin
The Origin attribute defines the origin of a route and marks the path of a
BGP route. The Origin attribute is classified into three types:
– IGP
A route with IGP as the Origin attribute has the highest priority. The
Origin attribute of the routes imported into a BGP routing table using the
network command is IGP.
– EGP
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 725
A route with EGP as the Origin attribute has the second highest priority.
The Origin attribute of the routes obtained through EGP is EGP.
– Incomplete
A route with Incomplete as the Origin attribute has the lowest priority.
The Origin attribute of the routes learned by other means is Incomplete.
For example, the Origin attribute of the routes imported by BGP using
the import-route command is Incomplete.
● AS_Path
The AS_Path attribute records all of the ASs that a route passes through from
the source to the destination in the vector order. To prevent inter-AS routing
loops, a BGP device does not receive the routes whose AS_Path list contains
the local AS number.
When a BGP speaker advertises an imported route:
– If the route is advertised to EBGP peers, the BGP speaker creates an
AS_Path list containing the local AS number in an Update message.
– If the route is advertised to IBGP peers, the BGP speaker creates an
empty AS_Path list in an Update message.
When a BGP speaker advertises a route learned in the Update message sent
by another BGP speaker:
– If the route is advertised to EBGP peers, the BGP speaker adds the local
AS number to the leftmost of the AS_Path list. According to the AS_Path
list, the BGP speaker that receives the route can determine the ASs
through which the route passes to reach the destination. The number of
the AS that is nearest to the local AS is placed on the top of the AS_Path
list. The other AS numbers are listed according to the sequence in which
the route passes through ASs.
– If the route is advertised to IBGP peers, the BGP speaker does not change
the AS_Path attribute of the route.
● Next_Hop
The Next_Hop attribute records the next hop that a route passes through. The
Next_Hop attribute of BGP is different from that of an IGP because it may not
be a neighboring IP address. A BGP speaker processes the Next_Hop attribute
based on the following rules:
– When advertising a route to an EBGP peer, a BGP speaker sets the
Next_Hop attribute of the route to the address of the local interface
through which the BGP peer relationship is established.
– When advertising a locally originated route to an IBGP peer, the BGP
speaker sets the Next_Hop attribute of the route to the address of the
local interface through which the BGP peer relationship is established.
– When advertising a route learned from an EBGP peer to an IBGP peer, the
BGP speaker does not change the Next_Hop attribute of the route.
● Local_Pref
The Local_Pref attribute indicates the BGP preference of a device and helps
determine the optimal route when traffic leaves an AS. When a BGP device
obtains multiple routes to the same destination address but with different
next hops from different IBGP peers, the BGP device prefers the route with the
highest Local_Pref. The Local_Pref attribute is exchanged only between IBGP
peers and is not advertised to other ASs. The Local_Pref attribute can be
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 726
manually configured. If no Local_Pref attribute is configured for a route, the
Local_Pref attribute of the route uses the default value 100.
● MED
The multi-exit discriminator (MED) attribute helps determine the optimal
route when traffic enters an AS. When a BGP device obtains multiple routes to
the same destination address but with different next hops from EBGP peers,
the BGP device selects the route with the smallest MED value as the optimal
route.
The MED attribute is exchanged only between two neighboring ASs. The AS
that receives the MED attribute does not advertise it to any other ASs. The
MED attribute can be manually configured. If no MED attribute is configured
for a route, the MED attribute of the route uses the default value 0.
● Community
The Community attribute:
– Identifies the BGP routes with the same characteristics.
– Simplifies the applications of routing policies.
– Facilitates route maintenance and management.
The Community attribute includes self-defined community attributes and
well-known community attributes. Table 9-9 lists well-known community
attributes.
Table 9-9 Well-known community attributes
Community
Attribute
Value Description
Internet 0
(0x00000000)
A BGP device can advertise the
received route with the Internet
attribute to all peers.
No_Advertise 4294967042
(0xFFFFFF02)
A BGP device does not advertise the
received route with the No_Advertise
attribute to any peer.
No_Export 4294967041
(0xFFFFFF01)
A BGP device does not advertise the
received route with the No_Export
attribute to devices outside the local
AS.
No_Export_Subc
onfed
4294967043
(0xFFFFFF03)
A BGP device does not advertise the
received route with the
No_Export_Subconfed attribute to
devices outside the local AS or to
devices outside the local sub-AS.
● Originator_ID and Cluster_List
The Originator_ID attribute and Cluster_List attribute help eliminate loops in
route reflector scenarios. For details, see 9.2.6 Route Reflector.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 727
9.2.18.2 Next_Hop
Unlike the Next_Hop attribute in an IGP, the Next_Hop attribute in BGP is not
necessarily the IP address of a neighboring device. In most cases, the Next_Hop
attribute in BGP complies with the following rules:
● When advertising a route to an EBGP peer, a BGP speaker sets the Next_Hop
of the route to the address of the local interface through which the BGP peer
relationship is established.
● When advertising a locally generated route to an IBGP peer, a BGP speaker
sets the Next_Hop of the route to the address of the local interface through
which the BGP peer relationship is established.
● When advertising a route learned from an EBGP peer to an IBGP peer, the
BGP speaker does not modify the Next_Hop of the route.
Modifying the Next_Hop
In some scenarios, the Next_Hop needs to be modified. Table 9-10 describes
whether the Next_Hop needs to be modified in specific scenarios.
Table 9-10 Next_Hop processing
Objectives Command Usage Scenarios Remarks
To enable an
ASBR to
modify the
Next_Hops
of the routes
to be
advertised to
IBGP peers.
peer {
group-
name |
ipv4-
address |
ipv6-
address } next-
hop-local
By default, when an
ASBR forwards a route
learned from an EBGP
peer to its IBGP peers,
the ASBR does not
change the Next_Hop
of the route. Therefore,
the Next_Hop address
of the route remains
the EBGP peer IP
address. After being
forwarded to the IBGP
peers, the route cannot
become active as the
Next_Hop is
unreachable. To
address this issue,
configure the ASBR to
modify the Next_Hop
of the route to the
local IP address before
advertising the route
to IBGP peers. After
being forwarded to the
IBGP peers, the route
can be active because
the Next_Hop is
reachable (an IGP is
configured in the AS).
If BGP load
balancing has
been configured
using the
maximum load-
balancing
number
command, the
switch modifies
the Next_Hop of
each route to the
local IP address
through which the
IBGP peer
relationship is
established before
it advertises the
route to IBGP
peers, regardless
of whether the
peer next-hop-
local command is
configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 728
Objectives Command Usage Scenarios Remarks
To prevent a
device from
modifying
the
Next_Hops
of the routes
imported
from an IGP
before
advertising
the routes to
IBGP peers.
peer {
ipv4-
address |
group-
name } next-hop-
invariable
- By default, a
device modifies
the Next_Hops of
the routes
imported from an
IGP to the local IP
address before
advertising the
routes to IBGP
peers.
To prevent a
device from
modifying
the
Next_Hops
of routes
before
advertising
the routes to
EBGP peers.
peer {
ipv4-
address |
group-
name } next-hop-
invariable
In an inter-AS VPN
Option C scenario
where an RR is used,
the peer next-hop-
invariable command
needs to be run on the
RR to prevent the RR
from modifying the
Next_Hops of routes
before advertising the
routes to EBGP peers.
This ensures that the
remote PE recurses
routes to the LSP
destined for the local
PE during traffic
transmission.
By default, a
device modifies
the Next_Hops of
routes to the local
IP address before
advertising the
routes to EBGP
peers.
In addition, a
device does not
modify the
Next_Hops of
non-labeled
routes if the
routes are learned
from EBGP peers
and are to be
advertised to IBGP
peers; the device
sets its interface
IP address as the
Next_Hops of
labeled routes if
the routes are
learned from
EBGP peers and
are to be
advertised to IBGP
peers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 729
Objectives Command Usage Scenarios Remarks
To configure
BGP
Next_Hop
recursion
based on a
route-policy.
nexthop
recursive-lookup
route-policy
route-policy-name
To enable a device to
recurse only desired
routes, configure
Next_Hop recursion
based on a specified
route-policy so that
only the routes that
match the route-policy
are recursed.
By default,
Next_Hop
recursion based
on a specified
route-policy is not
configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 730
Objectives Command Usage Scenarios Remarks
To enable a
device to
modify the
Next_Hops
of BGP
routes using
a route-
policy.
apply ip-address
next-hop{
ipv4-
address | peer-
address }
The Next_Hops of BGP
routes can be modified
using a route-policy in
the following
situations:
● For IBGP peers, the
route-policy can be
an import or export
policy. Even if the
next hop address
configured in the
route-policy is
unreachable, the
IBGP peers still add
the routes whose
next hop addresses
have been changed
to the address
configured in the
route-policy to the
BGP routing table.
However, the routes
are invalid.
● For EBGP peers, the
route-policy can
only be an import
policy in most cases.
If the route-policy is
configured as an
export policy, the
routes whose next
hop addresses have
been changed to
the address
configured in the
route-policy are
discarded by the
EBGP peers because
the next hop
address is
unreachable.
If a route-policy
has been specified
in the import-
route or network
command, the
apply clause
configured for the
route-policy using
the apply ip-
address next-hop
command does
not take effect.
Obtaining a Reachable Next Hop
During route selection, BGP first checks whether the next hop addresses of routes
are reachable. Routes carrying unreachable next hop addresses are invalid and are
not selected. Table 9-11 shows how to obtain a reachable next hop IP address or
tunnel.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 731
Table 9-11 Unreachable next hop
Item Description Solutions
Unreachable next hop IP
address
A next hop IP address is
obtained through route
recursion, but no active
routes to the IP address
are available in the IP
routing table.
Common solutions are as
follows:
● Configure static
routes or an IGP.
● Run the import-route
command.
● Run the network
command.
Alternatively, you can
run the peer next-hop-
local command to
change the Next_Hop to
the local IP address.
Unreachable next hop
tunnel
Routes fail to be
recursed to tunnels.
Configure a tunnel policy
or a tunnel selector to
ensure that the routes
can be recursed to
tunnels.
A next hop tunnel is
obtained through route
recursion, but the tunnel
is unavailable.
Ensure that the tunnel is
correctly configured and
is Up.
The following example shows how to obtain a reachable next hop IP address. In
Figure 9-25, an IBGP peer relationship is established between Switch A and Switch
B, and an EBGP peer relationship is established between Switch B and Switch C.
Switch A imports the route 1.1.1.9/32, and Switch C imports the route 3.3.3.9/32.
Figure 9-25 Networking
# Display the BGP routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 732
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
i 3.3.3.9/32 10.1.2.1 0 100 0 65001i
The preceding command output shows that no asterisk (*) is in front of the route
3.3.3.9/32, which indicates that the route is invalid.
# Display the IP routing table of Switch A.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 5 Routes : 5
Destination/Mask Proto Pre Cost Flags NextHop Interface
1.1.1.9/32 Direct 0 0 D 127.0.0.1 LoopBack1
10.1.1.0/30 Direct 0 0 D 10.1.1.1 GigabitEthernet0/0/0
10.1.1.1/32 Direct 0 0 D 127.0.0.1 GigabitEthernet0/0/0
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
The preceding command output shows that the next hop IP address (10.1.2.1) of
the route 3.3.3.9/32 is not in the IP routing table, which indicates that the route is
not selected due to the unreachable next hop IP address. The following solutions
can address this issue:
● Configure a static route destined for 10.1.2.1/30 on Switch A.
● Configure an IGP on Switch B and Switch C and configure BGP to import the
route 10.1.2.1 on Switch B. This solution is not applicable to this specific
scenario because Switch B and Switch C are located in different ASs.
● Run the import-route direct command on Switch B. This solution is not
optimal because unnecessary routes may be imported.
● Run the network 10.1.2.0 30 command on Switch B to advertise the route
10.1.2.0/30 to Switch A.
● Run the peer 10.1.1.1 next-hop-local command on Switch B to configure
Switch B to modify the Next_Hop of the route 3.3.3.9/32 before advertising
the route to Switch A.
In this example, the network 10.1.2.0 30 command is configured on Switch B.
After the command is configured, check the BGP routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 0.0.0.0 0 0 i
*>i 3.3.3.9/32 10.1.2.1 0 100 0 65001i
*>i 10.1.2.0/30 10.1.1.2 0 100 0 i
The preceding command output shows that both * and > are in front of the route
3.3.3.9/32, which indicates that the route is valid and optimal.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 733
9.2.18.3 PrefVal
PrefVal is Huawei-specific and valid only on the device where it is configured. The
PreVal attribute is set by customers. Therefore, BGP first compares the PreVal
values during route selection.
If multiple routes are available to the same destination, the route with the largest
PreVal value is selected as the optimal route. By default, the PreVal of the routes
learned from BGP peers is 0.
Table 9-12 lists two methods to modify the PreVal value.
Table 9-12 Methods to modify the PreVal value
Method Usage Scenario
Run the peer {
group-name |
ipv4-
address |
ipv6-address } preferred-
value
value command.
This method sets a PreVal value for
the routes learned from a peer or peer
group.
Configure an import policy and run the
apply preferred-value
preferred-value
command to configure an apply clause
for the policy.
This method sets different PreVal
values for different routes learned
from a peer or peer group.
NOTE
If both the methods are used, the method
with the import policy takes effect if routes
match the conditions specified in the peer
preferred-value command and the import
policy.
The following example shows how the PreVal value is used during BGP route
selection. In Figure 9-26, both ISP1 and ISP2 advertise the routes 10.11.0.0/16 and
10.22.0.0/16 to AS 65001.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 734
Figure 9-26 PreVal application networking
Scenario 1: When no PreVal value is configured on Switch A, check the BGP
routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.11.0.0/16 10.1.3.2 0 200?
* 10.1.2.2 0 300 100?
*> 10.22.0.0/16 10.1.3.2 0 200?
* 10.1.2.2 0 300 100?
The BGP routing table of Switch A shows that Switch A receives the routes
10.11.0.0/16 and 10.22.0.0/16 from ISP1 and ISP2. Check the information about
the route 10.11.0.0/16 on Switch A.
[SwitchA] display bgp routing-table 10.11.0.0
BGP local router ID : 10.1.2.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 735
From: 10.1.3.2 (10.1.3.2)
Route Duration: 00h08m35s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 200, origin incomplete, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.2.2
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h04m38s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 300 100, origin incomplete, pref-val 0, valid, external, pre 255, not preferred for AS-Path
Not advertised to any peer yet
The preceding command output shows that the AS_Path of the route learned from
ISP2 is shorter than that of the route learned from ISP1. Therefore, the route
learned from ISP2 is selected as the optimal route. Table 9-13 shows the route
attribute comparison of the routes 10.11.0.0/16 learned from ISP1 and ISP2.
Table 9-13 Route attribute comparison of the route learned from ISP1 and that
learned from ISP2
Route Attribute Route Learned
from ISP1
Route Learned
from ISP2
Comparison
PrefVal 0 0 The same.
Local_Pref - - The same.
NOTE
If a route does not
carry Local_Pref,
the default value
100 takes effect.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 300 100 200 The route learned
from ISP2 is
selected as the
optimal route
because its
AS_Path is shorter
than that of the
route learned
from ISP1.
Scenario 2: The administrator of AS 65001 requires that ISP1 be active and ISP2
be backup for the traffic to 10.11.0.0/16 and 10.22.0.0/16.
To meet the preceding requirements, run the peer {
group-name |
ipv4-address |
ipv6-address } preferred-value
value command on Switch A to increase the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 736
PrefVal values of the routes learned from ISP1. This configuration ensures that the
routes learned from ISP1 are selected as the optimal routes. Detailed
configurations are as follows:
bgp 65001
#
ipv4-family unicast
peer 10.1.2.2 preferred-value 120 //Set the PrefVal of the routes learned from AS 300 to 120.
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.11.0.0/16 10.1.2.2 120 300 100?
* 10.1.3.2 0 200?
*> 10.22.0.0/16 10.1.2.2 120 300 100?
* 10.1.3.2 0 200?
The preceding command output shows that Switch A selects the routes learned
from ISP1.
# Display detailed information about the route 10.11.0.0/16 or 10.22.0.0/16 on
Switch A. The route 10.11.0.0/16 is used as an example.
[SwitchA] display bgp routing-table 10.11.0.0
BGP local router ID : 10.1.2.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h05m36s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 300 100, origin incomplete, pref-val 120, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.2.2
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.3.2 (10.1.3.2)
Route Duration: 00h23m11s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 200, origin incomplete, pref-val 0, valid, external, pre 255, not preferred for PreVal
Not advertised to any peer yet
The preceding command output shows that the PrefVal value of the route learned
from ISP1 is greater than that of the route learned from ISP2 and that the route
learned from ISP1 is selected as the optimal route.
Scenario 3: The expected configurations of the administrator of AS 65001 are as
follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 737
● For the traffic destined to 10.11.0.0/16, ISP1 is active and ISP2 is backup.
● For the traffic destined to 10.22.0.0/16, ISP2 is active and ISP1 is backup.
To meet the preceding requirements, ensure that Switch A selects the route
10.11.0.0/16 learned from ISP1 and the route 10.22.0.0/16 learned from ISP2. In
this situation, the peer preferred-value command can no longer be used because
different PrefVal values are required for the routes learned from the same ISP. To
allow different PrefVal values for the routes learned from the same ISP, configure
import policies. Detailed configurations are as follows:
#
bgp 65001
#
ipv4-family unicast
peer 10.1.2.2 route-policy for_isp1_in import //Apply import policy named for_isp1_in to the routes
learned from 10.1.2.2 and use for_isp1_in to modify the PrefVal value.
peer 10.1.3.2 route-policy for_isp2_in import //Apply import policy named for_isp2_in to the routes
learned from 10.1.3.2 and use for_isp2_in to modify the PrefVal value.
#
route-policy for_isp1_in permit node 10 //Define the first node of for_isp1_in and set the PrefVal
value of the route 10.11.0.0/16 to 80.
if-match ip-prefix for_isp1
apply preferred-value 80
#
route-policy for_isp1_in permit node 20 //Define the second node of for_isp1_in and allow
for_isp1_in to permit all routes.
#
route-policy for_isp2_in permit node 10 //Define the first node of for_isp2_in and set the PrefVal
value of the route 10.22.0.0/16 to 120.
if-match ip-prefix for_isp2
apply preferred-value 120
#
route-policy for_isp2_in permit node 20 //Define the second node of for_isp2_in and allow
for_isp2_in to permit all routes.
#
ip ip-prefix for_isp1 index 10 permit 10.11.0.0 16 //Configure an IP prefix list to match the route
10.11.0.0/16.
ip ip-prefix for_isp2 index 10 permit 10.22.0.0 16 //Configure an IP prefix list to match the route
10.22.0.0/16.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.11.0.0/16 10.1.2.2 80 300 100?
* 10.1.3.2 0 200?
*> 10.22.0.0/16 10.1.3.2 120 200?
* 10.1.2.2 0 300 100?
The preceding command output shows that Switch A selects the route
10.11.0.0/16 learned from ISP1 and the route 10.22.0.0/16 learned from ISP2.
# Display detailed information about the route 10.22.0.0/16 on Switch A.
[SwitchA] display bgp routing-table 10.22.0.0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 738
BGP local router ID : 10.1.2.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.22.0.0/16:
From: 10.1.3.2 (10.1.3.2)
Route Duration: 00h14m14s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 200, origin incomplete, pref-val 120, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.2.2
BGP routing table entry information of 10.22.0.0/16:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h07m54s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 300 100, origin incomplete, pref-val 0, valid, external, pre 255, not preferred for PreVal
Not advertised to any peer yet
The preceding command output shows that two routes 10.22.0.0/16 are available
in the BGP routing table of Switch A and that the route with the next hop address
10.1.3.2 is selected because its PrefVal (120) is greater than the PrefVal (0) of the
route with next hop address 10.1.2.2. The PrefVal value is sufficient enough to
determine the optimal route, and therefore, Switch A does not compare other
route attributes.
The preceding examples show that PrefVal values can be configured as required to
control the traffic forwarding path.
9.2.18.4 Local_Pref
The Local_Pref attribute is used to determine the optimal route when traffic leaves
an AS. The Local_Pref attribute is available only to IBGP peers and is not
advertised to other ASs.
Table 9-14 lists two methods to modify the Local_Pref value.
Table 9-14 Methods to modify the Local_Pref value
Method Usage Scenario
Run the default local-preference
command.
This method sets a default Local_Pref
for the routes that the local device
advertises to IBGP peers.
Configure an import or export policy
and run the apply local-preference
command to configure an apply clause
for the policy.
This method sets different Local_Pref
values for different routes that the
local device advertises to IBGP peers.
NOTE
If both the methods are used, the method
with the import policy takes effect if routes
match the conditions specified in the apply
local-preference command and the policy.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 739
The following example shows how the Local_Pref value is used during BGP route
selection. In Figure 9-27, both ISP1 and ISP2 advertise the routes 10.11.0.0/16 and
10.22.0.0/16 to AS 65001.
Figure 9-27 Local_Pref application networking
Scenario 1: When no Local_Pref value is configured on Switch A and Switch B,
check the BGP routing tables of Switch A and Switch B.
[SwitchA] display bgp routing-table
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/30 0.0.0.0 0 0 i
*>i 10.1.2.0/30 10.1.3.2 0 100 0 i
*> 10.11.0.0/16 10.1.1.1 0 100 10i
* i 10.1.2.1 100 0 200 10i
*> 10.22.0.0/16 10.1.1.1 0 100 10i
* i 10.1.2.1 100 0 200 10i
The BGP routing table of Switch A shows that Switch A receives the routes
10.11.0.0/16 and 10.22.0.0/16 from ISP1 and Switch B. Check the information
about the route 10.11.0.0/16 on Switch A.
[SwitchA] display bgp routing-table 10.11.0.0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 740
BGP local router ID : 192.168.2.3
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.1.1 (192.168.2.5)
Route Duration: 04h41m03s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.4.2
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.3.2 (192.168.2.2)
Route Duration: 01h42m40s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet1/0/3
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for peer type
Not advertised to any peer yet
The preceding command output shows that the route learned from ISP1 is
selected as the optimal route because it is an EBGP route and the route learned
from Switch B is an IBGP route. Table 9-15 shows the route attribute comparison
of the routes 10.11.0.0/16 learned from ISP1 and Switch B.
Table 9-15 Route attribute comparison of the routes 10.11.0.0/16 learned from
ISP1 and Switch B
Route Attribute Route Learned
from ISP1
Route Learned
from Switch B
Comparison
PrefVal 0 0 The same.
Local_Pref - 100 The same.
NOTE
If a route does not
carry Local_Pref,
the default value
100 takes effect.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 100 10 200 10 The same length.
Origin IGP IGP The same.
MED - - The same.
Peer type EBGP IBGP Route
10.11.0.0/16
learned from ISP1
is optimal.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 741
The route selection process on Switch B is the same as that on Switch A. Then,
Switch A and Switch B advertise the optimal routes to Switch C. Check the routing
table of Switch C.
[SwitchC] display bgp routing-table
Total Number of Routes: 6
BGP Local router ID is 192.168.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.4.1 0 100 0 i
*>i 10.1.2.0/30 10.1.5.1 0 100 0 i
*>i 10.11.0.0/16 10.1.2.1 100 0 200 10i
* i 10.1.1.1 100 0 100 10i
*>i 10.22.0.0/16 10.1.2.1 100 0 200 10i
* i 10.1.1.1 100 0 100 10i
The preceding command output shows that Switch C selects the routes advertised
by Switch B.
Check the reason why the routes learned from Switch A are not selected on Switch
C. The route 10.11.0.0/16 is used as an example.
[SwitchC] display bgp routing-table 10.11.0.0
BGP local router ID : 192.168.2.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.5.1 (192.168.2.2)
Route Duration: 00h12m46s
Relay IP Nexthop: 10.1.5.1
Relay IP Out-Interface: GigabitEthernet1/0/1
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Not advertised to any peer yet
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.4.1 (192.168.2.3)
Route Duration: 00h17m30s
Relay IP Nexthop: 10.1.4.1
Relay IP Out-Interface: GigabitEthernet1/0/0
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for router ID
Not advertised to any peer yet
The preceding command output shows that Switch C selects the route
10.11.0.0/16 learned from Switch B because the router ID (192.168.2.2) of Switch
B is smaller than that (192.168.2.3) of Switch A. Table 9-16 shows the route
attribute comparison of the routes 10.11.0.0/16 learned from Switch A and Switch
B.
Table 9-16 Route attribute comparison of the routes 10.11.0.0/16 learned from
Switch A and Switch B
Route Attribute Route Learned
from Switch A
Route Learned
from Switch B
Comparison
PrefVal 0 0 The same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 742
Route Attribute Route Learned
from Switch A
Route Learned
from Switch B
Comparison
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 100 10 200 10 The same length.
Origin IGP IGP The same.
MED - - The same.
Peer type IBGP IBGP The same.
IGP cost - - The same.
Cluster_List - - The same length.
Router ID 192.168.2.3 192.168.2.2 Route
10.11.0.0/16
learned from
Switch B is
optimal.
Scenario 2: The administrator of AS 65001 requires that ISP1 be active and ISP2
be backup for the traffic to 10.11.0.0/16 and 10.22.0.0/16.
To meet the preceding requirements, run the default local-preference command
on Switch A to increase the Local_Pref values of the routes learned from Switch A.
This configuration ensures that the routes learned from ISP1 are selected as the
optimal routes. Detailed configurations are as follows:
#
bgp 65001
#
ipv4-family unicast
default local-preference 120 //Set the Local_Pref of the routes to be advertised to 120.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/30 0.0.0.0 0 0 i
*>i 10.1.2.0/30 10.1.3.2 0 100 0 i
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 743
*> 10.11.0.0/16 10.1.1.1 0 100 10i
*> 10.22.0.0/16 10.1.1.1 0 100 10i
The preceding command output shows that Switch A selects the routes learned
from ISP1.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 192.168.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.3.1 0 120 0 i
*> 10.1.2.0/30 0.0.0.0 0 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
* 10.1.2.1 0 200 10i
*>i 10.22.0.0/16 10.1.1.1 120 0 100 10i
* 10.1.2.1 0 200 10i
The preceding command output shows that Switch B selects the routes learned
from Switch A. Switch B does not advertise the routes learned from ISP2 to its
IBGP peers because those routes are not selected.
# Display detailed information about the route 10.11.0.0/16 or 10.22.0.0/16 on
Switch B. The route 10.11.0.0/16 is used as an example.
[SwitchB] display bgp routing-table 10.11.0.0
BGP local router ID : 192.168.2.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.3.1 (192.168.2.3)
Route Duration: 00h22m16s
Relay IP Nexthop: 10.1.3.1
Relay IP Out-Interface: GigabitEthernet1/0/4
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, localpref 120, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
10.1.2.1
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.2.1 (192.168.2.4)
Route Duration: 00h22m23s
Direct Out-interface: GigabitEthernet1/0/0
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, pref-val 0, valid, external, pre 255, not preferred for Local_Pref
Not advertised to any peer yet
The preceding command output shows that the Local_Pref value of the route
learned from Switch A is greater than that of the route learned from ISP2 and that
the route learned from Switch A is selected as the optimal route. Table 9-17
shows the route attribute comparison of the routes 10.11.0.0/16 learned from
Switch A and ISP2.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 744
Table 9-17 Route attribute comparison of the routes 10.11.0.0/16 learned from
Switch A and ISP2
Route Attribute Route Learned
from Switch A
Route Learned
from ISP2
Comparison
PrefVal 0 0 The same.
Local_Pref 120 - Route
10.11.0.0/16
learned from
Switch A is
optimal.
NOTE
If a route does not
carry Local_Pref,
the default value
100 takes effect.
# Display the routing table of Switch C.
[SwitchC] display bgp routing-table
Total Number of Routes: 4
BGP Local router ID is 192.168.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.4.1 0 120 0 i
*>i 10.1.2.0/30 10.1.5.1 0 100 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
*>i 10.22.0.0/16 10.1.1.1 120 0 100 10i
Switch C selects the routes advertised by ISP1 because Switch B did not advertise
the routes learned from ISP2 to Switch C.
Scenario 3: The requirements of the administrator of AS 65001 are as follows:
● ISP1 is active and ISP2 is backup for the traffic to 10.11.0.0/16.
● ISP2 is active and ISP1 is backup for the traffic to 10.22.0.0/16.
To meet the preceding requirements, ensure that AS 65001 selects the route
10.11.0.0/16 learned from Switch A and the route 10.22.0.0/16 learned from
Switch B. Detailed configurations are as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 745
Figure 9-28 Local_Pref-based BGP route selection networking (1)
In this situation, different Local_Pref values are required for the routes learned
from the same ISP. To configure different Local_Pref values for the routes learned
from the same ISP, configure route-policies. Detailed configurations are as follows:
● Configurations on Switch A
#
bgp 65001
#
ipv4-family unicast
peer 10.1.1.1 route-policy rp1 import //Apply import policy named rp1 to the routes
learned from 10.1.1.1 and use rp1 to modify the Local_Pref.
#
route-policy rp1 permit node 10 //Define the first node of rp1 and set the Local_Pref
value of the route 10.11.0.0/16 to 120.
if-match ip-prefix addpref
apply local-preference 120
#
route-policy rp1 permit node 20 //Define the second node of rp1 and set the
Local_Pref value of the route 10.22.0.0/16 to 80.
if-match ip-prefix reducepref
apply local-preference 80
#
route-policy rp1 permit node 30 //Define the third node of rp1 and allow rp1 to
permit all routes.
#
ip ip-prefix addpref index 10 permit 10.11.0.0 16 //Configure an IP prefix list to match the route
10.11.0.0/16.
ip ip-prefix reducepref index 10 permit 10.22.0.0 16 //Configure an IP prefix list to match the route
10.22.0.0/16.
#
● Configurations on Switch B
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 746
bgp 65001
#
ipv4-family unicast
peer 10.1.2.1 route-policy rp2 import //Apply import policy named rp2 to the routes
learned from 10.1.1.1 and use rp2 to modify the Local_Pref.
#
route-policy rp2 permit node 10 //Define the first node of rp2 and set the Local_Pref
value of the route 10.22.0.0/16 to 200.
if-match ip-prefix addpref
apply local-preference 200
#
route-policy rp2 permit node 20 //Define the second node of rp2 and set the
Local_Pref value of the route 10.11.0.0/16 to 60.
if-match ip-prefix reducepref
apply local-preference 60
#
route-policy rp2 permit node 30 //Define the third node of rp2 and allow rp2 to
permit all routes.
#
ip ip-prefix addpref index 10 permit 10.22.0.0 16 //Configure an IP prefix list to match the route
10.22.0.0/16.
ip ip-prefix reducepref index 10 permit 10.11.0.0 16 //Configure an IP prefix list to match the route
10.11.0.0/16.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/30 0.0.0.0 0 0 i
*>i 10.1.2.0/30 10.1.3.2 0 100 0 i
*> 10.11.0.0/16 10.1.1.1 120 0 100 10i
*>i 10.22.0.0/16 10.1.2.1 200 0 200 10i
* 10.1.1.1 80 0 100 10i
# Display detailed information about the route 10.22.0.0/16 on Switch A.
[SwitchA] display bgp routing-table 10.22.0.0
BGP local router ID : 192.168.2.3
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.22.0.0/16:
From: 10.1.3.2 (192.168.2.2)
Route Duration: 00h20m12s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet1/0/3
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 200, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
10.1.1.1
BGP routing table entry information of 10.22.0.0/16:
From: 10.1.1.1 (192.168.2.5)
Route Duration: 00h19m40s
Direct Out-interface: GigabitEthernet1/0/1
Original nexthop: 10.1.1.1
Qos information : 0x0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 747
AS-path 100 10, origin igp, localpref 80, pref-val 0, valid, external, pre 255, not preferred for Local_Pref
Not advertised to any peer yet
The preceding command output shows that two routes 10.22.0.0/16 are available
in the BGP routing table of Switch A and that the route with next hop address
10.1.2.1 is selected because its Local_Pref (200) is greater than the Local_Pref (80)
of the route with next hop address 10.1.1.1.
Table 9-18 shows the route attribute comparison of the routes 10.22.0.0/16
learned from ISP1 and Switch B.
Table 9-18 Route attribute comparison of the routes 10.22.0.0/16 learned from
ISP1 and Switch B.
Route Attribute Route Learned
from ISP1
Route Learned
from Switch B
Comparison
PrefVal 0 0 The same.
Local_Pref 80 200 Route
10.22.0.0/16
learned from
Switch B is
optimal.
The route with next hop address 10.1.1.1 is not optimal, and therefore, it is not
advertised to Switch B and Switch C. In addition, the route 10.11.0.0/16 with next
hop address 10.1.2.1 is not optimal on Switch B, and therefore, Switch B does not
advertise this route to Switch A and Switch C. As a result, only one route
10.11.0.0/16 with next hop address 10.1.1.1 is available in the BGP routing table of
Switch A.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 192.168.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.3.1 0 100 0 i
*> 10.1.2.0/30 0.0.0.0 0 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
* 10.1.2.1 60 0 200 10i
*> 10.22.0.0/16 10.1.2.1 200 0 200 10i
# Display detailed information about the route 10.11.0.0/16 on Switch B.
[SwitchB] display bgp routing-table 10.11.0.0
BGP local router ID : 192.168.2.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.3.1 (192.168.2.3)
Route Duration: 00h40m28s
Relay IP Nexthop: 10.1.3.1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 748
Relay IP Out-Interface: GigabitEthernet1/0/4
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, localpref 120, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
10.1.2.1
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.2.1 (192.168.2.4)
Route Duration: 00h41m00s
Direct Out-interface: GigabitEthernet1/0/0
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 60, pref-val 0, valid, external, pre 255, not preferred for Local_Pref
Not advertised to any peer yet
The preceding command output shows that two routes 10.11.0.0/16 are available
in the BGP routing table of Switch B and that the route with next hop address
10.1.1.1 is selected because its Local_Pref (120) is greater than the Local_Pref (60)
of the route with next hop address 10.1.2.1. The route with next hop address
10.1.2.1 is not advertised to Switch A and Switch C because it is not optimal.
# Display the routing table of Switch C.
[SwitchC] display bgp routing-table
Total Number of Routes: 4
BGP Local router ID is 192.168.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.4.1 0 100 0 i
*>i 10.1.2.0/30 10.1.5.1 0 100 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
*>i 10.22.0.0/16 10.1.2.1 200 0 200 10i
The preceding command output shows that the next hop address of the route
10.11.0.0/16 is 10.1.1.1 and that the next hop address of the route 10.22.0.0/16 is
10.1.2.1.
Scenario 4: The requirements of the administrator of AS 65001 are as follows:
● ISP1 is active and ISP2 is backup for the traffic from Switch A and Switch C to
10.11.0.0/16 and 10.22.0.0/16.
● ISP2 is active and ISP1 is backup for the traffic from Switch B to 10.11.0.0/16
and 10.22.0.0/16.
To meet the preceding requirements, ensure that Switch A and Switch C select the
routes learned from ISP1. Detailed configurations are as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 749
Figure 9-29 Local_Pref-based BGP route selection networking (2)
You can perform either of the following operations:
● Configure an export policy on Switch A to modify the Local_Pref of the routes
to be advertised to Switch C.
● Configure an import policy on Switch C to modify the Local_Pref of the routes
learned from Switch A.
The configurations on Switch A are used as an example. Detailed configurations
are as follows:
#
bgp 65001
#
ipv4-family unicast
peer 10.1.4.2 route-policy rp2 export //Apply the export route-policy rp2 to the route destined
for the peer 10.1.4.1 to modify the Local_Pref of the route.
#
route-policy rp2 permit node 10 //Define the node index of the route-policy rp2 to 10 and
set the Local_Pref to 120.
apply local-preference 120
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 750
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/30 0.0.0.0 0 0 i
*>i 10.1.2.0/30 10.1.3.2 0 100 0 i
*> 10.11.0.0/16 10.1.1.1 0 100 10i
* i 10.1.2.1 100 0 200 10i
*> 10.22.0.0/16 10.1.1.1 0 100 10i
* i 10.1.2.1 100 0 200 10i
The preceding command output shows that Switch A selects the routes learned
from ISP1.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 192.168.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.3.1 0 100 0 i
*> 10.1.2.0/30 0.0.0.0 0 0 i
*> 10.11.0.0/16 10.1.2.1 0 200 10i
* i 10.1.1.1 100 0 100 10i
*> 10.22.0.0/16 10.1.2.1 0 200 10i
* i 10.1.1.1 100 0 100 10i
The preceding command output shows that Switch B selects the routes learned
from ISP2.
# Display the routing table of Switch C.
[SwitchC] display bgp routing-table
Total Number of Routes: 6
BGP Local router ID is 192.168.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.0/30 10.1.4.1 0 120 0 i
*>i 10.1.2.0/30 10.1.5.1 0 100 0 i
*>i 10.11.0.0/16 10.1.1.1 120 0 100 10i
* i 10.1.2.1 100 0 200 10i
*>i 10.22.0.0/16 10.1.1.1 120 0 100 10i
* i 10.1.2.1 100 0 200 10i
The preceding command output shows that Switch C selects the routes learned
from ISP1.
# Display detailed information about the route 10.11.0.0/16 or 10.22.0.0/16 on
Switch C. The route 10.11.0.0/16 is used as an example.
[SwitchC] display bgp routing-table 10.11.0.0
BGP local router ID : 192.168.2.1
Local AS number : 65001
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 751
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.4.1 (192.168.2.3)
Route Duration: 00h06m26s
Relay IP Nexthop: 10.1.4.1
Relay IP Out-Interface: GigabitEthernet1/0/0
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path 100 10, origin igp, localpref 120, pref-val 0, valid, internal, best, select, active, pre 255
Not advertised to any peer yet
BGP routing table entry information of 10.11.0.0/16:
From: 10.1.5.1 (192.168.2.2)
Route Duration: 00h08m05s
Relay IP Nexthop: 10.1.5.1
Relay IP Out-Interface: GigabitEthernet1/0/1
Original nexthop: 10.1.2.1
Qos information : 0x0
AS-path 200 10, origin igp, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for Local_Pref
Not advertised to any peer yet
The preceding command output shows that Switch C selects the routes learned
from ISP1 because the Local_Pref of the routes learned from ISP1 is greater than
that of the route learned from ISP2.
The preceding examples show that the modification of the Local_Pref values
affects not only BGP route advertisement but also BGP route selection with an AS.
We can configure Local_Pref values as required to control the forwarding path of
the traffic that leaves an AS.
9.2.18.5 Route Type
BGP routes can be locally imported or learned from peers. The locally imported
routes take precedence over the routes learned from peers during BGP route
selection. It is unusual for locally imported routes and the routes learned from
peers to carry the same destination IP address and coexist in the routing table.
Generally, locally imported routes can be the routes imported using the network
or import-route command and the automatically and manually summarized
routes. Precedences of these routes are described as follows:
1. Summarized routes take precedence over non-summarized routes.
2. Summarized routes that are manually generated using the aggregate
command take precedence over summarized routes that are automatically
generated based on the summary automatic command settings.
3. The routes imported using the network command take precedence over the
routes imported using the import-route command.
In Figure 9-30, Switch A and Switch B are EBGP peers, and Switch B, Switch C, and
Switch D are IBGP peers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 752
Figure 9-30 Networking
The configurations on Switch C are as follows:
#
bgp 65001
#
ipv4-family unicast
network 10.1.2.0 255.255.255.252 //Advertise the route 10.1.2.0/30.
network 10.1.4.0 255.255.255.252 //Advertise the route 10.1.4.0/30.
import-route direct //Import direct routes.
#
The configurations on Switch D are as follows:
#
bgp 65001
#
ipv4-family unicast
network 10.1.3.0 255.255.255.252 //Advertise the route 10.1.3.0/30.
network 10.1.4.0 255.255.255.252 //Advertise the route 10.1.4.0/30.
import-route direct //Import direct routes.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch D.
[SwitchD] display bgp routing-table
BGP Local router ID is 10.1.3.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 10
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.2.0/30 10.1.4.2 0 100 0 i
*> 10.1.3.0/30 0.0.0.0 0 0 i
* 0.0.0.0 0 0 ?
*> 10.1.3.2/32 0.0.0.0 0 0 ?
*> 10.1.4.0/30 0.0.0.0 0 0 i
* 0.0.0.0 0 0 ?
i 10.1.4.2 0 100 0 ?
*> 10.1.4.1/32 0.0.0.0 0 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
The preceding command output shows that three routes 10.1.4.0/30 are available
in the routing table. The route with the next hop address 10.1.4.2 is learned from
a peer (Switch C). Therefore, BGP first excludes this route from route selection.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 753
[SwitchD] display bgp routing-table 10.1.4.0 30
BGP local router ID : 10.1.3.2
Local AS number : 65001
Paths: 3 available, 1 best, 1 select
BGP routing table entry information of 10.1.4.0/30:
Network route.
From: 0.0.0.0 (0.0.0.0)
Route Duration: 00h03m51s
Direct Out-interface: GigabitEthernet0/0/4
Original nexthop: 10.1.4.1
Qos information : 0x0
AS-path Nil, origin igp, MED 0, pref-val 0, valid, local, best, select, pre 0
Advertised to such 2 peers:
10.1.3.1
10.1.4.2
BGP routing table entry information of 10.1.4.0/30:
Imported route.
From: 0.0.0.0 (0.0.0.0)
Route Duration: 00h04m10s
Direct Out-interface: GigabitEthernet0/0/4
Original nexthop: 10.1.4.1
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, pref-val 0, valid, local, pre 0, not preferred for route type
Not advertised to any peer yet
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.4.2 (10.1.2.2)
Route Duration: 00h02m24s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/4
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, localpref 100, pref-val 0, internal, pre 255
Not advertised to any peer yet
The preceding command output shows that the route imported using the network
command is selected as the optimal route.
The configurations on Switch B are as follows:
bgp 65001
#
ipv4-family unicast
summary automatic
aggregate 10.0.0.0 255.0.0.0
import-route direct
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.1.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 14
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.0.0 127.0.0.1 0 ?
* 127.0.0.1 0 ?
s> 10.1.1.0/30 0.0.0.0 0 0 ?
*> 10.1.1.2/32 0.0.0.0 0 0 ?
s> 10.1.2.0/30 0.0.0.0 0 0 ?
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 754
i 10.1.2.2 0 100 0 i
*> 10.1.2.1/32 0.0.0.0 0 0 ?
s> 10.1.3.0/30 0.0.0.0 0 0 ?
i 10.1.3.2 0 100 0 i
*> 10.1.3.1/32 0.0.0.0 0 0 ?
*>i 10.1.4.0/30 10.1.3.2 0 100 0 i
* i 10.1.2.2 0 100 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
The preceding command output shows that two summarized routes 10.0.0.0 are
available in the routing table.
[SwitchB] display bgp routing-table 10.0.0.0
BGP local router ID : 10.1.1.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.0.0.0/8:
Aggregated route.
Route Duration: 00h17m04s
Direct Out-interface: NULL0
Original nexthop: 127.0.0.1
Qos information : 0x0
AS-path Nil, origin incomplete, pref-val 0, valid, local, best, select, active, pre 255
Aggregator: AS 65001, Aggregator ID 10.1.1.2
Advertised to such 3 peers:
10.1.1.1
10.1.3.2
10.1.2.2
BGP routing table entry information of 10.0.0.0/8:
Summary automatic route
Route Duration: 00h17m04s
Direct Out-interface: NULL0
Original nexthop: 127.0.0.1
Qos information : 0x0
AS-path Nil, origin incomplete, pref-val 0, valid, local, pre 255, not preferred for route type
Aggregator: AS 65001, Aggregator ID 10.1.1.2
Not advertised to any peer yet
The preceding command output shows that the route generated using the
aggregate command is selected as the optimal route.
9.2.18.6 AS_Path
Four types of AS_Path attributes are available:
● AS_Sequence: records in reverse order all the ASs through which a route
passes from the local device to the destination.
● AS_Set: records in random order all the ASs through which a route passes
from the local device to the destination. The AS_Set attribute is used in route
summarization scenarios.
● AS_Confed_Sequence: records in reverse order all the sub-ASs within a BGP
confederation through which a route passes from the local device to the
destination.
● AS_Confed_Set: records in random order all the sub-ASs within a BGP
confederation through which a route passes from the local device to the
destination.
Table 9-19 describes the AS_Path-based route selection rules.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 755
Table 9-19 AS_Path-based route selection rules
Item Description
AS_Set BGP takes an AS_Set as one AS number even if the
AS_Set contains multiple AS numbers.
When the aggregate (BGP) command is
configured to generate a manually summarized
route, if as-set is specified in the command, AS_Set
will be carried in the summarized route. The
information in the AS_Set is as follows:
● If the routes used in the summarization carry
the same AS_Sequence, this AS_Sequence is
carried in the summarized route, and the AS_Set
of the summarized route is null.
● If the routes used in the summarization carry
different AS_Sequences, all the AS numbers
carried in the AS_Sequences are included in the
AS_Set of the summarized route.
AS_Confed_Sequence and
AS_Confed_Set
BGP ignores AS_Confed_Sequence and
AS_Confed_Set when calculating the AS_Path
length.
bestroute as-path-ignore After the command is configured, BGP does not
compare the AS_Path attribute during route
selection.
apply as-path The command can be run to configure an apply
clause for a route-policy so that the ASs in the
AS_Path of the route that matches the route-policy
are cleared or replaced, or new ASs are added.
NOTE
The configuration of the apply as-path command may
change the traffic forwarding path, or cause routing loops
or route selection errors. Therefore, exercise caution when
configuring the command.
peer public-as-only After the command is configured, BGP deletes
private AS numbers (if any) from the AS_Path
attribute before sending Update packets. Private AS
numbers range from 64512 to 65534.
peer fake-as After the command is configured, BGP can use a
fake AS number to set up a BGP peer relationship.
If the local device uses the actual AS number to
establish an EBGP peer relationship with a remote
device, the actual AS number is carried in the
AS_Path of the route sent to the remote device. If
the local device uses the fake AS number to
establish the EBGP peer relationship, the fake AS
number is carried in the AS_Path of the route sent
to the remote device.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 756
Item Description
peer substitute-as If the command is configured and an AS in the
AS_Path carried in the route sent by a PE to the CE
of the specified peer is the same as the AS of the
CE, the PE replaces the AS with the local AS.
NOTE
The peer substitute-as command applies only to PEs in
BGP MPLS IP/VPN scenarios and may cause routing loops
if it is improperly configured. Therefore, exercise caution
when using the command.
During BGP route selection, BGP compares the AS_Path length by calculating the
number of ASs included in the AS_Sequence if AS_Sequence is carried in a route. If
both AS_Sequence and AS_Set are carried in the route, BGP considers the AS_Path
length to be the number of ASs included in the AS_Sequence plus 1.
Deleting Private AS Numbers
As public AS resources are limited, carriers generally use private AS numbers when
deploying VPNs. Private AS numbers, however, must not be advertised to the
Internet because they may cause routing loops. In Figure 9-31, both ISP1 and ISP2
use 65001 as a private AS number.
Figure 9-31 Networking in which a private AS needs to be deleted
In Figure 9-31, Switch A advertises the route 10.0.0.0/8 to Switch D through ISP1
and ISP2. After receiving this route, Switch D checks its AS_Path. This AS_Path
carries AS 65001, which is the same as the AS of Switch D. As a result, Switch D
discards this route.
To address this problem, run the peer public-as-only command on Switch B so
that Switch B deletes AS 65001 before adding AS 100 (public AS) to the AS_Path
and forwarding the route to Switch C.
In the following situations, after the peer public-as-only command is configured,
BGP does not delete any private AS number from the AS_Path:
● The AS_Path of a route carries the AS number of the remote peer. In this case,
deleting private AS numbers may lead to a routing loop.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 757
● The AS_Path carries both public and private AS numbers, which indicates that
the route has passed through the public network. In this case, deleting private
AS numbers may lead to incorrect traffic forwarding.
The preceding limitations also apply to confederation scenarios.
Adding AS Numbers
In Figure 9-32, AS 65005 imports three routes and advertises them to AS 65001
through two paths.
Figure 9-32 Networking in which new AS numbers are added to the AS_Path
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 172.16.1.0/24 10.1.3.2 0 65003 65005?
* 10.1.1.2 0 65002 65004 65005?
*> 172.16.2.0/24 10.1.3.2 0 65003 65005?
* 10.1.1.2 0 65002 65004 65005?
*> 172.16.3.0/24 10.1.3.2 0 65003 65005?
* 10.1.1.2 0 65002 65004 65005?
[SwitchA] display bgp routing-table 172.16.1.0
BGP local router ID : 10.1.1.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 758
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.3.2 (10.1.5.1)
Route Duration: 00h00m56s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 65003 65005, origin incomplete, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.1.2
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.1.2 (10.1.1.2)
Route Duration: 00h34m43s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path 65002 65004 65005, origin incomplete, pref-val 0, valid, external, pre 255, not preferred for AS-
Path
Not advertised to any peer yet
The preceding command output shows that Switch A selects the route learned
from Switch C because this route has a shorter AS_Path length than that learned
from Switch B. To enable Switch A to select the route learned from Switch B,
configure Switch B to reduce the AS_Path length of the route or configure Switch
C to increase the AS_Path length of the route. In the following example, Switch C
is configured to increase the AS_Path length of the route. The detailed
configurations on Switch C are as follows:
#
bgp 65003
#
ipv4-family unicast
undo synchronization
peer 10.1.3.1 route-policy add_asn export //Apply export policy named add_asn to routes to be
advertised to 10.1.3.1.
#
route-policy add_asn permit node 10 //Define the first node of add_asn.
if-match ip-prefix prefix1 //Configure IP prefix list named prefix1.
apply as-path 65003 65003 65003 additive //Add 65003, 65003, 65003 to the AS_Path of the
route that matches prefix1.
#
route-policy add_asn permit node 20 //Define the second node of add_asn to permit all other
routes.
#
ip ip-prefix prefix1 index 10 permit 172.16.1.0 24 //Define the first index of prefix1 to match the route
172.16.1.0/24.
ip ip-prefix prefix1 index 20 permit 172.16.2.0 24 //Define the second index of prefix1 to match the
route 172.16.2.0/24.
ip ip-prefix prefix1 index 30 permit 172.16.3.0 24 //Define the third index of prefix1 to match the route
172.16.3.0/24.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 759
*> 172.16.1.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65003 65003 65003 65003 65005?
*> 172.16.2.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65003 65003 65003 65003 65005?
*> 172.16.3.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65003 65003 65003 65003 65005?
[SwitchA] display bgp routing-table 172.16.1.0
BGP local router ID : 10.1.1.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.1.2 (10.1.1.2)
Route Duration: 00h33m30s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path 65002 65004 65005, origin incomplete, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.3.2
10.1.1.2
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.3.2 (10.1.5.1)
Route Duration: 00h02m12s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 65003 65003 65003 65003 65005, origin incomplete, pref-val 0, valid, external, pre 255, not
preferred for AS-Path
Not advertised to any peer yet
The preceding command output shows that the AS_Path length of the route
learned from Switch B is shorter than that of the route learned from Switch C and
that the route learned from Switch B is selected as the optimal route. Table 9-20
shows the attribute comparison of the routes 172.16.1.0 learned from Switch B
and Switch C.
Table 9-20 Attribute comparison of the routes 172.16.1.0 learned from Switch B
and Switch C
Route Attribute Route Learned
from Switch B
Route Learned
from Switch C
Comparison
PrefVal 0 0 The same.
Local_Pref - - The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 65002 65004
65005
65003 65003
65003 65003
65005
The route learned
from Switch B is
optimal.
AS numbers can be added to the AS_Path as required. However, if an AS number is
added to the AS_Path of a route, the route cannot be received by devices in this
AS. Therefore, the local AS number is added in most cases. For example in Figure
9-32, if Switch C adds AS 65001 to the AS_Path of a route before advertising the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 760
route to Switch A, Switch A will discard the route upon receipt because the route
carries Switch A's AS number.
Replacing AS Numbers
When the apply as-path command is configured, if overwrite is specified in the
command, the device will replace the AS numbers in the original AS_Path attribute
to achieve the following goals:
● Hide the actual path information.
● Prevent a route from being discarded by replacing the AS_Path of the route
with a shorter one if the as-path-limit command is configured on the device
that receives this route.
● Reduce the AS_Path length.
AS number replacement can also be used for the purpose of load balancing. For
example in Figure 9-32, the apply as-path 65002 65004 65005 overwrite
command can be configured on Switch A to replace the AS_Path of the route
learned from Switch C so that the route has the same AS_Path as that of the route
learned from Switch B, and the two routes are used to load-balance traffic.
Detailed configurations on Switch A are as follows:
#
bgp 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.3.2 route-policy replace_asn import //Apply export policy named replace_asn to routes to
be advertised to 10.1.3.2.
#
route-policy replace_asn permit node 10 //Define the first node of replace_asn.
if-match as-path-filter filter1 //Configure AS_Path filter named filter1.
apply as-path 65002 65004 65005 overwrite //Replace the AS_Path of the route that matches
filter1 with 65002, 65004, 65005.
#
route-policy replace_asn permit node 20 //Define the second node of replace_asn to permit all
other routes.
#
ip as-path-filter filter1 permit ^65003 //Define AS_Path filter named filter1 to match all the
routes learned from AS 65003.
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 172.16.1.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65002 65004 65005?
*> 172.16.2.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65002 65004 65005?
*> 172.16.3.0/24 10.1.1.2 0 65002 65004 65005?
* 10.1.3.2 0 65002 65004 65005?
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 761
The preceding command output shows that the AS_Path of the route received
from AS 65003 has been replaced, after which the routes received from AS 65002
and AS 65003 have the same AS_Path. Run the maximum load-balancing 2
command on Switch A to set the maximum number of routes for load balancing
to 2. Then, check the detailed route information. The route 172.16.1.0/24 is used in
the following example:
[SwitchA] display bgp routing-table 172.16.1.0
BGP local router ID : 10.1.1.1
Local AS number : 65001
Paths: 2 available, 1 best, 2 select
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.1.2 (10.1.1.2)
Route Duration: 19h57m51s
Direct Out-interface: GigabitEthernet0/0/1
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path 65002 65004 65005, origin incomplete, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.1.2
10.1.3.2
BGP routing table entry information of 172.16.1.0/24:
From: 10.1.3.2 (10.1.5.1)
Route Duration: 00h10m21s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path 65002 65004 65005, origin incomplete, pref-val 0, valid, external, select, active, pre 255, not
preferred for router ID
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch B is
optimal and is used along with the route learned from Switch C (not optimal) for
load balancing. Check the information about the route 172.16.1.0/24 in the IP
routing table.
[SwitchA] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 9 Routes : 12
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.1.1.0/30 Direct 0 0 D 10.1.1.1 GigabitEthernet0/0/1
10.1.1.1/32 Direct 0 0 D 127.0.0.1 GigabitEthernet0/0/1
10.1.3.0/30 Direct 0 0 D 10.1.3.1 GigabitEthernet0/0/0
10.1.3.1/32 Direct 0 0 D 127.0.0.1 GigabitEthernet0/0/0
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
172.16.1.0/24 EBGP 255 0 D 10.1.1.2 GigabitEthernet0/0/1
EBGP 255 0 D 10.1.3.2 GigabitEthernet0/0/0
172.16.2.0/24 EBGP 255 0 D 10.1.1.2 GigabitEthernet0/0/1
EBGP 255 0 D 10.1.3.2 GigabitEthernet0/0/0
172.16.3.0/24 EBGP 255 0 D 10.1.1.2 GigabitEthernet0/0/1
EBGP 255 0 D 10.1.3.2 GigabitEthernet0/0/0
The preceding command output shows that BGP has delivered the two routes with
the same route prefix to the IP routing table for load balancing.
Clearing the AS_Path
When the apply as-path command is configured, if none overwrite is specified in
the command, the device clears the AS_Path to hide the actual path information
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 762
and shorten the AP_Path list. If the AS_Path is null, BGP considers its length as 0
during route selection.
9.2.18.7 Origin
Three types of Origin attributes are available:
● IGP: indicates that routes are added to the BGP routing table using the
network command. IGP has the highest priority.
● EGP: indicates that routes are learned through the EGP protocol. EGP has the
second highest priority.
NOTE
The switch can receive and send BGP routes with EGP as the Origin. However, the
switch does not support the EGP protocol; therefore, to set the Origin of routes to EGP,
you need to run the apply origin { egp {
as-number-plain |
as-number-dot } | igp |
incomplete } command to configure an apply clause for a route-policy.
● Incomplete: indicates that routes are added to the BGP routing table using
the import-route command. Incomplete has the lowest priority.
The routes imported using the network command are more specific than those
imported using the import-route command. Therefore, IGP takes precedence over
Incomplete in route selection. In Figure 9-33, Switch A and Switch B are EBGP
peers, and Switch B, Switch C, and Switch D are IBGP peers.
Figure 9-33 Networking diagram with Origin configurations
