The configurations on Switch D are as follows:
#
bgp 65001
#
ipv4-family unicast
network 10.1.4.0 255.255.255.252 //Advertise the route 10.1.4.0/30.
#
The configurations on Switch C are as follows:
#
bgp 65001
#
ipv4-family unicast
import-route direct //Import direct routes.
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 763
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.1.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
i 10.1.2.0/30 10.1.2.2 0 100 0 ?
*>i 10.1.4.0/30 10.1.3.2 0 100 0 i
* i 10.1.2.2 0 100 0 ?
The preceding command output shows that two active routes 10.1.4.0/30 are
available in the routing table.
[SwitchB] display bgp routing-table 10.1.4.0
BGP local router ID : 10.1.1.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.3.2 (10.1.3.2)
Route Duration: 01h14m48s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/2
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
10.1.1.1
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 01h13m20s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for
Origin
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch D is
selected because it is imported using the network command and its Origin
priority is higher than that of the route learned from Switch C. Table 9-21
describes the attribute comparison of the routes learned from Switch C and Switch
D.
Table 9-21 Attribute comparison of the routes learned from Switch C and Switch
D
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 764
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path - - The same length.
Origin Incomplete IGP The route learned
from Switch D is
optimal.
The Origin attribute can be modified using a route-policy. In the following
example, a route-policy is configured on Switch B to modify the Origin attribute,
and the detailed configurations are as follows:
#
bgp 65001
#
ipv4-family unicast
peer 10.1.3.2 route-policy for_d import //Apply import policy named for_d to the routes learned
from 10.1.3.2 and use for_d to modify the Origin value.
#
route-policy for_d permit node 10 //Define the route-policy named for_d.
apply origin incomplete //Set the Origin type to Incomplete.
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.1.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
i 10.1.2.0/30 10.1.2.2 0 100 0 ?
*>i 10.1.4.0/30 10.1.2.2 0 100 0 ?
* i 10.1.3.2 0 100 0 ?
The preceding command output shows that the route learned from Switch C
becomes the optimal route.
[SwitchB] display bgp routing-table 10.1.4.0
BGP local router ID : 10.1.1.2
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 01h28m19s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 1 peers:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 765
10.1.1.1
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.3.2 (10.1.3.2)
Route Duration: 00h03m18s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: GigabitEthernet0/0/2
Original nexthop: 10.1.3.2
Qos information : 0x0
AS-path Nil, origin incomplete, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, not preferred for
router ID
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch C
becomes the optimal route because it has a smaller router ID than the route
learned from Switch D. Table 9-22 shows the attribute comparison of the routes
learned from Switch C and Switch D.
Table 9-22 Attribute comparison of the routes learned from Switch C and Switch
D
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path - - The same.
Origin Incomplete Incomplete The same.
MED 0 0 The same.
Peer type IBGP IBGP The same.
IGP cost - - The same.
Cluster_List - - The same.
Router ID 10.1.2.2 10.1.3.2 The route learned
from Switch C is
optimal.
9.2.18.8 MED
The MED attribute is transmitted only within an AS or between two neighboring
ASs. The AS that receives the MED attribute does not advertise it to a third AS.
Similar to the cost used by an IGP, the MED is used to determine the optimal route
when traffic enters an AS. When a BGP peer learns multiple routes that have the
same destination address but different next hop addresses from EBGP peers, the
route with the smallest MED value is selected as the optimal route if all the other
attributes are the same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 766
Table 9-23 lists two methods used to modify the MED value.
Table 9-23 Methods to modify the MED value
Method Usage Scenario
Run the default med command. This method sets a default MED for all
the routes that the local device
advertises to its BGP peers. The
default med command takes effect
only with the routes imported locally
using the import-route command and
BGP summarized routes.
Configure an import or export policy
and run the apply cost command to
configure an apply clause for the
policy.
This method sets different MED values
for different routes advertised by the
local device to its EBGP peers.
Configure an export policy and run the
apply cost-type internal command to
configure an apply clause for the
export policy.
This method enables a device to set
MED values for the BGP routes that
are learned from IBGP peers and to be
advertised to EBGP peers and match
the export policy to the costs of the
IGP routes to which the BGP routes are
recursed.
The major points about MED attributes that require consideration are as follows:
● If routes are received from different ASs, traffic will be sent to different ASs. In
addition, BGP selects the optimal route only from the routes destined for the
same address. Therefore, BGP only compares the MEDs of routes that are
from the same AS (excluding confederation sub-ASs). MEDs of two routes are
compared only if the leftmost AS number in the AS_Sequence (excluding
AS_Confed_Sequence) of one route is the same as its counterpart in the other
route.
● If the compare-different-as-med command is run, BGP compares MEDs of
routes even when the routes are received from peers in different ASs. Do not
run this command unless the ASs use the same IGP and route selection mode.
Otherwise, a routing loop may occur.
● If a route does not carry MED, BGP uses the default value (0) as the MED of
the route during route selection. If the bestroute med-none-as-maximum
command is run, BGP considers the largest MED value (4294967295) to be
the MED of the route. After route selection is complete, the MED is restored
to the original value.
● After the bestroute med-confederation command is configured, BGP
compares the MEDs of routes only when the AS_Path attributes of the routes
carry no external AS numbers (ASs that do not belong to the confederation)
and the leftmost AS numbers in each AS_Confed_Sequence are the same.
● After the deterministic-med command is configured, routes will not be
selected in the same sequence they are received.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 767
Figure 9-34 shows an example of using the MED attribute in BGP route selection.
In Figure 9-34, ISP1 and ISP2 can learn the route 1.1.1.9/32 from Switch C or
Switch D.
Figure 9-34 Networking diagram for MED applications
Scenario 1: Check the BGP routing tables of Switch A and Switch B before Switch
C and Switch D are configured to modify the MED of the route 1.1.1.9/32.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 10.1.1.2 0 65001i
* 10.1.3.2 0 65001i
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 768
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 10.1.4.2 0 65001i
* 10.1.2.2 0 65001i
The preceding command output shows that both ISP1 and ISP2 select the route
learned from Switch C as the optimal route. As a result, Switch C and Switch D
cannot load-balance the traffic from ISP1 or ISP2 to 1.1.1.9/32.
Run the display bgp routing-table
ip-address command on Switch B to check the
reason why Switch B chooses the route learned from Switch C.
[SwitchB] display bgp routing-table 1.1.1.9
BGP local router ID : 10.1.2.1
Local AS number : 200
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.4.2 (10.1.1.2)
Route Duration: 00h00m58s
Direct Out-interface: GigabitEthernet0/0/2
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path 65001, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.2.2
10.1.4.2
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h01m07s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 65001, origin igp, pref-val 0, valid, external, pre 255, not preferred for router ID
Not advertised to any peer yet
The preceding command output shows that Switch B selects the route learned
from Switch C because the router ID (10.1.1.2) of Switch C is smaller than that
(10.1.2.2) of Switch D. Table 9-24 describes the attribute comparison of the routes
learned from Switch C and Switch D.
Table 9-24 Attribute comparison of the routes learned from Switch C and Switch
D
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
PrefVal 0 0 The same.
Local_Pref - - The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 65001 65001 The same length.
Origin IGP IGP The same.
MED - - The same.
Peer type EBGP EBGP The same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 769
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
IGP cost - - The same.
Cluster_List - - The same length.
Router ID 10.1.1.2 10.1.2.2 The route learned
from Switch C is
optimal.
Scenario 2: The requirements of the administrator of AS 65001 are as follows:
● For the traffic from ISP1 to 1.1.1.9/32, the link Switch A -> Switch C is active
and the link Switch A -> Switch D is backup.
● For the traffic from ISP2 to 1.1.1.9/32, the link Switch B -> Switch D is active
and the link Switch B -> Switch C is backup.
To meet the preceding requirements, ensure that ISP1 selects the route learned
from Switch C and that ISP2 selects the route learned from Switch D. Figure 9-35
shows the networking in which MED is used to control route selection.
Figure 9-35 Networking diagram for MED applications
Configure route-policies to set different MED values for the routes learned from
different peers. Detailed configurations are as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 770
● Configurations on Switch C:
#
bgp 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.4.1 route-policy addmed100 export //Apply export policy named addmed100 to the
routes to be advertised to 10.1.4.1 and use addmed100 to modify the MED value.
#
route-policy addmed100 permit node 10 //Define the first node of addmed100 and set the
MED of the route 1.1.1.9/32 to 100.
if-match ip-prefix p1
apply cost 100
#
route-policy addmed100 permit node 20 //Define the second node of addmed100 to allow
addmed100 to permit all other routes.
#
ip ip-prefix p1 index 10 permit 1.1.1.9 32 //Configure an IP prefix list to match the route
1.1.1.9/32.
● Configurations on Switch D:
NOTE
The following configurations are intended to ensure that Switch A selects the route
learned from Switch C. However, Switch A has already selected the route learned from
Switch C because the router ID of Switch C is smaller than that of Switch D. Therefore,
the following configurations on Switch D are optional.
#
bgp 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.3.1 route-policy addmed200 export //Apply export policy named addmed200 to the
routes to be advertised to 10.1.3.1 and use addmed200 to modify the MED value.
#
route-policy addmed200 permit node 10 //Define the first node of addmed200 and set the
MED of the route 1.1.1.9/32 to 200.
if-match ip-prefix p1
apply cost 200
#
route-policy addmed200 permit node 20 //Define the second node of addmed200 to allow
addmed200 to permit all other routes.
#
ip ip-prefix p1 index 10 permit 1.1.1.9 32 //Configure an IP prefix list to match the route
1.1.1.9/32.
Run the display bgp routing-table [
ip-address ] command to check the
configurations. Use Switch B as an example.
# Display the routing table of Switch B.
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 10.1.2.2 0 65001i
* 10.1.4.2 100 0 65001i
# Display detailed information about the route 1.1.1.9/32 on Switch B.
[SwitchB] display bgp routing-table 1.1.1.9 32
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 771
BGP local router ID : 10.1.2.1
Local AS number : 200
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 01h20m38s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 65001, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.2.2
10.1.4.2
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.4.2 (10.1.1.2)
Route Duration: 01h16m28s
Direct Out-interface: GigabitEthernet0/0/2
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path 65001, origin igp, MED 100, pref-val 0, valid, external, pre 255, not preferred for MED
Not advertised to any peer yet
The preceding command output shows that two routes 1.1.1.9/32 are available in
the BGP routing table of Switch B and that only the route with next hop address
10.1.2.2 is selected as the optimal route.
Table 9-25 describes the attribute comparison of the routes learned from Switch C
and Switch D.
Table 9-25 Attribute comparison of the routes learned from Switch C and Switch
D
Route Attribute Route Learned
from Switch C
Route Learned
from Switch D
Comparison
PrefVal 0 0 The same.
Local_Pref - - The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 65001 65001 The same length.
Origin IGP IGP The same.
MED 100 - The route learned
from Switch D
carries no MED
value, and
therefore, the
default value (0)
is used.
The route learned
from Switch D is
optimal.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 772
Figure 9-35 shows that the route learned from Switch D does not carry the MED
value. During route selection, BGP uses the default value (0) as the MED of the
route. Therefore, this route is selected as the optimal route. To change the route
selection result on Switch B, run the bestroute med-none-as-maximum
command on Switch B. Detailed configurations are as follows:
[SwitchB] display bgp routing-table
BGP Local router ID is 10.1.2.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 1.1.1.9/32 10.1.4.2 100 0 65001i
* 10.1.2.2 0 65001i
[SwitchB] display bgp routing-table 1.1.1.9
BGP local router ID : 10.1.2.1
Local AS number : 200
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.4.2 (10.1.1.2)
Route Duration: 00h08m42s
Direct Out-interface: GigabitEthernet0/0/2
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path 65001, origin igp, MED 100, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.2.2
10.1.4.2
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 16h33m10s
Direct Out-interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 65001, origin igp, pref-val 0, valid, external, pre 255, not preferred for MED
Not advertised to any peer yet
The preceding command output shows that two routes 1.1.1.9/32 are available in
the BGP routing table of Switch B. The MED of the route with the next hop
address 10.1.4.2 is 100, and the MED of the route with the next hop address
10.1.2.2 is considered as 4294967295 because it carries no MED. Therefore, the
route with the next hop address 10.1.4.2 is selected as the optimal route.
In addition, BGP selects routes in the same sequence they are received. Therefore,
the route selection result is relevant to the sequence in which the routes are
received. For example, the following three BGP routes are available on a device:
● Route A1: AS_Path { 65001 200 }, med 100, igp cost 13, internal, Router id
4.4.4.4
● Route A2: AS_Path { 65001 100 }, med 150, igp cost 11, internal, Router id
5.5.5.5
● Route B: AS_Path { 65002 300 }, med 0, igp cost 12, internal, Router id 6.6.6.6
If the compare-different-as-med (BGP) command is run, route B is the optimal
route, regardless of the sequence in which the routes are received. If the compare-
different-as-med (BGP) command is not configured, BGP does not compare the
MED values of routes learned from different ASs. The route selection is described
in the following cases:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 773
● Case 1: Route A1 is received first, followed by route B, and then route A2.
– BGP first compares route A1 and route B. The leftmost AS number in the
AS_Path of route A1 is 65001, which is different from its counterpart in
route B (65002). Therefore, BGP does not compare the MED values, and
prefers route B to route A1 because the IGP cost (12) of route B is
smaller than that of route A1 (13).
– BGP then compares route A2 and route B. The leftmost AS number in the
AS_Path of route A2 is 65001, which is different from its counterpart in
route B (65002). Therefore, BGP does not compare the MED values, and
selects route A2 as the optimal route because its IGP cost (11) is smaller
than that of route B (12).
● Case 2: Route A2 is received first, followed by route B, and then route A1.
– BGP then compares route A2 and route B. The leftmost AS number in the
AS_Path of route A2 is 65001, which is different from its counterpart in
route B (65002). Therefore, BGP does not compare the MED values and
prefers route A2 to route B because the IGP cost (11) of route A2 is
smaller than that of route B (12).
– BGP then compares route A1 and route A2. The leftmost AS number in
the AS_Path of route A1 is the same as its counterpart in route A2
(65001). In this situation, BGP selects route A1 as the optimal route
because its MED value (100) is smaller than that of route A2 (150).
● Case 3: If the deterministic-med command is run, BGP groups the routes that
are learned from different ASs but are destined for the same network
segment based on the leftmost AS number in the AS_Path, selects one
optimal route from each group, and then compares the optimal routes of all
the groups. Detailed steps are as follows:
– BGP first compares route A1 and route A2. The leftmost AS number in
the AS_Path of route A1 is the same as its counterpart in route A2
(65001). In this situation, BGP selects route A1 as the optimal route
because its MED value (100) is smaller than that of route A2 (150).
– BGP then compares route A1 and route B. The leftmost AS number in the
AS_Path of route A1 is 65001, which is different from its counterpart in
route B (65002). Therefore, BGP does not compare the MED values and
selects route B as the optimal route because the IGP cost (12) of route B
is smaller than that of route A1 (13).
Case 1 and case 2 show that the route selection result is relevant to the sequence
in which routes are received if the deterministic-med is not configured. Case 3
shows that the route selection result is irrelevant to the sequence in which routes
are received if the deterministic-med is configured.
9.2.18.9 Peer Type
When one EBGP route and multiple IBGP routes are available, BGP selects the
optimal route based on the peer type. If no EBGP route is available or multiple
EBGP routes are available, BGP is unable to select the optimal route based on the
peer type.
When multiple egress devices reside on a carrier network and receive routes from
the Internet, the egress devices select the optimal route based on the peer type in
most cases. In Figure 9-36, all devices reside in the same AS, Switch A and Switch
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 774
B function as egress devices and are IBGP peers of all devices in the AS. In
addition, Switch A and Switch B receive routes from the Internet and advertise
EBGP routes to all their IBGP peers. Therefore, Switch A and Switch B have an
IBGP route and an EBGP route, and the two routes have the same AS_Path. In this
situation, Switch A and Switch B select the EBGP route as the optimal route.
Figure 9-36 Peer type application networking
The EBGP route is selected as the optimal route, which prevents the traffic that
leaves Switch A or Switch B for the Internet from being forwarded to the other
egress device.
For more peer type-based route selection examples, see 9.2.18.4 Local_Pref.
9.2.18.10 IGP Cost
This rule helps BGP to choose the route with the smallest cost to its recursive next
hop address quickly. If the bestroute igp-metric-ignore command is configured,
BGP does not compare the IGP cost. In Figure 9-37, OSPF runs in AS 65001, an
EBGP peer relationship is established between Switch E and Switch A and between
Switch E and Switch B, and an IBGP peer relationship is established between
Switch A and Switch C, between Switch A and Switch D, between Switch B and
Switch C, and between Switch B and Switch D; Switch E is configured to import
routes (10.1.1.1/32 for example) from AS 100 to BGP.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 775
Figure 9-37 Networking diagram with IGP cost configurations
Run the display bgp routing-table [
ip-address ] command on Switch C and
Switch D to check the configurations. Switch C is used as an example.
# Display the routing table of Switch C.
[SwitchC] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.1.1/32 10.1.5.2 0 100 0 100i
* i 10.1.6.2 0 100 0 100i
*>i 10.1.5.0/30 10.1.3.2 0 100 0 i
*>i 10.1.6.0/30 10.1.2.2 0 100 0 i
The preceding command output shows that two routes 10.1.1.1/32 are available in
the routing table of Switch C and that Switch C selects the route learned from
Switch A.
[SwitchC] display bgp routing-table 10.1.1.1
BGP local router ID : 10.1.1.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.1/32:
From: 10.1.3.2 (10.1.1.2)
Route Duration: 00h00m44s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.5.2
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 776
Not advertised to any peer yet
BGP routing table entry information of 10.1.1.1/32:
From: 10.1.2.2 (10.1.2.2)
Route Duration: 00h00m39s
Relay IP Nexthop: 10.1.1.2
Relay IP Out-Interface: GigabitEthernet0/0/1
Original nexthop: 10.1.6.2
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, IGP cost 2, not preferred
for IGP cost
Not advertised to any peer yet
The preceding command output shows that the route with next hop address
10.1.6.2 is ignored because its IGP cost is larger than that of the other route. Table
9-26 describes the attribute comparison of the routes learned from Switch A and
Switch B.
Table 9-26 Attribute comparison of the routes learned from Switch A and Switch
B.
Route Attribute Route Learned
from Switch A
Route Learned
from Switch B
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path 100 100 The same length.
Origin IGP IGP The same.
MED 0 0 The same.
Peer type IBGP IBGP The same.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 777
Route Attribute Route Learned
from Switch A
Route Learned
from Switch B
Comparison
IGP cost - 2 The route learned
from Switch A is
optimal.
NOTE
If a BGP route
carries no IGP cost
value, BGP
considers its IGP
cost to be 0. If no
IGP routes are
used during BGP
peer relationship
establishment or
the costs of used
IGP routes are 0,
the IGP cost is not
displayed in the
display bgp
routing-table
ip-
address command
output.
9.2.18.11 Cluster_List
An RR and its clients form a cluster. In an AS, each RR is uniquely identified by a
Cluster_ID.
Similar to an AS_Path, a Cluster_List is composed of a series of Cluster_IDs and is
generated by an RR. The Cluster_List records all the RRs through which a route
passes.
● Before an RR reflects a route between its clients or between its clients and
non-clients, the RR adds the local Cluster_ID to the leftmost position of the
Cluster_List. If a route does not carry any Cluster_List, the RR creates one for
the route.
● After the RR receives an updated route, it checks the Cluster_List of the route.
If the RR finds that its cluster ID is included in the Cluster_List, the RR discards
the route. If its cluster ID is not included in the Cluster_List, the RR adds its
cluster ID to the Cluster_List and then reflects the route.
The following example shows how Cluster_List is used in BGP route selection. In
Figure 9-38, an IBGP peer relationship is established between each two
neighboring devices in AS 65001. Switch B functions as a level-1 RR, and Switch D
is its client. Switch D functions as a level-2 RR, and Switch E is its client. Switch C
functions as an RR, and Switch E is its client. Switch E is configured to import the
route 1.1.1.9/32 to BGP.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 778
Figure 9-38 Networking diagram with Cluster_List configurations
Run the display bgp routing-table [
ip-address ] command on Switch A to check
the configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.3.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 1.1.1.9/32 10.1.5.2 0 100 0 i
* i 10.1.4.2 0 100 0 i
The preceding command output shows that two routes 1.1.1.9/32 are available in
the routing table of Switch C and that Switch A selects the route learned from
Switch C.
[SwitchA] display bgp routing-table 1.1.1.9
BGP local router ID : 10.1.3.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.3.2 (2.2.2.9)
Route Duration: 00h53m08s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet0/0/1
Original nexthop: 10.1.5.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255, IGP cost
3
Originator: 1.1.1.9
Cluster list: 0.0.0.3
Not advertised to any peer yet
BGP routing table entry information of 1.1.1.9/32:
From: 10.1.1.2 (10.1.2.1)
Route Duration: 00h28m05s
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 779
Relay IP Nexthop: 10.1.1.2
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.4.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, IGP cost 3, not preferred
for Cluster List
Originator: 1.1.1.9
Cluster list: 0.0.0.2, 0.0.0.1
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch B is
ignored because its Cluster_List is longer than that of the route learned from
Switch C. Table 9-27 describes attribute comparison of the routes learned from
Switch B and Switch C.
Table 9-27 Attribute comparison of the routes learned from Switch B and Switch
C
Route Attribute Route Learned
from Switch B
Route Learned
from Switch C
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path - - The same length.
Origin IGP IGP The same.
MED 0 0 The same.
Peer type IBGP IBGP The same.
IGP cost 3 3 The same.
Cluster_List 0.0.0.2, 0.0.0.1 0.0.0.3 The route learned
from Switch C is
optimal.
In most cases, BGP does not advertise the routes learned from an AS to the AS
again. When RRs are deployed, such routes may be advertised to the AS again
although routing loops may occur. Using the Cluster_List attribute can prevent
such routing loops.
9.2.18.12 Originator_ID
The Originator_ID attribute is four bytes long and is generated by an RR. It carries
the router ID of the route originator in the local AS.
● When a route is reflected by an RR for the first time, the RR adds the
Originator_ID to this route. If a route already carries the Originator_ID
attribute, the RR does not create a new one.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 780
● After receiving the route, a BGP speaker checks whether the Originator_ID is
the same as its router ID. If Originator_ID is the same as its router ID, the BGP
speaker discards this route.
The following example shows how Originator_ID is used during BGP route
selection. In Figure 9-39, an IBGP peer relationship is established between each
two neighboring devices in AS 65001. The router IDs of Switch B and Switch C are
2.2.2.9 and 3.3.3.9, respectively, and they function as RRs. Switch D is a client of
Switch B, and Switch E is a client of Switch C. Switch D and Switch E are
configured to import the route 10.1.4.0/30 to BGP.
Figure 9-39 Networking diagram with Originator_ID configurations
Run the display bgp routing-table [
ip-address ] command on Switch A to check
the configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.3.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.4.0/30 10.1.5.2 0 100 0 i
* i 10.1.2.2 0 100 0 i
The preceding command output shows that two routes 10.1.4.0/30 are available in
the routing table of Switch A and that Switch A selects the route learned from
Switch C.
[SwitchA] display bgp routing-table 1.1.1.9
BGP local router ID : 10.1.3.1
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.3.2 (3.3.3.9)
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 781
Route Duration: 00h00m01s
Relay IP Nexthop: 10.1.3.2
Relay IP Out-Interface: GigabitEthernet0/0/1
Original nexthop: 10.1.5.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, pre 255, IGP cost 2
Originator: 10.1.4.1
Cluster list: 0.0.0.3
Not advertised to any peer yet
BGP routing table entry information of 10.1.4.0/30:
From: 10.1.1.2 (2.2.2.9)
Route Duration: 00h00m17s
Relay IP Nexthop: 10.1.1.2
Relay IP Out-Interface: GigabitEthernet0/0/0
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, pre 255, IGP cost 2, not preferred
for router ID
Originator: 10.1.4.2
Cluster list: 0.0.0.2
Not advertised to any peer yet
The preceding command output shows that the route learned from Switch B is not
selected due to a router ID issue. In fact, the router ID of Switch B is 2.2.2.9,
smaller than that (3.3.3.9) of Switch C. The route learned from Switch B should be
selected if the router IDs are used to determine the optimal route. However, the
routes carry Originator_ID attributes. In this situation, the Originator_ID attributes
(rather than router IDs) are compared. Switch A selects the route learned from
Switch C because its Originator_ID (10.1.4.1) is smaller than that (10.1.4.2) of the
route learned from Switch B.
Table 9-28 describes the attribute comparison of the routes learned from Switch B
and Switch C.
Table 9-28 Attribute comparison of the routes learned from Switch B and Switch
C
Route Attribute Route Learned
from Switch B
Route Learned
from Switch C
Comparison
PrefVal 0 0 The same.
Local_Pref 100 100 The same.
Route type Learned from a
peer
Learned from a
peer
The same.
AIGP - - The same.
AS_Path - - The same length.
Origin IGP IGP The same.
MED 0 0 The same.
Peer type IBGP IBGP The same.
IGP cost 2 2 The same.
Cluster_List 0.0.0.2 0.0.0.3 The same length.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 782
Route Attribute Route Learned
from Switch B
Route Learned
from Switch C
Comparison
Originator_ID 10.1.4.2 10.1.4.1 The route learned
from Switch C is
optimal.
If routes carry Originator_ID attributes, the Originator_ID attributes (rather than
router IDs) are compared.
9.2.18.13 BGP Router ID
A router ID uniquely identifies a router in an AS, and the router ID can be
configured as follows:
● Run the router-id(BGP) {
ipv4-address | vpn-instance auto-select }
command. If no router ID is configured in the BGP view, BGP selects the
global router ID. For details on how a global router ID is selected, see router-
id.
● Run the router-id (BGP-VPN Instance IPv4 Address Family View) {
ipv4-
address | auto-select } command in the BGP VPN instance IPv4 address
family view. The router-id (BGP-VPN Instance IPv4 Address Family View)
command takes precedence over the router-id(BGP) command.
If each route carries an Originator_ID, the Originator_IDs rather than router IDs
are compared during route selection. The route with the smallest Originator_ID is
preferred. By default, Cluster_List takes precedence over Originator_ID during BGP
route selection. To enable Originator_ID to take precedence over Cluster_List
during BGP route selection, run the bestroute router id-prior-clusterlist
command.
For more router ID-based route selection examples, see 9.2.18.4 Local_Pref,
9.2.18.7 Origin, and 9.2.18.8 MED.
9.2.18.14 Peer IP Address
The peer IP address is the IP address specified in
ipv4-address or
ipv6-address in
the peer {
group-name |
ipv4-address |
ipv6-address } as-number {
as-number-
plain |
as-number-dot } command. The
group-name parameter specified in the
command is the one specified in the peer {
ipv4-address |
ipv6-address } group
group-name command.
If the optimal route has not been selected yet before BGP begins to compare peer
IP addresses, the local device may have established multiple BGP peer
relationships with another device through equal-cost links. In most cases, if a
backup physical link is available between two devices, using loopback interfaces to
establish a BGP peer relationship is recommended although multiple BGP peer
relationships may be established between the two devices through the physical
links.
In Figure 9-40, two physical links are available between Switch A and Switch B.
Switch A and Switch B can use loopback interfaces to establish a BGP peer
relationship or use the two links to establish two BGP peer relationships. In the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 783
following example, the two links are used to establish two BGP peer relationships
to show how peer addresses are used in route selection.
Figure 9-40 Networking in which two links are used to establish two BGP peer
relationships
The configurations on Switch A are as follows:
#
bgp 65001
peer 10.1.1.2 as-number 65002
peer 10.1.2.2 as-number 65002
#
ipv4-family unicast
peer 10.1.1.2 enable
peer 10.1.2.2 enable
#
The configurations on Switch B are as follows:
#
bgp 65002
peer 10.1.1.1 as-number 65001
peer 10.1.2.1 as-number 65001
#
ipv4-family unicast
network 2.2.2.9 255.255.255.255
peer 10.1.1.1 enable
peer 10.1.2.1 enable
#
Run the display bgp routing-table [
ip-address ] command to check the
configurations.
# Display the routing table of Switch A.
[SwitchA] display bgp routing-table
BGP Local router ID is 192.168.2.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 2.2.2.9/32 10.1.1.2 0 0 65002i
* 10.1.2.2 0 0 65002i
The preceding command output shows that two routes 2.2.2.9/32 are available in
the routing table and that the route with the next hop address 10.1.1.2 is selected
as the optimal route.
[SwitchA] display bgp routing-table 2.2.2.9
BGP local router ID : 192.168.2.3
Local AS number : 65001
Paths: 2 available, 1 best, 1 select
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 784
BGP routing table entry information of 2.2.2.9/32:
From: 10.1.1.2 (192.168.2.4)
Route Duration: 00h19m10s
Direct Out-interface: GigabitEthernet1/0/5
Original nexthop: 10.1.1.2
Qos information : 0x0
AS-path 65002, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
10.1.1.2
10.1.2.2
BGP routing table entry information of 2.2.2.9/32:
From: 10.1.2.2 (192.168.2.4)
Route Duration: 00h19m05s
Direct Out-interface: GigabitEthernet1/0/10
Original nexthop: 10.1.2.2
Qos information : 0x0
AS-path 65002, origin igp, MED 0, pref-val 0, valid, external, pre 255, not preferred for peer address
Not advertised to any peer yet
The preceding command output shows that the route with the next hop address
10.1.1.2 is selected as the optimal route because its peer IP address is smaller than
that of the other route.
9.3 Summary of BGP Configuration Tasks
Table 9-29 describes the BGP configuration tasks.
NOTE
If BGP is configured on an IPv6 network, all the peer addresses specified in the peer
command must be IPv6 addresses.
Table 9-29 BGP configuration tasks
Scenario Description Task
Configuring basic BGP
functions
The configuration of
basic BGP functions is
the foundation of the
BGP network
construction and the
precondition for other
BGP functions.
9.6 Configuring Basic
BGP Functions
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 785
Scenario Description Task
Configuring BGP security On BGP networks,
unauthorized users can
attack the BGP network
by modifying data
packets or forging
authorized users. To
ensure security of
services carried on BGP
networks, configure BGP
MD5 authentication, BGP
keychain authentication,
or Generalized TTL
Security Mechanism
(GTSM) function.
9.7 Configuring BGP
Security
Simplifying IBGP
network connections
Because routes received
from an IBGP peer will
not be sent to other
IBGP peers, fully-meshed
connections must be
established on the IBGP
network. However, when
there are many devices,
peer configuration is very
complex on the fully-
meshed IBGP network,
and the consumption of
network resources and
device CPU resources will
increase. To reduce the
number of IBGP network
connections and better
plan the network,
configure the route
reflector and
confederation.
9.8 Simplifying IBGP
Network Connections
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 786
Scenario Description Task
Configuring BGP route
selection and load
balancing
In a BGP routing table,
there may be multiple
routes to the same
destination. To guide
route selection, BGP
defines next-hop policies
and route selection rules.
The priority of next-hop
policies is higher than
that of BGP route
selection rules. After the
next-hop policies are
performed, BGP selects
routes according to the
route selection rules.
Usually there are
multiple valid routes to
the same destination on
the network. If BGP only
advertises the optimal
route to its peer,
unbalanced traffic on
different routes will
occur. The BGP load-
balancing configuration
can balance load on
different routes and
reduce network
congestion.
9.9 Configuring BGP
Route Selection and
Load Balancing
Controlling the
advertising and receiving
of BGP routes
With the expansion of
the network scale, the
sharp increase of routing
tables leads to greater
load on networks and
increasing network
security problems. To
solve this problem, filter
routes according to the
routing policies and only
send and receive
required BGP routes. In
addition, multiple routes
to the same destination
may exist. If these routes
need to pass through
different ASs, direct
service traffic to specific
ASs or filter the routes to
be advertised.
9.10 Controlling the
Receiving and
Advertisement of BGP
Routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 787
Scenario Description Task
Adjusting the BGP
network convergence
speed
To enable BGP to rapidly
detect network changes,
speed up the BGP
network convergence. To
minimize the effect on
networks from route
flapping and reduce load
on the device, slow down
the BGP network
convergence.
9.11 Adjusting the BGP
Network Convergence
Speed
Configuring BGP
reliability
To avoid long service
interruption when faults
occur on BGP networks,
adopt the solution of
standby link. However,
the BGP mechanism
requires more than 1
second to detect the
faults and perform an
active/standby
switchover. To ensure
that users of delay-
sensitive services such as
the voice service do not
detect the service
interruption, associate
BGP tracking, BGP, and
BFD to implement fast
fault detection, and use
BGP GR to perform a
fast switchover after the
fault detection.
9.12 Configuring BGP
Reliability
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 788
Scenario Description Task
Configuring BGP route
summarization
The BGP routing table on
a medium or large BGP
network contains a large
number of routing
entries. Storing the
routing table consumes a
lot of memory, and
transmitting and
processing the routing
information consumes a
lot of network resources.
Route summarization
can reduce the size of a
routing table, prevent
specific routes from
being advertised, and
minimize the impact of
route flapping on
networks. Although BGP
automatic route
summarization is easy to
configure, it only
summarizes routes
according to the natural
network segment. BGP
manual route
summarization can be
used with flexible
routing policies to enable
BGP to effectively
transmit and control
routes.
9.13 Configuring BGP
Route Summarization
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 789
Scenario Description Task
Configuring BGP to
advertise default routes
to peers
The BGP routing table on
a medium or large BGP
network contains a large
number of routing
entries. Storing the
routing table consumes a
large number of memory
resources, and
transmitting and
processing the routing
information consumes a
large number of network
resources. If multiple
routes in a peer BGP
routing table are sent
only from a local device,
configure the local
device to send a default
route to its peer. In this
case, the local device will
send a default route with
the next-hop address as
the local address to its
peer, regardless of
whether there is a
default route in the local
routing table. After the
local device is configured
to send only the default
route to its peer using
the routing policies, the
number of network
routes is greatly reduced
and the peer and
network memory
resources are greatly
saved.
9.14 Configuring BGP to
Advertise Default
Routes to Peers
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 790
Scenario Description Task
Configuring MP-BGP Traditional BGP-4 only
manages IPv4 unicast
routing information and
does not support route
transmission between
ASs of other networks
such as multicast
networks. To support
multiple types of
network layer protocols,
the Internet Engineering
Task Force (IETF)
extends BGP-4 to
Multiprotocol Extensions
for BGP-4 (MP-BGP)
defined in RFC 4760. MP-
BGP is called Multicast
BGP (MBGP) on
multicast networks.
9.15 Configuring MP-
BGP
9.4 Licensing Requirements and Limitations for BGP
Involved Network Elements
Other network elements are required to support BGP.
Licensing Requirements
The BGP4/BGP4+ feature is a basic feature of a switch and is not under license
control.
Feature Support in V200R024C00
Only the following switch models support BGP:
S5720I-SI, S500, S5735-S, S5735-S-I, S5735S-H, S5736-S, S5731-H, S5731-S,
S5731S-H, S5731S-S, S5732-H, S6735-S, S6720S-S, S6730-H, S6730S-H, S6730-S,
and S6730S-S
NOTE
For details about the hardware specifications and matched parts of the switch, visit
Hardware Center. For details about the key specifications and full software specifications of
the switch, visit Specifications Query.
The S5751-L, S5731-L, and S5731S-L are remote units and do not support web-based
management, YANG, or commands. They can be configured only through configuration
delivery by the central device. For details, see "Simplified Architecture Configuration (the
Solar System Solution)" in the
S300, S500, S2700, S5700, and S6700 V200R024C00
Configuration Guide - Device Management.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 791
Feature Limitations
None.
9.5 Default Settings for BGP
Table 9-30 describes the default settings for BGP.
Table 9-30 Default settings for BGP
Parameter Default Setting
BGP Disabled
Keepalive message interval 60s
Hold time 180s
9.6 Configuring Basic BGP Functions
Pre-configuration Tasks
Before configuring basic BGP functions, configure IP addresses for interfaces to
ensure network-layer communication between neighbor nodes.
Configuration Procedure
Perform the following operations in sequence and as required.
9.6.1 Starting a BGP Process
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
BGP is started, the local AS number is specified, and the BGP view is displayed.
NOTICE
After BGP peers are configured, changing the router ID of a BGP peer resets BGP
peer relationships.
Step 3 Run router-id
ipv4-address
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 792
A router ID is set.
NOTE
By default, BGP automatically selects the global router ID. If the IP address of a physical
interface is used as the router ID, route flapping occurs when the IP address of the physical
interface changes. To enhance network stability, configuring the address of a loopback
interface as the router ID is recommended. For router ID selection rules in the system view,
see descriptions in Command Reference about the router-id command.
----End
9.6.2 Configuring BGP Peers
Context
During the configuration of BGP peers, if the AS number of the specified peer is
the same as the local AS number, an IBGP peer is configured. If the AS number of
the specified peer is different from the local AS number, an EBGP peer is
configured. To enhance the stability of BGP connections, you are advised to use
the reachable loopback interface addresses to establish BGP connections.
When loopback interface addresses are used to establish a BGP connection, run
the peer connect-interface command on both ends of the BGP connection to
ensure the correctness of interfaces and addresses on the TCP connection. If the
command is run on only one end, the BGP connection may fail to be established.
When loopback interface addresses are used to establish an EBGP connection, the
peer ebgp-max-hop command with
hop-count greater than or equal to 2 must
be run. Otherwise, the EBGP connection cannot be established.
To perform the same configuration on a large number of peers, configure a BGP
peer group according to 9.6.3 (Optional) Configuring a BGP Peer Group to
reduce the configuration workload.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run peer {
ipv4-address |
ipv6-address } as-number {
as-number-plain |
as-
number-dot }
The BGP peer is created.
By default, no BGP peer is created.
Step 4 (Optional) Run peer
ipv4-address connect-interface
interface-type interface-
number [
ipv4-source-address ]
Or run peer
ipv6-address connect-interface
interface-type interface-number
[
ipv6-source-address ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 793
A source interface and a source IP address are specified for the peer to establish a
TCP connection.
By default, BGP uses the interface that is directly connected to the peer to
establish a TCP connection.
Step 5 (Optional) Run peer {
ipv4-address |
ipv6-address } ebgp-max-hop [
hop-count ]
The maximum number of hops allowed for the establishment of an EBGP
connection is set.
By default, the maximum number of hops allowed for an EBGP connection is 1.
That is, an EBGP connection must be established on a directly connected physical
link.
If a one-hop EBGP peer relationship is established using loopback interface
addresses, you can also run the peer connected-check-ignore command to
establish an EBGP peer relationship.
Step 6 (Optional) Run peer {
ipv4-address |
ipv6-address } description
description-text
The description of the peer is configured.
NOTE
If a BGP peer is configured on an IPv4 unicast network, steps 7 and 8 are not required. If a
BGP peer is configured on an IPv4 multicast network and an IPv6 unicast network, steps 7
and 8 are required.
Step 7 (Optional) Run the following commands as required.
● Run ipv4-family multicast
The BGP-IPv4 multicast address family view is displayed.
● Run ipv6-family [ unicast ]
The BGP-IPv6 unicast address family view is displayed.
Step 8 (Optional) Run peer {
ipv4-address |
ipv6-address } enable
MP-BGP is enabled on the BGP peers to configure them as MP-BGP peers.
----End
9.6.3 (Optional) Configuring a BGP Peer Group
Context
A large BGP network has a large number of peers. It is difficult to configure and
maintain these peers. You can add the BGP peers with the same configurations to
a BGP peer group and then configure the BGP peers in batches. This simplifies
peer management and improves route advertisement efficiency.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 794
NOTE
● If a function is configured on a peer and its peer group, the function configured on the peer
takes precedence over that configured on the peer group.
● When loopback interface addresses are used to establish a BGP connection, you are advised
to perform step 6 on the both ends of the BGP connection simultaneously to ensure the
correct establishment of the connection. If step 6 is performed on only one end, the BGP
connection may fail to be established.
● When loopback interfaces are used to establish an EBGP connection, step 7 is required and
hop-count in the
peer ebgp-max-hop command must be greater than or equal to 2.
Otherwise, the EBGP connection cannot be established.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run group
group-name [ external | internal ]
A BGP peer group is created.
NOTE
The AS number of an IBGP peer group is the local AS number. Therefore, step 4 is not
required.
Step 4 Run peer
group-name as-number {
as-number-plain |
as-number-dot }
An AS number is configured for the EBGP peer group.
NOTE
To add an EBGP peer to a peer group, configure the EBGP peer according to 9.6.2
Configuring BGP Peers and then perform step 5.
To add an IBGP peer to a peer group, perform step 5. The system creates an IBGP peer in
the BGP view and sets its AS number as the AS number of the peer group.
Step 5 Run peer {
ipv4-address |
ipv6-address } group
group-name
A peer is added to the peer group.
NOTE
You can repeat step 5 to add multiple peers to a peer group.
Step 6 (Optional) Run peer
group-name connect-interface
interface-type interface-
number [
ipv4-source-address ] or peer
group-name connect-interface
interface-
type interface-number [
ipv6-source-address ]
A source interface and a source IP address are specified for the peer to establish a
TCP connection.
By default, the outbound interface of a BGP packet serves as the source interface
of a BGP packet.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 795
NOTE
The configurations of GTSM and EBGP-MAX-HOP affect the TTL values of BGP packets,
which may cause a conflict between TTL values. Therefore, you can configure only one of
the two functions for a peer or peer group.
Step 7 (Optional) Run peer
group-name ebgp-max-hop [
hop-count ]
The maximum number of hops allowed for the establishment of an EBGP
connection is set.
By default, the maximum number of hops allowed for an EBGP connection is 1.
That is, an EBGP connection must be established on a directly connected physical
link.
If a one-hop EBGP peer relationship is established using loopback interface
addresses, you can also run the peer connected-check-ignore command to
establish an EBGP peer relationship.
Step 8 (Optional) Run peer
group-name description
description-text
The description is configured for the peer group.
NOTE
If you want to configure an IPv4 peer group in the BGP-IPv4 unicast address family view,
skip steps 9, 10, and 11. To configure a BGP peer group in another address family view,
perform steps 9, 10, and 11.
Step 9 Enter the required address family view based on the actual network. The following
example uses the BGP-IPv6 unicast address family view.
Run ipv6-family [ unicast ]
The BGP-IPv6 unicast address family view is displayed.
Step 10 Run peer
group-name enable
The switch is enabled to exchange routing information with the specified peer or
peer group in the address family view.
Step 11 Run peer {
ipv4-address |
ipv6-address } group
group-name
The specified peer is added to the peer group.
----End
9.6.4 (Optional) Configuring Dynamic BGP Peers
Context
If static BGP peers change frequently, the local device needs to add or delete BGP
peer configurations in response to each change, which requires a heavy
maintenance workload. To address this problem, configure the dynamic BGP peer
function, which allows BGP to listen to BGP connection requests from a specified
network segment, establish BGP peer relationships dynamically, and add the peers
to a peer group. This spares the local device from adding or deleting BGP peer
configurations in response to each change in the peer number, which reduces the
maintenance workload.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 796
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 (Optional) Run bgp dynamic-session-limit
limit-value
The maximum number of dynamic BGP peer sessions is configured.
By default, a maximum of 100 dynamic BGP peer sessions can be established after
the dynamic BGP peer function is enabled.
Step 4 (Optional) Run ipv4-family vpn-instance
vpn-instance-name
The BGP-VPN instance IPv4 address family view is displayed.
Perform this step if you need to configure the dynamic BGP peer function in the
BGP-VPN instance IPv4 address family view in a BGP/MPLS IP VPN scenario.
Step 5 Run group
group-name [ external | internal ]
A BGP peer group is created.
● If the local device and its peers reside in the same AS, configure internal to
create an IBGP peer group.
● If the local device and its peers reside in different ASs, configure external to
create an EBGP peer group.
Step 6 Run peer
group-name listen-net
network {
mask |
mask-length }
BGP is configured to listen to BGP connection requests from a specified network
segment and establish BGP peer relationships dynamically.
If you run the command multiple times, BGP listens to BGP connection requests
from multiple network segments.
Step 7 Run peer
group-name as-number {
as-number-plain |
as-number-dot }
[ optional-as {
optional-as-number-plain |
optional-as-number-dot } &<1-5> ]
An AS number is configured for the peer group.
● If the dynamic peers in the peer group reside in the same AS, configure {
as-
number-plain |
as-number-dot } to set a fixed AS number.
● If the dynamic peers in the peer group may reside in different ASs, in addition
to a fixed AS number, you need to configure optional-as {
optional-as-
number-plain |
optional-as-number-dot } &<1-5> to set an optional AS
number. A maximum of five optional AS numbers can be set.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 797
9.6.5 Configuring BGP to Import Routes
Context
BGP cannot discover routes and needs to import routes such as IGP routes into
BGP routing tables so that the imported routes can be transmitted within an AS or
between ASs. BGP imports routes in either import or network mode:
● In import mode, BGP imports IGP routes, including RIP, OSPF, and IS-IS routes,
into BGP routing tables based on protocol type. To ensure the validity of
imported IGP routes, BGP can also import static routes and direct routes in
import mode.
● In network mode, BGP imports the routes in the IP routing table one by one
into BGP routing tables. The network mode is more accurate than the import
mode.
Procedure
● In import mode
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Run import-route
protocol [
process-id ] [ med
med | route-policy
route-policy-name ] *
BGP is configured to import routes of other routing protocols.
e. (Optional) Run default-route imported
BGP is allowed to import default routes from the local IP routing table.
To import default routes, you need to run both the default-route
imported command and the import-route (BGP) command. If only the
import-route (BGP) command is used, default routes cannot be
imported. In addition, the default-route imported command is used to
import only the default routes that exist in the local routing table.
By default, BGP does not add default routes to BGP routing tables.
● In network mode
a. Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 798
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Run network
ipv4-address [
mask |
mask-length ] [ route-policy
route-
policy-name ]
Or run network
ipv6-address prefix-length [ route-policy
route-policy-
name ]
BGP is configured to import routes from the IPv4 or IPv6 routing table
one by one.
----End
9.6.6 Verifying the Basic BGP Function Configuration
Procedure
● Run the display bgp peer [ verbose ] command to check information about
all BGP peers.
● Run the display bgp peer
ipv4-address { log-info | verbose } command to
check information about the specified BGP peer.
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check BGP routing information.
● Run the display bgp group [
group-name ] command to check information
about the specified BGP peer group.
● Run the display bgp multicast peer [ [
peer-address ] verbose ] command to
check information about the specified MBGP peer.
● Run the display bgp multicast group [
group-name ] command to check
information about an MBGP peer group.
● Run the display bgp multicast network command to check the routing
information that MBGP advertises.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check the
MBGP routing table.
----End
9.7 Configuring BGP Security
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 799
Pre-configuration Tasks
Before configuring BGP security, configure basic BGP functions.
Configuration Procedure
You can perform the following configuration tasks as required. The following
configuration tasks (excluding the task of Verifying the BGP Security
Configuration) can be performed in any sequence.
9.7.1 Configuring MD5 Authentication
Context
BGP uses TCP as the transmission protocol, and considers a packet valid as long as
the source address, destination address, source port, destination port, and TCP
sequence number of the packet are correct. However, most parameters in a packet
may be easily obtained by attackers. To protect BGP from attacks, use MD5
authentication or keychain authentication between BGP peers to reduce the
possibility of attacks. The MD5 algorithm is easy to configure and generates a
single password that can only be manually changed.
NOTICE
If simple is selected during the configuration of the MD5 authentication
password, the password is saved in the configuration file in plain text. This brings
security risks. It is recommended that you select cipher to save the password in
cipher text. MD5 authentication has potential security risks.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run peer {
ipv4-address |
group-name |
ipv6-address } password { cipher
cipher-
password | simple
simple-password }
The MD5 authentication password is set.
NOTE
● To prevent the MD5 password set on BGP peers from being decrypted, update the MD5
password periodically.
● BGP MD5 authentication and BGP keychain authentication are mutually exclusive, and
only either of them can be configured for a BGP peer.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 800
9.7.2 Configuring Keychain Authentication
Context
BGP uses TCP as the transmission protocol, and considers a packet valid as long as
the source address, destination address, source port, destination port, and TCP
sequence number of the packet are correct. However, most parameters in a packet
may be easily obtained by attackers. To protect BGP from attacks, use MD5
authentication or keychain authentication between BGP peers to reduce the
possibility of attacks. The keychain algorithm is complex to configure and
generates a set of passwords. Keychain authentication allows automatically
changing a password based on the configuration. Therefore, keychain
authentication applies to networks requiring high security.
NOTE
Before configuring BGP keychain authentication, configure a keychain corresponding to
keychain-name. Otherwise, the TCP connection cannot be established. For details about
configuring a keychain, see Keychain Configuration in the
S300, S500, S2700, S5700, and
S6700 V200R024C00 Configuration Guide - Security.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run peer {
ipv4-address |
group-name |
ipv6-address } keychain
keychain-name
Keychain authentication is configured.
NOTE
● You must configure keychain authentication on both ends of the BGP connection.
Encryption algorithms and passwords configured on both ends must be the same;
otherwise, the TCP connection cannot be established between BGP peers and BGP
messages cannot be transmitted. SHA256 and HMAC-SHA256 encryption algorithms are
recommended in keychain authentication.
● BGP MD5 authentication and BGP keychain authentication are mutually exclusive, and
only either of them can be configured for a BGP peer.
● Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-
H, S6730-S, and S6730S-S support keychain
keychain-name.
----End
9.7.3 Configuring BGP GTSM
Context
To protect a device against the attacks of forged BGP packets, you can configure
GTSM to check whether the TTL value in the IP packet header is within the
specified range. GTSM allows or discards packets with TTL values outside of the
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 801
specified range according to networking requirements. When the default action to
be taken on packets is set to drop in GTSM, set a proper TTL range according to
the network topology. Then packets with TTL values outside of the specified range
are discarded. This prevents attackers from sending forged BGP packets to
consume CPU resources.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
NOTE
The configurations of GTSM and peer ebgp-max-hop affect the TTL values of BGP packets,
which may cause a conflict between TTL values. Therefore, you can configure only either of
the two functions for a peer or peer group.
Step 3 Run peer {
group-name |
ipv4-address |
ipv6-address } valid-ttl-hops [
hops ]
BGP GTSM is configured.
By default, GTSM is not configured on any BGP peer or peer group.
Step 4 (Optional) Run the gtsm default-action { drop | pass } command in the system
view:
The default action to be taken on the packets that do not match a GTSM policy is
set.
By default, the action to be taken on the packets that do not match the GTSM
policy is pass.
Step 5 (Optional) Run the gtsm log drop-packet all command in the system view:
The function of recording logs about discarded GTSM packet is enabled on the
device.
The logs help locate faults.
----End
9.7.4 Verifying the BGP Security Configuration
Procedure
● Run the display bgp peer verbose command to check detailed authentication
information about the specified BGP peer.
----End
9.8 Simplifying IBGP Network Connections
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 802
Pre-configuration Tasks
Before simplifying IBGP network connections, configure basic BGP functions.
Configuration Procedure
Perform the following configuration tasks in any sequence as required.
9.8.1 Configuring a BGP Route Reflector
Context
To ensure the connectivity between IBGP peers within an AS, you need to establish
full-mesh connections between the IBGP peers. When there are many IBGP peers,
it is costly to establish a fully-meshed network. A route reflector (RR) can solve
this problem.
A cluster ID can help prevent routing loops between multiple RRs within a cluster
and between clusters. When a cluster has multiple RRs, the same cluster ID must
be configured for all the RRs within the cluster.
If full-mesh IBGP connections are established between clients of multiple RRs,
route reflection between clients is not required and wastes bandwidth resources.
In this case, prohibit route reflection between clients to reduce the network
burden.
Within an AS, an RR transmits routing information and forwards traffic. When an
RR connects to a large number of clients and non-clients, many CPU resources are
consumed if the RR transmits routing information and forwards traffic
simultaneously. This also reduces route transmission efficiency. To improve route
transmission efficiency, prohibit BGP from adding preferred routes to IP routing
tables on the RR to enable the RR only to transmit routing information.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
BGP is enabled and the BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family unicast
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run peer {
group-name |
ipv4-address |
ipv6-address } reflect-client
An RR and its client are configured.
By default, the route reflector and its client are not configured.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 803
Step 5 (Optional) Run reflector cluster-id
cluster-id
A cluster ID is configured for the RR.
By default, each RR uses its router ID as the cluster ID.
Step 6 (Optional) Run undo reflect between-clients
Route reflection is prohibited between clients.
By default, route reflection is allowed between clients.
Step 7 (Optional) Run routing-table rib-only [ route-policy
route-policy-name ]
BGP is prohibited from adding preferred routes to IP routing tables.
By default, BGP adds preferred routes to IP routing tables.
----End
Verifying the Configuration
● Run the display bgp group [
group-name ] command to check information
about the specified BGP peer group.
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check routing information in a BGP
routing table.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check the
MBGP routing table.
9.8.2 Configuring a BGP Confederation
Context
A confederation divides an AS into sub-ASs. Within each sub-AS, IBGP peers
establish full-mesh connections or have an RR configured. Sub-ASs establish EBGP
connections. On a large BGP network, configuring a confederation can reduce the
number of IBGP connections, simplify routing policy management, and improve
route advertisement efficiency.
Other devices may implement the confederation not in accordance with RFC 3065.
You can configure confederation compatibility to make standard devices
compatible with nonstandard devices.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
BGP is enabled and the BGP view is displayed.
Step 3 Run confederation id {
as-number-plain |
as-number-dot }
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 804
A confederation ID is configured.
By default, no BGP confederation is configured.
NOTICE
An old speaker that has a 2-byte AS number cannot be in the same confederation
with a new speaker that has a 4-byte AS number. Otherwise, a routing loop may
occur. This is because the AS4_Path attribute does not support confederations.
Step 4 Run confederation peer-as {
as-number-plain |
as-number-dot } &<1-32>
A sub-AS number is configured for a confederation.
By default, no sub-AS number of the confederation is configured.
Step 5 (Optional) Run confederation nonstandard
Confederation compatibility is configured.
By default, confederations comply with RFC 3065.
----End
Verifying the Configuration
● Run the display bgp peer [
ipv4-address ] verbose command to check
detailed information about BGP peers.
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check routing information in a BGP
routing table.
9.9 Configuring BGP Route Selection and Load
Balancing
Pre-configuration Tasks
Before configuring BGP route attributes, configure basic BGP functions.
Configuration Procedure
Perform the following configuration tasks as required. The following configuration
tasks (excluding the task of Verifying the BGP Route Selection and Load Balancing
Configuration) can be performed in any sequence. For detailed route selection
rules, see 9.2.5 BGP Route Selection Rules and Load Balancing.
9.9.1 Configuring the BGP Priority
Context
The routing protocols may share and select routing information because switches
may run multiple dynamic routing protocols at the same time. The system sets a
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 805
default priority for each routing protocol. When multiple routing protocols are
used to select routes, the route selected by the routing protocol with a higher
priority takes effect.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run preference {
external internal local | route-policy
route-policy-name }
Or run preference
external internal local route-policy
route-policy-name
The BGP priority is set.
The default BGP priority is 255.
The smaller the preference value, the higher the preference.
BGP has the following types of routes:
● EBGP routes learned from peers in other ASs
● IBGP routes learned from peers in the same AS
● Locally originated routes (A locally originated route is a route summarized by
using the summary automatic command or the aggregate command.)
Different preference values can be set for these three types of routes.
In addition, a routing policy can also be used to set the preferences for the routes
that match the policy. The routes that do not match the policy use the default
preference.
NOTE
You cannot use the peer route-policy command on BGP peers to apply routing policies to
set the BGP priority.
----End
9.9.2 Configuring the Next_Hop Attribute
Context
When an Autonomous System Boundary Router (ASBR) forwards the route
learned from an EBGP peer to an IBGP peer, the ASBR does not change the next
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 806
hop of the route by default. When the IBGP peer receives this route, it finds the
next hop unreachable, sets the route to inactive, and does not use this route to
guide traffic forwarding. To enable the IBGP peer to use this route to guide traffic
forwarding, configure the ASBR to set its IP address as the next hop of the route
when the ASBR forwards this route to the IBGP peer. After the IBGP peer receives
the route from the ASBR, it finds the next hop of the route reachable, sets the
route to active, and uses this route to guide traffic forwarding.
When a BGP route changes, BGP needs to recurse the indirect next hop of the
route again. If no restriction is imposed on the recursed route, BGP may recurse
the next hop to an incorrect forwarding path, causing traffic loss. To prevent traffic
loss, configure routing policy-based route recursion.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Perform any of the following operations as required:
● Run peer {
ipv4-address |
group-name |
ipv6-address } next-hop-local
A BGP device is configured to set its IP address as the next hop when the
device advertises routes to an IBGP peer or an IBGP peer group.
By default, a BGP device does not change the next-hop address when
advertising routes to its IBGP peers.
● Run nexthop recursive-lookup route-policy
route-policy-name
BGP is configured to recurse the next hop based on a routing policy.
BGP does not recurse the next hop based on a routing policy.
● Run the peer {
ipv4-address |
group-name } next-hop-invariable command
in the IPv4 unicast address family view:
The device is prevented from changing the next-hop address of a route
imported from an IGP before advertising the route to an IBGP peer.
By default, a device changes the next-hop address of a route imported from
an IGP to the address of the interface connecting the device to its peer when
advertising the route to an IBGP peer.
NOTE
The nexthop recursive-lookup route-policy
route-policy-name command does not take
effect for the routes received from directly connected EBGP peers.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 807
9.9.3 Configuring the PrefVal Attribute
Context
The PrefVal attribute is a Huawei proprietary attribute and is valid only on the device where
it is configured. When a BGP routing table contains multiple routes to the same
destination, BGP prefers the route with the highest PrefVal.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run peer {
group-name |
ipv4-address |
ipv6-address } preferred-value
value
The PrefVal attribute is configured for all the routes learned from a specified peer.
By default, the PrefVal of a route learned from a peer is 0.
----End
9.9.4 Configuring the Default Local_Pref Attribute
Context
The Local_Pref attribute is used to determine the optimal route for outgoing traffic
of an AS. When a BGP device obtains multiple routes to the same destination
address but with different next hops from different IBGP peers, the BGP device
prefers the route with the highest Local_Pref value.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 808
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run default local-preference
local-preference
The default Local_Pref attribute is configured.
By default, the Local_Pref attribute is 100.
----End
9.9.5 Configuring the AS_Path Attribute
Context
The AS_Path attribute records all of the ASs that a route passes through from the
source to the destination in the vector order. You can configure the AS_Path
attribute to implement flexible route selection.
● Generally, BGP compares the AS_Path lists of routes and prefers the route
with the shortest AS_Path list. When the AS_Path attribute is not required in
route selection, configure BGP not to compare the AS_Path lists of routes
during route selection.
● In most cases, BGP detects routing loops based on the AS number. However,
to ensure correct route transmission on a hub-and-spoke network, you need
to configure all the BGP peers that VPN routes advertised from a hub CE to a
spoke CE pass through to accept the routes with a repeated AS number.
● Public AS numbers can be used on the Internet, but not private AS numbers
because they may cause routing loops. To prevent routing loops, configure the
AS_Path attribute to carry only public AS numbers in EBGP Update messages.
● When the AS_Path attribute is reconstructed or summarized routes are
generated, you can set the maximum number of AS numbers in the AS_Path
attribute. Then a BGP device checks whether the number of AS numbers in
the AS_Path attribute of a route exceeds the maximum value. If so, the BGP
device discards the route.
● A device usually supports only one BGP process. This indicates that a device
supports only one AS number. In some cases, for example, when network
migration changes an AS number, you can set a fake AS number to ensure
successful network migration.
● BGP checks the first AS number in the AS_Path list that is carried in the
Update message sent by an EBGP peer. If the first AS number specifies the AS
where the EBGP peer resides, BGP accepts the Update message. Otherwise,
BGP rejects the Update message and interrupts the EBGP connection. If you
do not want BGP to check the first AS number, disable the option.
Procedure
Step 1 Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 809
Step 2 Run route-policy
route-policy-name { deny | permit } node
node
A node is configured for a route-policy, and the view of the route-policy is
displayed.
Step 3 (Optional) Configure matching rules for the route-policy to change only the
community attributes of the routes that meet the matching rules.
By default, all routes meet matching rules. For details, see 10.6.2 (Optional)
Configuring an if-match Clause.
Step 4 Run apply as-path {
as-number-plain |
as-number-dot } &<1-10> { additive |
overwrite }
The AS_Path attribute is set for BGP routes.
Step 5 Run quit
Return to the system view.
Step 6 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 7 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 8 Add the AS_Path attribute to routes.
● Run peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-
policy-name export
The AS_Path attribute is added to the routes advertised to BGP peers or peer
groups.
● Run peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-
policy-name import
The AS_Path attribute is added to the routes received from BGP peers or peer
groups.
● Run import-route
protocol [
process-id ] route-policy
route-policy-name
The AS_Path attribute is added to the routes imported by BGP in import
mode.
● Run network {
ipv4-address [
mask |
mask-length ] |
ipv6-address prefix-
length } route-policy
route-policy-name
The AS_Path attribute is added to the routes imported by BGP in network
mode.
Step 9 (Optional) Run any of the following commands to configure the AS_Path attribute
as required.
● Run bestroute as-path-ignore
BGP is configured not to compare the AS_Path attributes of routes during
route selection.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 810
By default, BGP compares the AS_Path attributes of routes during route
selection.
● Run peer {
ipv4-address |
group-name |
ipv6-address } allow-as-loop
[
number ]
Repeated local AS numbers are allowed in routes.
By default, repeated local AS numbers are not allowed.
● Run peer {
ipv4-address |
group-name |
ipv6-address } public-as-only
[ force ]
BGP is configured to carry only public AS numbers in the AS_Path attribute in
an EBGP Update message.
By default, the AS_Path attribute can carry both public and private AS
numbers in an EBGP Update message.
● Run peer {
group-name |
ipv4-address |
ipv6-address } substitute-as
AS number substitution is enabled. The device replaces the AS number of the
peer specified in the AS_Path attribute with the local AS number.
By default, AS number substitution is disabled.
NOTE
Enabling BGP AS number substitution may cause route loops in a CE multi-homing
network.
● Return to the BGP view to configure the AS_Path attribute.
a. Run quit
Return to the BGP view.
b. (Optional) Run any of the following commands to configure the AS_Path
attribute as required.
▪ Run as-path-limit
as-path-limit-num
The maximum number of AS numbers in the AS_Path attribute is set.
By default, the maximum number of AS numbers in the AS_Path
attribute is 255.
▪ Run peer {
ipv4-address |
group-name |
ipv6-address } fake-as
[ prepend-global-as ]
The peer fake-as command can be used to hide the actual AS
number of a BGP device. EBGP peers in other ASs will use the fake
AS number of this BGP device to set up EBGP peer relationships with
this device.
A fake AS number is configured for an EBGP peer group.
By default, EBGP peers establish a connection using the actual AS
number.
NOTICE
Running the undo check-first-as command increases the probability
of routing loops. Therefore, exercise caution when using this
command.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 811
▪ Run undo check-first-as
BGP is configured not to check the first AS number in the AS_Path
list that is carried in the Update message sent by an EBGP peer.
By default, BGP checks the first AS number in the AS_Path list that is
carried in the Update message sent by an EBGP peer.
NOTE
When BGP is disabled from checking the first AS number, run the refresh
bgp command in the user view if you want BGP to check the first AS
number of received routes.
----End
9.9.6 Configuring the MED Attribute
Context
The multi-exit discriminator (MED) helps determine the optimal route for
incoming traffic of an AS. It is similar to the metric used in IGP. When a BGP
device obtains multiple routes to the same destination address but with different
next hops from EBGP peers, the BGP device selects the route with the smallest
MED value as the optimal route.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Perform any of the following operations as required:
● Run default med
med
The default MED value is set.
By default, the MED is 0.
● Run bestroute med-none-as-maximum
BGP defines the MED value as the maximum value if a route does not have
the MED attribute.
By default, BGP uses the default MED value when a route does not have the
MED attribute.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 812
● Run compare-different-as-med
BGP is allowed to compare the MED values of routes received from EBGP
peers in any AS.
By default, BGP compares only the MEDs of the routes received from EBGP
peers within the same AS.
● Run deterministic-med
The deterministic-MED function is enabled.
By default, the BGP deterministic-MED function is disabled.
● Run bestroute med-confederation
The MED values of routes in a confederation are compared.
By default, BGP compares only the MEDs of the routes from the same AS.
----End
9.9.7 Configuring the BGP Community Attribute
Context
The Community attribute is a private BGP route attribute. It is transmitted
between BGP peers and is not restricted within an AS. The Community attribute
allows a group of BGP devices in multiple ASs to share the same routing policies,
which simplifies routing policy applications and facilitates routing policy
management and maintenance. A BGP device can add or change the community
attributes of routes to be advertised.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run route-policy
route-policy-name { deny | permit } node
node
A node is configured for a route-policy, and the view of the route-policy is
displayed.
Step 3 (Optional) Configure matching rules for the route-policy to change only the
community attributes of the routes that meet the matching rules.
By default, all routes meet matching rules. For details, see 10.6.2 (Optional)
Configuring an if-match Clause.
Step 4 Run either of the following commands to configure the Community attribute.
● Run apply community {
community-number |
aa:nn | internet | no-advertise
| no-export | no-export-subconfed } &<1-32> [ additive ]
Common community attributes are configured for BGP routes.
NOTE
You can run this command to configure a maximum of 32 community attributes at a
time.
● Run apply extcommunity { rt {
as-number:nn |
ipv4-address:nn } } &<1-16>
[ additive ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 813
A BGP extended community attribute (route-target) is configured.
Extended community attributes are extensions to community attributes in
services. Currently, only the route-target attribute is supported in VPN.
Step 5 Run quit
Return to the system view.
Step 6 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 7 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 8 Add the Community attribute to routes.
● Run peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-
policy-name export
The Community attribute is added to the routes advertised to BGP peers or
peer groups.
● Run peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-
policy-name import
The Community attribute is added to the routes received from BGP peers or
peer groups.
● Run import-route
protocol [
process-id ] route-policy
route-policy-name
The Community attribute is added to the routes imported by BGP in import
mode.
● Run network {
ipv4-address [
mask |
mask-length ] |
ipv6-address prefix-
length } route-policy
route-policy-name
The Community attribute is added to the routes imported by BGP in network
mode.
NOTE
Step 9 is required only when the Community attribute needs to be added to the routes
advertised to BGP peers or peer groups.
Step 9 (Optional) Allow BGP to advertise community attributes when BGP adds
community attributes to the routes advertised to BGP peers or peer groups.
● Run peer {
ipv4-address |
group-name |
ipv6-address } advertise-community
BGP is allowed to advertise community attributes to BGP peers or peer
groups.
By default, BGP does not advertise community attributes to any peer or peer
group.
● To advertise an extended community attribute to a specified peer or peer
group, perform the following steps:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 814
a. Run the peer {
ipv4-address |
group-name |
ipv6-address } advertise-ext-
community command to advertise an extended community attribute to a
specified peer or peer group.
b. Run the ext-community-change enable command to enable the device
to change extended community attributes using a routing policy.
By default, BGP peers cannot change extended community attributes
using a route-policy; specifically, BGP peers advertise only the extended
community attributes carried in routes to a specified peer or peer group,
and the peer route-policy command cannot be used to modify the
extended community attributes.
----End
9.9.8 Configuring BGP Load Balancing
Context
On a large network, there may be multiple valid BGP routes to the same
destination. A switch will select and add the optimal BGP route to its routing table
for traffic forwarding and advertises this route to its peers. This, however, will
result in uneven load balancing of much traffic. Configuring BGP load balancing
can enable the switch to add these multiple equal-cost BGP routes to its routing
table, implementing traffic load balancing and reducing network congestion. After
BGP load balancing is configured, the switch will still select the optimal route
among the multiple routes and advertise only this route to its peers.
Equal-cost BGP routes can be generated for traffic load balancing only when the
first eight route attributes described in "BGP Route Selection Policies" are the
same. Change load balancing rules by adjusting some configurations, for example,
ignoring the comparison of the AS_Path attribute. When adjusting these
configurations, ensure that these configurations do not result in routing loops.
NOTE
If BGP load balancing is configured, the local device changes the next-hop address of routes
to its address when advertising routes to IBGP peer groups, regardless of whether the peer
next-hop-local command is used.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 815
The IPv6 address family view is displayed.
Step 4 Run maximum load-balancing [ ebgp | ibgp ]
number [ ecmp-nexthop-
changed ]
The maximum number of BGP routes to be used for load balancing is set.
By default, the maximum number of BGP routes to be used for load balancing is
1, indicating that load balancing is not implemented.
NOTE
● On a public network, if the routes to the same destination implement load balancing,
the system will determine the optimal route type. If the optimal routes are IBGP routes,
only IBGP routes carry out load balancing. If the optimal routes are EBGP routes, only
EBGP routes carry out load balancing. This means that load balancing cannot be
implemented among IBGP and EBGP routes with the same destination address.
● On an IPv4 multicast network, BGP compares the AS_Path attributes of the routes to be
used for load balancing. In this case, step 5 is not supported.
NOTICE
Configuring BGP not to compare the AS_Path attributes of the routes to be used
for load balancing may cause routing loops.
Step 5 (Optional) Run load-balancing as-path-ignore
BGP is configured not to compare the AS_Path attributes of the routes to be used
for load balancing.
By default, BGP compares the AS_Path attributes of the routes to be used for load
balancing.
----End
9.9.9 Verifying the BGP Route Selection and Load Balancing
Configuration
Procedure
● Run the display bgp paths [
as-regular-expression ] command to check BGP
AS_Path information.
● Run the display bgp routing-table different-origin-as command to check
the routes with the same destination address but different origin ASs.
● Run the display bgp routing-table regular-expression
as-regular-expression
command to check information about routes that match the AS regular
expression.
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check routing information in a BGP
routing table.
● Run the display bgp routing-table community [
community-number |
aa:nn ] &<1-29> [ internet | no-advertise | no-export | no-export-
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 816
subconfed ] * [ whole-match ] command to check routing information with
the specified BGP community.
● Run the display bgp routing-table community-filter { {
community-filter-
name |
basic-community-filter-number } [ whole-match ] |
advanced-
community-filter-number } command to check information about routes
matching a specified BGP community filter.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check the
MBGP routing table.
● Run the display bgp multicast routing-table statistics command to check
statistics about the MBGP routing table.
----End
9.10 Controlling the Receiving and Advertisement of
BGP Routes
Pre-configuration Tasks
Before controlling the receiving and advertisement of BGP routes, configure basic
BGP functions.
Configuration Procedure
Figure 9-41 Flowchart of controlling the receiving and advertisement of BGP
routes
9.10.1 Configuring a Routing Policy
Context
Before controlling the receiving and advertisement of BGP routes, configure
routing policies or filters of routing policies for route selection. For details, see 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 817
Routing Policy Configuration in the
S300, S500, S2700, S5700, and S6700
V200R024C00 Configuration Guide - IP Unicast Routing.
9.10.2 Controlling the Advertisement of BGP Routes
Context
There are usually a large number of routes in a BGP routing table. Transmitting a
great deal of routing information heavily burdens devices. To address this problem,
you can configure devices to advertise only the routes that they want to advertise
or routes that their peers require. Multiple routes to the same destination may
exist and traverse different ASs. Routes to be advertised need to be filtered in
order to direct routes to specific ASs.
Procedure
● Configure the BGP device to filter the routes advertised by all its peers or peer
groups.
You can configure a BGP device to filter routes to be advertised.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform either of the following operations to configure the BGP device to
advertise routes to all peers or peer groups:
▪ To filter routes based on an ACL, run the filter-policy {
acl-number |
acl-name
acl-name } export [
protocol [
process-id ] ] or the filter-
policy {
acl6-number | acl6-name
acl6-name } export [
protocol
[
process-id ] ] command.
▪ To filter routes based on an IP prefix list, run the filter-policy ip-
prefix
ip-prefix-name export [
protocol [
process-id ] ] or the filter-
policy ipv6-prefix
ipv6-prefix-name export [
protocol [
process-id ] ]
command.
NOTE
If an ACL has been referenced in the filter-policy command but no VPN instance
is specified in the ACL rule, BGP will filter routes including public and private
network routes in all address families. If a VPN instance is specified in the ACL
rule, only the data traffic from the VPN instance will be filtered, and no route of
this VPN instance will be filtered.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 818
● Configure BGP to filter the routes advertised by a specified peer or peer
group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform any of the following operations to configure the BGP device to
advertise routes to a specific peer or peer group:
▪ To filter routes based on an ACL, run the peer {
group-name |
ipv4-
address |
ipv6-address } filter-policy {
acl-number | acl-name
acl-
name |
acl6-number | acl6-name
acl6-name } export command.
▪ To filter routes based on an IP prefix list, run the peer {
ipv4-address
|
group-name } ip-prefix
ip-prefix-name export or the peer {
group-
name |
ipv4-address |
ipv6-address } ipv6-prefix
ipv6-prefix-name
export command.
▪ To filter routes based on an AS_Path filter, run the peer {
ipv4-
address |
group-name |
ipv6-address } as-path-filter {
as-path-filter-
number |
as-path-filter-name } export command.
▪ To filter routes based on a route-policy, run the peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-policy-name export
command.
NOTE
The routing policy applied in the peer route-policy export command does not
support a specific interface as one matching rule. That is, the routing policy does
not support the if-match interface command.
----End
9.10.3 Controlling the Receiving of BGP Routes
Context
When a BGP device is attacked or network configuration errors occur, the BGP
device will receive a large number of routes from its peer. As a result, many device
resources are consumed. Therefore, the administrator must limit the resources
used by the device based on network planning and device capacity. BGP provides
peer-based route control to limit the number of routes to be sent by a peer. This
addresses the preceding problem.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 819
Procedure
● Configure the BGP device to filter the routes received from all its peers or
peer groups.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform either of the following operations to configure the BGP device to
filter the routes received from all its peers or peer groups:
▪ To filter routes based on an ACL, run the filter-policy {
acl-number |
acl-name
acl-name } import or the filter-policy {
acl6-number |
acl6-name
acl6-name } import command.
▪ To filter routes based on an IP prefix list, run the filter-policy ip-
prefix
ip-prefix-name import or the filter-policy ipv6-prefix
ipv6-
prefix-name import command.
NOTE
If an ACL has been referenced in the filter-policy command but no VPN instance
is specified in the ACL rule, BGP will filter routes including public and private
network routes in all address families. If a VPN instance is specified in the ACL
rule, only the data traffic from the VPN instance will be filtered, and no route of
this VPN instance will be filtered.
● Configure BGP to filter the routes received from a specified peer or peer
group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform any of the following operations to configure the BGP device to
filter the routes received from a specific peer or peer group:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 820
▪ To filter routes based on an ACL, run the peer {
group-name |
ipv4-
address |
ipv6-address } filter-policy {
acl-number | acl-name
acl-
name |
acl6-number | acl6-name
acl6-name } import command.
▪ To filter routes based on an IP prefix list, run the peer {
ipv4-address
|
group-name } ip-prefix
ip-prefix-name import or the peer {
group-
name |
ipv4-address |
ipv6-address } ipv6-prefix
ipv6-prefix-name
import command.
▪ To filter routes based on an AS_Path filter, run the peer {
ipv4-
address |
group-name |
ipv6-address } as-path-filter {
as-path-filter-
number |
as-path-filter-name } import command.
▪ To filter routes based on a route-policy, run the peer {
ipv4-address |
group-name |
ipv6-address } route-policy
route-policy-name import
command.
NOTE
The routing policy applied in the peer route-policy import command does not
support a specific interface as one matching rule. That is, the routing policy does
not support the if-match interface command.
NOTICE
If the number of routes received by the local device exceeds the upper
limit and the peer route-limit command is used for the first time, the
local device and its peer reestablish the peer relationship, regardless of
whether alert-only is set.
e. (Optional) Run peer {
group-name |
ipv4-address |
ipv6-address } route-
limit
limit [
percentage ] [ alert-only | idle-forever | idle-timeout
times ]
The maximum number of routes that can be received from the peer or
peer group is set.
----End
9.10.4 Configuring BGP Soft Reset
Context
After changing a BGP import policy, you must reset BGP connections for the new
import policy to take effect. This, however, interrupts the BGP connections
temporarily. BGP route-refresh allows the system to softly reset BGP connections
to refresh a BGP routing table without tearing down any BGP connection. If a
device's peer does not support route-refresh, configure the device to retain all
routing updates received from the peer so that the device can refresh its routing
table without tearing down the BGP connection with the peer.
Procedure
● If a device's peer supports route-refresh, configure the device to softly reset
the BGP connection with the peer and update the BGP routing table.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 821
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. (Optional) Run peer {
ipv4-address |
group-name } capability-advertise
route-refresh
Or run peer
ipv6-address capability-advertise { 4-byte-as | route-
refresh }
Route-refresh is enabled.
By default, route-refresh is enabled.
d. Run quit
Return to the system view.
e. Run quit
Return to the user view.
f. Run refresh bgp [ vpn-instance
vpn-instance-name ipv4-family |
vpnv4 ] { all |
ipv4-address | group
group-name | external | internal }
{ export | import }
Or run refresh bgp ipv6 { all | group
group-name |
ipv4-address |
ipv6-
address | external | internal } { export | import }
BGP soft reset is configured.
● If a device's peer does not support route-refresh, configure the device to
retain all routing updates received from the peer so that the device can
refresh its routing table without tearing down the BGP connection with the
peer.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
NOTICE
If the peer keep-all-routes command is used on the device for the first
time, the sessions between the device and its peers are reestablished.
The refresh bgp command takes effect when the peer keep-all-routes
command is used on the device supporting route-refresh.
d. Run peer {
ipv4-address |
group-name |
ipv6-address } keep-all-routes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 822
The device is configured to store all the routing updates received from its
peers or peer groups.
By default, the device stores only the routing updates that are received
from peers or peer groups and match a configured import policy.
----End
9.10.5 Verifying the BGP Route Receiving and Advertisement
Configuration
Procedure
● Run the display ip as-path-filter [
as-path-filter-number |
as-path-filter-
name ] command to check information about a configured AS_Path filter.
● Run the display ip community-filter [
basic-comm-filter-num |
adv-comm-
filter-num |
comm-filter-name ] command to check information about a
configured community filter.
● Run the display ip extcommunity-filter [
extcomm-filter-number |
extcomm-
filter-name ] command to check information about a configured extended
community filter.
● Run the display bgp routing-table as-path-filter {
as-path-filter-number |
as-path-filter-name } command to check information about routes matching
a specified AS_Path filter.
● Run the display bgp routing-table community-filter { {
community-filter-
name |
basic-community-filter-number } [ whole-match ] |
advanced-
community-filter-number } command to check information about routes
matching a specified BGP community filter.
● Run the display bgp routing-table peer
ipv4-address received-routes
[ active ] [ statistics ] command to check information about routes received
by a BGP device from its peers.
● Run the display bgp multicast routing-table different-origin-as command
to check information about MBGP routes with different origin ASs.
● Run the display bgp multicast routing-table regular-expression
as-regular-
expression to check information about MBGP routes matching the AS regular
expression.
● Run the display bgp multicast paths [
as-regular-expression ] command to
check information about AS paths.
● Run the display bgp multicast routing-table as-path-filter {
as-path-filter-
number |
as-path-filter-name } command to check information about MBGP
routes matching the AS_Path filter.
● Run the display bgp multicast routing-table community-filter
{ {
community-filter-name |
basic-community-filter-number } [ whole-
match ] |
advanced-community-filter-number } command to check
information about routes matching a specified MBGP community filter.
● Run the display bgp multicast routing-table peer
peer-address
{ advertised-routes [
network [ {
mask |
mask-length } [ longer-prefixes ] ] ]
| received-routes [ active ] | accepted-routes } command to check
information about routes that are sent by and received from the specified
MBGP peer.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 823
● Run the display bgp multicast network command to check the routing
information that MBGP advertises.
----End
9.11 Adjusting the BGP Network Convergence Speed
Pre-configuration Tasks
Before adjusting the BGP network convergence speed, configure basic BGP
functions.
Configuration Procedure
You can perform the following configuration tasks (excluding the task of Verifying
the BGP Network Convergence Speed Adjustment Configuration) in any sequence.
9.11.1 Configuring a BGP ConnectRetry Timer
Context
After BGP initiates a TCP connection, the ConnectRetry timer will be stopped if the
TCP connection is established successfully. If the first attempt to establish a TCP
connection fails, BGP tries again to establish the TCP connection after the
ConnectRetry timer expires.
● Setting a short ConnectRetry interval reduces the period BGP waits between
attempts to establish a TCP connection. This speeds up the establishment of
the TCP connection.
● Setting a long ConnectRetry interval suppresses routing flapping caused by
peer relationship flapping.
A ConnectRetry timer can be configured either for all peers or peer groups, or for
a specific peer or peer group. A ConnectRetry timer configured for a specific peer
takes precedence over that configured for the peer group of this peer. In addition,
a ConnectRetry timer configured for a specific peer or peer group takes
precedence over that configured for all peers or peer groups.
Procedure
● Configure a BGP ConnectRetry timer for all peers or peer groups.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run timer connect-retry
connect-retry-time
A BGP ConnectRetry timer is configured for all peers or peer groups.
By default, the ConnectRetry timer value is 32s.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 824
● Configure a ConnectRetry timer for a specific peer or peer group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run peer {
group-name |
ipv4-address |
ipv6-address } timer connect-
retry
connect-retry-time
A ConnectRetry timer is configured for a specific peer or peer group.
By default, the ConnectRetry timer value is 32s.
----End
9.11.2 Configuring BGP Keepalive and Hold Timers
Context
Keepalive messages are used by BGP to maintain peer relationships.
● If short Keepalive time and holdtime are set, BGP can detect a link fault
quickly. This speeds up BGP network convergence, but increases the number
of Keepalive messages on the network and loads of devices, and consumes
more network bandwidth resources.
● If long Keepalive time and holdtime are set, the number of Keepalive
messages on the network is reduced, loads of devices are reduced, and less
network bandwidth is consumed. If the Keepalive time is too long, BGP is
unable to detect link status changes in a timely manner. This hinders the
implementation of rapid BGP network convergence and may cause significant
packet loss.
Keepalive and hold timers can be configured either for all peers or peer groups, or
for a specific peer or peer group. Keepalive and hold timers configured for a
specific peer take precedence over those configured for the peer group of the peer.
In addition, Keepalive and hold timers configured for a specific peer or peer group
take precedence over those configured for all peers or peer groups.
NOTICE
Changing timer values using the timer command or the peer timer command
interrupts BGP peer relationships between switches.
Setting the Keepalive time to 20s is recommended. If the Keepalive time is less
than 20s, sessions between peers may be closed.
Procedure
● Configure BGP timers for all peers or peer groups.
a. Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 825
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run timer keepalive
keepalive-time hold
hold-time [ min-holdtime
min-holdtime ]
BGP timers are configured.
The proper maximum interval at which Keepalive messages are sent is
one third the holdtime. By default, the Keepalive time is 60s and the
holdtime is 180s.
● Configure BGP timers for a specific peer or peer group.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run peer {
ipv4-address |
group-name |
ipv6-address } timer keepalive
keepalive-time hold
hold-time [ min-holdtime
min-holdtime ]
The Keepalive and hold timers are configured for a specific peer or peer
group.
The proper maximum interval at which Keepalive messages are sent is
one third the holdtime. By default, the Keepalive time is 60s and the
holdtime is 180s.
----End
9.11.3 Configuring an Update Message Timer
Context
BGP does not periodically update a routing table. When BGP routes change, BGP
updates the changed BGP routes in the BGP routing table by sending Update
messages.
● If a short Update message interval is set, BGP can fast detect route changes.
This speeds up BGP network convergence, but increases the number of
Update messages on the network and loads of devices, and consumes more
network bandwidth resources.
● If a long Update message interval is set, the number of Update messages on
the network is reduced, loads of devices are reduced, and less network
bandwidth is consumed. This avoids network flapping. If the Update message
interval is too long, BGP is unable to detect route changes in a timely manner.
This hinders the implementation of rapid BGP network convergence and may
cause significant packet loss.
Procedure
Step 1 Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 826
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run peer {
ipv4-address |
group-name |
ipv6-address } route-update-interval
interval
An Update message timer is configured.
By default, the interval at which Update messages are sent to IBGP peers is 15s,
and the interval at which Update messages are sent to EBGP peers is 30s.
----End
9.11.4 Disabling Rapid EBGP Connection Reset
Context
Rapid EBGP connection reset is enabled by default. This allows BGP to
immediately respond to a fault on an interface and delete the direct EBGP sessions
on the interface without waiting for the hold timer to expire and implements rapid
BGP network convergence.
If the status of an interface used to establish an EBGP connection changes
frequently, the EBGP session will be deleted and reestablished repeatedly, causing
network flapping. Rapid EBGP connection reset can be disabled in such a situation.
BGP will delete direct EBGP sessions on the interface until the hold timer expires.
This suppresses BGP network flapping and reduces network bandwidth
consumption.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run undo ebgp-interface-sensitive
Rapid EBGP connection reset is disabled.
By default, rapid EBGP connection reset is enabled.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 827
NOTE
Rapid EBGP connection reset enables BGP to quickly respond to interface faults but
prevents BGP from quickly responding to interface recovery. After the interface recovers,
BGP uses its state machine to restore relevant sessions.
Rapid EBGP connection reset is disabled in a situation where the status of an interface used
to establish an EBGP connection changes frequently. If the status of the interface becomes
stable, run the ebgp-interface-sensitive command to enable rapid EBGP connection reset
to implement rapid BGP network convergence.
----End
9.11.5 Configuring the BGP Next Hop Delayed Response
Context
Configuring the BGP next hop delayed response can speed up BGP route
convergence and minimize traffic loss.
As shown in Figure 9-42, PE1, PE2, and PE3 are the clients of the RR. CE2 is dual-
homed to PE1 and PE2. PE1 and PE2 advertise their routes to CE2 to the RR. The
RR advertises the route from PE1 to PE3. PE3 has a route to CE2 only and
advertises this route to CE1. After the route exchange, CE1 and CE2 can
communicate. If PE1 fails, PE3 detects that the next hop is unreachable and
instructs CE1 to delete the route to CE2. Traffic is then interrupted. After BGP
route convergence is complete, the RR selects the route advertised by PE2 and
sends a route update message to PE3. PE3 then advertises this route to CE1, and
traffic forwarding is restored to the normal state. A high volume of traffic will be
lost during traffic interruption because BGP route convergence is rather slow.
If the BGP next hop delayed response is enabled on PE3, PE3 does not reselect a
route or instruct CE1 to delete the route to CE2 immediately after detecting that
the route to PE1 is unreachable. After BGP convergence is complete, the RR selects
the route advertised by PE2 and sends the route to PE3. PE3 then reselects a route
and sends a route update message to CE1. Traffic forwarding is restored to the
normal state. After the BGP next hop delayed response is enabled on PE3, PE3
does not need to delete the route or instruct CE1 to delete the route. This delayed
response speeds up BGP route convergence and minimizes traffic loss.
Figure 9-42 Networking diagram of configuring the BGP next hop delayed
response
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 828
The BGP next hop delayed response applies to scenarios where the next hop has
multiple links to reach the same destination. If there is only one link between the
next hop and the destination, configuring the BGP next hop delayed response may
cause heavier traffic loss when the link fails because link switching is impossible.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Set a delay in responding to next hop changes.
The recursion results are as follows:
● Urgent recursion result change
The recursive next hop is changed, and BGP route reachability is also changed.
For example, if a fault occurs on a network, a device finds no next-hop route
or tunnel to which a BGP route is recursed. As a result, traffic is interrupted.
● Non-urgent recursion result change
The recursive next hop is changed, and BGP route reachability is not affected.
For example, after the interface or type of a tunnel to which the next hop of a
BGP route is recursed is changed (that is, the recursed tunnel is changed),
traffic keeps traveling over the BGP route.
Run either of the following commands to set a delay time after which a device
responds to a BGP next hop change:
● Run nexthop recursive-lookup delay [
delay-time ]
A device is enabled to delay responses to all next hop changes.
● Run nexthop recursive-lookup non-critical-event delay [
delay-time ]
A device is enabled to delay responses to non-urgent next hop changes.
If
delay-time is not specified, the default delay time is 5s.
The preceding commands can be run separately or simultaneously. The nexthop
recursive-lookup non-critical-event delay command takes precedence over the
nexthop recursive-lookup delay command if both commands are run.
The delay time specified in the nexthop recursive-lookup non-critical-event
delay command must be greater than or equal to that specified in the nexthop
recursive-lookup delay command if both commands are run.
----End
9.11.6 Configuring BGP Route Dampening
Context
A route is considered to be flapping when it repeatedly appears and then
disappears in the routing table. BGP generally applies to complex networks where
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 829
routes change frequently. Frequent route flapping consumes lots of bandwidths
and CPU resources and even affects normal network operation. BGP route
dampening prevents frequent route flapping.
BGP can differentiate routes based on policies and use different route dampening
parameters to suppress different routes. For example, on a network, you can set a
long suppression time for routes with a long mask and set a short suppression
time for routes with a short mask (such as 8-bit mask).
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast | vpnv4 [ unicast ] | vpn-instance
vpn-
instance-name }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast | vpn-instance
vpn-instance-name ]
The IPv6 address family view is displayed.
Step 4 Run dampening [ ibgp ] [
half-life-reach reuse suppress ceiling | route-policy
route-policy-name ] *
BGP route dampening parameters are configured.
NOTE
The dampening command is valid only for EBGP routes.
----End
9.11.7 Configuring Slow Peer Detection
Context
An update peer-group may consist of multiple BGP peers. If a network problem
(congestion for example) occurs and slows down the speed at which the local
device advertises routes to a BGP peer in the update peer-group, the speed at
which the local device advertises routes to other BGP peers in the update peer-
group is affected. To address this problem, slow peer detection is enabled by
default.
When slow peer detection is enabled, the local device identifies the BGP peer to
which routes are sent the slowest based on the time taken to send 100 packets to
each BGP peer. If this time is greater than the period threshold for slow peer
detection plus the average time taken to send 100 packets to BGP peers
(excluding the longest and shortest times), the local device considers the peer a
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 830
slow peer and removes it from the update peer-group. Slow peer detection
prevents this slow peer from affecting route advertisement to other peers in the
update peer-group. By default, the period threshold for slow peer detection is
300s.
To adjust the period threshold for slow peer detection or disable slow peer
detection, run the following steps.
NOTE
After a slow peer is removed from the update peer-group, the peer relationship between
the local device and the slow peer is reestablished.
Procedure
● Adjust the period threshold for slow peer detection
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run slow-peer detection threshold
threshold-value
Set a period threshold for slow peer detection.
By default, the period threshold for slow peer detection is 300s.
threshold-value specifies a period threshold for slow peer detection. If the
time taken to send 100 packets to a BGP peer is X, the configured period
is Y, the average time taken to send 100 packets to BGP peers (excluding
the longest and shortest times) is Z, and the inequality (X > Y + Z) is met,
the local device considers the BGP peer a slow peer and removes it from
the update peer-group.
● Disable slow peer detection
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Run slow-peer detection disable
The slow peer detection is disabled.
----End
9.11.8 Verifying the BGP Network Convergence Speed
Adjustment Configuration
Procedure
● Run the display bgp peer [ verbose ] command to check information about
all BGP peers.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 831
● Run the display bgp group [
group-name ] command to check information
about the specified BGP peer group.
● Run the display bgp routing-table dampened command to check dampened
BGP routes.
● Run the display bgp routing-table dampening parameter command to
check configured BGP route dampening parameters.
● Run the display bgp routing-table flap-info [ regular-expression
as-
regular-expression | as-path-filter
as-path-filter-number |
network-address
[ {
mask |
mask-length } [ longer-match ] ] ] command to check route
flapping statistics.
● Run the display bgp multicast routing-table dampened command to check
dampened MBGP routes.
● Run the display bgp multicast routing-table dampening parameter
command to check MBGP route dampening parameters.
● Run the following commands to check statistics about flapping MBGP routes:
– display bgp multicast routing-table flap-info [
ip-address [
mask
[ longer-match ] |
mask-length [ longer-match ] ] | as-path-filter
as-
path-filter-number | regular-expression
as-regular-expression ]
– display bgp multicast routing-table flap-info regular-expression
as-
regular-expression
----End
9.12 Configuring BGP Reliability
Pre-configuration Tasks
Before configuring BGP reliability, configure basic BGP functions.
Configuration Procedure
You can perform the following configuration tasks in any sequence.
9.12.1 Enabling BGP Tracking
Context
BFD can be configured to detect peer relationship status changes in order to
implement rapid BGP convergence. BFD, however, needs to be configured on the
entire network, and has poor extensibility. If BFD cannot be deployed on a device
to detect BGP peer relationship status, BGP peer tracking can be enabled on the
device to quickly detect link or peer unreachability, implementing rapid network
convergence.
BGP tracking can be used to adjust the interval between peer unreachability
discovery and connection interruption. This suppresses BGP peer relationship
flapping caused by route flapping and improves BGP network stability.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 832
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run peer {
group-name |
ipv4-address |
ipv6-address } tracking [ delay
delay-
time ]
BGP peer tracking is enabled on the device to detect the status of a specified peer.
By default, BGP peer tracking is disabled.
----End
9.12.2 Configuring BFD for BGP
Context
BGP periodically sends Keepalive messages to its peers to detect the status of its
peers. It takes more than 1 second for this detection mechanism to detect a fault.
When data is transmitted at gigabit rates, long-time fault detection will cause
packet loss and cannot meet high reliability requirements of carrier-class
networks. BFD for BGP can solve this problem. BFD is a millisecond-level fault
detection mechanism. It can fast detect faults on the link between BGP neighbors.
Therefore, BFD speeds up BGP route convergence, ensures fast link switching, and
reduces traffic loss.
When a peer joins a peer group on which BFD is enabled, BFD also takes effect on
the peer and a BFD session is created on the peer. To prevent BFD from taking
effect on the peer, run the peer bfd block command.
By default, Huawei devices establish multi-hop IBGP sessions with each other.
When a Huawei device communicates with a non-Huawei device that establishes
a single-hop IBGP session by default, you are advised to configure only association
between IGP and BFD or association between IBGP and BFD.
NOTE
Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H,
S6730-S, and S6730S-S support BFD for BGP.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bfd
Global BFD is enabled on the local device.
Step 3 Run quit
Return to the system view.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 833
Step 4 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 5 Run peer {
group-name |
ipv4-address |
ipv6-address } bfd enable [ single-hop-
prefer ]
BFD is configured for the peer or peer group, and default BFD parameters are
used to establish BFD sessions.
single-hop-prefer takes effect only on IBGP peers. By default, if single-hop-
prefer is not specified, multi-hop sessions are established between direct IBGP
peers (Huawei devices). To interconnect a Huawei device and a non-Huawei
device that defaults the sessions between IBGP peers to single-hop, configure
single-hop-prefer in the command.
If BFD is configured for a peer group, BFD sessions are created for the peers on
which the peer bfd block command is not used.
Step 6 Run peer {
group-name |
ipv4-address |
ipv6-address } bfd { min-tx-interval
min-
tx-interval | min-rx-interval
min-rx-interval | detect-multiplier
multiplier | wtr
wtr-value } *
BFD session parameters are configured.
Step 7 (Optional) Run peer {
ipv4-address |
ipv6-address } bfd block
The peer is disabled from inheriting the BFD function of the peer group to which
the peer belongs.
NOTE
● BFD sessions are established when they are in Established state.
● If BFD parameters are configured on a peer, BFD sessions are established using these
parameters.
● The peer {
ipv4-address |
ipv6-address } bfd block and peer {
group-name |
ipv4-
address |
ipv6-address } bfd enable [ single-hop-prefer ] commands are mutually
exclusive.
----End
Verifying the Configuration
● Run the display bgp bfd session { [ vpnv4 vpn-instance
vpn-instance-
name ] peer
ipv4-address | all } command to check information about the
BFD sessions established between BGP peers.
● Run the display bgp [ vpnv4 vpn-instance
vpn-instance-name ] peer
[ [
ipv4-address ] verbose ] command to check information about BGP peers.
● Run the display bgp group [
group-name ] command to check information
about the specified BGP peer group.
● Run the display bgp vpnv4 { all | vpn-instance
vpn-instance-name } group
[
group-name ] command to check information about the BGP VPNv4 peer
group.
9.12.3 Configuring BGP GR
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 834
Context
After the graceful-restart command is configured to enable GR for the switch, to
prevent traffic interruption, another GR-capable device can assist the switch to
perform GR when BGP on the switch restarts due to an active/standby switchover,
and the switch can assist other GR-capable devices to perform GR when BGP on
other devices restarts.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run graceful-restart
BGP GR is enabled.
By default, BGP GR is disabled.
Step 4 (Optional) Run graceful-restart timer wait-for-rib
timer
The time during which the restarting speaker and receiving speaker wait for End-
of-RIB messages is set.
By default, the time for waiting for End-of-RIB messages is 600 seconds.
Step 5 (Optional) Run graceful-restart peer-reset
The device is enabled to reset a BGP session in GR mode.
By default, a device is disabled from resetting a BGP connection in GR mode.
----End
Verifying the Configuration
● Run the display bgp peer verbose command to check detailed information
about BGP GR.
9.13 Configuring BGP Route Summarization
Pre-configuration Tasks
Before configuring BGP route summarization, configure basic BGP functions.
Procedure
● Configure automatic route summarization.
a. Run system-view
The system view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 835
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
d. Run summary automatic
BGP summarizes subnet routes based on natural mask.
NOTE
The command summarizes the routes imported by BGP. These routes can be direct
routes, static routes, RIP routes, OSPF routes, or IS-IS routes. The command, however,
is invalid for the routes imported using the network command.
● Configure manual route summarization.
a. Run system-view
The system view is displayed.
b. Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
c. Enter the corresponding address family view based on network type to
configure BGP devices on networks.
▪ Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
▪ Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
d. Perform any of the following operations to configure manual route
summarization.
▪ To advertise the summarized routes and specific routes, run the
aggregate
ipv4-address {
mask |
mask-length } command.
▪ To advertise only the summarized routes, run the aggregate
ipv4-
address {
mask |
mask-length } detail-suppressed or the aggregate
ipv6-address prefix-length detail-suppressed command.
▪ To advertise the summarized routes and specific routes that meet the
specified route-policy, run the aggregate
ipv4-address {
mask |
mask-length } suppress-policy
route-policy-name or the aggregate
ipv6-address prefix-length suppress-policy
route-policy-name
command.
▪ To advertise the summarized routes of which the AS_Set attribute
helps detect routing loops, run the aggregate
ipv4-address {
mask |
mask-length } as-set or the aggregate
ipv6-address prefix-length as-
set command.
▪ To set attributes for the summarized routes, run the aggregate
ipv4-
address {
mask |
mask-length } attribute-policy
route-policy-name
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 836
or the aggregate
ipv6-address prefix-length attribute-policy
route-
policy-name command.
▪ To summarize the specific routes that meet the specified route-policy,
run the aggregate
ipv4-address {
mask |
mask-length } origin-policy
route-policy-name or the aggregate
ipv6-address prefix-length
origin-policy
route-policy-name command.
NOTE
Manual route summarization is valid for the routes in the local BGP routing table. For
example, if the local BGP routing table does not contain routes with mask longer than
16 bits, such as 10.1.1.1/24, BGP will not generate an aggregated route for it even if
the aggregate 10.1.1.1 16 command is used.
----End
Verifying the Configuration
● Run the display bgp routing-table [
ipv4-address [ {
mask |
mask-length }
[ longer-prefixes ] ] ] command to check information about summarized
routes.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check the
MBGP routing table.
9.14 Configuring BGP to Advertise Default Routes to
Peers
Pre-configuration Tasks
Before configuring BGP to send default routes to peers, configure basic BGP
functions.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family { unicast | multicast }
The IPv4 address family view is displayed.
● Run ipv6-family [ unicast ]
The IPv6 address family view is displayed.
Step 4 Run peer {
group-name |
ipv4-address |
ipv6-address } default-route-advertise
[ route-policy
route-policy-name ] [ conditional-route-match-all {
ipv4-address1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 837
{
mask1 |
mask-length1 } } &<1-4> | conditional-route-match-any {
ipv4-
address2 {
mask2 |
mask-length2 } } &<1-4> ]
Or run peer {
group-name |
ipv4-address |
ipv6-address } default-route-advertise
[ route-policy
route-policy-name ] [ conditional-route-match-all {
ipv6-address1
prefix-length1 } &<1-4> | conditional-route-match-any {
ipv6-address2 prefix-
length2 } &<1-4> ]
A BGP device is configured to send default routes to a peer or peer group.
----End
Verifying the Configuration
● Run the display bgp routing-table [
ipv4-address [
mask |
mask-length
[ longer-prefixes ] ] ] command to check received BGP default routes.
● Run the display bgp multicast routing-table [
ip-address [
mask-length
[ longer-prefixes ] |
mask [ longer-prefixes ] ] ] command to check received
MBGP default routes.
9.15 Configuring MP-BGP
Pre-configuration Tasks
Before configuring MP-BGP, 9.6.1 Starting a BGP Process.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
BGP is started, the local AS number is specified, and the BGP view is displayed.
Step 3 Enter the corresponding address family view based on network type to configure
BGP devices on networks.
● Run ipv4-family unicast
The BGP-IPv4 unicast address family view is displayed.
● Run ipv4-family vpnv4
The BGP-VPNv4 address family view is displayed.
● Run ipv4-family vpn-instance
vpn-instance-name
The BGP-VPN instance IPv4 address family view is displayed.
● Run ipv4-family multicast
The BGP-IPv4 multicast address family view is displayed.
● Run ipv6-family unicast
The BGP-IPv6 unicast address family view is displayed.
● Run ipv6-family vpnv6
The BGP-VPNv6 address family view is displayed.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 838
● Run ipv6-family vpn-instance
vpn-instance-name
The BGP-VPN instance IPv6 address family view is displayed.
NOTE
● Only the S5731-H, S5731S-H, S5732-H, S6735-S, S6730S-H, and S6730-H support BGP-
VPNv4 address family view and BGP-VPNv6 address family view.
● Different extended BGP functions must be configured in their respective address family
views, while common BGP functions are configured in the BGP view.
● The Switch supports the following MBGP features: basic BGP functions, BGP security
(MD5 authentication and keychain authentication), simplifying IBGP network
connections (route reflector and confederation), BGP route selection and load balancing,
controlling the receiving and advertisement of BGP routes, adjusting the BGP network
convergence speed, BGP reliability, BGP route summarization, and advertising default
routes to peers.
● Some BGP4+ functions can be configured in the BGP view, and some BGP4+ functions
need to be configured in the IPv6 unicast address family view. For example, the
following BGP4+ functions need to be configured in the IPv6 unicast address family
view: load balancing, manual route summarization, route dampening, community, and
route reflector.
----End
9.16 Maintaining BGP
9.16.1 Configuring Alarm and Clear Alarm Thresholds for the
Number of BGP Routes
Context
There are a limited number of BGP routes that can be added to a routing table. If
the limit is reached, new routes cannot be added, which may interrupt services. To
address this problem, configure alarm and clear alarm thresholds for the number
of BGP routes as required. With the alarm and clear alarm thresholds, alarms are
generated and cleared as expected. The alarms prompt you to check whether an
exception occurs and to take preventive measures.
Procedure
Step 1 Run system-view
The system view is displayed.
Step 2 Run bgp {
as-number-plain |
as-number-dot }
The BGP view is displayed.
Step 3 Run routing-table limit threshold-alarm upper-limit
upper-limit-value lower-
limit
lower-limit-value
Alarm and clear alarm thresholds are configured for the number of BGP routes.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 839
●
upper-limit-value specifies the alarm threshold. If the ratio of BGP routes to
the maximum number that is allowed exceeds the alarm threshold, an alarm
is generated.
●
lower-limit-value specifies the clear alarm threshold. If the ratio of BGP routes
to the maximum number that is allowed falls below this threshold, the alarm
is cleared.
●
upper-limit-value must be greater than
lower-limit-value; otherwise, alarms
are generated and cleared repeatedly if route flapping occurs.
By default,
upper-limit-value is 80%, and
lower-limit-value is 70%.
----End
9.16.2 Resetting BGP Connections
Context
NOTICE
Running the reset bgp command to reset BGP connections will interrupt BGP peer
relationships between BGP devices. Exercise caution when you use this command.
When the BGP routing policy changes, for example, the switch does not support
the route-refresh capability, reset BGP connections to make the modification take
effect.
Procedure
● To reset all BGP connections, run the reset bgp all command in the user view.
● To reset the BGP connection with a specified AS, run the reset bgp {
as-
number-plain |
as-number-dot } command in the user view.
● To reset the BGP connection with a specified peer, run the reset bgp
ipv4-
address command in the user view.
● To reset all EBGP connections, run the reset bgp external command in the
user view.
● To reset the BGP connection with a specified peer group, run the reset bgp
group
group-name command in the user view.
● To reset all IBGP connections, run the reset bgp internal command in the
user view.
● To reset the MBGP connection with a specified peer, run the reset bgp
multicast
peer-address command in the user view.
● To reset all MBGP connections, run the reset bgp multicast all command in
the user view.
● To reset the MBGP connection with all the peers in a specified peer group, run
the reset bgp multicast group
group-name command in the user view.
● To reset all external connections, run the reset bgp multicast external
command in the user view.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 840
● To reset all internal connections, run the reset bgp multicast internal
command in the user view.
----End
9.16.3 Clearing BGP Statistics
Context
NOTICE
BGP statistics cannot be restored after being cleared. Exercise caution when you
clear BGP statistics.
Procedure
● To clear route flapping statistics, run the reset bgp flap-info [ regexp
as-
path-regexp | as-path-filter
as-path-filter-number |
ipv4-address [
mask |
mask-length ] ] command in the user view.
● To clear route flapping statistics on a specified peer, run the reset bgp
ipv4-
address flap-info command in the user view.
● To clear route dampening statistics and release suppressed routes, run the
reset bgp dampening [
ipv4-address [
mask |
mask-length ] ] command in
the user view.
● To clear MBGP route dampening statistics, run the reset bgp multicast
dampening [
ip-address [
mask |
mask-length ] ] command in the user view.
● To clear MBGP route flapping statistics, run the reset bgp multicast flap-info
[
ip-address [
mask |
mask-length ] | as-path-filter {
as-path-list-number |
as-
path-list-name } | regexp
regexp ] command in the user view.
----End
9.17 Configuration Examples for BGP
9.17.1 Example for Configuring Basic BGP Functions
Networking Requirements
As shown in Figure 9-43, BGP runs between Switches; an EBGP connection is
established between SwitchA and SwitchB; IBGP full-mesh connections are
established between SwitchB, SwitchC, and SwitchD.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 841
Figure 9-43 Networking diagram of configuring basic BGP functions
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IBGP connections between SwitchB, SwitchC, and SwitchD.
2. Configure an EBGP connection between SwitchA and SwitchB.
Procedure
Step 1 Create VLANs and add interfaces to the corresponding VLANs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 50
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 50
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.2 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 50
[SwitchA-Vlanif50] ip address 10.1.1.1 16
[SwitchA-Vlanif50] quit
Step 3 Configure IBGP connections.
# Configure SwitchB.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 842
[SwitchB] bgp 65009
[SwitchB-bgp] router-id 172.17.2.2
[SwitchB-bgp] peer 172.16.1.2 as-number 65009
[SwitchB-bgp] peer 172.16.3.2 as-number 65009
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 65009
[SwitchC-bgp] router-id 172.17.3.3
[SwitchC-bgp] peer 172.16.3.1 as-number 65009
[SwitchC-bgp] peer 172.16.2.2 as-number 65009
[SwitchC-bgp] quit
# Configure SwitchD.
[SwitchD] bgp 65009
[SwitchD-bgp] router-id 172.17.4.4
[SwitchD-bgp] peer 172.16.1.1 as-number 65009
[SwitchD-bgp] peer 172.16.2.1 as-number 65009
[SwitchD-bgp] quit
Step 4 Configure EBGP connections.
# Configure SwitchA.
[SwitchA] bgp 65008
[SwitchA-bgp] router-id 172.17.1.1
[SwitchA-bgp] peer 192.168.1.1 as-number 65009
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] peer 192.168.1.2 as-number 65008
[SwitchB-bgp] quit
# Check the status of BGP connections.
[SwitchB] display bgp peer
BGP local router ID : 172.17.2.2
Local AS number : 65009
Total number of peers : 3 Peers in established state : 3
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
172.16.1.2 4 65009 49 62 0 00:44:58 Established 0
172.16.3.2 4 65009 56 56 0 00:40:54 Established 0
192.168.1.2 4 65008 49 65 0 00:44:03 Established 0
You can view that the BGP connections between SwitchB and all the other
Switches are set up.
Step 5 Configure SwitchA to advertise route 10.1.0.0/16.
# Configure SwitchA to advertise routes.
[SwitchA] bgp 65008
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] network 10.1.0.0 255.255.0.0
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.17.1.1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 843
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.0.0/16 0.0.0.0 0 0 i
# Check the routing table of SwitchB.
[SwitchB] display bgp routing-table
BGP Local router ID is 172.17.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.0.0/16 192.168.1.2 0 0 65008i
# Check the routing table of SwitchC.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.17.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
i 10.1.0.0/16 192.168.1.2 0 100 0 65008i
According to the routing table, you can view that SwitchC has learned the route to
the destination 10.1.0.0 in AS 65008, but the next hop 192.168.1.2 is unreachable.
Therefore, this route is invalid.
Step 6 Configure BGP to import direct routes.
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] import-route direct
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Check the BGP routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.17.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.0.0/16 0.0.0.0 0 0 i
*> 172.16.1.0/24 192.168.1.1 0 0 65009?
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 844
*> 172.16.3.0/24 192.168.1.1 0 0 65009?
192.168.1.0 192.168.1.1 0 0 65009?
# Check the routing table of SwitchC.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.17.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.1.0.0/16 192.168.1.2 0 100 0 65008i
*>i 172.16.1.0/24 172.16.3.1 0 100 0 ?
i 172.16.3.0/24 172.16.3.1 0 100 0 ?
*>i 192.168.1.0 172.16.3.1 0 100 0 ?
You can view that the route destined for 10.1.0.0 becomes valid, and the next hop
is the address of SwitchA.
# Perform the ping operation to verify the configuration.
[SwitchC] ping 10.1.1.1
PING 10.1.1.1: 56 data bytes, press CTRL_C to break
Reply from 10.1.1.1: bytes=56 Sequence=1 ttl=255 time=31 ms
Reply from 10.1.1.1: bytes=56 Sequence=2 ttl=255 time=47 ms
Reply from 10.1.1.1: bytes=56 Sequence=3 ttl=255 time=31 ms
Reply from 10.1.1.1: bytes=56 Sequence=4 ttl=255 time=16 ms
Reply from 10.1.1.1: bytes=56 Sequence=5 ttl=255 time=31 ms
--- 10.1.1.1 ping statistics ---
5 packet(s) transmitted
5 packet(s) received
0.00% packet loss
round-trip min/avg/max = 16/31/47 ms
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 50
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif50
ip address 10.1.1.1 255.255.0.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 65008
router-id 172.17.1.1
peer 192.168.1.1 as-number 65009
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 845
ipv4-family unicast
undo synchronization
network 10.1.0.0 255.255.0.0
peer 192.168.1.1 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20 30
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface Vlanif20
ip address 172.16.3.1 255.255.255.0
#
interface Vlanif30
ip address 172.16.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65009
router-id 172.17.2.2
peer 172.16.1.2 as-number 65009
peer 172.16.3.2 as-number 65009
peer 192.168.1.2 as-number 65008
#
ipv4-family unicast
undo synchronization
import-route direct
peer 172.16.1.2 enable
peer 172.16.3.2 enable
peer 192.168.1.2 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 40
#
interface Vlanif20
ip address 172.16.3.2 255.255.255.0
#
interface Vlanif40
ip address 172.16.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
bgp 65009
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 846
router-id 172.17.3.3
peer 172.16.2.2 as-number 65009
peer 172.16.3.1 as-number 65009
#
ipv4-family unicast
undo synchronization
peer 172.16.2.2 enable
peer 172.16.3.1 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30 40
#
interface Vlanif30
ip address 172.16.1.2 255.255.255.0
#
interface Vlanif40
ip address 172.16.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
bgp 65009
router-id 172.17.4.4
peer 172.16.1.1 as-number 65009
peer 172.16.2.1 as-number 65009
#
ipv4-family unicast
undo synchronization
peer 172.16.1.1 enable
peer 172.16.2.1 enable
#
return
9.17.2 Example for Configuring Basic BGP4+ Functions
Networking Requirements
As shown in Figure 9-44, there are two ASs: 65008 and 65009. SwitchA belongs to
AS 65008, and SwitchB, SwitchC, and SwitchD belong to AS 65009. BGP4+ is
required to exchange the routing information between the two ASs.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 847
Figure 9-44 Networking diagram of configuring basic BGP4+ functions
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure IBGP connections between SwitchB, SwitchC, and SwitchD.
2. Configure an EBGP connection between SwitchA and SwitchB.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Enable the IPv6 forwarding capability, and assign an IPv6 address for each
interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] ipv6
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ipv6 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 848
[SwitchA-Vlanif10] ipv6 address fc00:0:0:8::1/64
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ipv6 enable
[SwitchA-Vlanif20] ipv6 address fc00:0:0:100::2/64
[SwitchA-Vlanif20] quit
Step 3 Configure IBGP.
# Configure SwitchB.