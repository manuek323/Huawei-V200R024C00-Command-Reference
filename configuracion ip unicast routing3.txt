[SwitchB] bgp 65009
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer fc00:0:0:91::2 as-number 65009
[SwitchB-bgp] peer fc00:0:0:93::2 as-number 65009
[SwitchB-bgp] ipv6-family unicast
[SwitchB-bgp-af-ipv6] peer fc00:0:0:91::2 enable
[SwitchB-bgp-af-ipv6] peer fc00:0:0:93::2 enable
[SwitchB-bgp-af-ipv6] network fc00:0:0:91:: 64
[SwitchB-bgp-af-ipv6] network fc00:0:0:93:: 64
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 65009
[SwitchC-bgp] router-id 10.3.3.3
[SwitchC-bgp] peer fc00:0:0:93::1 as-number 65009
[SwitchC-bgp] peer fc00:0:0:92::2 as-number 65009
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer fc00:0:0:93::1 enable
[SwitchC-bgp-af-ipv6] peer fc00:0:0:92::2 enable
[SwitchC-bgp-af-ipv6] network fc00:0:0:93:: 64
[SwitchC-bgp-af-ipv6] network fc00:0:0:92:: 64
[SwitchC-bgp-af-ipv6] quit
[SwitchC-bgp] quit
# Configure SwitchD.
[SwitchD] bgp 65009
[SwitchD-bgp] router-id 10.4.4.4
[SwitchD-bgp] peer fc00:0:0:91::1 as-number 65009
[SwitchD-bgp] peer fc00:0:0:92::1 as-number 65009
[SwitchD-bgp] ipv6-family unicast
[SwitchD-bgp-af-ipv6] peer fc00:0:0:91::1 enable
[SwitchD-bgp-af-ipv6] peer fc00:0:0:92::1 enable
[SwitchD-bgp-af-ipv6] network fc00:0:0:92:: 64
[SwitchD-bgp-af-ipv6] network fc00:0:0:91:: 64
[SwitchD-bgp-af-ipv6] quit
[SwitchD-bgp] quit
Step 4 Configure an EBGP connection.
# Configure SwitchA.
[SwitchA] bgp 65008
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer fc00:0:0:100::1 as-number 65009
[SwitchA-bgp] ipv6-family unicast
[SwitchA-bgp-af-ipv6] peer fc00:0:0:100::1 enable
[SwitchA-bgp-af-ipv6] network fc00:0:0:100:: 64
[SwitchA-bgp-af-ipv6] network fc00:0:0:8:: 64
[SwitchA-bgp-af-ipv6] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] peer fc00:0:0:100::2 as-number 65008
[SwitchB-bgp] ipv6-family unicast
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 849
[SwitchB-bgp-af-ipv6] peer fc00:0:0:100::2 enable
[SwitchB-bgp-af-ipv6] network fc00:0:0:100:: 64
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# View the status of the BGP4+ peers.
[SwitchB] display bgp ipv6 peer
BGP local router ID : 10.2.2.2
Local AS number : 65009
Total number of peers : 3 Peers in established state : 3
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
FC00:0:0:91::2 4 65009 8 9 0 00:05:37 Established 2
FC00:0:0:93::2 4 65009 2 2 0 00:00:09 Established 2
FC00:0:0:100::2 4 65008 9 7 0 00:05:38 Established 1
The preceding information shows that the BGP4+ connections between SwitchB
and other Switches are set up.
# Display the routing table of SwitchA.
[SwitchA] display bgp ipv6 routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
*> Network : FC00:0:0:91:: PrefixLen : 64
NextHop : FC00:0:0:100::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 65009 i
*> Network : FC00:0:0:92:: PrefixLen : 64
NextHop : FC00:0:0:100::1 LocPrf :
MED : PrefVal : 0
Label :
Path/Ogn : 65009 i
*> Network : FC00:0:0:93:: PrefixLen : 64
NextHop : FC00:0:0:100::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 65009 i
*> Network : FC00:0:0:100:: PrefixLen : 64
NextHop : :: LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
NextHop : FC00:0:0:100::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 65009 i
The routing table shows that SwitchA has learned the route from AS 65009. AS
65008 and AS 65009 can exchange their routing information.
----End
Configuration Files
● SwitchA configuration file
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 850
#
sysname SwitchA
#
ipv6
#
vlan batch 10 20
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:8::1/64
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:100::2/64
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 65008
router-id 10.1.1.1
peer FC00:0:0:100::1 as-number 65009
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:8:: 64
network FC00:0:0:100:: 64
peer FC00:0:0:100::1 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
vlan batch 20 30 40
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:100::1/64
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:93::1/64
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:91::1/64
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 851
bgp 65009
router-id 10.2.2.2
peer FC00:0:0:91::2 as-number 65009
peer FC00:0:0:93::2 as-number 65009
peer FC00:0:0:100::2 as-number 65008
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:91:: 64
network FC00:0:0:93:: 64
network FC00:0:0:100:: 64
peer FC00:0:0:91::2 enable
peer FC00:0:0:93::2 enable
peer FC00:0:0:100::2 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 30 50
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:93::2/64
#
interface Vlanif50
ipv6 enable
ipv6 address FC00:0:0:92::1/64
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65009
router-id 10.3.3.3
peer FC00:0:0:92::2 as-number 65009
peer FC00:0:0:93::1 as-number 65009
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:92:: 64
network FC00:0:0:93:: 64
peer FC00:0:0:92::2 enable
peer FC00:0:0:93::1 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
ipv6
#
vlan batch 40 50
#
interface Vlanif40
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 852
ipv6 enable
ipv6 address FC00:0:0:91::2/64
#
interface Vlanif50
ipv6 enable
ipv6 address FC00:0:0:92::2/64
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 65009
router-id 10.4.4.4
peer FC00:0:0:91::1 as-number 65009
peer FC00:0:0:92::1 as-number 65009
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:91:: 64
network FC00:0:0:92:: 64
peer FC00:0:0:91::1 enable
peer FC00:0:0:92::1 enable
#
return
9.17.3 Example for Configuring Basic MBGP Functions
Networking Requirements
As shown in Figure 9-45, the receiver receives VoD information in multicast mode.
The receiver and the source reside in different ASs. Multicast routing information
needs to be transmitted between ASs.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 853
Figure 9-45 Networking diagram of MBGP configuration
Data Plan
Table 9-31 IP addresses of interconnected interfaces
Link
Name
(Local
End-
Remote
End)
Local Interface and IP Address Remote Interface and IP
Address
SwitchA-
SwitchB
GE0/0/1
VLANIF100: 192.168.1.1/24
GE0/0/1
VLANIF100: 192.168.1.2/24
SwitchA-
Source
GE0/0/2
VLANIF101: 10.10.10.1/24
-
SwitchB-
SwitchD
GE0/0/2
VLANIF200: 192.168.4.2/24
GE0/0/2
VLANIF200: 192.168.4.1/24
SwitchB-
SwitchC
GE0/0/3
VLANIF300: 192.168.3.2/24
GE0/0/3
VLANIF300: 192.168.3.1/24
SwitchC-
SwitchD
GE0/0/1
VLANIF400: 192.168.5.1/24
GE0/0/1
VLANIF400: 192.168.5.2/24
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 854
Link
Name
(Local
End-
Remote
End)
Local Interface and IP Address Remote Interface and IP
Address
SwitchC-
Receiver
GE0/0/2
VLANIF102: 10.22.22.1/24
-
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure MBGP peers for inter-AS multicast transmission.
2. Configure the routes advertised by MBGP.
3. Enable the multicast function on each switch.
4. Configure basic PIM-SM functions on each switch in ASs and enable IGMP on
receiver-side interfaces.
5. Configure a BSR boundary on the interfaces that connect to two ASs.
6. Configure MSDP peers to transmit inter-domain multicast source information.
Procedure
Step 1 Configure IP addresses for interfaces on each Switch and the OSPF protocol in the
ASs.
# Configure IP addresses and masks for the interfaces on each switch according to
Figure 9-45 and configure OSPF on the switches in ASs. Ensure that SwitchB,
SwitchC, and SwitchD in AS 200 can communicate with the receiver at the
network layer, learn routes to the loopback interfaces of each other, and
dynamically update routes using a unicast routing protocol. Configure OSPF
process 1. The configuration procedure is not mentioned here.
Step 2 Configure BGP, enable the MBGP protocol, and configure the MBGP peers.
# Configure BGP and the MBGP peer on SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] peer 192.168.1.2 as-number 200
[SwitchA-bgp] ipv4-family multicast
[SwitchA-bgp-af-multicast] peer 192.168.1.2 enable
[SwitchA-bgp-af-multicast] quit
[SwitchA-bgp] quit
# Configure BGP and the MBGP peer on SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] peer 192.168.1.1 as-number 100
[SwitchB-bgp] peer 192.168.3.1 as-number 200
[SwitchB-bgp] peer 192.168.4.1 as-number 200
[SwitchB-bgp] ipv4-family multicast
[SwitchB-bgp-af-multicast] peer 192.168.1.1 enable
[SwitchB-bgp-af-multicast] peer 192.168.3.1 enable
[SwitchB-bgp-af-multicast] peer 192.168.4.1 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 855
[SwitchB-bgp-af-multicast] quit
[SwitchB-bgp] quit
# Configure BGP and the MBGP peer on SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] peer 192.168.3.2 as-number 200
[SwitchC-bgp] peer 192.168.5.2 as-number 200
[SwitchC-bgp] ipv4-family multicast
[SwitchC-bgp-af-multicast] peer 192.168.3.2 enable
[SwitchC-bgp-af-multicast] peer 192.168.5.2 enable
[SwitchC-bgp-af-multicast] quit
[SwitchC-bgp] quit
# Configure BGP and the MBGP peer on SwitchD.
[SwitchD] bgp 200
[SwitchD-bgp] peer 192.168.4.2 as-number 200
[SwitchD-bgp] peer 192.168.5.1 as-number 200
[SwitchD-bgp] ipv4-family multicast
[SwitchD-bgp-af-multicast] peer 192.168.4.2 enable
[SwitchD-bgp-af-multicast] peer 192.168.5.1 enable
[SwitchD-bgp-af-multicast] quit
[SwitchD-bgp] quit
Step 3 Configure the routes to be advertised.
# Configure the routes to be advertised on SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] import-route direct
[SwitchA-bgp] ipv4-family multicast
[SwitchA-bgp-af-multicast] import-route direct
[SwitchA-bgp-af-multicast] quit
[SwitchA-bgp] quit
# Configure the routes to be advertised on SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] import-route direct
[SwitchB-bgp] import-route ospf 1
[SwitchB-bgp] ipv4-family multicast
[SwitchB-bgp-af-multicast] import-route direct
[SwitchB-bgp-af-multicast] import-route ospf 1
[SwitchB-bgp-af-multicast] quit
[SwitchB-bgp] quit
Step 4 Enable multicast on each Switch and the interfaces that are connected.
# Configure SwitchA.
[SwitchA] multicast routing-enable
[SwitchA] interface vlanif 100
[SwitchA-Vlanif100] pim sm
[SwitchA-Vlanif100] quit
[SwitchA] interface vlanif 101
[SwitchA-Vlanif101] pim sm
[SwitchA-Vlanif101] quit
# Configure SwitchB.
[SwitchB] multicast routing-enable
[SwitchB] interface vlanif 100
[SwitchB-Vlanif100] pim sm
[SwitchB-Vlanif100] quit
[SwitchB] interface vlanif 200
[SwitchB-Vlanif200] pim sm
[SwitchB-Vlanif200] quit
[SwitchB] interface vlanif 300
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 856
[SwitchB-Vlanif300] pim sm
[SwitchB-Vlanif300] quit
# Configure SwitchC.
[SwitchC] multicast routing-enable
[SwitchC] interface vlanif 400
[SwitchC-Vlanif400] pim sm
[SwitchC-Vlanif400] quit
[SwitchC] interface vlanif 102
[SwitchC-Vlanif102] pim sm
[SwitchC-Vlanif102] igmp enable
[SwitchC-Vlanif102] quit
[SwitchC] interface vlanif 300
[SwitchC-Vlanif300] pim sm
[SwitchC-Vlanif300] quit
# Configure SwitchD.
[SwitchD] multicast routing-enable
[SwitchD] interface vlanif 400
[SwitchD-Vlanif400] pim sm
[SwitchD-Vlanif400] quit
[SwitchD] interface vlanif 200
[SwitchD-Vlanif200] pim sm
[SwitchD-Vlanif200] quit
Step 5 Configure BSR and RP within each AS.
# Configure SwitchA.
[SwitchA] interface LoopBack 0
[SwitchA-LoopBack0] ip address 10.1.1.1 255.255.255.255
[SwitchA-LoopBack0] pim sm
[SwitchA-LoopBack0] quit
[SwitchA] pim
[SwitchA-pim] c-bsr LoopBack 0
[SwitchA-pim] c-rp LoopBack 0
[SwitchA-pim] quit
# Configure SwitchB.
[SwitchB] interface LoopBack 0
[SwitchB-LoopBack0] ip address 10.2.2.2 255.255.255.255
[SwitchB-LoopBack0] pim sm
[SwitchB-LoopBack0] quit
[SwitchB] pim
[SwitchB-pim] c-bsr LoopBack 0
[SwitchB-pim] c-rp LoopBack 0
[SwitchB-pim] quit
Step 6 Configure the BSR boundary on the interfaces connecting two ASs.
# Configure SwitchA.
[SwitchA] interface vlanif 100
[SwitchA-Vlanif100] pim bsr-boundary
[SwitchA-Vlanif100] quit
# Configure SwitchB.
[SwitchB] interface vlanif 100
[SwitchB-Vlanif100] pim bsr-boundary
[SwitchB-Vlanif100] quit
Step 7 Configure MSDP peers.
# Configure SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 857
[SwitchA] msdp
[SwitchA-msdp] peer 192.168.1.2 connect-interface Vlanif100
[SwitchA-msdp] quit
# Configure SwitchB.
[SwitchB] msdp
[SwitchB-msdp] peer 192.168.1.1 connect-interface Vlanif100
[SwitchB-msdp] quit
Step 8 Verify the configuration.
# Run the display bgp multicast peer command to view the MBGP peer
relationship between switches. For example, the following information shows the
MBGP peer relationship on SwitchA:
[SwitchA] display bgp multicast peer
BGP local router ID : 10.1.1.1
Local AS number : 100
Total number of peers : 1 Peers in established state : 1
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
192.168.1.2 4 200 82 75 0 00:30:29 Established 17
# Run the display msdp brief command to view information about the MSDP
peer relationship between switches. For example, the following information shows
the MSDP peer relationship on SwitchB:
[SwitchB] display msdp brief
MSDP Peer Brief Information
Configured Up Listen Connect Shutdown Down
1 1 0 0 0 0
Peer's Address State Up/Down time AS SA Count Reset Count
192.168.1.1 Up 00:07:17 100 1 0
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 100 to 101
#
multicast routing-enable
#
interface Vlanif100
ip address 192.168.1.1 255.255.255.0
pim bsr-boundary
pim sm
#
interface Vlanif101
ip address 10.10.10.1 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 100
#
interface GigabitEthernet0/0/2
port link-type access
port default vlan 101
#
interface LoopBack0
ip address 10.1.1.1 255.255.255.255
pim sm
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 858
#
pim
c-bsr LoopBack0
c-rp LoopBack0
#
bgp 100
peer 192.168.1.2 as-number 200
#
ipv4-family unicast
undo synchronization
import-route direct
peer 192.168.1.2 enable
#
ipv4-family multicast
undo synchronization
peer 192.168.1.2 enable
#
msdp
peer 192.168.1.2 connect-interface Vlanif100
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 100 200 300
#
multicast routing-enable
#
interface Vlanif100
ip address 192.168.1.2 255.255.255.0
pim bsr-boundary
pim sm
#
interface Vlanif200
ip address 192.168.4.2 255.255.255.0
pim sm
#
interface Vlanif300
ip address 192.168.3.2 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 100
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 200
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 300
#
interface LoopBack0
ip address 10.2.2.2 255.255.255.255
pim sm
#
pim
c-bsr LoopBack0
c-rp LoopBack0
#
ospf 1
area 0.0.0.0
network 10.2.2.2 0.0.0.0
network 192.168.3.0 0.0.0.255
network 192.168.4.0 0.0.0.255
#
bgp 200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 859
peer 192.168.1.1 as-number 100
peer 192.168.3.1 as-number 200
peer 192.168.4.1 as-number 200
#
ipv4-family unicast
undo synchronization
import-route direct
import-route ospf 1
peer 192.168.1.1 enable
peer 192.168.3.1 enable
peer 192.168.4.1 enable
#
ipv4-family multicast
undo synchronization
import-route direct
import-route ospf 1
peer 192.168.1.1 enable
peer 192.168.3.1 enable
peer 192.168.4.1 enable
#
msdp
peer 192.168.1.1 connect-interface Vlanif100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 102 300 400
#
multicast routing-enable
#
interface Vlanif102
ip address 10.22.22.1 255.255.255.0
pim sm
igmp enable
#
interface Vlanif300
ip address 192.168.3.1 255.255.255.0
pim sm
#
interface Vlanif400
ip address 192.168.5.1 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 400
#
interface GigabitEthernet0/0/2
port link-type access
port default vlan 102
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 300
#
interface LoopBack0
ip address 10.3.3.3 255.255.255.255
#
ospf 1
area 0.0.0.0
network 10.3.3.3 0.0.0.0
network 10.22.22.0 0.0.0.255
network 192.168.3.0 0.0.0.255
network 192.168.5.0 0.0.0.255
#
bgp 200
peer 192.168.3.2 as-number 200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 860
peer 192.168.5.2 as-number 200
#
ipv4-family unicast
undo synchronization
peer 192.168.3.2 enable
peer 192.168.5.2 enable
#
ipv4-family multicast
undo synchronization
peer 192.168.3.2 enable
peer 192.168.5.2 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 200 400
#
multicast routing-enable
#
interface Vlanif200
ip address 192.168.4.1 255.255.255.0
pim sm
#
interface Vlanif400
ip address 192.168.5.2 255.255.255.0
pim sm
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 400
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 200
#
interface LoopBack0
ip address 10.4.4.4 255.255.255.255
#
ospf 1
area 0.0.0.0
network 10.4.4.4 0.0.0.0
network 192.168.4.0 0.0.0.255
network 192.168.5.0 0.0.0.255
#
bgp 200
peer 192.168.4.2 as-number 200
peer 192.168.5.1 as-number 200
#
ipv4-family unicast
undo synchronization
peer 192.168.4.2 enable
peer 192.168.5.1 enable
#
ipv4-family multicast
undo synchronization
peer 192.168.4.2 enable
peer 192.168.5.1 enable
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 861
9.17.4 Example for Configuring BGP to Interact with an IGP
Networking Requirements
The network shown in Figure 9-46 is divided into AS 65008 and AS 65009. In AS
65009, an IGP is used to calculate routes. In this example, OSPF is used as an IGP.
The two ASs need to communicate with each other.
Figure 9-46 Networking diagram of configuring BGP to interact with an IGP
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure OSPF on SwitchB and SwitchC so that these devices can access each
other.
2. Establish an EBGP connection between SwitchA and SwitchB so that these
devices can exchange routing information.
3. Configure BGP and OSPF to import routes from each other on SwitchB so that
the two ASs can communicate with each other.
4. (Optional) Configure BGP route summarization on SwitchB to simplify the
BGP routing table.
Procedure
Step 1 Create VLANs and add interfaces to the corresponding VLANs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 30
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 30
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 862
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.3.1.2 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 30
[SwitchA-Vlanif30] ip address 10.8.1.1 24
[SwitchA-Vlanif30] quit
Step 3 Configure OSPF.
# Configure SwitchB.
[SwitchB] ospf 1
[SwitchB-ospf-1] area 0
[SwitchB-ospf-1-area-0.0.0.0] network 10.9.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
# Configure SwitchC.
[SwitchC] ospf 1
[SwitchC-ospf-1] area 0
[SwitchC-ospf-1-area-0.0.0.0] network 10.9.1.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] network 10.9.2.0 0.0.0.255
[SwitchC-ospf-1-area-0.0.0.0] quit
[SwitchC-ospf-1] quit
Step 4 Configure an EBGP connection.
# Configure SwitchA.
[SwitchA] bgp 65008
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer 10.3.1.1 as-number 65009
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] network 10.8.1.0 255.255.255.0
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer 10.3.1.2 as-number 65008
Step 5 Configure BGP to interact with an IGP.
# On SwitchB, configure BGP to import OSPF routes.
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] import-route ospf 1
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 863
*> 10.8.1.0/24 0.0.0.0 0 0 i
*> 10.9.1.0/24 10.3.1.1 0 0 65009?
*> 10.9.2.0/24 10.3.1.1 2 0 65009?
# On SwitchB, configure OSPF to import BGP routes.
[SwitchB] ospf
[SwitchB-ospf-1] import-route bgp
[SwitchB-ospf-1] quit
# Check the routing table of SwitchC.
[SwitchC] display ip routing-table
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 7 Routes : 7
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.8.1.0/24 O_ASE 150 1 D 10.9.1.1 Vlanif20
10.9.1.0/24 Direct 0 0 D 10.9.1.2 Vlanif20
10.9.1.2/32 Direct 0 0 D 127.0.0.1 Vlanif20
10.9.2.0/24 Direct 0 0 D 10.9.2.1 Vlanif40
10.9.2.1/32 Direct 0 0 D 127.0.0.1 Vlanif40
127.0.0.0/8 Direct 0 0 D 127.0.0.1 InLoopBack0
127.0.0.1/32 Direct 0 0 D 127.0.0.1 InLoopBack0
Step 6 Configure automatic summarization.
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] summary automatic
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Check the BGP routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.0.0 10.3.1.1 0 65009?
*> 10.8.1.0/24 0.0.0.0 0 0 i
# Perform the ping operation to verify the configuration.
[SwitchA] ping -a 10.8.1.1 10.9.2.1
PING 10.9.2.1: 56 data bytes, press CTRL_C to break
Reply from 10.9.2.1: bytes=56 Sequence=1 ttl=253 time=15 ms
Reply from 10.9.2.1: bytes=56 Sequence=2 ttl=253 time=31 ms
Reply from 10.9.2.1: bytes=56 Sequence=3 ttl=253 time=47 ms
Reply from 10.9.2.1: bytes=56 Sequence=4 ttl=253 time=46 ms
Reply from 10.9.2.1: bytes=56 Sequence=5 ttl=253 time=47 ms
--- 10.9.2.1 ping statistics ---
5 packet(s) transmitted
5 packet(s) received
0.00% packet loss
round-trip min/avg/max = 15/37/47 ms
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 864
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 30
#
interface Vlanif10
ip address 10.3.1.2 255.255.255.0
#
interface Vlanif30
ip address 10.8.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65008
router-id 10.1.1.1
peer 10.3.1.1 as-number 65009
#
ipv4-family unicast
undo synchronization
network 10.8.1.0 255.255.255.0
peer 10.3.1.1 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.3.1.1 255.255.255.0
#
interface Vlanif20
ip address 10.9.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 65009
router-id 10.2.2.2
peer 10.3.1.2 as-number 65008
#
ipv4-family unicast
undo synchronization
summary automatic
import-route ospf 1
peer 10.3.1.2 enable
#
ospf 1
import-route bgp
area 0.0.0.0
network 10.9.1.0 0.0.0.255
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 865
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 40
#
interface Vlanif20
ip address 10.9.1.2 255.255.255.0
#
interface Vlanif40
ip address 10.9.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 40
#
ospf 1
area 0.0.0.0
network 10.9.1.0 0.0.0.255
network 10.9.2.0 0.0.0.255
#
return
9.17.5 Example for Configuring AS_Path Filter
Networking Requirements
On the network shown in Figure 9-47, SwitchB establish EBGP connections with
SwitchA and SwitchC. The user wants to disable the devices in AS 10 from
communicating with devices in AS 30.
Figure 9-47 Networking diagram of configuring the AS_Path filter
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 866
Configuration Roadmap
The configuration roadmap is as follows:
1. Establish EBGP connections between SwitchA and SwitchB and between
SwitchB and SwitchC and configure these devices to import direct routes so
that the ASs can communicate with each other through these EBGP
connections.
2. Configure AS_Path filters on SwitchB and use filtering rules to prevent AS 20
from advertising routes of AS 30 to AS 10 or routes of AS 10 to AS 30.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 1/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.0.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.2.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure EBGP connections.
# Configure SwitchA.
[SwitchA] bgp 10
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] peer 192.168.2.2 as-number 20
[SwitchA-bgp] import-route direct
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 20
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] peer 192.168.2.1 as-number 10
[SwitchB-bgp] peer 192.168.3.2 as-number 30
[SwitchB-bgp] import-route direct
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 30
[SwitchC-bgp] router-id 172.16.3.3
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 867
[SwitchC-bgp] peer 192.168.3.1 as-number 20
[SwitchC-bgp] import-route direct
[SwitchC-bgp] quit
# Check the routing table advertised by SwitchB. Take the routing table advertised
by SwitchB to SwitchC as an example. You can find that SwitchB advertises the
direct route of AS 10.
[SwitchB] display bgp routing-table peer 192.168.3.2 advertised-routes
BGP Local router ID is 172.16.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 4
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.1.0/24 192.168.3.1 0 20 10?
*> 10.1.1.0/24 192.168.3.1 0 20 30?
*> 192.168.2.0 192.168.3.1 0 0 20?
*> 192.168.3.0 192.168.3.1 0 0 20?
Check the routing table of SwitchC. You can find that SwitchC learns this route
advertised by SwitchB.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.16.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 9
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.1.0/24 192.168.3.1 0 20 10?
*> 10.1.1.0/24 0.0.0.0 0 0 ?
*> 10.1.1.1/32 0.0.0.0 0 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
*> 192.168.2.0 192.168.3.1 0 0 20?
*> 192.168.3.0 0.0.0.0 0 0 ?
192.168.3.1 0 0 20?
*> 192.168.3.2/32 0.0.0.0 0 0 ?
Step 4 Configure the AS_Path filter on SwitchB and apply the filter on the outbound
interface of SwitchB.
# Create AS_Path filter 1, denying the passing of routes carrying AS 30. The
regular expression "_30_" indicates any AS list that contains AS 30 and ".*"
matches any character.
[SwitchB] ip as-path-filter path-filter1 deny _30_
[SwitchB] ip as-path-filter path-filter1 permit .*
# Create AS_Path filter 2, denying the passing of routes carrying AS 10. The
regular expression "_10_" indicates any AS list that contains AS 10 and "*"
matches any character.
[SwitchB] ip as-path-filter path-filter2 deny _10_
[SwitchB] ip as-path-filter path-filter2 permit .*
# Apply the AS_Path filter on two outbound interfaces of SwitchB.
[SwitchB] bgp 20
[SwitchB-bgp] peer 192.168.2.1 as-path-filter path-filter1 export
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 868
[SwitchB-bgp] peer 192.168.3.2 as-path-filter path-filter2 export
[SwitchB-bgp] quit
Step 5 Check the routing table advertised by SwitchB.
Check the routing table advertised by SwitchB to AS 30. You can find that the
direct route of AS 10 advertised by SwitchB does not exist.
[SwitchB] display bgp routing-table peer 192.168.3.2 advertised-routes
BGP Local router ID is 172.16.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 192.168.2.0 192.168.3.1 0 0 20?
*> 192.168.3.0 192.168.3.1 0 0 20?
Similarly, the BGP routing table of SwitchC does not have the route.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.16.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 8
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 0.0.0.0 0 0 ?
*> 10.1.1.1/32 0.0.0.0 0 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
*> 192.168.2.0 192.168.3.1 0 0 20?
*> 192.168.3.0 0.0.0.0 0 0 ?
192.168.3.1 0 0 20?
*> 192.168.3.2/32 0.0.0.0 0 0 ?
Check the routing table advertised by SwitchB to AS 10. You can find that the
direct route of AS 30 advertised by SwitchB does not exist.
[SwitchB] display bgp routing-table peer 192.168.2.1 advertised-routes
BGP Local router ID is 172.16.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 192.168.2.0 192.168.2.2 0 0 20?
*> 192.168.3.0 192.168.2.2 0 0 20?
Similarly, the BGP routing table of SwitchA does not have the route.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.16.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 869
Total Number of Routes: 8
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.0.1.0/24 0.0.0.0 0 0 ?
*> 10.0.1.1/32 0.0.0.0 0 0 ?
*> 127.0.0.0 0.0.0.0 0 0 ?
*> 127.0.0.1/32 0.0.0.0 0 0 ?
*> 192.168.2.0 0.0.0.0 0 0 ?
192.168.2.2 0 0 20?
*> 192.168.2.1/32 0.0.0.0 0 0 ?
*> 192.168.3.0 192.168.2.2 0 0 20?
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.0.1.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 10
router-id 172.16.1.1
peer 192.168.2.2 as-number 20
#
ipv4-family unicast
undo synchronization
import-route direct
peer 192.168.2.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 20 30
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.3.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 20
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 870
router-id 172.16.2.2
peer 192.168.2.1 as-number 10
peer 192.168.3.2 as-number 30
#
ipv4-family unicast
undo synchronization
import-route direct
peer 192.168.2.1 enable
peer 192.168.2.1 as-path-filter path-filter1 export
peer 192.168.3.2 enable
peer 192.168.3.2 as-path-filter path-filter2 export
#
ip as-path-filter path-filter1 deny _30_
ip as-path-filter path-filter1 permit .*
ip as-path-filter path-filter2 deny _10_
ip as-path-filter path-filter2 permit .*
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 30 40
#
interface Vlanif30
ip address 192.168.3.2 255.255.255.0
#
interface Vlanif40
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 30
router-id 172.16.3.3
peer 192.168.3.1 as-number 20
#
ipv4-family unicast
undo synchronization
import-route direct
peer 192.168.3.1 enable
#
return
9.17.6 Example for Configuring MED Attributes to Control BGP
Route Selection
Networking Requirements
As shown in Figure 9-48, BGP is configured on all switches; SwitchA resides in AS
65008; SwitchB and SwitchC reside in AS 65009. EBGP connections are established
between SwitchA and SwitchB, and between SwitchA and SwitchC. An IBGP
connection is established between SwitchB and SwitchC. After a period, traffic
from AS 65008 to AS 65009 needs to first pass through SwitchC.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 871
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-48 Networking diagram of configuring MED attributes of routes to
control route selection
Configuration Roadmap
The configuration roadmap is as follows:
1. Establish EBGP connections between SwitchA and SwitchB and between
SwitchA and SwitchC, and establish an IBGP connection between SwitchB and
SwitchC.
2. Apply a routing policy to increase the MED value of the route sent by SwitchB
to SwitchA so that SwitchA will send traffic to AS 65009 through SwitchC.
Procedure
Step 1 Create VLANs and add interfaces to the corresponding VLANs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 872
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.2 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.2.2 24
[SwitchA-Vlanif20] quit
Step 3 Establish a BGP connection.
# Configure SwitchA.
[SwitchA] bgp 65008
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] peer 192.168.1.1 as-number 65009
[SwitchA-bgp] peer 192.168.2.1 as-number 65009
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65009
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] peer 192.168.1.2 as-number 65008
[SwitchB-bgp] peer 10.1.1.2 as-number 65009
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] network 10.1.1.0 255.255.255.0
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 65009
[SwitchC-bgp] router-id 172.16.3.3
[SwitchC-bgp] peer 192.168.2.2 as-number 65008
[SwitchC-bgp] peer 10.1.1.1 as-number 65009
[SwitchC-bgp] ipv4-family unicast
[SwitchC-bgp-af-ipv4] network 10.1.1.0 255.255.255.0
[SwitchC-bgp-af-ipv4] quit
[SwitchC-bgp] quit
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.16.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.1.1 0 0 65009i
* 192.168.2.1 0 0 65009i
According to the routing table, you can view that there are two valid routes
destined for 10.1.1.0/24. The route whose next hop is 192.168.1.1 is the optimal
route because the router ID of SwitchB is smaller.
Step 4 Configure load balancing.
# Configure SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 873
[SwitchA] bgp 65008
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] maximum load-balancing 2
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.16.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.1.1 0 0 65009i
*> 192.168.2.1 0 0 65009i
According to the routing table, you can view that the BGP route 10.1.1.0/24 has
two next hops that are 192.168.1.1 and 192.168.2.1. Both of them are optimal
routes.
Step 5 Set the MED.
# Set the MED sent from SwitchB to SwitchA through the policy.
[SwitchB] route-policy 10 permit node 10
[SwitchB-route-policy] apply cost 100
[SwitchB-route-policy] quit
[SwitchB] bgp 65009
[SwitchB-bgp] peer 192.168.1.2 route-policy 10 export
# Check the routing table of SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.16.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.2.1 0 0 65009i
* 192.168.1.1 100 0 65009i
According to the routing table, you can view that the MED of the next hop
192.168.1.1 (SwitchB) is 100, and that of the next hop 192.168.2.1 is 0. Therefore,
the route with the smaller MED is selected.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif20
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 874
ip address 192.168.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 65008
router-id 172.16.1.1
peer 192.168.1.1 as-number 65009
peer 192.168.2.1 as-number 65009
#
ipv4-family unicast
undo synchronization
maximum load-balancing 2
peer 192.168.1.1 enable
peer 192.168.2.1 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 30
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface Vlanif30
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65009
router-id 172.16.2.2
peer 10.1.1.2 as-number 65009
peer 192.168.1.2 as-number 65008
#
ipv4-family unicast
undo synchronization
network 10.1.1.0 255.255.255.0
peer 10.1.1.2 enable
peer 192.168.1.2 enable
peer 192.168.1.2 route-policy 10 export
#
route-policy 10 permit node 10
apply cost 100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 30
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface Vlanif30
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 875
ip address 10.1.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 65009
router-id 172.16.3.3
peer 10.1.1.1 as-number 65009
peer 192.168.2.2 as-number 65008
#
ipv4-family unicast
undo synchronization
network 10.1.1.0 255.255.255.0
peer 10.1.1.1 enable
peer 192.168.2.2 enable
#
return
9.17.7 Example for Configuring a BGP Route Reflector
Networking Requirements
In Figure 9-49, four switches belong to two ASs, SwitchA and SwitchB establish an
EBGP neighbor relationship, and SwitchC establishes an IBGP neighbor relationship
with SwitchB and SwitchD. To prevent IBGP fully meshed connections and simplify
network configurations, the user requires that devices in the two ASs
communicate when no IBGP connection is established between SwitchB and
SwitchD.
Figure 9-49 Networking diagram of configuring a BGP route reflector (RR)
Configuration Roadmap
The configuration roadmap is as follows:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 876
1. Configure basic BGP functions to allow BGP neighbors to communicate.
2. Configure SwitchC as an RR and configure SwitchB and SwitchD as two clients
of the RR. Subsequently, SwitchB and SwitchD can learn the routes advertised
by SwitchA without establishing an IBGP connection, simplifying
configurations.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA, and are not mentioned here.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Configure IP addresses for interfaces and set the IP address of LoopBack0 on
SwitchA as the destination IP address of a ping test.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA, and are not mentioned here.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.10.10.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface LoopBack 0
[SwitchA-LoopBack0] ip address 192.168.10.1 32
[SwitchA-LoopBack0] quit
Step 3 Configure basic BGP functions and advertise direct network segments in the BGP
processes of the four switches.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer 10.10.10.2 as-number 200
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] network 192.168.10.1 32
[SwitchA-bgp-af-ipv4] network 10.10.10.0 24
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer 10.10.10.1 as-number 100
[SwitchB-bgp] peer 10.10.20.2 as-number 200
[SwitchB-bgp] ipv4-family unicast
[SwitchB-bgp-af-ipv4] network 10.10.10.0 24
[SwitchB-bgp-af-ipv4] network 10.10.20.0 24
[SwitchB-bgp-af-ipv4] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] router-id 10.3.3.3
[SwitchC-bgp] peer 10.10.20.1 as-number 200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 877
[SwitchC-bgp] peer 10.10.30.2 as-number 200
[SwitchC-bgp] ipv4-family unicast
[SwitchC-bgp-af-ipv4] network 10.10.20.0 24
[SwitchC-bgp-af-ipv4] network 10.10.30.0 24
[SwitchC-bgp-af-ipv4] quit
[SwitchC-bgp] quit
# Configure SwitchD.
[SwitchD] bgp 200
[SwitchD-bgp] router-id 10.4.4.4
[SwitchD-bgp] peer 10.10.30.1 as-number 200
[SwitchD-bgp] ipv4-family unicast
[SwitchD-bgp-af-ipv4] network 10.10.30.0 24
[SwitchD-bgp-af-ipv4] quit
[SwitchD-bgp] quit
Step 4 Configure an RR.
# Configure SwitchC as an RR and configure SwitchB and SwitchD as two clients
of the RR.
[SwitchC] bgp 200
[SwitchC-bgp] ipv4-family unicast
[SwitchC-bgp-af-ipv4] peer 10.10.20.1 reflect-client
[SwitchC-bgp-af-ipv4] peer 10.10.30.2 reflect-client
[SwitchC-bgp-af-ipv4] quit
[SwitchC-bgp] quit
Step 5 Verify the configuration.
# Check the BGP routing table of SwitchB.
[SwitchB] display bgp routing-table 192.168.10.1 32
BGP local router ID : 10.2.2.2
Local AS number : 200
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 192.168.10.1/32:
From: 10.10.10.1 (10.1.1.1)
Route Duration: 00h34m09s
Direct Out-interface: Vlanif10
Original nexthop: 10.10.10.1
Qos information : 0x0
AS-path 100, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 1 peers:
10.10.20.2
The command output shows that SwitchB has learned and advertised the route
192.168.10.1/32 to SwitchC.
# Check the BGP routing table of SwitchC.
[SwitchC] display bgp routing-table 192.168.10.1 32
BGP local router ID : 10.3.3.3
Local AS number : 200
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 192.168.10.1/32:
RR-client route.
From: 10.10.20.1 (10.2.2.2)
Route Duration: 00h34m17s
Relay IP Nexthop: 10.10.20.1
Relay IP Out-Interface: Vlanif20
Original nexthop: 10.10.10.1
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Advertised to such 2 peers:
10.10.20.1
10.10.30.2
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 878
The command output shows that SwitchC has learned and advertised the route
192.168.10.1/32 to its two clients SwitchB and SwitchD.
# Check the BGP routing table of SwitchD.
[SwitchD] display bgp routing-table 192.168.10.1 32
BGP local router ID : 10.4.4.4
Local AS number : 200
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 192.168.10.1/32:
From: 10.10.30.1 (10.3.3.3)
Route Duration: 00h34m25s
Relay IP Nexthop: 10.10.30.1
Relay IP Out-Interface: Vlanif30
Original nexthop: 10.10.10.1
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, active, pre 255
Originator: 10.2.2.2
Cluster list: 10.3.3.3
Not advertised to any peer yet
The command output shows that SwitchD has learned from SwitchC the route
192.168.10.1/32 advertised by SwitchA.
# On SwitchD, ping the IP address of LoopBack0 on SwitchA to test route
reachability.
[SwitchD] ping 192.168.10.1
PING 192.168.10.1: 56 data bytes, press CTRL_C to break
Reply from 192.168.10.1: bytes=56 Sequence=1 ttl=255 time=31 ms
Reply from 192.168.10.1: bytes=56 Sequence=2 ttl=255 time=16 ms
Reply from 192.168.10.1: bytes=56 Sequence=3 ttl=255 time=40 ms
Reply from 192.168.10.1: bytes=56 Sequence=4 ttl=255 time=30 ms
Reply from 192.168.10.1: bytes=56 Sequence=5 ttl=255 time=26 ms
--- 192.168.10.1 ping statistics ---
5 packet(s) transmitted
5 packet(s) received
0.00% packet loss
round-trip min/avg/max = 70/84/100 ms
The command output shows that SwitchD pings the IP address of LoopBack0 on
SwitchA successfully, indicating that routes to SwitchA are reachable.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10
#
interface Vlanif10
ip address 10.10.10.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface LoopBack0
ip address 192.168.10.1 255.255.255.255
#
bgp 100
router-id 10.1.1.1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 879
peer 10.10.10.2 as-number 200
#
ipv4-family unicast
undo synchronization
network 10.10.10.0 255.255.255.0
network 192.168.10.1 255.255.255.255
peer 10.10.10.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.10.10.2 255.255.255.0
#
interface Vlanif20
ip address 10.10.20.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 200
router-id 10.2.2.2
peer 10.10.10.1 as-number 100
peer 10.10.20.2 as-number 200
#
ipv4-family unicast
undo synchronization
network 10.10.10.0 255.255.255.0
network 10.10.20.0 255.255.255.0
peer 10.10.10.1 enable
peer 10.10.20.2 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 30
#
interface Vlanif20
ip address 10.10.20.2 255.255.255.0
#
interface Vlanif30
ip address 10.10.30.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 200
router-id 10.3.3.3
peer 10.10.20.1 as-number 200
peer 10.10.30.2 as-number 200
#
ipv4-family unicast
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 880
undo synchronization
network 10.10.20.0 255.255.255.0
network 10.10.30.0 255.255.255.0
peer 10.10.20.1 enable
peer 10.10.20.1 reflect-client
peer 10.10.30.2 enable
peer 10.10.30.2 reflect-client
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30
#
interface Vlanif30
ip address 10.10.30.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 200
router-id 10.4.4.4
peer 10.10.30.1 as-number 200
#
ipv4-family unicast
undo synchronization
network 10.10.30.0 255.255.255.0
peer 10.10.30.1 enable
#
return
9.17.8 Example for Configuring a BGP4+ Route Reflector
Networking Requirements
As shown in Figure 9-50, four devices belong to two ASs. You are required to
perform simplified configuration to ensure that the two ASs communicate with
each other.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 881
Figure 9-50 Networking diagram of configuring a BGP4+ route reflector
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic BGP4+ functions to allow BGP neighbors to communicate.
2. Configure SwitchC as a route reflector so that no IBGP connection needs to be
established between SwitchB and SwitchD. This simplifies the configuration.
Procedure
Step 1 Add interfaces to VLANs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Enable the IPv6 forwarding capability, and assign an IPv6 address for each
interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] ipv6
[SwitchA] interface vlanif 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 882
[SwitchA-Vlanif10] ipv6 enable
[SwitchA-Vlanif10] ipv6 address fc00:0:0:0:1::1/64
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ipv6 enable
[SwitchA-Vlanif20] ipv6 address fc00:0:0:0:10::1/96
[SwitchA-Vlanif20] quit
Step 3 Configure basic BGP4+ functions.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer fc00:0:0:0:10::2 as-number 200
[SwitchA-bgp] ipv6-family unicast
[SwitchA-bgp-af-ipv6] peer fc00:0:0:0:10::2 enable
[SwitchA-bgp-af-ipv6] network fc00:0:0:0:1:: 64
[SwitchA-bgp-af-ipv6] network fc00:0:0:0:10:: 96
[SwitchA-bgp-af-ipv6] quit
# Configure SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer fc00:0:0:0:10::1 as-number 100
[SwitchB-bgp] peer fc00:0:0:0:11::1 as-number 200
[SwitchB-bgp] ipv6-family unicast
[SwitchB-bgp-af-ipv6] peer fc00:0:0:0:10::1 enable
[SwitchB-bgp-af-ipv6] peer fc00:0:0:0:11::1 enable
[SwitchB-bgp-af-ipv6] network fc00:0:0:0:10:: 96
[SwitchB-bgp-af-ipv6] network fc00:0:0:0:11:: 96
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] router-id 10.3.3.3
[SwitchC-bgp] peer fc00:0:0:0:11::2 as-number 200
[SwitchC-bgp] peer fc00:0:0:0:12::2 as-number 200
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer fc00:0:0:0:11::2 enable
[SwitchC-bgp-af-ipv6] peer fc00:0:0:0:12::2 enable
[SwitchC-bgp-af-ipv6] network fc00:0:0:0:11:: 96
[SwitchC-bgp-af-ipv6] network fc00:0:0:0:12:: 96
[SwitchC-bgp-af-ipv6] quit
# Configure SwitchD.
[SwitchD] bgp 200
[SwitchD-bgp] router-id 10.4.4.4
[SwitchD-bgp] peer fc00:0:0:0:12::1 as-number 200
[SwitchD-bgp] ipv6-family unicast
[SwitchD-bgp-af-ipv6] peer fc00:0:0:0:12::1 enable
[SwitchD-bgp-af-ipv6] network fc00:0:0:0:12:: 96
[SwitchD-bgp-af-ipv6] quit
[SwitchD-bgp] quit
Step 4 Configure the route reflector.
# Configure SwitchC as the route reflector and SwitchB and SwitchD as the clients.
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer fc00:0:0:0:11::2 reflect-client
[SwitchC-bgp-af-ipv6] peer fc00:0:0:0:12::2 reflect-client
# View the routing table of SwitchB.
[SwitchB] display bgp ipv6 routing-table
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 883
BGP Local router ID is 10.2.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 6
*> Network : 1:: PrefixLen : 64
NextHop : FC00:0:0:0:10::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 100 i
*> Network : FC00:0:0:0:10:: PrefixLen : 96
NextHop : :: LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
NextHop : FC00:0:0:0:10::1 LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : 100 i
*> Network : FC00:0:0:0:11:: PrefixLen : 96
NextHop : :: LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
i
NextHop : FC00:0:0:0:11::1 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
*>i Network : FC00:0:0:0:12:: PrefixLen : 96
NextHop : FC00:0:0:0:11::1 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
# View the routing table of SwitchD.
[SwitchD] display bgp ipv6 routing-table
BGP Local router ID is 10.4.4.4
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
*>i Network : FC00:0:0:1:: PrefixLen : 64
NextHop : FC00:0:0:10::1 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : 100 i
*>i Network : FC00:0:0:10:: PrefixLen : 96
NextHop : FC00:0:0:11::2 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
*>i Network : FC00:0:0:11:: PrefixLen : 96
NextHop : FC00:0:0:12::1 LocPrf : 100
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
*> Network : FC00:0:0:12:: PrefixLen : 96
NextHop : :: LocPrf :
MED : 0 PrefVal : 0
Label :
Path/Ogn : i
i
NextHop : FC00:0:0:12::1 LocPrf : 100
MED : 0 PrefVal : 0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 884
Label :
Path/Ogn : i
The routing tables show that SwitchD and SwitchB have learned the routing
information advertised by SwitchA from SwitchC.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
vlan batch 10 20
#
interface Vlanif10
ipv6 enable
ipv6 address FC00:0:0:1::1/64
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:10::1/96
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 100
router-id 10.1.1.1
peer FC00:0:0:10::2 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:1:: 64
network FC00:0:0:10:: 96
peer FC00:0:0:10::2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
vlan batch 20 30
#
interface Vlanif20
ipv6 enable
ipv6 address FC00:0:0:10::2/96
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:11::2/96
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 885
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 200
router-id 10.2.2.2
peer FC00:0:0:10::1 as-number 100
peer FC00:0:0:11::1 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:10:: 96
network FC00:0:0:11:: 96
peer FC00:0:0:10::1 enable
peer FC00:0:0:11::1 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
vlan batch 30 40
#
interface Vlanif30
ipv6 enable
ipv6 address FC00:0:0:11::1/96
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:12::1/96
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 200
router-id 10.3.3.3
peer FC00:0:0:11::2 as-number 200
peer FC00:0:0:12::2 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:11:: 96
network FC00:0:0:12:: 96
peer FC00:0:0:11::2 enable
peer FC00:0:0:11::2 reflect-client
peer FC00:0:0:12::2 enable
peer FC00:0:0:12::2 reflect-client
#
return
● SwitchD configuration file
#
sysname SwitchD
#
ipv6
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 886
#
vlan batch 40
#
interface Vlanif40
ipv6 enable
ipv6 address FC00:0:0:12::2/96
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
bgp 200
router-id 10.4.4.4
peer FC00:0:0:12::1 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:0:0:12:: 96
peer FC00:0:0:12::1 enable
#
return
9.17.9 Example for Configuring a BGP Confederation
Networking Requirements
In Figure 9-51, there are multiple BGP switches in AS 200. It is required that the
number of IBGP connections be reduced.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 887
Figure 9-51 Networking diagram of configuring a BGP confederation
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure a BGP confederation on each switch in AS 200 to divide AS 200 into
three sub-ASs: AS 65001, AS 65002, and AS 65003. Three switches in AS
65001 establish full-mesh IBGP connections to reduce the number of IBGP
connections.
Procedure
Step 1 Create VLANs and add interfaces to the corresponding VLANs.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20 30 40 60
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
[SwitchA] interface gigabitethernet 0/0/3
[SwitchA-GigabitEthernet0/0/3] port link-type trunk
[SwitchA-GigabitEthernet0/0/3] port trunk allow-pass vlan 30
[SwitchA-GigabitEthernet0/0/3] quit
[SwitchA] interface gigabitethernet 0/0/4
[SwitchA-GigabitEthernet0/0/4] port link-type trunk
[SwitchA-GigabitEthernet0/0/4] port trunk allow-pass vlan 40
[SwitchA-GigabitEthernet0/0/4] quit
[SwitchA] interface gigabitethernet 0/0/5
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 888
[SwitchA-GigabitEthernet0/0/5] port link-type trunk
[SwitchA-GigabitEthernet0/0/5] port trunk allow-pass vlan 60
[SwitchA-GigabitEthernet0/0/5] quit
The configurations of SwitchB, SwitchC, SwitchD, SwitchE, and SwitchF are similar
to the configuration of SwitchA, and are not mentioned here.
Step 2 Assign an IP address to each VLANIF interface.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 10.1.2.1 24
[SwitchA-Vlanif20] quit
[SwitchA] interface vlanif 30
[SwitchA-Vlanif30] ip address 10.1.3.1 24
[SwitchA-Vlanif30] quit
[SwitchA] interface vlanif 40
[SwitchA-Vlanif40] ip address 10.1.4.1 24
[SwitchA-Vlanif40] quit
[SwitchA] interface vlanif 60
[SwitchA-Vlanif60] ip address 192.168.1.1 24
[SwitchA-Vlanif60] quit
The configurations of SwitchB, SwitchC, SwitchD, SwitchE, and SwitchF are similar
to the configuration of SwitchA, and are not mentioned here.
Step 3 Configure the BGP confederation.
# Configure SwitchA.
[SwitchA] bgp 65001
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] confederation id 200
[SwitchA-bgp] confederation peer-as 65002 65003
[SwitchA-bgp] peer 10.1.1.2 as-number 65002
[SwitchA-bgp] peer 10.1.2.2 as-number 65003
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] peer 10.1.1.2 next-hop-local
[SwitchA-bgp-af-ipv4] peer 10.1.2.2 next-hop-local
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 65002
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] confederation id 200
[SwitchB-bgp] confederation peer-as 65001 65003
[SwitchB-bgp] peer 10.1.1.1 as-number 65001
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 65003
[SwitchC-bgp] router-id 172.16.3.3
[SwitchC-bgp] confederation id 200
[SwitchC-bgp] confederation peer-as 65001 65002
[SwitchC-bgp] peer 10.1.2.1 as-number 65001
[SwitchC-bgp] quit
Step 4 Establish IBGP connection in AS 65001.
# Configure SwitchA.
[SwitchA] bgp 65001
[SwitchA-bgp] peer 10.1.3.2 as-number 65001
[SwitchA-bgp] peer 10.1.4.2 as-number 65001
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 889
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] peer 10.1.3.2 next-hop-local
[SwitchA-bgp-af-ipv4] peer 10.1.4.2 next-hop-local
[SwitchA-bgp-af-ipv4] quit
# Configure SwitchD.
[SwitchD] bgp 65001
[SwitchD-bgp] router-id 172.16.4.4
[SwitchD-bgp] peer 10.1.3.1 as-number 65001
[SwitchD-bgp] peer 10.1.5.2 as-number 65001
[SwitchD-bgp] quit
# Configure SwitchE.
[SwitchE] bgp 65001
[SwitchE-bgp] router-id 172.16.5.5
[SwitchE-bgp] peer 10.1.4.1 as-number 65001
[SwitchE-bgp] peer 10.1.5.1 as-number 65001
[SwitchE-bgp] quit
Step 5 Establish an EBGP connection between AS 100 and AS 200.
# Configure SwitchA.
[SwitchA] bgp 65001
[SwitchA-bgp] peer 192.168.1.2 as-number 100
[SwitchA-bgp] quit
# Configure SwitchF.
[SwitchF] bgp 100
[SwitchF-bgp] router-id 172.16.6.6
[SwitchF-bgp] peer 192.168.1.1 as-number 200
[SwitchF-bgp] ipv4-family unicast
[SwitchF-bgp-af-ipv4] network 10.0.1.0 255.255.255.0
[SwitchF-bgp-af-ipv4] quit
[SwitchF-bgp] quit
Step 6 Verify the configuration.
# Check the BGP routing table of SwitchB.
[SwitchB] display bgp routing-table
BGP Local router ID is 172.16.2.2
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.0.1.0/24 10.1.1.1 0 100 0 (65001) 100i
[SwitchB] display bgp routing-table 10.0.1.0
BGP local router ID : 172.16.2.2
Local AS number : 65002
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.0.1.0/24:
From: 10.1.1.1 (172.16.1.1)
Route Duration: 00h01m22s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: Vlanif10
Original nexthop: 10.1.1.1
Qos information : 0x0
AS-path (65001) 100, origin igp, MED 0, localpref 100, pref-val 0, valid, external-confed, best,select, active,
pre 255
Not advertised to any peer yet
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 890
# Check the BGP routing table of SwitchD.
[SwitchD] display bgp routing-table
BGP Local router ID is 172.16.4.4
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*>i 10.0.1.0/24 10.1.3.1 0 100 0 100i
[SwitchD] display bgp routing-table 10.0.1.0
BGP local router ID : 172.16.4.4
Local AS number : 65001
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.0.1.0/24:
From: 10.1.3.1 (172.16.1.1)
Route Duration: 00h18m34s
Relay IP Nexthop: 0.0.0.0
Relay IP Out-Interface: Vlanif30
Original nexthop: 10.1.3.1
Qos information : 0x0
AS-path 100, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best,select, active, pre 255
Not advertised to any peer yet
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20 30 40 60
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
#
interface Vlanif20
ip address 10.1.2.1 255.255.255.0
#
interface Vlanif30
ip address 10.1.3.1 255.255.255.0
#
interface Vlanif40
ip address 10.1.4.1 255.255.255.0
#
interface Vlanif60
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/4
port link-type trunk
port trunk allow-pass vlan 40
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 891
#
interface GigabitEthernet0/0/5
port link-type trunk
port trunk allow-pass vlan 60
#
bgp 65001
router-id 172.16.1.1
confederation id 200
confederation peer-as 65002 65003
peer 10.1.1.2 as-number 65002
peer 10.1.2.2 as-number 65003
peer 10.1.3.2 as-number 65001
peer 10.1.4.2 as-number 65001
peer 192.168.1.2 as-number 100
#
ipv4-family unicast
undo synchronization
peer 10.1.1.2 enable
peer 10.1.1.2 next-hop-local
peer 10.1.2.2 enable
peer 10.1.2.2 next-hop-local
peer 10.1.3.2 enable
peer 10.1.3.2 next-hop-local
peer 10.1.4.2 enable
peer 10.1.4.2 next-hop-local
peer 192.168.1.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
bgp 65002
router-id 172.16.2.2
confederation id 200
confederation peer-as 65001 65003
peer 10.1.1.1 as-number 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.1.1 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20
#
interface Vlanif20
ip address 10.1.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 65003
router-id 172.16.3.3
confederation id 200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 892
confederation peer-as 65001 65002
peer 10.1.2.1 as-number 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.2.1 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30 50
#
interface Vlanif30
ip address 10.1.3.2 255.255.255.0
#
interface Vlanif50
ip address 10.1.5.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 65001
router-id 172.16.4.4
peer 10.1.3.1 as-number 65001
peer 10.1.5.2 as-number 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.3.1 enable
peer 10.1.5.2 enable
#
return
● SwitchE configuration file
#
sysname SwitchE
#
vlan batch 40 50
#
interface Vlanif40
ip address 10.1.4.2 255.255.255.0
#
interface Vlanif50
ip address 10.1.5.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 65001
router-id 172.16.5.5
peer 10.1.4.1 as-number 65001
peer 10.1.5.1 as-number 65001
#
ipv4-family unicast
undo synchronization
peer 10.1.4.1 enable
peer 10.1.5.1 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 893
#
return
● SwitchF configuration file
#
sysname SwitchF
#
vlan batch 60 70
#
interface Vlanif60
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif70
ip address 10.0.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 60
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 70
#
bgp 100
router-id 172.16.6.6
peer 192.168.1.1 as-number 200
#
ipv4-family unicast
undo synchronization
network 10.0.1.0 255.255.255.0
peer 192.168.1.1 enable
#
return
9.17.10 Example for Configuring the BGP Community
Attribute
Networking Requirements
As shown in Figure 9-52, EBGP connections are established between SwitchB and
SwitchA, and between SwitchB and SwitchC. It is required that the routes
advertised from AS 10 to AS 20 are not advertised to other ASs by AS 20.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 894
Figure 9-52 Networking diagram of configuring the BGP community
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure a route-policy on SwitchA to advertise the No_Export attribute so
that AS 20 does not advertise the routes received from AS 10 to other ASs.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 10.1.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.2.1 24
[SwitchA-Vlanif20] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 895
Step 3 Configure EBGP.
# ConfigureSwitchA.
[SwitchA] bgp 10
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] peer 192.168.2.2 as-number 20
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] network 10.1.1.0 255.255.255.0
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 20
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] peer 192.168.2.1 as-number 10
[SwitchB-bgp] peer 192.168.3.2 as-number 30
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 30
[SwitchC-bgp] router-id 172.16.3.3
[SwitchC-bgp] peer 192.168.3.1 as-number 20
[SwitchC-bgp] quit
# Check the routing table of SwitchB.
[SwitchB] display bgp routing-table 10.1.1.0
BGP local router ID : 172.16.2.2
Local AS number : 20
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.2.1 (172.16.1.1)
Route Duration: 00h00m15s
Direct Out-interface: Vlanif20
Original nexthop: 192.168.2.1
Qos information : 0x0
AS-path 10, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
192.168.2.1
192.168.3.2
You can view that SwitchB advertises the received routes to SwitchC in AS 30.
# Check the routing table of SwitchC.
[SwitchC] display bgp routing-table
BGP Local router ID is 172.16.3.3
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.3.1 0 20 10i
You can find that SwitchC has learned a route to the destination 10.1.1.0/24 from
SwitchB.
Step 4 Configure BGP community attributes.
# Configure the routing policy on SwitchA to enable SwitchB not to advertise the
routes advertised by SwitchA to any other AS.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 896
[SwitchA] route-policy comm_policy permit node 10
[SwitchA-route-policy] apply community no-export
[SwitchA-route-policy] quit
# Apply routing policies.
[SwitchA] bgp 10
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] peer 192.168.2.2 route-policy comm_policy export
[SwitchA-bgp-af-ipv4] peer 192.168.2.2 advertise-community
# Check the routing table of SwitchB.
[SwitchB] display bgp routing-table 10.1.1.0
BGP local router ID : 172.16.2.2
Local AS number : 20
Paths: 1 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.2.1 (172.16.1.1)
Route Duration: 00h00m33s
Direct Out-interface: Vlanif20
Original nexthop: 192.168.2.1
Qos information : 0x0
Community:no-export
AS-path 10, origin igp, MED 0, pref-val 0, valid, external, best, select, active, pre 255
Not advertised to any peer yet
You can view the configured community attribute in the BGP routing table of
SwitchB. At this time, there are no routes to the destination 10.1.1.0/24 in the BGP
routing table of SwitchC.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 10
router-id 172.16.1.1
peer 192.168.2.2 as-number 20
#
ipv4-family unicast
undo synchronization
network 10.1.1.0 255.255.255.0
peer 192.168.2.2 enable
peer 192.168.2.2 route-policy comm_policy export
peer 192.168.2.2 advertise-community
#
route-policy comm_policy permit node 10
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 897
apply community no-export
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 20 30
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.3.1 255.255.255.0
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 20
router-id 172.16.2.2
peer 192.168.2.1 as-number 10
peer 192.168.3.2 as-number 30
#
ipv4-family unicast
undo synchronization
peer 192.168.2.1 enable
peer 192.168.3.2 enable
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan 30
#
interface Vlanif30
ip address 192.168.3.2 255.255.255.0
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 30
router-id 172.16.3.3
peer 192.168.3.1 as-number 20
#
ipv4-family unicast
undo synchronization
peer 192.168.3.1 enable
#
return
9.17.11 Example for Configuring BGP Load Balancing
Networking Requirements
On the network shown in Figure 9-53, BGP is configured on all switches. SwitchA
is in AS 100. SwitchB and SwitchC are in AS 300. SwitchD is in AS 200. Network
congestion from SwitchA to destination address 10.1.1.0/24 needs to be relieved
and network resources need to be fully utilized.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 898
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-53 Networking diagram of configuring BGP load balancing
Configuration Roadmap
The configuration roadmap is as follows:
1. Establish EBGP connections between SwitchA and SwitchB and between
SwitchA and SwitchC, between SwitchD and SwitchB and between SwitchD
and SwitchC to enable ASs to communicate with each other using BGP.
2. Configuring load balancing on SwitchA so that SwitchA can send traffic to
SwitchD through either SwitchB or SwitchC.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 899
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.1.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.2.1 24
[SwitchA-Vlanif20] quit
Step 3 Establish BGP connections.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 172.16.1.1
[SwitchA-bgp] peer 192.168.1.2 as-number 300
[SwitchA-bgp] peer 192.168.2.2 as-number 300
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 300
[SwitchB-bgp] router-id 172.16.2.2
[SwitchB-bgp] peer 192.168.1.1 as-number 100
[SwitchB-bgp] peer 192.168.3.1 as-number 200
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 300
[SwitchC-bgp] router-id 172.16.3.3
[SwitchC-bgp] peer 192.168.2.1 as-number 100
[SwitchC-bgp] peer 192.168.4.1 as-number 200
[SwitchC-bgp] quit
# Configure SwitchD.
[SwitchD] bgp 200
[SwitchD-bgp] router-id 172.16.4.4
[SwitchD-bgp] peer 192.168.3.2 as-number 300
[SwitchD-bgp] peer 192.168.4.2 as-number 300
[SwitchD-bgp] ipv4-family unicast
[SwitchD-bgp-af-ipv4] network 10.1.1.0 255.255.255.0
[SwitchD-bgp-af-ipv4] quit
[SwitchD-bgp] quit
# View the routing table of SwitchA.
[SwitchA] display bgp routing-table 10.1.1.0 24
BGP local router ID : 172.16.1.1
Local AS number : 100
Paths: 2 available, 1 best, 1 select
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.1.2 (172.16.2.2)
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 900
Route Duration: 0d00h00m50s
Direct Out-interface: Vlanif10
Original nexthop: 192.168.1.2
Qos information : 0x0
AS-path 300 200, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
192.168.2.2
192.168.1.2
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.2.2 (172.16.3.3)
Route Duration: 0d00h00m51s
Direct Out-interface: Vlanif20
Original nexthop: 192.168.2.2
Qos information : 0x0
AS-path 300 200, origin igp, pref-val 0, valid, external, pre 255, not preferred for router ID
Not advertised to any peer yet
The preceding command output shows that there are two valid routes from
SwitchA to destination 10.1.1.0/24. The route with the next-hop address of
192.168.1.2 is the optimal route because the router ID of SwitchB is smaller.
Step 4 Configure BGP load balancing.
# Configure load balancing on SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] ipv4-family unicast
[SwitchA-bgp-af-ipv4] maximum load-balancing 2
[SwitchA-bgp-af-ipv4] quit
[SwitchA-bgp] quit
Step 5 Verify the configuration.
# View the routing table of SwitchA.
[SwitchA] display bgp routing-table 10.1.1.0 24
BGP local router ID : 172.16.1.1
Local AS number : 100
Paths: 2 available, 1 best, 2 select
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.1.2 (172.16.2.2)
Route Duration: 0d00h03m55s
Direct Out-interface: Vlanif10
Original nexthop: 192.168.1.2
Qos information : 0x0
AS-path 300 200, origin igp, pref-val 0, valid, external, best, select, active, pre 255
Advertised to such 2 peers:
192.168.2.2
192.168.1.2
BGP routing table entry information of 10.1.1.0/24:
From: 192.168.2.2 (172.16.3.3)
Route Duration: 0d00h03m56s
Direct Out-interface: Vlanif20
Original nexthop: 192.168.2.2
Qos information : 0x0
AS-path 300 200, origin igp, pref-val 0, valid, external, select, active, pre 255, not preferred for router ID
Not advertised to any peer yet
The preceding command output shows that BGP route 10.1.1.0/24 has two next
hops: 192.168.1.2 and 192.168.2.2. Both of them are optimal routes.
----End
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 901
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
vlan batch 10 20
#
interface Vlanif10
ip address 192.168.1.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 100
router-id 172.16.1.1
peer 192.168.1.2 as-number 300
peer 192.168.2.2 as-number 300
#
ipv4-family unicast
undo synchronization
maximum load-balancing 2
peer 192.168.1.2 enable
peer 192.168.2.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 30
#
interface Vlanif10
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif30
ip address 192.168.3.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 300
router-id 172.16.2.2
peer 192.168.1.1 as-number 100
peer 192.168.3.1 as-number 200
#
ipv4-family unicast
undo synchronization
peer 192.168.1.1 enable
peer 192.168.3.1 enable
#
return
● SwitchC configuration file
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 902
#
sysname SwitchC
#
vlan batch 20 40
#
interface Vlanif20
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif40
ip address 192.168.4.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 300
router-id 172.16.3.3
peer 192.168.2.1 as-number 100
peer 192.168.4.1 as-number 200
#
ipv4-family unicast
undo synchronization
peer 192.168.2.1 enable
peer 192.168.4.1 enable
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30 40 50
#
interface Vlanif30
ip address 192.168.3.1 255.255.255.0
#
interface Vlanif40
ip address 192.168.4.1 255.255.255.0
#
interface Vlanif50
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 50
#
bgp 200
router-id 172.16.4.4
peer 192.168.3.2 as-number 300
peer 192.168.4.2 as-number 300
#
ipv4-family unicast
undo synchronization
network 10.1.1.0 255.255.255.0
peer 192.168.3.2 enable
peer 192.168.4.2 enable
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 903
9.17.12 Example for Configuring a BGP Routing Policy
Networking Requirements
Figure 9-54 shows the simplified MPLS network that carries multiple types of
L3VPN services, such as multimedia, signaling, and accounting. In Figure 9-54,
two sites, each of which has two PEs accessing the core layer, are taken as an
example. The core layer is divided into two planes. All the P nodes on the same
plane are full-meshed P nodes. Nodes on different planes are connected to
provide backup paths across plane. MP-BGP is used to advertise inner labels and
VPNv4 routes between the PEs. All PEs set up MP-IBGP peer relationships with the
RR.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-54 Networking diagram
NOTE
Figure 9-54 is a simplified networking diagram, in which two sites are taken as an example
and each plane takes three P nodes and one RR as an example. In the actual network, there
are 14 sites with 28 PEs and each plane has four P nodes and two RR nodes, and each RR
needs to set up MP-IBGP connections with 28 PEs.
In Figure 9-54, each PE sends BGP Update messages to the RR, other PEs receive
BGP Update messages from different planes. Therefore, routing policies need to be
deployed to ensure that one VPN flow is transmitted only through one plane.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 904
Data Plan
Table 9-32 IP addresses of interconnected interfaces
Link
Name
(Local
End-
Remote
End)
Local Interface and IP Address Remote Interface and IP
Address
P1–P3 GE1/0/0
VLANIF10: 10.1.1.1/30
GE1/0/0
VLANIF10: 10.1.1.2/30
P1–P5 GE2/0/0
VLANIF20: 10.1.2.1/30
GE1/0/0
VLANIF20: 10.1.2.2/30
P1–RR GE3/0/0
VLANIF30: 10.1.3.1/30
GE1/0/0
VLANIF30: 10.1.3.2/30
P1–P2 GE4/0/0
VLANIF40: 10.1.4.1/30
GE1/0/0
VLANIF40: 10.1.4.2/30
P1–PE1 GE5/0/0
VLANIF50: 10.1.5.1/30
GE1/0/0
VLANIF50: 10.1.5.2/30
P2–P6 GE4/0/0
VLANIF80: 10.1.6.1/30
GE1/0/0
VLANIF80: 10.1.6.2/30
P2–P4 GE3/0/0
VLANIF70: 10.1.7.1/30
GE1/0/0
VLANIF70: 10.1.7.2/30
P2–RR GE2/0/0
VLANIF60: 10.1.8.1/30
GE2/0/0
VLANIF60: 10.1.8.2/30
P2–PE2 GE5/0/0
VLANIF90: 10.1.9.1/30
GE1/0/0
VLANIF90: 10.1.9.2/30
P3–P5 GE2/0/0
VLANIF110: 10.1.10.1/30
GE2/0/0
VLANIF110: 10.1.10.2/30
P3–P4 GE3/0/0
VLANIF120: 10.1.11.1/30
GE2/0/0
VLANIF120: 10.1.11.2/30
P3–PE3 GE4/0/0
VLANIF130: 10.1.12.1/30
GE1/0/0
VLANIF130: 10.1.12.2/30
P4–P6 GE3/0/0
VLANIF150: 10.1.13.1/30
GE3/0/0
VLANIF150: 10.1.13.2/30
P4–PE4 GE4/0/0
VLANIF160: 10.1.14.1/30
GE1/0/0
VLANIF160: 10.1.14.2/30
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 905
Link
Name
(Local
End-
Remote
End)
Local Interface and IP Address Remote Interface and IP
Address
P5–P6 GE3/0/0
VLANIF170: 10.1.15.1/30
GE2/0/0
VLANIF170: 10.1.15.2/30
PE1–PE2 GE2/0/0
VLANIF100: 10.1.16.1/30
GE2/0/0
VLANIF100: 10.1.16.2/30
PE3–PE4 GE2/0/0
VLANIF140: 10.1.17.1/30
GE2/0/0
VLANIF140: 10.1.17.2/30
Table 9-33 IP addresses of loopback interfaces
Local Device IP Address of the
local Loopback 0
Interface
Remote Device IP Address of the
Remote
Loopback 0
Interface
P1 10.1.1.9/32 P2 10.2.2.9/32
P3 10.3.3.9/32 P4 10.4.4.9/32
P5 10.5.5.9/32 P6 10.6.6.9/32
PE1 10.7.7.9/32 PE2 10.8.8.9/32
PE3 10.9.9.9/32 PE4 10.10.10.9/32
RR 10.11.11.9/32 - -
Table 9-34 BGP parameter Value
BGP Parameter Value
AS number 65000
Router ID Same as the address of Loopback 0
interface
BGP community attribute Plane A: 65000:100
Plane B: 65000:200
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 906
BGP Parameter Value
BGP local preference Plane A: The local preference of
community attribute 65000:100 is set
to 200.
Plane B: The local preference of
community attribute 65000:200 is set
to 200.
NOTE
By default, the BGP local preference is 100.
The greater the value, the higher the
preference.
Routing policy name Route import policy: local_pre
Route export policy: comm
Community filter name 1
BGP peer group name Client
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure different RDs for two PEs in the same site to ensure that each PE
can receive two routes from different BGP next hops in the remote site. When
two PEs in a site advertise the routes to the same destination, configuring
different RDs for the two PEs can ensure that BGP peers consider the
advertised routes as two different routes. This is because BGP-VPNv4 uses the
VPNv4 addresses that consist of IPv4 addresses and RDs.
2. Assign different communities for BGP routes from PE in plane A and BGP
routes from PE in plane B.
3. Set different local preferences for routes based on the community attributes
of the routes. In this manner, the PEs in plane A choose the routes advertised
by remote PEs in plane A, and the PEs in plane B always choose the routes
advertised by the remote PEs in plane B.
Procedure
Step 1 Configure names for devices and IP addresses for interfaces.
For detailed configurations, see the configuration files of this example.
Step 2 Configure an IGP.
In this example, IS-IS is used as an IGP. For detailed configurations, see the
configuration files of this example.
After the configuration, run the display ip routing-table command. You can view
that PEs, Ps and PEs, and Ps have learned the addresses of Loopback 0 interfaces
from each other.
Step 3 Establish MP-IBGP connections between the PEs and RR.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 907
# Take the configuration of PE1 as an example. Configurations of other PEs are
similar to that of PE1, and are not mentioned here.
[PE1] bgp 65000
[PE1-bgp] peer 10.11.11.9 as-number 65000
[PE1-bgp] peer 10.11.11.9 connect-interface LoopBack0
[PE1-bgp] ipv4-family unicast
[PE1-bgp-af-ipv4] undo peer 10.11.11.9 enable
[PE1-bgp-af-ipv4] quit
[PE1-bgp] ipv4-family vpnv4
[PE1-bgp-af-vpnv4] peer 10.11.11.9 enable
# Configure the RR.
[RR] bgp 65000
[RR-bgp] group client internal
[RR-bgp] peer client connect-interface LoopBack0
[RR-bgp] ipv4-family unicast
[RR-bgp-af-ipv4] undo peer client enable
[RR-bgp-af-ipv4] quit
[RR-bgp] ipv4-family vpnv4
[RR-bgp-af-vpnv4] undo policy vpn-target
[RR-bgp-af-vpnv4] peer client enable
[RR-bgp-af-vpnv4] peer 10.7.7.9 group client
[RR-bgp-af-vpnv4] peer 10.8.8.9 group client
[RR-bgp-af-vpnv4] peer 10.9.9.9 group client
[RR-bgp-af-vpnv4] peer 10.10.10.9 group client
[RR-bgp-af-vpnv4] peer client reflect-client
NOTE
You need to run the undo policy vpn-target command in the BGP-VPNv4 address family
view of the RR to ensure that VPN-target-based filtering is not performed on VPNv4 routes.
By default, an RR performs VPN-target-based filtering on the received VPNv4 routes. The
matching routes are added to the VPN routing table, and the other routes are discarded. In
this example, VPN instances are not configured on the RR. As a result, if VPN-target-based
filtering is enabled, all the received VPNv4 routes will be discarded.
After the configuration, run the display bgp vpnv4 all peer command on the RR.
You can view that the RR sets up MP-IBGP peers with all PEs.
[RR] display bgp vpnv4 all peer
BGP local router ID : 10.11.11.9
Local AS number : 65000
Total number of peers : 4 Peers in established state : 4
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
10.7.7.9 4 65000 79 82 0 00:01:31 Established 0
10.8.8.9 4 65000 42 66 0 00:01:16 Established 0
10.9.9.9 4 65000 21 34 0 00:00:50 Established 0
10.10.10.9 4 65000 2 4 0 00:00:21 Established 0
Step 4 Configure a routing policy.
NOTE
Take the configurations of PE1, PE2, and the RR as an example. The configurations of PE3
and PE4 are similar to the configurations of PE1 and PE2 respectively, and are not
mentioned here.
# Configure a routing policy on PE1 so that the BGP VPNv4 route advertised by
PE1 can carry community attribute 65000:100.
[PE1] route-policy comm permit node 10
[PE1-route-policy] apply community 65000:100
# Configure the routing policy on PE2 so that the BGP VPNv4 route advertised by
PE2 can carry community attribute 65000:200.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 908
[PE2] route-policy comm permit node 10
[PE2-route-policy] apply community 65000:200
# On PE1, apply the routing policy to the BGP VPNv4 route advertised by PE1 to
the RR so that the route can carry the community attribute.
[PE1] bgp 65000
[PE1-bgp] ipv4-family vpnv4
[PE1-bgp-af-vpnv4] peer 10.11.11.9 route-policy comm export
[PE1-bgp-af-vpnv4] peer 10.11.11.9 advertise-community
# On PE2, apply the routing policy to the advertised BGP VPNv4 route advertised
by PE2 to the RR so that the route can carry the community attribute.
[PE2] bgp 65000
[PE2-bgp] ipv4-family vpnv4
[PE2-bgp-af-vpnv4] peer 10.11.11.9 route-policy comm export
[PE2-bgp-af-vpnv4] peer 10.11.11.9 advertise-community
# Configure the RR to advertise the community attribute to the PEs.
[RR] bgp 65000
[RR-bgp] ipv4-family vpnv4
[RR-bgp-af-vpnv4] peer client advertise-community
# Configure the community attribute filter on PE1.
[PE1] ip community-filter 1 permit 65000:100
# Configure the community attribute filter on PE2.
[PE2] ip community-filter 1 permit 65000:200
# On PE1, configure a routing policy and set the local preference of the route with
community attribute 65000:100 to 200.
[PE1] route-policy local_pre permit node 10
[PE1-route-policy] if-match community-filter 1
[PE1-route-policy] apply local-preference 200
[PE1-route-policy] quit
# On PE2, configure a routing policy and set the local preference of the route with
community attribute 65000:200 to 200.
[PE2] route-policy local_pre permit node 10
[PE2-route-policy] if-match community-filter 1
[PE2-route-policy] apply local-preference 200
[PE2-route-policy] quit
# On PE1, apply the routing policy to the imported BGP VPNv4 route so that the
PE1 chooses the route advertised by the remote PEs in plane A.
[PE1] bgp 65000
[PE1-bgp] ipv4-family vpnv4
[PE1-bgp-af-vpnv4] peer 10.11.11.9 route-policy local_pre import
# On PE2, apply the routing policy to the imported BGP VPNv4 route so that the
PE2 chooses the route advertised by the remote PEs in plane B.
[PE2] bgp 65000
[PE2-bgp] ipv4-family vpnv4
[PE2-bgp-af-vpnv4] peer 10.11.11.9 route-policy local_pre import
NOTE
After this configuration, you also need to configure MPLS, establish tunnels, configure MPLS
L3VPN, and configure PEs to access CEs. For detailed configurations, see the configuration files
of this example.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 909
Step 5 Verify the configuration.
Run the display bgp vpnv4 all routing-table community command on a PE. You
can view information about the VPNv4 routes with community attributes. Take the
display on PE1 and PE2 as an example.
[PE1] display bgp vpnv4 all routing-table community
BGP Local router ID is 10.7.7.9
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes from all PE: 2
Route Distinguisher: 65000:10001012
Network NextHop MED LocPrf PrefVal Community
*> 10.22.1.0/24 10.9.9.9 0 200 65000:100
* 10.10.10.9 0 100 65000:200
VPN-Instance NGN_Media, router ID 10.7.7.9:
Total Number of Routes: 2
Network NextHop MED LocPrf PrefVal Community
*>i 10.22.1.0/24 10.9.9.9 0 200 0 65000:100
* 10.10.10.9 0 100 0 65000:200
[PE2] display bgp vpnv4 all routing-table community
BGP Local router ID is 10.8.8.9
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes from all PE: 2
Route Distinguisher: 65000:10001011
Route Distinguisher: 65000:10001011
Network NextHop MED LocPrf PrefVal Community
*> 10.22.1.0/24 10.10.10.9 0 200 65000:200
* 10.9.9.9 0 100 65000:100
VPN-Instance NGN_Media, router ID 10.7.7.9:
Total Number of Routes: 2
Total routes of vpn-instance NGN_Media: 2
Network NextHop MED LocPrf PrefVal Community
*>i 10.22.1.0/24 10.10.10.9 0 200 0 65000:200
* 10.9.9.9 0 100 0 65000:100
Run the display ip routing-table vpn-instance NGN_Media 10.22.1.0 24
command on PE1, and you can find that the next hop of route 10.22.1.0/24 is PE3.
That is, PE1 chooses the route advertised by PE3.
[PE1] display ip routing-table vpn-instance NGN_Media 10.22.1.0 24
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 910
Routing Table: NGN_Media
Summary Count: 1
Destination/Mask Proto Pre Cost Flags NextHop Interface
10.22.1.0/24 IBGP 255 0 RD 10.9.9.9 Vlanif50
----End
Configuration Files
● P1 configuration file
#
sysname P1
#
vlan batch 10 20 30 40 50
#
mpls lsr-id 10.1.1.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0100.1009.00
#
interface Vlanif10
description toP3Vlanif10
ip address 10.1.1.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif20
description toP5Vlanif20
ip address 10.1.2.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif30
description toRRVlanif30
ip address 10.1.3.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif40
description toP2Vlanif40
ip address 10.1.4.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif50
description toP1Vlanif50
ip address 10.1.5.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet3/0/0
port link-type trunk
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 911
port trunk allow-pass vlan 30
#
interface GigabitEthernet4/0/0
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet5/0/0
port link-type trunk
port trunk allow-pass vlan 50
#
interface LoopBack0
ip address 10.1.1.9 255.255.255.255
isis enable 64
#
return
● P2 configuration file
#
sysname P2
#
vlan batch 40 60 70 80 90
#
mpls lsr-id 10.2.2.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0200.2009.00
#
interface Vlanif40
description toP1Vlanif40
ip address 10.1.4.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif60
description toRRVlanif60
ip address 10.1.8.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif70
description toP4Vlanif70
ip address 10.1.7.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif80
description toP6Vlanif80
ip address 10.1.6.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif90
description toPE2Vlanif90
ip address 10.1.9.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 40
#
interface GigabitEthernet2/0/0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 912
port link-type trunk
port trunk allow-pass vlan 60
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 70
#
interface GigabitEthernet4/0/0
port link-type trunk
port trunk allow-pass vlan 80
#
interface GigabitEthernet5/0/0
port link-type trunk
port trunk allow-pass vlan 90
#
interface LoopBack0
ip address 10.2.2.9 255.255.255.255
isis enable 64
#
return
● P3 configuration file
#
sysname P3
#
vlan batch 10 110 120 130
#
mpls lsr-id 10.3.3.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0300.3009.00
#
interface Vlanif10
description toP1Vlanif10
ip address 10.1.1.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif110
description toP5Vlanif110
ip address 10.1.10.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif120
description toP4Vlanif120
ip address 10.1.11.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif130
description toPE3Vlanif130
ip address 10.1.12.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 110
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 913
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 120
#
interface GigabitEthernet4/0/0
port link-type trunk
port trunk allow-pass vlan 130
#
interface LoopBack0
ip address 10.3.3.9 255.255.255.255
isis enable 64
#
return
● P4 configuration file
#
sysname P4
#
vlan batch 70 120 150 160
#
mpls lsr-id 10.4.4.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0400.4009.00
#
interface Vlanif70
description toP2Vlanif70
ip address 10.1.7.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif120
description toP3Vlanif120
ip address 10.1.11.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif150
description toP6Vlanif150
ip address 10.1.13.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif160
description toPE4Vlanif160
ip address 10.1.14.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 70
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 120
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 150
#
interface GigabitEthernet4/0/0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 914
port link-type trunk
port trunk allow-pass vlan 160
#
interface LoopBack0
ip address 10.4.4.9 255.255.255.255
isis enable 64
#
return
● P5 configuration file
#
sysname P5
#
vlan batch 20 110 170
#
mpls lsr-id 10.5.5.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0500.5009.00
#
interface Vlanif20
description toP1Vlanif20
ip address 10.1.2.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif110
description toP3Vlanif110
ip address 10.1.10.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif170
description toP6Vlanif170
ip address 10.1.15.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 110
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 170
#
interface LoopBack0
ip address 10.5.5.9 255.255.255.255
isis enable 64
#
return
● P6 configuration file
#
sysname P6
#
vlan batch 80 150 170
#
mpls lsr-id 10.6.6.9
mpls
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 915
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0600.6009.00
#
interface Vlanif80
description toP2Vlanif80
ip address 10.1.6.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif150
description toP4Vlanif150
ip address 10.1.13.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif170
description toP5Vlanif170
ip address 10.1.15.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 80
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 170
#
interface GigabitEthernet3/0/0
port link-type trunk
port trunk allow-pass vlan 150
#
interface LoopBack0
ip address 10.6.6.9 255.255.255.255
isis enable 64
#
return
● PE1 configuration file
#
sysname PE1
#
vlan batch 50 100
#
ip vpn-instance NGN_Media
ipv4-family
route-distinguisher 65000:10001012
apply-label per-instance
vpn-target 65000:100 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Other
ipv4-family
route-distinguisher 65000:30001012
apply-label per-instance
vpn-target 65000:300 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Signaling
ipv4-family
route-distinguisher 65000:20001012
apply-label per-instance
vpn-target 65000:200 export-extcommunity
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 916
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
mpls lsr-id 10.7.7.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0700.7009.00
#
interface Vlanif50
description toP1Vlanif50
ip address 10.1.5.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif100
description toPE2Vlanif100
ip address 10.1.16.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet3/0/0
#
interface GigabitEthernet3/0/0.10
dot1q termination vid 180
ip binding vpn-instance NGN_Media
ip address 10.21.1.73 255.255.255.252
#
interface GigabitEthernet3/0/0.11
dot1q termination vid 190
ip binding vpn-instance NGN_Signaling
ip address 10.21.1.77 255.255.255.252
#
interface GigabitEthernet3/0/0.12
dot1q termination vid 200
ip binding vpn-instance NGN_Other
ip address 10.21.1.81 255.255.255.252
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 50
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 100
#
interface LoopBack0
ip address 10.7.7.9 255.255.255.255
isis enable 64
#
bgp 65000
peer 10.11.11.9 as-number 65000
peer 10.11.11.9 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
undo peer 10.11.11.9 enable
#
ipv4-family vpnv4
policy vpn-target
peer 10.11.11.9 enable
peer 10.11.11.9 route-policy local_pre import
peer 10.11.11.9 route-policy comm export
peer 10.11.11.9 advertise-community
#
ipv4-family vpn-instance NGN_Media
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 917
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Other
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Signaling
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
route-policy comm permit node 10
apply community 65000:100
#
route-policy local_pre permit node 10
if-match community-filter 1
apply local-preference 200
#
ip community-filter 1 permit 65000:100
#
return
● PE2 configuration file
#
sysname PE2
#
vlan batch 90 100
#
ip vpn-instance NGN_Media
ipv4-family
route-distinguisher 65000:10001011
apply-label per-instance
vpn-target 65000:100 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Other
ipv4-family
route-distinguisher 65000:30001011
apply-label per-instance
vpn-target 65000:300 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Signaling
ipv4-family
route-distinguisher 65000:20001011
apply-label per-instance
vpn-target 65000:200 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
mpls lsr-id 10.8.8.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0800.8009.00
#
interface Vlanif90
description toP2Vlanif90
ip address 10.1.9.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif100
description toPE1Vlanif100
ip address 10.1.16.2 255.255.255.252
isis enable 64
mpls
mpls ldp
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 918
#
interface GigabitEthernet3/0/0
#
interface GigabitEthernet3/0/0.10
dot1q termination vid 210
ip binding vpn-instance NGN_Media
ip address 10.21.1.13 255.255.255.252
#
interface GigabitEthernet3/0/0.11
dot1q termination vid 220
ip binding vpn-instance NGN_Signaling
ip address 10.21.1.17 255.255.255.252
#
interface GigabitEthernet3/0/0.12
dot1q termination vid 230
ip binding vpn-instance NGN_Other
ip address 10.21.1.21 255.255.255.252
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 90
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 100
#
interface LoopBack0
ip address 10.8.8.9 255.255.255.255
isis enable 64
#
bgp 65000
peer 10.11.11.9 as-number 65000
peer 10.11.11.9 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
undo peer 10.11.11.9 enable
#
ipv4-family vpnv4
policy vpn-target
peer 10.11.11.9 enable
peer 10.11.11.9 route-policy local_pre import
peer 10.11.11.9 route-policy comm export
peer 10.11.11.9 advertise-community
#
ipv4-family vpn-instance NGN_Media
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Other
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Signaling
aggregate 10.21.1.0 255.255.255.0 detail-suppressed
import-route direct
#
route-policy comm permit node 10
apply community 65000:200
#
route-policy local_pre permit node 10
if-match community-filter 1
apply local-preference 200
#
ip community-filter 1 permit 65000:200
#
return
● PE3 configuration file
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 919
#
sysname PE3
#
vlan batch 130 140
#
ip vpn-instance NGN_Media
ipv4-family
route-distinguisher 65000:10000811
apply-label per-instance
vpn-target 65000:100 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Other
ipv4-family
route-distinguisher 65000:30000811
apply-label per-instance
vpn-target 65000:300 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Signaling
ipv4-family
route-distinguisher 65000:20000811
apply-label per-instance
vpn-target 65000:200 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
mpls lsr-id 10.9.9.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.0900.9009.00
#
interface Vlanif130
description toP3Vlanif130
ip address 10.1.12.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif140
description toPE4Vlanif140
ip address 10.1.17.1 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet3/0/0
#
interface GigabitEthernet3/0/0.10
dot1q termination vid 240
ip binding vpn-instance NGN_Media
ip address 10.22.1.73 255.255.255.252
#
interface GigabitEthernet3/0/0.11
dot1q termination vid 250
ip binding vpn-instance NGN_Signaling
ip address 10.22.1.77 255.255.255.252
#
interface GigabitEthernet3/0/0.12
dot1q termination vid 260
ip binding vpn-instance NGN_Other
ip address 10.22.1.81 255.255.255.252
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 130
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 920
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 140
#
interface LoopBack0
ip address 10.9.9.9 255.255.255.255
isis enable 64
#
bgp 65000
peer 10.11.11.9 as-number 65000
peer 10.11.11.9 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
undo peer 10.11.11.9 enable
#
ipv4-family vpnv4
policy vpn-target
peer 10.11.11.9 enable
peer 10.11.11.9 route-policy local_pre import
peer 10.11.11.9 route-policy comm export
peer 10.11.11.9 advertise-community
#
ipv4-family vpn-instance NGN_Media
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Other
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Signaling
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
route-policy comm permit node 10
apply community 65000:100
#
route-policy local_pre permit node 10
if-match community-filter 1
apply local-preference 200
#
route-policy local_pre permit node 20
#
ip community-filter 1 permit 65000:100
#
return
● PE4 configuration file
#
sysname PE4
#
vlan batch 140 160
#
ip vpn-instance NGN_Media
ipv4-family
route-distinguisher 65000:10000712
apply-label per-instance
vpn-target 65000:100 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Other
ipv4-family
route-distinguisher 65000:30000712
apply-label per-instance
vpn-target 65000:300 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
ip vpn-instance NGN_Signaling
ipv4-family
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 921
route-distinguisher 65000:20000712
apply-label per-instance
vpn-target 65000:200 export-extcommunity
vpn-target 65000:100 65000:200 65000:300 import-extcommunity
#
mpls lsr-id 10.10.10.9
mpls
#
mpls ldp
#
isis 64
network-entity 49.0091.0100.1001.0009.00
#
interface Vlanif140
description toPE3Vlanif140
ip address 10.1.17.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface Vlanif160
description toP4Vlanif160
ip address 10.1.14.2 255.255.255.252
isis enable 64
mpls
mpls ldp
#
interface GigabitEthernet3/0/0
#
interface GigabitEthernet3/0/0.10
dot1q termination vid 270
ip binding vpn-instance NGN_Media
ip address 10.22.1.13 255.255.255.252
#
interface GigabitEthernet3/0/0.11
dot1q termination vid 280
ip binding vpn-instance NGN_Signaling
ip address 10.22.1.17 255.255.255.252
#
interface GigabitEthernet3/0/0.12
dot1q termination vid 290
ip binding vpn-instance NGN_Other
ip address 10.22.1.21 255.255.255.252
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 160
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 140
#
interface LoopBack0
ip address 10.10.10.9 255.255.255.255
isis enable 64
#
bgp 65000
peer 10.11.11.9 as-number 65000
peer 10.11.11.9 connect-interface LoopBack0
#
ipv4-family unicast
undo synchronization
undo peer 10.11.11.9 enable
#
ipv4-family vpnv4
policy vpn-target
peer 10.11.11.9 enable
peer 10.11.11.9 route-policy local_pre import
peer 10.11.11.9 route-policy comm export
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 922
peer 10.11.11.9 advertise-community
#
ipv4-family vpn-instance NGN_Media
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Other
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
ipv4-family vpn-instance NGN_Signaling
aggregate 10.22.1.0 255.255.255.0 detail-suppressed
import-route direct
#
route-policy comm permit node 10
apply community 65000:200
#
route-policy local_pre permit node 10
if-match community-filter 1
apply local-preference 200
#
ip community-filter 1 permit 65000:200
#
return
● RR configuration file
#
sysname RR
#
vlan batch 30 60
#
isis 64
network-entity 49.0091.0100.1101.1009.00
#
interface Vlanif30
description toP1Vlanif30
ip address 10.1.3.2 255.255.255.252
isis enable 64
#
interface Vlanif60
description toP2Vlanif60
ip address 10.1.8.2 255.255.255.252
isis enable 64
#
interface GigabitEthernet1/0/0
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet2/0/0
port link-type trunk
port trunk allow-pass vlan 60
#
interface LoopBack0
ip address 10.11.11.9 255.255.255.255
isis enable 64
#
bgp 65000
group client internal
peer client connect-interface LoopBack0
peer 10.7.7.9 as-number 65000
peer 10.8.8.9 as-number 65000
peer 10.9.9.9 as-number 65000
peer 10.10.10.9 as-number 65000
#
ipv4-family unicast
undo synchronization
undo peer client enable
undo peer 10.7.7.9 enable
undo peer 10.8.8.9 enable
undo peer 10.9.9.9 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 923
undo peer 10.10.10.9 enable
#
ipv4-family vpnv4
undo policy vpn-target
peer client enable
peer client reflect-client
peer client advertise-community
peer 10.7.7.9 enable
peer 10.7.7.9 group client
peer 10.8.8.9 enable
peer 10.8.8.9 group client
peer 10.9.9.9 enable
peer 10.9.9.9 group client
peer 10.10.10.9 enable
peer 10.10.10.9 group client
#
return
9.17.13 Example for Configuring BFD for BGP
Networking Requirements
As shown in Figure 9-55, SwitchA belongs to AS 100, and SwitchB and SwitchC
belong to AS 200. EBGP connections are established between SwitchA and
SwitchB, and between SwitchA and SwitchC.
Service traffic is transmitted along the primary link SwitchA→SwitchB. The link
SwitchA→SwitchC→SwitchB functions as the backup link. Fast fault detection is
required to allow traffic to be fast switched from the primary link to the backup
link.
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-55 Networking diagram of configuring BFD for BGP
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 924
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic BGP functions on each switch.
2. Configure the MED attribute to control route selection.
3. Enable BFD on SwitchA and SwitchB.
NOTE
If two switches establish an EBGP peer relationship over a direct link, BFD for BGP does not
need to be configured. This is because the ebgp-interface-sensitive command is enabled
by default for directly-connected EBGP peers.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10 20
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface gigabitethernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] port link-type trunk
[SwitchA-GigabitEthernet0/0/2] port trunk allow-pass vlan 20
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Assign an IP address to each VLANIF interface.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
[SwitchA] interface vlanif 10
[SwitchA-Vlanif10] ip address 192.168.2.1 24
[SwitchA-Vlanif10] quit
[SwitchA] interface vlanif 20
[SwitchA-Vlanif20] ip address 192.168.1.1 24
[SwitchA-Vlanif20] quit
Step 3 Configure basic BGP functions. Establish EBGP peer relationships between SwitchA
and SwitchB, and between SwitchA and SwitchC and an IBGP peer relationship
between SwitchB and SwitchC.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 172.17.1.1
[SwitchA-bgp] peer 192.168.1.2 as-number 200
[SwitchA-bgp] peer 192.168.1.2 ebgp-max-hop
[SwitchA-bgp] peer 192.168.2.2 as-number 200
[SwitchA-bgp] peer 192.168.2.2 ebgp-max-hop
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] router-id 172.17.2.2
[SwitchB-bgp] peer 192.168.1.1 as-number 100
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 925
[SwitchB-bgp] peer 192.168.1.1 ebgp-max-hop
[SwitchB-bgp] peer 10.1.1.2 as-number 200
[SwitchB-bgp] network 172.16.1.0 255.255.255.0
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] router-id 172.17.3.3
[SwitchC-bgp] peer 192.168.2.1 as-number 100
[SwitchC-bgp] peer 192.168.2.1 ebgp-max-hop
[SwitchC-bgp] peer 10.1.1.1 as-number 200
[SwitchC-bgp] import-route direct
[SwitchC-bgp] quit
# Check the status of BGP peer relationships on SwitchA. The command output
shows that the BGP peer relationships are in the Established state.
[SwitchA] display bgp peer
BGP local router ID : 172.17.1.1
Local AS number : 100
Total number of peers : 2 Peers in established state : 2
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
192.168.1.2 4 200 2 5 0 00:01:25 Established 0
192.168.2.2 4 200 2 4 0 00:00:55 Established 0
Step 4 Set the MED.
Set the MED sent from SwitchB to SwitchC through the policy.
# Configure SwitchB.
[SwitchB] route-policy 10 permit node 10
[SwitchB-route-policy] apply cost 100
[SwitchB-route-policy] quit
[SwitchB] bgp 200
[SwitchB-bgp] peer 192.168.1.1 route-policy 10 export
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] route-policy 10 permit node 10
[SwitchC-route-policy] apply cost 150
[SwitchC-route-policy] quit
[SwitchC] bgp 200
[SwitchC-bgp] peer 192.168.2.1 route-policy 10 export
[SwitchC-bgp] quit
# View all BGP routing information on SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.17.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 5
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.2.2 150 0 200?
*> 172.16.1.0/24 192.168.1.2 100 0 200i
* 192.168.2.2 150 0 200i
*> 192.168.2.0 192.168.1.2 100 0 200?
192.168.2.2 150 0 200?
According to the BGP routing table, the next-hop address of the route destined for
172.16.1.0/24 is 192.168.1.2 and service flow is transmitted on the active link
SwitchA → SwitchB.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 926
Step 5 Configure BFD, and set the interval for transmitting BFD packets, the interval for
receiving BFD packets, and the local detection multiplier.
# Enable BFD on SwitchA. Set the minimum intervals for transmitting and
receiving BFD packets to 100 ms and the local detection multiplier to 4.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] bgp 100
[SwitchA-bgp] peer 192.168.1.2 bfd enable
[SwitchA-bgp] peer 192.168.1.2 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchA-bgp] quit
# Enable BFD on SwitchB. Set the minimum intervals for transmitting and
receiving BFD packets to 100 ms and the local detection multiplier to 4.
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] bgp 200
[SwitchB-bgp] peer 192.168.1.1 bfd enable
[SwitchB-bgp] peer 192.168.1.1 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchB-bgp] quit
# Display all BFD sessions on SwitchA.
[SwitchA] display bgp bfd session all
Local_Address Peer_Address LD/RD Interface
192.168.1.1 192.168.1.2 8201/8201 Vlanif20
Tx-interval(ms) Rx-interval(ms) Multiplier Session-State
100 100 4 Up
Wtr-interval(m)
0
Step 6 Verify the configuration.
# Run the shutdown command on VLANIF20 of SwitchB to simulate faults on the
active link.
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] shutdown
# Check the BGP routing table on SwitchA.
[SwitchA] display bgp routing-table
BGP Local router ID is 172.17.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 3
Network NextHop MED LocPrf PrefVal Path/Ogn
*> 10.1.1.0/24 192.168.2.2 150 0 200?
*> 172.16.1.0/24 192.168.2.2 150 0 200i
192.168.2.0 192.168.2.2 150 0 200?
According to the BGP routing table, the standby link SwitchA → SwitchC →
SwitchB takes effect after the active link fails. The next-hop address of the route
destined for 172.16.1.0/24 becomes 192.168.2.2.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 927
#
vlan batch 10 20
#
bfd
#
interface Vlanif10
ip address 192.168.2.1 255.255.255.0
#
interface Vlanif20
ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
bgp 100
router-id 172.17.1.1
peer 192.168.1.2 as-number 200
peer 192.168.1.2 ebgp-max-hop 255
peer 192.168.1.2 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
peer 192.168.1.2 bfd enable
peer 192.168.2.2 as-number 200
peer 192.168.2.2 ebgp-max-hop 255
#
ipv4-family unicast
undo synchronization
peer 192.168.1.2 enable
peer 192.168.2.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 20 30 40
#
bfd
#
interface Vlanif20
ip address 192.168.1.2 255.255.255.0
#
interface Vlanif30
ip address 10.1.1.1 255.255.255.0
#
interface Vlanif40
ip address 172.16.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/3
port link-type trunk
port trunk allow-pass vlan 40
#
bgp 200
router-id 172.17.2.2
peer 10.1.1.2 as-number 200
peer 192.168.1.1 as-number 100
peer 192.168.1.1 ebgp-max-hop 255
peer 192.168.1.1 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 928
peer 192.168.1.1 bfd enable
#
ipv4-family unicast
undo synchronization
network 172.16.1.0 255.255.255.0
peer 10.1.1.2 enable
peer 192.168.1.1 enable
peer 192.168.1.1 route-policy 10 export
#
route-policy 10 permit node 10
apply cost 100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 10 30
#
bfd
#
interface Vlanif10
ip address 192.168.2.2 255.255.255.0
#
interface Vlanif30
ip address 10.1.1.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
bgp 200
router-id 172.17.3.3
peer 10.1.1.1 as-number 200
peer 192.168.2.1 as-number 100
peer 192.168.2.1 ebgp-max-hop 255
#
ipv4-family unicast
undo synchronization
import-route direct
peer 10.1.1.1 enable
peer 192.168.2.1 enable
peer 192.168.2.1 route-policy 10 export
#
route-policy 10 permit node 10
apply cost 150
#
return
9.17.14 Example for Configuring BFD for BGP4+
Networking Requirements
In Figure 9-56, SwitchA belongs to AS 100, and SwitchB and SwitchC belong to AS
200. SwitchA establishes EBGP connections with both SwitchB and SwitchC.
Service traffic is forwarded along the primary link SwitchA→SwitchB. The link
SwitchA→SwitchC→SwitchB is used as a backup. Customers require that a fault on
the primary link be detected in milliseconds so that service traffic can be fast
switched to the backup link if the primary link fails.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 929
NOTE
In this scenario, ensure that all connected interfaces have STP disabled. If STP is enabled
and VLANIF interfaces of switches are used to construct a Layer 3 ring network, an
interface on the network will be blocked. As a result, Layer 3 services on the network
cannot run normally.
Figure 9-56 Networking diagram of configuring BFD for BGP4+
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure basic BGP4+ functions on all switches so that they can establish
BGP peer relationships with each other.
2. Configure MED-based route selection on SwitchA and SwitchB to forward
traffic on the primary link between SwitchA and SwitchB.
3. Enable BFD on SwitchA and SwitchB to detect faults in milliseconds so that
service traffic can be fast switched to the backup link if the primary link fails.
Procedure
Step 1 Enable the IPv6 forwarding capability and configure IPv6 addresses for interfaces.
# Configure SwitchA. The configurations of SwitchB and SwitchC are similar to the
configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] ipv6
[SwitchA] interface GigabitEthernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] undo portswitch
[SwitchA-GigabitEthernet0/0/1] ipv6 enable
[SwitchA-GigabitEthernet0/0/1] ipv6 address FC00:3::1 64
[SwitchA-GigabitEthernet0/0/1] quit
[SwitchA] interface GigabitEthernet 0/0/2
[SwitchA-GigabitEthernet0/0/2] undo portswitch
[SwitchA-GigabitEthernet0/0/2] ipv6 enable
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 930
[SwitchA-GigabitEthernet0/0/2] ipv6 address FC00:1::1 64
[SwitchA-GigabitEthernet0/0/2] quit
Step 2 Configure basic BGP4+ functions, establish EBGP connections between SwitchA
and SwitchB and between SwitchA and SwitchC, and establish an IBGP connection
between SwitchB and SwitchC.
# Configure SwitchA.
[SwitchA] bgp 100
[SwitchA-bgp] router-id 10.1.1.1
[SwitchA-bgp] peer FC00:3::2 as-number 200
[SwitchA-bgp] peer FC00:1::2 as-number 200
[SwitchA-bgp] ipv6-family unicast
[SwitchA-bgp-af-ipv6] peer FC00:3::2 enable
[SwitchA-bgp-af-ipv6] peer FC00:1::2 enable
[SwitchA-bgp-af-ipv6] quit
[SwitchA-bgp] quit
# Configure SwitchB.
[SwitchB] bgp 200
[SwitchB-bgp] router-id 10.2.2.2
[SwitchB-bgp] peer FC00:3::1 as-number 100
[SwitchB-bgp] peer FC00:2::1 as-number 200
[SwitchB-bgp] ipv6-family unicast
[SwitchB-bgp-af-ipv6] peer FC00:3::1 enable
[SwitchB-bgp-af-ipv6] peer FC00:2::1 enable
[SwitchB-bgp-af-ipv6] network FC00:4:: 64
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] bgp 200
[SwitchC-bgp] router-id 10.3.3.3
[SwitchC-bgp] peer FC00:1::1 as-number 100
[SwitchC-bgp] peer FC00:2::2 as-number 200
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer FC00:1::1 enable
[SwitchC-bgp-af-ipv6] peer FC00:2::2 enable
[SwitchC-bgp-af-ipv6] quit
[SwitchC-bgp] quit
# Run the display bgp ipv6 peer command on SwitchA. The command output
shows that BGP peer relationships have been established.
[SwitchA] display bgp ipv6 peer
BGP local router ID : 10.1.1.1
Local AS number : 100
Total number of peers : 2 Peers in established state : 2
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
FC00:1::2 4 200 2 4 0 00:00:27 Established 0
FC00:3::2 4 200 2 3 0 00:00:27 Established 0
Step 3 Configure the MED attribute.
Set the MED values of routes sent from SwitchB and SwitchC to SwitchA through
routing policies.
# Configure SwitchB.
[SwitchB] route-policy 10 permit node 10
[SwitchB-route-policy] apply cost 100
[SwitchB-route-policy] quit
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 931
[SwitchB] bgp 200
[SwitchB-bgp] ipv6-family unicast
[SwitchB-bgp-af-ipv6] peer FC00:3::1 route-policy 10 export
[SwitchB-bgp-af-ipv6] quit
[SwitchB-bgp] quit
# Configure SwitchC.
[SwitchC] route-policy 10 permit node 10
[SwitchC-route-policy] apply cost 150
[SwitchC-route-policy] quit
[SwitchC] bgp 200
[SwitchC-bgp] ipv6-family unicast
[SwitchC-bgp-af-ipv6] peer FC00:1::1 route-policy 10 export
[SwitchC-bgp-af-ipv6] quit
[SwitchC-bgp] quit
# Check the BGP routing table on SwitchA.
[SwitchA] display bgp ipv6 routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 2
*> Network : FC00:4:: PrefixLen : 64
NextHop : FC00:3::2 LocPrf :
MED : 100 PrefVal : 0
Label :
Path/Ogn : 200 i
*
NextHop : FC00:1::2 LocPrf :
MED : 150 PrefVal : 0
Label :
Path/Ogn : 200 i
In the BGP routing table, you can view that the next-hop address of the route to
FC00:4::1/64 is FC00:3::2, and traffic is transmitted on the primary link
SwitchA→SwitchB.
Step 4 Configure BFD, and set the intervals at which BFD packets are sent and received
and the local detection multiplier.
# Configure BFD on SwitchA, and set the minimum intervals for sending and
receiving BFD packets to both 100 ms and the local detection multiplier to 4.
[SwitchA] bfd
[SwitchA-bfd] quit
[SwitchA] bgp 100
[SwitchA-bgp] peer FC00:3::2 bfd enable
[SwitchA-bgp] peer FC00:3::2 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchA-bgp] quit
# Configure BFD on SwitchB, and set the minimum intervals for sending and
receiving BFD packets to both 100 ms and the local detection multiplier to 4.
[SwitchB] bfd
[SwitchB-bfd] quit
[SwitchB] bgp 200
[SwitchB-bgp] peer FC00:3::1 bfd enable
[SwitchB-bgp] peer FC00:3::1 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
[SwitchB-bgp] quit
# Check all BFD sessions on SwitchA.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 932
[SwitchA] display bgp ipv6 bfd session all
Local_Address : FC00:3::1
Peer_Address : FC00:3::2
Tx-interval(ms): 100 Rx-interval(ms): 100
Multiplier : 4 Interface : GigabitEthernet0/0/1
LD/RD : 8199/8200 Session-State : Up
Wtr-interval(m): 0
Step 5 Verify the configuration.
# Run the shutdown command on GE0/0/1 of SwitchB to simulate a primary link
fault.
[SwitchB] interface GigabitEthernet 0/0/1
[SwitchB-GigabitEthernet0/0/1] shutdown
# Check the BGP routing table on SwitchA.
[SwitchA] display bgp ipv6 routing-table
BGP Local router ID is 10.1.1.1
Status codes: * - valid, > - best, d - damped,
h - history, i - internal, s - suppressed, S - Stale
Origin : i - IGP, e - EGP, ? - incomplete
Total Number of Routes: 1
*> Network : FC00:4:: PrefixLen : 64
NextHop : FC00:1::2 LocPrf :
MED : 150 PrefVal : 0
Label :
Path/Ogn : 200 i
In the BGP routing table, you can view that the backup link
SwitchA→SwitchC→SwitchB transmits traffic after the primary link
SwitchA→SwitchB fails, and the next-hop address of the route to FC00:4::1/64
becomes FC00:1::2.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
#
ipv6
#
bfd
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:3::1/64
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:1::1/64
#
bgp 100
router-id 10.1.1.1
peer FC00:1::2 as-number 200
peer FC00:3::2 as-number 200
peer FC00:3::2 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
peer FC00:3::2 bfd enable
#
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 933
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
peer FC00:1::2 enable
peer FC00:3::2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
ipv6
#
bfd
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:3::2/64
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:2::2/64
#
interface GigabitEthernet0/0/3
undo portswitch
ipv6 enable
ipv6 address FC00:4::1/64
#
bgp 200
router-id 10.2.2.2
peer FC00:2::1 as-number 200
peer FC00:3::1 as-number 100
peer FC00:3::1 bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 4
peer FC00:3::1 bfd enable
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
network FC00:4:: 64
peer FC00:2::1 enable
peer FC00:3::1 enable
peer FC00:3::1 route-policy 10 export
#
route-policy 10 permit node 10
apply cost 100
#
return
● SwitchC configuration file
#
sysname SwitchC
#
ipv6
#
interface GigabitEthernet0/0/1
undo portswitch
ipv6 enable
ipv6 address FC00:2::1/64
#
interface GigabitEthernet0/0/2
undo portswitch
ipv6 enable
ipv6 address FC00:1::2/64
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 934
#
bgp 200
router-id 10.3.3.3
peer FC00:1::1 as-number 100
peer FC00:2::2 as-number 200
#
ipv4-family unicast
undo synchronization
#
ipv6-family unicast
undo synchronization
peer FC00:1::1 enable
peer FC00:1::1 route-policy 10 export
peer FC00:2::2 enable
#
route-policy 10 permit node 10
apply cost 150
#
return
9.17.15 Example for Configuring BGP GTSM
Networking Requirements
As shown in Figure 9-57, SwitchA belongs to AS 10, and SwitchB, SwitchC, and
SwitchD belong to AS 20. BGP runs on the network. To protect a device against
the attacks of forged BGP packets, you can configure GTSM to check whether the
TTL value in the IP packet header is within the specified range.
Figure 9-57 Networking diagram of configuring BGP GTSM
Configuration Roadmap
The configuration roadmap is as follows:
1. Configure OSPF on SwitchB, SwitchC, and SwitchD to implement interworking
in AS 20.
2. Set up an EBGP connection between SwitchA and SwitchB, and set up IBGP
connections between SwitchB, SwitchC, and SwitchD through loopback
interfaces to implement interworking between ASs.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 935
3. Configure GTSM on SwitchA, SwitchB, SwitchC, and SwitchD so that it can
protect SwitchB against CPU-utilization attacks.
Procedure
Step 1 Configure the VLAN to which each interface belongs.
# Configure SwitchA. The configurations of SwitchB, SwitchC, and SwitchD are
similar to the configuration of SwitchA.
<HUAWEI> system-view
[HUAWEI] sysname SwitchA
[SwitchA] vlan batch 10
[SwitchA] interface gigabitethernet 0/0/1
[SwitchA-GigabitEthernet0/0/1] port link-type trunk
[SwitchA-GigabitEthernet0/0/1] port trunk allow-pass vlan 10
[SwitchA-GigabitEthernet0/0/1] quit
Step 2 Assign an IP address to each interface.
# Configure SwitchB. The configurations of SwitchA, SwitchC, and SwitchD are
similar to the configuration of SwitchB.
[SwitchB] interface vlanif 10
[SwitchB-Vlanif10] ip address 10.1.1.2 24
[SwitchB-Vlanif10] quit
[SwitchB] interface vlanif 20
[SwitchB-Vlanif20] ip address 10.2.1.2 24
[SwitchB-Vlanif20] quit
[SwitchB] interface loopback 0
[SwitchB-LoopBack0] ip address 172.16.2.9 32
[SwitchB-LoopBack0] quit
Step 3 Configure OSPF.
# Configure SwitchB. The configurations of SwitchC and SwitchD are similar to the
configuration of SwitchB.
[SwitchB] ospf
[SwitchB-ospf-1] area 0.0.0.0
[SwitchB-ospf-1-area-0.0.0.0] network 10.2.1.0 0.0.0.255
[SwitchB-ospf-1-area-0.0.0.0] network 172.16.2.9 0.0.0.0
[SwitchB-ospf-1-area-0.0.0.0] quit
[SwitchB-ospf-1] quit
Step 4 Configure an IBGP connection.
# Configure SwitchB.
[SwitchB] bgp 20
[SwitchB-bgp] router-id 172.16.2.9
[SwitchB-bgp] peer 172.16.3.9 as-number 20
[SwitchB-bgp] peer 172.16.3.9 connect-interface LoopBack0
[SwitchB-bgp] peer 172.16.3.9 next-hop-local
[SwitchB-bgp] peer 172.16.4.9 as-number 20
[SwitchB-bgp] peer 172.16.4.9 connect-interface LoopBack0
[SwitchB-bgp] peer 172.16.4.9 next-hop-local
# Configure SwitchC.
[SwitchC] bgp 20
[SwitchC-bgp] router-id 172.16.3.9
[SwitchC-bgp] peer 172.16.2.9 as-number 20
[SwitchC-bgp] peer 172.16.2.9 connect-interface LoopBack0
[SwitchC-bgp] peer 172.16.4.9 as-number 20
[SwitchC-bgp] peer 172.16.4.9 connect-interface LoopBack0
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 936
# Configure SwitchD.
[SwitchD] bgp 20
[SwitchD-bgp] router-id 172.16.4.9
[SwitchD-bgp] peer 172.16.2.9 as-number 20
[SwitchD-bgp] peer 172.16.2.9 connect-interface LoopBack0
[SwitchD-bgp] peer 172.16.3.9 as-number 20
[SwitchD-bgp] peer 172.16.3.9 connect-interface LoopBack0
Step 5 Configure an EBGP connection.
# Configure SwitchA.
[SwitchA] bgp 10
[SwitchA-bgp] router-id 172.16.1.9
[SwitchA-bgp] peer 10.1.1.2 as-number 20
# Configure SwitchB.
[SwitchB-bgp] peer 10.1.1.1 as-number 10
[SwitchB-bgp] quit
# Display the connection status of the BGP peers.
[SwitchB] display bgp peer
BGP local router ID : 172.16.2.9
Local AS number : 20
Total number of peers : 3 Peers in established state : 3
Peer V AS MsgRcvd MsgSent OutQ Up/Down State PrefRcv
172.16.3.9 4 20 8 7 0 00:05:06 Established 0
172.16.4.9 4 20 8 10 0 00:05:33 Established 0
10.1.1.1 4 10 7 7 0 00:04:09 Established 0
You can view that SwitchB has set up BGP connections with other routers.
Step 6 Configure GTSM on SwitchA and SwitchB. SwitchA and SwitchB are directly
connected, so the range of the TTL value between the two switches is [255, 255].
The value of valid-ttl-hops is 1.
# Configure GTSM on SwitchA.
[SwitchA-bgp] peer 10.1.1.2 valid-ttl-hops 1
# Configure GTSM of the EBGP connection on SwitchB.
[SwitchB-bgp] peer 10.1.1.1 valid-ttl-hops 1
# Check the GTSM configuration.
[SwitchB] display bgp peer 10.1.1.1 verbose
BGP Peer is 10.1.1.1, remote AS 10
Type: EBGP link
BGP version 4, Remote router ID 172.16.1.9
Update-group ID : 0
BGP current state: Established, Up for 00h49m35s
BGP current event: RecvKeepalive
BGP last state: OpenConfirm
BGP Peer Up count: 1
Received total routes: 0
Received active routes total: 0
Received mac routes: 0
Advertised total routes: 0
Port: Local - 179 Remote - 52876
Configured: Connect-retry Time: 32 sec
Configured: Min Hold Time: 0 sec
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 937
Configured: Active Hold Time: 180 sec Keepalive Time:60 sec
Received : Active Hold Time: 180 sec
Negotiated: Active Hold Time: 180 sec Keepalive Time:60 sec
Peer optional capabilities:
Peer supports bgp multi-protocol extension
Peer supports bgp route refresh capability
Peer supports bgp 4-byte-as capability
Address family IPv4 Unicast: advertised and received
Received: Total 59 messages
Update messages 0
Open messages 2
KeepAlive messages 57
Notification messages 0
Refresh messages 0
Sent: Total 79 messages
Update messages 5
Open messages 2
KeepAlive messages 71
Notification messages 1
Refresh messages 0
Authentication type configured: None
Last keepalive received: 2012/03/06 19:17:37 Last keepalive sent : 2012/03/06 19:17:37 Last update
received: 2012/03/06 19:17:43 Last update sent : 2012/03/06 19:17:37
Minimum route advertisement interval is 30 seconds
Optional capabilities:
Route refresh capability has been enabled
4-byte-as capability has been enabled
GTSM has been enabled, valid-ttl-hops: 1
Peer Preferred Value: 0
Routing policy configured:
No routing policy is configured
You can view that GTSM is enabled, the valid hop count is 1, and the BGP
connection is in the Established state.
Step 7 Configure GTSM on SwitchB and SwitchC. SwitchB and SwitchC are directly
connected, so the range of the TTL value between the two switches is [255, 255].
The value of valid-ttl-hops is 1.
# Configure GTSM on SwitchB.
[SwitchB-bgp] peer 172.16.3.9 valid-ttl-hops 1
# Configure GTSM of the IBGP connection on SwitchC.
[SwitchC-bgp] peer 172.16.2.9 valid-ttl-hops 1
# View the GTSM configuration.
[SwitchB] display bgp peer 172.16.3.9 verbose
BGP Peer is 172.16.3.9, remote AS 20
Type: IBGP link
BGP version 4, Remote router ID 172.16.3.9
Update-group ID : 1
BGP current state: Established, Up for 00h54m36s
BGP current event: KATimerExpired
BGP last state: OpenConfirm
BGP Peer Up count: 2
Received total routes: 0
Received active routes total: 0
Received mac routes: 0
Advertised total routes: 0
Port: Local - 54998 Remote - 179
Configured: Connect-retry Time: 32 sec
Configured: Min Hold Time: 0 sec
Configured: Active Hold Time: 180 sec Keepalive Time:60 sec
Received : Active Hold Time: 180 sec
Negotiated: Active Hold Time: 180 sec Keepalive Time:60 sec
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 938
Peer optional capabilities:
Peer supports bgp multi-protocol extension
Peer supports bgp route refresh capability
Peer supports bgp 4-byte-as capability
Address family IPv4 Unicast: advertised and received
Received: Total 63 messages
Update messages 0
Open messages 1
KeepAlive messages 62
Notification messages 0
Refresh messages 0
Sent: Total 69 messages
Update messages 10
Open messages 1
KeepAlive messages 58
Notification messages 0
Refresh messages 0
Authentication type configured: None
Last keepalive received: 2012/03/06 19:18:37 Last keepalive sent : 2012/03/06 19:18:37 Last update
received: 2012/03/06 19:18:43 Last update sent : 2012/03/06 19:18:37
Minimum route advertisement interval is 15 seconds
Optional capabilities:
Route refresh capability has been enabled
4-byte-as capability has been enabled
Nexthop self has been configured
Connect-interface has been configured
GTSM has been enabled, valid-ttl-hops: 1
Peer Preferred Value: 0
Routing policy configured:
No routing policy is configured
You can view that GTSM is enabled, the valid hop count is 1, and the BGP
connection is in the Established state.
Step 8 Configure GTSM on SwitchC and SwitchD. SwitchC and SwitchD are directly
connected, so the range of the TTL value between the two switches is [255, 255].
The value of valid-ttl-hops is 1.
# Configure GTSM of the IBGP connection on SwitchC.
[SwitchC-bgp] peer 172.16.4.9 valid-ttl-hops 1
# Configure GTSM of the IBGP connection on SwitchD.
[SwitchD-bgp] peer 172.16.3.9 valid-ttl-hops 1
# Check the GTSM configuration.
[SwitchC] display bgp peer 172.16.4.9 verbose
BGP Peer is 172.16.4.9, remote AS 20
Type: IBGP link
BGP version 4, Remote router ID 172.16.4.9
Update-group ID : 1
BGP current state: Established, Up for 00h56m06s
BGP current event: KATimerExpired
BGP last state: OpenConfirm
BGP Peer Up count: 2
Received total routes: 0
Received active routes total: 0
Received mac routes: 0
Advertised total routes: 0
Port: Local - 179 Remote - 53758
Configured: Connect-retry Time: 32 sec
Configured: Min Hold Time: 0 sec
Configured: Active Hold Time: 180 sec Keepalive Time:60 sec
Received : Active Hold Time: 180 sec
Negotiated: Active Hold Time: 180 sec Keepalive Time:60 sec
Peer optional capabilities:
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 939
Peer supports bgp multi-protocol extension
Peer supports bgp route refresh capability
Peer supports bgp 4-byte-as capability
Address family IPv4 Unicast: advertised and received
Received: Total 63 messages
Update messages 0
Open messages 1
KeepAlive messages 62
Notification messages 0
Refresh messages 0
Sent: Total 63 messages
Update messages 0
Open messages 2
KeepAlive messages 61
Notification messages 0
Refresh messages 0
Authentication type configured: None
Last keepalive received: 2012/03/06 19:19:37 Last keepalive sent : 2012/03/06 19:19:37 Last update
received: 2012/03/06 19:19:43 Last update sent : 2012/03/06 19:19:37
Minimum route advertisement interval is 15 seconds
Optional capabilities:
Route refresh capability has been enabled
4-byte-as capability has been enabled
Connect-interface has been configured
GTSM has been enabled, valid-ttl-hops: 1
Peer Preferred Value: 0
Routing policy configured:
No routing policy is configured
You can view that GTSM is enabled, the valid hop count is 1, and the BGP
connection is in the Established state.
Step 9 Configure GTSM on SwitchB and SwitchD. SwitchB and SwitchD are connected by
SwitchC, so the range of the TTL value between the two switches is [254, 255].
The value of valid-ttl-hops is 2.
# Configure GTSM of the IBGP connection on SwitchB.
[SwitchB-bgp] peer 172.16.4.9 valid-ttl-hops 2
# Configure GTSM on SwitchD.
[SwitchD-bgp] peer 172.16.2.9 valid-ttl-hops 2
# Check the GTSM configuration.
[SwitchB] display bgp peer 172.16.4.9 verbose
BGP Peer is 172.16.4.9, remote AS 20
Type: IBGP link
BGP version 4, Remote router ID 172.16.4.9
Update-group ID : 1
BGP current state: Established, Up for 00h57m48s
BGP current event: RecvKeepalive
BGP last state: OpenConfirm
BGP Peer Up count: 2
Received total routes: 0
Received active routes total: 0
Received mac routes: 0
Advertised total routes: 0
Port: Local - 53714 Remote - 179
Configured: Connect-retry Time: 32 sec
Configured: Min Hold Time: 0 sec
Configured: Active Hold Time: 180 sec Keepalive Time:60 sec
Received : Active Hold Time: 180 sec
Negotiated: Active Hold Time: 180 sec Keepalive Time:60 sec
Peer optional capabilities:
Peer supports bgp multi-protocol extension
Peer supports bgp route refresh capability
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 940
Peer supports bgp 4-byte-as capability
Address family IPv4 Unicast: advertised and received
Received: Total 72 messages
Update messages 0
Open messages 1
KeepAlive messages 71
Notification messages 0
Refresh messages 0
Sent: Total 82 messages
Update messages 10
Open messages 1
KeepAlive messages 71
Notification messages 0
Refresh messages 0
Authentication type configured: None
Last keepalive received: 2012/03/06 19:20:37 Last keepalive sent : 2012/03/06 19:20:37 Last update
received: 2012/03/06 19:20:43 Last update sent : 2012/03/06 19:20:37
Minimum route advertisement interval is 15 seconds
Optional capabilities:
Route refresh capability has been enabled
4-byte-as capability has been enabled
Nexthop self has been configured
Connect-interface has been configured
GTSM has been enabled, valid-ttl-hops: 2
Peer Preferred Value: 0
Routing policy configured:
No routing policy is configured
You can view that GTSM is configured, the valid hop count is 2, and the BGP
connection is in the Established state.
NOTE
● In this example, if the value of valid-ttl-hops of either SwitchB or SwitchD is smaller
than 2, the IBGP connection cannot be set up.
● GTSM must be configured on the two ends of the BGP connection.
Step 10 Verify the configuration.
# Run the display gtsm statistics all command on SwitchB to check the GTSM
statistics of SwitchB. By default, SwitchB does not discard any packet when all
packets match the GTSM policy.
[SwitchB] display gtsm statistics all
GTSM Statistics Table
----------------------------------------------------------------
SlotId Protocol Total Counters Drop Counters Pass Counters
----------------------------------------------------------------
0 BGP 17 0 17
0 BGPv6 0 0 0
0 OSPF 0 0 0
0 LDP 0 0 0
0 OSPFv3 0 0 0 0 RIP 0 0 0
----------------------------------------------------------------
If the host simulates the BGP packets of SwitchA to attack SwitchB, the packets
are discarded because their TTL value is not 255 when reaching SwitchB. In the
GTSM statistics of SwitchB, the number of dropped packets increases accordingly.
----End
Configuration Files
● SwitchA configuration file
#
sysname SwitchA
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 941
#
vlan batch 10
#
interface Vlanif10
ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
bgp 10
router-id 172.16.1.9
peer 10.1.1.2 as-number 20
peer 10.1.1.2 valid-ttl-hops 1
#
ipv4-family unicast
undo synchronization
peer 10.1.1.2 enable
#
return
● SwitchB configuration file
#
sysname SwitchB
#
vlan batch 10 20
#
interface Vlanif10
ip address 10.1.1.2 255.255.255.0
#
interface Vlanif20
ip address 10.2.1.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 10
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 20
#
interface LoopBack0
ip address 172.16.2.9 255.255.255.255
#
bgp 20
router-id 172.16.2.9
peer 172.16.3.9 as-number 20
peer 172.16.3.9 connect-interface LoopBack0
peer 172.16.3.9 valid-ttl-hops 1
peer 172.16.4.9 as-number 20
peer 172.16.4.9 connect-interface LoopBack0
peer 172.16.4.9 valid-ttl-hops 2
peer 10.1.1.1 as-number 10
peer 10.1.1.1 valid-ttl-hops 1
#
ipv4-family unicast
undo synchronization
import-route ospf 1
peer 172.16.3.9 enable
peer 172.16.3.9 next-hop-local
peer 172.16.4.9 enable
peer 172.16.4.9 next-hop-local
peer 10.1.1.1 enable
#
ospf 1
area 0.0.0.0
network 172.16.2.9 0.0.0.0
network 10.2.1.0 0.0.0.255
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 942
● SwitchC configuration file
#
sysname SwitchC
#
vlan batch 20 30
#
interface Vlanif20
ip address 10.2.1.2 255.255.255.0
#
interface Vlanif30
ip address 10.2.2.1 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 20
#
interface GigabitEthernet0/0/2
port link-type trunk
port trunk allow-pass vlan 30
#
interface LoopBack0
ip address 172.16.3.9 255.255.255.255
#
bgp 20
router-id 172.16.3.9
peer 172.16.2.9 as-number 20
peer 172.16.2.9 connect-interface LoopBack0
peer 172.16.2.9 valid-ttl-hops 1
peer 172.16.4.9 as-number 20
peer 172.16.4.9 connect-interface LoopBack0
peer 172.16.4.9 valid-ttl-hops 1
#
ipv4-family unicast
undo synchronization
peer 172.16.2.9 enable
peer 172.16.4.9 enable
#
ospf 1
area 0.0.0.0
network 172.16.3.9 0.0.0.0
network 10.2.1.0 0.0.0.255
network 10.2.2.0 0.0.0.255
#
return
● SwitchD configuration file
#
sysname SwitchD
#
vlan batch 30
#
interface Vlanif30
ip address 10.2.2.2 255.255.255.0
#
interface GigabitEthernet0/0/1
port link-type trunk
port trunk allow-pass vlan 30
#
interface LoopBack0
ip address 172.16.4.9 255.255.255.255
#
bgp 20
router-id 172.16.4.9
peer 172.16.2.9 as-number 20
peer 172.16.2.9 connect-interface LoopBack0
peer 172.16.2.9 valid-ttl-hops 2
peer 172.16.3.9 as-number 20
peer 172.16.3.9 connect-interface LoopBack0
peer 172.16.3.9 valid-ttl-hops 1
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 943
#
ipv4-family unicast
undo synchronization
peer 172.16.2.9 enable
peer 172.16.3.9 enable
#
ospf 1
area 0.0.0.0
network 172.16.4.9 0.0.0.0
network 10.2.2.0 0.0.0.255
#
return
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 9 BGP Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 944
10 Routing Policy Configuration
10.1 Overview of Routing Policies
10.2 Understanding Routing Policies
10.3 Summary of Routing Policy Configuration Tasks
10.4 Licensing Requirements and Limitations for Routing Policies
10.5 Configuring Filters
10.6 Configuring a Routing Policy
10.7 Configuring Filter-Policy
10.8 Controlling the Valid Time of Routing Policies
10.9 Maintaining Routing Policies
10.10 Configuration Examples for Routing Policies
10.1 Overview of Routing Policies
Definition
Routing policy is a policy that controls routes using a series of tools or methods.
This type of policy will affect route generation, advertisement, and selection and
so affect the packet forwarding path. These tools include ACL, route-policy, ip-
prefix, and filter-policy, and these methods include filtering routes and setting
attributes for routes.
Purpose
On an IP network, routing policy is mainly used to filter routing information and
modify route attributes. Table 10-1 describes its functions.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 945
Table 10-1 Functions of routing policy
Function Execution Process Result
Filter routing
information.
If a route meets a specific
condition, it is accepted.
If a route meets a specific
condition, it is advertised.
If a route meets a specific
condition, it is imported.
This route is processed as
required.
Modify route
attributes.
If a route meets a specific
condition, a certain attribute
value of this route is
changed to a specified value.
A certain attribute value of
this route is changed to a
specified value.
Using routing policy to filter routing information
Figure 10-1 Using routing policy to filter routing information
In Figure 10-1, SwitchA is dual-homed to SwitchB and SwitchC and will receive
routes from both SwitchB and SwitchC. If SwitchA wants to receive routes only
from SwitchB but not from SwitchC, configure routing policy on SwitchA to permit
the routes received from SwitchB and deny the routes received from SwitchC.
Using routing policy to modify route attributes
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 946
Figure 10-2 Using routing policy to modify route attributes
In Figure 10-2, SwitchA is also dual-homed to SwitchB and SwitchC. Because
SwitchB has better link stability and higher bandwidth than SwitchC, links of
SwitchB and SwitchC need to function as the primary and backup links
respectively. When the primary link fails, traffic is automatically switched to the
backup link. To meet this requirement, you can use routing policy to set a lower
route cost on SwitchB and set a higher route cost on SwitchC. Subsequently, traffic
is automatically transmitted over the primary link of SwitchB, and the link of
SwitchC functions as the backup link for route backup.
Benefits
Routing policies offer the following benefits:
● Improves network security by controlling route receiving, advertising and
importing.
● Improves network performance by modifying route attributes for proper
traffic planning.
Relevant Information
Technology Forum
Huawei S Series Switches Routing Policy
10.2 Understanding Routing Policies
10.2.1 Routing Policy Fundamentals
Filters
A filter is the core of a routing policy and is used to define a set of matching rules.
The switch provides the filters listed in Table 10-2.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 947
Table 10-2 Comparisons between filters
Filter Applicabl
e Scope
Matching Rules
Access control list
(ACL)
Dynamic
routing
protocols
Inbound interface, source or destination IP
address, protocol type, and source or
destination port number
IP prefix list Dynamic
routing
protocols
Source and destination IP addresses and
next hop address
AS_Path filter BGP AS_Path attribute
Community filter BGP Community attribute
Extcommunity filter VPN Extended community attribute
Route distinguisher
(RD) filter
VPN RD attribute
Route-policy Dynamic
routing
protocols
Destination IP address, next-hop address,
cost, interface information, route type, ACL,
IP prefix list, AS_Path filter, community
filter, extcommunity filter, and RD filter
The ACL, IP prefix list, AS_Path filter, community filter, extcommunity filter, and RD
filter can be used only to filter routes but not modify attributes of filtered routes.
A route-policy is a comprehensive filter, and it can use the matching rules of the
ACL, IP prefix list, AS_Path filter, community filter, extcommunity filter, and RD
filter to filter routes. In addition, attributes of filtered routes can be modified using
the route-policy. The following describes these filters.
ACL
An ACL is a set of sequential filtering rules. Users can define rules based on packet
information, such as inbound interfaces, source or destination IP addresses,
protocol types, and source or destination port numbers, and specify an action to
deny or permit packets. After an ACL is configured, the system classifies received
packets based on the rules defined in the ACL and denies or permits the packets
accordingly.
An ACL only classifies packets based on defined rules and can be used to filter
packets only when it is applied to a routing policy.
ACLs can be configured for both IPv4 packets and IPv6 packets. Users can specify
the IP address and subnet address range in an ACL to match the source IP address,
destination network segment address, or next-hop address of a route.
IP Prefix List
An IP prefix list contains a group of route filtering rules. Users can specify the
prefix and mask length range to match the destination network segment address
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 948
or next-hop address of a route. An IP prefix list is used to filter routes that are
advertised and received by dynamic routing protocols.
An IP prefix list is easier to configure and more flexible than an ACL. However, if a
large number of routes with different prefixes need to be filtered, it is complex to
configure an IP prefix list to filter these routes.
IP prefix lists can be configured for both IPv4 routes and IPv6 routes, and these IP
prefix lists share the same implementation process. An IP prefix list filters routes
based on the mask length or mask length range.
● Mask length: An IP prefix list filters routes based on IP address prefixes. An IP
address prefix is defined by an IP address and a mask length. For example, for
the route to 10.1.1.1/16, the mask length is 16 bits, and the valid prefix is 16
bits (10.1.0.0).
● Mask length range: If routes have the same IP address prefix but different
masks, the prefix mask length range can be specified for exact match or for
matching routes within the specified mask length range.
NOTE
0.0.0.0 is a wildcard address. If the IP prefix is 0.0.0.0, either a mask or a mask length range
can be specified following the prefix:
● If a mask is specified, all routes with this mask are permitted or denied.
● If a mask length range is specified, all routes with the mask length in this range are
permitted or denied.
AS_Path Filter
An AS_Path filter is used to filter BGP routes based on AS_Path attributes
contained in BGP routes. The AS_Path attribute records numbers of all ASs that a
BGP route passes through from the local end to the destination in the distance-
vector (DV) order. Therefore, filtering rules defined based on AS_Path attributes
can be used to filter BGP routes. The matching condition of an AS_Path filter is
specified using a regular expression. For example, ^30 indicates that only the
AS_Path attribute starting with 30 is matched.
For details about AS_Path filter principles and applications, see 10.2.5 AS_Path
Filter Applications in BGP.
Community Filter
A community filter is used to filter BGP routes based on Community attributes
contained in BGP routes. The Community attribute is a set of destination
addresses with the same characteristics. Therefore, filtering rules defined based on
Community attributes can be used to filter BGP routes.
In addition to well-known Community attributes, users can define community
attributes using digits. The matching condition of a community filter can be
specified using a community ID or regular expression.
For details about community filter principles and applications, see 10.2.6
Community Attribute Applications in BGP.
S300, S500, S2700, S5700 and S6700 Series Ethernet
Switches
Configuration Guide - IP Unicast Routing 10 Routing Policy Configuration
Issue 01 (2024-09-30) Copyright © Huawei Technologies Co., Ltd. 949
Extcommunity Filter
An extcommunity filter is used to filter BGP routes based on extended community
attributes. BGP extended community attributes are classified into two types:
● VPN target: A VPN target controls route learning between VPN instances,
isolating routes of VPN instances. A VPN target may be either an import or
export VPN target. Before advertising a Virtual Private Network version 4
(VPNv4) or Virtual Private Network version 6 (VPNv6) route to a remote
Multi-protocol Extensions for Border Gateway Protocol (MP-BGP) peer, a PE
adds an export VPN target to the route. After receiving a VPNv4 or VPNv6
route, the remote MP-BGP peer compares the received export VPN target with
the local import VPN target to determine which routes can be added to the
routing table of the local VPN instance.
● Site-of-Origin (SoO): If multiple CEs at a VPN site are connected to different
PEs, the routes advertised from the CEs to the PEs may be re-advertised to
this VPN site after the routes have traversed the backbone network. This may
cause routing loops within the VPN site. To prevent routing loops, you can
configure an SoO attribute to differentiate routes advertised from different
VPN sites.
RD Filter
An RD filter is used to filter BGP routes based on RDs in VPN routes. RDs are used
to distinguish IPv4 and IPv6 prefixes in the same address segment in VPN
instances. RD filters specify matching rules regarding RD attributes.
Route-Policy
A route-policy is a complex filter. It is used to match attributes of specified routes
and change route attributes when specific conditions are met. A route-policy can
use the preceding six filters to define its matching rules.
Invoking Between Tools in Routing Policy
In applications, to control routes, tools used in routing policy must be used
together. Figure 10-3 shows invoking between these tools.
