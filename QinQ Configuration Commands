QinQ Configuration Commands

    Command Support
    add-tag vlan-id
    display spare-bucket resource
    display vlan-translation resource
    port add-tag acl
    port vlan-stacking
    port vlan-stacking untagged
    qinq mapping pe-vid ce-vid
    qinq mapping vid map-vlan
    qinq protocol
    qinq protocol mode
    qinq stacking
    qinq stacking vlan
    qinq vlan-translation enable
    qinq vlan-translation miss-drop

Command Support

Commands provided in this section and all the parameters in the commands are supported by all switch models (except the S5751-L, S5731-L, and S5731S-L), unless otherwise specified. For details, see specific commands.
add-tag vlan-id
Function

The add-tag vlan-id command configures an action of adding an outer VLAN tag in a traffic behavior.

The undo add-tag command deletes the action.

By default, no action of adding an outer VLAN tag is configured in a traffic behavior.

Only the S5735S-H, S5736-S, and S6720S-S support this command.
Format

add-tag vlan-id vlan-id

undo add-tag
Parameters

Parameter
	

Description
	

Value

vlan-id
	

Specifies the VLAN ID in the outer VLAN tag.
	

The value is an integer that ranges from 1 to 4094.
Views

Traffic behavior view
Default Level

2: Configuration level
Usage Guidelines

Usage Scenario

When the downstream device needs to provide services based on the outer VLAN tag, run the add-tag vlan-id command to configure the device to add an outer VLAN tag to packets matching the traffic classifier.

Follow-up Procedure

Run the traffic policy command to create a traffic policy and run the classifier behavior command in the traffic policy view to bind the traffic classifier to the traffic behavior containing the action of adding an outer VLAN tag.

Precautions

    After the add-tag vlan-id, remark 8021p, remark cvlan-id or remark vlan-id command is used, the system modifies the VLAN tag of packets according to its configuration. The behavior configured through these commands is called VLAN-based action.

    To apply a VLAN-based action and a non-VLAN-based action to the same upstream traffic policy, configure the VLAN-based action and non-VLAN-based action in different traffic behaviors bound to the same traffic policy.
    In the scenario where a traffic policy is bound to multiple pairs of traffic classifiers and traffic behaviors, a traffic behavior contains add-tag vlan-id, and a traffic classifier bound to another traffic behavior that does not define any VLAN-specific actions defines if-match vlan-id, the VLAN ID specified by add-tag vlan-id is matched. If another traffic behavior defines if-match cvlan-id, the VLAN ID in the packets is matched.

    The add-tag vlan-id command is invalid for double-tagged VLAN packets.

    When port vlan-stacking, port vlan-stacking untagged, or port link-type dot1q-tunnel is configured on an interface to add a VLAN tag to packets so that packets carry double VLAN tags, the add-tag vlan-id command is invalid for the double-tagged VLAN packets.
    If you run the add-tag vlan-id command in the same traffic classifier view multiple times, only the latest configuration takes effect.

Example

# Configure an action of adding an outer VLAN tag for traffic behavior tb to 100.

<HUAWEI> system-view
[HUAWEI] traffic behavior tb
[HUAWEI-behavior-tb] add-tag vlan-id 100

display spare-bucket resource
Function

The display spare-bucket resource command displays the usage of backup resources when VLAN translation resources conflict.
Format

display spare-bucket resource [ slot slot-number ]

Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6730-H, S6730S-H, S6730-S, and S6730S-S support this command.
Parameters

Parameter
	

Description
	

Value

slot slot-number
	

Specifies the slot ID where the usage of backup resources is displayed.
	

The value is an integer and must be the ID of an existing slot on the device.
Views

All views
Default Level

1: Monitoring level
Usage Guidelines

The command displays the usage of backup VLAN translation resources, including the total number of backup VLAN translation resources, and the numbers of used and remaining backup VLAN translation resources. The command output helps you manage backup VLAN translation resources and locate the problem of ineffective VLAN mapping due to insufficient resources.

When no slot ID is specified, the usage of backup VLAN translation resources in all slots is displayed.
Example

# Display the usage of backup VLAN translation resources in slot 0.

<HUAWEI> display spare-bucket resource slot 0
------------------------------------------------------------                                                                        
 Slot                Used          Free          Total                                                                              
------------------------------------------------------------                                                                        
 0                   0             66            66             

Table 5-59 Description of the display spare-bucket resource command output

Item
	

Description

Slot
	

Slot ID

Used
	

Number of used backup VLAN translation resources.

Free
	

Number of remaining backup VLAN translation resources.

Total
	

Total number of backup VLAN translation resources.
display vlan-translation resource
Function

The display vlan-translation resource command displays VLAN translation resource usage.
Format

display vlan-translation resource [ slot slot-number ]

Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H, S6730-S, and S6730S-S support this command.
Parameters

Parameter
	

Description
	

Value

slot slot-number
	

Displays VLAN translation resource usage in a specified slot.
	

The value is an integer and must be an existing slot on the device.
Views

All views
Default Level

1: Monitoring level
Usage Guidelines

Usage Scenario

The display vlan-translation resource command displays VLAN translation resource usage, including the total number of inbound/outbound VLAN translation resources, the number of used VLAN translation resources, and the number of remaining VLAN translation resources. The command output helps you manage VLAN translation resources, and locate faults of insufficient VLAN translation resources caused by VLAN Mapping or Selective QinQ.
Example

# Display VLAN translation resource usage.

<HUAWEI> display vlan-translation resource slot 0
 Interface:
   GigabitEthernet0/0/1 to GigabitEthernet0/0/48
-------------------------------------------------
 Type      Total      Configured      Remaining
-------------------------------------------------
 Ingress   65536      0               65536      
 Egress    65536      0               65536      

Table 5-60 Description of the display vlan-translation resource command output

Item
	

Description

Interface
	

Interface where VLAN translation is performed.

Type
	

VLAN translation resource type, which can be Ingress or Egress.

Total
	

Total number of VLAN translation resources.

Configured
	

Number of used VLAN translation resources.

Remaining
	

Number of remaining VLAN translation resources.
port add-tag acl
Function

The port add-tag acl command adds an outer tag to the packet that matches an ACL rule on an interface.

The undo port add-tag acl command cancels the configuration.
By default, the device does not add an outer tag to the packet that matches an ACL rule.

Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H, S6730-S, and S6730S-S support this command.
Format

port add-tag acl { acl-number | name acl-name } [ rule rule-id ] vlan vlan-id { priority-inherit | remark-8021p 8021p-value }

undo port add-tag acl { acl-number | name acl-name } [ rule rule-id ]

If both Layer 2 ACLs and Layer 3 ACLs are configured, use the following command:

port add-tag acl l2-acl [ rule rule-id ] [ acl { basic-acl | advance-acl | name acl-name } [ rule rule-id ] ] vlan vlan-id { priority-inherit | remark-8021p 8021p-value }

port add-tag acl { basic-acl | advance-acl } [ rule rule-id ] [ acl { l2-acl | name acl-name } [ rule rule-id ] ] vlan vlan-id { remark-8021p 8021p-value | priority-inherit }

port add-tag acl name acl-name [ rule rule-id ] [ acl { basic-acl | advance-acl | l2-acl | name acl-name } [ rule rule-id ] ] vlan vlan-id { remark-8021p 8021p-value | priority-inherit }

undo port add-tag acl l2-acl [ rule rule-id ] [ acl { basic-acl | advance-acl | name acl-name } [ rule rule-id ] ]

undo port add-tag acl { basic-acl | advance-acl } [ rule rule-id ] [ acl { l2-acl | name acl-name } [ rule rule-id ] ]

undo port add-tag acl name acl-name [ rule rule-id ] [ acl { basic-acl | advance-acl | l2-acl | name acl-name } [ rule rule-id ] ]
Parameters

Parameter
	

Description
	

Value

acl-number
	

Specifies the number of an ACL.
	
The value is an integer that ranges from 2000 to 4999. The value ranges of different types of ACLs are as follows:

    The value of a basic ACL ranges from 2000 to 2999.
    The value of an advanced ACL ranges from 3000 to 3999.
    The value of a Layer 2 ACL ranges from 4000 to 4999.

rule-id
	

Specifies the ID of an ACL rule.
	
The value of an IPv4 ACL ranges from 0 to 4294967294.

    When the rule ID is specified and the rule associated with the rule ID exists, the new rule takes effect.
    If the rule associated with the rule ID does not exist, you can create a rule with a specified rule ID and add the rule according to the rule ID.

NOTE:

The number of ACL rules assigned automatically by the device starts from the step. The default step is 5. With this step, the device creates ACL rules with the numbers of 5, 10, 15, and so on.

name acl-name
	

Specifies a named ACL.
	

The value must the name of an existing ACL.

vlan vlan-id
	

Specifies a VLAN ID.
	

The value is an integer that ranges from 1 to 4094.

l2-acl
	

Specifies the number of a Layer 2 ACL.
	

The value is an integer that ranges from 4000 to 4999.

basic-acl
	

Specifies the number of a basic ACL.
	

The value is an integer that ranges from 2000 to 2999.

advance-acl
	

Specifies the number of an advance ACL.
	

The value is an integer that ranges from 3000 to 3999.

priority-inherit
	

Indicates that the outer VLAN tag inherits the priority in the inner VLAN tag.
	

-

remark-8021p 8021p-value
	

Specifies the re-marked priority of the added outer VLAN tag. 8021p-value specifies the 802.1p priority.
	

The value is an integer that ranges from 0 to 7. A larger value indicates a higher priority.
Views

Ethernet interface view, GE interface view, XGE interface view, 25GE interface view, 40GE interface view, 100GE interface view, Eth-Trunk interface view, MultiGEinterface view
Default Level

2: Configuration level
Usage Guidelines

Usage Scenario

A device interface adds the specified outer tag to a packet based on the VLAN tag, MAC address, IP protocol, source address, destination address, priority, or port number of an application of a user.

Precautions

    After you run the port add-tag acl command, the following situations may occur:
        The device does not take the original forwarding action to forward the packet that matches an ACL rule. Instead, the device adds an outer tag to the packet and forwards the packet in the VLAN specified by the added outer tag.
        The device adds an outer tag to the packet that does not match an ACL rule based on the default VLAN of an interface.

    A Layer 2 ACL and a Layer 3 ACL can be set in the port add-tag acl command simultaneously. The Layer 3 ACL and its rules can be configured only after the Layer 2 ACL and its rules are configured. The Layer 2 ACL number ranges from 4000 to 4999 and the Layer 3 ACL number ranges from 2000 to 2999 and 3000 to 3999.
    This command is invalid for packets tagged with VLAN 0. If packets tagged with VLAN 0 need to be processed, configure a traffic policy on the switch.

    For the S6735-S, The port add-tag acl command is invalid for double-tagged VLAN packets.

Example

# Add the outer tag of VLAN 1001 to the packet that matches the source IP address of 192.168.0.0/16 on GE0/0/1.

<HUAWEI> system-view
[HUAWEI] acl name test 2000 
[HUAWEI-acl-basic-test] rule 1 permit source 192.168.0.0 0.0.255.255
[HUAWEI-acl-basic-test] quit
[HUAWEI] interface gigabitethernet 0/0/1
[HUAWEI-GigabitEthernet0/0/1] port link-type trunk
[HUAWEI-GigabitEthernet0/0/1] port trunk allow-pass vlan all
[HUAWEI-GigabitEthernet0/0/1] port add-tag acl 2000 rule 1 vlan 1001 priority-inherit 

port vlan-stacking
Function

The port vlan-stacking command configures VLAN stacking.

The undo port vlan-stacking command cancels the configuration.

By default, VLAN stacking is not configured.
Format

port vlan-stacking vlan vlan-id1 [ to vlan-id2 ] stack-vlan vlan-id3 [ remark-8021p 8021p-value1 ]

port vlan-stacking vlan vlan-id1 stack-vlan vlan-id3 [ remark-8021p 8021p-value1 ] map-vlan vlan-id4 [ remark-inner-8021p 8021p-value2 ]

undo port vlan-stacking vlan vlan-id1 [ to vlan-id2 ] [ stack-vlan vlan-id3 ]

undo port vlan-stacking all
Parameters

Parameter
	

Description
	

Value

vlan vlan-id1 [ to vlan-id2 ]
	
Specifies the VLAN ID in a received tagged frame.

    vlan-id1 specifies the start VLAN ID.
    to vlan-id2 specifies the end VLAN ID. The value of vlan-id2 must be larger than the value of vlan-id1. vlan-id1 and vlan-id2 identify a VLAN range.

	

The value of vlan-id1 is an integer that ranges from 1 to 4094.

The value of vlan-id2 is an integer that ranges from 1 to 4094.

stack-vlan vlan-id3
	

Specifies the outer VLAN ID added to a frame.
	

The value is an integer that ranges from 1 to 4094.

remark-8021p 8021p-value1
	

Specifies the re-marked 802.1p priority in the outer tag added to a frame.
	

The value is an integer that ranges from 0 to 7. A larger value indicates a higher priority.

map-vlan vlan-id4
	

Specifies the mapped VLAN ID in the stacked inner tag.
	

The value is an integer that ranges from 1 to 4094.

remark-inner-8021p 8021p-value2
	

Specifies the re-marked 802.1p priority in the mapped inner tag.
	

The value is an integer that ranges from 0 to 7. A larger value indicates a higher priority.

all
	

Deletes all VLAN stacking configurations on the interface.
	

-
Views

Ethernet interface view, GE interface view, XGE interface view, 40GE interface view, 100GE interface view, MultiGE interface view, Eth-Trunk interface view, port group view, 25GE interface view
Default Level

2: Configuration level
Usage Guidelines

Usage Scenario

VLAN stacking, also called selective QinQ, is a Layer 2 technology that enables a device to add outer VLAN tags based on VLAN IDs.
When frames are transmitted on the ISP network, the frames are differentiated based on user applications, access sites, or access devices. A device enabled with VLAN stacking adds outer tags to user frames based on the inner tags or priorities in the user frames so that traffic from different users are differentiated. A VLAN stacking interface has the following features:

    A VLAN stacking port can be configured with multiple outer VLAN tags so that the port can add different outer VLAN tags to different VLAN frames.

    A VLAN stacking interface can add the outer tag to received frames. After an interface joins the stacked VLAN in untagged mode, the interface removes the outer tag from outgoing frames.

When a network edge device needs to act as a user-side device and the received single-tagged packets are from one type of service, the same service from different users needs to be sent in different VLANs. That is, 1:1 VLAN mapping is implemented. After mapped VLAN tags enter the carrier network, VLAN stacking needs to be enabled on the network edge device to distinguish different users and services, because the number of VLANs that can be provided by the carrier network is limited. In addition, specified tags need to be added to packets of different users and services. Outer tags are the same as those provided by the carrier network and can be transmitted over the carrier network, and inner tags are transparently transmitted over the carrier network, enabling communication between different users. You need to run the port vlan-stackingvlanvlan-id1stack-vlanvlan-id2 [ remark-8021p8021p-value1 ] map-vlanvlan-id4 [ remark-inner-8021p8021p-value2 ] command to enable both VLAN mapping and VLAN stacking functions. remark-8021p8021p-value1 and remark-inner-8021p8021p-value2 specify 802.1p priorities of inner and outer VLAN tags.

If you want to implement both VLAN mapping and VLAN stacking, you cannot enable them separately by running the corresponding commands. This is because the VLAN ID that is mapped based on VLAN mapping cannot be mapped again based on VLAN stacking. For example, if port vlan-stacking vlan 210 stack-vlan 2010 and port vlan-mapping vlan 10 map-vlan 210 are configured on a device, the device maps VLAN 10 to VLAN 210 based on port vlan-mapping vlan 10 map-vlan 210. However, VLAN 210 after mapping will not be mapped to VLAN 2010 based on port vlan-stacking vlan 210 stack-vlan 2010. To implement both VLAN stacking and VLAN mapping, run the port vlan-stacking vlanvlanid1stack-vlanvlanid2map-vlanvlanid3 command.
When remark-8021p 8021p-value is not specified:

    On the SS1720GW-E, S1720GWR-E, S5720I-SI, S5720-LI, S2730S-S, S5735-L-I, S5735-L1,S300, S5735-L, S5735S-L1, S5720S-LI, S5735-S, S500, S5735-S-I, S5735S-H, S5736-S, and S6720S-S, the 802.1p priority in the outer VLAN tag is the same as the interface priority. If trust 8021p is configured on the interface, the 802.1p priority in the outer VLAN tag is the same as the 802.1p priority in the inner VLAN tag.
    On other models, the 802.1p priority in the outer VLAN tag is the same as the 802.1p priority in the inner VLAN tag.

Precautions
When you configure selective QinQ, note the following points:

    Selective QinQ is recommended to be enabled on a hybrid interface. Selective QinQ can take effect on the interface only in the inbound direction.
    The outer VLAN must be created before VLAN stacking is performed.

    When an interface configured with VLAN stacking needs to remove the outer tag from outgoing frames, the interface must join the VLAN specified by stack-vlan in untagged mode. If the outer VLAN does not need to be removed, the interface must join the VLAN specified by stack-vlan in tagged mode.

    When map-vlan vlan-id4 is configured to perform VLAN stacking and VLAN mapping concurrently, on switches other than the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H, S6730-S, and S6730S-S, the same outer VLAN tag cannot be added to packets from different user VLANs. On the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H, S6730-S, and S6730S-S, the same outer VLAN tag cannot be added to packets from different user VLANs, and different inner VLAN tags in packets from different user VLANs cannot be matched to the same VLAN tag. For example, if packets containing VLAN IDs 10 and 20 respectively are received on an interface, the port vlan-stacking vlan 10 stack-vlan 100 map-vlan 200 and port vlan-stacking vlan 20 stack-vlan 100 map-vlan 200 commands cannot be configured together.
    On the S6735-S, the qinq protocol and port vlan-stacking commands cannot be run simultaneously on an interface.
    On the S2730S-S, S5735-L-I, S5735-L1,S300, S5735-L, S5735S-L1, S5735-S, S500, S5735-S-I, after the port vlan-stacking command is run on an interface, IP packets cannot be forwarded on the interface.
    On the S6735-S, after the port vlan-stacking command is run on an interface, the inner VLAN tag of packets is not removed and the outer VLAN tag is replaced during Layer 3 forwarding.

Example

# On GE0/0/1, configure selective QinQ and outer VLAN tag 100 to the tagged frames with the inner VLAN tags 10 to 13.

<HUAWEI> system-view
[HUAWEI] interface gigabitethernet 0/0/1
[HUAWEI-GigabitEthernet0/0/1] port link-type hybrid
[HUAWEI-GigabitEthernet0/0/1] qinq vlan-translation enable
[HUAWEI-GigabitEthernet0/0/1] port hybrid untagged vlan 100
[HUAWEI-GigabitEthernet0/0/1] port vlan-stacking vlan 10 to 13 stack-vlan 100

port vlan-stacking untagged
Function

The port vlan-stacking untagged command configures a device to add double VLAN tags to an untagged frame.

The undo port vlan-stacking untagged command cancels the configuration.

By default, the device does not add double tags to an untagged frame.
Format

port vlan-stacking untagged stack-vlan vlan-id1 stack-inner-vlan vlan-id2

undo port vlan-stacking untagged
Parameters

Parameter
	

Description
	

Value

stack-vlan vlan-id1
	

Specifies the outer VLAN tag added to an untagged frame.
	

The value of vlan-id1 is an integer that ranges from 1 to 4094.

stack-inner-vlan vlan-id2
	

Specifies the inner VLAN tag added to an untagged frame.
	

The value of vlan-id2 is an integer that ranges from 1 to 4094.
Views

Ethernet interface view, GE interface view, XGE interface view, 40GE interface view, 100GE interface view, MultiGE interface view, Eth-Trunk interface view, port group view, 25GE interface view
Default Level

2: Configuration level
Usage Guidelines

Usage Scenario

If double tags need to be added to packets, two devices are required. The port vlan-stacking untagged command adds double tags to packets on one device or untagged packets received on a Layer 2 interface to differentiate services or users.
For outgoing packets:

    S5720I-SI, S5720-LI, S5720S-LI, S5735S-H, S5736-S, and S6720S-S:

        Double-tagged packets: The switch removes tags, as long as the outer VLAN ID is matched (regardless of whether the inner VLAN ID is matched).

        Single-tagged packets: If QinQ (doltq or VLAN stacking) is configured on the inbound interface and the outer VLAN ID in QinQ is the same as the outer VLAN ID specified by the port vlan-stacking untagged stack-vlan vlan-id1 stack-inner-vlan vlan-id2 command, the VLAN ID of outgoing packets is the VLAN ID of original packets.
    Other models: When only the outer VLAN ID is matched and the VLAN is configured on the interface in untagged mode, the outer VLAN tag is removed and the inner VLAN tag is reserved.

Precautions

To enable an interface to add double VLAN tags to an untagged packet, you need to set the link type of the interface to hybrid, and add the interface to the VLAN specified by stack-vlan on the S6720S-S, S5735S-H, S5736-S, S5720S-LI, S5720-LI, S5720I-SI. On other devices, you need to set the link type of the interface to hybrid or trunk, and add the interface to the VLAN specified by stack-vlan.

When the interface PVID is not VLAN 1, restore the PVID to VLAN 1 before the port vlan-stacking untagged command is executed.

Adding double VLAN tags to untagged frames is port-based VLAN assignment. Different VLAN assignment modes are in the following order of priority: policy-based VLAN assignment > MAC address-based VLAN assignment > IP subnet-based VLAN assignment > protocol-based VLAN assignment > interface-based VLAN assignment.

On the S5720I-SI, S5720-LI, S2730S-S, S5735-L-I, S5735-L1,S300, S5735-L, S5735S-L1, S5720S-LI, S5735-S, S500, S5735-S-I, S5735S-H, S5736-S, and S6720S-S if the port vlan-stacking untagged vlan-id1 stack-inner-vlan vlan-id2 command is used on an interface, the VLAN specified by vlan-id1 cannot be configured as the outer VLAN in the port vlan-stacking command.

If the port vlan-stacking untagged command is used on an interface, the interface processes the received packets with VLAN tag 0 as untagged packets.
Example

# Add double VLAN tags to untagged frames received on GE0/0/1.

<HUAWEI> system-view
[HUAWEI] interface gigabitethernet 0/0/1
[HUAWEI-GigabitEthernet0/0/1] port link-type hybrid
 [HUAWEI-GigabitEthernet0/0/1] qinq vlan-translation enable
 [HUAWEI-GigabitEthernet0/0/1] port hybrid untagged vlan 100
[HUAWEI-GigabitEthernet0/0/1] port vlan-stacking untagged stack-vlan 100 stack-inner-vlan 200

qinq mapping pe-vid ce-vid
Function

The qinq mapping pe-vid ce-vid command configures a sub-interface to map the outer VLAN tag of a frame.

The undo qinq mapping pe-vid ce-vid command cancels the configuration.

By default, VLAN mapping is not configured on a sub-interface.
Format

qinq mapping pe-vid vlan-id1 ce-vid vlan-id2 [ to vlan-id3 ] map-vlan vid vlan-id4

undo qinq mapping pe-vid vlan-id1 ce-vid vlan-id2 [ to vlan-id3 ] map-vlan vid vlan-id4

Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H, S6730-S, and S6730S-S support this configuration.
Parameters

Parameter
	

Description
	

Value

pe-vid vlan-id1
	

Specifies the outer VLAN tag in a received frame.
	

The value is an integer that ranges from 2 to 4094.

ce-vid vlan-id2 [ to vlan-id3 ]
	
Specifies the inner VLAN tag in a received frame.

    vlan-id2: specifies the start inner VLAN tag.
    vlan-id3: specifies the end inner VLAN tag.
    The value of vlan-id3 must be greater than or equal to the value of vlan-id2. vlan-id2 and vlan-id3 identify a VLAN range.

	

The value of vlan-id2 is an integer that ranges from 1 to 4094.

The value of vlan-id3 is an integer that ranges from 1 to 4094.

map-vlan vid vlan-id4
	

Specifies the VLAN ID in the mapped outer tag.
	

The value is an integer that ranges from 1 to 4094.
Views

GE sub-interface view, XGE sub-interface view, 25GE sub-interface view, 40GE sub-interface view, 100GE sub-interface view, VE sub-interface view, Eth-Trunk sub-interface view, MultiGE sub-interface view
Default Level

2: Configuration level
Usage Guidelines

Usage Scenario

QinQ mapping is generally deployed on edge devices of a metro Ethernet and often used to map the VLAN tag carried in a frame to a specified VLAN tag before the frame is transmitted on the public network. QinQ mapping can be applied to the following scenarios:

    The VLAN IDs deployed in new sites and old sites conflict, but new sites need to communicate with old sites.

    The VLAN ID planning of each site on the public network is different. As a result, the VLAN IDs conflict. However, the sites do not need to communicate.

    The VLAN IDs on both ends of the public network are different.

When a network edge device receives double-tagged frames, the inner tags indicate users and outer tags indicates services. To differentiate services on the ISP network, you can configure 2 to 1 QinQ mapping on network edge devices. The double tags of frames are mapped to a specified S-VLAN tag so that the outer tag can be transparently transmitted on the ISP network.
The qinq mapping pe-vid ce-vid command on a sub-interface has similar functions with the port vlan-mapping vlan inner-vlan command on the main interface. The differences are as follows:

    QinQ mapping on a sub-interface is mainly used to access the L2VPN.

    QinQ mapping used on the main interface is used for interconnection on the Layer 2 MAN so that users of different VLANs can communicate with each other.

    QinQ mapping saves a large number of physical ports.

Precautions

The qinq mapping pe-vid ce-vid command maps the outer VLAN tags of the frames on a sub-interface, but does not change the inner VLAN tags. This command takes effect for only incoming frames.

The original VLAN IDs specified for QinQ mapping on a sub-interface cannot be globally created or displayed by display commands.

VLAN mapping or VLAN stacking cannot be configured for the same VLAN on the main interface and its sub-interfaces.

The mapped VLAN IDs specified in QinQ mapping configuration must be different from the control VLAN IDs for ring protocols such as SEP, RRPP, and ERPS. Otherwise, an error message will be displayed, indicating that the configuration fails.
Example

# On XGigabitEthernet0/0/1.1, set the outer VLAN tag 10 of frames with the inner VLAN tag 20 to outer VLAN tag 30.

<HUAWEI> system-view
[HUAWEI] vcmp role silent
[HUAWEI] interface xgigabitethernet 0/0/1
[HUAWEI-XGigabitEthernet0/0/1] port link-type hybrid
[HUAWEI-XGigabitEthernet0/0/1] quit
[HUAWEI] interface xgigabitethernet 0/0/1.1
[HUAWEI-XGigabitEthernet0/0/1.1] qinq mapping pe-vid 10 ce-vid 20 map-vlan vid 30

qinq mapping vid map-vlan
Function

The qinq mapping vid map-vlan command configures 1 to 1 QinQ mapping on a sub-interface.

The undo qinq mapping vid map-vlan command cancels the configuration.

By default, 1 to 1 QinQ mapping is not configured on a sub-interface.
Format

qinq mapping vid vlan-id1 [ to vlan-id2 ] map-vlan vid vlan-id3

undo qinq mapping vid vlan-id1 [ to vlan-id2 ] map-vlan vid vlan-id3

Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H, S6730-S, and S6730S-S support this configuration.
Parameters

Parameter
	

Description
	

Value

vid vlan-id1 to vlan-id2
	
Specifies the VLAN ID of the tag carried in the received packet.

    vlan-id1: specifies the start inner VLAN tag.
    vlan-id2: specifies the end inner VLAN tag.
    The value of vlan-id2 must be greater than or equal to the value of vlan-id1. vlan-id1 and vlan-id2 identify a VLAN range.

	

vlan-id1 is an integer that ranges from 2 to 4094.

vlan-id2 is an integer that ranges from 2 to 4094.

map-vlan vid vlan-id3
	

Specifies the VLAN ID in the mapped outer tag.
	

The value is an integer that ranges from 1 to 4094.
Views

GE sub-interface view, XGE sub-interface view, 25GE sub-interface view, 40GE sub-interface view, 100GE sub-interface view, VE sub-interface view, Eth-Trunk sub-interface view, MultiGE sub-interface view
Default Level

2: Configuration level
Usage Guidelines

Usage Scenario

QinQ mapping is often deployed on edge devices of a metro Ethernet and is used to map the frames sent from the user side. The devices map the VLAN IDs in user packets to specified VLAN IDs before forwarding the packets to the public network. QinQ mapping can be applied to the following scenarios:

    The VLAN IDs deployed in new sites and old sites conflict, but new sites need to communicate with old sites.

    The VLAN ID planning of each site on the public network is different. As a result, the VLAN IDs conflict. However, the sites do not need to communicate.

    The VLAN IDs on both ends of the public network are different.

The qinq mapping vid map-vlan command on a sub-interface has similar functions with the port vlan-mapping vlan inner-vlan command on the main interface. The differences are as follows:

    QinQ mapping on a sub-interface is mainly used to access the L2VPN.

    QinQ mapping used on the main interface is used for interconnection on the Layer 2 MAN so that users of different VLANs can communicate with each other.

    QinQ mapping saves a large number of physical ports.

Precautions

The qinq mapping vid map-vlan command maps the single tags in frames on a sub-interface. This command takes effect only for incoming packets.

The original VLAN IDs specified for QinQ mapping on a sub-interface cannot be globally created or displayed by display commands.

VLAN mapping or VLAN stacking cannot be configured for the same VLAN on the main interface and its sub-interfaces.

The mapped VLAN IDs specified in QinQ mapping configuration must be different from the control VLAN IDs for ring protocols such as SEP, RRPP, and ERPS. Otherwise, an error message will be displayed, indicating that the configuration fails.
Example

# Configure QinQ mapping on XGigabitEthernet0/0/1.1 to map outer VLAN tag 100 to inner VLAN tag 200.

<HUAWEI> system-view
[HUAWEI] vcmp role silent
[HUAWEI] interface xgigabitethernet 0/0/1
[HUAWEI-XGigabitEthernet0/0/1] port link-type hybrid
[HUAWEI-XGigabitEthernet0/0/1] quit
[HUAWEI] interface xgigabitethernet 0/0/1.1
[HUAWEI-XGigabitEthernet0/0/1.1] qinq mapping vid 100 map-vlan vid 200

qinq protocol
Function

The qinq protocol command sets the TPID value in the outer VLAN tag of an interface.

The undo qinq protocol command restores the default TPID value in the outer VLAN tag.

By default, the TPID value in the outer VLAN tag is 0x8100.
Format

qinq protocol protocol-id

undo qinq protocol
Parameters

Parameter
	

Description
	

Value

protocol-id
	

Specifies the TPID value in the outer VLAN tag.
	

The value is a 4-digit hexadecimal integer that ranges from 0x0600 to 0xFFFF. The default TPID value is 0x8100.
Views

Ethernet interface view, GE interface view, XGE interface view, 40GE interface view, 100GE interface view, MultiGE interface view, Eth-Trunk interface view, 25GE interface view, port group view
Default Level

2: Configuration level
Usage Guidelines

Usage Scenario

Devices from different vendors or in different network plans may use different Tag Protocol Identifier (TPID) values in VLAN tags of QinQ packets. The switch supports configuration of the TPID value in outer VLAN tags so that it can interoperate with devices from different vendors or operate seamlessly on an existing network.

Precautions

    In earlier versions of V200R010, this command can be configured on Eth-Trunk member interfaces but not the Eth-Trunk. In V200R010 and later versions, this command can be configured on the Eth-Trunk but not Eth-Trunk member interfaces.

    When the device is upgraded from an earlier version of V200R010 to V200R010 or later and the qinq protocol command is configured on Eth-Trunk member interfaces, the following situations may occur:

        If the same qinq protocol command has been configured on all Eth-Trunk member interfaces, the qinq protocol command configuration takes effect on the Eth-Trunk after the upgrade.

        If different qinq protocol commands are configured on Eth-Trunk member interfaces, the qinq protocol command configuration takes effect on the Eth-Trunk member interfaces after the upgrade and there is the configuration on the Eth-Trunk member interfaces. To configure the qinq protocol command in the Eth-Trunk interface view, first manually run the undo qinq protocol command on Eth-Trunk member interfaces to delete the configuration. In this situation, automatic completion of the undo qinq protocol command is not supported. You must manually enter the undo qinq protocol command.

    The device directly connected to an interface must be able to identify the TPID value in the outer VLAN tag on the interface.
    On the S6735-S, the qinq protocol and port vlan-stacking commands cannot be run simultaneously on an interface.

    The qinq protocol command identifies incoming frames, and adds or changes the TPID value of outgoing frames.

    The qinq protocol command can also change the TPID value in the VLAN tag of a single-tagged packet.
    The TPID value specified by the qinq protocol command must be different from TPID values of specific protocols. Otherwise, the interface cannot correctly classify protocol packets. The TPID value cannot be any of the values in the following table.
    Table 5-61 Description of protocol types and values

    Protocol Type
    	

    Value

    ARP
    	

    0x0806

    RARP
    	

    0x8035

    IP
    	

    0x0800

    IPv6
    	

    0x86DD

    PPPoE
    	

    0x8863/0x8864

    MPLS
    	

    0x8847/0x8848

    IPX/SPX
    	

    0x8137

    LACP
    	

    0x8809

    802.1x
    	

    0x888E

    HGMP
    	

    0x88A7

    Reserved
    	

    0xFFFD/0xFFFE/0xFFFF

Example

# Set the TPID value in the outer VLAN tag of a QinQ frame to 0x9100 on GE0/0/1.

<HUAWEI> system-view
[HUAWEI] interface gigabitethernet0/0/1
[HUAWEI-GigabitEthernet0/0/1] qinq protocol 9100

qinq protocol mode
Function

The qinq protocol mode command configures the mode in which the TPID value in the outer VLAN tag of QinQ packets takes effect for interfaces.

The undo qinq protocol mode command restores the default mode in which the TPID value in the outer VLAN tag of QinQ packets takes effect for interfaces.

By default, the TPID value in the outer VLAN tag of QinQ packets takes effect for interfaces based on the slot.
Format

qinq protocol mode { global | slot }

undo qinq protocol mode

Only the S5732-H, S6730-H, S6730S-H, S6730-S, and S6730S-S support this command.
Parameters

Parameter
	

Description
	

Value

global
	

Indicates that the TPID value takes effect globally.
	

-

slot
	

Indicates that the TPID value takes effect based on the slot ID.
	

-
Views

System view
Default Level

2: Configuration level
Usage Guidelines

Usage Scenario

After the qinq protocol protocol-id command is run on an interface to configure the TPID value in the outer VLAN tag of QinQ packets, that is, the protocol type in the outer VLAN tag, the QinQ packets cannot be broadcast on other cards and are discarded in an inter-card broadcast traffic forwarding scenario. In this scenario, you can configure the qinq protocol mode global command in the system view to switch to the global mode in which the TPID value takes effect globally so that packets with the TPID value can be broadcast and forwarded across cards properly.

Precautions

A maximum of four TPIDs can be configured globally on the device, including the default TPID 0x8100. When more than four TPIDs are configured on the device, the global mode cannot be configured.
Example

# Set the mode in which the TPID value in the outer VLAN tag of QinQ packets takes effect for interfaces to the global mode.

<HUAWEI> system-view
[HUAWEI] qinq protocol mode global

qinq stacking
Function

The qinq stacking command configures VLAN stacking on a sub-interface.

The undo qinq stacking command cancels the configuration.

By default, VLAN stacking is not configured on a sub-interface.
Format

qinq stacking vid vlan-id1 [ to vlan-id2 ] pe-vid vlan-id3

undo qinq stacking vid vlan-id1 [ to vlan-id2 ] pe-vid vlan-id3

Only the S5731-H, S5731-S, S5731S-H, S5731S-S, S5732-H, S6735-S, S6730-H, S6730S-H, S6730-S, and S6730S-S support this configuration.
Parameters

Parameter
	

Description
	

Value

vid vlan-id1 [ to vlan-id2 ]
	
Specifies the outer VLAN ID range.

    vlan-id1 specifies the start VLAN ID.
    tovlan-id2 specifies the end VLAN ID. The vlan-id1 and vlan-id2 id value of vlan-id2 must be greater than or equal to the value of vlan-id1entify a VLAN range.

	

The value of vlan-id1 is an integer that ranges from 2 to 4094.

The value of vlan-id2 is an integer that ranges from 2 to 4094.

pe-vid vlan-id3
	

Specifies the outer VLAN tags added to a frame.
	

The value is an integer that ranges from 1 to 4094.
Views

GE sub-interface view, XGE sub-interface view, 25GE sub-interface view, 40GE sub-interface view, 100GE sub-interface view, VE sub-interface view, Eth-Trunk sub-interface view, MultiGE sub-interface view
Default Level

2: Configuration level
Usage Guidelines

Usage Scenario

The qinq stacking command adds an outer VLAN tag to the packets on a sub-interface.

Precautions

    The original VLAN IDs specified for QinQ mapping on a sub-interface cannot be globally created or displayed by display commands.
    VLAN mapping or VLAN stacking cannot be configured for the same VLAN on the main interface and its sub-interfaces.
    When a QinQ stacking sub-interface receives a packet, the interface checks whether the packet carries a VLAN tag. If not, the packet is directly dropped. If the packet carries one or two VLAN tags, the interface processes the packet as follows:
        If the packet carries one VLAN tag and the VLAN ID in the tag matches the VLAN range specified by vid vlan-id1 [ to vlan-id2 ] in the qinq stacking vid command, the interface adds an outer VLAN tag with a VLAN ID in the specified range to the packet. If the VLAN ID in the tag carried by the packet does not match the specified VLAN range, the packet is dropped.
        If the packet carries two VLAN tags and the VLAN ID in the outer VLAN tag matches the VLAN range specified by vid vlan-id1 [ to vlan-id2 ] in the qinq stacking vid command, the interface adds another outer VLAN tag with a VLAN ID in the specified range to the packet and forwards the packet. In this case, the inner VLAN tag is transmitted transparently. If the VLAN ID in the outer VLAN tag carried by the packet does not match the specified VLAN range, the packet is dropped.

Example

# Configure VLAN stacking on XGigabitEthernet0/0/1.1 and add an outer VLAN tag 100 to frames with the inner VLAN tags 10 to 13.

<HUAWEI> system-view
[HUAWEI] vcmp role silent
[HUAWEI] interface xgigabitethernet 0/0/1
[HUAWEI-XGigabitEthernet0/0/1] port link-type hybrid
[HUAWEI-XGigabitEthernet0/0/1] quit
[HUAWEI] interface xgigabitethernet 0/0/1.1
[HUAWEI-XGigabitEthernet0/0/1.1] qinq stacking vid 10 to 13 pe-vid 100

qinq stacking vlan
Function

The qinq stacking vlan command configures QinQ stacking on a VLANIF interface.

The undo qinq stacking vlan command cancels the configuration.

By default, QinQ stacking is not configured on a VLANIF interface.
Format

qinq stacking vlan vlan-id

undo qinq stacking vlan
Parameters
Parameter 	Description 	Value
vlan-id 	Specifies the outer VLAN tag added to a frame. 	The value is an integer that ranges from 1 to 4094.
Views

VLANIF interface view
Default Level

2: Configuration level
Usage Guidelines

Assume that the local device A is connected to the remote device B over the ISP network.

The ID of the management VLAN on device B is the same as the ID of VLAN for users connected to device A. However, the S-VLAN ID is different from the management VLAN ID.

To log in to device B to manage it from local device A, you can use the qinq stacking vlan command on device B to configure QinQ stacking on the VLANIF interface corresponding to the management VLAN. In addition, you need to configure QinQ on the user-side interface of device A.

    Packets sent from device A to device B are processed as follows:

    The user-side interface of device A sends double-tagged packets to the ISP network. The outer VLAN tag is assigned by the carrier so that the packets can be transparently transmitted over the ISP network to SwitchB.

    When device B receives double-tagged packets, it compares the VLAN tags of the packets with the VLAN tags configured on the VLANIF interface. If the outer tag of the packets is the same as the outer tag configured on the VLANIF interface, device B removes the outer tag and sends the packets to the IP layer for processing.

    Packets sent from device B to device A are processed as follows:

    When the VLANIF interface of SwitchB receives data packets, device B adds a VLAN tag to the packets according to the QinQ stacking configuration. The new outer VLAN tag is assigned by the carrier so that the double-tagged data packets can be transparently transmitted across the ISP network to device A. Device A removes the outer VLAN tag, and then forwards the packets to users.

    When configuring QinQ stacking on a VLANIF interface, ensure that the VLANIF interface corresponds to the management VLAN. VLANIF interfaces corresponding to other VLANs do not support QinQ stacking.

    To change the configured outer VLAN, run the undo qinq stacking vlan command to disable QinQ stacking, and then run the qinq stacking vlan command to configure a new outer VLAN.

    The qinq stacking vlan command conflicts with the icmp host-unreachable send command. Therefore, you must run the undo icmp host-unreachable send command before using the qinq stacking vlan command.

    The outer VLAN added to packets must be an existing VLAN without VLANIF interface configured.

Example

# Configure QinQ stacking on VLANIF 10.

<HUAWEI> system-view

[HUAWEI] vlan 10

[HUAWEI-vlan10] management-vlan

[HUAWEI-vlan10] quit

[HUAWEI] interface vlanif 10

[HUAWEI-Vlanif10] undo icmp host-unreachable send

[HUAWEI-Vlanif10] qinq stacking vlan 20

qinq vlan-translation enable
Function

The qinq vlan-translation enable command enables VLAN translation on an interface.

The undo qinq vlan-translation enable command disables VLAN translation on an interface.

By default, VLAN translation is disabled on an interface.
Format

qinq vlan-translation enable

undo qinq vlan-translation enable
Parameters

None
Views

Ethernet interface view, GE interface view, XGE interface view, 40GE interface view, 100GE interface view, MultiGE interface view, Eth-Trunk interface view, port group view, 25GE interface view
Default Level

2: Configuration level
Usage Guidelines

You can configure VLAN mapping and selective QinQ on an interface only after VLAN translation is enabled on it.
Example

# Enable VLAN translation on GigabitEthernet0/0/1.

<HUAWEI> system-view
[HUAWEI] interface gigabitethernet 0/0/1
[HUAWEI-GigabitEthernet0/0/1] port link-type hybrid
[HUAWEI-GigabitEthernet0/0/1] qinq vlan-translation enable

qinq vlan-translation miss-drop
Function

The qinq vlan-translation miss-drop command configures an interface to discard the packets that do not match any VLAN Stacking, VLAN mapping, and entry.

The undo qinq vlan-translation miss-drop command cancels the configuration.

By default, an interface does not discard the packets that do not match any VLAN Stacking, VLAN mapping, and entry.

This command does not take effect for untagged packets.
Format

qinq vlan-translation miss-drop

undo qinq vlan-translation miss-drop
Parameters

None
Views

Ethernet interface view, GE interface view, XGE interface view, 40GE interface view, 100GE interface view, MultiGE interface view, Eth-Trunk interface view, 25GE interface view, port group view
Default Level

2: Configuration level
Usage Guidelines

After VLAN Stacking and VLAN mapping, are configured on an interface, you can run the qinq vlan-translation miss-drop command to configure the interface to discard the received packets that do not match any VLAN Stacking, VLAN mapping, and entry.
Example

# Configure GE0/0/1 to discard the packets that do not match any VLAN Stacking, VLAN mapping, and entry.

<HUAWEI> system-view
[HUAWEI] interface gigabitethernet 0/0/1
[HUAWEI-GigabitEthernet0/0/1] port link-type hybrid
[HUAWEI-GigabitEthernet0/0/1] qinq vlan-translation enable
[HUAWEI-GigabitEthernet0/0/1] qinq vlan-translation miss-drop

